"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7759],{7759:(ie,F,m)=>{m.r(F),m.d(F,{AddPostPageModule:()=>te});var S=m(177),C=m(4341),f=m(5374),P=m(9858),_=m(467),O=m(4237),D=m(7447),T=m(736),A=m(5402),w=m(7892),j=m(8326),B=m(9349),t=m(3953),U=m(482),M=m(4234),N=m(3656),L=m(9900),E=m(755),V=m(345),G=m(1076);function X(u,g){if(1&u&&(t.j41(0,"ion-title"),t.EFF(1),t.k0s()),2&u){const l=t.XpG();t.R7$(),t.JRh(l.lang.text.AddPost.EditTitle)}}function Y(u,g){if(1&u&&(t.j41(0,"ion-title"),t.EFF(1),t.k0s()),2&u){const l=t.XpG();t.R7$(),t.JRh(l.lang.text.AddPost.Title)}}function J(u,g){if(1&u){const l=t.RV6();t.j41(0,"ion-item",7),t.bIt("click",function(){const i=t.eBV(l).index,n=t.XpG(2);return t.Njj(n.select_server(i,!0))}),t.j41(1,"ion-label"),t.EFF(2),t.k0s()()}if(2&u){const l=g.$implicit;t.R7$(2),t.JRh(l.name)}}function H(u,g){if(1&u){const l=t.RV6();t.j41(0,"ion-accordion-group",21,0),t.bIt("click",function(){t.eBV(l);const i=t.XpG();return t.Njj(i.isExpanded=!0)}),t.j41(2,"ion-accordion",22)(3,"ion-item",23)(4,"ion-label"),t.EFF(5),t.k0s(),t.j41(6,"ion-label",24),t.EFF(7),t.k0s(),t.nrm(8,"ion-icon",25),t.k0s(),t.j41(9,"div",26),t.DNE(10,J,3,1,"ion-item",27),t.k0s()()()}if(2&u){const l=t.XpG();t.Y8G("disabled",l.isSaveClicked)("value",l.isExpanded),t.R7$(5),t.JRh(l.lang.text.AddGroup.SelectServer),t.R7$(2),t.JRh(l.servers[l.index].name),t.R7$(3),t.Y8G("ngForOf",l.servers)}}function z(u,g){if(1&u){const l=t.RV6();t.j41(0,"div",28)(1,"ion-item",11)(2,"ion-toggle",29),t.mxI("ngModelChange",function(i){t.eBV(l);const n=t.XpG();return t.DH7(n.userInput.isNSFW,i)||(n.userInput.isNSFW=i),t.Njj(i)}),t.EFF(3),t.k0s()(),t.j41(4,"div",30),t.nrm(5,"img",31),t.k0s()()}if(2&u){const l=t.XpG();t.R7$(2),t.R50("ngModel",l.userInput.isNSFW),t.R7$(),t.JRh(l.lang.text.AddPost.NSFW),t.R7$(2),t.Aen(l.userInput.isNSFW?"filter: blur(16px);":""),t.Y8G("src",l.MainPostImage,t.B4B)}}function W(u,g){if(1&u&&t.nrm(0,"ion-icon",36),2&u){const l=t.XpG().$implicit;t.Y8G("name",l.icon||"close-circle")}}function K(u,g){if(1&u&&t.nrm(0,"img",37),2&u){const l=t.XpG().$implicit;t.Y8G("src","assets/icon/"+l.icon_img,t.B4B)("alt",l.title)}}function Q(u,g){if(1&u){const l=t.RV6();t.j41(0,"div",32)(1,"div",33),t.bIt("click",function(){const i=t.eBV(l).$implicit;return t.Njj(i.act())}),t.DNE(2,W,1,1,"ion-icon",34)(3,K,1,2,"img",35),t.j41(4,"div"),t.EFF(5),t.k0s()()()}if(2&u){const l=g.$implicit;t.R7$(),t.Aen("cursor: "+(l.cursor||"pointer")+";"),t.Y8G("hidden",l.isHide),t.R7$(),t.Y8G("ngIf",l.icon),t.R7$(),t.Y8G("ngIf",l.icon_img),t.R7$(2),t.JRh(l.name)}}function Z(u,g){if(1&u){const l=t.RV6();t.j41(0,"ion-item",38),t.bIt("click",function(){const i=t.eBV(l),n=i.$implicit,s=i.index,r=t.XpG();return t.Njj(r.open_viewer(n,s))})("contextmenu",function(){const i=t.eBV(l).index,n=t.XpG();return t.Njj(n.PostAttachContextMenu(i))}),t.j41(1,"ion-label"),t.EFF(2),t.k0s(),t.j41(3,"div",39),t.nrm(4,"img",40),t.k0s()()}if(2&u){const l=g.$implicit,e=g.index,i=t.XpG();t.Y8G("disabled",i.isSaveClicked),t.R7$(2),t.JRh("["+e+"] "+l.filename),t.R7$(2),t.Y8G("src",l.thumbnail,t.B4B)}}const q=[{path:"",component:(()=>{var u;class g{constructor(e,i,n,s,r,a,c,p,o,h,y,v){var I,d=this;this.global=e,this.lang=i,this.navCtrl=n,this.nakama=s,this.modalCtrl=r,this.p5toast=a,this.indexed=c,this.loadingCtrl=p,this.sanitizer=o,this.mClipboard=h,this.route=y,this.router=v,this.servers=[],this.userInput={id:void 0,title:void 0,content:void 0,creator_id:void 0,creator_name:void 0,UserColor:void 0,create_time:void 0,modify_time:void 0,server:void 0,mainImage:void 0,attachments:[],OutSource:void 0,isNSFW:!1},this.index=0,this.BackButtonPressed=!1,this.isModify=!1,this.isExpanded=!1,this.isSaveClicked=!1,this.isServerChanged=!1,this.useVoiceRecording=!1,this.MainPostImage=void 0,this.extended_buttons=[{icon:"image-outline",name:this.lang.text.AddPost.MainPostImage,act:()=>{this.isSaveClicked||(this.MainPostImage?(URL.revokeObjectURL(this.MainPostImage),this.MainPostImage=void 0,this.userInput.mainImage=void 0,document.getElementById("PostMainImage_sel").value=""):document.getElementById("PostMainImage_sel").click())}},{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(I=(0,_.A)(function*(){if(!d.isSaveClicked)try{return void(yield d.new_attach({detail:{value:"link"}}))}catch(b){"done"!=b&&d.new_attach({detail:{value:"load"}})}}),function(){return I.apply(this,arguments)})},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:function(){var I=(0,_.A)(function*(){d.isSaveClicked||d.modalCtrl.create({component:T.c,componentProps:{},cssClass:"fullscreen"}).then(x=>{x.onWillDismiss().then(function(){var R=(0,_.A)(function*($){$.data&&(d.AddAttachTextForm(),yield d.voidDraw_fileAct_callback($,void 0))});return function($){return R.apply(this,arguments)}}()),x.onDidDismiss().then(()=>{d.AddShortcut()}),delete d.global.p5key.KeyShortCut.Escape,x.present()})});return function(){return I.apply(this,arguments)}}()},{icon:"reader-outline",name:this.lang.text.ChatRoom.newText,act:function(){var I=(0,_.A)(function*(){let b={info:{content:{is_new:void 0,type:"text/plain",viewer:"text",filename:void 0,path:void 0}},no_edit:void 0};b.info.content.is_new="text",b.info.content.filename=d.global.TextEditorNewFileName(),b.no_edit=!0,d.modalCtrl.create({component:w.c,componentProps:b}).then(k=>{k.onWillDismiss().then(x=>{if(x.data){let R=d.global.TextEditorAfterAct(x.data,{display_name:d.nakama.users.self.display_name});d.AddAttachTextForm(),d.userInput.attachments.push(R)}}),k.onDidDismiss().then(()=>{d.AddShortcut()}),delete d.global.p5key.KeyShortCut.Escape,k.present()})});return function(){return I.apply(this,arguments)}}()},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:function(){var I=(0,_.A)(function*(){if(!d.isSaveClicked)try{let b=yield d.global.from_camera("tmp_files/post/",{user_id:"local"==d.isOfficial?void 0:d.nakama.servers[d.isOfficial][d.target].session.user_id,display_name:d.nakama.users.self.display_name});d.AddAttachTextForm(),d.userInput.attachments.push(b)}catch(b){console.log("\ucd2c\uc601 \uc2e4\ud328: ",b),d.p5toast.show({text:`${d.lang.text.GlobalAct.ErrorFromCamera}: ${b}`})}});return function(){return I.apply(this,arguments)}}()},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var I=(0,_.A)(function*(){d.isSaveClicked||(d.useVoiceRecording=!d.useVoiceRecording,d.useVoiceRecording?(yield A.R.hasAudioRecordingPermission()).value?(d.extended_buttons[5].icon="stop-circle-outline",d.p5toast.show({text:d.lang.text.ChatRoom.StartVRecord}),d.p5canvas.StartVoiceTimer(),yield A.R.startRecording(),d.CreateFloatingVoiceTimeHistoryAddButton()):(d.useVoiceRecording=!1,d.extended_buttons[5].icon="mic-circle-outline",yield A.R.requestAudioRecordingPermission()):yield d.StopAndSaveVoiceRecording())});return function(){return I.apply(this,arguments)}}()},{icon:"cloud-done-outline",name:this.lang.text.ChatRoom.Detour,act:()=>{this.toggle_custom_attach()}},{icon:"eye-off-outline",name:this.lang.text.AddPost.UseOutLink,act:()=>{this.toggle_open_link()}}],this.lock_modal_open=!1,this.useFirstCustomCDN=0,this.UseOutLink=!1,this.isApplyPostData=!1}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),delete this.nakama.StatusBarChangedCallback,this.useVoiceRecording&&this.StopAndSaveVoiceRecording();try{this.MainPostImage&&setTimeout(()=>{URL.revokeObjectURL(this.MainPostImage)},1e3)}catch{}}ngOnInit(){var e=this;this.cont=new AbortController,this.useFirstCustomCDN=Number(localStorage.getItem("useFFSCDN"))||0,this.toggle_custom_attach(this.useFirstCustomCDN),this.route.queryParams.subscribe(function(){var i=(0,_.A)(function*(n){const s=e.router.getCurrentNavigation().extras.state;let r=!1;if(s&&(r=!!s.act,s.data&&(e.userInput=s.data)),r){if(e.LoadListServer(),e.servers.length>1&&(e.index=1),s&&s.data){let a=`${e.userInput.server.isOfficial}/${e.userInput.server.target}`;for(let c=0,p=e.servers.length;c<p;c++)if(`${e.servers[c].isOfficial}/${e.servers[c].target}`==a){e.index=c;break}if(e.userInput.mainImage){let c=e.userInput.mainImage.url;c||(c=URL.createObjectURL(e.userInput.mainImage.blob)),e.MainPostImage=c}for(let c=0,p=e.userInput.attachments.length;c<p;c++)if("image"==e.userInput.attachments[c].viewer)if(e.userInput.attachments[c].url)e.userInput.attachments[c].thumbnail=e.userInput.attachments[c].url;else{let o=yield e.indexed.loadBlobFromUserPath(e.userInput.attachments[c].path,e.userInput.attachments[c].file_ext),h=URL.createObjectURL(o);e.userInput.attachments[c].thumbnail=h,setTimeout(()=>{URL.revokeObjectURL(h)},1e3)}e.UseOutLink=!!e.userInput.OutSource,e.toggle_open_link(e.UseOutLink)}e.select_server(e.index),s&&s.data&&(e.OriginalInfo=JSON.parse(JSON.stringify(e.userInput)))}});return function(n){return i.apply(this,arguments)}}()),setTimeout(()=>{this.CreateDrop()},100),this.nakama.StatusBarChangedCallback=()=>{this.LoadListServer(),this.index=0}}InitBrowserBackButtonOverride(){try{window.history.pushState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.navCtrl.back())}}catch(e){console.log("\ud0d0\uc0c9 \uae30\ub85d \ubcc0\uacbd\uc2dc \uc624\ub958 \ubc1c\uc0dd: ",e)}}LoadListServer(){this.servers=this.nakama.get_all_server_info(!0,!0),this.servers.unshift({name:this.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0})}CreateDrop(){var e=this;let i=document.getElementById("p5Drop_addPost");this.p5canvas||(this.p5canvas=new j(n=>{let s=0;n.setup=()=>{let a=n.createCanvas(i.clientWidth,i.clientHeight);a.parent(i),n.pixelDensity(.1),a.drop(function(){var c=(0,_.A)(function*(p){yield e.selected_blobFile_callback_act(p.file)});return function(p){return c.apply(this,arguments)}}()),n.noLoop(),n.StartVoiceTimer=()=>{n.loop(),s=n.millis()},n.StopVoiceTimer=()=>{n.noLoop()}},n.draw=()=>{this.useVoiceRecording&&(this.extended_buttons[5].name=r(n.millis()-s))};let r=a=>{let c=a/1e3,p=n.floor(c)%60,o=c/60,h=n.floor(o)%60,y=n.floor(o/60);return y?`${y}:${h}:${n.nf(p,2)}`:`${h}:${n.nf(p,2)}`};n.mouseMoved=a=>{a.dataTransfer?(i.style.pointerEvents="all",i.style.backgroundColor="#0008"):(i.style.pointerEvents="none",i.style.backgroundColor="transparent")},n.keyPressed=function(){var a=(0,_.A)(function*(c){"Enter"===c.code&&"exact_post_title_id"==document.activeElement.id&&e.postData()});return function(c){return a.apply(this,arguments)}}()}))}catchBottomTabShortCut(){this.BottomTabShortcut=this.global.p5key.KeyShortCut.BottomTab,delete this.global.p5key.KeyShortCut.BottomTab}ionViewWillEnter(){this.AddShortcut(),this.catchBottomTabShortCut(),this.TitleInput=document.getElementById("add_post_title").childNodes[1].childNodes[1].childNodes[1],this.TitleInput.id="exact_post_title_id",this.TitleInput.onpaste=e=>{let i=[];for(const n of e.clipboardData.files)i.push({file:n});if(i.length)return 1==i.length&&this.ChangeMainPostImage({target:{files:[i[0].file]}}),!1},this.ContentTextArea=document.getElementById("add_post_content"),setTimeout(()=>{this.userInput.title?this.ContentTextArea.focus():this.TitleInput.focus()},200),this.ContentTextArea.onpaste=e=>{let i=[];for(const n of e.clipboardData.files)i.push({file:n});if(i.length){if(1==i.length)this.selected_blobFile_callback_act(i[0].file);else for(let n=0,s=i.length;n<s;n++)this.selected_blobFile_callback_act(i[n].file);return!1}},this.isModify=!!this.userInput.id,this.InitBrowserBackButtonOverride()}go_to_profile(){this.modalCtrl.create({component:D.Q,componentProps:{isOfficial:this.isOfficial,target:this.target}}).then(e=>e.present())}select_server(e,i=!1){this.index=e,this.userInput.server=this.servers[e],this.isExpanded=!1,this.isOfficial=this.servers[e].isOfficial,this.target=this.servers[e].target,i?this.isServerChanged=this.OriginalServerInfo!=`${this.isOfficial}/${this.target}`:this.OriginalServerInfo=`${this.isOfficial}/${this.target}`,this.userInput.creator_name=this.nakama.users.self.display_name;try{this.userInput.creator_id=this.nakama.servers[this.isOfficial][this.target].session.user_id,this.userInput.UserColor=(this.userInput.creator_id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6),this.extended_buttons[7].isHide=2==this.useFirstCustomCDN}catch{this.userInput.creator_id="me",this.userInput.UserColor="888888",this.extended_buttons[7].isHide=1!=this.useFirstCustomCDN}}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.navigateBack("portal/community")})}AddVoiceTimeHistory(){this.userInput.content?this.userInput.content+=`\n{"i":"n","t":"${this.extended_buttons[5].name}"}\n`:this.userInput.content=`{"i":"n","t":"${this.extended_buttons[5].name}"}\n`,this.ContentTextArea.focus()}CreateFloatingVoiceTimeHistoryAddButton(){this.p5floatingButton&&this.p5floatingButton.remove(),this.p5floatingButton=new j(e=>{e.setup=()=>{e.noCanvas();let i=e.createDiv('<ion-icon style="width: 36px; height: 36px" name="timer-outline"></ion-icon>');i.style("position: absolute; right: 0; bottom: 56px; z-index: 1"),i.style("width: 64px; height: 64px"),i.style("text-align: center; align-content: center"),i.style("cursor: pointer"),i.style("margin: 16px"),i.style("padding-top: 6px"),i.style("background-color: #8888"),i.style("border-radius: 24px"),i.elt.onclick=()=>{this.AddVoiceTimeHistory(),this.p5toast.show({text:`${this.lang.text.AddPost.RecordVoiceTime}: ${this.extended_buttons[5].name}`})}}})}StopAndSaveVoiceRecording(){var e=this;return(0,_.A)(function*(){e.p5floatingButton&&e.p5floatingButton.remove();let i=yield e.loadingCtrl.create({message:e.lang.text.AddPost.SavingRecord});i.present();try{let n=yield A.R.stopRecording(),s=e.global.Base64ToBlob(`${n.value.mimeType},${n.value.recordDataBase64}`);s.name=`${e.lang.text.ChatRoom.VoiceRecord}.${n.value.mimeType.split("/").pop().split(";")[0]}`,s.type_override=n.value.mimeType,yield e.selected_blobFile_callback_act(s),i.dismiss()}catch(n){e.p5toast.show({text:`${e.lang.text.AddPost.FailedToSaveVoice}:${n}`}),i.dismiss()}e.extended_buttons[5].icon="mic-circle-outline",e.extended_buttons[5].name=e.lang.text.ChatRoom.Voice,e.checkVoiceLinker()})()}checkVoiceLinker(){this.p5canvas.StopVoiceTimer();let e=this.userInput.content.split("\n");for(let i=0,n=e.length;i<n;i++)try{let s=JSON.parse(e[i]);"n"==s.i&&(s.i=this.userInput.attachments.length-1),e[i]=JSON.stringify(s)}catch{}this.userInput.content=e.join("\n")}ChangeMainPostImage(e){let i=e.target.files[0],n={};n.filename=i.name,n.file_ext=i.name.split(".").pop()||i.type||this.lang.text.ChatRoom.unknown_ext,n.size=i.size,n.type=i.type||i.type_override,n.blob=i,n.path=`tmp_files/post/MainImage.${n.file_ext}`,this.userInput.mainImage=n;let s=URL.createObjectURL(i);this.indexed.saveBlobToUserPath(i,n.path),this.MainPostImage=s}selected_blobFile_callback_act(e,i=[],n="loaded",s){var r=this;return(0,_.A)(function*(){let a=r.global.selected_blobFile_callback_act(e,"tmp_files/post/",{user_id:"local"==r.isOfficial?"local":r.nakama.servers[r.isOfficial][r.target].session.user_id,display_name:r.nakama.users.self.display_name},n,i);r.create_selected_thumbnail(a),void 0===s?(r.AddAttachTextForm(),r.userInput.attachments.push(a)):r.userInput.attachments[s]=a,r.indexed.saveBlobToUserPath(a.blob,a.path)})()}AddAttachTextForm(){this.userInput.content?this.userInput.content+=`\n[${this.userInput.attachments.length}]\n`:this.userInput.content=`[${this.userInput.attachments.length}]\n`,this.ContentTextArea.focus()}create_selected_thumbnail(e){var i=this;return(0,_.A)(function*(){if(i.global.set_viewer_category_from_ext(e),e.url){try{(yield fetch(e.url,{signal:i.cont.signal})).ok&&(e.thumbnail=e.url)}catch{}return void(e.typeheader=e.viewer)}try{e.thumbnail=yield i.indexed.loadBlobFromUserPath(e.path,e.type)}catch{}let n=URL.createObjectURL(e.blob);"image"===(e.typeheader=e.blob.type.split("/")[0]||e.viewer,setTimeout(()=>{URL.revokeObjectURL(n)},0),e.thumbnail=void 0,e.typeheader)&&(e.thumbnail=i.sanitizer.bypassSecurityTrustUrl(n))})()}voidDraw_fileAct_callback(e,i,n){var s=this;return(0,_.A)(function*(){let r=yield s.global.voidDraw_fileAct_callback(e,"tmp_files/post/",{user_id:"local"==s.isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,display_name:s.nakama.users.self.display_name},i);r.thumbnail=s.sanitizer.bypassSecurityTrustUrl(e.data.img),void 0!==n?s.userInput.attachments[n]=r:s.userInput.attachments.push(r),e.data.loadingCtrl.dismiss()})()}new_attach(e,i=void 0){var n=this;return(0,_.A)(function*(){let s;switch(void 0===i&&(i={}),e.detail.value){case"load":document.getElementById("add_post_input").click();break;case"link":try{let r=i.url;if(void 0===r)try{r=yield n.mClipboard.paste()}catch{try{let o=yield n.global.GetValueFromClipboard();switch(o.type){case"text/plain":r=o.value;break;case"image/png":return void n.inputFileSelected({target:{files:[o.value]}})}}catch(o){throw o}}try{let p=n.global.Base64ToBlob(r),o=r.split(";")[0].split(":")[1];throw s=new File([p],`${n.lang.text.ChatRoom.FileLink}.${o.split("/").pop()}`,{type:o}),yield n.selected_blobFile_callback_act(s),"done"}catch(p){if("done"===p)throw p}try{if(0!=r.indexOf("http:")&&0!=r.indexOf("https:"))throw"\uc62c\ubc14\ub978 \uc6f9 \uc8fc\uc18c\uac00 \uc544\ub2d8";if(s&&void 0===i.filename)throw"\uc774\ubbf8 \ud30c\uc77c\uc774 \ucca8\ubd80\ub428, \ud1a0\uae00\ub9cc \uc2dc\ub3c4";if(!(yield fetch(r,{signal:n.cont.signal})).ok)throw"URL \uad6c\uc870\uac00 \uc815\uc0c1\uc774 \uc544\ub2d8"}catch(p){throw p}let a={};a.url=r,a.content_related_creator=[],i&&i.content_related_creator&&(a.content_related_creator=[...i.content_related_creator]),a.content_related_creator.push({user_id:"local"==n.isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:i.url?"shared":"link"}),a.content_creator={user_id:"local"==n.isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:i.url?"shared":"link"};let c=a.url.split(".");a.file_ext=i.file_ext||c.pop().split("?").shift(),a.filename=i.filename||decodeURIComponent(`${c.pop().split("/").pop()||n.lang.text.ChatRoom.ExternalLinkFile}.${a.file_ext}`),n.global.set_viewer_category_from_ext(a),a.type=i.type||"",a.typeheader=i.typeheader||a.viewer,n.global.modulate_thumbnail(a,a.url,n.cont),n.userInput.attachments.push(a)}catch(r){throw"done"==r?r:`\uc778\uc2dd \ubd88\uac00\ub2a5\ud55c URL \uc815\ubcf4: ${r}`}}})()}PostAttachContextMenu(e){this.p5toast.show({text:`${this.lang.text.AddPost.RemoveAttach}: ${this.userInput.attachments[e].filename}`}),this.userInput.attachments.splice(e,1);let i=this.userInput.content.split("\n");for(let n=i.length-1;n>=0;n--){let s=!1,r=i[n].length-1,a=0;try{a=Number(i[n].substring(1,r)),s="["==i[n].charAt(0)&&"]"==i[n].charAt(r)&&!isNaN(a)}catch{}if(s)if(e==a){if(""==i[n+1])try{i.splice(n+1,1)}catch{}i.splice(n,1)}else e<a&&(i[n]=`[${a-1}]`)}return this.userInput.content=i.join("\n"),!1}inputFileSelected(e){var i=this;return(0,_.A)(function*(){if(e.target.files.length)if(1!=e.target.files.length){let s=yield i.loadingCtrl.create({message:i.lang.text.ChatRoom.MultipleSend});s.present();for(let r=0,a=e.target.files.length;r<a;r++)s.message=`${a-r}: ${e.target.files[r].name}`,yield i.selected_blobFile_callback_act(e.target.files[r]);s.dismiss(),setTimeout(()=>{document.getElementById("add_post_input").value=""},300)}else{let s=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});s.present(),yield i.selected_blobFile_callback_act(e.target.files[0]),s.dismiss(),document.getElementById("add_post_input").value=""}})()}open_viewer(e,i){var n=this;let s=[];for(let r=0,a=this.userInput.attachments.length;r<a;r++)s.push({content:this.userInput.attachments[r]});this.lock_modal_open||(this.lock_modal_open=!0,delete this.global.p5key.KeyShortCut.Escape,this.modalCtrl.create({component:w.c,componentProps:{info:{content:e},path:e.path,alt_path:e.path,isOfficial:this.isOfficial,target:this.target,relevance:s,local:"local"==this.isOfficial},cssClass:"fullscreen"}).then(r=>{r.onDidDismiss().then(a=>{if(this.AddShortcut(),a.data)switch(a.data.type){case"image":let c=[];if(a.data.msg.content.content_related_creator&&(c=[...a.data.msg.content.content_related_creator]),a.data.msg.content.content_creator){let p=!1;for(let o=0,h=c.length;o<h;o++)if(c[o].user_id==a.data.msg.content.content_creator.user_id){p=!0;break}p||c.push(a.data.msg.content.content_creator)}return void this.modalCtrl.create({component:T.c,componentProps:{path:a.data.path||e.path,width:a.data.width,height:a.data.height,isDarkMode:a.data.isDarkMode,scrollHeight:a.data.scrollHeight},cssClass:"fullscreen"}).then(p=>{p.onDidDismiss().then(()=>{this.AddShortcut()}),p.onWillDismiss().then(function(){var o=(0,_.A)(function*(h){h.data&&(yield n.voidDraw_fileAct_callback(h,c,i))});return function(h){return o.apply(this,arguments)}}()),delete this.global.p5key.KeyShortCut.Escape,p.present()});case"text":this.selected_blobFile_callback_act(a.data.blob,a.data.contentRelated,"textedit",i)}}),delete this.global.p5key.KeyShortCut.Escape,r.present(),this.lock_modal_open=!1}))}toggle_custom_attach(e){var i=this;return(0,_.A)(function*(){switch(i.useFirstCustomCDN=(null!=e?e:i.useFirstCustomCDN+1)%("me"==i.userInput.creator_id?2:3),"Android"==B.aH&&(i.useFirstCustomCDN=2,i.extended_buttons[6].isHide=!0),i.extended_buttons[7].isHide=!("me"!=i.userInput.creator_id&&2!=i.useFirstCustomCDN||1==i.useFirstCustomCDN||i.userInput.OutSource),i.useFirstCustomCDN){case 0:i.extended_buttons[6].icon="cloud-offline-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.Detour;break;case 1:i.extended_buttons[6].icon="cloud-done-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.useFSS;break;case 2:i.extended_buttons[6].icon="server-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.forceSQL}localStorage.setItem("useFFSCDN",`${i.useFirstCustomCDN}`)})()}toggle_open_link(e){var i=this;return(0,_.A)(function*(){i.UseOutLink=null!=e?e:!i.UseOutLink,i.extended_buttons[7].icon=i.UseOutLink?"eye-outline":"eye-off-outline"})()}postData(){var e=this;return(0,_.A)(function*(){if(!e.userInput.title)return e.p5toast.show({text:e.lang.text.AddPost.NeedPostTitle}),void e.TitleInput.focus();e.useVoiceRecording&&(yield e.StopAndSaveVoiceRecording());let i=!!e.userInput.server.local;e.isApplyPostData=!0;let n=yield e.loadingCtrl.create({message:e.lang.text.AddPost.WIP});n.present(),e.isSaveClicked=!0;let s=e.userInput.server.isOfficial,r=e.userInput.server.target;if(e.isModify||e.isServerChanged){if(e.userInput.mainImage&&e.userInput.mainImage.url&&!e.userInput.mainImage.blob){try{let a=yield fetch(e.userInput.mainImage.url,{signal:e.cont.signal});a.ok&&(e.userInput.mainImage.blob=yield a.blob())}catch{}e.userInput.mainImage.blob=yield(yield fetch(e.userInput.mainImage.url,{signal:e.cont.signal})).blob()}for(let a=0,c=e.userInput.attachments.length;a<c;a++)if(e.userInput.attachments[a].url&&!e.userInput.attachments[a].blob)try{let p=yield fetch(e.userInput.attachments[a].url,{signal:e.cont.signal});p.ok&&(e.userInput.attachments[a].blob=yield p.blob())}catch{}yield e.nakama.RemovePost(e.userInput)}try{if(!e.isModify||e.isServerChanged)if(e.isServerChanged&&e.OriginalInfo&&(yield e.nakama.RemovePost(e.OriginalInfo)),i){let o=Number(yield e.indexed.loadTextFromUserPath("servers/local/target/posts/me/counter.txt"))||0;e.userInput.id=`LocalPost_${o}`;try{yield e.indexed.saveTextFileToUserPath(`${o+1}`,"servers/local/target/posts/me/counter.txt")}catch(h){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${h}`}),console.log(h)}}else try{let o=yield e.nakama.servers[s][r].client.readStorageObjects(e.nakama.servers[s][r].session,{object_ids:[{collection:"server_post",key:"Counter",user_id:e.nakama.servers[s][r].session.user_id}]}),h=0;o.objects.length&&(h=o.objects[0].value.counter),e.userInput.id=`ServerPost_${h}`,yield e.nakama.servers[s][r].client.writeStorageObjects(e.nakama.servers[s][r].session,[{collection:"server_post",key:"Counter",permission_write:1,permission_read:2,value:{counter:h+1}}])}catch(o){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${o}`}),console.log(o)}e.isModify?e.userInput.modify_time=(new Date).getTime():(e.userInput.create_time=(new Date).getTime(),e.userInput.modify_time=e.userInput.create_time);for(let o=0,h=e.userInput.attachments.length;o<h;o++)delete e.userInput.attachments[o].thumbnail;if(e.userInput.mainImage)if(n.message=e.lang.text.AddPost.SyncMainImage,e.userInput.mainImage.path=`servers/${s}/${r}/posts/${e.userInput.creator_id}/${e.userInput.id}/MainImage.${e.userInput.mainImage.file_ext}`,e.userInput.mainImage.thumbnail=e.MainPostImage,i)try{if(1!=e.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let o;if(n.message=`${e.lang.text.AddPost.SyncMainImage}: ${e.userInput.mainImage.filename}`,o=yield e.global.try_upload_to_user_custom_fs(e.userInput.mainImage,e.nakama.users.self.display_name,n),!o)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.mainImage.path,delete e.userInput.mainImage.partsize,e.userInput.mainImage.url=o}catch{yield e.indexed.saveBlobToUserPath(e.userInput.mainImage.blob,e.userInput.mainImage.path)}else try{if(2==e.useFirstCustomCDN)throw"SQL \uac15\uc81c";let o=e.nakama.servers[e.isOfficial][e.target].info.address,h=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:",y=yield e.global.upload_file_to_storage(e.userInput.mainImage,e.nakama.servers[e.isOfficial][e.target].session.user_id,h,o,1==e.useFirstCustomCDN,n);if(!y)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.mainImage.partsize,e.userInput.mainImage.url=y}catch{yield e.nakama.sync_save_file(e.userInput.mainImage,s,r,"server_post",`${e.userInput.id}_mainImage`)}let a=e.userInput.attachments.length;if(a){n.message=e.lang.text.AddPost.SyncAttaches;for(let o=a-1;o>=0;o--)if(i)try{if(1!=e.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let h;if(n.message=`${e.lang.text.AddPost.SyncAttaches}: [${o}]${e.userInput.attachments[o].filename}`,h=yield e.global.try_upload_to_user_custom_fs(e.userInput.attachments[o],e.nakama.users.self.display_name,n),!h)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.attachments[o].path,delete e.userInput.attachments[o].partsize,e.userInput.attachments[o].url=h}catch{e.userInput.attachments[o].path=`servers/${s}/${r}/posts/${e.userInput.creator_id}/${e.userInput.id}/[${o}]${e.userInput.attachments[o].filename}`,yield e.indexed.saveBlobToUserPath(e.userInput.attachments[o].blob,e.userInput.attachments[o].path)}else try{if(2==e.useFirstCustomCDN)throw"SQL \uac15\uc81c";let h=e.nakama.servers[e.isOfficial][e.target].info.address,y=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:",v=yield e.global.upload_file_to_storage(e.userInput.attachments[o],e.nakama.servers[e.isOfficial][e.target].session.user_id,y,h,1==e.useFirstCustomCDN,n);if(!v)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.attachments[o].partsize,e.userInput.attachments[o].url=v}catch(h){"SQL \uac15\uc81c"==h&&e.userInput.attachments[o].url&&!e.userInput.attachments[o].blob&&(e.userInput.attachments[o].blob=yield(yield fetch(e.userInput.attachments[o].url,{signal:e.cont.signal})).blob()),yield e.nakama.sync_save_file(e.userInput.attachments[o],s,r,"server_post",`${e.userInput.id}_attach_${o}`)}}if(e.userInput.OutSource&&(yield e.global.remove_file_from_storage(e.userInput.OutSource),e.userInput.OutSource=void 0),e.UseOutLink){let o=new Blob([JSON.stringify(e.userInput)],{type:"text/plain"}),h={blob:o,filename:`${e.userInput.id}.json`,file_ext:"json",size:o.size};try{let y=e.nakama.servers[e.isOfficial][e.target].info.address,v=e.nakama.servers[e.isOfficial][e.target].session.user_id,d=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:";n.message=`${e.lang.text.AddPost.SyncPostInfo}`;let I=yield e.global.upload_file_to_storage(h,v,d,y,1==e.useFirstCustomCDN);if(!I)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";e.userInput.OutSource=I}catch{try{let v=e.nakama.users.self.display_name;n.message=`${e.lang.text.AddPost.SyncPostInfo}`;let d=yield e.global.try_upload_to_user_custom_fs(h,v);if(!d)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";e.userInput.OutSource=d}catch(v){e.userInput.OutSource=void 0,e.UseOutLink=!1,e.p5toast.show({text:`${e.lang.text.AddPost.OutLinkFailed}: ${v}`})}}}let c=JSON.parse(JSON.stringify(e.userInput));c.mainImage&&delete c.mainImage.blob;for(let o=c.attachments.length-1;o>=0;o--)delete c.attachments[o].blob;delete c.server;try{e.nakama.posts_orig[s][r]||(e.nakama.posts_orig[s][r]={}),e.nakama.posts_orig[s][r][e.userInput.creator_id]||(e.nakama.posts_orig[s][r][e.userInput.creator_id]={}),e.nakama.posts_orig[s][r][e.userInput.creator_id][e.userInput.id]=e.userInput}catch(o){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${o}`}),console.log(o)}let p=JSON.stringify(c);if(yield e.indexed.saveTextFileToUserPath(p,`servers/${s}/${r}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`),!i){let o=new Blob([p],{type:"application/json"}),h={filename:"info.json"};h.blob=o,h.size=o.size,h.type="application/json",h.file_ext="txt",h.typeheader="text",h.path=`servers/${s}/${r}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`,yield e.nakama.sync_save_file(h,s,r,"server_post",e.userInput.id)}e.nakama.rearrange_posts()}catch(a){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${a}`}),console.warn("\uac8c\uc2dc\ubb3c \uc800\uc7a5 \ucc98\ub9ac \uc624\ub958: ",a)}try{yield e.nakama.servers[e.isOfficial][e.target].client.rpc(e.nakama.servers[e.isOfficial][e.target].session,"send_noti_all_fn",{noti_id:O.I.MANAGE_POST,type:"add",user_id:e.userInput.creator_id,post_id:e.userInput.id,persistent:!1})}catch{}n.dismiss(),e.navCtrl.navigateBack("portal/community")})()}ionViewWillLeave(){if(this.cont.abort(),delete this.global.p5key.KeyShortCut.Escape,this.global.p5key.KeyShortCut.BottomTab=this.BottomTabShortcut,this.indexed.GetFileListFromDB("tmp_files/post").then(e=>e.forEach(i=>this.indexed.removeFileFromUserPath(i))),!this.isApplyPostData)try{this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id]&&delete this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id],this.nakama.load_local_post_with_id(this.userInput.id,this.userInput.server.isOfficial,this.userInput.server.target,this.userInput.creator_id),this.nakama.rearrange_posts()}catch{}}}return(u=g).\u0275fac=function(e){return new(e||u)(t.rXU(U.z3),t.rXU(M.y),t.rXU(N.q9),t.rXU(O.X),t.rXU(f.W3),t.rXU(L.G),t.rXU(E.n),t.rXU(f.Xi),t.rXU(V.up),t.rXU(G.B),t.rXU(P.nX),t.rXU(P.Ix))},u.\u0275cmp=t.VBU({type:u,selectors:[["app-add-post"]],decls:30,vars:19,consts:[["accordionGroup",""],[1,"ion-no-border"],[4,"ngIf"],["slot","start"],["defaultHref","portal/community"],["id","p5Drop_addPost",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],["button","",3,"click"],[1,"additional_form","new_bg_form"],[1,"ion-text-end"],["style","width: 100%; text-align: center; text-align: -webkit-center; padding: 8px;",4,"ngIf"],["button",""],["id","add_post_title",3,"ngModelChange","disabled","placeholder","ngModel"],["id","add_post_content",1,"infobox",2,"height","50%",3,"ngModelChange","disabled","placeholder","ngModel"],["hidden","","type","file","id","add_post_input","accept","*","multiple","",3,"change"],["hidden","","type","file","id","PostMainImage_sel","accept","image/*",3,"change"],[2,"width","100%","text-align","center","padding-bottom","16px"],["style","display: inline-block;",4,"ngFor","ngForOf"],["button","",3,"disabled","click","contextmenu",4,"ngFor","ngForOf"],["button","",3,"click","disabled"],[1,"ion-text-center"],["value","colors","expand","inset",3,"click","disabled","value"],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],[2,"width","100%","text-align","center","text-align","-webkit-center","padding","8px"],[2,"pointer-events","none",3,"ngModelChange","ngModel"],[1,"thumbnail_image",2,"width","400px","padding-top","8px"],["alt","MainPostImage",3,"src"],[2,"display","inline-block"],[1,"ext_button","ext_button_override",3,"click","hidden"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"],["button","",3,"click","contextmenu","disabled"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"]],template:function(e,i){1&e&&(t.j41(0,"ion-header",1)(1,"ion-toolbar"),t.DNE(2,X,2,1,"ion-title",2)(3,Y,2,1,"ion-title",2),t.j41(4,"ion-buttons",3),t.nrm(5,"ion-back-button",4),t.k0s()()(),t.j41(6,"ion-content"),t.nrm(7,"div",5),t.DNE(8,H,11,5,"ion-accordion-group",6),t.j41(9,"ion-item",7),t.bIt("click",function(){return i.go_to_profile()}),t.nrm(10,"div",8),t.j41(11,"ion-label"),t.EFF(12),t.k0s(),t.j41(13,"ion-label",9),t.EFF(14),t.k0s()(),t.j41(15,"ion-item-divider")(16,"ion-label"),t.EFF(17),t.k0s()(),t.DNE(18,z,6,5,"div",10),t.j41(19,"ion-item",11)(20,"ion-input",12),t.mxI("ngModelChange",function(s){return t.DH7(i.userInput.title,s)||(i.userInput.title=s),s}),t.k0s()(),t.j41(21,"textarea",13),t.mxI("ngModelChange",function(s){return t.DH7(i.userInput.content,s)||(i.userInput.content=s),s}),t.k0s(),t.j41(22,"input",14),t.bIt("change",function(s){return i.inputFileSelected(s)}),t.k0s(),t.j41(23,"input",15),t.bIt("change",function(s){return i.ChangeMainPostImage(s)}),t.k0s(),t.j41(24,"div",16),t.DNE(25,Q,6,6,"div",17),t.k0s(),t.DNE(26,Z,5,3,"ion-item",18),t.j41(27,"ion-item",19),t.bIt("click",function(){return i.postData()}),t.j41(28,"ion-label",20),t.EFF(29),t.k0s()()()),2&e&&(t.R7$(2),t.Y8G("ngIf",i.isModify),t.R7$(),t.Y8G("ngIf",!i.isModify),t.R7$(5),t.Y8G("ngIf",i.servers.length),t.R7$(2),t.Aen("background-image: linear-gradient(to right, #0000, #"+i.userInput.UserColor+"44)"),t.R7$(2),t.JRh(i.lang.text.AddPost.Creator),t.R7$(2),t.JRh(i.userInput.creator_name||i.lang.text.Profile.noname_user),t.R7$(3),t.JRh(i.lang.text.AddPost.AddNewPost),t.R7$(),t.Y8G("ngIf",i.MainPostImage),t.R7$(2),t.Y8G("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.TitlePlaceholder),t.R50("ngModel",i.userInput.title),t.R7$(),t.Y8G("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.ContentPlaceHolder),t.R50("ngModel",i.userInput.content),t.R7$(4),t.Y8G("ngForOf",i.extended_buttons),t.R7$(),t.Y8G("ngForOf",i.userInput.attachments),t.R7$(),t.Y8G("disabled",i.isSaveClicked),t.R7$(2),t.JRh(i.lang.text.AddPost.Post))},dependencies:[S.Sq,S.bT,C.me,C.BC,C.vS,f.xk,f.YH,f.QW,f.W9,f.eU,f.iq,f.$w,f.uz,f.Dg,f.he,f.BC,f.BY,f.ai,f.hB,f.Gw,f.el],styles:[".ext_button_override[_ngcontent-%COMP%]{margin:12px;cursor:pointer}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover;border-radius:16px;overflow:hidden}"]}),g})()}];let ee=(()=>{var u;class g{}return(u=g).\u0275fac=function(e){return new(e||u)},u.\u0275mod=t.$C({type:u}),u.\u0275inj=t.G2t({imports:[P.iI.forChild(q),P.iI]}),g})(),te=(()=>{var u;class g{}return(u=g).\u0275fac=function(e){return new(e||u)},u.\u0275mod=t.$C({type:u}),u.\u0275inj=t.G2t({imports:[S.MD,C.YN,f.bv,ee]}),g})()}}]);