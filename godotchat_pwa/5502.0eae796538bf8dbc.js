"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5502],{5502:(pt,R,_)=>{_.r(R),_.d(R,{MinimalChatPageModule:()=>mt});var P=_(177),k=_(4341),m=_(5374),I=_(9858),b=_(467),S=_(9349),v=_(482),T=_(7892),N=_(736),U=_(8326),t=_(3953),B=_(9347),E=_(5547),O=_(345),X=_(3656),J=_(8065),V=_(4234),H=_(9900),Y=_(755);const Q=["MinimalChatServer"],z=["SQNewAttach"],L=["minimalchat_input"];function W(o,d){if(1&o){const a=t.RV6();t.j41(0,"ion-item",31),t.nrm(1,"ion-icon",32),t.j41(2,"ion-input",33),t.mxI("ngModelChange",function(e){t.eBV(a);const s=t.XpG();return t.DH7(s.client.FallbackOverrideAddress,e)||(s.client.FallbackOverrideAddress=e),t.Njj(e)}),t.k0s(),t.j41(3,"ion-icon",34),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.global.open_custom_site(e.client.FallbackOverrideAddress))}),t.k0s()()}if(2&o){const a=t.XpG();t.Y8G("disabled","idle"!=a.client.status),t.R7$(2),t.Y8G("label",a.lang.text.Settings.OverrideFallbackFS),t.R50("ngModel",a.client.FallbackOverrideAddress)}}function K(o,d){if(1&o&&(t.j41(0,"ion-select-option",41),t.EFF(1),t.k0s()),2&o){const a=d.$implicit;t.Y8G("value",a),t.R7$(),t.JRh(a.info.name)}}function q(o,d){if(1&o){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-select",38,2),t.bIt("ionChange",function(e){t.eBV(a);const s=t.XpG(2);return t.Njj(s.SelectAddressTarget(e))}),t.j41(3,"ion-select-option",39),t.EFF(4),t.k0s(),t.DNE(5,K,2,2,"ion-select-option",40),t.k0s()()}if(2&o){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.AddGroup.SelectServer),t.R7$(3),t.JRh(a.lang.text.voidDraw.InternalConn),t.R7$(),t.Y8G("ngForOf",a.ServerList)}}function Z(o,d){if(1&o){const a=t.RV6();t.j41(0,"ion-item")(1,"ion-input",42),t.mxI("ngModelChange",function(e){t.eBV(a);const s=t.XpG(2);return t.DH7(s.UserInputCustomAddress,e)||(s.UserInputCustomAddress=e),t.Njj(e)}),t.k0s(),t.j41(2,"ion-icon",34),t.bIt("click",function(){t.eBV(a);const e=t.XpG(2);return t.Njj(e.global.open_custom_site(e.UserInputCustomAddress))}),t.k0s()()}if(2&o){const a=t.XpG(2);t.R7$(),t.Y8G("label",a.lang.text.voidDraw.InputAddress),t.R50("ngModel",a.UserInputCustomAddress)}}function tt(o,d){if(1&o){const a=t.RV6();t.j41(0,"div",10),t.DNE(1,q,6,3,"ion-item",16)(2,Z,3,2,"ion-item",16),t.j41(3,"ion-item")(4,"ion-input",35),t.mxI("ngModelChange",function(e){t.eBV(a);const s=t.XpG();return t.DH7(s.client.JoinedChannel,e)||(s.client.JoinedChannel=e),t.Njj(e)}),t.k0s()(),t.j41(5,"ion-item",36),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.init_joinChat())}),t.j41(6,"ion-label",37),t.EFF(7),t.k0s()()()}if(2&o){const a=t.XpG();t.R7$(),t.Y8G("ngIf",a.ServerList.length),t.R7$(),t.Y8G("ngIf",a.NeedInputCustomAddress),t.R7$(2),t.Y8G("label",a.lang.text.voidDraw.ChannelIdAddress),t.R50("ngModel",a.client.JoinedChannel),t.R7$(3),t.JRh(a.lang.text.voidDraw.ConnectToAddress)}}function et(o,d){if(1&o){const a=t.RV6();t.j41(0,"div")(1,"img",43),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.copy_qr_address())}),t.k0s(),t.j41(2,"ion-item",36),t.bIt("click",function(){t.eBV(a);const e=t.XpG();return t.Njj(e.copy_qr_address(e.client.JoinedChannel))}),t.j41(3,"ion-label",44),t.EFF(4),t.k0s()()()}if(2&o){const a=t.XpG();t.R7$(),t.Y8G("src",a.QRCodeSRC,t.B4B),t.R7$(3),t.JRh(a.client.JoinedChannel)}}function it(o,d){if(1&o&&(t.j41(0,"font",47),t.EFF(1),t.k0s()),2&o){const a=t.XpG().$implicit;t.Mz_("color","#",a.color,""),t.R7$(),t.JRh(" "+a.text)}}function nt(o,d){if(1&o&&(t.j41(0,"b"),t.EFF(1),t.k0s()),2&o){const a=t.XpG(2).$implicit;t.R7$(),t.SpI("",a.target,":")}}function at(o,d){if(1&o&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&o){const a=t.XpG().$implicit;t.R7$(),t.JRh(a.text)}}function st(o,d){if(1&o){const a=t.RV6();t.j41(0,"a",50),t.bIt("click",function(){t.eBV(a);const e=t.XpG().$implicit,s=t.XpG(4);return t.Njj(s.open_url_link(e.text))}),t.EFF(1),t.k0s()}if(2&o){const a=t.XpG().$implicit;t.Y8G("href",a.text,t.B4B),t.R7$(),t.JRh(a.text)}}function lt(o,d){if(1&o&&(t.j41(0,"span"),t.DNE(1,at,2,1,"span",16)(2,st,2,2,"a",49),t.k0s()),2&o){const a=d.$implicit;t.R7$(),t.Y8G("ngIf",!a.href),t.R7$(),t.Y8G("ngIf",a.href)}}function ot(o,d){if(1&o&&(t.j41(0,"span"),t.DNE(1,lt,3,2,"span",17),t.k0s()),2&o){const a=t.XpG(2).$implicit;t.R7$(),t.Y8G("ngForOf",a.text)}}function rt(o,d){if(1&o&&(t.j41(0,"span"),t.EFF(1),t.k0s()),2&o){const a=t.XpG(3).$implicit;t.R7$(),t.SpI(" ",a.Progress," ")}}function ct(o,d){if(1&o){const a=t.RV6();t.j41(0,"span")(1,"span",51),t.bIt("click",function(){t.eBV(a);const e=t.XpG(2).$implicit,s=t.XpG();return t.Njj(s.open_file_viewer(e.file.info))}),t.EFF(2),t.k0s(),t.DNE(3,rt,2,1,"span",16),t.k0s()}if(2&o){const a=t.XpG(2).$implicit,i=t.XpG();t.R7$(2),t.JRh(i.lang.text.ChatRoom.attachments+": "+a.file.info.filename),t.R7$(),t.Y8G("ngIf",a.Progress)}}function ht(o,d){if(1&o&&(t.j41(0,"font",48)(1,"font",47),t.DNE(2,nt,2,1,"b",16),t.k0s(),t.DNE(3,ot,2,1,"span",16)(4,ct,4,2,"span",16),t.k0s()),2&o){const a=t.XpG().$implicit;t.R7$(),t.Mz_("color","#",a.color,""),t.R7$(),t.Y8G("ngIf",a.target),t.R7$(),t.Y8G("ngIf",a.text),t.R7$(),t.Y8G("ngIf",a.file)}}function dt(o,d){if(1&o&&(t.j41(0,"p"),t.DNE(1,it,2,3,"font",45)(2,ht,5,5,"font",46),t.k0s()),2&o){const a=d.$implicit;t.R7$(),t.Y8G("ngIf",!a.target),t.R7$(),t.Y8G("ngIf",a.target)}}const ut=[{path:"",component:(()=>{var o;class d{constructor(i,e,s,l,n,h,r,c,p,g,u,f,C,x){this.client=i,this.noti=e,this.title=s,this.modalCtrl=l,this.navCtrl=n,this.route=h,this.router=r,this.statusBar=c,this.lang=p,this.global=g,this.p5toast=u,this.indexed=f,this.loadingCtrl=C,this.alertCtrl=x,this.Header="ranchat",this.iconColor="d8d8d8",this.lnId=12,this.req_refreshed=!1,this.isMobileApp=!1,this.open_this=F=>{this.noti.Current==this.Header?window.focus():this.client.RejoinGroupChat()},this.NeedInputCustomAddress=!1,this.UserInputCustomAddress=void 0}open_url_link(i){var e=this;return(0,b.A)(function*(){if(0==i.indexOf("https://is2you2.github.io/godotchat_pwa/?")){let s=e.global.CatchGETs(i)||{};e.global.initialize();try{yield e.client.nakama.AddressToQRCodeAct(s)}catch(l){e.p5toast.show({text:`${e.lang.text.ChatRoom.QRLinkFailed}: ${l}`})}}else window.open(i,"_blank")})()}ngOnInit(){var i=this;this.route.queryParams.subscribe(function(){var e=(0,b.A)(function*(s){const l=i.router.getCurrentNavigation().extras.state;yield new Promise(n=>setTimeout(n,100)),l&&(i.client.MyUserName=l.name,i.client.JoinedChannel=l.channel||i.client.JoinedChannel,l.address&&(i.UserInputCustomAddress=l.address,i.init_joinChat()))});return function(s){return e.apply(this,arguments)}}()),window.onfocus=()=>{this.lnId&&this.noti.ClearNoti(this.lnId)},this.isMobileApp="Android"==S.aH||"iOS"==S.aH,this.header_title=this.lang.text.MinimalChat.header_title_group,this.minimal_chat_log=document.getElementById("minimal_chat_div"),this.minimal_chat_log.onscroll=e=>{this.minimal_chat_log.scrollHeight==this.minimal_chat_log.scrollTop+this.minimal_chat_log.clientHeight&&this.scroll_down()},this.ServerList=this.client.nakama.get_all_online_server(),setTimeout(()=>{this.MinimalChatServer?(this.MinimalChatServer.value=this.ServerList[0]||"local",this.SelectAddressTarget({detail:{value:this.MinimalChatServer.value}})):this.NeedInputCustomAddress=!0},0),this.client.cacheAddress&&this.CreateQRCode(),setTimeout(()=>{this.CreateDrop()},100)}ionViewWillEnter(){this.DomMinimalChatInput=document.getElementById("minimalchat_input"),this.client.p5canvas&&this.client.p5canvas.remove(),this.DomMinimalChatInput.onpaste=i=>{let e=[];for(const s of i.clipboardData.files)e.push({file:s});if(1==e.length)return this.SendAttachAct({target:{files:[e[0].file]}}),!1},this.client.IsConnected&&this.focus_on_input()}AddShortCut(){this.global.p5key.KeyShortCut.EnterAct=()=>{document.activeElement!=this.DomMinimalChatInput&&setTimeout(()=>{this.focus_on_input()},0)},this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()}}open_select_new(){delete this.global.p5key.KeyShortCut.Escape;let i=["camera","image","text","load"];this.global.p5key.KeyShortCut.Digit=e=>{delete this.global.p5key.KeyShortCut.Digit,i.length>e&&this.new_attach({detail:{value:i[e]}})},this.SQNewAttach&&this.SQNewAttach.open()}new_attach(i){var e=this;return(0,b.A)(function*(){switch(i.detail.value){case"camera":try{let l=yield e.global.from_camera("tmp_files/todo/",{display_name:e.client.MyUserName});l.content_creator.display_name=e.client.MyUserName,l.content_related_creator[0].display_name=e.client.MyUserName,e.TrySendingAttach(l)}catch(l){console.log("\ucd2c\uc601 \uc2e4\ud328: ",l),e.p5toast.show({text:`${e.lang.text.GlobalAct.ErrorFromCamera}: ${l}`})}e.AddShortCut(),e.auto_scroll_down(100);break;case"text":let s=e.global.TextEditorNewFileName();e.modalCtrl.create({component:T.c,componentProps:{info:{content:{is_new:"text",type:"text/plain",viewer:"text",filename:s}},no_edit:!0}}).then(l=>{e.global.StoreShortCutAct("minimal-textedit"),l.onWillDismiss().then(n=>{if(n.data){let h=e.global.TextEditorAfterAct(n.data,{display_name:e.client.MyUserName});e.TrySendingAttach(h),e.auto_scroll_down()}}),l.onDidDismiss().then(()=>{e.global.RestoreShortCutAct("minimal-textedit")}),l.present()});break;case"image":e.modalCtrl.create({component:N.c,cssClass:"fullscreen"}).then(l=>{e.global.StoreShortCutAct("minimal-image"),l.onWillDismiss().then(function(){var n=(0,b.A)(function*(h){if(h.data){let r=yield e.global.voidDraw_fileAct_callback(h,"tmp_files/square/",{display_name:e.client.MyUserName});e.TrySendingAttach(r)}});return function(h){return n.apply(this,arguments)}}()),l.onDidDismiss().then(()=>{e.global.RestoreShortCutAct("minimal-image")}),l.present()});break;case"load":e.SelectAttach(),e.AddShortCut()}e.SQNewAttach.value=""})()}CreateDrop(){var i=this;let e=document.getElementById("p5Drop_chatroom");this.p5canvas=new U(s=>{s.setup=()=>{let c=s.createCanvas(e.clientWidth,e.clientHeight);c.parent(e),s.pixelDensity(.1),c.drop(p=>{let g=s.millis();h<g-400?(n=!1,r.length=0,r.push(p)):(n=!0,r.push(p)),h=g,clearTimeout(l),l=setTimeout((0,b.A)(function*(){if(n)i.alertCtrl.create({header:i.lang.text.ChatRoom.MultipleSend,message:`${i.lang.text.ChatRoom.CountFile}: ${r.length}`,buttons:[{text:i.lang.text.ChatRoom.Send,handler:()=>{for(let u=0,f=r.length;u<f;u++)i.SendAttachAct({target:{files:[r[u].file]}})}}]}).then(u=>{i.global.StoreShortCutAct("minimal-multiple-send"),i.global.p5key.KeyShortCut.Escape=()=>{u.dismiss()},u.onDidDismiss().then(()=>{i.global.RestoreShortCutAct("minimal-multiple-send")}),u.present()});else{let u=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});u.present(),i.SendAttachAct({target:{files:[p.file]}}),u.dismiss()}}),400)})};let l,n=!1,h=0,r=[];s.mouseMoved=c=>{c.dataTransfer?(e.style.pointerEvents="all",e.style.backgroundColor="#0008"):(e.style.pointerEvents="none",e.style.backgroundColor="transparent")}})}CreateQRCode(){var i=this;return(0,b.A)(function*(){i.QRCodeSRC=void 0;let s,e=0==i.client.cacheAddress.indexOf("ws:");try{let l=(e?"http":"https")+"://"+i.client.cacheAddress.split("://")[1],n=`${l}:${e?8080:8443}${window.sub_path}`;const h=new AbortController,r=setTimeout(()=>{h.abort()},500);let c=yield fetch(n,{signal:h.signal});if(clearTimeout(r),!c.ok)throw"\uc8fc\uc18c \uc5c6\uc74c";s=`${l}:${e?8080:8443}${window.sub_path}`}catch{s=`${S.d2}godotchat_pwa/`}i.QRCodeTargetString=`${s}?group_dedi=${i.client.cacheAddress},${i.client.JoinedChannel||"public"}`,i.QRCodeSRC=i.global.readasQRCodeFromString(i.QRCodeTargetString)})()}SelectAddressTarget(i){"local"===(this.header_title=this.lang.text.MinimalChat.header_title_group,this.title.setTitle(this.lang.text.MinimalChat.WebTitle_group),i.detail.value)?(this.UserInputCustomAddress="",this.NeedInputCustomAddress=!0):(this.UserInputCustomAddress=i.detail.value.info.address,this.NeedInputCustomAddress=!1)}init_joinChat(){var i=this;if(this.client.status="custom",this.Header="simplechat",this.noti.ClearNoti(this.lnId),this.noti.Current=this.Header,document.getElementById("favicon").setAttribute("href","assets/icon/simplechat.png"),!this.client.client||this.client.client.readyState!=this.client.client.OPEN&&(!this.client.p5canvas||!this.client.p5canvas.OnDediMessage)){this.client.userInput.logs.length=0;let l={color:v.ud?"bbb":"444",text:this.lang.text.MinimalChat.joinChat_group,isSystem:!0};this.client.userInput.logs.push(l),this.client.userInput.last_message=l;let n=this.UserInputCustomAddress.split("://"),h=n.pop().split(":"),r=n.pop();r?r+=":":r=this.global.checkProtocolFromAddress(h[0])?"wss:":"ws:",this.client.initialize(`${r}//${h[0]}`)}const s=[{title:this.lang.text.MinimalChat.Noti_Reply,action:"sq_reply",type:"text"}];this.client.funcs.onmessage=l=>{try{let n=JSON.parse(l);this.client.JoinedChannel||(this.client.JoinedChannel=n.channel),this.client.uuid||(this.client.uuid=n.uid,this.client.FallbackOverrideAddress&&this.client.uuid&&this.FFSOverrideConnect());let h=this.client.uuid==n.uid,r=h?this.client.MyUserName||this.lang.text.MinimalChat.name_me:n.name||this.lang.text.MinimalChat.name_stranger_group,c=n.uid?(n.uid.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6):v.ud?"888888":"444444";if(this.client.p5canvas&&this.client.p5canvas.OnDediMessage&&this.client.p5canvas.OnDediMessage(c),n.msg){let g=n.msg.split(" "),u=[];for(let C=0,x=g.length;C<x;C++)0==g[C].indexOf("http://")||0==g[C].indexOf("https://")?(u.push({text:" "}),u.push({href:!0,text:g[C]})):u.push({text:" "+g[C]});let f={color:c,text:u,target:r,isMe:h};this.client.userInput.logs.push(f),this.client.userInput.last_message=f}else if(n.type)switch(n.type){case"join":let g={color:c,text:[{text:" "+this.lang.text.MinimalChat.user_join_comment}],target:r,isSystem:!0};this.client.userInput.logs.push(g),this.client.userInput.last_message=g;break;case"leave":let u={color:c,text:[{text:" "+this.lang.text.MinimalChat.user_out_comment}],target:r,isSystem:!0};this.client.userInput.logs.push(u),this.client.userInput.last_message=u;break;case"file":let f={color:c,file:n,target:r,isMe:h};if(this.client.userInput.logs.push(f),this.client.userInput.last_message=f,!n.info.url){let C=n.info;this.client.DownloadPartManager[n.uid]||(this.client.DownloadPartManager[n.uid]={}),this.client.DownloadPartManager[n.uid][n.temp_id]||(this.client.DownloadPartManager[n.uid][n.temp_id]=f),f.Progress=C.partsize}break;case"part":return this.client.DownloadPartManager[n.uid][n.temp_id].Progress--,void this.indexed.checkIfFileExist(n.path,C=>{C||this.indexed.saveBase64ToUserPath(","+n.part,`${n.path}_${n.index}`)});case"EOF":return void this.indexed.checkIfFileExist(n.path,function(){var C=(0,b.A)(function*(x){x?i.indexed.removeFileFromUserPath(`${n.path}.history`):(yield new Promise(function(){var F=(0,b.A)(function*($,D){let A=[],G=0;for(let y=0,j=n.partsize;y<j;y++)try{let M=yield i.indexed.GetFileInfoFromDB(`${n.path}_${y}`);G+=M.contents.length,A[y]=M}catch(M){console.log("\ud30c\uc77c \ubcd1\ud569\ud558\uae30 \uc624\ub958: ",M);break}try{let y=new Int8Array(G),j=0;for(let M=0,w=A.length;M<w;M++)y.set(A[M].contents,j),j+=A[M].contents.length;yield i.indexed.saveInt8ArrayToUserPath(y,n.path);for(let M=0,w=n.partsize;M<w;M++)i.indexed.removeFileFromUserPath(`${n.path}_${M}`);yield i.indexed.removeFileFromUserPath(`${n.path}.history`)}catch(y){console.log("\ud30c\uc77c \ucd5c\uc885 \uc800\uc7a5\ud558\uae30 \uc624\ub958: ",y),D()}$(void 0)});return function($,D){return F.apply(this,arguments)}}()),delete i.client.DownloadPartManager[n.uid][n.temp_id].Progress,delete i.client.DownloadPartManager[n.uid][n.temp_id])});return function(x){return C.apply(this,arguments)}}())}let p="certified";if(n.count&&(this.client.ConnectedNow=n.count),n.msg)this.noti.PushLocal({id:this.lnId,title:r,body:n.msg,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},actions_ln:["group_dedi"],actions_wm:s,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor,autoCancel_ln:!0},this.Header,this.open_this);else if(n.type)switch(n.type){case"join":this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.user_join,body:r+` | ${this.lang.text.MinimalChat.user_join_comment}`,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},actions_ln:["group_dedi"],actions_wm:s,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor,autoCancel_ln:!0},this.Header,this.open_this);break;case"leave":p="pending",this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.user_out,body:r+` | ${this.lang.text.MinimalChat.user_out_comment}`,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},actions_ln:["group_dedi"],actions_wm:s,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor,autoCancel_ln:!0},this.Header,this.open_this);break;case"file":this.noti.PushLocal({id:this.lnId,title:r,body:this.lang.text.MinimalChat.user_send_attach,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},actions_ln:["group_dedi"],actions_wm:s,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor,autoCancel_ln:!0},this.Header,this.open_this)}this.statusBar.settings.dedicated_groupchat=p,setTimeout(()=>{this.statusBar.settings.dedicated_groupchat==p&&(this.statusBar.settings.dedicated_groupchat="online")},250)}catch{}this.auto_scroll_down()},this.client.funcs.onclose=l=>{this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let n={color:"faa",text:this.lang.text.MinimalChat.failed_to_join,isSystem:!0};this.client.userInput.logs.push(n),this.client.userInput.last_message=n,this.noti.PushLocal({id:this.lnId,title:this.lang.text.MinimalChat.failed_to_join,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},autoCancel_ln:!0,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor},this.Header,this.open_this),this.client.p5canvas&&this.client.p5canvas.OnDediMessage&&this.client.p5canvas.OnDediMessage("ff0000"),this.client.disconnect()},this.client.funcs.onopen=l=>{this.CreateQRCode(),this.statusBar.settings.dedicated_groupchat="online",this.client.send(JSON.stringify({name:this.client.MyUserName,type:"join",channel:this.client.JoinedChannel||"public"})),this.client.funcs.onclose=h=>{this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let r=this.lang.text.MinimalChat.cannot_join,c={color:"faa",text:r,isSystem:!0};this.client.userInput.logs.push(c),this.client.userInput.last_message=c,this.noti.PushLocal({id:this.lnId,title:r,group_ln:"simplechat",extra_ln:{type:"MinimalChatPage",componentProps:{address:this.UserInputCustomAddress,name:this.client.MyUserName}},actions_ln:["group_dedi"],actions_wm:s,autoCancel_ln:!0,smallIcon_ln:"simplechat",iconColor_ln:this.iconColor},this.Header,this.open_this),this.client.p5canvas&&this.client.p5canvas.OnDediMessage&&this.client.p5canvas.OnDediMessage("ff0000")}}}FFSOverrideConnect(){let i=this.client.FallbackOverrideAddress.split("://"),e=i.pop();this.client.FFSClient=new WebSocket(`${i.pop()?"wss:":"ws:"}//${e}:12013`),this.client.FFSClient.onopen=()=>{this.client.FFSClient.send(JSON.stringify({type:"override",clientId:this.client.uuid,channel:this.client.JoinedChannel,name:this.client.MyUserName}))}}copy_qr_address(i=this.QRCodeTargetString){this.global.WriteValueToClipboard("text/plain",i)}SelectAttach(){document.getElementById("minimal_chat_file").click()}SendAttachAct(i){var e=this;return(0,b.A)(function*(){let s=i.target.files[0],l={};l.blob=s,l.filename=s.name,l.size=s.size,l.file_ext=s.name.split(".").pop(),l.type=s.type,e.global.set_viewer_category(l),l.content_related_creator=[{user_id:e.client.MyUserName,timestamp:(new Date).getTime(),display_name:e.client.MyUserName,various:"loaded"}],l.content_creator={user_id:e.client.MyUserName,timestamp:(new Date).getTime(),display_name:e.client.MyUserName,various:"loaded"},e.TrySendingAttach(l)})()}TrySendingAttach(i){var e=this;return(0,b.A)(function*(){let s=`${Date.now()}`,l={type:"file",info:i,temp_id:s,name:e.client.MyUserName};try{if(!e.client.FallbackOverrideAddress)throw"FFS \uc6b0\uc120\ucc98\ub9ac \uc9c0\uc815\ub418\uc9c0 \uc54a\uc74c";let n=yield e.global.try_upload_to_user_custom_fs(i,`square_${e.client.JoinedChannel||"public"}_${e.client.uuid}`,void 0,e.client.FallbackOverrideAddress);if(!n)throw"\ubd84\ud560 \uc804\uc1a1 \uc2dc\ub3c4 \ud544\uc694";i.url=n,e.client.FFS_Urls.push(n),delete i.blob,e.client.send(JSON.stringify(l)),e.focus_on_input()}catch{i.path=`tmp_files/sqaure/${s}.${i.file_ext}`,yield e.indexed.saveBlobToUserPath(i.blob,i.path);let h=yield e.indexed.GetFileInfoFromDB(i.path);i.partsize=Math.ceil(i.size/v.xM),delete i.blob,e.client.send(JSON.stringify(l)),e.focus_on_input();for(let c=0;c<i.partsize;c++){yield new Promise(u=>setTimeout(u,40));let p=e.global.req_file_part_base64(h,c,i.path);e.client.send(JSON.stringify({type:"part",path:i.path,index:c,part:p,temp_id:s}))}yield new Promise(c=>setTimeout(c,40)),e.client.send(JSON.stringify({type:"EOF",path:i.path,partsize:i.partsize,temp_id:s}))}})()}open_file_viewer(i){var e=this;let s=[];for(let l=0,n=this.client.userInput.logs.length;l<n;l++)try{this.client.userInput.logs[l].file.info.filename&&s.push({content:this.client.userInput.logs[l].file.info})}catch{}this.modalCtrl.create({component:T.c,componentProps:{info:{content:i},path:i.path,relevance:s,noTextEdit:!0},cssClass:"fullscreen"}).then(l=>{this.global.StoreShortCutAct("minimal-ionic-viewer"),l.onDidDismiss().then(n=>{if(n.data&&"image"===n.data.type){let h=[];if(n.data.msg.content.content_related_creator&&(h=[...n.data.msg.content.content_related_creator]),n.data.msg.content.content_creator){let r=!1;for(let c=0,p=h.length;c<p;c++)if(h[c].user_id==n.data.msg.content.content_creator.user_id){r=!0;break}r||h.push(n.data.msg.content.content_creator)}this.modalCtrl.create({component:N.c,componentProps:{path:n.data.path||i.path,width:n.data.width,height:n.data.height,isDarkMode:n.data.isDarkMode,scrollHeight:n.data.scrollHeight},cssClass:"fullscreen"}).then(r=>{r.onWillDismiss().then(function(){var c=(0,b.A)(function*(p){if(p.data){p.data.loadingCtrl.dismiss();let g=p.data.img;e.indexed.saveBase64ToUserPath(g,`tmp_files/sqaure/${p.data.name}`);let f=e.global.Base64ToBlob(g,"image/png");f.name=p.data.name,e.SendAttachAct({target:{files:[f]}})}});return function(p){return c.apply(this,arguments)}}()),r.present()})}else this.global.RestoreShortCutAct("minimal-ionic-viewer")}),l.present()})}ionViewDidEnter(){this.AddShortCut(),setTimeout(()=>{this.scroll_down()},0)}scroll_down(){this.minimal_chat_log.scrollTo({top:this.minimal_chat_log.scrollHeight,behavior:"smooth"})}focus_on_input(i){this.minimalchat_input.setFocus(),this.auto_scroll_down(i)}auto_scroll_down(i){setTimeout(()=>{let e=this.minimal_chat_log.scrollHeight;e<this.minimal_chat_log.scrollTop+this.minimal_chat_log.clientHeight+120&&this.minimal_chat_log.scrollTo({top:e,behavior:"smooth"})},i||0)}send(i){this.statusBar.settings.dedicated_groupchat="certified",setTimeout(()=>{"certified"==this.statusBar.settings.dedicated_groupchat&&(this.statusBar.settings.dedicated_groupchat="online")},250);let e={msg:i||this.client.userInput.text};e.msg.trim()&&(e.name=this.client.MyUserName,this.client.send(JSON.stringify(e)),this.client.userInput.text="",this.focus_on_input())}quit_chat(){this.client.funcs.onclose=()=>{this.statusBar.settings.dedicated_groupchat="missing",setTimeout(()=>{this.statusBar.settings.dedicated_groupchat="offline"},1500);let i={color:v.ud?"ffa":"884",text:this.lang.text.MinimalChat.leave_chat_group,isSystem:!0};this.client.userInput.logs.push(i),this.client.userInput.last_message=i,this.minimal_chat_log.scrollTo({top:this.minimal_chat_log.scrollHeight,behavior:"smooth"})},this.UserInputCustomAddress="",this.noti.ClearNoti(this.lnId),"idle"==this.client.status&&this.navCtrl.pop(),this.indexed.GetFileListFromDB("tmp_files/sqaure",i=>i.forEach(e=>this.indexed.removeFileFromUserPath(e)));for(let i=0,e=this.client.FFS_Urls.length;i<e;i++)this.global.remove_files_from_storage_with_key(this.client.FFS_Urls[i],`square_${this.client.JoinedChannel||"public"}_${this.client.uuid}`);this.client.disconnect(),this.client.FFS_Urls.length=0,this.client.DownloadPartManager={}}ionViewWillLeave(){this.title.setTitle("GodotChat"),document.getElementById("favicon").setAttribute("href","assets/icon/favicon.png"),this.noti.Current=void 0,this.client.IsConnected&&this.client.CreateRejoinButton(),delete this.global.p5key.KeyShortCut.EnterAct,delete this.global.p5key.KeyShortCut.Escape}ngOnDestroy(){this.route.queryParams.unsubscribe(),window.onfocus=void 0,this.minimal_chat_log.onscroll=null,this.DomMinimalChatInput.onpaste=null,this.p5canvas&&this.p5canvas.remove()}}return(o=d).\u0275fac=function(i){return new(i||o)(t.rXU(B.z),t.rXU(E.r),t.rXU(O.hE),t.rXU(m.W3),t.rXU(X.q9),t.rXU(I.nX),t.rXU(I.Ix),t.rXU(J.j),t.rXU(V.y),t.rXU(v.z3),t.rXU(H.G),t.rXU(Y.n),t.rXU(m.Xi),t.rXU(m.hG))},o.\u0275cmp=t.VBU({type:o,selectors:[["app-minimal-chat"]],viewQuery:function(i,e){if(1&i&&(t.GBs(Q,5),t.GBs(z,5),t.GBs(L,5)),2&i){let s;t.mGM(s=t.lsd())&&(e.MinimalChatServer=s.first),t.mGM(s=t.lsd())&&(e.SQNewAttach=s.first),t.mGM(s=t.lsd())&&(e.minimalchat_input=s.first)}},decls:46,vars:19,consts:[["minimalchat_input",""],["SQNewAttach",""],["MinimalChatServer",""],[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],["slot","end",2,"margin","8px 16px"],["scrollY","false"],["id","p5Drop_chatroom",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],[2,"display","flex","flex-direction","column","height","100%"],[2,"flex","0 1 auto"],["button","","id","fallback_fs_input",3,"disabled",4,"ngIf"],["button","",3,"disabled"],[1,"ion-text-right",3,"ngModelChange","label","placeholder","ngModel"],["style","flex: 0 1 auto;",4,"ngIf"],["id","minimal_chat_div",1,"main",2,"flex","1 1 auto"],[4,"ngIf"],[4,"ngFor","ngForOf"],["id","input_table",2,"width","100%"],["expand","block","fill","clear",3,"click"],["name","exit"],[2,"width","100%"],["id","minimalchat_input","type","text",3,"ionFocus","keyup.enter","ngModelChange","placeholder","ngModel"],["name","document-attach-outline"],["hidden","","type","file","id","minimal_chat_file","accept","*",3,"change"],["interface","action-sheet",2,"display","none",3,"ionChange","ionDismiss","label","cancelText"],["value","camera"],["value","image"],["value","text"],["value","load"],["name","send"],["button","","id","fallback_fs_input",3,"disabled"],["name","cloud-done-outline",1,"icon_margin"],["placeholder","(https://)0.0.0.0(:0)",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["slot","end","name","open-outline",3,"click"],["placeholder","public",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["button","",3,"click"],[1,"ion-text-center"],["value","local",2,"pointer-events","none",3,"ionChange","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["placeholder","(wss://)0.0.0.0",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["alt","Loading",2,"width","100%","height","auto","cursor","copy",3,"click","src"],["disabled","","color","medium",1,"ion-text-center"],[3,"color",4,"ngIf"],["class","default_text",4,"ngIf"],[3,"color"],[1,"default_text"],["target","_system","onclick","return false;",3,"href","click",4,"ngIf"],["target","_system","onclick","return false;",3,"click","href"],[1,"file_attach_box",3,"click"]],template:function(i,e){if(1&i){const s=t.RV6();t.j41(0,"ion-header",3)(1,"ion-toolbar")(2,"ion-buttons",4),t.bIt("click",function(){return t.eBV(s),t.Njj(e.navCtrl.pop())}),t.nrm(3,"ion-back-button",5),t.k0s(),t.j41(4,"ion-title"),t.EFF(5),t.k0s(),t.j41(6,"div",6),t.EFF(7),t.k0s()()(),t.j41(8,"ion-content",7),t.nrm(9,"div",8),t.j41(10,"div",9)(11,"div",10),t.DNE(12,W,4,3,"ion-item",11),t.j41(13,"ion-item",12)(14,"ion-input",13),t.mxI("ngModelChange",function(n){return t.eBV(s),t.DH7(e.client.MyUserName,n)||(e.client.MyUserName=n),t.Njj(n)}),t.k0s()()(),t.DNE(15,tt,8,5,"div",14),t.j41(16,"div",15),t.DNE(17,et,5,2,"div",16),t.j41(18,"div"),t.DNE(19,dt,3,2,"p",17),t.k0s()()()(),t.j41(20,"ion-footer")(21,"table",18)(22,"tr")(23,"td")(24,"ion-button",19),t.bIt("click",function(){return t.eBV(s),t.Njj(e.quit_chat())}),t.nrm(25,"ion-icon",20),t.k0s()(),t.j41(26,"td",21)(27,"ion-input",22,0),t.bIt("ionFocus",function(){return t.eBV(s),t.Njj(e.focus_on_input(120))})("keyup.enter",function(){return t.eBV(s),t.Njj(e.send())}),t.mxI("ngModelChange",function(n){return t.eBV(s),t.DH7(e.client.userInput.text,n)||(e.client.userInput.text=n),t.Njj(n)}),t.k0s()(),t.j41(29,"td")(30,"ion-button",19),t.bIt("click",function(){return t.eBV(s),t.Njj(e.open_select_new())}),t.nrm(31,"ion-icon",23),t.k0s(),t.j41(32,"input",24),t.bIt("change",function(n){return t.eBV(s),t.Njj(e.SendAttachAct(n))}),t.k0s()(),t.j41(33,"ion-select",25,1),t.bIt("ionChange",function(n){return t.eBV(s),t.Njj(e.new_attach(n))})("ionDismiss",function(){return t.eBV(s),t.Njj(e.AddShortCut())}),t.j41(35,"ion-select-option",26),t.EFF(36),t.k0s(),t.j41(37,"ion-select-option",27),t.EFF(38),t.k0s(),t.j41(39,"ion-select-option",28),t.EFF(40),t.k0s(),t.j41(41,"ion-select-option",29),t.EFF(42),t.k0s()(),t.j41(43,"td")(44,"ion-button",19),t.bIt("click",function(){return t.eBV(s),t.Njj(e.send())}),t.nrm(45,"ion-icon",30),t.k0s()()()()()}2&i&&(t.R7$(5),t.JRh(e.header_title),t.R7$(2),t.Lme("",e.lang.text.MinimalChat.concurrent_users,": ",e.client.ConnectedNow,""),t.R7$(5),t.Y8G("ngIf",!e.isMobileApp),t.R7$(),t.Y8G("disabled","idle"!=e.client.status),t.R7$(),t.Y8G("label",e.lang.text.Profile.name_placeholder)("placeholder",e.lang.text.Profile.noname_user),t.R50("ngModel",e.client.MyUserName),t.R7$(),t.Y8G("ngIf","idle"==e.client.status),t.R7$(2),t.Y8G("ngIf",e.QRCodeSRC&&"idle"!=e.client.status),t.R7$(2),t.Y8G("ngForOf",e.client.userInput.logs),t.R7$(8),t.Y8G("placeholder",e.lang.text.MinimalChat.input_placeholder),t.R50("ngModel",e.client.userInput.text),t.R7$(6),t.Y8G("label",e.lang.text.TodoDetail.new_attach)("cancelText",e.lang.text.GlobalAct.CancelText),t.R7$(3),t.JRh(e.lang.text.GlobalAct.FromCamera),t.R7$(2),t.JRh(e.lang.text.TodoDetail.new_draw),t.R7$(2),t.JRh(e.lang.text.TodoDetail.new_text),t.R7$(2),t.JRh(e.lang.text.TodoDetail.add_attach))},dependencies:[P.Sq,P.bT,k.BC,k.vS,m.Jm,m.QW,m.W9,m.M0,m.eU,m.iq,m.$w,m.uz,m.he,m.Nm,m.Ip,m.BC,m.ai,m.Je,m.Gw,m.el],styles:[".main[_ngcontent-%COMP%]{width:100%;padding:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}p[_ngcontent-%COMP%]{margin:8px 0 0}.default_text[_ngcontent-%COMP%]{color:var(--miniranchat-default-text)}.bottom_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;height:-moz-fit-content;height:fit-content;max-height:96px;transform:translateY(-100%);position:absolute;background:var(--chatroom-last-msg-viewer-bg);padding:8px;overflow:hidden}ion-button[_ngcontent-%COMP%]{--padding-start: 12px;--padding-end: 12px}.file_attach_box[_ngcontent-%COMP%]{margin-left:8px;padding:2px 8px;border-radius:6px;background-color:#8888;cursor:pointer}"]}),d})()}];let _t=(()=>{var o;class d{}return(o=d).\u0275fac=function(i){return new(i||o)},o.\u0275mod=t.$C({type:o}),o.\u0275inj=t.G2t({imports:[I.iI.forChild(ut),I.iI]}),d})(),mt=(()=>{var o;class d{}return(o=d).\u0275fac=function(i){return new(i||o)},o.\u0275mod=t.$C({type:o}),o.\u0275inj=t.G2t({imports:[P.MD,k.YN,m.bv,_t]}),d})()}}]);