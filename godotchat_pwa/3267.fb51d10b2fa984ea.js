"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3267],{3267:(A,G,f)=>{f.r(G),f.d(G,{GroupDetailPageModule:()=>E});var v=f(177),h=f(4341),g=f(5374),m=f(9858),d=f(467),b=f(9349),i=f(3953),y=f(4237),O=f(8065),R=f(755),$=f(4234),D=f(482),j=f(9900),P=f(1357),F=f(3656);function C(a,u){if(1&a){const n=i.RV6();i.j41(0,"img",21),i.bIt("click",function(){i.eBV(n);const t=i.XpG(2);return i.Njj(t.copy_startup_address())}),i.k0s()}if(2&a){const n=i.XpG(2);i.Y8G("src",n.QRCodeSRC,i.B4B)}}function I(a,u){if(1&a&&(i.j41(0,"div"),i.DNE(1,C,1,1,"img",20),i.k0s()),2&a){const n=i.XpG();i.R7$(),i.Y8G("ngIf",n.QRCodeSRC)}}function B(a,u){if(1&a&&(i.j41(0,"ion-item",22)(1,"ion-label",23),i.EFF(2),i.k0s()()),2&a){const n=i.XpG();i.R7$(2),i.JRh(n.lang.text.GroupDetail.NotAcceptYet)}}function w(a,u){if(1&a&&(i.j41(0,"ion-item",22)(1,"ion-label",23),i.EFF(2),i.k0s()()),2&a){const n=i.XpG();i.R7$(2),i.JRh(n.lang.text.GroupDetail.MissedGroup)}}function T(a,u){if(1&a&&(i.j41(0,"ion-item-divider")(1,"ion-label"),i.EFF(2),i.k0s()()),2&a){const n=i.XpG();i.R7$(2),i.SpI("",n.lang.text.GroupDetail.Members+" ("+n.info.users.length+"/"+n.info.max_count+")"," ")}}function S(a,u){if(1&a){const n=i.RV6();i.j41(0,"ion-item",7),i.bIt("click",function(){const t=i.eBV(n).$implicit,o=i.XpG();return i.Njj(o.open_user_profile(t))}),i.nrm(1,"div",8),i.j41(2,"div",9),i.nrm(3,"img",10),i.k0s(),i.j41(4,"ion-label",11),i.EFF(5),i.k0s()()}if(2&a){const n=u.$implicit,e=i.XpG();i.R7$(),i.Aen("background-color: "+e.statusBar.colors[n.user.online?"online":"offline"]),i.R7$(2),i.Aen("filter: "+(n.user.online?"grayscale(0) contrast(1);":"grayscale(.9) contrast(1.4);")),i.Y8G("src",n.user.img,i.B4B),i.R7$(2),i.JRh(n.user.display_name||e.lang.text.Profile.noname_user)}}function x(a,u){if(1&a){const n=i.RV6();i.j41(0,"ion-item",7),i.bIt("click",function(){i.eBV(n);const t=i.XpG();return i.Njj(t.remove_group())}),i.j41(1,"ion-label",24),i.EFF(2),i.k0s()()}if(2&a){const n=i.XpG();i.R7$(2),i.JRh(n.lang.text.GroupDetail.BreakupGroup)}}function U(a,u){if(1&a){const n=i.RV6();i.j41(0,"ion-item",7),i.bIt("click",function(){i.eBV(n);const t=i.XpG();return i.Njj(t.leave_group())}),i.j41(1,"ion-label",24),i.EFF(2),i.k0s()()}if(2&a){const n=i.XpG();i.R7$(2),i.JRh(n.lang.text.GroupDetail.LeaveGroup)}}const M=[{path:"",component:(()=>{var a;class u{constructor(e,t,o,s,r,l,c,p,_,k){this.nakama=e,this.statusBar=t,this.indexed=o,this.lang=s,this.global=r,this.p5toast=l,this.mClipboard=c,this.route=p,this.router=_,this.navCtrl=k,this.has_admin=!1,this.BackButtonPressed=!1,this.file_sel_id="",this.need_edit=!1,this.lock_modal_open=!1}ngOnDestroy(){this.route.queryParams.unsubscribe()}InitBrowserBackButtonOverride(){try{window.history.replaceState(null,null,window.location.href),window.onpopstate&&(window.onpopstate=null),window.onpopstate=()=>{this.BackButtonPressed||(window.onpopstate=null,this.BackButtonPressed=!0,this.navCtrl.pop())}}catch(e){console.log("\ud0d0\uc0c9 \uae30\ub85d \ubcc0\uacbd\uc2dc \uc624\ub958 \ubc1c\uc0dd: ",e)}}ngOnInit(){var e=this;return(0,d.A)(function*(){e.route.queryParams.subscribe(t=>{try{const o=e.router.getCurrentNavigation().extras.state;e.InitBrowserBackButtonOverride(),e.info=o.info,e.file_sel_id=`group_detail_${e.info.id}_${(new Date).getTime()}}`,e.info_orig=JSON.parse(JSON.stringify(o.info)),e.nakama.socket_reactive.group_detail=e,e.QRCodeSRC=e.global.readasQRCodeFromString(`${b.d2}godotchat_pwa/?group=${e.info.name},${e.info.id}`),e.info.server||(e.info.server=o.server),e.isOfficial=e.info.server.isOfficial,e.target=e.info.server.target;try{e.has_admin=e.info.creator_id==e.nakama.servers[e.isOfficial][e.target].session.user_id}catch(s){console.log("check is admin failed: ",s),e.has_admin=!1}if(e.info.users&&e.info.users.length)for(let s=0,r=e.info.users.length;s<r;s++)e.info.users[s].is_me?(e.info.users[s].user=e.nakama.users.self,e.indexed.loadTextFromUserPath("servers/self/profile.img",(l,c)=>{l&&c&&(e.nakama.users.self.img=c.replace(/"|\\|=/g,""))})):e.info.users[s].user.id?e.info.users[s].user=e.nakama.load_other_user(e.info.users[s].user.id,e.isOfficial,e.target):e.info.users.splice(s,1);try{e.nakama.servers[e.isOfficial][e.target].client.readStorageObjects(e.nakama.servers[e.isOfficial][e.target].session,{object_ids:[{collection:"group_public",key:`group_${e.info.id}`,user_id:e.info.creator_id}]}).then(s=>{s.objects.length?(e.nakama.groups[e.isOfficial][e.target][e.info.id].img=s.objects[0].value.img.replace(/"|=|\\/g,""),e.indexed.saveTextFileToUserPath(s.objects[0].value.img,`servers/${e.isOfficial}/${e.target}/groups/${e.info.id}.img`)):e.info.status&&(delete e.nakama.groups[e.isOfficial][e.target][e.info.id].img,e.indexed.removeFileFromUserPath(`servers/${e.isOfficial}/${e.target}/groups/${e.info.id}.img`))})}catch(s){console.log(s)}}catch(o){console.log("\uadf8\ub8f9 \uc0c1\uc138 \ud398\uc774\uc9c0 \uc9c4\uc785 \uc624\ub958: ",o)}})})()}ionViewDidEnter(){this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()}}update_from_notification(e){switch(e.code){case-4:case-5:this.update_GroupUsersList(e.server.isOfficial,e.server.target);break;default:console.warn("\uc608\uc0c1\ud558\uc9c0 \ubabb\ud55c \uadf8\ub8f9 \ud589\ub3d9: ",e)}}update_GroupUsersList(e,t){this.nakama.servers[e][t].client.listGroupUsers(this.nakama.servers[e][t].session,this.info.id).then(o=>{let s=[];for(let r=0,l=o.group_users.length;r<l;r++)if(o.group_users[r].user.id==this.nakama.servers[e][t].session.user_id)s.push({state:o.group_users[r].state,user:this.nakama.users.self});else{let c=this.nakama.load_other_user(o.group_users[r].user.id,e,t);this.nakama.save_other_user(o.group_users[r].user,e,t),s.push({state:o.group_users[r].state,user:c})}this.info.users=s})}buttonClickInputFile(){var e=this;return(0,d.A)(function*(){if(e.has_admin)if(e.info.img)e.info.img=void 0,e.nakama.servers[e.info.server.isOfficial][e.info.server.target].client.deleteStorageObjects(e.nakama.servers[e.info.server.isOfficial][e.info.server.target].session,{object_ids:[{collection:"group_public",key:`group_${e.info.id}`}]}).then(t=>{e.indexed.removeFileFromUserPath(`servers/${e.info.server.isOfficial}/${e.info.server.target}/groups/${e.info.id}.img`)});else try{let t=yield e.global.GetValueFromClipboard();switch(t.type){case"text/plain":yield e.check_if_clipboard_available(t.value);break;case"image/png":return void e.inputImageSelected({target:{files:[t.value]}})}}catch{try{let o=yield e.mClipboard.paste();yield e.check_if_clipboard_available(o)}catch{document.getElementById(e.file_sel_id).click()}}})()}inputImageSelected(e){var t=this;return(0,d.A)(function*(){let o=yield t.global.GetBase64ThroughFileReader(e.target.files[0]);t.nakama.limit_image_size(o,r=>{t.info.img=r.canvas.toDataURL(),t.announce_update_group_image(t.info.img)}),document.getElementById(t.file_sel_id).value=""})()}announce_update_group_image(e){this.nakama.servers[this.info.server.isOfficial][this.info.server.target].client.writeStorageObjects(this.nakama.servers[this.info.server.isOfficial][this.info.server.target].session,[{collection:"group_public",key:`group_${this.info.id}`,value:{img:e},permission_read:2,permission_write:1}]).then(t=>{this.indexed.saveTextFileToUserPath(JSON.stringify(e),`servers/${this.info.server.isOfficial}/${this.info.server.target}/groups/${this.info.id}.img`)})}check_if_clipboard_available(e){var t=this;return(0,d.A)(function*(){try{if(0!=e.indexOf("http"))throw"URL \uc8fc\uc18c\uac00 \uc544\ub2d8";yield new Promise((o,s)=>{let r=document.createElement("img");r.src=e,r.onload=()=>{t.info.img=e,t.announce_update_group_image(e),r.onload=null,r.onerror=null,r.remove(),o(void 0)},r.onerror=()=>{r.onload=null,r.onerror=null,r.remove(),s()}})}catch{try{if(0!=e.indexOf("data:image"))throw"DataURL \uc8fc\uc18c\uac00 \uc544\ub2d8";t.nakama.limit_image_size(e,s=>{t.info.img=s.canvas.toDataURL(),t.announce_update_group_image(t.info.img)})}catch{throw"\uc0ac\uc6a9\ubd88\uac00 \uc774\ubbf8\uc9c0"}}})()}remove_group(){var e=this;return(0,d.A)(function*(){e.need_edit=!1;try{if(e.nakama.servers[e.info.server.isOfficial][e.info.server.target]){if(e.info.creator_id!=e.nakama.servers[e.info.server.isOfficial][e.info.server.target].session.user_id)throw e.lang.text.GroupDetail.YouAreNotCreator;"online"==e.info.status?e.nakama.servers[e.info.server.isOfficial][e.info.server.target].socket.writeChatMessage(e.info.channel_id,{gupdate:"remove"}).then(function(){var t=(0,d.A)(function*(o){let s=yield e.nakama.servers[e.info.server.isOfficial][e.info.server.target].client.getAccount(e.nakama.servers[e.info.server.isOfficial][e.info.server.target].session),r=JSON.parse(s.user.metadata);for(let l=0,c=r.is_manager.length;l<c;l++)if(r.is_manager[l]==e.info.id){r.is_manager.splice(l,1);break}r.is_manager.length||delete r.is_manager;try{yield e.nakama.servers[e.info.server.isOfficial][e.info.server.target].client.rpc(e.nakama.servers[e.info.server.isOfficial][e.info.server.target].session,"update_user_metadata_fn",{user_id:e.nakama.servers[e.info.server.isOfficial][e.info.server.target].session.user_id,metadata:r})}catch(l){console.log("\uadf8\ub8f9 \uc0ad\uc81c\uc2dc \uc0dd\uc131\uc790\uc758 \ub9e4\ub2c8\uc800 \uad8c\ud55c \ubc15\ud0c8 \ub3d9\uae30\ud654 \uc624\ub958: ",l)}e.after_remove_group()});return function(o){return t.apply(this,arguments)}}()):e.after_remove_group()}else yield e.nakama.remove_group_list(e.info,e.info.server.isOfficial,e.info.server.target),e.navCtrl.pop()}catch(t){console.log("remove_group: ",t),e.p5toast.show({text:t})}})()}after_remove_group(){var e=this;return(0,d.A)(function*(){e.leave_channel(),yield e.nakama.remove_group_list(e.info,e.info.server.isOfficial,e.info.server.target),e.navCtrl.pop()})()}edit_group(){"online"==this.statusBar.groupServer[this.info.server.isOfficial][this.info.server.target]&&"missing"!=this.info.status&&this.has_admin&&this.nakama.servers[this.info.server.isOfficial][this.info.server.target].client.updateGroup(this.nakama.servers[this.info.server.isOfficial][this.info.server.target].session,this.info.id,{name:this.info.name,lang_tag:this.info.lang_tag,description:this.info.description,open:this.info.open}),this.nakama.groups[this.info.server.isOfficial][this.info.server.target][this.info.id]=this.info,this.nakama.save_groups_with_less_info()}open_user_profile(e){this.lock_modal_open||(this.lock_modal_open=!0,e.is_me?(this.nakama.open_profile_page({isOfficial:this.info.server.isOfficial,target:this.info.server.target}),this.lock_modal_open=!1):(this.nakama.open_others_profile({info:e,group:this.info,has_admin:this.has_admin}),this.lock_modal_open=!1))}leave_group(){this.need_edit=!1,"online"==this.info.status?this.after_leave_group(()=>{this.leave_channel(),this.nakama.groups[this.info.server.isOfficial][this.info.server.target][this.info.id].status="missing",this.nakama.save_groups_with_less_info(()=>this.navCtrl.pop())}):"pending"==this.info.status&&this.after_leave_group(()=>{this.nakama.groups[this.info.server.isOfficial][this.info.server.target][this.info.id].status="missing",this.nakama.save_groups_with_less_info(()=>this.navCtrl.pop())})}after_leave_group(e=(()=>console.warn("after_leave_group_announce Func Null"))){var t=this;this.nakama.servers[this.info.server.isOfficial][this.info.server.target].client.leaveGroup(this.nakama.servers[this.info.server.isOfficial][this.info.server.target].session,this.info.id).then(function(){var o=(0,d.A)(function*(s){s&&e(),t.nakama.remove_channel_files(t.info.server.isOfficial,t.info.server.target,t.info.channel_id);let r=t.nakama.servers[t.info.server.isOfficial][t.info.server.target].info;try{let l=localStorage.getItem("fallback_fs");if(!l)throw"\uc0ac\uc6a9\uc790 \uc9c0\uc815 \uc11c\ubc84 \uc5c6\uc74c";let c=l.split("://"),p=c.pop().split(":"),_=c.pop();_?_+=":":_=t.global.checkProtocolFromAddress(p[0])?"https:":"http:";let k=`${_}//${p[0]}:${p[1]||9002}/`;yield t.global.remove_files_from_storage_with_key(k,`${t.info.id}_${t.nakama.servers[r.isOfficial][r.target].session.user_id}`)}catch{}try{let l=`${r.useSSL?"https":"http"}://${r.address}`;yield t.global.remove_files_from_storage_with_key(l,`${t.info.id}_${t.nakama.servers[r.isOfficial][r.target].session.user_id}`)}catch{}});return function(s){return o.apply(this,arguments)}}())}leave_channel(){this.nakama.channels_orig[this.info.server.isOfficial][this.info.server.target]&&this.nakama.channels_orig[this.info.server.isOfficial][this.info.server.target][this.info.channel_id]&&"missing"!=this.nakama.channels_orig[this.info.server.isOfficial][this.info.server.target][this.info.channel_id].status&&(this.nakama.channels_orig[this.info.server.isOfficial][this.info.server.target][this.info.channel_id].status="missing")}copy_id(){this.mClipboard.copy(this.info.id).catch(e=>{this.global.WriteValueToClipboard("text/plain",this.info.id)})}copy_startup_address(){let e=encodeURI(`https://is2you2.github.io/godotchat_pwa/?group=${this.info.name},${this.info.id}`);this.mClipboard.copy(e).catch(t=>{this.global.WriteValueToClipboard("text/plain",e)})}ionViewWillLeave(){delete this.nakama.socket_reactive.group_detail,this.need_edit=this.info.description!=this.info_orig.description,this.need_edit&&this.edit_group(),delete this.global.p5key.KeyShortCut.Escape}}return(a=u).\u0275fac=function(e){return new(e||a)(i.rXU(y.X),i.rXU(O.j),i.rXU(R.n),i.rXU($.y),i.rXU(D.z3),i.rXU(j.G),i.rXU(P.B),i.rXU(m.nX),i.rXU(m.Ix),i.rXU(F.q9))},a.\u0275cmp=i.VBU({type:a,selectors:[["app-group-detail"]],decls:39,vars:24,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref",""],[4,"ngIf"],["color","warning",4,"ngIf"],[2,"cursor","copy",3,"click"],["text-wrap","","color","medium",1,"ion-text-center"],["button","",3,"click"],[1,"additional_form","status_bar_single"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"],[1,"form_margin"],[1,"server_target"],[1,"form_margin","content"],["hidden","","type","file","accept","image/*",3,"change","id"],[1,"infobox",3,"ngModelChange","disabled","ngModel","placeholder"],[2,"pointer-events","none"],[2,"pointer-events","none",3,"ngModelChange","ngModel"],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click",4,"ngIf"],["style","width: 100%; height: auto; cursor: copy;","alt","Loading",3,"src","click",4,"ngIf"],["alt","Loading",2,"width","100%","height","auto","cursor","copy",3,"click","src"],["color","warning"],[1,"ion-text-center"],["color","danger",1,"ion-text-center"]],template:function(e,t){1&e&&(i.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),i.EFF(3),i.k0s(),i.j41(4,"ion-buttons",1),i.nrm(5,"ion-back-button",2),i.k0s()()(),i.j41(6,"ion-content"),i.DNE(7,I,2,1,"div",3)(8,B,3,1,"ion-item",4)(9,w,3,1,"ion-item",4),i.j41(10,"ion-item",5),i.bIt("click",function(){return t.copy_id()}),i.j41(11,"ion-label",6),i.EFF(12),i.k0s()(),i.j41(13,"ion-item",7),i.bIt("click",function(){return t.buttonClickInputFile()}),i.nrm(14,"div",8),i.j41(15,"div",9),i.nrm(16,"img",10),i.k0s(),i.j41(17,"ion-label",11)(18,"div")(19,"table")(20,"tr")(21,"td"),i.EFF(22),i.k0s(),i.j41(23,"td",12),i.EFF(24),i.k0s()()()(),i.j41(25,"div",13),i.EFF(26),i.k0s()()(),i.j41(27,"input",14),i.bIt("change",function(s){return t.inputImageSelected(s)}),i.k0s(),i.j41(28,"ion-item-divider")(29,"ion-label"),i.EFF(30),i.k0s()(),i.j41(31,"textarea",15),i.mxI("ngModelChange",function(s){return i.DH7(t.info.description,s)||(t.info.description=s),s}),i.k0s(),i.j41(32,"ion-item",16)(33,"ion-toggle",17),i.mxI("ngModelChange",function(s){return i.DH7(t.info.open,s)||(t.info.open=s),s}),i.EFF(34),i.k0s()(),i.DNE(35,T,3,1,"ion-item-divider",3)(36,S,6,6,"ion-item",18)(37,x,3,1,"ion-item",19)(38,U,3,1,"ion-item",19),i.k0s()),2&e&&(i.R7$(3),i.JRh(t.lang.text.GroupDetail.Title),i.R7$(4),i.Y8G("ngIf","missing"!=t.info.status),i.R7$(),i.Y8G("ngIf","pending"==t.info.status),i.R7$(),i.Y8G("ngIf","missing"==t.info.status),i.R7$(3),i.JRh(t.info.id),i.R7$(2),i.Aen("background-color: "+t.statusBar.colors[t.info.status||"offline"]),i.R7$(2),i.Aen("filter: "+("online"==t.info.status?"grayscale(0) contrast(1);":"grayscale(.9) contrast(1.4);")),i.Y8G("src",t.info.img,i.B4B),i.R7$(6),i.SpI(" ",t.info.name||t.info.title||t.info.display_name," "),i.R7$(2),i.SpI(" ","("+(t.info.server.name||t.info.server.target)+")"," "),i.R7$(2),i.SpI(" ",t.lang.text.AddGroup.ClicktoChangeGroupImg," "),i.R7$(),i.Y8G("id",t.file_sel_id),i.R7$(3),i.JRh(t.lang.text.AddGroup.GroupDetail_placeholder),i.R7$(),i.Y8G("disabled",!t.has_admin),i.R50("ngModel",t.info.description),i.Y8G("placeholder",t.lang.text.GroupDetail.NoDetailGroup),i.R7$(2),i.R50("ngModel",t.info.open),i.R7$(),i.JRh(t.lang.text.GroupDetail.IsOpen),i.R7$(),i.Y8G("ngIf",t.info.users&&t.info.users.length),i.R7$(),i.Y8G("ngForOf",t.info.users),i.R7$(),i.Y8G("ngIf",("online"==t.info.status||"pending"==t.info.status)&&t.has_admin),i.R7$(),i.Y8G("ngIf",("online"==t.info.status||"pending"==t.info.status)&&!t.has_admin))},dependencies:[v.Sq,v.bT,h.me,h.BC,h.vS,g.QW,g.W9,g.eU,g.uz,g.Dg,g.he,g.BC,g.BY,g.ai,g.hB,g.el],styles:[".content[_ngcontent-%COMP%]{color:#888;height:24px;display:table-cell;vertical-align:middle}"]}),u})()}];let X=(()=>{var a;class u{}return(a=u).\u0275fac=function(e){return new(e||a)},a.\u0275mod=i.$C({type:a}),a.\u0275inj=i.G2t({imports:[m.iI.forChild(M),m.iI]}),u})(),E=(()=>{var a;class u{}return(a=u).\u0275fac=function(e){return new(e||a)},a.\u0275mod=i.$C({type:a}),a.\u0275inj=i.G2t({imports:[v.MD,h.YN,g.bv,X]}),u})()}}]);