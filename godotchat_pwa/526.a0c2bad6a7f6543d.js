"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[526],{526:(Z,O,g)=>{g.r(O),g.d(O,{PostViewerPageModule:()=>J});var U=g(177),D=g(4341),P=g(5374),T=g(9858),k=g(467),F=g(8326),j=g(7892),L=g(9349),e=g(3953),S=g(3656),E=g(4234),A=g(755),B=g(4237),G=g(482),X=g(9900);function M(r,I){if(1&r){const f=e.RV6();e.j41(0,"ion-icon",9),e.bIt("click",function(){e.eBV(f);const o=e.XpG();return e.Njj(o.ChangeToAnother(-1))}),e.k0s()}}function N(r,I){if(1&r&&(e.j41(0,"ion-label",10),e.EFF(1),e.k0s()),2&r){const f=e.XpG();e.R7$(),e.JRh(f.CurrentIndex+" / "+f.nakama.posts.length)}}function H(r,I){if(1&r){const f=e.RV6();e.j41(0,"ion-icon",11),e.bIt("click",function(){e.eBV(f);const o=e.XpG();return e.Njj(o.ChangeToAnother(1))}),e.k0s()}}function z(r,I){if(1&r&&e.nrm(0,"img",12),2&r){const f=e.XpG();e.Y8G("src",f.PostInfo.mainImage.MainThumbnail,e.B4B)}}function W(r,I){if(1&r){const f=e.RV6();e.j41(0,"ion-footer")(1,"table",13)(2,"tr")(3,"td")(4,"ion-button",14),e.bIt("click",function(){e.eBV(f);const o=e.XpG();return e.Njj(o.EditPost())}),e.EFF(5),e.k0s()(),e.j41(6,"td")(7,"ion-button",15),e.bIt("click",function(){e.eBV(f);const o=e.XpG();return e.Njj(o.RemovePost())}),e.EFF(8),e.k0s()()()()()}if(2&r){const f=e.XpG();e.R7$(5),e.SpI(" ",f.lang.text.AddPost.EditTitle," "),e.R7$(3),e.SpI(" ",f.lang.text.PostViewer.RemovePost," ")}}const Y=[{path:"",component:(()=>{var r;class I{constructor(t,o,c,_,u,w,v,m,s,p){this.modalCtrl=t,this.navCtrl=o,this.lang=c,this.indexed=_,this.nakama=u,this.alertCtrl=w,this.global=v,this.p5toast=m,this.route=s,this.router=p,this.PostInfo={},this.isOwner=!1,this.HavePosts=!1,this.CurrentIndex=1,this.BackButtonPressed=!1,this.blenderViewers=[],this.FileURLs=[],this.PlayableElements=[],this.IsFocusOnHere=!0,this.blockShortcut=!1,this.ContentChanging=!1}ngOnInit(){this.route.queryParams.subscribe(t=>{try{const o=this.router.getCurrentNavigation().extras.state;this.PostInfo=o.data,this.CurrentIndex=o.index,this.initialize()}catch{}})}ionViewWillEnter(){this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.IsFocusOnHere=!0,window.history.pushState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(window.onpopstate=null,this.BackButtonPressed=!0,this.navCtrl.pop())}}ChangeContentWithKeyInput(){var t=this;if(this.p5canvas){this.p5canvas.keyPressed=function(){var u=(0,k.A)(function*(w){if(t.IsFocusOnHere&&!t.blockShortcut)switch(w.code){case"KeyA":case"ArrowLeft":t.ChangeToAnother(-1);break;case"KeyD":case"ArrowRight":t.ChangeToAnother(1)}});return function(w){return u.apply(this,arguments)}}();let o=this.p5canvas.createVector(),c={};this.p5canvas.touchStarted=u=>{if("changedTouches"in u){for(let v=0,m=u.changedTouches.length;v<m;v++)c[u.changedTouches[v].identifier]=this.p5canvas.createVector(u.changedTouches[v].clientX,u.changedTouches[v].clientY);1===Object.keys(c).length&&(o=c[u.changedTouches[0].identifier].copy())}};const _=100;this.p5canvas.touchEnded=u=>{if("changedTouches"in u){let w;for(let m=0,s=u.changedTouches.length;m<s;m++)w=this.p5canvas.createVector(u.changedTouches[m].clientX,u.changedTouches[m].clientY),delete c[u.changedTouches[m].identifier];0===Object.keys(c).length&&(w.sub(o),w.x>_?this.ChangeToAnother(-1):w.x<-_&&this.ChangeToAnother(1))}}}}initialize(){if(this.cont&&this.cont.abort(),this.cont=new AbortController,this.PostInfo.mainImage)try{let t=this.PostInfo.mainImage.url;t||(t=URL.createObjectURL(this.PostInfo.mainImage.blob),setTimeout(()=>{URL.revokeObjectURL(t)},100)),this.PostInfo.mainImage.MainThumbnail=t}catch{}this.create_content();try{this.isOwner="me"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id}catch{this.isOwner=!1}this.HavePosts=this.nakama.posts.length>1&&this.CurrentIndex>=0,this.ChangeContentWithKeyInput()}ChangeToAnother(t){if(this.ContentChanging)return;this.ContentChanging=!0;let o=this.CurrentIndex+t;o<=0||o>this.nakama.posts.length?this.ContentChanging=!1:(this.p5canvas&&this.p5canvas.remove(),this.CurrentIndex=o,this.PostInfo=this.nakama.posts[this.CurrentIndex-1],this.initialize())}create_content(){var t=this;let o=document.getElementById("PostContent");this.p5canvas=new F(c=>{c.setup=(0,k.A)(function*(){c.noCanvas();let _=c.createDiv(`${t.PostInfo.OutSource?'<ion-icon id="title_link" style="cursor: pointer;" slot="start" name="link-outline"></ion-icon> ':""}${t.PostInfo.title}`);t.PostInfo.OutSource&&(document.getElementById("title_link").onclick=(0,k.A)(function*(){let p=0==t.PostInfo.OutSource.indexOf("https:"),d="",x=t.PostInfo.OutSource,C=x.substring(0,x.indexOf(":8"));try{let V=`${C}:${p?8443:8080}${window.sub_path}`;const l=new AbortController,n=setTimeout(()=>{l.abort()},500);let i=yield fetch(V,{signal:l.signal});if(clearTimeout(n),!i.ok)throw"\uc8fc\uc18c \uc5c6\uc74c";d=`${C}:${p?8443:8080}${window.sub_path}?postViewer=${t.PostInfo.OutSource}`}catch{d=`${L.d2}godotchat_pwa/?postViewer=${t.PostInfo.OutSource}`}t.global.WriteValueToClipboard("text/plain",d)})),_.style("font-size","32px"),_.style("font-weight","bold"),_.parent(o);let u=c.createDiv();u.style("color","#888"),u.parent(o),c.createDiv(`${t.lang.text.PostViewer.CreateTime}: ${new Date(t.PostInfo.create_time).toLocaleString()}`).parent(u),t.PostInfo.create_time!=t.PostInfo.modify_time&&c.createDiv(`${t.lang.text.PostViewer.ModifyTime}: ${new Date(t.PostInfo.modify_time).toLocaleString()}`).parent(u);let v=c.createDiv();v.style("padding-bottom","8px"),v.parent(o);let m=c.createSpan(t.nakama.usernameOverride[t.PostInfo.server.isOfficial][t.PostInfo.server.target][t.PostInfo.creator_id]||t.PostInfo.creator_name);if(m.style("color",`#${t.PostInfo.UserColor}`),m.style("font-weight","bold"),m.style("font-size","17px"),m.style("cursor","pointer"),m.elt.onclick=()=>{if("me"==t.PostInfo.creator_id)t.nakama.open_profile_page();else try{let s=t.PostInfo.server.isOfficial,p=t.PostInfo.server.target,d=t.PostInfo.creator_id;d==t.nakama.servers[s][p].session.user_id?t.nakama.open_profile_page({isOfficial:s,target:p}):t.nakama.open_others_profile({info:{user:t.nakama.load_other_user(d,s,p)},group:{server:{isOfficial:s,target:p}}})}catch(s){t.p5toast.show({text:`${t.lang.text.PostViewer.CannotOpenProfile}: ${s}`})}},m.parent(v),t.PostInfo.server.local)for(let s=0,p=t.PostInfo.attachments.length;s<p;s++)try{let d=yield t.indexed.loadBlobFromUserPath(t.PostInfo.attachments[s].path,t.PostInfo.attachments[s].type);t.PostInfo.attachments[s].blob=d}catch{}else for(let s=0,p=t.PostInfo.attachments.length;s<p;s++)try{t.PostInfo.attachments[s].alt_path=`servers/${t.PostInfo.server.isOfficial}/${t.PostInfo.server.target}/posts/${t.PostInfo.creator_id}/${t.PostInfo.id}/[${s}]${t.PostInfo.attachments[s].filename}`;let d=yield t.nakama.sync_load_file(t.PostInfo.attachments[s],t.PostInfo.server.isOfficial,t.PostInfo.server.target,"server_post",t.PostInfo.creator_id,`${t.PostInfo.id}_attach_${s}`,!1);t.PostInfo.attachments[s].blob=d.value}catch{}if(t.PostInfo.content){let s=t.PostInfo.content.split("\n"),p=[];for(let d=0,x=s.length;d<x;d++){let C=!1,V=s[d].length-1,l=0;try{l=Number(s[d].substring(1,V)),C="["==s[d].charAt(0)&&"]"==s[d].charAt(V)&&!isNaN(l)}catch{}if(C)switch(t.PostInfo.attachments[l].viewer){case"image":{let n=t.PostInfo.attachments[l].url;if(!n)try{n=URL.createObjectURL(t.PostInfo.attachments[l].blob),setTimeout(()=>{URL.revokeObjectURL(n)},100)}catch(a){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",a)}let i=c.createImg(n,`${l}`);i.style("cursor","pointer"),i.elt.onclick=()=>{let a=[];for(let h=0,b=t.PostInfo.attachments.length;h<b;h++)a.push({content:t.PostInfo.attachments[h]});t.modalCtrl.create({component:j.c,componentProps:{info:{content:t.PostInfo.attachments[l]},path:t.PostInfo.attachments[l].path,relevance:a,noEdit:!0},cssClass:"fullscreen"}).then(h=>{h.onDidDismiss().then(b=>{t.blockShortcut=!1,b.data&&b.data.share&&t.navCtrl.pop()}),t.blockShortcut=!0,h.present()})},i.parent(o)}break;case"audio":{let n=t.PostInfo.attachments[l].url;if(!n)try{n=URL.createObjectURL(t.PostInfo.attachments[l].blob),t.FileURLs.push(n)}catch(a){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",a)}let i=c.createAudio([n]);i.showControls(),i.elt.onplay=()=>{for(let a=0,h=t.PlayableElements.length;a<h;a++)try{a!=l&&t.PlayableElements[a].pause()}catch{}},i.parent(o),t.PlayableElements[l]=i.elt}break;case"video":{let n=t.PostInfo.attachments[l].url;if(!n)try{n=URL.createObjectURL(t.PostInfo.attachments[l].blob),t.FileURLs.push(n)}catch(a){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",a)}let i=c.createVideo([n]);i.style("width","100%"),i.style("height","auto"),i.showControls(),i.parent(o),t.PlayableElements[l]=i.elt}break;case"godot":{let n=`PostViewer_godot_pck_${l}`,i=c.createDiv();i.id(n),i.style("width","100%"),i.style("height","432px"),i.parent(o),setTimeout((0,k.A)(function*(){let a=!1;if(t.indexed.godotDB)try{yield t.indexed.GetGodotIndexedDB(),yield t.indexed.saveBlobToUserPath(t.PostInfo.attachments[l].blob,`godot/app_userdata/Client/tmp_files/duplicate/${t.PostInfo.attachments[l].filename}`,void 0,t.indexed.godotDB),a=!0}catch(h){console.log("\ub0b4\ubd80 \ud30c\uc77c \uc5c6\uc74c: ",h)}if(yield t.global.CreateGodotIFrame(n,{path:`tmp_files/duplicate/${t.PostInfo.attachments[l].filename}`,url:t.PostInfo.attachments[l].url},"start_load_pck"),!a){try{let h=yield t.indexed.loadBlobFromUserPath(t.PostInfo.attachments[l].path,"",void 0,t.indexed.ionicDB);yield t.indexed.GetGodotIndexedDB(),yield t.indexed.saveBlobToUserPath(h,`godot/app_userdata/Client/tmp_files/duplicate/${t.PostInfo.attachments[l].filename}`,void 0,t.indexed.godotDB)}catch{}yield t.global.CreateGodotIFrame(n,{path:`tmp_files/duplicate/${t.PostInfo.attachments[l].filename}`,url:t.PostInfo.attachments[l].url},"start_load_pck")}t.PostInfo.attachments[l].url?t.global.godot_window.download_url():t.global.godot_window.start_load_pck()}),100)}break;case"blender":{let n=c.createDiv();n.style("position","relative"),n.style("width","100%"),n.style("height","432px"),n.elt.onwheel=()=>!1,n.elt.oncontextmenu=()=>!1,n.parent(o);let i=t.global.load_blender_file(n.elt,t.PostInfo.attachments[l],void 0,()=>{},()=>{});t.blenderViewers.push(i)}break;default:{let n=c.createDiv();n.style("width","160px"),n.style("height","112px"),n.style("overflow","hidden"),n.style("background-color","grey"),n.style("margin-top","4px"),n.style("border-radius","8px"),n.style("cursor","pointer"),n.parent(o);let i=c.createP(t.PostInfo.attachments[l].filename);i.style("margin","0px 4px"),i.style("text-align","start"),i.parent(n);let a=c.createDiv();a.style("background-color","white"),a.style("margin-top","2px"),a.style("position","relative"),a.style("width","100%"),a.style("height","2px"),a.parent(n);let h=c.createSpan(t.lang.text.PostViewer.OpenFromViewer);h.style("margin","2px 4px 0px 4px"),h.style("text-align","start"),h.style("display","grid"),h.parent(n),n.elt.onclick=()=>{let b=[];for(let y=0,R=t.PostInfo.attachments.length;y<R;y++)b.push({content:t.PostInfo.attachments[y]});t.modalCtrl.create({component:j.c,componentProps:{info:{content:t.PostInfo.attachments[l]},path:t.PostInfo.attachments[l].path,relevance:b,noEdit:!0},cssClass:"fullscreen"}).then(y=>{y.onDidDismiss().then(()=>{t.blockShortcut=!1}),t.blockShortcut=!0,y.present()})}}}else try{let n=JSON.parse(s[d]),a=c.createDiv(`[${n.i}] ${t.PostInfo.attachments[n.i].filename} (${n.t})`);a.style("background-color","#8888"),a.style("width","fit-content"),a.style("height","fit-content"),a.style("border-radius","16px"),a.style("padding","8px 16px"),a.style("cursor","pointer"),a.parent(o),p.push(()=>{let h=t.PlayableElements[n.i],b=n.t.split(":"),y=0,R=1;for(let $=b.length-1;$>=0;$--){let Q=Number(b.pop());y+=Q*R,R*=60}a.elt.onclick=()=>{try{h.currentTime=y,h.play()}catch{}}})}catch{let i=c.createDiv();i.parent(o);let a=s[d].split(" ");for(let h=0,b=a.length;h<b;h++)if(0==a[h].indexOf("http:")||0==a[h].indexOf("https:")){let y=c.createA(a[h],a[h]);y.attribute("target","_blank"),y.parent(i),c.createSpan("&nbsp").parent(i)}else c.createSpan(a[h]+"&nbsp").parent(i)}}for(let d=0,x=p.length;d<x;d++)p[d]()}t.ContentChanging=!1})})}EditPost(){this.nakama.EditPost(this.PostInfo),this.navCtrl.pop()}ionViewWillLeave(){delete this.global.p5key.KeyShortCut.Escape,this.IsFocusOnHere=!1}RemovePost(){var o,t=this;this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.ChatRoom.Delete,cssClass:"redfont",handler:(o=(0,k.A)(function*(){yield t.nakama.RemovePost(t.PostInfo),t.navCtrl.pop()}),function(){return o.apply(this,arguments)})}]}).then(o=>o.present())}ngOnDestroy(){this.route.queryParams.unsubscribe(),this.cont.abort();for(let t=0,o=this.FileURLs.length;t<o;t++)URL.revokeObjectURL(this.FileURLs[t]);for(let t=0,o=this.blenderViewers.length;t<o;t++)this.blenderViewers[t].remove();this.p5canvas&&this.p5canvas.remove()}}return(r=I).\u0275fac=function(t){return new(t||r)(e.rXU(P.W3),e.rXU(S.q9),e.rXU(E.y),e.rXU(A.n),e.rXU(B.X),e.rXU(P.hG),e.rXU(G.z3),e.rXU(X.G),e.rXU(T.nX),e.rXU(T.Ix))},r.\u0275cmp=e.VBU({type:r,selectors:[["app-post-viewer"]],decls:13,vars:6,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref","portal/community"],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["style","width: 100%; height: auto;","alt","MainImage",3,"src",4,"ngIf"],["id","PostContent",2,"padding","16px","height","100%"],[4,"ngIf"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],["alt","MainImage",2,"width","100%","height","auto",3,"src"],[2,"width","100%","background-color","black"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"]],template:function(t,o){1&t&&(e.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),e.EFF(3),e.k0s(),e.j41(4,"ion-buttons",1),e.nrm(5,"ion-back-button",2),e.k0s(),e.DNE(6,M,1,0,"ion-icon",3)(7,N,2,1,"ion-label",4)(8,H,1,0,"ion-icon",5),e.k0s()(),e.j41(9,"ion-content"),e.DNE(10,z,1,1,"img",6),e.nrm(11,"div",7),e.k0s(),e.DNE(12,W,9,2,"ion-footer",8)),2&t&&(e.R7$(3),e.JRh(o.lang.text.PostViewer.Title),e.R7$(3),e.Y8G("ngIf",o.HavePosts),e.R7$(),e.Y8G("ngIf",o.HavePosts),e.R7$(),e.Y8G("ngIf",o.HavePosts),e.R7$(2),e.Y8G("ngIf",o.PostInfo.mainImage&&o.PostInfo.mainImage.MainThumbnail),e.R7$(2),e.Y8G("ngIf",o.isOwner&&o.CurrentIndex>=0))},dependencies:[U.bT,P.Jm,P.QW,P.W9,P.M0,P.eU,P.iq,P.he,P.BC,P.ai,P.el],styles:[".relevance_change[_ngcontent-%COMP%]{width:25px;height:25px}"]}),I})()}];let K=(()=>{var r;class I{}return(r=I).\u0275fac=function(t){return new(t||r)},r.\u0275mod=e.$C({type:r}),r.\u0275inj=e.G2t({imports:[T.iI.forChild(Y),T.iI]}),I})(),J=(()=>{var r;class I{}return(r=I).\u0275fac=function(t){return new(t||r)},r.\u0275mod=e.$C({type:r}),r.\u0275inj=e.G2t({imports:[U.MD,D.YN,P.bv,K]}),I})()}}]);