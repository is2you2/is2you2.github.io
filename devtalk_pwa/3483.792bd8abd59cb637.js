"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3483],{3483:(y,v,l)=>{l.d(v,{k:()=>D});var _=l(467),h=l(8258),m=l(8326),e=l(3953),s=l(5374),I=l(9900),k=l(4237),G=l(8065),x=l(4234),C=l(3295),A=l(1076),E=l(755),f=l(177),g=l(4341);const b=["AddGroupPublic"];function R(o,u){if(1&o){const a=e.RV6();e.j41(0,"ion-item",21),e.bIt("click",function(){const i=e.eBV(a).index,n=e.XpG(2);return e.Njj(n.select_server(i))}),e.j41(1,"ion-label"),e.EFF(2),e.k0s()()}if(2&o){const a=u.$implicit;e.R7$(2),e.JRh(a.name)}}function P(o,u){if(1&o){const a=e.RV6();e.j41(0,"ion-accordion-group",14,0),e.bIt("click",function(){e.eBV(a);const i=e.XpG();return e.Njj(i.isExpanded=!0)}),e.j41(2,"ion-accordion",15)(3,"ion-item",16)(4,"ion-label"),e.EFF(5),e.k0s(),e.j41(6,"ion-label",17),e.EFF(7),e.k0s(),e.nrm(8,"ion-icon",18),e.k0s(),e.j41(9,"div",19),e.DNE(10,R,3,1,"ion-item",20),e.k0s()()()}if(2&o){const a=e.XpG();e.Y8G("disabled",a.isSaveClicked)("value",a.isExpanded),e.R7$(5),e.JRh(a.lang.text.AddGroup.SelectServer),e.R7$(2),e.JRh(a.servers[a.index].name),e.R7$(3),e.Y8G("ngForOf",a.servers)}}function M(o,u){if(1&o){const a=e.RV6();e.j41(0,"div")(1,"ion-item-divider")(2,"ion-label"),e.EFF(3),e.k0s()(),e.j41(4,"ion-item",7)(5,"ion-input",22),e.mxI("ngModelChange",function(i){e.eBV(a);const n=e.XpG();return e.DH7(n.userInput.id,i)||(n.userInput.id=i),e.Njj(i)}),e.k0s()()()}if(2&o){const a=e.XpG();e.R7$(3),e.JRh(a.lang.text.AddGroup.JoinGroupWithId),e.R7$(),e.Y8G("disabled",a.isSaveClicked),e.R7$(),e.Y8G("label",a.lang.text.AddGroup.InputGroupId),e.R50("ngModel",a.userInput.id)}}function O(o,u){if(1&o){const a=e.RV6();e.j41(0,"div")(1,"ion-item-divider")(2,"ion-label"),e.EFF(3),e.k0s()(),e.j41(4,"textarea",23),e.mxI("ngModelChange",function(i){e.eBV(a);const n=e.XpG();return e.DH7(n.userInput.description,i)||(n.userInput.description=i),e.Njj(i)}),e.k0s(),e.j41(5,"ion-item",24)(6,"ion-input",25),e.mxI("ngModelChange",function(i){e.eBV(a);const n=e.XpG();return e.DH7(n.userInput.max_count,i)||(n.userInput.max_count=i),e.Njj(i)}),e.k0s()(),e.j41(7,"ion-item",7,1)(9,"ion-toggle",26),e.mxI("ngModelChange",function(i){e.eBV(a);const n=e.XpG();return e.DH7(n.userInput.open,i)||(n.userInput.open=i),e.Njj(i)}),e.bIt("ionChange",function(){e.eBV(a);const i=e.XpG();return e.Njj(i.isPublicToggle())}),e.EFF(10),e.k0s()()()}if(2&o){const a=e.XpG();e.R7$(3),e.JRh(a.lang.text.AddGroup.GroupDetail),e.R7$(),e.Y8G("disabled",a.isSaveClicked||""!=a.userInput.id),e.R50("ngModel",a.userInput.description),e.Y8G("placeholder",a.lang.text.AddGroup.GroupDetail_placeholder),e.R7$(),e.Y8G("disabled",a.isSaveClicked||""!=a.userInput.id),e.R7$(),e.Y8G("label",a.lang.text.AddGroup.MemberMaxLimit),e.R50("ngModel",a.userInput.max_count),e.R7$(),e.Y8G("disabled",a.isSaveClicked||""!=a.userInput.id),e.R7$(2),e.R50("ngModel",a.userInput.open),e.R7$(),e.SpI(" ",a.lang.text.AddGroup.IsOpen,"")}}let D=(()=>{var o;class u{constructor(t,i,n,r,d,c,p,B){this.modalCtrl=t,this.p5toast=i,this.nakama=n,this.statusBar=r,this.lang=d,this.global=c,this.mClipboard=p,this.indexed=B,this.BackButtonPressed=!1,this.userInput={server:void 0,id:"",name:void 0,description:void 0,max_count:void 0,lang_tag:void 0,open:!0,creator_id:void 0,img:void 0},this.servers=[],this.index=0,this.isExpanded=!0,this.isSaveClicked=!1,this.file_sel_id=""}InitBrowserBackButtonOverride(){window.history.replaceState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.modalCtrl.dismiss())}}ngOnInit(){this.InitBrowserBackButtonOverride();let t=JSON.parse(localStorage.getItem("add-group"));t&&(this.userInput=t),this.LoadListServer(),this.servers.length>1&&(this.index=1),this.userInput.server=this.servers[this.index],this.file_sel_id=`add_group_${(new Date).getTime()}`,this.nakama.StatusBarChangedCallback=()=>{this.LoadListServer(),this.index=0},this.CheckIfCopiedChannelID()}CheckIfCopiedChannelID(){var t=this;return(0,_.A)(function*(){let i;try{i=yield h.A.read()}catch{try{i=yield t.mClipboard.paste()}catch{return}}/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(i)&&(t.userInput.id=i,t.JoinWithSpecificId())})()}LoadListServer(){this.servers=this.nakama.get_all_server_info(!0,!0),this.servers.unshift({name:this.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0})}ionViewWillEnter(){this.ChangeContentWithKeyInput()}ChangeContentWithKeyInput(){let i=document.getElementById("group_name").childNodes[1].childNodes[1].childNodes[1];setTimeout(()=>{i.focus()},200),this.p5canvas=new m(n=>{n.keyPressed=r=>{"Enter"===r.code&&"group_desc"!=document.activeElement.id&&this.save()}})}select_server(t){this.index=t,this.userInput.server=this.servers[t],this.servers[t].local&&(this.userInput.id=""),this.isExpanded=!1}check_if_clipboard_available(t){var i=this;return(0,_.A)(function*(){try{if(0!=t.indexOf("http"))throw"URL \uc8fc\uc18c\uac00 \uc544\ub2d8";yield new Promise((n,r)=>{let d=document.createElement("img");d.src=t,d.onload=()=>{i.userInput.img=t,n(void 0)},d.onerror=()=>{d.remove(),r()}})}catch{try{if(0!=t.indexOf("data:image"))throw"DataURL \uc8fc\uc18c\uac00 \uc544\ub2d8";i.nakama.limit_image_size(t,r=>i.userInput.img=r.canvas.toDataURL())}catch{throw"\uc0ac\uc6a9\ubd88\uac00 \uc774\ubbf8\uc9c0"}}})()}isPublicToggle(){this.userInput.open=this.GroupIsPublic.checked}save(){var t=this;return(0,_.A)(function*(){if(t.isSaveClicked)return;if(t.isSaveClicked=!0,t.servers[t.index].local)return void t.SaveLocalAct();if(t.userInput.id)return void(yield t.JoinWithSpecificId());if("online"!=t.statusBar.groupServer[t.servers[t.index].isOfficial][t.servers[t.index].target])return void t.p5toast.show({text:t.lang.text.AddGroup.cannot_use_selected_server});let i=t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].client,n=t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].session;t.userInput.owner=n.user_id,t.userInput.status="online",t.userInput.lang_tag=t.userInput.lang_tag||navigator.language.split("-")[0]||t.lang.lang,t.userInput.max_count=t.userInput.max_count||1;try{let r=yield i.createGroup(n,{name:t.userInput.name,lang_tag:t.userInput.lang_tag,description:t.userInput.description,max_count:t.userInput.max_count,open:t.userInput.open});t.userInput.id=r.id,t.userInput.creator_id=t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].session.user_id,t.nakama.save_group_info(t.userInput,t.servers[t.index].isOfficial,t.servers[t.index].target);try{yield t.nakama.join_chat_with_modulation(r.id,3,t.servers[t.index].isOfficial,t.servers[t.index].target),t.p5toast.show({text:t.lang.text.AddGroup.group_created})}catch(p){console.error(p)}let d=yield t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].client.getAccount(t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].session),c=JSON.parse(d.user.metadata);c.is_manager?c.is_manager.push(r.id):c.is_manager=[r.id];try{yield t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].client.rpc(t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].session,"update_user_metadata_fn",{user_id:t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target].session.user_id,metadata:c})}catch(p){console.log("\uadf8\ub8f9 \uc0dd\uc131\uc790\ub97c \ub9e4\ub2c8\uc800\ub85c \uc2b9\uaca9 \uc624\ub958: ",p)}setTimeout(()=>{t.modalCtrl.dismiss()},500)}catch(r){switch(console.error("\uadf8\ub8f9 \uc0dd\uc131 \uc2e4\ud328: ",r),r.status){case 400:setTimeout(()=>{t.p5toast.show({text:t.lang.text.AddGroup.NeedSetGroupName}),t.isSaveClicked=!1},500);break;case 409:setTimeout(()=>{t.p5toast.show({text:t.lang.text.AddGroup.AlreadyExist}),t.isSaveClicked=!1},500);break;default:setTimeout(()=>{t.p5toast.show({text:`${t.lang.text.AddGroup.UnexpectedErr}: ${r}`}),t.isSaveClicked=!1},500)}}})()}SaveLocalAct(){if(this.nakama.channels_orig.local||(this.nakama.channels_orig.local={}),this.nakama.channels_orig.local.target||(this.nakama.channels_orig.local.target={}),this.nakama.channels_orig.local.target[this.userInput.name])return this.p5toast.show({text:this.lang.text.AddGroup.AlreadyExist}),void(this.isSaveClicked=!1);let t=this.CreateRandomLocalId();this.nakama.channels_orig.local.target[t]={id:t,local:!0,title:this.userInput.name,redirect:{type:0},status:"online",HideAutoThumbnail:!1,info:{...this.userInput,status:"online"}},this.userInput.img&&this.indexed.saveTextFileToUserPath(this.userInput.img,`servers/local/target/groups/${t}.img`),this.nakama.rearrange_channels(),setTimeout(()=>{this.modalCtrl.dismiss()},500)}CreateRandomLocalId(){let t="";for(let n=0,r=16;n<r;n++){let d=Math.floor(62*Math.random());t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(d)}return this.nakama.channels_orig.local.target[t]?this.CreateRandomLocalId():t}JoinWithSpecificId(){var t=this;return(0,_.A)(function*(){let i=!1,n=t.nakama.servers[t.servers[t.index].isOfficial][t.servers[t.index].target];try{yield n.client.joinGroup(n.session,t.userInput.id),t.nakama.get_group_list_from_server(t.servers[t.index].isOfficial,t.servers[t.index].target),i=!0}catch{try{yield t.nakama.join_chat_with_modulation(t.userInput.id,2,t.servers[t.index].isOfficial,t.servers[t.index].target),i=!0}catch{t.p5toast.show({text:t.lang.text.AddGroup.check_group_id}),t.isSaveClicked=!1}}i&&(t.p5toast.show({text:t.lang.text.AddGroup.join_group_succ}),setTimeout(()=>{t.modalCtrl.dismiss()},500))})()}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),delete this.nakama.StatusBarChangedCallback}buttonClickLinkInputFile(){var t=this;return(0,_.A)(function*(){if(t.userInput.img)t.userInput.img=void 0;else try{let i=yield h.A.read();yield t.check_if_clipboard_available(i)}catch{try{let n=yield t.mClipboard.paste();yield t.check_if_clipboard_available(n)}catch{document.getElementById(t.file_sel_id).click()}}})()}inputImageSelected(t){var i=this;return(0,_.A)(function*(){let n=yield i.global.GetBase64ThroughFileReader(t.target.files[0]);i.nakama.limit_image_size(n,d=>i.userInput.img=d.canvas.toDataURL()),document.getElementById(i.file_sel_id).value=""})()}}return(o=u).\u0275fac=function(t){return new(t||o)(e.rXU(s.W3),e.rXU(I.G),e.rXU(k.X),e.rXU(G.j),e.rXU(x.y),e.rXU(C.z3),e.rXU(A.B),e.rXU(E.n))},o.\u0275cmp=e.VBU({type:o,selectors:[["app-add-group"]],viewQuery:function(t,i){if(1&t&&e.GBs(b,5),2&t){let n;e.mGM(n=e.lsd())&&(i.GroupIsPublic=n.first)}},decls:27,vars:16,consts:[["accordionGroup",""],["AddGroupPublic",""],[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],[4,"ngIf"],["button","",3,"disabled"],["id","group_name",1,"ion-text-right",3,"ngModelChange","label","ngModel","placeholder"],["button","",3,"click","disabled"],[1,"additional_form","bg_img_form"],[1,"profile_img",2,"filter","grayscale(0) contrast(1)",3,"src"],["hidden","","type","file","accept","image/*",3,"change","id"],[1,"ion-text-center"],["value","colors","expand","inset",3,"click","disabled","value"],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click"],["placeholder","00000000-0000-0000-0000-000000000000",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["id","group_desc",1,"infobox",3,"ngModelChange","disabled","ngModel","placeholder"],[3,"disabled"],["type","number","min","1","placeholder","1",1,"ion-text-right",3,"ngModelChange","label","ngModel"],[2,"pointer-events","none",3,"ngModelChange","ionChange","ngModel"]],template:function(t,i){1&t&&(e.j41(0,"ion-header",2)(1,"ion-toolbar")(2,"ion-title"),e.EFF(3),e.k0s(),e.j41(4,"ion-buttons",3),e.bIt("click",function(){return i.modalCtrl.dismiss()}),e.nrm(5,"ion-back-button",4),e.k0s()()(),e.j41(6,"ion-content"),e.DNE(7,P,11,5,"ion-accordion-group",5)(8,M,6,4,"div",6),e.j41(9,"ion-item-divider")(10,"ion-label"),e.EFF(11),e.k0s()(),e.j41(12,"ion-item",7)(13,"ion-input",8),e.mxI("ngModelChange",function(r){return e.DH7(i.userInput.name,r)||(i.userInput.name=r),r}),e.k0s()(),e.j41(14,"ion-item",9),e.bIt("click",function(){return i.buttonClickLinkInputFile()}),e.j41(15,"div",10),e.nrm(16,"img",11),e.k0s(),e.j41(17,"ion-label")(18,"p"),e.EFF(19),e.k0s(),e.j41(20,"h2"),e.EFF(21),e.k0s()()(),e.j41(22,"input",12),e.bIt("change",function(r){return i.inputImageSelected(r)}),e.k0s(),e.DNE(23,O,11,10,"div",6),e.j41(24,"ion-item",9),e.bIt("click",function(){return i.save()}),e.j41(25,"ion-label",13),e.EFF(26),e.k0s()()()),2&t&&(e.R7$(3),e.JRh(i.lang.text.AddGroup.Title),e.R7$(4),e.Y8G("ngIf",i.servers.length),e.R7$(),e.Y8G("ngIf",!i.userInput.server.local),e.R7$(3),e.JRh(i.lang.text.AddGroup.GroupInfo),e.R7$(),e.Y8G("disabled",i.isSaveClicked||""!=i.userInput.id),e.R7$(),e.Y8G("label",i.lang.text.AddGroup.DisplayName),e.R50("ngModel",i.userInput.name),e.Y8G("placeholder",i.lang.text.AddGroup.DisplayName_placeholder),e.R7$(),e.Y8G("disabled",i.isSaveClicked||""!=i.userInput.id),e.R7$(2),e.Y8G("src",i.userInput.img,e.B4B),e.R7$(3),e.SpI("",(i.userInput.name||i.lang.text.AddGroup.DisplayName_placeholder)+" ("+(i.userInput.server.name||i.userInput.server.target)+")"," "),e.R7$(2),e.JRh(i.lang.text.AddGroup.ClicktoChangeGroupImg),e.R7$(),e.Y8G("id",i.file_sel_id),e.R7$(),e.Y8G("ngIf",!i.userInput.server.local),e.R7$(),e.Y8G("disabled",i.isSaveClicked),e.R7$(2),e.JRh(i.lang.text.AddGroup.submit))},dependencies:[f.Sq,f.bT,g.me,g.BC,g.vS,s.xk,s.YH,s.QW,s.W9,s.eU,s.iq,s.$w,s.uz,s.Dg,s.he,s.BC,s.BY,s.ai,s.hB,s.su,s.Gw,s.el,s.T6]}),u})()}}]);