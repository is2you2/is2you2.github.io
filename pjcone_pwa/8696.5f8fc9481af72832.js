"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8696],{8696:(w,A,f)=>{f.d(A,{C:()=>J});var C=f(1528),I=f(9352),x=f(9596),p=f(7136),L=f(4712),M=f(5020),g=f(4496),N=f(5624),W=f(3824),B=f(4668),U=f(4500),$=f(7756);!function j(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&f.e(4616).then(f.t.bind(f,4616,23)).then(y=>{})}();let J=(()=>{var y;class k{constructor(t,a,e,n,i,c){this.modalCtrl=t,this.p5toast=a,this.indexed=e,this.lang=n,this.nakama=i,this.mClipboard=c,this.OnUse=!1,this.isCallable=!1,this.isConnected=!1,this.JoinInited=!1,this.ReceivedOfferPart="",this.ReceivedAnswerPart="",this.IceCandidates=[],this.nakama.WebRTCService=this}initialize(t,a,e,n){var i=this;return(0,C.c)(function*(){if("data"!=t&&"http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")){let s=i.nakama.get_all_online_server(),r="https://is2you2.github.io/pjcone_pwa/";r+=`?tmp_user=${i.nakama.users.self.email},${i.nakama.users.self.password},${i.nakama.users.self.display_name}`;for(let o=0,h=s.length;o<h;o++)r+=`&server=${s[o].info.name||""},${s[o].info.address||""},${s[o].info.useSSL||""},${s[o].info.port||""},${s[o].info.key||""}`;r+=`&open_prv_channel=${e.user_id},${e.isOfficial||"official"},${e.target||"DevTestServer"}`;try{let o=yield i.indexed.loadTextFromUserPath("servers/webrtc_server.json"),h=JSON.parse(o);for(let d=0,u=h.length;d<u;d++)r+=`&rtcserver=[${h[d].urls}],${h[d].username},${h[d].credential}`}catch{}try{yield i.mClipboard.copy(r)}catch{}throw window.open(r,"_system"),i.lang.text.WebRTCDevManager.SecurityError}if("data"!=t&&(yield L.G.requestAudioRecordingPermission()),i.OnUse)throw i.p5toast.show({text:i.lang.text.WebRTCDevManager.AlreadyCalling}),i.lang.text.WebRTCDevManager.AlreadyCalling;if(yield i.close_webrtc(n),i.TypeIn=t,i.nakama.socket_reactive.WEBRTC_CHECK_ONLINE=s=>{i.user_id==s.user_id&&i.close_webrtc()},i.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL=function(){var s=(0,C.c)(function*(r){let h=JSON.stringify(i.LocalOffer).match(/(.{1,64})/g);if(r){for(let d=0,u=h.length;d<u;d++)r.server.send_to(r.target,r.user,JSON.stringify({type:"socket_react",act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:h[d]})),yield new Promise(v=>setTimeout(v,40));r.server.send_to(r.target,r.user,JSON.stringify({type:"socket_react",act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:"EOL"}))}else{for(let d=0,u=h.length;d<u;d++)yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent(h[d]));yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent("EOL"))}});return function(r){return s.apply(this,arguments)}}(),i.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL=s=>{"EOL"==s?(i.createRemoteOfferFromAnswer(JSON.parse(i.ReceivedOfferPart)),i.ReceivedOfferPart="",i.InitReplyCallback&&i.InitReplyCallback()):i.ReceivedOfferPart+=s},i.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER=(s,r)=>{"EOL"==s?(i.ReceiveRemoteAnswer(JSON.parse(i.ReceivedAnswerPart),r),i.ReceivedAnswerPart=""):i.ReceivedAnswerPart+=s},i.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES=(s,r)=>{i.ReceiveIceCandidate(JSON.parse(s),r)},i.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED=s=>{"EOL"==s?(i.createRemoteOfferFromAnswer(JSON.parse(i.ReceivedOfferPart)),i.ReceivedOfferPart="",i.CreateAnswer()):i.ReceivedOfferPart+=s},i.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF=s=>{i.close_webrtc(!1)},e&&(i.isOfficial=e.isOfficial,i.target=e.target,i.user_id=e.user_id,i.channel_id=e.channel_id),"data"!=t){i.createP5_panel();try{var c,l;i.localMedia=document.createElement(t),i.localMedia.id="webrtc_video",i.localMedia.style.width="100%",i.localMedia.style.height="fit-content",i.localMedia.autoplay=!0,"video"==t&&(i.localMedia.playsInline=!0),i.localMedia.muted=!0,document.body.appendChild(i.localMedia),i.remoteMedia=document.createElement(t),i.remoteMedia.id="webrtc_video_remote",i.remoteMedia.style.width="100%",i.remoteMedia.style.height="fit-content",i.remoteMedia.autoplay=!0,"video"==t&&(i.remoteMedia.playsInline=!0),document.body.appendChild(i.remoteMedia);let r,o,s=yield i.getDeviceList(),h=Number(null!==(c=localStorage.getItem("VideoInputDev"))&&void 0!==c?c:NaN),d=Number(null!==(l=localStorage.getItem("AudioInputDev"))&&void 0!==l?l:NaN);for(let u=0,v=s.length,R=0,O=0;u<v&&(!r||!o);u++)!r&&"audioinput"==s[u].kind&&(Number.isNaN(d)?(r=s[u].deviceId,localStorage.setItem("AudioInputDev",`${O}`)):O==d&&(r=s[u].deviceId),O++),!o&&"videoinput"==s[u].kind&&(Number.isNaN(h)?(o=s[u].deviceId,localStorage.setItem("AudioInputDev",`${R}`)):R==h&&(o=s[u].deviceId),R++);a||(a={},"video"==t?(a.video=!0,o&&(a.video={deviceId:o})):a.video=!1,a.audio=!0,r&&(a.audio={deviceId:r})),i.localStream=yield navigator.mediaDevices.getUserMedia(a),i.localMedia.srcObject=i.localStream,i.isCallable=!0}catch(s){console.log("navigator.getUserMedia error: ",s),yield i.close_webrtc(),i.p5toast.show({text:`${i.lang.text.WebRTCDevManager.InitErr}: ${s}`})}}else i.isCallable=!0;yield i.createCall(),i.p5canvas&&(i.p5canvas.call_button.elt.disabled=!1)})()}createP5_panel(){var t=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5canvas.waiting_act),this.p5canvas.remove()),this.p5canvas=new I(a=>{let e,n,i,c,l,s,r,o,h,d,u=1;a.setup=()=>{let _,D=()=>{this.JoinInited?(_.stop(.1),clearTimeout(a.waiting_act)):(_&&_.stop(.1),_=new I.Oscillator(380,"sine"),_.start(),_.amp(1,.15),_.amp(0,.75),a.waiting_act=setTimeout(()=>{D()},1200))};a.waiting_act=setTimeout(()=>{D()},0),a.hangup=(E=!1)=>{!this.isConnected&&!E||(_.stop(.1),clearTimeout(a.waiting_act),_=new I.Oscillator(380,"sine"),_.start(),_.freq(250,.35),_.amp(1,.15),_.amp(0,.25),_.amp(1,.35),_.amp(0,.45))},a.noCanvas(),e=a.createDiv(),e.id("outterDiv"),e.style("position: absolute; left: 50%; top: 0px; z-index: 1"),e.style("transform: translateX(-50%)"),e.style("width: fit-content; height: fit-content"),e.style("padding: 8px 16px;"),e.style("display: flex; justify-content: center;"),c=a.createDiv(),c.parent(e),c.style("display: flex; justify-content: center;"),c.style("width: fit-content; height: fit-content"),c.style("border-radius: 32px"),c.style("background: #"+(M.Mp?"30564e88":"b9543788")),c.style("padding: 6px 12px"),n=a.createDiv(),n.parent(c),n.id("webrtc_content"),n.style("display: flex; justify-content: center;"),n.style("flex-direction","column"),n.style("width: fit-content; height: fit-content"),n.style("word-break: break-all"),n.style("background: #"+(M.Mp?"30564e88":"b9543788")),n.style("border-radius: 32px"),n.style("padding: 6px 12px"),n.style("color: "+(M.Mp?"white":"black")),O(),this.isOfficial&&this.target&&(this.user_id&&(i=a.createDiv(this.nakama.users[this.isOfficial][this.target][this.user_id].display_name)),i.parent(n),i.style("text-align","center"),i.style("align-self","center"),i.style("width","100%"),i.style("height","fit-content"),i.style("pointer-events","none")),l=a.createDiv(),l.parent(n),l.id("webrtc_content"),l.style("display: flex; justify-content: center;"),l.style("align-self","center"),l.style("width: fit-content; height: fit-content"),s=a.createButton('<ion-icon style="width: 32px; height: 32px;" name="call-outline"></ion-icon>'),s.parent(l),s.style("padding","0px"),s.style("margin","4px"),s.style("border-radius","16px"),s.style("width","40px"),s.style("height","40px"),s.mouseClicked(()=>{this.CreateAnswer()}),s.elt.disabled=!0,a.call_button=s,r=a.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),r.parent(l),r.style("padding","0px"),r.style("margin","4px"),r.style("border-radius","16px"),r.style("width","40px"),r.style("height","40px"),r.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let m=0,T=E.length;m<T;m++)E[m].enabled=!1;o.show(),r.hide()}),o=a.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),o.parent(l),o.style("background-color","grey"),o.style("padding","0px"),o.style("margin","4px"),o.style("border-radius","16px"),o.style("width","40px"),o.style("height","40px"),o.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let m=0,T=E.length;m<T;m++)E[m].enabled=!0;r.show(),o.hide()}),o.hide(),h=a.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),h.parent(l),h.style("padding","0px"),h.style("margin","4px"),h.style("border-radius","16px"),h.style("width","40px"),h.style("height","40px"),h.mouseClicked((0,C.c)(function*(){h.elt.disabled=!0;let E=yield t.getDeviceList();t.modalCtrl.create({component:x.I,componentProps:{list:E}}).then(m=>{m.onDidDismiss().then(function(){var T=(0,C.c)(function*(S){h.elt.disabled=!1;try{let b={};S.data.videoinput&&(b.video={deviceId:S.data.videoinput.deviceId}),S.data.audioinput&&(b.audio={deviceId:S.data.audioinput.deviceId}),t.PeerConnection.removeStream(t.localStream),t.localStream=yield navigator.mediaDevices.getUserMedia(b),t.localMedia.srcObject=t.localStream,t.localStream.getTracks().forEach(K=>t.PeerConnection.addTrack(K,t.localStream))}catch{}});return function(S){return T.apply(this,arguments)}}()),m.present()})})),d=a.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),d.parent(l),d.style("background-color","red"),d.style("padding","0px"),d.style("margin","4px"),d.style("border-radius","16px"),d.style("width","40px"),d.style("height","40px"),d.mouseClicked((0,C.c)(function*(){yield t.close_webrtc()}))};let R=!1;a.draw=()=>{u>0&&(u-=.03),O(),this.OnUse||this.p5canvas&&!R&&(this.p5canvas.hangup(),e.hide(),setTimeout(()=>{this.OnUse||this.p5canvas.remove()},1e3),R=!0)};let O=()=>{let _=a.lerpColor(a.color("#"+(M.Mp?"30564e88":"b9543788")),a.color("#ffd94ebb"),u).levels,D=4*u;c.style(`padding: ${D}px ${D}px`),n.style(`padding: ${a.lerp(6,2,u)}px ${a.lerp(12,8,u)}px`),c.style(`background: rgba(${_[0]}, ${_[1]}, ${_[2]}, ${_[3]/255})`)}})}getDeviceList(){return(0,C.c)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(){var t=this;return(0,C.c)(function*(){let a;t.isCallable=!1,t.isConnected=!0,t.startTime=window.performance.now();try{let e=yield t.indexed.loadTextFromUserPath("servers/webrtc_server.json");a={},a.iceServers=JSON.parse(e)}catch{}"data"!=t.TypeIn&&(!a||!a.iceServers||!a.iceServers.length)&&(t.p5toast.show({text:t.lang.text.WebRTCDevManager.NoRegServer}),a=void 0),t.PeerConnection=new RTCPeerConnection(a),t.PeerConnection.addEventListener("icecandidate",e=>t.handleConnection(e)),t.PeerConnection.addEventListener("connectionstatechange",function(){var e=(0,C.c)(function*(n){switch(n.target.connectionState){case"failed":case"disconnected":yield t.close_webrtc();break;case"connected":t.p5canvas&&clearTimeout(t.p5canvas.waiting_act);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",n.target.connectionState)}});return function(n){return e.apply(this,arguments)}}()),"data"!=t.TypeIn?(t.localStream.getTracks().forEach(e=>t.PeerConnection.addTrack(e,t.localStream)),t.PeerConnection.addEventListener("addstream",e=>{t.remoteMedia.srcObject=e.stream})):t.createDataChannel(),t.PeerConnection.addEventListener("datachannel",e=>{t.dataChannel=e.channel,t.createDataChannelListener()}),t.PeerConnection.addEventListener("negotiationneeded",function(){var e=(0,C.c)(function*(n){if(t.JoinInited){yield t.PeerConnection.createOffer({offerToReceiveVideo:1}).then(l=>t.createdOffer(l)).catch(l=>t.setSessionDescriptionError(l));let c=JSON.stringify(t.LocalOffer).match(/(.{1,64})/g);if(t.isOfficial&&t.target){for(let l=0,s=c.length;l<s;l++)yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,p.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent(c[l]));yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,p.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent("EOL"))}else console.log("\uc11c\ubc84\uc815\ubcf4 \uc5c6\uc74c: \ub204\uad6c \ud1b5\ud574\uc11c \ubcf4\ub0c4?")}});return function(n){return e.apply(this,arguments)}}())})()}createDataChannel(t){this.dataChannel=this.PeerConnection.createDataChannel(t),this.createDataChannelListener()}createDataChannelListener(){this.dataChannel.addEventListener("open",t=>{this.dataChannelOpenAct&&this.dataChannelOpenAct()}),this.dataChannel.addEventListener("close",t=>{this.dataChannelOnCloseAct&&this.dataChannelOnCloseAct(),this.dataChannelOpenAct=void 0,this.dataChannelOnMsgAct=void 0,this.dataChannelOnCloseAct=void 0}),this.dataChannel.addEventListener("message",t=>{this.dataChannelOnMsgAct&&this.dataChannelOnMsgAct(t.data)})}send(t){try{this.dataChannel.send(t)}catch(a){console.log("WebRTC \uba54\uc2dc\uc9c0 \ubc1c\uc1a1 \uc2e4\ud328: ",a)}}CreateOffer(){this.p5canvas&&this.p5canvas.call_button.hide(),this.PeerConnection.createOffer({offerToReceiveVideo:1}).then(t=>this.createdOffer(t)).catch(t=>this.setSessionDescriptionError(t))}handleConnection(t){let a=t.candidate;a&&this.IceCandidates.push(new RTCIceCandidate(a))}ReceiveIceCandidate(t,a){var e=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,C.c)(function*(){if(a)for(let n=0,i=e.IceCandidates.length;n<i;n++)a.send(JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(e.IceCandidates[n])})),yield new Promise(c=>setTimeout(c,40));else for(let n=0,i=e.IceCandidates.length;n<i;n++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,p.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(e.IceCandidates[n])));e.IceCandidates.length=0}),800),this.PeerConnection.addIceCandidate(t).then(()=>{console.log("Success to add new ice candidate")}).catch(n=>{console.error("failed to add ice candidate: ",n)})}createdOffer(t){this.LocalOffer=t,this.PeerConnection.setLocalDescription(t).then(()=>{this.setLocalDescriptionSuccess(this.PeerConnection)}).catch(a=>this.setSessionDescriptionError(a))}createRemoteOfferFromAnswer(t){this.PeerConnection.setRemoteDescription(t).then(()=>{this.setRemoteDescriptionSuccess(this.PeerConnection)}).catch(a=>this.setSessionDescriptionError(a))}CreateAnswer(t){this.PeerConnection.createAnswer().then(a=>this.createdAnswer(a,t)).catch(a=>this.setSessionDescriptionError(a))}setLocalDescriptionSuccess(t){this.setDescriptionSuccess(t,"setLocalDescription")}setRemoteDescriptionSuccess(t){this.setDescriptionSuccess(t,"setRemoteDescription")}createdAnswer(t,a){var e=this;return(0,C.c)(function*(){e.p5canvas&&e.p5canvas.call_button.hide(),e.LocalAnswer=t,e.PeerConnection.setLocalDescription(t).then(()=>{e.setLocalDescriptionSuccess(e.PeerConnection)}).catch(c=>e.setSessionDescriptionError(c));let i=JSON.stringify(t).match(/(.{1,64})/g);if(a){for(let c=0,l=i.length;c<l;c++)a.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",data_str:i[c]})),yield new Promise(s=>setTimeout(s,40));a.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",data_str:"EOL"}))}else{for(let c=0,l=i.length;c<l;c++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,p.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent(i[c]));yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,p.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent("EOL")),yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.nakama.self_match[e.isOfficial][e.target].match_id,p.i.WEBRTC_RECEIVED_CALL_SELF,encodeURIComponent(""))}e.JoinInited=!0})()}ReceiveRemoteAnswer(t,a){var e=this;return(0,C.c)(function*(){if(e.PeerConnection.setRemoteDescription(t).then(()=>{e.setRemoteDescriptionSuccess(e.PeerConnection)}).catch(n=>e.setSessionDescriptionError(n)),a)for(let n=0,i=e.IceCandidates.length;n<i;n++)a.server.send_to(a.target,a.user,JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(e.IceCandidates[n])})),yield new Promise(c=>setTimeout(c,40));else for(let n=0,i=e.IceCandidates.length;n<i;n++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,p.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(e.IceCandidates[n])));e.IceCandidates.length=0})()}setSessionDescriptionError(t){console.error(`Failed to create session description: ${t}.`)}setDescriptionSuccess(t,a){console.log(`Local ${a} complete.`)}HangUpCall(t){var a=this;return(0,C.c)(function*(){a.p5canvas&&a.p5canvas.hangup(),a.isCallable=!0,a.isConnected=!1,a.PeerConnection&&a.PeerConnection.close(),a.PeerConnection=void 0;try{t&&a.CurrentMatch.match_id!=a.nakama.self_match[a.isOfficial][a.target].match_id&&(yield a.nakama.servers[a.isOfficial][a.target].socket.sendMatchState(a.CurrentMatch.match_id,p.i.WEBRTC_HANGUP,""),yield a.nakama.servers[a.isOfficial][a.target].socket.leaveMatch(a.CurrentMatch.match_id))}catch{}})()}close_webrtc(t=!0,a=!1){var e=this;return(0,C.c)(function*(){a&&"data"!=e.TypeIn||(e.InitReplyCallback=void 0,yield e.HangUpCall(t),e.localMedia&&e.localMedia.remove(),e.remoteMedia&&e.remoteMedia.remove(),e.OnUse=!1,e.isCallable=!1,e.isConnected=!1,e.localStream&&(e.localStream.getVideoTracks().forEach(n=>n.stop()),e.localStream.getAudioTracks().forEach(n=>n.stop())),e.localMedia=void 0,e.localStream=void 0,e.remoteMedia=void 0,e.isOfficial=void 0,e.target=void 0,e.user_id=void 0,e.channel_id=void 0,e.dataChannel={},e.ReceivedOfferPart="",e.ReceivedAnswerPart="",e.JoinInited=!1,delete e.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER,delete e.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES,delete e.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED,delete e.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF,delete e.nakama.socket_reactive.WEBRTC_CHECK_ONLINE,e.IceCandidates.length=0)})()}}return(y=k).\u0275fac=function(t){return new(t||y)(g.CoB(N.qS),g.CoB(W.O),g.CoB(B.k),g.CoB(U.o),g.CoB(p.h),g.CoB($._))},y.\u0275prov=g.wxM({token:y,factory:y.\u0275fac,providedIn:"root"}),k})()},4712:(w,A,f)=>{f.d(A,{G:()=>I});const I=(0,f(6400).C_)("VoiceRecorder",{web:()=>f.e(5840).then(f.bind(f,5840)).then(P=>new P.VoiceRecorderWeb)})}}]);