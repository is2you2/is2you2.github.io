"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8696,4712],{8696:(b,A,c)=>{c.d(A,{C:()=>J});var p=c(1528),O=c(9352),k=c(9596),_=c(7136),L=c(4712),S=c(5020),g=c(4496),N=c(5624),W=c(3824),B=c(4668),U=c(4500),$=c(7756);!function j(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&c.e(4616).then(c.t.bind(c,4616,23)).then(y=>{})}();let J=(()=>{var y;class w{constructor(t,e,i,r,a,d){this.modalCtrl=t,this.p5toast=e,this.indexed=i,this.lang=r,this.nakama=a,this.mClipboard=d,this.OnUse=!1,this.isCallable=!1,this.isConnected=!1,this.JoinInited=!1,this.ReceivedOfferPart="",this.ReceivedAnswerPart="",this.IceCandidates=[],this.dataChannel={},this.dataChannelOpenAct={},this.dataChannelOnMsgAct={},this.dataChannelOnCloseAct={},this.nakama.WebRTCService=this}initialize(t,e,i,r){var a=this;return(0,p.c)(function*(){if("http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")){let n=a.nakama.get_all_online_server(),o="https://is2you2.github.io/pjcone_pwa/";o+=`?tmp_user=${a.nakama.users.self.email},${a.nakama.users.self.password},${a.nakama.users.self.display_name}`;for(let s=0,l=n.length;s<l;s++)o+=`&server=${n[s].info.name||""},${n[s].info.address||""},${n[s].info.useSSL||""},${n[s].info.port||""},${n[s].info.key||""}`;o+=`&open_prv_channel=${i.user_id},${i.isOfficial||"official"},${i.target||"DevTestServer"}`;try{let s=yield a.indexed.loadTextFromUserPath("servers/webrtc_server.json"),l=JSON.parse(s);for(let u=0,C=l.length;u<C;u++)o+=`&rtcserver=[${l[u].urls}],${l[u].username},${l[u].credential}`}catch{}try{yield a.mClipboard.copy(o)}catch{}throw window.open(o,"_system"),a.lang.text.WebRTCDevManager.SecurityError}if(yield L.G.requestAudioRecordingPermission(),a.OnUse)throw a.p5toast.show({text:a.lang.text.WebRTCDevManager.AlreadyCalling}),a.lang.text.WebRTCDevManager.AlreadyCalling;if(yield a.close_webrtc(r),a.TypeIn=t,a.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL=(0,p.c)(function*(){let o=JSON.stringify(a.LocalOffer).match(/(.{1,64})/g);for(let s=0,l=o.length;s<l;s++)yield a.nakama.servers[a.isOfficial][a.target].socket.sendMatchState(a.CurrentMatch.match_id,_.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent(o[s]));yield a.nakama.servers[a.isOfficial][a.target].socket.sendMatchState(a.CurrentMatch.match_id,_.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent("EOL"))}),a.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL=n=>{"EOL"==n?(a.createRemoteOfferFromAnswer(JSON.parse(a.ReceivedOfferPart)),a.ReceivedOfferPart=""):a.ReceivedOfferPart+=n},a.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER=n=>{"EOL"==n?(a.ReceiveRemoteAnswer(JSON.parse(a.ReceivedAnswerPart)),a.ReceivedAnswerPart=""):a.ReceivedAnswerPart+=n},a.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES=n=>{a.ReceiveIceCandidate(JSON.parse(n))},a.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED=n=>{"EOL"==n?(a.createRemoteOfferFromAnswer(JSON.parse(a.ReceivedOfferPart)),a.ReceivedOfferPart="",a.CreateAnswer()):a.ReceivedOfferPart+=n},a.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF=n=>{a.close_webrtc(!1)},i&&(a.isOfficial=i.isOfficial,a.target=i.target,a.user_id=i.user_id,a.channel_id=i.channel_id),"data"!=t){a.createP5_panel();try{var d,f;a.localMedia=document.createElement(t),a.localMedia.id="webrtc_video",a.localMedia.style.width="100%",a.localMedia.style.height="fit-content",a.localMedia.autoplay=!0,"video"==t&&(a.localMedia.playsInline=!0),a.localMedia.muted=!0,document.body.appendChild(a.localMedia),a.remoteMedia=document.createElement(t),a.remoteMedia.id="webrtc_video_remote",a.remoteMedia.style.width="100%",a.remoteMedia.style.height="fit-content",a.remoteMedia.autoplay=!0,"video"==t&&(a.remoteMedia.playsInline=!0),document.body.appendChild(a.remoteMedia);let o,s,n=yield a.getDeviceList(),l=Number(null!==(d=localStorage.getItem("VideoInputDev"))&&void 0!==d?d:NaN),u=Number(null!==(f=localStorage.getItem("AudioInputDev"))&&void 0!==f?f:NaN);for(let C=0,m=n.length,R=0,I=0;C<m&&(!o||!s);C++)!o&&"audioinput"==n[C].kind&&(Number.isNaN(u)?(o=n[C].deviceId,localStorage.setItem("AudioInputDev",`${I}`)):I==u&&(o=n[C].deviceId),I++),!s&&"videoinput"==n[C].kind&&(Number.isNaN(l)?(s=n[C].deviceId,localStorage.setItem("AudioInputDev",`${R}`)):R==l&&(s=n[C].deviceId),R++);e||(e={},"video"==t?(e.video=!0,s&&(e.video={deviceId:s})):e.video=!1,e.audio=!0,o&&(e.audio={deviceId:o})),a.localStream=yield navigator.mediaDevices.getUserMedia(e),a.localMedia.srcObject=a.localStream,a.isCallable=!0}catch(n){console.log("navigator.getUserMedia error: ",n),yield a.close_webrtc(),a.p5toast.show({text:`${a.lang.text.WebRTCDevManager.InitErr}: ${n}`})}}yield a.createCall(),a.p5canvas&&(a.p5canvas.call_button.elt.disabled=!1)})()}createP5_panel(){var t=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5canvas.waiting_act),this.p5canvas.remove()),this.p5canvas=new O(e=>{let i,r,a,d,f,n,o,s,l,u,C=1;e.setup=()=>{let h,D=()=>{this.JoinInited?(h.stop(.1),clearTimeout(e.waiting_act)):(h&&h.stop(.1),h=new O.Oscillator(380,"sine"),h.start(),h.amp(1,.15),h.amp(0,.75),e.waiting_act=setTimeout(()=>{D()},1200))};e.waiting_act=setTimeout(()=>{D()},0),e.hangup=(E=!1)=>{!this.isConnected&&!E||(h.stop(.1),clearTimeout(e.waiting_act),h=new O.Oscillator(380,"sine"),h.start(),h.freq(250,.35),h.amp(1,.15),h.amp(0,.25),h.amp(1,.35),h.amp(0,.45))},e.noCanvas(),i=e.createDiv(),i.id("outterDiv"),i.style("position: absolute; left: 50%; top: 0px; z-index: 1"),i.style("transform: translateX(-50%)"),i.style("width: fit-content; height: fit-content"),i.style("padding: 8px 16px;"),i.style("display: flex; justify-content: center;"),d=e.createDiv(),d.parent(i),d.style("display: flex; justify-content: center;"),d.style("width: fit-content; height: fit-content"),d.style("border-radius: 32px"),d.style("background: #"+(S.Mp?"30564e88":"b9543788")),d.style("padding: 6px 12px"),r=e.createDiv(),r.parent(d),r.id("webrtc_content"),r.style("display: flex; justify-content: center;"),r.style("flex-direction","column"),r.style("width: fit-content; height: fit-content"),r.style("word-break: break-all"),r.style("background: #"+(S.Mp?"30564e88":"b9543788")),r.style("border-radius: 32px"),r.style("padding: 6px 12px"),r.style("color: "+(S.Mp?"white":"black")),I(),this.isOfficial&&this.target&&(this.user_id&&(a=e.createDiv(this.nakama.users[this.isOfficial][this.target][this.user_id].display_name)),a.parent(r),a.style("text-align","center"),a.style("align-self","center"),a.style("width","100%"),a.style("height","fit-content"),a.style("pointer-events","none")),f=e.createDiv(),f.parent(r),f.id("webrtc_content"),f.style("display: flex; justify-content: center;"),f.style("align-self","center"),f.style("width: fit-content; height: fit-content"),n=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="call-outline"></ion-icon>'),n.parent(f),n.style("padding","0px"),n.style("margin","4px"),n.style("border-radius","16px"),n.style("width","40px"),n.style("height","40px"),n.mouseClicked(()=>{this.CreateAnswer()}),n.elt.disabled=!0,e.call_button=n,o=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),o.parent(f),o.style("padding","0px"),o.style("margin","4px"),o.style("border-radius","16px"),o.style("width","40px"),o.style("height","40px"),o.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let v=0,T=E.length;v<T;v++)E[v].enabled=!1;s.show(),o.hide()}),s=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),s.parent(f),s.style("background-color","grey"),s.style("padding","0px"),s.style("margin","4px"),s.style("border-radius","16px"),s.style("width","40px"),s.style("height","40px"),s.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let v=0,T=E.length;v<T;v++)E[v].enabled=!0;o.show(),s.hide()}),s.hide(),l=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),l.parent(f),l.style("padding","0px"),l.style("margin","4px"),l.style("border-radius","16px"),l.style("width","40px"),l.style("height","40px"),l.mouseClicked((0,p.c)(function*(){l.elt.disabled=!0;let E=yield t.getDeviceList();t.modalCtrl.create({component:k.I,componentProps:{list:E}}).then(v=>{v.onDidDismiss().then(function(){var T=(0,p.c)(function*(M){l.elt.disabled=!1;try{let x={};M.data.videoinput&&(x.video={deviceId:M.data.videoinput.deviceId}),M.data.audioinput&&(x.audio={deviceId:M.data.audioinput.deviceId}),t.PeerConnection.removeStream(t.localStream),t.localStream=yield navigator.mediaDevices.getUserMedia(x),t.localMedia.srcObject=t.localStream,t.localStream.getTracks().forEach(K=>t.PeerConnection.addTrack(K,t.localStream))}catch{}});return function(M){return T.apply(this,arguments)}}()),v.present()})})),u=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),u.parent(f),u.style("background-color","red"),u.style("padding","0px"),u.style("margin","4px"),u.style("border-radius","16px"),u.style("width","40px"),u.style("height","40px"),u.mouseClicked((0,p.c)(function*(){yield t.close_webrtc()}))};let R=!1;e.draw=()=>{C>0&&(C-=.03),I(),this.OnUse||this.p5canvas&&!R&&(this.p5canvas.hangup(),i.hide(),setTimeout(()=>{this.OnUse||this.p5canvas.remove()},1e3),R=!0)};let I=()=>{let h=e.lerpColor(e.color("#"+(S.Mp?"30564e88":"b9543788")),e.color("#ffd94ebb"),C).levels,D=4*C;d.style(`padding: ${D}px ${D}px`),r.style(`padding: ${e.lerp(6,2,C)}px ${e.lerp(12,8,C)}px`),d.style(`background: rgba(${h[0]}, ${h[1]}, ${h[2]}, ${h[3]/255})`)}})}getDeviceList(){return(0,p.c)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(){var t=this;return(0,p.c)(function*(){let e;t.isCallable=!1,t.isConnected=!0,t.startTime=window.performance.now();try{let i=yield t.indexed.loadTextFromUserPath("servers/webrtc_server.json");e={},e.iceServers=JSON.parse(i)}catch{}"data"!=t.TypeIn&&(!e||!e.iceServers||!e.iceServers.length)&&(t.p5toast.show({text:t.lang.text.WebRTCDevManager.NoRegServer}),e=void 0),t.PeerConnection=new RTCPeerConnection(e),t.PeerConnection.addEventListener("icecandidate",i=>t.handleConnection(i)),t.PeerConnection.addEventListener("connectionstatechange",function(){var i=(0,p.c)(function*(r){switch(r.target.connectionState){case"failed":case"disconnected":yield t.close_webrtc();break;case"connected":t.p5canvas&&clearTimeout(t.p5canvas.waiting_act);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",r.target.connectionState)}});return function(r){return i.apply(this,arguments)}}()),"data"!=t.TypeIn&&(t.localStream.getTracks().forEach(i=>t.PeerConnection.addTrack(i,t.localStream)),t.PeerConnection.addEventListener("addstream",i=>{t.remoteMedia.srcObject=i.stream})),t.PeerConnection.addEventListener("datachannel",i=>{t.dataChannel[i.channel.label]=i.channel,t.createDataChannelListener(i.channel.label)}),t.PeerConnection.addEventListener("negotiationneeded",function(){var i=(0,p.c)(function*(r){if(t.JoinInited&&(yield t.PeerConnection.createOffer({offerToReceiveVideo:1}).then(a=>t.createdOffer(a)).catch(a=>t.setSessionDescriptionError(a)),"data"!=t.TypeIn)){let d=JSON.stringify(t.LocalOffer).match(/(.{1,64})/g);for(let f=0,n=d.length;f<n;f++)yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,_.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent(d[f]));yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,_.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent("EOL"))}});return function(r){return i.apply(this,arguments)}}())})()}createDataChannel(t,e){this.dataChannel[t]=this.PeerConnection.createDataChannel(t,e),this.createDataChannelListener(t)}createDataChannelListener(t){this.dataChannel[t].addEventListener("open",e=>{this.dataChannelOpenAct[t]&&this.dataChannelOpenAct[t]()}),this.dataChannel[t].addEventListener("close",e=>{this.dataChannelOnCloseAct[t]&&this.dataChannelOnCloseAct[t]()}),this.dataChannel[t].addEventListener("message",e=>{this.dataChannelOnMsgAct[t]&&this.dataChannelOnMsgAct[t](e.data)})}send(t,e){try{this.dataChannel[t].send(e)}catch(i){console.log("WebRTC \uba54\uc2dc\uc9c0 \ubc1c\uc1a1 \uc2e4\ud328: ",i)}}CreateOfffer(){this.p5canvas&&this.p5canvas.call_button.hide(),this.PeerConnection.createOffer({offerToReceiveVideo:1}).then(t=>this.createdOffer(t)).catch(t=>this.setSessionDescriptionError(t))}handleConnection(t){let e=t.candidate;e&&this.IceCandidates.push(new RTCIceCandidate(e))}ReceiveIceCandidate(t){var e=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,p.c)(function*(){if("data"!=e.TypeIn)for(let i=0,r=e.IceCandidates.length;i<r;i++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,_.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(e.IceCandidates[i])));e.IceCandidates.length=0}),800),this.PeerConnection.addIceCandidate(t).then(()=>{console.log("Success to add new ice candidate")}).catch(i=>{console.error("failed to add ice candidate: ",i)})}createdOffer(t){this.LocalOffer=t,this.PeerConnection.setLocalDescription(t).then(()=>{this.setLocalDescriptionSuccess(this.PeerConnection)}).catch(e=>this.setSessionDescriptionError(e))}createRemoteOfferFromAnswer(t){this.PeerConnection.setRemoteDescription(t).then(()=>{this.setRemoteDescriptionSuccess(this.PeerConnection)}).catch(e=>this.setSessionDescriptionError(e))}CreateAnswer(){this.PeerConnection.createAnswer().then(t=>this.createdAnswer(t)).catch(t=>this.setSessionDescriptionError(t))}setLocalDescriptionSuccess(t){this.setDescriptionSuccess(t,"setLocalDescription")}setRemoteDescriptionSuccess(t){this.setDescriptionSuccess(t,"setRemoteDescription")}createdAnswer(t){var e=this;return(0,p.c)(function*(){if(e.p5canvas&&e.p5canvas.call_button.hide(),e.LocalAnswer=t,e.PeerConnection.setLocalDescription(t).then(()=>{e.setLocalDescriptionSuccess(e.PeerConnection)}).catch(i=>e.setSessionDescriptionError(i)),"data"!=e.TypeIn){let r=JSON.stringify(t).match(/(.{1,64})/g);for(let a=0,d=r.length;a<d;a++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,_.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent(r[a]));yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,_.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent("EOL"))}yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.nakama.self_match[e.isOfficial][e.target].match_id,_.i.WEBRTC_RECEIVED_CALL_SELF,encodeURIComponent("")),e.JoinInited=!0})()}ReceiveRemoteAnswer(t){var e=this;return(0,p.c)(function*(){if(e.PeerConnection.setRemoteDescription(t).then(()=>{e.setRemoteDescriptionSuccess(e.PeerConnection)}).catch(i=>e.setSessionDescriptionError(i)),"data"!=e.TypeIn){for(let i=0,r=e.IceCandidates.length;i<r;i++)yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,_.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(e.IceCandidates[i])));e.IceCandidates.length=0}})()}setSessionDescriptionError(t){console.error(`Failed to create session description: ${t}.`)}setDescriptionSuccess(t,e){console.log(`Local ${e} complete.`)}HangUpCall(t){var e=this;return(0,p.c)(function*(){e.p5canvas&&e.p5canvas.hangup(),e.isCallable=!0,e.isConnected=!1,e.PeerConnection&&e.PeerConnection.close(),e.PeerConnection=void 0;try{t&&(yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,_.i.WEBRTC_HANGUP,""),yield e.nakama.servers[e.isOfficial][e.target].socket.leaveMatch(e.CurrentMatch.match_id))}catch{}})()}close_webrtc(t=!0){var e=this;return(0,p.c)(function*(){yield e.HangUpCall(t),e.localMedia&&e.localMedia.remove(),e.remoteMedia&&e.remoteMedia.remove(),e.OnUse=!1,e.isCallable=!1,e.isConnected=!1,e.localStream&&(e.localStream.getVideoTracks().forEach(i=>i.stop()),e.localStream.getAudioTracks().forEach(i=>i.stop())),e.localMedia=void 0,e.localStream=void 0,e.remoteMedia=void 0,e.dataChannelOpenAct={},e.dataChannelOnCloseAct={},e.dataChannelOnMsgAct={},e.dataChannel={},e.ReceivedOfferPart="",e.ReceivedAnswerPart="",e.JoinInited=!1,delete e.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER,delete e.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES,delete e.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED,delete e.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF,e.IceCandidates.length=0})()}}return(y=w).\u0275fac=function(t){return new(t||y)(g.CoB(N.qS),g.CoB(W.O),g.CoB(B.k),g.CoB(U.o),g.CoB(_.h),g.CoB($._))},y.\u0275prov=g.wxM({token:y,factory:y.\u0275fac,providedIn:"root"}),w})()},4712:(b,A,c)=>{c.d(A,{G:()=>O});const O=(0,c(6400).C_)("VoiceRecorder",{web:()=>c.e(5840).then(c.bind(c,5840)).then(P=>new P.VoiceRecorderWeb)})}}]);