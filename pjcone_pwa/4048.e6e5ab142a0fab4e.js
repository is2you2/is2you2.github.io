"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4048],{4048:(j,D,s)=>{s.r(D),s.d(D,{CommunityPageModule:()=>E});var x=s(1368),M=s(4716),y=s(5624),T=s(3332),R=s(1528),n=s(340),v=s(416),t=s(4496),w=s(4180),S=s(7136),U=s(4500),L=s(5020),$=s(9240),A=s(4668);function K(a,f){if(1&a&&t.wR5(0,"img",17),2&a){const r=t.GaO().$implicit;t.m_g(r.isNSFW?"filter: blur(16px);":""),t.E7m("src",r.mainImage.thumbnail,t.K6U)}}function B(a,f){if(1&a&&(t.I0R(0,"span",18),t.OEk(1),t.C$Y()),2&a){const r=t.GaO().$implicit,e=t.GaO(2);t.yG2(),t.oRS(" ","("+(r.server?r.server.name||r.server.target:e.lang.text.AddGroup.UseLocalStorage)+")"," ")}}function P(a,f){if(1&a){const r=t.KQA();t.I0R(0,"ion-card",10),t.qCj("click",function(){const l=t.usT(r).$implicit,h=t.GaO(2);return t.CGJ(h.open_post(l))}),t.yuY(1,K,1,3,"img",11),t.I0R(2,"ion-card-header")(3,"ion-card-subtitle",12)(4,"span",13),t.qCj("click",function(){const l=t.usT(r).$implicit,h=t.GaO(2);return t.CGJ(h.open_profile(l))}),t.OEk(5),t.C$Y(),t.yuY(6,B,2,1,"span",14),t.C$Y(),t.I0R(7,"ion-card-title",15),t.OEk(8),t.C$Y()(),t.I0R(9,"ion-card-content",16),t.OEk(10),t.C$Y()()}if(2&a){const r=f.$implicit,e=t.GaO(2);t.E7m("id",r.id),t.yG2(),t.E7m("ngIf",r.mainImage),t.yG2(3),t.m_g("color: #"+r.UserColor),t.yG2(),t.oRS(" ",r.creator_name," "),t.yG2(),t.E7m("ngIf",e.nakama.showServer),t.yG2(2),t.cNF(r.title),t.yG2(2),t.oRS(" ",r.content," ")}}function k(a,f){if(1&a&&(t.I0R(0,"div",8),t.yuY(1,P,11,8,"ion-card",9),t.C$Y()),2&a){const r=t.GaO();t.yG2(),t.E7m("ngForOf",r.nakama.posts)}}function C(a,f){if(1&a){const r=t.KQA();t.I0R(0,"div")(1,"div",19),t.qCj("click",function(){t.usT(r);const i=t.GaO();return t.CGJ(i.add_post())}),t.wR5(2,"ion-icon",20),t.I0R(3,"div")(4,"ion-label",21),t.OEk(5),t.C$Y()()()()}if(2&a){const r=t.GaO();t.yG2(5),t.cNF(r.lang.text.Community.NoPosts)}}const m=[{path:"",component:(()=>{var a;class f{constructor(e,i,l,h,b,I,d){this.statusBar=e,this.nakama=i,this.lang=l,this.global=h,this.navCtrl=b,this.indexed=I,this.modalCtrl=d,this.is_loadable=!0,this.counter={local:{target:{me:0}},official:{},unofficial:{}},this.isOpenProfile=!1}ngOnInit(){var e=this;return(0,R.c)(function*(){e.nakama.is_post_lock=!0,e.nakama.posts.length||(yield e.load_posts_counter()),e.nakama.CommunityGoToEditPost=e.add_post})()}add_post(e){this.navCtrl.navigateForward("portal/community/add-post",{state:{data:e,act:!0}})}ionViewDidEnter(){this.try_add_shortcut(),this.ContentDiv&&this.ContentScroll&&this.ContentDiv.clientHeight-(this.ContentScroll.scrollTop+this.ContentScroll.clientHeight)<1&&this.load_post_cycles()}load_post_cycles(){var e=this;return(0,R.c)(function*(){e.is_loadable&&(yield e.load_posts()),setTimeout(()=>{e.ContentDiv||(e.ContentDiv=document.getElementById("CommunityMainContent")),e.ContentScroll||(e.ContentScroll=document.getElementById("CommunityScrollDiv"),e.ContentScroll.onscroll=i=>{e.ContentDiv.clientHeight-(e.ContentScroll.scrollTop+e.ContentScroll.clientHeight)<1&&e.load_post_cycles()}),e.is_loadable&&e.ContentDiv.clientHeight-(e.ContentScroll.scrollTop+e.ContentScroll.clientHeight)<1&&e.load_post_cycles()},50)})()}try_add_shortcut(){this.global.p5key&&this.global.p5key.KeyShortCut?this.AddShortcut():setTimeout(()=>{this.try_add_shortcut()},100)}load_posts_counter(){var e=this;return(0,R.c)(function*(){let i=Number(yield e.indexed.loadTextFromUserPath("servers/local/target/posts/counter.txt"))||0;e.counter.local.target.me=i;let l=e.nakama.get_all_server_info(!0,!0);for(let h=0,b=l.length;h<b;h++)e.counter[l[h].isOfficial][l[h].target]||(e.counter[l[h].isOfficial][l[h].target]={});e.load_post_cycles()})()}load_posts(){var e=this;return(0,R.c)(function*(){let i=!1,l=Object.keys(e.counter);for(let h=0,b=l.length;h<b;h++){let I=Object.keys(e.counter[l[h]]);for(let d=0,c=I.length;d<c;d++){let _=Object.keys(e.counter[l[h]][I[d]]);for(let g=0,p=_.length;g<p;g++){let O=e.counter[l[h]][I[d]][_[g]];!i&&O>0&&(i=!0),"local"==l[h]?yield e.load_local_post_step_by_step(O):(console.log(`\uc11c\ubc84 \uc5c5\ub370\uc774\ud2b8 \ud589\ub3d9 \uc5c6\uc74c: ${l[h]}/${I[d]}/${_[g]}`),e.load_server_user_post_step_by_step(O))}}}e.is_loadable=i,e.nakama.rearrange_posts()})()}load_local_post_step_by_step(e){var i=this;return(0,R.c)(function*(){if(e<0)return;let l=yield i.nakama.load_local_post_with_id(`LocalPost_${e}`);i.counter.local.target.me--,l||(yield i.load_local_post_step_by_step(i.counter.local.target.me))})()}load_server_user_post_step_by_step(e){}open_profile(e){this.isOpenProfile=!0,"local"==e.creator_id?this.modalCtrl.create({component:n.w}).then(i=>i.present()):console.log("\uc11c\ubc84 \uc791\uc131\uc790 \uac80\ud1a0: ",e),setTimeout(()=>{this.isOpenProfile=!1},0)}open_post(e){this.isOpenProfile||(this.isOpenProfile=!0,this.modalCtrl.create({component:v.S,componentProps:{data:e}}).then(i=>{delete this.global.p5key.KeyShortCut.Digit,delete this.global.p5key.KeyShortCut.AddAct,i.onDidDismiss().then(l=>{l.data||this.AddShortcut()}),i.present()}),setTimeout(()=>{this.isOpenProfile=!1},0))}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Digit=e=>{this.nakama.posts.length>e?this.open_post(this.nakama.posts[e]):this.add_post()}),this.global.p5key&&this.global.p5key.KeyShortCut&&!this.global.p5key.KeyShortCut.AddAct&&(this.global.p5key.KeyShortCut.AddAct=()=>{this.add_post()})}ionViewWillLeave(){delete this.global.p5key.KeyShortCut.Digit,delete this.global.p5key.KeyShortCut.AddAct,this.nakama.is_post_lock=!1}}return(a=f).\u0275fac=function(e){return new(e||a)(t.GI1(w.Y),t.GI1(S.h),t.GI1(U.o),t.GI1(L.A1),t.GI1($.wX),t.GI1(A.k),t.GI1(y.qS))},a.\u0275cmp=t.In1({type:a,selectors:[["app-community"]],decls:12,vars:5,consts:[[1,"ion-no-border"],[1,"add_post",3,"click"],["button","","name","add-circle-outline",2,"width","24px","height","24px"],[1,"header_online_circle",3,"click"],["id","CommunityScrollDiv",2,"height","100%","overflow-y","auto"],["id","CommunityMainContent"],["style","display: ruby-text",4,"ngIf"],[4,"ngIf"],[2,"display","ruby-text"],["button","","class","card_style",3,"id","click",4,"ngFor","ngForOf"],["button","",1,"card_style",3,"id","click"],["class","thumbnail_image","alt","",3,"src","style",4,"ngIf"],[1,"cardCreator"],[3,"click"],["class","server_target serverTargetOverride",4,"ngIf"],[1,"cardTitle"],[1,"cardContent"],["alt","",1,"thumbnail_image",3,"src"],[1,"server_target","serverTargetOverride"],[1,"disconnect_info",3,"click"],["color","medium","name","document-text-outline",2,"width","60px","height","60px"],["color","medium"]],template:function(e,i){1&e&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t.OEk(3),t.C$Y(),t.I0R(4,"div",1),t.qCj("click",function(){return i.add_post()}),t.wR5(5,"ion-icon",2),t.C$Y(),t.I0R(6,"div",3),t.qCj("click",function(){return i.nakama.toggle_all_session(!0)}),t.C$Y()()(),t.I0R(7,"ion-content")(8,"div",4)(9,"div",5),t.yuY(10,k,2,1,"div",6)(11,C,6,1,"div",7),t.C$Y()()()),2&e&&(t.yG2(3),t.cNF(i.lang.text.Community.Title),t.yG2(3),t.m_g("background-color: "+i.statusBar.colors[i.statusBar.settings.groupServer]+"; cursor: pointer;"),t.yG2(4),t.E7m("ngIf",i.nakama.posts.length),t.yG2(),t.E7m("ngIf",!i.nakama.posts.length))},dependencies:[x.ay,x.u_,y.KC,y.Gg,y.YY,y.MN,y.I7,y._i,y.wB,y.Ko,y.QR,y.tM,y.Md],styles:[".md[_ngcontent-%COMP%]   .add_post[_ngcontent-%COMP%]{position:absolute;right:68px;top:16px;cursor:pointer}.ios[_ngcontent-%COMP%]   .add_post[_ngcontent-%COMP%]{position:absolute;right:68px;top:10px;cursor:pointer}.card_style[_ngcontent-%COMP%]{width:400px}.cardCreator[_ngcontent-%COMP%]{width:-moz-fit-content;width:fit-content;font-weight:700;max-height:20px;overflow-y:hidden}.serverTargetOverride[_ngcontent-%COMP%]{font-weight:400}.cardTitle[_ngcontent-%COMP%]{max-height:24px;overflow-y:hidden}.cardContent[_ngcontent-%COMP%]{max-height:40px;overflow-y:hidden;padding-bottom:0;margin-bottom:13px}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover}"]}),f})()},{path:"add-post",loadChildren:()=>s.e(1592).then(s.bind(s,1592)).then(a=>a.AddPostPageModule)},{path:"post-viewer",loadChildren:()=>s.e(9368).then(s.bind(s,9368)).then(a=>a.PostViewerPageModule)}];let u=(()=>{var a;class f{}return(a=f).\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.a4G({type:a}),a.\u0275inj=t.s3X({imports:[T.qQ.forChild(m),T.qQ]}),f})(),E=(()=>{var a;class f{}return(a=f).\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.a4G({type:a}),a.\u0275inj=t.s3X({imports:[x.MD,M.y,y.wZ,u]}),f})()},416:(j,D,s)=>{s.d(D,{S:()=>B});var x=s(1528),M=s(9352),T=s(8744),R=s(340),n=s(4496),v=s(5624),t=s(9240),w=s(4500),S=s(4668),U=s(7136),L=s(5020),$=s(1368);function A(P,k){if(1&P&&n.wR5(0,"img",7),2&P){const C=n.GaO();n.E7m("src",C.PostInfo.mainImage.MainThumbnail,n.K6U)}}function K(P,k){if(1&P){const C=n.KQA();n.I0R(0,"ion-footer")(1,"table",8)(2,"tr")(3,"td")(4,"ion-button",9),n.qCj("click",function(){n.usT(C);const m=n.GaO();return n.CGJ(m.EditPost())}),n.OEk(5),n.C$Y()(),n.I0R(6,"td")(7,"ion-button",10),n.qCj("click",function(){n.usT(C);const m=n.GaO();return n.CGJ(m.RemovePost())}),n.OEk(8),n.C$Y()()()()()}if(2&P){const C=n.GaO();n.yG2(5),n.oRS(" ",C.lang.text.AddPost.EditTitle," "),n.yG2(3),n.oRS(" ",C.lang.text.PostViewer.RemovePost," ")}}let B=(()=>{var P;class k{constructor(o,m,u,E,a,f,r){this.modalCtrl=o,this.navParam=m,this.lang=u,this.indexed=E,this.nakama=a,this.alertCtrl=f,this.global=r,this.isOwner=!1}ngOnInit(){if(this.PostInfo=this.navParam.get("data"),this.PostInfo.mainImage){let o=URL.createObjectURL(this.PostInfo.mainImage.blob);this.PostInfo.mainImage.MainThumbnail=o,setTimeout(()=>{URL.revokeObjectURL(o)},100)}this.create_content(),this.isOwner="local"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id}create_content(){var o=this;let m=document.getElementById("PostContent");this.p5canvas=new M(u=>{u.setup=(0,x.c)(function*(){u.noCanvas();let E=u.createDiv(o.PostInfo.title);E.style("font-size","32px"),E.style("font-weight","bold"),E.parent(m);let a=u.createDiv();a.style("color","#888"),a.parent(m),u.createDiv(`${o.lang.text.PostViewer.CreateTime}: ${new Date(o.PostInfo.create_time).toLocaleString()}`).parent(a),o.PostInfo.create_time!=o.PostInfo.modify_time&&u.createDiv(`${o.lang.text.PostViewer.ModifyTime}: ${new Date(o.PostInfo.modify_time).toLocaleString()}`).parent(a);let r=u.createDiv();r.style("padding-bottom","8px"),r.parent(m);let e=u.createSpan(o.PostInfo.creator_name);e.style("color",`#${o.PostInfo.UserColor}`),e.style("font-weight","bold"),e.style("cursor","pointer"),e.elt.onclick=()=>{o.isOwner&&o.modalCtrl.create({component:R.w}).then(i=>i.present())},e.parent(r);for(let i=0,l=o.PostInfo.attachments.length;i<l;i++){let h=yield o.indexed.loadBlobFromUserPath(o.PostInfo.attachments[i].path,o.PostInfo.attachments[i].type);o.PostInfo.attachments[i].blob=h}if(o.PostInfo.content){let i=o.PostInfo.content.split("\n");for(let l=0,h=i.length;l<h;l++){let b=!1,I=i[l].length-1,d=0;try{d=Number(i[l].substring(1,I)),b="["==i[l].charAt(0)&&"]"==i[l].charAt(I)&&!isNaN(d)}catch{}if(b)switch(o.PostInfo.attachments[d].viewer){case"image":{let c=o.PostInfo.attachments[d].url;if(!c)try{c=URL.createObjectURL(o.PostInfo.attachments[d].blob),setTimeout(()=>{URL.revokeObjectURL(c)},100)}catch(g){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",g)}let _=u.createImg(c,`${d}`);_.style("cursor","pointer"),_.elt.onclick=()=>{let g=[];for(let p=0,O=o.PostInfo.attachments.length;p<O;p++)g.push({content:o.PostInfo.attachments[p]});o.modalCtrl.create({component:T.K,componentProps:{info:{content:o.PostInfo.attachments[d]},path:o.PostInfo.attachments[d].path,relevance:g,noEdit:!0},cssClass:"fullscreen"}).then(p=>p.present())},_.parent(m)}break;case"audio":{let c=o.PostInfo.attachments[d].url;if(!c)try{c=URL.createObjectURL(o.PostInfo.attachments[l].blob),setTimeout(()=>{URL.revokeObjectURL(c)},100)}catch(g){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",g)}let _=u.createAudio([c]);_.showControls(),_.parent(m)}break;case"video":{let c=o.PostInfo.attachments[d].url;if(!c)try{c=URL.createObjectURL(o.PostInfo.attachments[l].blob),setTimeout(()=>{URL.revokeObjectURL(c)},100)}catch(g){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",g)}let _=u.createVideo([c]);_.style("width","100%"),_.style("height","auto"),_.showControls(),_.parent(m)}break;case"godot":{let c=`PostViewer_godot_pck_${d}`,_=u.createDiv();_.id(c),_.style("width","100%"),_.style("height","432px"),_.parent(m),setTimeout((0,x.c)(function*(){let g=!1;if(o.indexed.godotDB)try{yield o.indexed.GetGodotIndexedDB(),yield o.indexed.saveBlobToUserPath(o.PostInfo.attachments[l].blob,`tmp_files/duplicate/${o.PostInfo.attachments[d].filename}`,void 0,o.indexed.godotDB),g=!0}catch(p){console.log("\ub0b4\ubd80 \ud30c\uc77c \uc5c6\uc74c: ",p)}if(yield o.global.CreateGodotIFrame(c,{path:`tmp_files/duplicate/${o.PostInfo.attachments[d].filename}`,url:o.PostInfo.attachments[d].url},"start_load_pck",!0),!g){try{let p=yield o.indexed.loadBlobFromUserPath(o.PostInfo.attachments[d].path,"",void 0,o.indexed.ionicDB);yield o.indexed.GetGodotIndexedDB(),yield o.indexed.saveBlobToUserPath(p,`tmp_files/duplicate/${o.PostInfo.attachments[d].filename}`,void 0,o.indexed.godotDB)}catch{}yield o.global.CreateGodotIFrame(c,{path:`tmp_files/duplicate/${o.PostInfo.attachments[d].filename}`,url:o.PostInfo.attachments[d].url},"start_load_pck",!0)}o.PostInfo.attachments[d].url?o.global.godot_window.download_url():o.global.godot_window.start_load_pck()}),100)}break;default:{let c=u.createDiv();c.style("width","160px"),c.style("height","112px"),c.style("overflow","hidden"),c.style("background-color","grey"),c.style("margin-top","4px"),c.style("border-radius","8px"),c.style("cursor","pointer"),c.parent(m);let _=u.createP(o.PostInfo.attachments[d].filename);_.style("margin","0px 4px"),_.style("text-align","start"),_.parent(c);let g=u.createDiv();g.style("background-color","white"),g.style("margin-top","2px"),g.style("position","relative"),g.style("width","100%"),g.style("height","2px"),g.parent(c);let p=u.createSpan(o.lang.text.PostViewer.OpenFromViewer);p.style("margin","2px 4px 0px 4px"),p.style("text-align","start"),p.style("display","grid"),p.parent(c),c.elt.onclick=()=>{let O=[];for(let G=0,F=o.PostInfo.attachments.length;G<F;G++)O.push({content:o.PostInfo.attachments[G]});o.modalCtrl.create({component:T.K,componentProps:{info:{content:o.PostInfo.attachments[d]},path:o.PostInfo.attachments[d].path,relevance:O,noEdit:!0},cssClass:"fullscreen"}).then(G=>G.present())}}}else u.createDiv(i[l]+"&nbsp").parent(m)}}})})}EditPost(){this.modalCtrl.dismiss({edit:!0}),this.nakama.EditPost(this.PostInfo)}RemovePost(){var m,o=this;this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.TodoDetail.remove,cssClass:"redfont",handler:(m=(0,x.c)(function*(){yield o.nakama.RemovePost(o.PostInfo),o.modalCtrl.dismiss()}),function(){return m.apply(this,arguments)})}]}).then(m=>m.present())}ionViewDidLeave(){this.p5canvas&&this.p5canvas.remove()}}return(P=k).\u0275fac=function(o){return new(o||P)(n.GI1(v.qS),n.GI1(t.a6),n.GI1(w.o),n.GI1(S.k),n.GI1(U.h),n.GI1(v.iW),n.GI1(L.A1))},P.\u0275cmp=n.In1({type:P,selectors:[["app-post-viewer"]],decls:10,vars:5,consts:[[3,"translucent"],["slot","start",3,"click"],["defaultHref",""],[3,"fullscreen"],["style","width: 100%; height: auto;","alt","MainImage",3,"src",4,"ngIf"],["id","PostContent",2,"padding","16px"],[4,"ngIf"],["alt","MainImage",2,"width","100%","height","auto",3,"src"],[2,"width","100%","background-color","black"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"]],template:function(o,m){1&o&&(n.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),n.OEk(3),n.C$Y(),n.I0R(4,"ion-buttons",1),n.qCj("click",function(){return m.modalCtrl.dismiss()}),n.wR5(5,"ion-back-button",2),n.C$Y()()(),n.I0R(6,"ion-content",3),n.yuY(7,A,1,1,"img",4),n.wR5(8,"div",5),n.C$Y(),n.yuY(9,K,9,2,"ion-footer",6)),2&o&&(n.E7m("translucent",!0),n.yG2(3),n.cNF(m.lang.text.PostViewer.Title),n.yG2(3),n.E7m("fullscreen",!0),n.yG2(),n.E7m("ngIf",m.PostInfo.mainImage&&m.PostInfo.mainImage.MainThumbnail),n.yG2(2),n.E7m("ngIf",m.isOwner))},dependencies:[$.u_,v.sn,v.GS,v._i,v.eV,v.wB,v.tM,v.Md,v.Im]}),k})()}}]);