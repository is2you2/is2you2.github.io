"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7602],{5087:(R,F,r)=>{r.d(F,{r:()=>U});var E=r(655),P=r(5016),n=r(9863),f=r(3996),i=r(1282),u=r(3496),O=r(5742),A=r(4433),k=r(3336);let U=(()=>{class x{constructor(p,h,_,w,t,e,o,d,s){this.modalCtrl=p,this.navParams=h,this.global=_,this.indexed=w,this.lang=t,this.file=e,this.alertCtrl=o,this.loadingCtrl=d,this.p5toast=s,this.EventListenerAct=b=>{b.detail.register(120,g=>{})}}ngOnInit(){this.FileInfo=this.navParams.get("info")}ionViewDidEnter(){document.addEventListener("ionBackButton",this.EventListenerAct),this.global.CreateGodotIFrame("viewer",{local_url:"assets/data/godot/viewer.pck",title:"ViewerEx",path:this.navParams.get("path"),ext:this.FileInfo.file_ext,force_logo:!0,receive_image:(p,h,_)=>{this.modalCtrl.dismiss({base64:","+p,width:h,height:_})}})}snapshot_modify(){this.global.godot_window.modify_image()}download_file(){"DesktopPWA"==P.n$||"MobilePWA"==P.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:p=>(0,E.mG)(this,void 0,void 0,function*(){let h=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});h.present();let _=p.filename?`${p.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,w=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,_,w).then(t=>{h.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(t=>{12===(h.dismiss(),t.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",t)})})}]}).then(p=>p.present())}ionViewWillLeave(){document.removeEventListener("ionBackButton",this.EventListenerAct)}}return x.\u0275fac=function(p){return new(p||x)(n.Y36(f.IN),n.Y36(f.X1),n.Y36(i.A),n.Y36(u.H),n.Y36(O.b),n.Y36(A.$),n.Y36(f.Br),n.Y36(f.HT),n.Y36(k.F))},x.\u0275cmp=n.Xpm({type:x,selectors:[["app-godot-viewer"]],decls:20,vars:4,consts:[["slot","start",3,"click"],["defaultHref",""],[1,"main_table",2,"width","100%","height","100%","margin","0"],[2,"height","0"],["text-wrap",""],[3,"click"],["id","viewer",1,"full_screen",2,"display","flex"]],template:function(p,h){1&p&&(n.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),n._uU(3),n.qZA(),n.TgZ(4,"ion-buttons",0),n.NdJ("click",function(){return h.modalCtrl.dismiss()}),n._UZ(5,"ion-back-button",1),n.qZA()()(),n.TgZ(6,"ion-content")(7,"table",2)(8,"tr",3)(9,"td")(10,"ion-list-header")(11,"ion-label",4),n._uU(12),n.qZA(),n.TgZ(13,"ion-button",5),n.NdJ("click",function(){return h.snapshot_modify()}),n._uU(14),n.qZA(),n.TgZ(15,"ion-button",5),n.NdJ("click",function(){return h.download_file()}),n._uU(16),n.qZA()()()(),n.TgZ(17,"tr")(18,"td"),n._UZ(19,"div",6),n.qZA()()()()),2&p&&(n.xp6(3),n.Oqu(h.lang.text.ContentViewer.Title),n.xp6(9),n.Oqu(h.FileInfo.filename),n.xp6(2),n.hij("",h.lang.text.ContentViewer.Edit," "),n.xp6(2),n.hij("",h.lang.text.ContentViewer.Download," "))},directives:[f.Gu,f.sr,f.wd,f.Sm,f.oU,f.cs,f.W2,f.yh,f.Q$,f.YG],styles:[""]}),x})()},774:(R,F,r)=>{r.d(F,{B:()=>h});var E=r(655),P=r(5016),n=r(6505),i=r(9863),u=r(3996),O=r(3496),A=r(5742),k=r(4433),U=r(3336),x=r(6690),T=r(9808);function p(_,w){if(1&_){const t=i.EpF();i.TgZ(0,"ion-button",9),i.NdJ("click",function(){return i.CHM(t),i.oxw().modify_image()}),i._uU(1),i.qZA()}if(2&_){const t=i.oxw();i.xp6(1),i.hij(" ",t.lang.text.ContentViewer.Edit," ")}}let h=(()=>{class _{constructor(t,e,o,d,s,b,g,c,C){this.modalCtrl=t,this.navParams=e,this.indexed=o,this.lang=d,this.file=s,this.p5toast=b,this.alertCtrl=g,this.loadingCtrl=c,this.fileOpener=C,this.image_info={}}ngOnInit(){return(0,E.mG)(this,void 0,void 0,function*(){this.FileInfo=this.navParams.get("info"),this.ContentBox=document.getElementById("ContentBox"),this.FileHeader=document.getElementById("FileHeader"),this.HasNoEditButton=this.navParams.get("no_edit")||!1,this.blob=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type),this.FileURL=URL.createObjectURL(this.blob)})}ionViewDidEnter(){return(0,E.mG)(this,void 0,void 0,function*(){let t=document.getElementById("p5canvas");switch(this.FileInfo.viewer){case"image":this.p5canvas=new n(e=>{let o;e.setup=()=>(0,E.mG)(this,void 0,void 0,function*(){t.style.maxWidth="100%",t.style.overflow="hidden",this.ContentBox.style.overflow="hidden";let a=e.createCanvas(t.clientWidth,t.clientHeight);a.style("margin","0"),a.style("position","relative"),a.style("pointer-events","none");let v=document.createElement("img");v.hidden=!0,v.src=this.FileURL,v.onload=()=>{t.style.backgroundImage=`url(${this.FileURL})`,t.style.backgroundRepeat="no-repeat",t.style.pointerEvents="none",this.image_info.width=v.naturalWidth,this.image_info.height=v.naturalHeight,s=e.createVector(v.naturalWidth,v.naturalHeight),d(),v.remove()},("Android"==P.n$||"iOS"==P.n$)&&(o=document.createElement("iframe"),o.setAttribute("src",this.FileURL),o.setAttribute("frameborder","0"),o.setAttribute("class","full_screen"),o.setAttribute("style","position: relative; pointer-events: all"),o.hidden=!0,t.appendChild(o)),e.noLoop()});let d=()=>{t.style.backgroundSize=`${t.clientWidth}px`,t.style.backgroundPositionX="0px",t.style.backgroundPositionY=t.clientHeight/2-s.y*(t.clientWidth/s.x)/2+"px"};e.windowResized=()=>{setTimeout(()=>{d()},50)};let s,b=e.createVector(),g=e.createVector(),c=e.createVector(),C=1,D=()=>{t.style.backgroundPositionX=`${b.x+c.x}px`,t.style.backgroundPositionY=`${b.y+c.y}px`},W=(a,v)=>{let l=C,y=C*v,I=Number(t.style.backgroundPositionX.split("px")[0]),V=Number(t.style.backgroundPositionY.split("px")[0]),B=(l-y)*e.map(a.x,I,I+l,0,1),Y=(l-y)/s.x*s.y*e.map(a.y,V,V+l/s.x*s.y,0,1);t.style.backgroundPositionX=`${I+B}px`,t.style.backgroundPositionY=`${V+Y}px`,t.style.backgroundSize=`${y}px`};e.mousePressed=()=>{e.mouseButton==e.CENTER&&d(),"DesktopPWA"==P.n$&&(b=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),g=e.createVector(e.mouseX,e.mouseY))},e.mouseWheel=a=>{C=Number(t.style.backgroundSize.split("px")[0]),W(e.createVector(t.clientWidth/2,t.clientHeight/2),1-a.delta/1e3)},e.mouseDragged=()=>{"DesktopPWA"==P.n$&&(c=e.createVector(e.mouseX,e.mouseY),c.sub(g),D())};let L,m={},M=!1;e.touchStarted=a=>{for(let l=0,y=a.changedTouches.length;l<y;l++)m[a.changedTouches[l].identifier]=e.createVector(a.changedTouches[l].clientX,a.changedTouches[l].clientY);switch(Object.keys(m).length){case 1:b=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),g=m[a.changedTouches[0].identifier].copy();break;case 2:b=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0]));let l=m[0].copy();L=l.dist(m[1]),g=l.add(m[1]).div(2).copy(),C=Number(t.style.backgroundSize.split("px")[0]),D();break;default:M=!0,d()}},e.touchMoved=a=>{if(!M){for(let l=0,y=a.changedTouches.length;l<y;l++)m[a.changedTouches[l].identifier]=e.createVector(a.changedTouches[l].clientX,a.changedTouches[l].clientY);switch(Object.keys(m).length){case 1:c=m[a.changedTouches[0].identifier].copy(),c.sub(g),D();break;case 2:let l=m[0].copy(),y=l.dist(m[1]);c=l.add(m[1]).div(2).copy();let I=c.copy();c.sub(g),D(),W(I,y/L)}}},e.touchEnded=a=>{if("changedTouches"in a){for(let l=0,y=a.changedTouches.length;l<y;l++)delete m[a.changedTouches[l].identifier];switch(Object.keys(m).length){case 1:b=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),g=m[Object.keys(m)[0]].copy();break;case 0:M=!1}}}});break;case"audio":this.p5canvas=new n(e=>{var o;e.setup=()=>{let s=e.createCanvas(t.clientWidth,t.clientHeight);s.style("margin","0"),s.style("position","relative"),s.style("pointer-events","none"),e.noLoop(),o=e.createAudio([this.FileURL],()=>{t.appendChild(o.elt),s.parent(t),o.elt.hidden=!0,setTimeout(()=>{d(),o.elt.hidden=!1},50),o.showControls(),o.play()})};let d=()=>{if("audio"!=this.FileInfo.viewer)return;let s=this.ContentBox.offsetWidth;o.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),o.size(s,25)};e.windowResized=()=>{setTimeout(()=>{d()},50)}});break;case"video":this.p5canvas=new n(e=>{var o;e.setup=()=>{let s=e.createCanvas(t.clientWidth,t.clientHeight);s.style("margin","0"),s.style("position","relative"),s.style("pointer-events","none"),e.noLoop(),o=e.createVideo([this.FileURL],()=>{t.appendChild(o.elt),s.parent(t),o.elt.hidden=!0,setTimeout(()=>{d(),o.elt.hidden=!1},50),o.showControls(),o.play()})};let d=()=>{if("video"!=this.FileInfo.viewer)return;let s=this.ContentBox.offsetWidth,b=this.ContentBox.offsetHeight-this.FileHeader.offsetHeight,g=o.width,c=o.height;o.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),g>c?(g=s,c=c/o.width*g):(c=b,g=g/o.height*c),o.size(g,c)};e.windowResized=()=>{setTimeout(()=>{d()},50)}});break;case"text":this.p5canvas=new n(e=>{e.setup=()=>{let o=e.createCanvas(t.clientWidth,t.clientHeight);o.style("margin","0"),o.style("position","relative"),o.style("pointer-events","none"),e.noLoop(),e.loadStrings(this.FileURL,d=>{let s=document.createElement("textarea");s.disabled=!0,s.className="infobox",s.setAttribute("style","height: 100%; display: block;"),s.textContent=d.join("\n"),t.appendChild(s)},d=>{console.error("\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c: ",d),t.textContent="\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c\uc785\ub2c8\ub2e4.",this.FileInfo.else=!0})}});break;case"disabled":try{yield this.file.writeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`,this.blob),this.fileOpener.open(this.file.externalDataDirectory+`viewer_tmp.${this.FileInfo.file_ext}`,this.FileInfo.type||`application/${this.FileInfo.file_ext}`)}catch(e){console.log("open file failed: ",e),this.p5toast.show({text:`${this.lang.text.ChatRoom.cannot_open_file}: ${e.message}`})}}})}modify_image(){this.modalCtrl.dismiss(this.image_info)}download_file(){"DesktopPWA"==P.n$||"MobilePWA"==P.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:t=>(0,E.mG)(this,void 0,void 0,function*(){let e=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});e.present();let o=t.filename?`${t.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,d=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,o,d).then(s=>{e.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(s=>{12===(e.dismiss(),s.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",s)})})}]}).then(t=>t.present())}ionViewWillLeave(){this.p5canvas&&this.p5canvas.remove(),this.FileURL&&URL.revokeObjectURL(this.FileURL),this.file.removeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`)}}return _.\u0275fac=function(t){return new(t||_)(i.Y36(u.IN),i.Y36(u.X1),i.Y36(O.H),i.Y36(A.b),i.Y36(k.$),i.Y36(U.F),i.Y36(u.Br),i.Y36(u.HT),i.Y36(x.u))},_.\u0275cmp=i.Xpm({type:_,selectors:[["app-ionic-viewer"]],decls:19,vars:4,consts:[["id","Toolbar"],["slot","start",3,"click"],["defaultHref",""],["id","ContentBox"],[1,"main_table_elt"],[2,"height","0"],["id","FileHeader"],["text-wrap",""],[3,"click",4,"ngIf"],[3,"click"],["id","p5canvas",1,"full_screen",2,"overflow-y","scroll"]],template:function(t,e){1&t&&(i.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),i._uU(3),i.qZA(),i.TgZ(4,"ion-buttons",1),i.NdJ("click",function(){return e.modalCtrl.dismiss()}),i._UZ(5,"ion-back-button",2),i.qZA()()(),i.TgZ(6,"ion-content",3)(7,"table",4)(8,"tr",5)(9,"td")(10,"ion-list-header",6)(11,"ion-label",7),i._uU(12),i.qZA(),i.YNc(13,p,2,1,"ion-button",8),i.TgZ(14,"ion-button",9),i.NdJ("click",function(){return e.download_file()}),i._uU(15),i.qZA()()()(),i.TgZ(16,"tr")(17,"td"),i._UZ(18,"div",10),i.qZA()()()()),2&t&&(i.xp6(3),i.Oqu(e.lang.text.ContentViewer.Title),i.xp6(9),i.Oqu(e.FileInfo.filename),i.xp6(1),i.Q6J("ngIf","image"==e.FileInfo.viewer&&!e.HasNoEditButton),i.xp6(2),i.hij(" ",e.lang.text.ContentViewer.Download," "))},directives:[u.Gu,u.sr,u.wd,u.Sm,u.oU,u.cs,u.W2,u.yh,u.Q$,T.O5,u.YG],styles:[".main_table_elt[_ngcontent-%COMP%]{width:100%;height:100%;border:0;margin:0}"]}),_})()}}]);