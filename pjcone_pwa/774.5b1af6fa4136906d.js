"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[774],{774:(H,R,g)=>{g.d(R,{B:()=>me});var n=g(655),f=g(3996),u=g(5016),F=g(6505),M=g(549),B=g(3260),e=g(9863),V=g(3496),N=g(5742),w=g(4433),P=g(3336),h=g(6690),T=g(1282),D=g(9912),E=g(4299),A=g(9808);function q(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-icon",17),e.NdJ("click",function(){return e.CHM(t),e.oxw().ChangeToAnother(-1)}),e.qZA()}}function J(s,m){if(1&s&&(e.TgZ(0,"ion-label",18),e._uU(1),e.qZA()),2&s){const t=e.oxw();e.xp6(1),e.Oqu(t.RelevanceIndex+" / "+t.Relevances.length)}}function j(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-icon",19),e.NdJ("click",function(){return e.CHM(t),e.oxw().ChangeToAnother(1)}),e.qZA()}}function Q(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-button",20),e.NdJ("click",function(){return e.CHM(t),e.oxw().close_text_edit()}),e._UZ(1,"ion-icon",21),e.qZA()}}function z(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-button",20),e.NdJ("click",function(){return e.CHM(t),e.oxw().SaveText()}),e._UZ(1,"ion-icon",22),e.qZA()}}function G(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-button",23),e.NdJ("click",function(){return e.CHM(t),e.oxw().DownloadAllListFiles()}),e._UZ(1,"ion-icon",24),e.qZA()}if(2&s){const t=e.oxw();e.Q6J("disabled",t.isDownloading||t.MessageInfo.content.transfer_index&&"download"==t.MessageInfo.content.transfer_index.OnTransfer)}}function K(s,m){1&s&&(e.TgZ(0,"ion-button",25),e._UZ(1,"ion-icon",26),e.qZA())}function X(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(3).open_text_editor()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA()()}if(2&s){const t=e.oxw(3);e.xp6(2),e.Oqu(t.lang.text.ContentViewer.EditText)}}function ee(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(3).modify_image()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA()()}if(2&s){const t=e.oxw(3);e.xp6(2),e.Oqu(t.lang.text.ContentViewer.Edit)}}function te(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",31),e.NdJ("click",function(){return e.CHM(t),e.oxw(3).open_bottom_modal()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA()()}if(2&s){const t=e.oxw(3);e.xp6(2),e.Oqu(t.lang.text.ContentViewer.ContentInfo)}}function ie(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(3).download_file()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA()()}if(2&s){const t=e.oxw(3);e.xp6(2),e.Oqu(t.lang.text.ContentViewer.Download)}}function ne(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(3).RemoveFile()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA()()}if(2&s){const t=e.oxw(3);e.xp6(2),e.Oqu(t.lang.text.ContentViewer.RemoveFile)}}function oe(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-content")(1,"ion-list"),e.YNc(2,X,3,1,"ion-item",28),e.YNc(3,ee,3,1,"ion-item",28),e.YNc(4,te,3,1,"ion-item",29),e.TgZ(5,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(2).ShareContent()}),e.TgZ(6,"ion-label"),e._uU(7),e.qZA()(),e.YNc(8,ie,3,1,"ion-item",28),e.YNc(9,ne,3,1,"ion-item",28),e.qZA()()}if(2&s){const t=e.oxw(2);e.xp6(2),e.Q6J("ngIf","text"==t.FileInfo.viewer&&!t.HasNoEditButton),e.xp6(1),e.Q6J("ngIf","audio"!=t.FileInfo.viewer&&!t.HasNoEditButton),e.xp6(1),e.Q6J("ngIf",t.FileInfo.content_creator),e.xp6(3),e.Oqu(t.lang.text.ContentViewer.ShareContent),e.xp6(1),e.Q6J("ngIf",!t.FileInfo.url),e.xp6(1),e.Q6J("ngIf",t.OpenInChannelChat)}}function ae(s,m){1&s&&(e.TgZ(0,"ion-popover",27),e.YNc(1,oe,10,6,"ng-template"),e.qZA())}function se(s,m){1&s&&e._UZ(0,"div",34)}function le(s,m){1&s&&e._UZ(0,"div",35)}function re(s,m){if(1&s&&(e.TgZ(0,"td"),e.YNc(1,se,1,0,"div",32),e.YNc(2,le,1,0,"div",33),e.qZA()),2&s){const t=e.oxw();e.xp6(1),e.Q6J("ngIf","pck"!=t.FileInfo.file_ext),e.xp6(1),e.Q6J("ngIf","pck"==t.FileInfo.file_ext)}}function ce(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"td")(1,"ion-grid")(2,"ion-row",36)(3,"ion-col",37)(4,"ion-button",38),e.NdJ("click",function(){return e.CHM(t),e.oxw().DownloadCurrentFile()}),e._uU(5),e.qZA()()()()()}if(2&s){const t=e.oxw();e.xp6(4),e.Q6J("disabled",t.isDownloading||t.MessageInfo.content.transfer_index&&"download"==t.MessageInfo.content.transfer_index.OnTransfer),e.xp6(1),e.hij(" ",t.MessageInfo.content.transfer_index&&"download"==t.MessageInfo.content.transfer_index.OnTransfer?t.lang.text.ContentViewer.FileDownloading:t.lang.text.ContentViewer.DownloadThisFile," ")}}function _e(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(2).copy_url()}),e.TgZ(1,"ion-label"),e._uU(2),e.qZA(),e.TgZ(3,"ion-label",39),e._uU(4),e.qZA()()}if(2&s){const t=e.oxw(2);e.xp6(2),e.Oqu(t.lang.text.ContentInfo.SourceFrom),e.xp6(2),e.Oqu(t.content_creator.various_display)}}function he(s,m){if(1&s&&(e.TgZ(0,"ion-item")(1,"ion-label"),e._uU(2),e.qZA(),e.TgZ(3,"ion-label",39),e._uU(4),e.qZA()()),2&s){const t=e.oxw(2);e.xp6(2),e.Oqu(t.lang.text.ContentInfo.FileSize),e.xp6(2),e.Oqu(t.CurrentFileSize)}}function de(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"div")(1,"ion-item-divider")(2,"div",42),e._uU(3),e.qZA()(),e.TgZ(4,"ion-item")(5,"ion-label"),e._uU(6),e.qZA(),e.TgZ(7,"ion-label",39),e._uU(8),e.qZA()(),e.TgZ(9,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw(2).copy_url()}),e.TgZ(10,"ion-label"),e._uU(11),e.qZA(),e.TgZ(12,"ion-label",39),e._uU(13),e.qZA()()()}if(2&s){const t=m.$implicit,i=e.oxw(2);e.xp6(3),e.Oqu(t.timeDisplay),e.xp6(3),e.Oqu(i.lang.text.ContentInfo.Publisher),e.xp6(2),e.Oqu(t.publisher||t.display_name||i.lang.text.Profile.noname_user),e.xp6(3),e.Oqu(i.lang.text.ContentInfo.SourceFrom),e.xp6(2),e.Oqu(t.various_display)}}function ge(s,m){if(1&s){const t=e.EpF();e.TgZ(0,"ion-content")(1,"ion-item-divider")(2,"ion-label"),e._uU(3),e.qZA()(),e.TgZ(4,"ion-item")(5,"ion-label"),e._uU(6),e.qZA(),e.TgZ(7,"ion-label",39),e._uU(8),e.qZA()(),e.YNc(9,_e,5,2,"ion-item",28),e.YNc(10,he,5,2,"ion-item",15),e.TgZ(11,"ion-item")(12,"ion-label"),e._uU(13),e.qZA(),e.TgZ(14,"ion-label",39),e._uU(15),e.qZA()(),e.YNc(16,de,14,5,"div",40),e.TgZ(17,"ion-item",30),e.NdJ("click",function(){return e.CHM(t),e.oxw().ShowContentInfoIonic.dismiss()}),e.TgZ(18,"ion-label",41),e._uU(19),e.qZA()()()}if(2&s){const t=e.oxw();e.xp6(3),e.Oqu(t.lang.text.ContentInfo.WorkLogs),e.xp6(3),e.Oqu(t.lang.text.ContentInfo.LastPost),e.xp6(2),e.hij(" ",(t.content_creator.user_id?t.content_creator.is_me?t.nakama.users.self.display_name:t.nakama.users[t.isOfficial][t.target][t.content_creator.user_id].display_name:t.content_creator.display_name)||t.lang.text.Profile.noname_user,""),e.xp6(1),e.Q6J("ngIf",t.content_creator.various),e.xp6(1),e.Q6J("ngIf",!t.FileInfo.url),e.xp6(3),e.Oqu(t.lang.text.ContentInfo.TimeAt),e.xp6(2),e.Oqu(t.content_creator.timeDisplay),e.xp6(1),e.Q6J("ngForOf",t.content_related_creator),e.xp6(3),e.Oqu(t.lang.text.ContentInfo.CloseModal)}}const fe=function(){return[.5,1]};let me=(()=>{class s{constructor(t,i,a,r,d,o,l,_,v,C,I,x){this.modalCtrl=t,this.navParams=i,this.indexed=a,this.lang=r,this.file=d,this.p5toast=o,this.alertCtrl=l,this.loadingCtrl=_,this.fileOpener=v,this.global=C,this.nakama=I,this.mClipboard=x,this.useP5Navigator=!0,this.RelevanceIndex=0,this.HaveRelevances=!1,this.NeedDownloadFile=!1,this.isDownloading=!1,this.OpenInChannelChat=!1,this.EventListenerAct=k=>{k.detail.register(120,U=>{})},this.isTextEditMode=!1,this.image_info={},this.forceWrite=!1}ngOnInit(){return(0,n.mG)(this,void 0,void 0,function*(){if("text"===(this.MessageInfo=this.navParams.get("info"),this.OpenInChannelChat=void 0!==this.MessageInfo.code,this.CurrentViewId=this.MessageInfo.message_id,this.FileInfo=this.MessageInfo.content,this.ContentBox=document.getElementById("ContentBox"),this.FileHeader=document.getElementById("FileHeader"),this.isOfficial=this.navParams.get("isOfficial"),this.target=this.navParams.get("target"),this.targetDB=this.navParams.get("targetDB"),this.HasNoEditButton=this.navParams.get("no_edit")||!1,this.FileInfo.is_new));else{if(this.Relevances=this.navParams.get("relevance"),this.Relevances){for(let t=0,i=this.Relevances.length;t<i;t++)if(this.Relevances[t].message_id&&this.MessageInfo.message_id){if(this.Relevances[t].message_id==this.MessageInfo.message_id){this.RelevanceIndex=t+1;break}}else if(this.Relevances[t].content.path==this.MessageInfo.content.path){this.RelevanceIndex=t+1;break}this.HaveRelevances=Boolean(this.Relevances.length>1)}else this.HaveRelevances=!1;this.FileInfo.url?this.FileURL=this.FileInfo.url:(this.blob=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type,void 0,this.targetDB),this.FileURL=URL.createObjectURL(this.blob)),this.CreateContentInfo()}})}reinit_content_data(t){return(0,n.mG)(this,void 0,void 0,function*(){if(this.NeedDownloadFile=!1,this.isTextEditMode=!1,this.MessageInfo=t,this.CurrentViewId=this.MessageInfo.message_id,this.FileInfo=this.MessageInfo.content,URL.revokeObjectURL(this.FileURL),this.FileInfo.url)this.FileURL=this.FileInfo.url,this.CreateContentInfo(),this.ionViewDidEnter();else{let i=this.FileInfo.path||`servers/${this.isOfficial}/${this.target}/channels/${t.channel_id}/files/msg_${t.message_id}.${t.content.file_ext}`;this.image_info.path=i,this.NeedDownloadFile=yield this.indexed.checkIfFileExist(`${i}.history`,void 0,this.targetDB);try{this.blob=yield this.indexed.loadBlobFromUserPath(i,this.FileInfo.type,void 0,this.targetDB),this.FileURL=URL.createObjectURL(this.blob),this.CreateContentInfo(),this.ionViewDidEnter()}catch(a){this.FileURL=void 0,this.blob=void 0,this.isDownloading=!1,this.NeedDownloadFile=!0,this.CreateContentInfo()}}})}DownloadAllListFiles(){this.alertCtrl.create({header:this.lang.text.ContentViewer.DownloadAllFiles,message:this.lang.text.ContentViewer.DownloadLoadedList,buttons:[{text:this.lang.text.ContentViewer.DownloadThisFile,handler:()=>(0,n.mG)(this,void 0,void 0,function*(){for(let t=0,i=this.Relevances.length;t<i;t++){let a=`servers/${this.isOfficial}/${this.target}/channels/${this.Relevances[t].channel_id}/files/msg_${this.Relevances[t].message_id}.${this.Relevances[t].content.file_ext}`;(yield this.indexed.checkIfFileExist(a,void 0,this.targetDB))||(yield this.DownloadCurrentFile(t))}})}]}).then(t=>t.present())}ChangeToAnother(t){this.p5canvas&&this.p5canvas.remove();let i=this.RelevanceIndex+t;i<=0||i>this.Relevances.length||(this.RelevanceIndex=i,this.FileInfo={file_ext:""},setTimeout(()=>{this.reinit_content_data(this.Relevances[this.RelevanceIndex-1])},0))}DownloadCurrentFile(t){return(0,n.mG)(this,void 0,void 0,function*(){this.isDownloading=!0;let i=0,a=this.Relevances[null!=t?t:this.RelevanceIndex-1],r=`servers/${this.isOfficial}/${this.target}/channels/${a.channel_id}/files/msg_${a.message_id}.${a.content.file_ext}`;try{let l=yield this.indexed.loadTextFromUserPath(`${r}.history`,void 0,this.targetDB);i=JSON.parse(l).index}catch(l){}let d=a.message_id;if((yield this.nakama.ReadStorage_From_channel(a,r,this.isOfficial,this.target,i))&&!this.nakama.channels_orig[this.isOfficial][this.target][a.channel_id].HideAutoThumbnail){let l=yield this.indexed.loadBlobFromUserPath(r,a.content.type||""),_=URL.createObjectURL(l);a.content.path=r,yield this.global.modulate_thumbnail(a.content,_)}this.CurrentViewId==d&&this.reinit_content_data(a)})}formatBytes(t,i=2){if(!+t)return"0 Bytes";const r=i<0?0:i,o=Math.floor(Math.log(t)/Math.log(1024));return`${parseFloat((t/Math.pow(1024,o)).toFixed(r))} ${["Bytes","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"][o]}`}CreateContentInfo(){try{this.CurrentFileSize=this.formatBytes(this.FileInfo.size||this.FileInfo.filesize),this.content_creator=this.FileInfo.content_creator,this.content_creator.timeDisplay=new Date(this.content_creator.timestamp).toLocaleString(),this.content_related_creator=this.FileInfo.content_related_creator,this.content_creator.user_id&&(this.content_creator.is_me=this.nakama.servers[this.isOfficial][this.target].session.user_id==this.content_creator.user_id),this.set_various_display(this.content_creator);for(let t=0,i=this.content_related_creator.length;t<i;t++)this.content_related_creator[t].user_id&&(this.content_related_creator[t].is_me=this.nakama.servers[this.isOfficial][this.target].session.user_id==this.content_related_creator[t].user_id),this.content_related_creator[t].timeDisplay=new Date(this.content_related_creator[t].timestamp).toLocaleString(),this.set_various_display(this.content_related_creator[t])}catch(t){}try{this.content_related_creator[0].publisher=this.content_related_creator[0].is_me?this.nakama.users.self.display_name:this.nakama.users[this.isOfficial][this.target][this.content_related_creator[0].user_id].display_name,this.content_related_creator[0].timestamp==this.content_related_creator[1].timestamp&&(this.content_related_creator[0].publisher=this.content_related_creator[1].is_me?this.nakama.users.self.display_name:this.nakama.users[this.isOfficial][this.target][this.content_related_creator[1].user_id].display_name,this.content_related_creator.splice(1,1))}catch(t){try{this.content_related_creator[0].publisher=this.content_related_creator[1].display_name,this.content_related_creator[0].timestamp==this.content_related_creator[1].timestamp&&(this.content_related_creator[0].publisher=this.content_related_creator[1].display_name,this.content_related_creator.splice(1,1))}catch(i){}try{this.content_related_creator[0].publisher||(this.content_related_creator[0].publisher=this.content_related_creator[0].display_name)}catch(i){}}try{this.content_related_creator.sort((t,i)=>t.timestamp>i.timestamp?-1:t.timestamp<i.timestamp?1:0)}catch(t){}}set_various_display(t){switch(t.various_display=this.lang.text.GlobalAct.UnknownSource,t.various){case"camera":t.various_display=this.lang.text.GlobalAct.FromCamera;break;case"link":t.various_display=this.FileInfo.url;break;case"loaded":t.various_display=this.lang.text.GlobalAct.variousCreator;break;case"voidDraw":t.various_display=this.lang.text.GlobalAct.FromVoidDraw;break;case"long_text":t.various_display=this.lang.text.GlobalAct.FromAutoLongText;break;case"textedit":t.various_display=this.lang.text.GlobalAct.FromTextEditor}}close_text_edit(){this.FileInfo.is_new?this.modalCtrl.dismiss():this.reinit_content_data(this.MessageInfo)}ionViewDidEnter(){return(0,n.mG)(this,void 0,void 0,function*(){this.forceWrite=!1;let t=document.getElementById("content_viewer_canvas");switch(t&&(t.style.backgroundImage=""),document.removeEventListener("ionBackButton",this.EventListenerAct),this.p5canvas&&this.p5canvas.remove(),this.FileInfo.viewer){case"image":this.p5canvas=new F(o=>{let l;o.setup=()=>(0,n.mG)(this,void 0,void 0,function*(){t.style.maxWidth="100%",t.style.overflow="hidden",this.ContentBox.style.overflow="hidden",o.noCanvas();let c=o.createElement("img");c.elt.hidden=!0,c.elt.src=this.FileURL,c.elt.onload=()=>{t.style.backgroundImage=`url(${this.FileURL})`,t.style.backgroundRepeat="no-repeat",t.style.pointerEvents="none",this.image_info.width=c.elt.naturalWidth,this.image_info.height=c.elt.naturalHeight,v=o.createVector(c.elt.naturalWidth,c.elt.naturalHeight),_(),c.remove()},("Android"==u.n$||"iOS"==u.n$)&&(l=o.createElement("iframe"),l.elt.setAttribute("src",this.FileURL),l.elt.setAttribute("frameborder","0"),l.elt.setAttribute("class","full_screen"),l.elt.setAttribute("style","position: relative; pointer-events: all"),l.elt.hidden=!0,t.appendChild(l.elt)),o.noLoop()});let _=()=>{if(this.image_info.width/this.image_info.height<t.clientWidth/t.clientHeight){let c=this.image_info.width*t.clientHeight/this.image_info.height;t.style.backgroundSize=`${c}px`,t.style.backgroundPositionX=(t.clientWidth-c)/2+"px",t.style.backgroundPositionY="0px"}else t.style.backgroundSize=`${t.clientWidth}px`,t.style.backgroundPositionX="0px",t.style.backgroundPositionY=t.clientHeight/2-v.y*(t.clientWidth/v.x)/2+"px"};o.windowResized=()=>{setTimeout(()=>{_()},50)};let v,C=o.createVector(),I=o.createVector(),x=o.createVector(),k=1,U=()=>{t.style.backgroundPositionX=`${C.x+x.x}px`,t.style.backgroundPositionY=`${C.y+x.y}px`},S=(c,O)=>{let p=k,y=k*O,Z=Number(t.style.backgroundPositionX.split("px")[0]),W=Number(t.style.backgroundPositionY.split("px")[0]),pe=(p-y)*o.map(c.x,Z,Z+p,0,1),ue=(p-y)/v.x*v.y*o.map(c.y,W,W+p/v.x*v.y,0,1);t.style.backgroundPositionX=`${Z+pe}px`,t.style.backgroundPositionY=`${W+ue}px`,t.style.backgroundSize=`${y}px`};o.mousePressed=()=>{!this.useP5Navigator||(o.mouseButton==o.CENTER&&_(),"DesktopPWA"==u.n$&&(C=o.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),I=o.createVector(o.mouseX,o.mouseY)))},o.mouseWheel=c=>{!this.useP5Navigator||(k=Number(t.style.backgroundSize.split("px")[0]),S(o.createVector(t.clientWidth/2,t.clientHeight/2),1-c.delta/1e3))},o.mouseDragged=()=>{!this.useP5Navigator||"DesktopPWA"==u.n$&&(x=o.createVector(o.mouseX,o.mouseY),x.sub(I),U())};let $,b={},L=!1;o.touchStarted=c=>{if(this.useP5Navigator){for(let p=0,y=c.changedTouches.length;p<y;p++)b[c.changedTouches[p].identifier]=o.createVector(c.changedTouches[p].clientX,c.changedTouches[p].clientY);switch(Object.keys(b).length){case 1:C=o.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),I=b[c.changedTouches[0].identifier].copy();break;case 2:C=o.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0]));let p=b[0].copy();$=p.dist(b[1]),I=p.add(b[1]).div(2).copy(),k=Number(t.style.backgroundSize.split("px")[0]),U();break;default:L=!0,_()}}},o.touchMoved=c=>{if(this.useP5Navigator&&!L){for(let p=0,y=c.changedTouches.length;p<y;p++)b[c.changedTouches[p].identifier]=o.createVector(c.changedTouches[p].clientX,c.changedTouches[p].clientY);switch(Object.keys(b).length){case 1:x=b[c.changedTouches[0].identifier].copy(),x.sub(I),U();break;case 2:let p=b[0].copy(),y=p.dist(b[1]);x=p.add(b[1]).div(2).copy();let Z=x.copy();x.sub(I),U(),S(Z,y/$)}}},o.touchEnded=c=>{if(this.useP5Navigator&&"changedTouches"in c){for(let p=0,y=c.changedTouches.length;p<y;p++)delete b[c.changedTouches[p].identifier];switch(Object.keys(b).length){case 1:C=o.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),I=b[Object.keys(b)[0]].copy();break;case 0:L=!1}}}});break;case"audio":this.p5canvas=new F(o=>{var l;o.setup=()=>{o.noCanvas(),o.noLoop(),l=o.createAudio([this.FileURL],()=>{t.appendChild(l.elt),l.elt.hidden=!0,setTimeout(()=>{_(),l.elt.hidden=!1},50),l.showControls(),l.play()})};let _=()=>{let v=this.ContentBox.offsetWidth;l.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),l.size(v,25)};o.windowResized=()=>{setTimeout(()=>{_()},50)}});break;case"video":this.p5canvas=new F(o=>{var l;o.setup=()=>{o.noCanvas(),o.noLoop(),l=o.createVideo([this.FileURL],()=>{t.appendChild(l.elt),l.elt.hidden=!0,setTimeout(()=>{this.image_info.width=l.elt.videoWidth,this.image_info.height=l.elt.videoHeight,_(),l.elt.hidden=!1},50),l.showControls(),l.play()}),o.VideoMedia=l};let _=()=>{let v=this.ContentBox.offsetWidth,C=this.ContentBox.offsetHeight-this.FileHeader.offsetHeight,I=l.width,x=l.height;l.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),I<x?(x=C,I=I/l.height*x):(I=v,x=x/l.width*I||C/2),l.size(I,x)};o.windowResized=()=>{setTimeout(()=>{_()},50)}});break;case"text":this.p5canvas=new F(o=>{o.setup=()=>{o.noCanvas(),o.noLoop(),o.loadStrings(this.FileURL,l=>{let _=o.createElement("textarea");_.elt.disabled=!0,_.elt.className="infobox",_.elt.setAttribute("style","height: 100%; display: block;"),_.elt.textContent=l.join("\n"),t.appendChild(_.elt),o.TextArea=_.elt},l=>{if(this.FileInfo.is_new){let _=o.createElement("textarea");_.elt.disabled=!0,_.elt.className="infobox",_.elt.setAttribute("style","height: 100%; display: block;"),_.elt.textContent="",t.appendChild(_.elt),o.TextArea=_.elt,this.open_text_editor()}else t.textContent=this.lang.text.ContentViewer.CannotOpenText,this.FileInfo.else=!0})}});break;case"godot":document.addEventListener("ionBackButton",this.EventListenerAct);let i,r,a=this.MessageInfo.message_id;if(!this.targetDB){r="tmp_files/duplicate/viewer.pck";let o=yield this.indexed.loadBlobFromUserPath(this.FileInfo.path||this.navParams.get("path"),"");yield this.indexed.saveBlobToUserPath(o,r,void 0,this.indexed.godotDB)}try{let o=yield this.indexed.loadBlobFromUserPath((this.FileInfo.path||this.navParams.get("path"))+"_thumbnail.png","",void 0,this.targetDB);i=URL.createObjectURL(o)}catch(o){}!this.NeedDownloadFile&&this.CurrentViewId==a&&(yield this.global.CreateGodotIFrame("content_viewer_canvas",{local_url:"assets/data/godot/viewer.pck",title:"ViewerEx",path:r,alt_path:this.FileInfo.path||this.navParams.get("path"),ext:this.FileInfo.file_ext,force_logo:!0,background:i,receive_image:(o,l,_)=>(0,n.mG)(this,void 0,void 0,function*(){let v="tmp_files/modify_image.png";yield this.indexed.saveBase64ToUserPath(","+o,v,void 0,this.indexed.godotDB),this.modalCtrl.dismiss({type:"image",path:v,width:l,height:_,msg:this.MessageInfo,index:this.RelevanceIndex-1})})},"create_thumbnail",this.indexed.ionicDB)),i&&URL.revokeObjectURL(i);break;case"disabled":let d=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});d.present();try{try{yield this.file.writeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`,this.blob)}catch(o){yield this.file.writeExistingFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`,this.blob)}this.fileOpener.open(this.file.externalDataDirectory+`viewer_tmp.${this.FileInfo.file_ext}`,this.FileInfo.type||`application/${this.FileInfo.file_ext}`)}catch(o){console.log("open file failed: ",o),this.p5toast.show({text:`${this.lang.text.ChatRoom.cannot_open_file}: ${o.message}`})}d.dismiss()}})}open_bottom_modal(){this.ShowContentInfoIonic.onDidDismiss().then(t=>{this.useP5Navigator=!0}),this.useP5Navigator=!1,this.ShowContentInfoIonic.present()}open_text_editor(){this.p5canvas.TextArea.disabled=!1,setTimeout(()=>{this.isTextEditMode=!0,this.p5canvas.TextArea.focus()},500)}SaveText(){return(0,n.mG)(this,void 0,void 0,function*(){let t=new Blob([this.p5canvas.TextArea.value],{type:this.FileInfo.type});if(t.name=this.FileInfo.filename,this.OpenInChannelChat)this.modalCtrl.dismiss({type:"text",blob:t,contentRelated:this.FileInfo.content_related_creator});else{let i=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});i.present();let a=`/tmp_files/texteditor/${this.FileInfo.filename}`;yield this.indexed.saveBlobToUserPath(t,a,void 0,this.targetDB),i.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved}),this.modalCtrl.dismiss({type:"text",blob:t,path:a})}})}modify_image(){return(0,n.mG)(this,void 0,void 0,function*(){switch(this.FileInfo.viewer){case"image":{let a=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});a.present();try{let r;this.image_info.path=`tmp_files/external_image_edit/image_download.${this.FileInfo.file_ext}`,r=this.FileInfo.url?yield fetch(this.FileInfo.url).then(d=>d.blob()):yield this.indexed.loadBlobFromUserPath(this.FileInfo.path||this.navParams.get("path"),this.FileInfo.type||"",void 0,this.targetDB),yield this.indexed.saveBlobToUserPath(r,this.image_info.path,void 0,this.indexed.godotDB),this.modalCtrl.dismiss(Object.assign(Object.assign({type:"image"},this.image_info),{path:this.image_info.path,msg:this.MessageInfo,index:this.RelevanceIndex-1}))}catch(r){this.p5toast.show({text:`${this.lang.text.ContentViewer.CannotEditFile}: ${r}`})}a.dismiss()}break;case"text":let t=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});t.present(),this.image_info.width=this.p5canvas.TextArea.clientWidth,this.image_info.height=this.p5canvas.TextArea.scrollHeight,this.p5canvas.createCanvas(this.image_info.width,this.image_info.height),this.p5canvas.textSize(16),this.p5canvas.textWrap(this.p5canvas.WORD);let i=.05*this.p5canvas.width;this.p5canvas.text(this.p5canvas.TextArea.textContent,i,i,this.p5canvas.width-2*i),this.p5canvas.saveFrames("","png",1,1,a=>(0,n.mG)(this,void 0,void 0,function*(){try{t.dismiss(),this.image_info.path="tmp_files/text_edit/text_copy.png",yield this.indexed.saveBase64ToUserPath(a[0].imageData.replace(/"|=|\\/g,"",void 0,this.indexed.godotDB),this.image_info.path,void 0,this.indexed.godotDB),this.modalCtrl.dismiss(Object.assign(Object.assign({type:"image"},this.image_info),{msg:this.MessageInfo,index:this.RelevanceIndex-1}))}catch(r){console.log("\ud30c\uc77c \uc800\uc7a5 \uc624\ub958: ",r)}}));break;case"video":try{let a=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});a.present(),this.p5canvas.VideoMedia.pause(),this.p5canvas.createCanvas(this.image_info.width,this.image_info.height),this.p5canvas.image(this.p5canvas.VideoMedia,0,0,this.image_info.width,this.image_info.height),this.p5canvas.saveFrames("","png",1,1,r=>(0,n.mG)(this,void 0,void 0,function*(){try{a.dismiss(),this.image_info.path="tmp_files/video_edit/frame.png",yield this.indexed.saveBase64ToUserPath(r[0].imageData.replace(/"|=|\\/g,""),this.image_info.path,void 0,this.indexed.godotDB),this.modalCtrl.dismiss(Object.assign(Object.assign({type:"image"},this.image_info),{msg:this.MessageInfo,index:this.RelevanceIndex-1}))}catch(d){console.log("\ud30c\uc77c \uc800\uc7a5 \uc624\ub958: ",d)}}))}catch(a){console.log("\uc7ac\uc0dd\uc911\uc778 \ube44\ub514\uc624 \uc774\ubbf8\uc9c0 \ucd94\ucd9c \uc624\ub958: ",a)}break;case"godot":this.global.godot_window.modify_image();break;default:console.log("\ud3b8\uc9d1 \ubd88\uac00 \ud30c\uc77c \uc815\ubcf4: ",this.FileInfo)}})}download_file(){"DesktopPWA"==u.n$||"MobilePWA"==u.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename,this.targetDB):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:t=>(0,n.mG)(this,void 0,void 0,function*(){let i=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});i.present();let a=t.filename?t.filename.replace(/:|\?|\/|\\|<|>/g,""):this.FileInfo.filename,r=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type,void 0,this.targetDB);this.forceWrite&&!t.filename?this.file.writeExistingFile(this.file.externalDataDirectory,a,r).then(d=>{this.forceWrite=!1,i.dismiss(),this.p5toast.show({text:`${this.lang.text.ContentViewer.OverWriteFile}: ${a}`})}):this.file.writeFile(this.file.externalDataDirectory,a,r).then(d=>{i.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(d=>{12===(i.dismiss(),d.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.forceWrite=!0,this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",d)})})}]}).then(t=>t.present())}ShareContent(){let t=this.nakama.rearrange_channels();for(let i=t.length-1;i>=0;i--)("missing"==t[i].status||"offline"==t[i].status)&&t.splice(i,1);t.length?this.modalCtrl.create({component:M.D,componentProps:{file:this.FileInfo,channels:t}}).then(i=>{i.onDidDismiss().then(a=>{a.data&&this.modalCtrl.dismiss()}),i.present()}):this.p5toast.show({text:this.lang.text.ShareContentToOther.NoChannelToShare})}RemoveFile(){this.alertCtrl.create({header:this.lang.text.ContentViewer.RemoveFile,message:this.FileInfo.path,buttons:[{text:this.lang.text.TodoDetail.remove,handler:()=>(0,n.mG)(this,void 0,void 0,function*(){URL.revokeObjectURL(this.FileURL),yield this.indexed.removeFileFromUserPath(this.FileInfo.path,void 0,this.targetDB),this.RelevanceIndex-=1,this.ChangeToAnother(1)})}]}).then(t=>t.present())}ionViewWillLeave(){return(0,n.mG)(this,void 0,void 0,function*(){switch(document.removeEventListener("ionBackButton",this.EventListenerAct),this.FileInfo.viewer){case"video":try{let a,r,i=this.p5canvas.VideoMedia.size();i.width>i.height?(a=192,r=i.height/i.width*192):(a=i.width/i.height*192,r=192),this.p5canvas.createCanvas(a,r),this.p5canvas.image(this.p5canvas.VideoMedia,0,0,a,r),this.p5canvas.fill(255,128),this.p5canvas.rect(0,0,a,r),this.p5canvas.textWrap(this.p5canvas.CHAR),this.p5canvas.textSize(16);let d=r/16;this.p5canvas.push(),this.p5canvas.translate(d/6,d/6),this.p5canvas.fill(0),this.p5canvas.text(this.FileInfo.filename,d,d,a-2*d,r-2*d),this.p5canvas.filter(this.p5canvas.BLUR,3),this.p5canvas.pop(),this.p5canvas.fill(255),this.p5canvas.text(this.FileInfo.filename,d,d,a-2*d,r-2*d),this.p5canvas.saveFrames("","png",1,1,o=>(0,n.mG)(this,void 0,void 0,function*(){try{yield this.indexed.saveBase64ToUserPath(o[0].imageData.replace(/"|=|\\/g,""),`${this.FileInfo.path}_thumbnail.png`,void 0,this.targetDB),this.global.modulate_thumbnail(this.FileInfo,"")}catch(l){console.log("\uc378\ub124\uc77c \uc800\uc7a5 \uc624\ub958: ",l)}}))}catch(i){console.log("\uc791\uc5c5\uc911 \uc624\ub958\ubcf4\uae30: ",i)}break;case"godot":try{this.global.godot_window.filename=this.FileInfo.filename,this.global.godot_window.create_thumbnail(this.FileInfo)}catch(i){}}this.p5canvas&&this.p5canvas.remove(),URL.revokeObjectURL(this.FileURL),(yield this.file.checkFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`))&&(yield this.file.removeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`))})}copy_url(){this.mClipboard.copy(this.FileInfo.url).catch(t=>B.Z.write(this.FileInfo.url))}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(f.IN),e.Y36(f.X1),e.Y36(V.H),e.Y36(N.b),e.Y36(w.$),e.Y36(P.F),e.Y36(f.Br),e.Y36(f.HT),e.Y36(h.u),e.Y36(T.AN),e.Y36(D.a),e.Y36(E.T))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-ionic-viewer"]],viewQuery:function(t,i){if(1&t&&e.Gf(f.ki,5),2&t){let a;e.iGM(a=e.CRH())&&(i.ShowContentInfoIonic=a.first)}},decls:26,vars:15,consts:[["id","Toolbar"],["slot","start",3,"click"],["defaultHref",""],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["id","ContentBox"],[1,"main_table_elt"],[2,"height","0"],["id","FileHeader"],["text-wrap",""],[3,"click",4,"ngIf"],["class","ion-align-items-center",3,"disabled","click",4,"ngIf"],["id","menu_trigger",4,"ngIf"],["trigger","menu_trigger","dismissOnSelect","",4,"ngIf"],[4,"ngIf"],["trigger","ShowContentInfoIonic",3,"initialBreakpoint","breakpoints"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],[3,"click"],["name","close-circle-outline"],["name","save-outline"],[1,"ion-align-items-center",3,"disabled","click"],["name","code-download-outline"],["id","menu_trigger"],["name","ellipsis-vertical"],["trigger","menu_trigger","dismissOnSelect",""],["button","",3,"click",4,"ngIf"],["button","","id","ShowContentInfoIonic",3,"click",4,"ngIf"],["button","",3,"click"],["button","","id","ShowContentInfoIonic",3,"click"],["class","full_screen","id","content_viewer_canvas",4,"ngIf"],["class","full_screen","style","display: flex;","id","content_viewer_canvas",4,"ngIf"],["id","content_viewer_canvas",1,"full_screen"],["id","content_viewer_canvas",1,"full_screen",2,"display","flex"],[1,"ion-align-items-center"],["size","12",1,"ion-text-center"],["color","warning","shape","round",1,"ion-align-items-center",3,"disabled","click"],[1,"ion-text-end"],[4,"ngFor","ngForOf"],[1,"ion-text-center"],[2,"width","100%","text-align","center"]],template:function(t,i){1&t&&(e.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),e._uU(3),e.qZA(),e.TgZ(4,"ion-buttons",1),e.NdJ("click",function(){return i.modalCtrl.dismiss()}),e._UZ(5,"ion-back-button",2),e.qZA(),e.YNc(6,q,1,0,"ion-icon",3),e.YNc(7,J,2,1,"ion-label",4),e.YNc(8,j,1,0,"ion-icon",5),e.qZA()(),e.TgZ(9,"ion-content",6)(10,"table",7)(11,"tr",8)(12,"td")(13,"ion-list-header",9)(14,"ion-label",10),e._uU(15),e.qZA(),e.YNc(16,Q,2,0,"ion-button",11),e.YNc(17,z,2,0,"ion-button",11),e.YNc(18,G,2,1,"ion-button",12),e.YNc(19,K,2,0,"ion-button",13),e.YNc(20,ae,2,0,"ion-popover",14),e.qZA()()(),e.TgZ(21,"tr"),e.YNc(22,re,3,2,"td",15),e.YNc(23,ce,6,2,"td",15),e.qZA()(),e.TgZ(24,"ion-modal",16),e.YNc(25,ge,20,9,"ng-template"),e.qZA()()),2&t&&(e.xp6(3),e.Oqu(i.lang.text.ContentViewer.Title),e.xp6(3),e.Q6J("ngIf",i.HaveRelevances),e.xp6(1),e.Q6J("ngIf",i.HaveRelevances),e.xp6(1),e.Q6J("ngIf",i.HaveRelevances),e.xp6(7),e.Oqu(i.FileInfo.filename),e.xp6(1),e.Q6J("ngIf",i.isTextEditMode),e.xp6(1),e.Q6J("ngIf",i.isTextEditMode),e.xp6(1),e.Q6J("ngIf",i.HaveRelevances&&!i.isTextEditMode),e.xp6(1),e.Q6J("ngIf",!i.isTextEditMode),e.xp6(1),e.Q6J("ngIf",!i.isTextEditMode),e.xp6(2),e.Q6J("ngIf",!i.NeedDownloadFile),e.xp6(1),e.Q6J("ngIf",i.NeedDownloadFile),e.xp6(1),e.Q6J("initialBreakpoint",.5)("breakpoints",e.DdM(14,fe)))},directives:[f.Gu,f.sr,f.wd,f.Sm,f.oU,f.cs,A.O5,f.gu,f.Q$,f.W2,f.yh,f.YG,f.d8,f.q_,f.Ie,f.jY,f.Nd,f.wI,f.ki,f.rH,A.sg],styles:[".main_table_elt[_ngcontent-%COMP%]{width:100%;height:100%;border:0;margin:0}.relevance_change[_ngcontent-%COMP%]{width:25px;height:25px}"]}),s})()},549:(H,R,g)=>{g.d(R,{D:()=>N});var n=g(9863),f=g(5742),u=g(3996),F=g(4606),Y=g(9912),M=g(9808);function B(w,P){1&w&&n._UZ(0,"div",11)}function e(w,P){if(1&w&&n._UZ(0,"img",12),2&w){const h=n.oxw().$implicit;n.Akn("online"==h.status||3==h.redirect.type&&"pending"==h.status?"filter: grayscale(0) contrast(1)":"filter: grayscale(.9) contrast(1.4)"),n.Q6J("src",h.info.img,n.LSH)}}function V(w,P){if(1&w){const h=n.EpF();n.TgZ(0,"ion-item",3),n.NdJ("click",function(){const E=n.CHM(h).$implicit;return n.oxw().go_to_chatroom(E)}),n.TgZ(1,"div",4),n.YNc(2,B,1,0,"div",5),n.qZA(),n.TgZ(3,"div",6),n.YNc(4,e,1,3,"img",7),n.qZA(),n.TgZ(5,"ion-label")(6,"div",8)(7,"table")(8,"tr")(9,"td"),n._uU(10),n.qZA(),n.TgZ(11,"td",9),n._uU(12),n.qZA()()()(),n.TgZ(13,"div",10),n._uU(14),n.qZA()()()}if(2&w){const h=P.$implicit,T=n.oxw();n.xp6(1),n.Akn("background-color: "+T.statusBar.colors[h.status||"offline"]),n.xp6(1),n.Q6J("ngIf",h.is_new),n.xp6(2),n.Q6J("ngIf",h.info),n.xp6(6),n.hij(" ",h.info?h.info.name||h.info.display_name||T.lang.text.ChatRoom.noname_chatroom:h.title||T.lang.text.ChatRoom.noname_chatroom," "),n.xp6(2),n.hij(" ","("+h.server.target+")"," "),n.xp6(2),n.hij(" ",h.last_comment||h.noti||T.lang.text.Subscribes.noMessageHistory," ")}}let N=(()=>{class w{constructor(h,T,D,E,A){this.lang=h,this.navParams=T,this.modalCtrl=D,this.statusBar=E,this.nakama=A}ngOnInit(){this.channels=this.navParams.get("channels")}go_to_chatroom(h){this.nakama.go_to_chatroom_without_admob_act(h,this.navParams.get("file")),this.modalCtrl.dismiss(!0)}}return w.\u0275fac=function(h){return new(h||w)(n.Y36(f.b),n.Y36(u.X1),n.Y36(u.IN),n.Y36(F.g),n.Y36(Y.a))},w.\u0275cmp=n.Xpm({type:w,selectors:[["app-share-content-to-other"]],decls:11,vars:3,consts:[["slot","start",3,"click"],["defaultHref",""],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click"],[1,"additional_form","status_bar_double"],["class","new_circle",4,"ngIf"],[1,"additional_form","bg_img_form"],["class","profile_img",3,"style","src",4,"ngIf"],[1,"form_margin","header"],[1,"server_target"],[1,"form_margin","content"],[1,"new_circle"],[1,"profile_img",3,"src"]],template:function(h,T){1&h&&(n.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),n._uU(3),n.qZA(),n.TgZ(4,"ion-buttons",0),n.NdJ("click",function(){return T.modalCtrl.dismiss()}),n._UZ(5,"ion-back-button",1),n.qZA()()(),n.TgZ(6,"ion-content")(7,"ion-item-divider")(8,"ion-label"),n._uU(9),n.qZA()(),n.YNc(10,V,15,7,"ion-item",2),n.qZA()),2&h&&(n.xp6(3),n.Oqu(T.lang.text.ShareContentToOther.Title),n.xp6(6),n.Oqu(T.lang.text.ShareContentToOther.AvailableChannels),n.xp6(1),n.Q6J("ngForOf",T.channels))},directives:[u.Gu,u.sr,u.wd,u.Sm,u.oU,u.cs,u.W2,u.rH,u.Q$,M.sg,u.Ie,M.O5],styles:[".server_target[_ngcontent-%COMP%]{color:#888;padding-left:4px}.content[_ngcontent-%COMP%]{color:#888;height:24px;display:table-cell;vertical-align:middle;padding:0 16px}"]}),w})()}}]);