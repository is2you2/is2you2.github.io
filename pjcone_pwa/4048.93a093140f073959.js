"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4048],{4048:(B,T,l)=>{l.r(T),l.d(T,{CommunityPageModule:()=>R});var O=l(1368),D=l(4716),y=l(5624),G=l(3332),x=l(1528),n=l(340),v=l(416),t=l(4496),M=l(4180),w=l(7136),U=l(4500),L=l(5020),S=l(9240),$=l(4668);function F(a,f){if(1&a&&t.wR5(0,"img",17),2&a){const r=t.GaO().$implicit;t.m_g(r.isNSFW?"filter: blur(16px);":""),t.E7m("src",r.mainImage.thumbnail,t.K6U)}}function A(a,f){if(1&a&&(t.I0R(0,"span",18),t.OEk(1),t.C$Y()),2&a){const r=t.GaO().$implicit,o=t.GaO(2);t.yG2(),t.oRS(" ","("+(r.server?r.server.name||r.server.target:o.lang.text.AddGroup.UseLocalStorage)+")"," ")}}function P(a,f){if(1&a){const r=t.KQA();t.I0R(0,"ion-card",10),t.qCj("click",function(){const h=t.usT(r).$implicit,c=t.GaO(2);return t.CGJ(c.open_post(h))}),t.yuY(1,F,1,3,"img",11),t.I0R(2,"ion-card-header")(3,"ion-card-subtitle",12)(4,"span",13),t.qCj("click",function(){const h=t.usT(r).$implicit,c=t.GaO(2);return t.CGJ(c.open_profile(h))}),t.OEk(5),t.C$Y(),t.yuY(6,A,2,1,"span",14),t.C$Y(),t.I0R(7,"ion-card-title",15),t.OEk(8),t.C$Y()(),t.I0R(9,"ion-card-content",16),t.OEk(10),t.C$Y()()}if(2&a){const r=f.$implicit,o=t.GaO(2);t.E7m("id",r.id),t.yG2(),t.E7m("ngIf",r.mainImage),t.yG2(3),t.m_g("color: #"+r.UserColor),t.yG2(),t.oRS(" ",r.creator_name," "),t.yG2(),t.E7m("ngIf",o.nakama.showServer),t.yG2(2),t.cNF(r.title),t.yG2(2),t.oRS(" ",r.content," ")}}function E(a,f){if(1&a&&(t.I0R(0,"div",8),t.yuY(1,P,11,8,"ion-card",9),t.C$Y()),2&a){const r=t.GaO();t.yG2(),t.E7m("ngForOf",r.nakama.posts)}}function C(a,f){if(1&a&&(t.I0R(0,"div")(1,"div",19),t.wR5(2,"ion-icon",20),t.I0R(3,"div")(4,"ion-label",21),t.OEk(5),t.C$Y()()()()),2&a){const r=t.GaO();t.yG2(5),t.cNF(r.lang.text.Community.NoPosts)}}const m=[{path:"",component:(()=>{var a;class f{constructor(o,i,h,c,I,d,s){this.statusBar=o,this.nakama=i,this.lang=h,this.global=c,this.navCtrl=I,this.indexed=d,this.modalCtrl=s,this.is_loadable=!0,this.counter={local:{target:{me:0}},official:{},unofficial:{}},this.isOpenProfile=!1}ngOnInit(){var o=this;return(0,x.c)(function*(){o.nakama.is_post_lock=!0,o.nakama.posts.length||(yield o.load_posts_counter()),o.nakama.CommunityGoToEditPost=o.add_post})()}add_post(o){this.navCtrl.navigateForward("portal/community/add-post",{state:{data:o,act:!0}})}ionViewDidEnter(){this.try_add_shortcut(),this.ContentDiv&&this.ContentScroll&&this.ContentDiv.clientHeight-(this.ContentScroll.scrollTop+this.ContentScroll.clientHeight)<1&&this.load_post_cycles()}load_post_cycles(){var o=this;return(0,x.c)(function*(){o.is_loadable&&(yield o.load_posts()),setTimeout(()=>{o.ContentDiv||(o.ContentDiv=document.getElementById("CommunityMainContent")),o.ContentScroll||(o.ContentScroll=document.getElementById("CommunityScrollDiv"),o.ContentScroll.onscroll=i=>{o.ContentDiv.clientHeight-(o.ContentScroll.scrollTop+o.ContentScroll.clientHeight)<1&&o.load_post_cycles()}),o.is_loadable&&o.ContentDiv.clientHeight-(o.ContentScroll.scrollTop+o.ContentScroll.clientHeight)<1&&o.load_post_cycles()},50)})()}try_add_shortcut(){this.global.p5key&&this.global.p5key.KeyShortCut?this.AddShortcut():setTimeout(()=>{this.try_add_shortcut()},100)}load_posts_counter(){var o=this;return(0,x.c)(function*(){let i=Number(yield o.indexed.loadTextFromUserPath("servers/local/target/posts/counter.txt"))||0;o.counter.local.target.me=i;let h=o.nakama.get_all_server_info(!0,!0);for(let c=0,I=h.length;c<I;c++)o.counter[h[c].isOfficial][h[c].target]||(o.counter[h[c].isOfficial][h[c].target]={});o.load_post_cycles()})()}load_posts(){var o=this;return(0,x.c)(function*(){let i=!1,h=Object.keys(o.counter);for(let c=0,I=h.length;c<I;c++){let d=Object.keys(o.counter[h[c]]);for(let s=0,u=d.length;s<u;s++){let _=Object.keys(o.counter[h[c]][d[s]]);for(let p=0,k=_.length;p<k;p++){let b=o.counter[h[c]][d[s]][_[p]];!i&&b&&(i=!0),"local"==h[c]?yield o.load_local_post_step_by_step(b):(console.log(`\uc11c\ubc84 \uc5c5\ub370\uc774\ud2b8 \ud589\ub3d9 \uc5c6\uc74c: ${h[c]}/${d[s]}/${_[p]}`),o.load_server_user_post_step_by_step())}}}o.is_loadable=i,o.nakama.rearrange_posts()})()}load_local_post_step_by_step(o){var i=this;return(0,x.c)(function*(){let h=yield i.indexed.loadTextFromUserPath(`servers/local/target/posts/LocalPost_${o}/info.json`);if(h){let c=JSON.parse(h);if(c.mainImage)if(c.mainImage.url)c.mainImage.thumbnail=c.mainImage.url;else{let I=yield i.indexed.loadBlobFromUserPath(c.mainImage.path,c.mainImage.type);c.mainImage.blob=I;let d=URL.createObjectURL(I);c.mainImage.thumbnail=d,setTimeout(()=>{URL.revokeObjectURL(d)},100)}i.nakama.posts_orig.local.target.me[c.id]=c,i.counter.local.target.me--}else i.counter.local.target.me--,yield i.load_local_post_step_by_step(i.counter.local.target.me)})()}load_server_user_post_step_by_step(){}open_profile(o){this.isOpenProfile=!0,"local"==o.creator_id?this.modalCtrl.create({component:n.w}).then(i=>i.present()):console.log("\uc11c\ubc84 \uc791\uc131\uc790 \uac80\ud1a0: ",o),setTimeout(()=>{this.isOpenProfile=!1},0)}open_post(o){this.isOpenProfile||(this.isOpenProfile=!0,this.modalCtrl.create({component:v.S,componentProps:{data:o}}).then(i=>{delete this.global.p5key.KeyShortCut.Digit,delete this.global.p5key.KeyShortCut.AddAct,i.onDidDismiss().then(h=>{h.data||this.AddShortcut()}),i.present()}),setTimeout(()=>{this.isOpenProfile=!1},0))}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Digit=o=>{this.nakama.posts.length>o?this.open_post(this.nakama.posts[o]):this.add_post()}),this.global.p5key&&this.global.p5key.KeyShortCut&&!this.global.p5key.KeyShortCut.AddAct&&(this.global.p5key.KeyShortCut.AddAct=()=>{this.add_post()})}ionViewWillLeave(){delete this.global.p5key.KeyShortCut.Digit,delete this.global.p5key.KeyShortCut.AddAct,this.nakama.is_post_lock=!1}}return(a=f).\u0275fac=function(o){return new(o||a)(t.GI1(M.Y),t.GI1(w.h),t.GI1(U.o),t.GI1(L.A1),t.GI1(S.wX),t.GI1($.k),t.GI1(y.qS))},a.\u0275cmp=t.In1({type:a,selectors:[["app-community"]],decls:12,vars:5,consts:[[1,"ion-no-border"],[1,"add_post",3,"click"],["button","","name","add-circle-outline",2,"width","24px","height","24px"],[1,"header_online_circle",3,"click"],["id","CommunityScrollDiv",2,"height","100%","overflow-y","auto"],["id","CommunityMainContent"],["style","display: ruby-text",4,"ngIf"],[4,"ngIf"],[2,"display","ruby-text"],["button","","class","card_style",3,"id","click",4,"ngFor","ngForOf"],["button","",1,"card_style",3,"id","click"],["class","thumbnail_image","alt","",3,"src","style",4,"ngIf"],[1,"cardCreator"],[3,"click"],["class","server_target serverTargetOverride",4,"ngIf"],[1,"cardTitle"],[1,"cardContent"],["alt","",1,"thumbnail_image",3,"src"],[1,"server_target","serverTargetOverride"],[1,"disconnect_info"],["color","medium","name","document-text-outline",2,"width","60px","height","60px"],["color","medium"]],template:function(o,i){1&o&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t.OEk(3),t.C$Y(),t.I0R(4,"div",1),t.qCj("click",function(){return i.add_post()}),t.wR5(5,"ion-icon",2),t.C$Y(),t.I0R(6,"div",3),t.qCj("click",function(){return i.nakama.toggle_all_session(!0)}),t.C$Y()()(),t.I0R(7,"ion-content")(8,"div",4)(9,"div",5),t.yuY(10,E,2,1,"div",6)(11,C,6,1,"div",7),t.C$Y()()()),2&o&&(t.yG2(3),t.cNF(i.lang.text.Community.Title),t.yG2(3),t.m_g("background-color: "+i.statusBar.colors[i.statusBar.settings.groupServer]+"; cursor: pointer;"),t.yG2(4),t.E7m("ngIf",i.nakama.posts.length),t.yG2(),t.E7m("ngIf",!i.nakama.posts.length))},dependencies:[O.ay,O.u_,y.KC,y.Gg,y.YY,y.MN,y.I7,y._i,y.wB,y.Ko,y.QR,y.tM,y.Md],styles:[".md[_ngcontent-%COMP%]   .add_post[_ngcontent-%COMP%]{position:absolute;right:68px;top:16px;cursor:pointer}.ios[_ngcontent-%COMP%]   .add_post[_ngcontent-%COMP%]{position:absolute;right:68px;top:10px;cursor:pointer}.card_style[_ngcontent-%COMP%]{width:400px}.cardCreator[_ngcontent-%COMP%]{width:-moz-fit-content;width:fit-content;font-weight:700;max-height:20px;overflow-y:hidden}.serverTargetOverride[_ngcontent-%COMP%]{font-weight:400}.cardTitle[_ngcontent-%COMP%]{max-height:24px;overflow-y:hidden}.cardContent[_ngcontent-%COMP%]{max-height:40px;overflow-y:hidden;padding-bottom:0;margin-bottom:13px}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover}"]}),f})()},{path:"add-post",loadChildren:()=>l.e(1592).then(l.bind(l,1592)).then(a=>a.AddPostPageModule)},{path:"post-viewer",loadChildren:()=>l.e(9368).then(l.bind(l,9368)).then(a=>a.PostViewerPageModule)}];let g=(()=>{var a;class f{}return(a=f).\u0275fac=function(o){return new(o||a)},a.\u0275mod=t.a4G({type:a}),a.\u0275inj=t.s3X({imports:[G.qQ.forChild(m),G.qQ]}),f})(),R=(()=>{var a;class f{}return(a=f).\u0275fac=function(o){return new(o||a)},a.\u0275mod=t.a4G({type:a}),a.\u0275inj=t.s3X({imports:[O.MD,D.y,y.wZ,g]}),f})()},416:(B,T,l)=>{l.d(T,{S:()=>A});var O=l(1528),D=l(9352),G=l(8744),x=l(340),n=l(4496),v=l(5624),t=l(9240),M=l(4500),w=l(4668),U=l(7136),L=l(5020),S=l(1368);function $(P,E){if(1&P&&n.wR5(0,"img",7),2&P){const C=n.GaO();n.E7m("src",C.PostInfo.mainImage.MainThumbnail,n.K6U)}}function F(P,E){if(1&P){const C=n.KQA();n.I0R(0,"ion-footer")(1,"table",8)(2,"tr")(3,"td")(4,"ion-button",9),n.qCj("click",function(){n.usT(C);const m=n.GaO();return n.CGJ(m.EditPost())}),n.OEk(5),n.C$Y()(),n.I0R(6,"td")(7,"ion-button",10),n.qCj("click",function(){n.usT(C);const m=n.GaO();return n.CGJ(m.RemovePost())}),n.OEk(8),n.C$Y()()()()()}if(2&P){const C=n.GaO();n.yG2(5),n.oRS(" ",C.lang.text.AddPost.EditTitle," "),n.yG2(3),n.oRS(" ",C.lang.text.PostViewer.RemovePost," ")}}let A=(()=>{var P;class E{constructor(e,m,g,R,a,f,r){this.modalCtrl=e,this.navParam=m,this.lang=g,this.indexed=R,this.nakama=a,this.alertCtrl=f,this.global=r,this.isOwner=!1,this.FileURLs=[]}ngOnInit(){if(this.PostInfo=this.navParam.get("data"),this.PostInfo.mainImage){let e=URL.createObjectURL(this.PostInfo.mainImage.blob);this.PostInfo.mainImage.MainThumbnail=e,this.FileURLs.push(e)}this.create_content(),this.isOwner="local"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id}create_content(){var e=this;let m=document.getElementById("PostContent");this.p5canvas=new D(g=>{g.setup=(0,O.c)(function*(){g.noCanvas();let R=g.createDiv(e.PostInfo.title);R.style("font-size","32px"),R.style("font-weight","bold"),R.parent(m);let a=g.createDiv();a.style("color","#888"),a.parent(m),g.createDiv(`${e.lang.text.PostViewer.CreateTime}: ${new Date(e.PostInfo.create_time).toLocaleString()}`).parent(a),e.PostInfo.create_time!=e.PostInfo.modify_time&&g.createDiv(`${e.lang.text.PostViewer.ModifyTime}: ${new Date(e.PostInfo.modify_time).toLocaleString()}`).parent(a);let r=g.createSpan(e.PostInfo.creator_name);r.style("color",`#${e.PostInfo.UserColor}`),r.style("font-weight","bold"),r.style("padding-bottom","16px"),r.style("cursor","pointer"),r.elt.onclick=()=>{e.isOwner&&e.modalCtrl.create({component:x.w}).then(o=>o.present())},r.parent(m);for(let o=0,i=e.PostInfo.attachments.length;o<i;o++){let h=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[o].path,e.PostInfo.attachments[o].type);e.PostInfo.attachments[o].blob=h}if(e.PostInfo.content){let o=e.PostInfo.content.split("\n");for(let i=0,h=o.length;i<h;i++){let c=!1,I=o[i].length-1,d=0;try{d=Number(o[i].substring(1,I)),c="["==o[i].charAt(0)&&"]"==o[i].charAt(I)&&!isNaN(d)}catch{}if(c)switch(e.PostInfo.attachments[d].viewer){case"image":{let s=e.PostInfo.attachments[d].url;if(!s)try{s=URL.createObjectURL(e.PostInfo.attachments[d].blob),e.FileURLs.push(s)}catch(_){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",_)}let u=g.createImg(s,`${d}`);u.style("cursor","pointer"),u.elt.onclick=()=>{let _=[];for(let p=0,k=e.PostInfo.attachments.length;p<k;p++)_.push({content:e.PostInfo.attachments[p]});e.modalCtrl.create({component:G.K,componentProps:{info:{content:e.PostInfo.attachments[d]},path:e.PostInfo.attachments[d].path,relevance:_,noEdit:!0},cssClass:"fullscreen"}).then(p=>p.present())},u.parent(m)}break;case"audio":{let s=e.PostInfo.attachments[d].url;if(!s)try{s=URL.createObjectURL(e.PostInfo.attachments[i].blob),e.FileURLs.push(s)}catch(_){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",_)}let u=g.createAudio([s]);u.showControls(),u.parent(m)}break;case"video":{let s=e.PostInfo.attachments[d].url;if(!s)try{s=URL.createObjectURL(e.PostInfo.attachments[i].blob),e.FileURLs.push(s)}catch(_){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",_)}let u=g.createVideo([s]);u.style("width","100%"),u.style("height","auto"),u.showControls(),u.parent(m)}break;case"godot":{let s=`PostViewer_godot_pck_${d}`,u=g.createDiv();u.id(s),u.style("width","100%"),u.style("height","432px"),u.parent(m),setTimeout((0,O.c)(function*(){let _=!1;if(e.indexed.godotDB)try{yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(e.PostInfo.attachments[i].blob,`tmp_files/duplicate/${e.PostInfo.attachments[d].filename}`,void 0,e.indexed.godotDB),_=!0}catch(p){console.log("\ub0b4\ubd80 \ud30c\uc77c \uc5c6\uc74c: ",p)}if(yield e.global.CreateGodotIFrame(s,{path:`tmp_files/duplicate/${e.PostInfo.attachments[d].filename}`,url:e.PostInfo.attachments[d].url},"start_load_pck"),!_){try{let p=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[d].path,"",void 0,e.indexed.ionicDB);yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(p,`tmp_files/duplicate/${e.PostInfo.attachments[d].filename}`,void 0,e.indexed.godotDB)}catch{}yield e.global.CreateGodotIFrame(s,{path:`tmp_files/duplicate/${e.PostInfo.attachments[d].filename}`,url:e.PostInfo.attachments[d].url},"start_load_pck")}e.PostInfo.attachments[d].url?e.global.godot_window.download_url():e.global.godot_window.start_load_pck()}),100)}break;default:{let s=g.createDiv();s.style("width","160px"),s.style("height","112px"),s.style("overflow","hidden"),s.style("background-color","grey"),s.style("margin-top","4px"),s.style("border-radius","8px"),s.style("cursor","pointer"),s.parent(m);let u=g.createP(e.PostInfo.attachments[d].filename);u.style("margin","0px 4px"),u.style("text-align","start"),u.parent(s);let _=g.createDiv();_.style("background-color","white"),_.style("margin-top","2px"),_.style("position","relative"),_.style("width","100%"),_.style("height","2px"),_.parent(s);let p=g.createSpan(e.lang.text.PostViewer.OpenFromViewer);p.style("margin","2px 4px 0px 4px"),p.style("text-align","start"),p.style("display","grid"),p.parent(s),s.elt.onclick=()=>{let k=[];for(let b=0,j=e.PostInfo.attachments.length;b<j;b++)k.push({content:e.PostInfo.attachments[b]});e.modalCtrl.create({component:G.K,componentProps:{info:{content:e.PostInfo.attachments[d]},path:e.PostInfo.attachments[d].path,relevance:k,noEdit:!0},cssClass:"fullscreen"}).then(b=>b.present())}}}else g.createDiv(o[i]+"&nbsp").parent(m)}}})})}EditPost(){this.modalCtrl.dismiss({edit:!0}),this.nakama.EditPost(this.PostInfo)}RemovePost(){var m,e=this;this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.TodoDetail.remove,cssClass:"redfont",handler:(m=(0,O.c)(function*(){yield e.nakama.RemovePost(e.PostInfo),e.modalCtrl.dismiss()}),function(){return m.apply(this,arguments)})}]}).then(m=>m.present())}ionViewDidLeave(){this.p5canvas&&this.p5canvas.remove();for(let e=0,m=this.FileURLs.length;e<m;e++)URL.revokeObjectURL(this.FileURLs[e])}}return(P=E).\u0275fac=function(e){return new(e||P)(n.GI1(v.qS),n.GI1(t.a6),n.GI1(M.o),n.GI1(w.k),n.GI1(U.h),n.GI1(v.iW),n.GI1(L.A1))},P.\u0275cmp=n.In1({type:P,selectors:[["app-post-viewer"]],decls:10,vars:5,consts:[[3,"translucent"],["slot","start",3,"click"],["defaultHref",""],[3,"fullscreen"],["style","width: 100%; height: auto;","alt","MainImage",3,"src",4,"ngIf"],["id","PostContent",2,"padding","16px"],[4,"ngIf"],["alt","MainImage",2,"width","100%","height","auto",3,"src"],[2,"width","100%","background-color","black"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"]],template:function(e,m){1&e&&(n.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),n.OEk(3),n.C$Y(),n.I0R(4,"ion-buttons",1),n.qCj("click",function(){return m.modalCtrl.dismiss()}),n.wR5(5,"ion-back-button",2),n.C$Y()()(),n.I0R(6,"ion-content",3),n.yuY(7,$,1,1,"img",4),n.wR5(8,"div",5),n.C$Y(),n.yuY(9,F,9,2,"ion-footer",6)),2&e&&(n.E7m("translucent",!0),n.yG2(3),n.cNF(m.lang.text.PostViewer.Title),n.yG2(3),n.E7m("fullscreen",!0),n.yG2(),n.E7m("ngIf",m.PostInfo.mainImage&&m.PostInfo.mainImage.MainThumbnail),n.yG2(2),n.E7m("ngIf",m.isOwner))},dependencies:[S.u_,v.sn,v.GS,v._i,v.eV,v.wB,v.tM,v.Md,v.Im]}),E})()}}]);