"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1592],{1592:(de,D,h)=>{h.r(D),h.d(D,{AddPostPageModule:()=>oe});var T=h(1368),$=h(4716),y=h(5624),R=h(3332),I=h(1528),N=h(5020),G=h(7136),U=h(340),O=h(4120),E=h(8372),w=h(4712),L=h(2272),M=h(3664),B=h(9352),j=h(5193),t=h(4496),V=h(4500),Y=h(9240),K=h(3824),z=h(4668),W=h(4476),H=h(7756);function J(d,f){if(1&d&&(t.I0R(0,"ion-title"),t.OEk(1),t.C$Y()),2&d){const c=t.GaO();t.yG2(),t.cNF(c.lang.text.AddPost.EditTitle)}}function Q(d,f){if(1&d&&(t.I0R(0,"ion-title"),t.OEk(1),t.C$Y()),2&d){const c=t.GaO();t.yG2(),t.cNF(c.lang.text.AddPost.Title)}}function X(d,f){if(1&d){const c=t.KQA();t.I0R(0,"ion-item",7),t.qCj("click",function(){const a=t.usT(c).index,s=t.GaO(2);return t.CGJ(s.select_server(a,!0))}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&d){const c=f.$implicit;t.yG2(2),t.cNF(c.name)}}function Z(d,f){if(1&d){const c=t.KQA();t.I0R(0,"ion-accordion-group",21,22),t.qCj("click",function(){t.usT(c);const i=t.GaO();return t.CGJ(i.isExpanded=!0)}),t.I0R(2,"ion-accordion",23)(3,"ion-item",24)(4,"ion-label"),t.OEk(5),t.C$Y(),t.I0R(6,"ion-label",25),t.OEk(7),t.C$Y(),t.wR5(8,"ion-icon",26),t.C$Y(),t.I0R(9,"div",27),t.yuY(10,X,3,1,"ion-item",28),t.C$Y()()()}if(2&d){const c=t.GaO();t.E7m("disabled",c.isSaveClicked)("value",c.isExpanded),t.yG2(5),t.cNF(c.lang.text.AddGroup.SelectServer),t.yG2(2),t.cNF(c.servers[c.index].name),t.yG2(3),t.E7m("ngForOf",c.servers)}}function q(d,f){if(1&d){const c=t.KQA();t.I0R(0,"div",29)(1,"ion-item",11)(2,"ion-toggle",30),t.iHE("ngModelChange",function(i){t.usT(c);const a=t.GaO();return t.kNx(a.userInput.isNSFW,i)||(a.userInput.isNSFW=i),t.CGJ(i)}),t.OEk(3),t.C$Y()(),t.I0R(4,"div",31),t.wR5(5,"img",32),t.C$Y()()}if(2&d){const c=t.GaO();t.yG2(2),t.OKB("ngModel",c.userInput.isNSFW),t.yG2(),t.cNF(c.lang.text.AddPost.NSFW),t.yG2(2),t.m_g(c.userInput.isNSFW?"filter: blur(16px);":""),t.E7m("src",c.MainPostImage,t.K6U)}}function ee(d,f){if(1&d&&t.wR5(0,"ion-icon",37),2&d){const c=t.GaO().$implicit;t.E7m("name",c.icon||"close-circle")}}function te(d,f){if(1&d&&t.wR5(0,"img",38),2&d){const c=t.GaO().$implicit;t.E7m("src","assets/icon/"+c.icon_img,t.K6U)("alt",c.title)}}function ie(d,f){if(1&d){const c=t.KQA();t.I0R(0,"div",33)(1,"div",34),t.qCj("click",function(){const a=t.usT(c).$implicit;return t.CGJ(a.act())}),t.yuY(2,ee,1,1,"ion-icon",35)(3,te,1,2,"img",36),t.I0R(4,"div"),t.OEk(5),t.C$Y()()()}if(2&d){const c=f.$implicit;t.yG2(),t.m_g("cursor: "+(c.cursor||"pointer")+";"),t.E7m("hidden",c.isHide),t.yG2(),t.E7m("ngIf",c.icon),t.yG2(),t.E7m("ngIf",c.icon_img),t.yG2(2),t.cNF(c.name)}}function ae(d,f){if(1&d){const c=t.KQA();t.I0R(0,"ion-item",39),t.qCj("click",function(){const i=t.usT(c),a=i.$implicit,s=i.index,o=t.GaO();return t.CGJ(o.open_viewer(a,s))})("contextmenu",function(){const a=t.usT(c).index,s=t.GaO();return t.CGJ(s.PostAttachContextMenu(a))}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"div",40),t.wR5(4,"img",41),t.C$Y()()}if(2&d){const c=f.$implicit,e=f.index,i=t.GaO();t.E7m("disabled",i.isSaveClicked),t.yG2(2),t.cNF("["+e+"] "+c.filename),t.yG2(2),t.E7m("src",c.thumbnail,t.K6U)}}const se=[{path:"",component:(()=>{var d;class f{constructor(e,i,a,s,o,n,l,p,r,m,C,P){var v,u=this;this.global=e,this.lang=i,this.navCtrl=a,this.nakama=s,this.modalCtrl=o,this.p5toast=n,this.indexed=l,this.loadingCtrl=p,this.sanitizer=r,this.mClipboard=m,this.route=C,this.router=P,this.servers=[],this.userInput={id:void 0,title:void 0,content:void 0,creator_id:void 0,creator_name:void 0,UserColor:void 0,create_time:void 0,modify_time:void 0,server:void 0,mainImage:void 0,attachments:[],isNSFW:!1},this.index=0,this.BackButtonPressed=!1,this.isModify=!1,this.isExpanded=!1,this.isSaveClicked=!1,this.isServerChanged=!1,this.useVoiceRecording=!1,this.MainPostImage=void 0,this.extended_buttons=[{icon:"image-outline",name:this.lang.text.AddPost.MainPostImage,act:()=>{this.isSaveClicked||(this.MainPostImage?(URL.revokeObjectURL(this.MainPostImage),this.MainPostImage=void 0,this.userInput.mainImage=void 0,document.getElementById("PostMainImage_sel").value=""):document.getElementById("PostMainImage_sel").click())}},{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(v=(0,I.c)(function*(){if(!u.isSaveClicked)try{return void(yield u.new_attach({detail:{value:"link"}}))}catch(g){"done"!=g&&u.new_attach({detail:{value:"load"}})}}),function(){return v.apply(this,arguments)})},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:function(){var v=(0,I.c)(function*(){u.isSaveClicked||u.modalCtrl.create({component:E.S,componentProps:{},cssClass:"fullscreen"}).then(_=>{_.onWillDismiss().then(function(){var S=(0,I.c)(function*(k){k.data&&(u.AddAttachTextForm(),yield u.voidDraw_fileAct_callback(k,void 0))});return function(k){return S.apply(this,arguments)}}()),_.onDidDismiss().then(()=>{u.AddShortcut()}),delete u.global.p5key.KeyShortCut.Escape,_.present()})});return function(){return v.apply(this,arguments)}}()},{icon:"reader-outline",name:this.lang.text.ChatRoom.newText,act:function(){var v=(0,I.c)(function*(){let g={info:{content:{is_new:void 0,type:"text/plain",viewer:"text",filename:void 0,path:void 0}},no_edit:void 0},x=new Date,_=x.getUTCFullYear(),S=("0"+(x.getMonth()+1)).slice(-2),k=("0"+x.getDate()).slice(-2),re=("0"+x.getHours()).slice(-2),le=("0"+x.getMinutes()).slice(-2),ce=("0"+x.getSeconds()).slice(-2);g.info.content.is_new="text",g.info.content.filename=`texteditor_${_}-${S}-${k}_${re}-${le}-${ce}.txt`,g.no_edit=!0,u.modalCtrl.create({component:M.K,componentProps:g}).then(F=>{F.onWillDismiss().then(A=>{if(A.data){let b={};b.content_creator={timestamp:(new Date).getTime(),display_name:u.nakama.users.self.display_name,various:"textedit"},b.content_related_creator=[],b.content_related_creator.push(b.content_creator),b.blob=A.data.blob,b.path=A.data.path,b.size=A.data.blob.size,b.filename=A.data.blob.name||g.info.content.filename,b.file_ext=b.filename.split(".").pop(),b.type="text/plain",b.viewer="text",u.userInput.attachments.push(b)}}),F.onDidDismiss().then(()=>{u.AddShortcut()}),delete u.global.p5key.KeyShortCut.Escape,F.present()})});return function(){return v.apply(this,arguments)}}()},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:function(){var v=(0,I.c)(function*(){if(!u.isSaveClicked)try{const g=yield O.Ut.getPhoto({quality:90,resultType:O.on.Base64,source:O._8.Camera});let x=yield u.loadingCtrl.create({message:u.lang.text.TodoDetail.WIP});x.present();let _={};_.filename=`Camera_${(new Date).toLocaleString().replace(/:/g,"_")}.${g.format}`,_.file_ext=g.format,_.thumbnail=u.sanitizer.bypassSecurityTrustUrl("data:image/jpeg;base64,"+g.base64String),_.type=`image/${g.format}`,_.typeheader="image",_.content_related_creator=[{user_id:"local"==u.servers[u.index].isOfficial?"local":u.nakama.servers[u.isOfficial][u.target].session.user_id,timestamp:(new Date).getTime(),display_name:u.nakama.users.self.display_name,various:"camera"}],_.content_creator={user_id:"local"==u.servers[u.index].isOfficial?"local":u.nakama.servers[u.isOfficial][u.target].session.user_id,timestamp:(new Date).getTime(),display_name:u.nakama.users.self.display_name,various:"camera"},_.viewer="image",_.path=`tmp_files/post/${_.filename}`,yield u.indexed.saveBase64ToUserPath("data:image/jpeg;base64,"+g.base64String,_.path,k=>{_.blob=new Blob([k],{type:_.type})}),u.AddAttachTextForm(),u.userInput.attachments.push(_),x.dismiss()}catch{}});return function(){return v.apply(this,arguments)}}()},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var v=(0,I.c)(function*(){u.isSaveClicked||(u.useVoiceRecording=!u.useVoiceRecording,u.useVoiceRecording?(yield w.G.hasAudioRecordingPermission()).value?(u.extended_buttons[5].icon="stop-circle-outline",u.p5toast.show({text:u.lang.text.ChatRoom.StartVRecord}),u.p5canvas.StartVoiceTimer(),yield w.G.startRecording(),u.CreateFloatingVoiceTimeHistoryAddButton()):(u.useVoiceRecording=!1,u.extended_buttons[5].icon="mic-circle-outline",yield w.G.requestAudioRecordingPermission()):yield u.StopAndSaveVoiceRecording())});return function(){return v.apply(this,arguments)}}()},{icon:"cloud-done-outline",name:this.lang.text.ChatRoom.Detour,act:()=>{this.toggle_custom_attach()}}],this.lock_modal_open=!1,this.useFirstCustomCDN=0,this.isApplyPostData=!1}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),delete this.nakama.StatusBarChangedCallback,this.useVoiceRecording&&this.StopAndSaveVoiceRecording();try{this.MainPostImage&&setTimeout(()=>{URL.revokeObjectURL(this.MainPostImage)},1e3)}catch{}}ngOnInit(){var e=this;this.useFirstCustomCDN=Number(localStorage.getItem("useFFSCDN"))||0,this.toggle_custom_attach(this.useFirstCustomCDN),this.route.queryParams.subscribe(function(){var i=(0,I.c)(function*(a){const s=e.router.getCurrentNavigation().extras.state;let o=!1;if(s&&(o=!!s.act,s.data&&(e.userInput=s.data)),o){if(e.LoadListServer(),s&&s.data){let n=`${e.userInput.server.isOfficial}/${e.userInput.server.target}`;for(let l=0,p=e.servers.length;l<p;l++)if(`${e.servers[l].isOfficial}/${e.servers[l].target}`==n){e.index=l;break}if(e.userInput.mainImage){let l=e.userInput.mainImage.url;l||(l=URL.createObjectURL(e.userInput.mainImage.blob)),e.MainPostImage=l}for(let l=0,p=e.userInput.attachments.length;l<p;l++)if("image"==e.userInput.attachments[l].viewer)if(e.userInput.attachments[l].url)e.userInput.attachments[l].thumbnail=e.userInput.attachments[l].url;else{let r=yield e.indexed.loadBlobFromUserPath(e.userInput.attachments[l].path,e.userInput.attachments[l].file_ext),m=URL.createObjectURL(r);e.userInput.attachments[l].thumbnail=m,setTimeout(()=>{URL.revokeObjectURL(m)},1e3)}}e.select_server(e.index),s&&s.data&&(e.OriginalInfo=JSON.parse(JSON.stringify(e.userInput)))}});return function(a){return i.apply(this,arguments)}}()),this.CreateDrop(),this.nakama.StatusBarChangedCallback=()=>{this.LoadListServer(),this.index=0}}InitBrowserBackButtonOverride(){window.history.pushState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.navCtrl.back())}}LoadListServer(){this.servers=this.nakama.get_all_server_info(!0,!0),this.servers.unshift({name:this.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0})}CreateDrop(){var e=this;let i=document.getElementById("p5Drop_addPost");this.p5canvas||(this.p5canvas=new B(a=>{let s=0;a.setup=()=>{let n=a.createCanvas(i.clientWidth,i.clientHeight);n.parent(i),a.pixelDensity(.1),n.drop(function(){var l=(0,I.c)(function*(p){yield e.selected_blobFile_callback_act(p.file)});return function(p){return l.apply(this,arguments)}}()),a.noLoop(),a.StartVoiceTimer=()=>{a.loop(),s=a.millis()},a.StopVoiceTimer=()=>{a.noLoop()}},a.draw=()=>{this.useVoiceRecording&&(this.extended_buttons[5].name=o(a.millis()-s))};let o=n=>{let l=n/1e3,p=a.floor(l)%60,r=l/60,m=a.floor(r)%60,C=a.floor(r/60);return C?`${C}:${m}:${a.nf(p,2)}`:`${m}:${a.nf(p,2)}`};a.mouseMoved=n=>{n.dataTransfer?(i.style.pointerEvents="all",i.style.backgroundColor="#0008"):(i.style.pointerEvents="none",i.style.backgroundColor="transparent")},a.keyPressed=n=>{"Enter"===n.code&&"exact_post_title_id"==document.activeElement.id&&this.postData()}}))}catchBottomTabShortCut(){this.BottomTabShortcut=this.global.p5key.KeyShortCut.BottomTab,delete this.global.p5key.KeyShortCut.BottomTab}ionViewWillEnter(){this.AddShortcut(),this.catchBottomTabShortCut(),this.TitleInput=document.getElementById("add_post_title").childNodes[1].childNodes[1].childNodes[1],this.TitleInput.id="exact_post_title_id",this.TitleInput.onpaste=e=>{let i=[];for(const a of e.clipboardData.files)a.type.startsWith("image/png")&&i.push({file:a});if(i.length)return 1==i.length&&this.ChangeMainPostImage({target:{files:[i[0].file]}}),!1},this.ContentTextArea=document.getElementById("add_post_content"),setTimeout(()=>{this.userInput.title?this.ContentTextArea.focus():this.TitleInput.focus()},200),this.ContentTextArea.onpaste=e=>{let i=[];for(const a of e.clipboardData.files)a.type.startsWith("image/")&&i.push({file:a});if(i.length){if(1==i.length)this.selected_blobFile_callback_act(i[0].file);else for(let a=0,s=i.length;a<s;a++)this.selected_blobFile_callback_act(i[a].file);return!1}},this.isModify=!!this.userInput.id,this.InitBrowserBackButtonOverride()}go_to_profile(){this.modalCtrl.create({component:U.w,componentProps:{isOfficial:this.isOfficial,target:this.target}}).then(e=>e.present())}select_server(e,i=!1){this.index=e,this.userInput.server=this.servers[e],this.isExpanded=!1,this.isOfficial=this.servers[e].isOfficial,this.target=this.servers[e].target,i?this.isServerChanged=this.OriginalServerInfo!=`${this.isOfficial}/${this.target}`:this.OriginalServerInfo=`${this.isOfficial}/${this.target}`,this.userInput.creator_name=this.nakama.users.self.display_name;try{this.userInput.creator_id=this.nakama.servers[this.isOfficial][this.target].session.user_id,this.userInput.UserColor=(this.userInput.creator_id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6)}catch{this.userInput.creator_id="me",this.userInput.UserColor="888888"}}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.navigateBack("portal/community")})}AddVoiceTimeHistory(){this.userInput.content?this.userInput.content+=`\n{"i":"n","t":"${this.extended_buttons[5].name}"}\n`:this.userInput.content=`{"i":"n","t":"${this.extended_buttons[5].name}"}\n`,this.ContentTextArea.focus()}CreateFloatingVoiceTimeHistoryAddButton(){this.p5floatingButton&&this.p5floatingButton.remove(),this.p5floatingButton=new B(e=>{e.setup=()=>{e.noCanvas();let i=e.createDiv('<ion-icon style="width: 36px; height: 36px" name="timer-outline"></ion-icon>');i.style("position: absolute; right: 0; bottom: 56px; z-index: 1"),i.style("width: 64px; height: 64px"),i.style("text-align: center; align-content: center"),i.style("cursor: pointer"),i.style("margin: 16px"),i.style("padding-top: 6px"),i.style("background-color: #8888"),i.style("border-radius: 24px"),i.elt.onclick=()=>{this.AddVoiceTimeHistory(),this.p5toast.show({text:`${this.lang.text.AddPost.RecordVoiceTime}: ${this.extended_buttons[5].name}`})}}})}StopAndSaveVoiceRecording(){var e=this;return(0,I.c)(function*(){e.p5floatingButton&&e.p5floatingButton.remove();let i=yield e.loadingCtrl.create({message:e.lang.text.AddPost.SavingRecord});i.present();try{let a=yield w.G.stopRecording(),s=e.global.Base64ToBlob(`${a.value.mimeType},${a.value.recordDataBase64}`);s.name=`${e.lang.text.ChatRoom.VoiceRecord}.${a.value.mimeType.split("/").pop().split(";")[0]}`,s.type_override=a.value.mimeType,yield e.selected_blobFile_callback_act(s),i.dismiss()}catch(a){e.p5toast.show({text:`${e.lang.text.AddPost.FailedToSaveVoice}:${a}`}),i.dismiss()}e.extended_buttons[5].icon="mic-circle-outline",e.extended_buttons[5].name=e.lang.text.ChatRoom.Voice,e.checkVoiceLinker()})()}checkVoiceLinker(){this.p5canvas.StopVoiceTimer();let e=this.userInput.content.split("\n");for(let i=0,a=e.length;i<a;i++)try{let s=JSON.parse(e[i]);"n"==s.i&&(s.i=this.userInput.attachments.length-1),e[i]=JSON.stringify(s)}catch{}this.userInput.content=e.join("\n")}ChangeMainPostImage(e){let i=e.target.files[0],a={};a.filename=i.name,a.file_ext=i.name.split(".").pop()||i.type||this.lang.text.ChatRoom.unknown_ext,a.size=i.size,a.type=i.type||i.type_override,a.blob=i,a.path=`tmp_files/post/MainImage.${a.file_ext}`,this.userInput.mainImage=a;let s=URL.createObjectURL(i);this.indexed.saveBlobToUserPath(i,a.path),this.MainPostImage=s}selected_blobFile_callback_act(e,i=[],a="loaded",s,o){var n=this;return(0,I.c)(function*(){let l={};l.filename=e.name,l.file_ext=e.name.split(".").pop()||e.type||n.lang.text.ChatRoom.unknown_ext,l.size=e.size,l.type=e.type||e.type_override,s&&(l.path=s),l.content_related_creator=[...i,{user_id:"local"==n.servers[n.index].isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:a}],l.content_creator={user_id:"local"==n.servers[n.index].isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:a},l.blob=e,l.path=`tmp_files/post/${l.filename}_${n.userInput.attachments.length}.${l.file_ext}`,n.create_selected_thumbnail(l),void 0===o?(n.AddAttachTextForm(),n.userInput.attachments.push(l)):n.userInput.attachments[o]=l,n.indexed.saveBlobToUserPath(l.blob,l.path)})()}AddAttachTextForm(){this.userInput.content?this.userInput.content+=`\n[${this.userInput.attachments.length}]\n`:this.userInput.content=`[${this.userInput.attachments.length}]\n`}create_selected_thumbnail(e){var i=this;return(0,I.c)(function*(){if(i.global.set_viewer_category_from_ext(e),e.url){try{(yield fetch(e.url)).ok&&(e.thumbnail=e.url)}catch{}return void(e.typeheader=e.viewer)}try{e.thumbnail=yield i.indexed.loadBlobFromUserPath(e.path,e.type)}catch{}let a=URL.createObjectURL(e.blob);"image"===(e.typeheader=e.blob.type.split("/")[0]||e.viewer,setTimeout(()=>{URL.revokeObjectURL(a)},0),e.thumbnail=void 0,e.typeheader)&&(e.thumbnail=i.sanitizer.bypassSecurityTrustUrl(a))})()}voidDraw_fileAct_callback(e,i,a){var s=this;return(0,I.c)(function*(){let o={};void 0!==a?s.userInput.attachments[a]=o:s.userInput.attachments.push(o);try{o.filename=e.data.name,o.file_ext="png",o.thumbnail=s.sanitizer.bypassSecurityTrustUrl(e.data.img),o.type="image/png",o.typeheader="image",i?(o.content_related_creator=i,o.content_creator={user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:"voidDraw"}):(o.content_related_creator=[{user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:"voidDraw"}],o.content_creator={user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:"voidDraw"}),o.path=`tmp_files/post/${o.filename}`,o.viewer="image",yield s.indexed.saveBase64ToUserPath(e.data.img,o.path,n=>{o.blob=new Blob([n],{type:o.type})})}catch(n){console.error("godot-\uc774\ubbf8\uc9c0 \ud3b8\uc9d1 \uc0ac\uc6a9 \ubd88\uac00: ",n)}e.data.loadingCtrl.dismiss()})()}new_attach(e,i=void 0){var a=this;return(0,I.c)(function*(){let s;switch(void 0===i&&(i={}),e.detail.value){case"load":document.getElementById("add_post_input").click();break;case"link":try{let o=i.url;if(void 0===o)try{o=yield a.mClipboard.paste()}catch{try{o=yield L.c.read()}catch(r){throw r}}try{let p=a.global.Base64ToBlob(o),r=o.split(";")[0].split(":")[1];throw s=new File([p],`${a.lang.text.ChatRoom.FileLink}.${r.split("/").pop()}`,{type:r}),yield a.selected_blobFile_callback_act(s),"done"}catch(p){if("done"===p)throw p}try{if(s&&void 0===i.filename)throw"\uc774\ubbf8 \ud30c\uc77c\uc774 \ucca8\ubd80\ub428, \ud1a0\uae00\ub9cc \uc2dc\ub3c4";if(!(yield fetch(o)).ok)throw"URL \uad6c\uc870\uac00 \uc815\uc0c1\uc774 \uc544\ub2d8"}catch(p){throw p}let n={};n.url=o,n.content_related_creator=[],i&&i.content_related_creator&&(n.content_related_creator=[...i.content_related_creator]),n.content_related_creator.push({user_id:"local"==a.servers[a.index].isOfficial?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,timestamp:(new Date).getTime(),display_name:a.nakama.users.self.display_name,various:i.url?"shared":"link"}),n.content_creator={user_id:"local"==a.servers[a.index].isOfficial?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,timestamp:(new Date).getTime(),display_name:a.nakama.users.self.display_name,various:i.url?"shared":"link"};let l=n.url.split(".");n.file_ext=i.file_ext||l.pop().split("?").shift(),n.filename=i.filename||decodeURIComponent(`${l.pop().split("/").pop()||a.lang.text.ChatRoom.ExternalLinkFile}.${n.file_ext}`),a.global.set_viewer_category_from_ext(n),n.type=i.type||"",n.typeheader=i.typeheader||n.viewer,a.global.modulate_thumbnail(n,n.url),a.userInput.attachments.push(n)}catch(o){throw"done"==o?o:`\uc778\uc2dd \ubd88\uac00\ub2a5\ud55c URL \uc815\ubcf4: ${o}`}}})()}PostAttachContextMenu(e){this.p5toast.show({text:`${this.lang.text.AddPost.RemoveAttach}: ${this.userInput.attachments[e].filename}`}),this.userInput.attachments.splice(e,1);let i=this.userInput.content.split("\n");for(let a=i.length-1;a>=0;a--){let s=!1,o=i[a].length-1,n=0;try{n=Number(i[a].substring(1,o)),s="["==i[a].charAt(0)&&"]"==i[a].charAt(o)&&!isNaN(n)}catch{}if(s)if(e==n){if(""==i[a+1])try{i.splice(a+1,1)}catch{}i.splice(a,1)}else e<n&&(i[a]=`[${n-1}]`)}return this.userInput.content=i.join("\n"),!1}inputFileSelected(e){var i=this;return(0,I.c)(function*(){if(e.target.files.length)if(1!=e.target.files.length){let s=yield i.loadingCtrl.create({message:i.lang.text.ChatRoom.MultipleSend});s.present();for(let o=0,n=e.target.files.length;o<n;o++)s.message=`${n-o}: ${e.target.files[o].name}`,yield i.selected_blobFile_callback_act(e.target.files[o]);s.dismiss(),setTimeout(()=>{document.getElementById("add_post_input").value=""},300)}else{let s=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});s.present(),yield i.selected_blobFile_callback_act(e.target.files[0]),s.dismiss(),document.getElementById("add_post_input").value=""}})()}open_viewer(e,i){var a=this;let s=[];for(let o=0,n=this.userInput.attachments.length;o<n;o++)s.push({content:this.userInput.attachments[o]});this.lock_modal_open||(this.lock_modal_open=!0,delete this.global.p5key.KeyShortCut.Escape,this.modalCtrl.create({component:M.K,componentProps:{info:{content:e},path:e.path,alt_path:e.path,isOfficial:this.isOfficial,target:this.target,relevance:s,local:"local"==this.servers[this.index].isOfficial},cssClass:"fullscreen"}).then(o=>{o.onDidDismiss().then(n=>{if(this.AddShortcut(),n.data)switch(n.data.type){case"image":let l=[];if(n.data.msg.content.content_related_creator&&(l=[...n.data.msg.content.content_related_creator]),n.data.msg.content.content_creator){let p=!1;for(let r=0,m=l.length;r<m;r++)if(l[r].user_id==n.data.msg.content.content_creator.user_id){p=!0;break}p||l.push(n.data.msg.content.content_creator)}return void this.modalCtrl.create({component:E.S,componentProps:{path:n.data.path||e.path,width:n.data.width,height:n.data.height,isDarkMode:n.data.isDarkMode,scrollHeight:n.data.scrollHeight},cssClass:"fullscreen"}).then(p=>{p.onDidDismiss().then(()=>{this.AddShortcut()}),p.onWillDismiss().then(function(){var r=(0,I.c)(function*(m){m.data&&(yield a.voidDraw_fileAct_callback(m,l,i))});return function(m){return r.apply(this,arguments)}}()),delete this.global.p5key.KeyShortCut.Escape,p.present()});case"text":this.selected_blobFile_callback_act(n.data.blob,n.data.contentRelated,"textedit",void 0,i)}}),delete this.global.p5key.KeyShortCut.Escape,o.present(),this.lock_modal_open=!1}))}toggle_custom_attach(e){var i=this;return(0,I.c)(function*(){switch(i.useFirstCustomCDN=(null!=e?e:i.useFirstCustomCDN+1)%("me"==i.userInput.creator_id?2:3),"Android"==j.s1&&(i.useFirstCustomCDN=2,i.extended_buttons[6].isHide=!0),i.useFirstCustomCDN){case 0:i.extended_buttons[6].icon="cloud-offline-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.Detour;break;case 1:i.extended_buttons[6].icon="cloud-done-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.useFSS;break;case 2:i.extended_buttons[6].icon="server-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.forceSQL}localStorage.setItem("useFFSCDN",`${i.useFirstCustomCDN}`)})()}postData(){var e=this;return(0,I.c)(function*(){if(!e.userInput.title)return e.p5toast.show({text:e.lang.text.AddPost.NeedPostTitle}),void e.TitleInput.focus();e.useVoiceRecording&&(yield e.StopAndSaveVoiceRecording());let i=!!e.userInput.server.local;e.isApplyPostData=!0;let a=yield e.loadingCtrl.create({message:e.lang.text.AddPost.WIP});a.present(),e.isSaveClicked=!0;let s=e.userInput.server.isOfficial,o=e.userInput.server.target;try{if(!e.isModify||e.isServerChanged)if(e.isServerChanged&&e.OriginalInfo&&(yield e.nakama.RemovePost(e.OriginalInfo)),i){let r=Number(yield e.indexed.loadTextFromUserPath("servers/local/target/posts/me/counter.txt"))||0;e.userInput.id=`LocalPost_${r}`;try{yield e.indexed.saveTextFileToUserPath(`${r+1}`,"servers/local/target/posts/me/counter.txt")}catch(m){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${m}`}),console.log(m)}}else try{let r=yield e.nakama.servers[s][o].client.readStorageObjects(e.nakama.servers[s][o].session,{object_ids:[{collection:"server_post",key:"Counter",user_id:e.nakama.servers[s][o].session.user_id}]}),m=0;r.objects.length&&(m=r.objects[0].value.counter),e.userInput.id=`ServerPost_${m}`,yield e.nakama.servers[s][o].client.writeStorageObjects(e.nakama.servers[s][o].session,[{collection:"server_post",key:"Counter",permission_write:1,permission_read:2,value:{counter:m+1}}])}catch(r){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${r}`}),console.log(r)}else{e.userInput.mainImage&&e.userInput.mainImage.url&&!e.userInput.mainImage.blob&&(e.userInput.mainImage.blob=yield(yield fetch(e.userInput.mainImage.url)).blob());for(let r=0,m=e.userInput.attachments.length;r<m;r++)e.userInput.attachments[r].url&&!e.userInput.attachments[r].blob&&(e.userInput.attachments[r].blob=yield(yield fetch(e.userInput.attachments[r].url)).blob());yield e.nakama.RemovePost(e.userInput)}e.isModify?e.userInput.modify_time=(new Date).getTime():(e.userInput.create_time=(new Date).getTime(),e.userInput.modify_time=e.userInput.create_time);for(let r=0,m=e.userInput.attachments.length;r<m;r++)delete e.userInput.attachments[r].thumbnail;if(e.userInput.mainImage){a.message=e.lang.text.AddPost.SyncMainImage,e.userInput.mainImage.path=`servers/${s}/${o}/posts/${e.userInput.creator_id}/${e.userInput.id}/MainImage.${e.userInput.mainImage.file_ext}`,e.userInput.mainImage.thumbnail=e.MainPostImage;try{if(1!=e.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let r;if(a.message=`${e.lang.text.AddPost.SyncMainImage}: ${e.userInput.mainImage.filename}`,r=yield e.global.try_upload_to_user_custom_fs(e.userInput.mainImage,e.nakama.users.self.display_name,void 0,a),!r)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.mainImage.path,delete e.userInput.mainImage.partsize,e.userInput.mainImage.url=r}catch{yield e.indexed.saveBlobToUserPath(e.userInput.mainImage.blob,e.userInput.mainImage.path)}if(!i)try{if(2==e.useFirstCustomCDN)throw"SQL \uac15\uc81c";let r=e.nakama.servers[e.isOfficial][e.target].info.address,m=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:",C=yield e.global.upload_file_to_storage(e.userInput.mainImage,e.nakama.servers[e.isOfficial][e.target].session.user_id,m,r,1==e.useFirstCustomCDN,a);if(!C)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.mainImage.partsize,e.userInput.mainImage.url=C}catch{yield e.nakama.sync_save_file(e.userInput.mainImage,s,o,"server_post",`${e.userInput.id}_mainImage`)}}let n=e.userInput.attachments.length;if(n){a.message=e.lang.text.AddPost.SyncAttaches;for(let r=n-1;r>=0;r--){try{if(1!=e.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let m;if(a.message=`${e.lang.text.AddPost.SyncAttaches}: [${r}]${e.userInput.attachments[r].filename}`,m=yield e.global.try_upload_to_user_custom_fs(e.userInput.attachments[r],e.nakama.users.self.display_name,void 0,a),!m)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.attachments[r].path,delete e.userInput.attachments[r].partsize,e.userInput.attachments[r].url=m}catch{e.userInput.attachments[r].path=`servers/${s}/${o}/posts/${e.userInput.creator_id}/${e.userInput.id}/[${r}]${e.userInput.attachments[r].filename}`,yield e.indexed.saveBlobToUserPath(e.userInput.attachments[r].blob,e.userInput.attachments[r].path)}if(!i)try{if(2==e.useFirstCustomCDN)throw"SQL \uac15\uc81c";let m=e.nakama.servers[e.isOfficial][e.target].info.address,C=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:",P=yield e.global.upload_file_to_storage(e.userInput.attachments[r],e.nakama.servers[e.isOfficial][e.target].session.user_id,C,m,1==e.useFirstCustomCDN,a);if(!P)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.attachments[r].partsize,e.userInput.attachments[r].url=P}catch(m){"SQL \uac15\uc81c"==m&&e.userInput.attachments[r].url&&!e.userInput.attachments[r].blob&&(e.userInput.attachments[r].blob=yield(yield fetch(e.userInput.attachments[r].url)).blob()),yield e.nakama.sync_save_file(e.userInput.attachments[r],s,o,"server_post",`${e.userInput.id}_attach_${r}`)}}}let l=JSON.parse(JSON.stringify(e.userInput));l.mainImage&&delete l.mainImage.blob;for(let r=l.attachments.length-1;r>=0;r--)delete l.attachments[r].blob;delete l.server;try{e.nakama.posts_orig[s][o]||(e.nakama.posts_orig[s][o]={}),e.nakama.posts_orig[s][o][e.userInput.creator_id]||(e.nakama.posts_orig[s][o][e.userInput.creator_id]={}),e.nakama.posts_orig[s][o][e.userInput.creator_id][e.userInput.id]=e.userInput}catch(r){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${r}`}),console.log(r)}let p=JSON.stringify(l);if(yield e.indexed.saveTextFileToUserPath(p,`servers/${s}/${o}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`),!i){let r=new Blob([p],{type:"application/json"}),m={filename:"info.json"};m.blob=r,m.size=r.size,m.type="application/json",m.file_ext="txt",m.typeheader="text",m.path=`servers/${s}/${o}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`,yield e.nakama.sync_save_file(m,s,o,"server_post",e.userInput.id)}e.nakama.rearrange_posts()}catch(n){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${n}`}),console.warn("\uac8c\uc2dc\ubb3c \uc800\uc7a5 \ucc98\ub9ac \uc624\ub958: ",n)}try{yield e.nakama.servers[e.isOfficial][e.target].client.rpc(e.nakama.servers[e.isOfficial][e.target].session,"send_noti_all_fn",{noti_id:G.i.MANAGE_POST,type:"add",user_id:e.userInput.creator_id,post_id:e.userInput.id,persistent:!1})}catch{}a.dismiss(),e.navCtrl.navigateBack("portal/community")})()}ionViewWillLeave(){if(delete this.global.p5key.KeyShortCut.Escape,this.global.p5key.KeyShortCut.BottomTab=this.BottomTabShortcut,this.indexed.GetFileListFromDB("tmp_files/post").then(e=>e.forEach(i=>this.indexed.removeFileFromUserPath(i))),!this.isApplyPostData)try{this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id]&&delete this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id],this.nakama.load_local_post_with_id(this.userInput.id,this.userInput.server.isOfficial,this.userInput.server.target,this.userInput.creator_id),this.nakama.rearrange_posts()}catch{}}}return(d=f).\u0275fac=function(e){return new(e||d)(t.GI1(N.A1),t.GI1(V.o),t.GI1(Y.wX),t.GI1(G.h),t.GI1(y.qS),t.GI1(K.O),t.GI1(z.k),t.GI1(y.Kg),t.GI1(W.mI),t.GI1(H._),t.GI1(R.gV),t.GI1(R.E5))},d.\u0275cmp=t.In1({type:d,selectors:[["app-add-post"]],decls:30,vars:20,consts:[[1,"ion-no-border"],[4,"ngIf"],["slot","start"],["defaultHref","portal/community"],[3,"fullscreen"],["id","p5Drop_addPost",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],["button","",3,"click"],[1,"additional_form","new_bg_form"],[1,"ion-text-end"],["style","width: 100%; text-align: center; text-align: -webkit-center; padding: 8px;",4,"ngIf"],["button",""],["id","add_post_title",3,"disabled","placeholder","ngModel","ngModelChange"],["id","add_post_content",1,"infobox",2,"height","50%",3,"disabled","placeholder","ngModel","ngModelChange"],["hidden","","type","file","id","add_post_input","accept","*","multiple","",3,"change"],["hidden","","type","file","id","PostMainImage_sel","accept","image/*",3,"change"],[2,"width","100%","text-align","center","padding-bottom","16px"],["style","display: inline-block;",4,"ngFor","ngForOf"],["button","",3,"disabled","click","contextmenu",4,"ngFor","ngForOf"],["button","",3,"disabled","click"],[1,"ion-text-center"],["value","colors","expand","inset",3,"disabled","value","click"],["accordionGroup",""],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],[2,"width","100%","text-align","center","text-align","-webkit-center","padding","8px"],[2,"pointer-events","none",3,"ngModel","ngModelChange"],[2,"width","400px","padding-top","8px"],["alt","MainPostImage",1,"thumbnail_image",3,"src"],[2,"display","inline-block"],[1,"ext_button","ext_button_override",3,"hidden","click"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"],["button","",3,"disabled","click","contextmenu"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"]],template:function(e,i){1&e&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar"),t.yuY(2,J,2,1,"ion-title",1)(3,Q,2,1,"ion-title",1),t.I0R(4,"ion-buttons",2),t.wR5(5,"ion-back-button",3),t.C$Y()()(),t.I0R(6,"ion-content",4),t.wR5(7,"div",5),t.yuY(8,Z,11,5,"ion-accordion-group",6),t.I0R(9,"ion-item",7),t.qCj("click",function(){return i.go_to_profile()}),t.wR5(10,"div",8),t.I0R(11,"ion-label"),t.OEk(12),t.C$Y(),t.I0R(13,"ion-label",9),t.OEk(14),t.C$Y()(),t.I0R(15,"ion-item-divider")(16,"ion-label"),t.OEk(17),t.C$Y()(),t.yuY(18,q,6,5,"div",10),t.I0R(19,"ion-item",11)(20,"ion-input",12),t.iHE("ngModelChange",function(s){return t.kNx(i.userInput.title,s)||(i.userInput.title=s),s}),t.C$Y()(),t.I0R(21,"textarea",13),t.iHE("ngModelChange",function(s){return t.kNx(i.userInput.content,s)||(i.userInput.content=s),s}),t.C$Y(),t.I0R(22,"input",14),t.qCj("change",function(s){return i.inputFileSelected(s)}),t.C$Y(),t.I0R(23,"input",15),t.qCj("change",function(s){return i.ChangeMainPostImage(s)}),t.C$Y(),t.I0R(24,"div",16),t.yuY(25,ie,6,6,"div",17),t.C$Y(),t.yuY(26,ae,5,3,"ion-item",18),t.I0R(27,"ion-item",19),t.qCj("click",function(){return i.postData()}),t.I0R(28,"ion-label",20),t.OEk(29),t.C$Y()()()),2&e&&(t.yG2(2),t.E7m("ngIf",i.isModify),t.yG2(),t.E7m("ngIf",!i.isModify),t.yG2(3),t.E7m("fullscreen",!0),t.yG2(2),t.E7m("ngIf",i.servers.length),t.yG2(2),t.m_g("background-image: linear-gradient(to right, #0000, #"+i.userInput.UserColor+"44)"),t.yG2(2),t.cNF(i.lang.text.AddPost.Creator),t.yG2(2),t.cNF(i.userInput.creator_name||i.lang.text.Profile.noname_user),t.yG2(3),t.cNF(i.lang.text.AddPost.AddNewPost),t.yG2(),t.E7m("ngIf",i.MainPostImage),t.yG2(2),t.E7m("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.TitlePlaceholder),t.OKB("ngModel",i.userInput.title),t.yG2(),t.E7m("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.ContentPlaceHolder),t.OKB("ngModel",i.userInput.content),t.yG2(4),t.E7m("ngForOf",i.extended_buttons),t.yG2(),t.E7m("ngForOf",i.userInput.attachments),t.yG2(),t.E7m("disabled",i.isSaveClicked),t.yG2(2),t.cNF(i.lang.text.AddPost.Post))},dependencies:[T.ay,T.u_,$.ot,$.ue,$._G,y.cm,y.qU,y.GS,y._i,y.wB,y.Ko,y.A5,y.Yb,y.S8,y.QR,y.tM,y.E$,y.Md,y.UJ,y.qG,y.Im],styles:[".ext_button_override[_ngcontent-%COMP%]{margin:12px;cursor:pointer}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover;border-radius:16px}"]}),f})()}];let ne=(()=>{var d;class f{}return(d=f).\u0275fac=function(e){return new(e||d)},d.\u0275mod=t.a4G({type:d}),d.\u0275inj=t.s3X({imports:[R.qQ.forChild(se),R.qQ]}),f})(),oe=(()=>{var d;class f{}return(d=f).\u0275fac=function(e){return new(e||d)},d.\u0275mod=t.a4G({type:d}),d.\u0275inj=t.s3X({imports:[T.MD,$.y,y.wZ,ne]}),f})()}}]);