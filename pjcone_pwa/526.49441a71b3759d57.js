"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[526],{526:(Re,M,I)=>{I.r(M),I.d(M,{PostViewerPageModule:()=>ye});var L=I(177),N=I(4341),k=I(5374),j=I(9858),R=I(467),B=I(8326),X=I(222),$=I(9969),t=I(3953),H=I(3656),W=I(4234),Y=I(755),Q=I(4237),J=I(7100),z=I(9900),K=I(3307),Z=I(8065),q=I(5547);const ee=["PostViewMenu"],te=["QuickPostView"];function oe(a,p){1&a&&(t.j41(0,"div",22),t.EFF(1,"Shift + W"),t.k0s())}function ie(a,p){1&a&&(t.j41(0,"div",22),t.EFF(1,"Shift + E"),t.k0s())}function ne(a,p){if(1&a){const i=t.RV6();t.j41(0,"div"),t.DNE(1,ie,2,0,"div",19),t.j41(2,"ion-item",20),t.bIt("click",function(){t.eBV(i);const o=t.XpG(3);return t.Njj(o.EditPost())}),t.j41(3,"ion-label"),t.EFF(4),t.k0s()()()}if(2&a){const i=t.XpG(3);t.R7$(),t.Y8G("ngIf",i.global.ShowHint),t.R7$(3),t.JRh(i.lang.text.AddPost.EditTitle)}}function se(a,p){1&a&&(t.j41(0,"div",22),t.EFF(1,"Shift + D"),t.k0s())}function ae(a,p){if(1&a){const i=t.RV6();t.j41(0,"div"),t.DNE(1,se,2,0,"div",19),t.j41(2,"ion-item",20),t.bIt("click",function(){t.eBV(i);const o=t.XpG(3);return t.Njj(o.RemovePost())}),t.j41(3,"ion-label"),t.EFF(4),t.k0s()()()}if(2&a){const i=t.XpG(3);t.R7$(),t.Y8G("ngIf",i.global.ShowHint),t.R7$(3),t.JRh(i.lang.text.PostViewer.RemovePost)}}function le(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-content")(1,"ion-list")(2,"div"),t.DNE(3,oe,2,0,"div",19),t.j41(4,"ion-item",20),t.bIt("click",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.ToggleFocusMode())}),t.j41(5,"ion-label"),t.EFF(6),t.k0s()()(),t.DNE(7,ne,5,2,"div",21)(8,ae,5,2,"div",21),t.k0s()()}if(2&a){const i=t.XpG(2);t.R7$(3),t.Y8G("ngIf",i.global.ShowHint),t.R7$(3),t.JRh(i.lang.text.ContentViewer.FocusMode),t.R7$(),t.Y8G("ngIf",i.isOwner&&i.CurrentIndex>=0),t.R7$(),t.Y8G("ngIf",i.isOwner&&i.CurrentIndex>=0)}}function re(a,p){1&a&&(t.j41(0,"div",23)(1,"div",24),t.EFF(2,"A"),t.k0s()())}function ce(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-icon",25),t.bIt("click",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.ChangeToAnother(-1))}),t.k0s()}}function de(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-label",26),t.bIt("click",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.FocusOnIndexInput())}),t.EFF(1),t.k0s()}if(2&a){const i=t.XpG(2);t.R7$(),t.JRh(i.CurrentIndex+" / "+i.nakama.posts.length)}}function he(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-label",27)(1,"input",28),t.bIt("change",function(o){t.eBV(i);const s=t.XpG(2);return t.Njj(s.ChangeRelevanceIndex(o))})("keydown",function(o){t.eBV(i);const s=t.XpG(2);return t.Njj(s.ChangeRelevanceIndex(o))}),t.k0s(),t.EFF(2),t.k0s()}if(2&a){const i=t.XpG(2);t.R7$(),t.Y8G("id",i.RelevancesInputId)("placeholder",i.CurrentIndex),t.R7$(),t.JRh(" / "+i.nakama.posts.length)}}function fe(a,p){1&a&&(t.j41(0,"div",23)(1,"div",29),t.EFF(2,"D"),t.k0s()())}function ue(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-icon",30),t.bIt("click",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.ChangeToAnother(1))}),t.k0s()}}function ge(a,p){if(1&a){const i=t.RV6();t.j41(0,"ion-header",8)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",9),t.nrm(5,"ion-back-button",10),t.k0s(),t.j41(6,"ion-icon",11),t.bIt("click",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.SetFalseAlarm())}),t.k0s(),t.j41(7,"ion-icon",12),t.bIt("click",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.OpenFileMenu())}),t.k0s(),t.j41(8,"ion-popover",13,1),t.DNE(10,le,9,4,"ng-template"),t.k0s(),t.DNE(11,re,3,0,"div",14)(12,ce,1,0,"ion-icon",15)(13,de,2,1,"ion-label",16)(14,he,3,3,"ion-label",17)(15,fe,3,0,"div",14)(16,ue,1,0,"ion-icon",18),t.k0s()()}if(2&a){const i=t.XpG();t.Y8G("@toggle_item",void 0),t.R7$(3),t.JRh(i.lang.text.PostViewer.Title),t.R7$(4),t.Y8G("id",i.postMenuId),t.R7$(),t.Y8G("trigger",i.postMenuId),t.R7$(3),t.Y8G("ngIf",i.global.ShowHint&&i.HavePosts),t.R7$(),t.Y8G("ngIf",i.HavePosts),t.R7$(),t.Y8G("ngIf",i.HavePosts&&!i.CanInputValue),t.R7$(),t.Y8G("ngIf",i.HavePosts&&i.CanInputValue),t.R7$(),t.Y8G("ngIf",i.global.ShowHint&&i.HavePosts),t.R7$(),t.Y8G("ngIf",i.HavePosts)}}function me(a,p){if(1&a&&t.nrm(0,"img",31),2&a){const i=t.XpG();t.Y8G("src",i.PostInfo.mainImage.MainThumbnail,t.B4B)}}function pe(a,p){1&a&&(t.j41(0,"div",22),t.EFF(1,"Shift + E"),t.k0s())}function Pe(a,p){1&a&&(t.j41(0,"div",22),t.EFF(1,"Shift + D"),t.k0s())}function _e(a,p){if(1&a){const i=t.RV6();t.j41(0,"table",32)(1,"tr")(2,"td")(3,"div",33),t.DNE(4,pe,2,0,"div",19),t.j41(5,"ion-button",34),t.bIt("click",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.EditPost())}),t.EFF(6),t.k0s()()(),t.j41(7,"td")(8,"div",33),t.DNE(9,Pe,2,0,"div",19),t.j41(10,"ion-button",35),t.bIt("click",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.RemovePost())}),t.EFF(11),t.k0s()()()()()}if(2&a){const i=t.XpG();t.R7$(4),t.Y8G("ngIf",i.global.ShowHint),t.R7$(2),t.SpI(" ",i.lang.text.AddPost.EditTitle," "),t.R7$(3),t.Y8G("ngIf",i.global.ShowHint),t.R7$(2),t.SpI(" ",i.lang.text.PostViewer.RemovePost," ")}}function Ie(a,p){if(1&a){const i=t.RV6();t.j41(0,"img",42),t.bIt("click",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.copy_text(o.TempSharedAddress))})("contextmenu",function(){t.eBV(i);const o=t.XpG(2);return t.Njj(o.copy_text(o.ResultSharedAddress))}),t.k0s()}if(2&a){const i=t.XpG(2);t.Y8G("src",i.QRCodeSRC,t.B4B)}}function ve(a,p){if(1&a){const i=t.RV6();t.j41(0,"div",36),t.bIt("click",function(o){t.eBV(i);const s=t.XpG();return t.Njj(s.CheckIfDismissAct(o))}),t.j41(1,"div",37)(2,"div",38),t.DNE(3,Ie,1,1,"img",39),t.j41(4,"ion-item",40),t.bIt("click",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.copy_text(o.TempSharedAddress))})("contextmenu",function(){t.eBV(i);const o=t.XpG();return t.Njj(o.copy_text(o.ResultSharedAddress))}),t.j41(5,"ion-label",41),t.EFF(6),t.k0s()()()()()}if(2&a){const i=t.XpG();t.R7$(3),t.Y8G("ngIf",i.QRCodeSRC),t.R7$(3),t.JRh(i.TempSharedAddress)}}const be=[{path:"",component:(()=>{var a;class p{constructor(e,o,s,f,g,m,y,P,_,x,F,V){this.navCtrl=e,this.lang=o,this.indexed=s,this.nakama=f,this.alertCtrl=g,this.global=m,this.p5toast=y,this.route=P,this.router=_,this.p5loading=x,this.statusBar=F,this.noti=V,this.PostInfo={},this.isOwner=!1,this.HavePosts=!1,this.CurrentIndex=1,this.postMenuId="postMenuId",this.DigitShortcutAct=[],this.LastPickedRouter="portal/community/",this.WaitingLoaded=!1,this.BackButtonPressed=!1,this.modelViewers=[],this.ScrollPostId="ScrollPostId",this.FileURLs=[],this.PlayableElements=[],this.IsFocusOnHere=!0,this.RearrangedRelevance=[],this.RearrangedContents=[],this.ModalDismissId="postviewer_modal",this.ContentChanging=!1,this.PostContentId="PostContentId",this.AlreadyHaveGodot=!1,this.CanInputValue=!1,this.RelevancesInputId="RelevancesInputId"}OpenFileMenu(){this.PostViewMenu.onDidDismiss().then(()=>{this.DigitShortcutAct.length=0,this.global.RestoreShortCutAct("postview-menu")}),this.global.StoreShortCutAct("postview-menu"),this.DigitShortcutAct.push(()=>this.ToggleFocusMode()),this.isOwner&&this.CurrentIndex>=0&&(this.DigitShortcutAct.push(()=>this.EditPost()),this.DigitShortcutAct.push(()=>this.RemovePost())),this.PostViewMenu.present()}ToggleFocusMode(){this.PostViewMenu.dismiss(),this.global.ToggleFullScreen()}ngOnInit(){this.postMenuId=`postMenuId_${Date.now()}`,this.ModalDismissId=`postviewer_modal_${Date.now()}`,this.cont=new AbortController,this.route.queryParams.subscribe(e=>{try{const o=this.router.getCurrentNavigation().extras.state;this.PostInfo=o.data,this.LastPickedRouter=this.PostInfo.router,this.ScrollPostId=`ScrollPostId_${Date.now()}`,this.PostContentId=`PostContentId_${Date.now()}`,this.CurrentIndex=o.index}catch{}}),this.RelevancesInputId=`post-viewer_RelevancesInputId_${Date.now}`}WaitingCurrent(){var e=this;return(0,R.A)(function*(){for(;!e.WaitingLoaded;)yield new Promise(o=>setTimeout(o,0))})()}ionViewWillEnter(){this.global.portalHint=!1,this.IsFocusOnHere&&this.initialize(),this.WaitingLoaded=!0,this.global.StoreShortCutAct("post-viewer"),this.IsFocusOnHere=!0}ChangeContentWithKeyInput(){var e=this;if(this.p5canvas){this.ScrollDiv||(this.ScrollDiv=document.getElementById(this.ScrollPostId)),this.p5canvas.keyPressed=function(){var f=(0,R.A)(function*(g){var m,y;if(e.IsFocusOnHere)switch(g.code){case"KeyW":g.shiftKey?e.ToggleFocusMode():e.ScrollDiv.scrollTo({top:e.ScrollDiv.scrollTop-e.ScrollDiv.clientHeight/2,behavior:"smooth"});break;case"KeyS":e.ScrollDiv.scrollTo({top:e.ScrollDiv.scrollTop+e.ScrollDiv.clientHeight/2,behavior:"smooth"});break;case"KeyA":case"ArrowLeft":e.ChangeToAnother(-1);break;case"KeyE":g.shiftKey&&e.EditPost();break;case"KeyD":g.shiftKey&&e.RemovePost();case"ArrowRight":g.shiftKey||e.ChangeToAnother(1);break;case"KeyF":e.OpenFileMenu();break;case"KeyQ":if(!e.RearrangedRelevance.length)return;let P,_,x;e.global.PageDismissAct[e.ModalDismissId]=V=>{e.ExitModalAct(V)};try{x=e.PostInfo.creator_id,P=e.PostInfo.server.isOfficial,_=e.PostInfo.server.target}catch{P="local"}e.IsFocusOnHere=!1,e.StopAllPlayableElement(),e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{...e.RearrangedRelevance[0],sender_id:x},isOfficial:P,target:_,path:e.RearrangedRelevance[0].content.path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId});break;case"Digit1":case"Digit2":case"Digit3":case"Digit4":case"Digit5":case"Digit6":case"Digit7":case"Digit8":case"Digit9":const F=(Number(g.code.slice(-1))-1+10)%10;null===(m=(y=e.DigitShortcutAct)[F])||void 0===m||m.call(y)}});return function(g){return f.apply(this,arguments)}}();let o=this.p5canvas.createVector(),s={};this.p5canvas.touchStarted=f=>{if(this.IsFocusOnHere&&"changedTouches"in f){for(let m=0,y=f.changedTouches.length;m<y;m++)s[f.changedTouches[m].identifier]=this.p5canvas.createVector(f.changedTouches[m].clientX,f.changedTouches[m].clientY);1===Object.keys(s).length&&(o=s[f.changedTouches[0].identifier].copy())}},this.p5canvas.touchEnded=f=>{if(this.IsFocusOnHere&&"changedTouches"in f){let g;for(let P=0,_=f.changedTouches.length;P<_;P++)g=this.p5canvas.createVector(f.changedTouches[P].clientX,f.changedTouches[P].clientY),delete s[f.changedTouches[P].identifier];let m=Object.keys(s).length;const y=this.p5canvas.max(100,this.p5canvas.min(window.innerWidth/4,200));0===m&&(g.sub(o),g.x>y?this.ChangeToAnother(-1):g.x<-y&&this.ChangeToAnother(1))}}}}ExitModalAct(e){var o=this;return(0,R.A)(function*(){var s;yield o.WaitingCurrent(),e.data&&e.data.share&&o.navCtrl.pop(),o.IsFocusOnHere=!0,e.index<o.RearrangedContents.length&&(null===(s=o.RearrangedContents[e.index].elt)||void 0===s||s.scrollIntoView({block:"center",behavior:"smooth"})),delete o.global.PageDismissAct[o.ModalDismissId]})()}initialize(){var e=this;this.RearrangedRelevance.length=0,this.RearrangedContents.length=0,this.PostInfo.quick&&(this.global.ArcadeWithFullScreen=!0),this.PostInfo.mainImage&&function(){var s=(0,R.A)(function*(){try{!e.PostInfo.mainImage.blob&&!e.PostInfo.mainImage.url&&e.PostInfo.mainImage.path&&(e.PostInfo.mainImage.blob=yield e.indexed.loadBlobFromUserPath(e.PostInfo.mainImage.path,"image/png"));let f=e.PostInfo.mainImage.url;f||(f=URL.createObjectURL(e.PostInfo.mainImage.blob),setTimeout(()=>{URL.revokeObjectURL(f)},100)),e.PostInfo.mainImage.MainThumbnail=f}catch{}});return function(){return s.apply(this,arguments)}}()(),this.create_content();try{this.isOwner="me"==this.PostInfo.creator_id||this.PostInfo.creator_id==this.nakama.servers[this.PostInfo.server.isOfficial][this.PostInfo.server.target].session.user_id,"me"!=this.PostInfo.creator_id&&(this.isOwner=this.isOwner&&"online"==this.statusBar.groupServer[this.PostInfo.server.isOfficial][this.PostInfo.server.target])}catch{this.isOwner=!1}this.isOwner=this.isOwner||this.PostInfo.is_me,this.HavePosts=this.nakama.posts.length>1&&this.CurrentIndex>=0,this.ChangeContentWithKeyInput()}ChangeToAnother(e){var o=this;return(0,R.A)(function*(){var s;if(o.ContentChanging)return;o.ContentChanging=!0;let f=o.CurrentIndex+e;if(f<=0||f>o.nakama.posts.length)return o.ContentChanging=!1,void(yield o.p5loading.update({id:"postviewer",message:`${o.lang.text.ContentViewer.EndOfList}: ${o.CurrentIndex} / ${o.nakama.posts.length}`,progress:1,forceEnd:350}));o.ScrollDiv.scrollTo({top:0}),o.p5canvas&&o.p5canvas.remove(),o.CurrentIndex=f,yield o.p5loading.update({id:"postviewer",message:`${o.lang.text.PostViewer.PreparingPost}: ${null===(s=o.nakama.posts[o.CurrentIndex-1])||void 0===s?void 0:s.title} (${o.CurrentIndex} / ${o.nakama.posts.length})`,progress:null,forceEnd:null}),o.PostInfo=o.nakama.posts[o.CurrentIndex-1],o.CanInputValue=!1,o.initialize()})()}copy_text(e){return this.global.WriteValueToClipboard("text/plain",e),!1}create_content(){var e=this;this.modelViewers.forEach(s=>s.cleanup()),this.modelViewers.length=0;let o=document.getElementById(this.PostContentId);this.p5canvas=new B(s=>{s.setup=(0,R.A)(function*(){s.noCanvas();let g=s.createDiv(`${e.PostInfo.OutSource?'<ion-icon id="title_link" style="cursor: pointer;" slot="start" name="link-outline"></ion-icon> ':""}${e.PostInfo.title}`);e.PostInfo.OutSource&&(document.getElementById("title_link").onclick=(0,R.A)(function*(){e.ResultSharedAddress="",e.ResultSharedAddress=`${e.global.CustomLocalAddress}?postViewer=${e.PostInfo.OutSource}`,e.QRCodeSRC=e.global.readasQRCodeFromString(e.ResultSharedAddress),e.nakama.TempQRCodeGenerateWS(e.nakama.servers[e.PostInfo.server.isOfficial][e.PostInfo.server.target].info,{act:"quick_post",keys:["address"],address:e.PostInfo.OutSource}).then(b=>{e.TempSharedAddress=b,e.QRCodeSRC=e.global.readasQRCodeFromString(b.replace(/ /g,"%20"))}),e.QuickPostView.onDidDismiss().then(()=>{var b,D;null===(b=e.nakama.TempWS)||void 0===b||null===(D=b.close)||void 0===D||D.call(b,1e3,"\uac8c\uc2dc\ubb3c \uacf5\uc720 QR \ubaa8\ub2ec \ub2eb\ud798"),e.global.RestoreShortCutAct("quick-post-view")}),e.global.StoreShortCutAct("quick-post-view"),e.QuickPostView.present()})),g.style("font-size","32px"),g.style("font-weight","bold"),g.parent(o);let P,m=s.createDiv();m.style("color","#888"),s.createDiv(`${e.lang.text.PostViewer.CreateTime}: ${new Date(e.PostInfo.create_time).toLocaleString()}`).parent(m),e.PostInfo.create_time!=e.PostInfo.modify_time&&s.createDiv(`${e.lang.text.PostViewer.ModifyTime}: ${new Date(e.PostInfo.modify_time).toLocaleString()}`).parent(m),m.parent(o);try{P=e.nakama.usernameOverride[e.PostInfo.server.isOfficial][e.PostInfo.server.target][e.PostInfo.creator_id]||e.PostInfo.creator_name}catch{P=e.PostInfo.creator_name}let _=s.createSpan(P);if(_.style("color",`#${e.PostInfo.UserColor}`),_.style("font-weight","bold"),_.style("font-size","17px"),_.style("cursor","pointer"),_.mouseClicked(()=>{if("me"==e.PostInfo.creator_id)e.nakama.open_profile_page();else try{let u=e.PostInfo.server.isOfficial,b=e.PostInfo.server.target,D=e.PostInfo.creator_id;D==e.nakama.servers[u][b].session.user_id?e.nakama.open_profile_page({isOfficial:u,target:b}):e.nakama.open_others_profile({info:{user:e.nakama.load_other_user(D,u,b)},group:{server:{isOfficial:u,target:b}}})}catch(u){e.p5toast.show({text:`${e.lang.text.PostViewer.CannotOpenProfile}: ${(u.statusText?`${u.statusText}(${u.status})`:u.status)||u}`})}}),_.parent(o),e.PostInfo.offlineAct){let u="";switch(e.PostInfo.offlineAct){case"edit":u=e.lang.text.Community.AfterOnline;break;case"remove":u=e.lang.text.Community.WillBeRemove}const b=s.createSpan(` (${u})`);b.style("color: #888; font-weight: normal;"),b.parent(_)}let x=[];if(e.PostInfo.content){var F;let u=(yield X.xI(e.PostInfo.content)).split("\n"),b=[];for(let d=0,C=u.length;d<C;d++){let U=!1,xe=u[d].length-1,n=0;try{let h=u[d].indexOf("}</p>");n=Number(u[d].substring(4,h)),U=0==u[d].indexOf("<p>{")&&u[d].indexOf("}</p>")==xe-4&&!isNaN(n)}catch{}if(U){var V;if(e.p5loading.update({id:"postviewer",message:`${e.lang.text.PostViewer.PreparingPost}: ${e.PostInfo.attachments[n].filename} (${e.CurrentIndex} / ${e.nakama.posts.length})`,progress:n/e.PostInfo.attachments.length,forceEnd:null}),!Number.isNaN(n)&&!x.includes(n)&&x.push(n),null!==(V=e.PostInfo.server)&&void 0!==V&&V.local)try{if(e.PostInfo.attachments[n].blob)throw"blob \uc900\ube44\ub418\uc5b4\uc788\uc74c";let h=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type);e.PostInfo.attachments[n].blob=h}catch{}else try{if(e.PostInfo.attachments[n].blob)throw"blob \uc900\ube44\ub418\uc5b4\uc788\uc74c";e.PostInfo.attachments[n].alt_path=`servers/${e.PostInfo.server.isOfficial}/${e.PostInfo.server.target}/posts/${e.PostInfo.creator_id}/${e.PostInfo.id}/[${d}]${e.PostInfo.attachments[d].filename}`;let h=yield e.nakama.sync_load_file(e.PostInfo.attachments[n],e.PostInfo.server.isOfficial,e.PostInfo.server.target,"server_post",e.PostInfo.creator_id,`${e.PostInfo.id}_attach_${n}`,!1);e.PostInfo.attachments[n].blob=h.value}catch{}switch(e.PostInfo.attachments[n].viewer){case"image":{let h=e.PostInfo.attachments[n].url;if(!h)try{h=URL.createObjectURL(e.PostInfo.attachments[n].blob),setTimeout(()=>{URL.revokeObjectURL(h)},100)}catch(l){console.log("\uac8c\uc2dc\ubb3c image \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=s.createP();r.parent(o);let c=s.createImg(h,`${n}`);c.style("cursor","pointer"),c.style("border-radius","16px"),c.attribute("loading","lazy"),c.mouseClicked(()=>{let l,v,w;e.global.PageDismissAct[e.ModalDismissId]=A=>{e.ExitModalAct(A)};try{w=e.PostInfo.creator_id,l=e.PostInfo.server.isOfficial,v=e.PostInfo.server.target}catch{l="local"}e.IsFocusOnHere=!1;let T=JSON.parse(JSON.stringify(e.PostInfo.attachments[n]));T.filename=`[${n}] ${T.filename}`,e.StopAllPlayableElement(),e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:T,sender_id:w},isOfficial:l,target:v,path:e.PostInfo.attachments[n].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),c.elt.oncontextmenu=()=>(function(){var v=(0,R.A)(function*(){try{yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[n].url)}catch{e.indexed.DownloadFileFromUserPath(e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type,e.PostInfo.attachments[n].filename)}});return function(){return v.apply(this,arguments)}}()(),!1),c.parent(r),u[d]=r}break;case"audio":{let h=e.PostInfo.attachments[n].url;if(!h)try{h=URL.createObjectURL(e.PostInfo.attachments[n].blob),e.FileURLs.push(h)}catch(l){console.log("\uac8c\uc2dc\ubb3c audio \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=s.createP(),c=s.createAudio([h]);c.showControls(),c.elt.onplay=()=>{for(let l=0,v=e.PlayableElements.length;l<v;l++)try{l!=n&&e.PlayableElements[l].pause()}catch{}},c.parent(r),u[d]=r,e.PlayableElements[n]=c.elt}break;case"video":{let h=e.PostInfo.attachments[n].url;if(!h)try{h=URL.createObjectURL(e.PostInfo.attachments[n].blob),e.FileURLs.push(h)}catch(l){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}let r=s.createP(),c=s.createVideo([h]);c.style("width","100%"),c.style("height","auto"),c.style("border-radius","16px"),c.showControls(),c.parent(r),u[d]=r,e.PlayableElements[n]=c.elt}break;case"godot":{const h=`PostViewer_godot_pck_${n}`;let r=s.createDiv();r.id(h),r.style("width","100%"),r.style("height","432px"),r.style("margin-top","8px"),u[d]=r,setTimeout(()=>{if(e.AlreadyHaveGodot||e.global.ArcadeLoaded)try{f(r,n),r.mouseClicked(()=>{let c,l,v;e.global.PageDismissAct[e.ModalDismissId]=T=>{e.ExitModalAct(T)};try{v=e.PostInfo.creator_id,c=e.PostInfo.server.isOfficial,l=e.PostInfo.server.target}catch{c="local"}e.IsFocusOnHere=!1;let w=JSON.parse(JSON.stringify(e.PostInfo.attachments[n]));w.filename=`[${n}] ${w.filename}`,e.StopAllPlayableElement(),e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:w,sender_id:v},isOfficial:c,target:l,path:e.PostInfo.attachments[n].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),r.elt.oncontextmenu=()=>(function(){var l=(0,R.A)(function*(){try{yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[n].url)}catch{e.indexed.DownloadFileFromUserPath(e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type,e.PostInfo.attachments[n].filename)}});return function(){return l.apply(this,arguments)}}()(),!1)}catch(c){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",c)}else e.AlreadyHaveGodot=!0,e.global.CreateGodotIFrameWithDuplicateAct(e.PostInfo.attachments[n],h,{path:`tmp_files/duplicate/${e.PostInfo.attachments[n].filename}`,quit_ionic:()=>{try{f(r,n),r.mouseClicked(()=>{let c,l,v;e.global.PageDismissAct[e.ModalDismissId]=T=>{e.ExitModalAct(T)};try{v=e.PostInfo.creator_id,c=e.PostInfo.server.isOfficial,l=e.PostInfo.server.target}catch{c="local"}e.IsFocusOnHere=!1;let w=JSON.parse(JSON.stringify(e.PostInfo.attachments[n]));w.filename=`[${n}] ${w.filename}`,e.StopAllPlayableElement(),e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:w,sender_id:v},isOfficial:c,target:l,path:e.PostInfo.attachments[n].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),r.elt.oncontextmenu=()=>(function(){var l=(0,R.A)(function*(){try{yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[n].url)}catch{e.indexed.DownloadFileFromUserPath(e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type,e.PostInfo.attachments[n].filename)}});return function(){return l.apply(this,arguments)}}()(),!1)}catch(c){console.log("\ud504\ub808\uc784 \uc0ad\uc81c \ud589\ub3d9\uc2e4\ud328: ",c)}}})},100*n)}break;case"model":{let h=s.createP(),r=s.createDiv();r.style("position","relative"),r.style("width","100%"),r.style("height","432px"),r.style("border-radius","16px"),r.style("overflow","hidden"),r.parent(h),r.hide(),u[d]=h;let c=e.PostInfo.attachments[n].url;if(!c)try{c=URL.createObjectURL(e.PostInfo.attachments[n].blob),e.FileURLs.push(c)}catch(l){console.log("\uac8c\uc2dc\ubb3c video \ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",l)}try{const l=yield e.global.load_openmodel_file(r.elt,e.PostInfo.attachments[n],c,s);e.modelViewers.push(l),r.show()}catch(l){e.p5toast.show({text:`${e.lang.text.ContentViewer.CannotOpenText}: ${(l.statusText?`${l.statusText}(${l.status})`:l.status)||l}`}),console.log("\ubaa8\ub378 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",l)}}break;case"code":case"text":if("text/html"==e.PostInfo.attachments[n].type)try{if(!e.PostInfo.attachments[n].blob||!e.PostInfo.attachments[n].blob.size){if(e.PostInfo.attachments[n].url){const l=yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[n].url);e.PostInfo.attachments[n].alt_path=`servers/${e.PostInfo.server.isOfficial}/${e.PostInfo.server.target}/posts/${e.PostInfo.creator_id}/${e.PostInfo.id}/[${n}]${e.PostInfo.attachments[n].filename}`,yield e.indexed.saveBlobToUserPath(l,e.PostInfo.attachments[n].alt_path)}let c=yield e.indexed.loadBlobFromUserPath(e.PostInfo.attachments[n].alt_path||e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type);e.PostInfo.attachments[n].blob=c}const h=URL.createObjectURL(e.PostInfo.attachments[n].blob);e.FileURLs.push(h);let r=s.createElement("iframe");r.style("width","100%"),r.style("border","0"),r.style("height","432px"),r.style("border-radius","16px"),r.attribute("src",h),u[d]=r;break}catch(h){console.log("HTML \ud30c\uc77c \uc77d\uae30 \uc2e4\ud328: ",h)}default:{let h=s.createDiv();h.parent(o),f(h,n),h.mouseClicked(()=>{let r,c,l;e.global.PageDismissAct[e.ModalDismissId]=w=>{e.ExitModalAct(w)};try{l=e.PostInfo.creator_id,r=e.PostInfo.server.isOfficial,c=e.PostInfo.server.target}catch{r="local"}e.IsFocusOnHere=!1;let v=JSON.parse(JSON.stringify(e.PostInfo.attachments[n]));v.filename=`[${n}] ${v.filename}`,e.StopAllPlayableElement(),e.global.ActLikeModal(`${e.LastPickedRouter}post-viewer/ionic-viewer`,{info:{content:v,sender_id:l},isOfficial:r,target:c,path:e.PostInfo.attachments[n].path,relevance:e.RearrangedRelevance,noEdit:!0,dismiss:e.ModalDismissId})}),h.elt.oncontextmenu=()=>(function(){var c=(0,R.A)(function*(){try{yield e.global.downloadWithProgressAsBlob(e.PostInfo.attachments[n].url)}catch{e.indexed.DownloadFileFromUserPath(e.PostInfo.attachments[n].path,e.PostInfo.attachments[n].type,e.PostInfo.attachments[n].filename)}});return function(){return c.apply(this,arguments)}}()(),!1),u[d]=h}}}else try{let h=e.global.HTMLDecode(u[d].replace("<p>","").replace("</p>","")),r=JSON.parse(h),l=s.createDiv(`[${r.i}] ${e.PostInfo.attachments[r.i].filename} (${r.t})`);l.style("background-color","#8888"),l.style("width","fit-content"),l.style("height","fit-content"),l.style("border-radius","16px"),l.style("padding","8px 16px"),l.style("margin","8px 0px"),l.style("cursor","pointer"),l.id("timelink"),u[d]=l,b.push(()=>{let v=e.PlayableElements[r.i],w=r.t.split(":"),T=0,A=1;for(let E=w.length-1;E>=0;E--){let ke=Number(w.pop());T+=ke*A,A*=60}l.mouseClicked(()=>{try{v.currentTime=T,v.play()}catch{}})})}catch{}}const D=(null===(F=e.PostInfo.attachments)||void 0===F?void 0:F.length)||0;for(let d=0;d<D;d++)x.includes(d)||x.push(d);for(let d of x){let C=JSON.parse(JSON.stringify(e.PostInfo.attachments[d]));C.filename=`[${d}] ${C.filename}`,e.RearrangedRelevance.push({content:C})}let O=[],G=()=>{if(O.length){let d=O.join("\n"),C=s.createDiv();C.style("width","100%"),C.elt.innerHTML=d,C.parent(o),O.length=0}};for(let d=0,C=u.length;d<C;d++)"string"==typeof u[d]?O.push(u[d]):(G(),u[d].parent(o),"timelink"!=u[d].id()&&e.RearrangedContents.push(u[d]));G();for(let d=0,C=b.length;d<C;d++)b[d]();for(let d of e.modelViewers){var S;null===(S=d.resized)||void 0===S||S.call(d)}}e.ContentChanging=!1,e.p5loading.update({id:"postviewer",message:`${e.lang.text.PostViewer.ReadyToSee}: ${e.PostInfo.title} (${e.CurrentIndex} / ${e.nakama.posts.length})`,progress:1,forceEnd:350})}),s.windowResized=()=>{setTimeout(()=>{for(let m of this.modelViewers){var g;null===(g=m.resized)||void 0===g||g.call(m)}},50)};let f=(g,m)=>{this.PostInfo.attachments[m].blob=null,g.style("width","160px"),g.style("height","112px"),g.style("overflow","hidden"),g.style("background-color","grey"),g.style("margin-top","8px"),g.style("border-radius","8px"),g.style("cursor","pointer");let y=s.createP(this.PostInfo.attachments[m].filename);y.style("margin","0px 4px"),y.style("text-align","start"),y.parent(g);let P=s.createDiv();P.style("background-color","white"),P.style("margin-top","2px"),P.style("position","relative"),P.style("width","100%"),P.style("height","2px"),P.parent(g);let _=s.createSpan(this.lang.text.PostViewer.OpenFromViewer);_.style("margin","2px 4px 0px 4px"),_.style("text-align","start"),_.style("display","grid"),_.parent(g)}})}StopAllPlayableElement(){for(let s=0,f=this.PlayableElements.length;s<f;s++){var e,o;null===(e=this.PlayableElements[s])||void 0===e||null===(o=e.pause)||void 0===o||o.call(e)}}CheckIfDismissAct(e){"quick_post_link_qr"===e.target.id&&this.QuickPostView.dismiss()}FocusOnIndexInput(){this.CanInputValue=!0,setTimeout(()=>{var e;null===(e=document.getElementById(this.RelevancesInputId))||void 0===e||e.focus()},100)}ChangeRelevanceIndex(e){if("Enter"==e.key){let o=Number(e.target.value||e.target.placeholder);o=Math.max(Math.min(o,this.nakama.posts.length),1),this.ChangeToAnother(o-this.CurrentIndex),setTimeout(()=>{this.CanInputValue=!1},0)}}EditPost(){this.isOwner&&this.CurrentIndex>=0&&(this.PostViewMenu.dismiss(),this.navCtrl.pop(),this.nakama.EditPost(this.PostInfo))}ionViewWillLeave(){this.p5loading.update({id:"postviewer",forceEnd:0},!0),this.WaitingLoaded=!1,this.global.RestoreShortCutAct("post-viewer"),this.IsFocusOnHere=!1}RemovePost(){var e=this;this.isOwner&&this.CurrentIndex>=0&&(this.PostViewMenu.dismiss(),this.alertCtrl.create({header:this.lang.text.PostViewer.RemovePost,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.ChatRoom.Delete,cssClass:"redfont",handler:()=>{!function(){var s=(0,R.A)(function*(){yield e.nakama.RemovePost(e.PostInfo),e.navCtrl.pop()});return function(){return s.apply(this,arguments)}}()()}}]}).then(o=>o.present()))}SetFalseAlarm(){var e=this;this.p5loading.toast(`${this.lang.text.NotificationSettings.set_alert}: ${this.PostInfo.title}...`,"create_todo_noti"),function(){var s=(0,R.A)(function*(){var f;const g=`/?localPostViewer=${e.PostInfo.server.isOfficial},${e.PostInfo.server.target},${e.PostInfo.id},${e.PostInfo.creator_id}`;let m={id:e.PostInfo.id,title:e.PostInfo.title,body:e.PostInfo.content,smallIcon_ln:"favicon",image:null===(f=e.PostInfo.mainImage)||void 0===f?void 0:f.MainThumbnail,bgcolor:(e.PostInfo.id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6),data_wm:{data:{url:g}}};if(!m.image){var y,P;let _;for(let x of e.PostInfo.attachments)if("image"==x.viewer){_=x;break}if(null!==(y=_)&&void 0!==y&&y.url)m.image=_.url;else if(null!==(P=_)&&void 0!==P&&P.path)try{const x=yield e.indexed.loadBlobFromUserPath(_.path,"image/png"),F=URL.createObjectURL(x);m.image=F,setTimeout(()=>{URL.revokeObjectURL(F)},100)}catch{}}e.noti.PushLocal(m,e.PostInfo.id,_=>{!function(){var F=(0,R.A)(function*(){try{const V=e.global.CatchGETs(g)||{},S=yield e.nakama.AddressToQRCodeAct(V,!0);yield e.nakama.act_from_QRInfo(S)}catch(V){e.p5toast.show({text:`${V}`}),console.log("\uc54c\ub9bc \ud074\ub9ad \ud589\ub3d9 \uc624\ub958: ",V)}});return function(){return F.apply(this,arguments)}}()()},!0)});return function(){return s.apply(this,arguments)}}()()}ngOnDestroy(){var e,o;null===(e=this.PostViewMenu)||void 0===e||e.dismiss(),null===(o=this.QuickPostView)||void 0===o||o.dismiss(),this.global.ToggleFullScreen(!1),this.route.queryParams.unsubscribe(),this.cont.abort("\uac8c\uc2dc\ubb3c \ubdf0\uc5b4 \ubc97\uc5b4\ub0a8"),this.cont=null;for(let s=0,f=this.FileURLs.length;s<f;s++)URL.revokeObjectURL(this.FileURLs[s]);this.modelViewers.forEach(s=>s.cleanup()),this.modelViewers.length=0,this.p5canvas&&this.p5canvas.remove(),this.global.portalHint=!0}}return(a=p).\u0275fac=function(e){return new(e||a)(t.rXU(H.q9),t.rXU(W.y),t.rXU(Y.n),t.rXU(Q.X),t.rXU(k.hG),t.rXU(J.z3),t.rXU(z.G),t.rXU(j.nX),t.rXU(j.Ix),t.rXU(K.f),t.rXU(Z.j),t.rXU(q.r))},a.\u0275cmp=t.VBU({type:a,selectors:[["app-post-viewer"]],viewQuery:function(e,o){if(1&e&&(t.GBs(ee,5),t.GBs(te,5)),2&e){let s;t.mGM(s=t.lsd())&&(o.PostViewMenu=s.first),t.mGM(s=t.lsd())&&(o.QuickPostView=s.first)}},decls:10,vars:5,consts:[["QuickPostView",""],["PostViewMenu",""],["class","ion-no-border",4,"ngIf"],[2,"height","100%","overflow-y","auto",3,"id"],["style","width: 100%; height: auto;","alt","MainImage","loading","lazy",3,"src",4,"ngIf"],[2,"padding","16px","height","100%","user-select","text",3,"id"],["style","width: 100%;",4,"ngIf"],[1,"transparent-modal"],[1,"ion-no-border"],["slot","start"],["defaultHref","portal/community"],["slot","end","name","notifications-circle-outline",1,"top_icon","relevance_change",2,"margin-right","24px",3,"click"],["name","ellipsis-vertical","slot","end",1,"relevance_change",2,"padding-right","24px","width","21px","height","21px",3,"click","id"],["dismissOnSelect","",3,"trigger"],["style","position: relative;","slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["class","shortcut_hint",4,"ngIf"],["button","",3,"click"],[4,"ngIf"],[1,"shortcut_hint"],["slot","end",2,"position","relative"],[1,"shortcut_hint","shortcut_change_viewer",2,"right","-4px"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end",3,"click"],["slot","end"],["type","number",2,"width","50px","text-align","right",3,"change","keydown","id","placeholder"],[1,"shortcut_hint","shortcut_change_viewer"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],["alt","MainImage","loading","lazy",2,"width","100%","height","auto",3,"src"],[2,"width","100%"],[2,"position","relative"],["expand","block",3,"click"],["color","danger","expand","block",3,"click"],["id","quick_post_link_qr",1,"OutterModal",3,"click"],[2,"display","flex","justify-content","center","align-items","center"],[2,"width","400px","min-height","455px","background-color","var(--chatroom-background)","text-align","center","padding","16px"],["style","width: 100%; height: auto; cursor: copy; margin-bottom: 8px;","alt","QuickPostViewLink",3,"src","click","contextmenu",4,"ngIf"],["button","",3,"click","contextmenu"],[1,"ion-text-center"],["alt","QuickPostViewLink",2,"width","100%","height","auto","cursor","copy","margin-bottom","8px",3,"click","contextmenu","src"]],template:function(e,o){1&e&&(t.DNE(0,ge,17,10,"ion-header",2),t.j41(1,"ion-content")(2,"div",3)(3,"div"),t.DNE(4,me,1,1,"img",4),t.nrm(5,"div",5),t.DNE(6,_e,12,4,"table",6),t.k0s()(),t.j41(7,"ion-modal",7,0),t.DNE(9,ve,7,2,"ng-template"),t.k0s()()),2&e&&(t.Y8G("ngIf",!o.global.ArcadeWithFullScreen),t.R7$(2),t.Y8G("id",o.ScrollPostId),t.R7$(2),t.Y8G("ngIf",o.PostInfo.mainImage&&o.PostInfo.mainImage.MainThumbnail),t.R7$(),t.Y8G("id",o.PostContentId),t.R7$(),t.Y8G("ngIf",o.isOwner&&o.CurrentIndex>=0))},dependencies:[L.bT,k.Jm,k.QW,k.W9,k.eU,k.iq,k.uz,k.he,k.nf,k.BC,k.ai,k.Sb,k.CF,k.el],data:{animation:[(0,$.hZ)("toggle_item",[(0,$.kY)(":enter",[(0,$.iF)({height:"0px",opacity:0}),(0,$.i0)(".3s ease-out",(0,$.iF)({height:"56px",opacity:1}))]),(0,$.kY)(":leave",[(0,$.i0)(".3s ease-in",(0,$.iF)({height:"0px",opacity:0}))])])]}}),p})()},{path:"ionic-viewer",loadChildren:()=>Promise.all([I.e(6042),I.e(4803)]).then(I.bind(I,4803)).then(a=>a.IonicViewerPageModule)}];let we=(()=>{var a;class p{}return(a=p).\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[j.iI.forChild(be),j.iI]}),p})(),ye=(()=>{var a;class p{}return(a=p).\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[L.MD,N.YN,k.bv,we]}),p})()}}]);