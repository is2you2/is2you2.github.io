"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4403],{4403:(te,D,u)=>{u.r(D),u.d(D,{ChatRoomPageModule:()=>We});var $=u(6814),n=u(95),M=u(1325),I=u(5877),v=u(5861),J=u(9868),E=u(9461),O=u(6845),L=u(9745),Q=u(477),N=u(6052),Y=u(2854),U=u(8162),B=u(196),j=u(4688),G=u(5470),K=u(9761),F=u(4713),W=u(1186),H=u(3832),e=u(9468),z=u(9080),X=u(4093),p=u(7488),T=u(797),g=u(3857),f=u(6593),x=u(7429),b=u(9376),y=u(4663);const P=["NewChatRoomAttach"];function V(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"ion-icon",36),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.toggle_thumbnail())}),e.qZA()}}function ee(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"ion-icon",37),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.toggle_thumbnail())}),e.qZA()}}function ie(s,d){if(1&s&&(e.TgZ(0,"div",46)(1,"font",47),e._uU(2),e.qZA()()),2&s){const o=e.oxw().$implicit;e.xp6(2),e.hij(" ",o.msgDate," ")}}function ne(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",48)(1,"span",49),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.user_detail(t))}),e.TgZ(2,"b")(3,"font",50),e._uU(4),e.qZA()()(),e.TgZ(5,"span",51),e._uU(6),e.qZA()()}if(2&s){const o=e.oxw().$implicit,i=e.oxw();e.xp6(3),e.MGl("color","#",o.is_me&&i.nakama.users.self.online||!o.is_me&&i.nakama.users[i.isOfficial][i.target][o.sender_id].online?o.color:"888",""),e.xp6(1),e.hij(" ",o.user_display_name,""),e.xp6(2),e.Oqu(o.msgTime)}}function ae(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",52),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.quickShare_act(t))}),e._uU(1),e.qZA()}if(2&s){const o=e.oxw(2);e.xp6(1),e.hij(" ",o.lang.text.ChatRoom.QuickShare," ")}}function oe(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",52),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.JoinWebRTCMatch(t))}),e._uU(1),e.qZA()}if(2&s){const o=e.oxw(2);e.xp6(1),e.hij(" ",o.lang.text.ChatRoom.JoinWebRTCMatch," ")}}function se(s,d){1&s&&e._UZ(0,"div",61)}function le(s,d){if(1&s&&(e.TgZ(0,"span",62),e._uU(1),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.hij(" ",o," ")}}function re(s,d){if(1&s&&(e.TgZ(0,"div",57)(1,"p",58),e._uU(2),e.qZA(),e.YNc(3,se,1,0,"div",59),e.YNc(4,le,2,1,"span",60),e.qZA()),2&s){const o=e.oxw(2).$implicit,i=e.oxw();e.Akn(i.info.HideAutoThumbnail?"filter: blur(6px);":""),e.xp6(2),e.hij(" ",o.content.filename," "),e.xp6(1),e.Q6J("ngIf",o.content.text),e.xp6(1),e.Q6J("ngForOf",o.content.text)}}function ce(s,d){if(1&s&&(e.TgZ(0,"div",63),e._UZ(1,"img",64),e.qZA()),2&s){const o=e.oxw(2).$implicit,i=e.oxw();e.xp6(1),e.Akn(i.info.HideAutoThumbnail?"filter: blur(6px);":""),e.Q6J("src",o.content.thumbnail,e.LSH)("alt",o.content.filename)}}function _e(s,d){if(1&s&&(e.TgZ(0,"div",65),e._uU(1),e.qZA()),2&s){const o=e.oxw(2).$implicit;e.xp6(1),e.hij(" ",o.content.transfer_index.index,"")}}function de(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",53),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.file_detail(t))}),e.YNc(1,re,5,5,"div",54),e.YNc(2,ce,2,4,"div",55),e.YNc(3,_e,2,1,"div",56),e.qZA()}if(2&s){const o=e.oxw().$implicit;e.xp6(1),e.Q6J("ngIf",!o.content.thumbnail),e.xp6(1),e.Q6J("ngIf",o.content.thumbnail),e.xp6(1),e.Q6J("ngIf",o.content.transfer_index)}}function he(s,d){if(1&s&&(e.TgZ(0,"div",66)(1,"div",67),e._uU(2),e.qZA()()),2&s){const o=e.oxw().$implicit;e.xp6(2),e.hij(" ",o.content.noti," ")}}function ue(s,d){if(1&s&&(e.TgZ(0,"span"),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.Akn("font-size: "+(o.size||16)+"px"),e.xp6(1),e.hij(" ",o.text," ")}}function ge(s,d){if(1&s&&(e.TgZ(0,"a",72),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.Q6J("href",o.text,e.LSH),e.xp6(1),e.Oqu(o.text)}}function fe(s,d){if(1&s&&(e.TgZ(0,"span"),e.YNc(1,ue,2,3,"span",70),e.YNc(2,ge,2,2,"a",71),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngIf",!o.href),e.xp6(1),e.Q6J("ngIf",o.href)}}function me(s,d){if(1&s&&(e.TgZ(0,"div"),e.YNc(1,fe,3,2,"span",69),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngForOf",o)}}function pe(s,d){if(1&s&&(e.TgZ(0,"div",68),e.YNc(1,me,2,1,"div",69),e.qZA()),2&s){const o=e.oxw().$implicit;e.xp6(1),e.Q6J("ngForOf",o.content.msg)}}function xe(s,d){if(1&s&&(e.TgZ(0,"div",73),e._uU(1),e.qZA()),2&s){const o=e.oxw(2);e.xp6(1),e.hij(" ",o.lang.text.ChatRoom.YouReadHereLast,"")}}function ve(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",38),e.NdJ("click",function(){const a=e.CHM(o).$implicit,l=e.oxw();return e.KtG(l.message_detail(a))}),e.YNc(1,ie,3,1,"div",39),e.YNc(2,ne,7,3,"div",40),e.YNc(3,ae,2,1,"div",41),e.YNc(4,oe,2,1,"div",41),e.YNc(5,de,4,3,"div",42),e.YNc(6,he,3,1,"div",43),e.YNc(7,pe,2,1,"div",44),e.YNc(8,xe,2,1,"div",45),e.qZA()}if(2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngIf",o.showInfo&&o.showInfo.date),e.xp6(1),e.Q6J("ngIf",o.showInfo&&o.showInfo.sender),e.xp6(1),e.Q6J("ngIf",o.content.quickShare),e.xp6(1),e.Q6J("ngIf",o.content.match),e.xp6(1),e.Q6J("ngIf",o.content.filename),e.xp6(1),e.Q6J("ngIf",o.content.noti),e.xp6(1),e.Q6J("ngIf",o.content.msg),e.xp6(1),e.Q6J("ngIf",o.isLastRead)}}function be(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",52),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.quickShare_act(t))}),e._uU(1),e.qZA()}if(2&s){const o=e.oxw(2);e.xp6(1),e.hij(" ",o.lang.text.ChatRoom.QuickShare," ")}}function we(s,d){1&s&&e._UZ(0,"div",61)}function Ce(s,d){if(1&s&&(e.TgZ(0,"span",62),e._uU(1),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.hij(" ",o," ")}}function Te(s,d){if(1&s&&(e.TgZ(0,"div",57)(1,"p",58),e._uU(2),e.qZA(),e.YNc(3,we,1,0,"div",59),e.YNc(4,Ce,2,1,"span",60),e.qZA()),2&s){const o=e.oxw(2).$implicit,i=e.oxw();e.Akn(i.info.HideAutoThumbnail?"filter: blur(6px);":""),e.xp6(2),e.hij(" ",o.content.filename," "),e.xp6(1),e.Q6J("ngIf",o.content.text),e.xp6(1),e.Q6J("ngForOf",o.content.text)}}function ke(s,d){if(1&s&&(e.TgZ(0,"div",63),e._UZ(1,"img",64),e.qZA()),2&s){const o=e.oxw(2).$implicit,i=e.oxw();e.xp6(1),e.Akn(i.info.HideAutoThumbnail?"filter: blur(6px);":""),e.Q6J("src",o.content.thumbnail,e.LSH)("alt",o.content.filename)}}function Ie(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",53),e.NdJ("click",function(){e.CHM(o);const t=e.oxw().$implicit,a=e.oxw();return e.KtG(a.file_detail(t))}),e.YNc(1,Te,5,5,"div",54),e.YNc(2,ke,2,4,"div",55),e.qZA()}if(2&s){const o=e.oxw().$implicit;e.xp6(1),e.Q6J("ngIf",!o.content.thumbnail),e.xp6(1),e.Q6J("ngIf",o.content.thumbnail)}}function ye(s,d){if(1&s&&(e.TgZ(0,"span",76),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.xp6(1),e.hij(" ",o.text," ")}}function Me(s,d){if(1&s&&(e.TgZ(0,"a",77),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.Q6J("href",o.text,e.LSH),e.xp6(1),e.Oqu(o.text)}}function Re(s,d){if(1&s&&(e.TgZ(0,"span"),e.YNc(1,ye,2,1,"span",74),e.YNc(2,Me,2,2,"a",75),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngIf",!o.href),e.xp6(1),e.Q6J("ngIf",o.href)}}function Ze(s,d){if(1&s&&(e.TgZ(0,"div"),e.YNc(1,Re,3,2,"span",69),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngForOf",o)}}function Oe(s,d){if(1&s&&(e.TgZ(0,"div",68),e.YNc(1,Ze,2,1,"div",69),e.qZA()),2&s){const o=e.oxw().$implicit;e.xp6(1),e.Q6J("ngForOf",o.content.msg)}}function Pe(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",38),e.NdJ("click",function(){const a=e.CHM(o).$implicit,l=e.oxw();return e.KtG(l.message_detail(a))}),e.YNc(1,be,2,1,"div",41),e.YNc(2,Ie,3,2,"div",42),e.YNc(3,Oe,2,1,"div",44),e.qZA()}if(2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngIf",o.content.quickShare),e.xp6(1),e.Q6J("ngIf",o.content.filename),e.xp6(1),e.Q6J("ngIf",o.content.msg)}}function Se(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"tr",78),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.cancel_qrshare())}),e.TgZ(1,"td",79)(2,"span"),e._uU(3),e.qZA()()()}if(2&s){const o=e.oxw();e.xp6(3),e.Oqu(o.lang.text.Settings.quickQRshare)}}function Ae(s,d){if(1&s&&e._UZ(0,"img",85),2&s){const o=e.oxw(4);e.Q6J("src",o.userInput.file.thumbnail,e.LSH)("alt",o.userInput.file.name)}}function $e(s,d){if(1&s&&(e.TgZ(0,"div"),e.YNc(1,Ae,1,2,"img",84),e.qZA()),2&s){const o=e.oxw(3);e.xp6(1),e.Q6J("ngIf","image"==o.userInput.file.typeheader)}}function Ue(s,d){if(1&s&&(e.TgZ(0,"span"),e._uU(1),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.hij(" ",o," ")}}function Ve(s,d){if(1&s&&(e.TgZ(0,"div",86),e.YNc(1,Ue,2,1,"span",69),e.qZA()),2&s){const o=e.oxw(3);e.xp6(1),e.Q6J("ngForOf",o.userInput.file.thumbnail)}}function De(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",38),e.NdJ("click",function(){e.CHM(o);const t=e.oxw(2);return e.KtG(t.removeAttach())}),e.TgZ(1,"div",82),e._uU(2),e.qZA(),e.YNc(3,$e,2,1,"div",21),e.YNc(4,Ve,2,1,"div",83),e.qZA()}if(2&s){const o=e.oxw(2);e.xp6(2),e.hij(" ",o.userInput.file.filename," "),e.xp6(1),e.Q6J("ngIf",o.userInput.file.thumbnail),e.xp6(1),e.Q6J("ngIf","text"==o.userInput.file.typeheader)}}function Je(s,d){if(1&s&&(e.TgZ(0,"tr",80)(1,"td"),e.YNc(2,De,5,3,"div",81),e.qZA()()),2&s){const o=e.oxw();e.xp6(2),e.Q6J("ngIf",o.userInput.file)}}function Le(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"tr",78),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.init_chatroom())}),e.TgZ(1,"td",87),e._uU(2),e.qZA()()}if(2&s){const o=e.oxw();e.xp6(2),e.Oqu(o.lang.text.ChatRoom.GoToRecent)}}function Qe(s,d){if(1&s&&(e.TgZ(0,"span"),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.xp6(1),e.hij(" ",o.text," ")}}function Ne(s,d){if(1&s&&(e.TgZ(0,"a",72),e._uU(1),e.qZA()),2&s){const o=e.oxw().$implicit;e.Q6J("href",o.text,e.LSH),e.xp6(1),e.Oqu(o.text)}}function Fe(s,d){if(1&s&&(e.TgZ(0,"span"),e.YNc(1,Qe,2,1,"span",21),e.YNc(2,Ne,2,2,"a",71),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngIf",!o.href),e.xp6(1),e.Q6J("ngIf",o.href)}}function He(s,d){if(1&s&&(e.TgZ(0,"span"),e.YNc(1,Fe,3,2,"span",69),e.qZA()),2&s){const o=d.$implicit;e.xp6(1),e.Q6J("ngForOf",o)}}function qe(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"tr",78),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.init_chatroom())}),e.TgZ(1,"td",88)(2,"span")(3,"b"),e._uU(4),e.qZA()(),e.YNc(5,He,2,1,"span",69),e.qZA()()}if(2&s){const o=e.oxw();e.xp6(2),e.Akn("margin-right: 8px; color: #"+o.last_message_viewer.color),e.xp6(2),e.Oqu((o.last_message_viewer.is_me?o.nakama.users.self.display_name:o.nakama.users[o.isOfficial][o.target][o.last_message_viewer.user_id].display_name)||o.lang.text.Profile.noname_user),e.xp6(1),e.Q6J("ngForOf",o.last_message_viewer.message)}}function Ee(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"td")(1,"ion-button",89),e.NdJ("click",function(){e.CHM(o);const t=e.oxw();return e.KtG(t.GetSpeechToText())}),e._UZ(2,"ion-icon",90),e.qZA()()}}function Ye(s,d){if(1&s&&e._UZ(0,"ion-icon",95),2&s){const o=e.oxw().$implicit;e.Q6J("name",o.icon||"close-circle")}}function Be(s,d){if(1&s&&e._UZ(0,"img",96),2&s){const o=e.oxw().$implicit;e.Q6J("src","assets/icon/"+o.icon_img,e.LSH)("alt",o.title)}}function je(s,d){if(1&s){const o=e.EpF();e.TgZ(0,"div",91)(1,"div",92),e.NdJ("click",function(){const a=e.CHM(o).$implicit;return e.KtG(a.act())}),e.YNc(2,Ye,1,1,"ion-icon",93),e.YNc(3,Be,1,2,"img",94),e.qZA()()}if(2&s){const o=d.$implicit;e.xp6(1),e.Akn("cursor: "+(o.cursor||"pointer")+";"),e.Q6J("hidden",o.isHide),e.xp6(1),e.Q6J("ngIf",o.icon),e.xp6(1),e.Q6J("ngIf",o.icon_img)}}const Ge=[{path:"",component:(()=>{var s;class d{constructor(i,t,a,l,c,_,h,m,w,Z,S,ze,Xe,et,tt,it){var k,r=this;this.modalCtrl=i,this.navCtrl=t,this.route=a,this.router=l,this.nakama=c,this.noti=_,this.statusBar=h,this.indexed=m,this.lang=w,this.sanitizer=Z,this.global=S,this.loadingCtrl=ze,this.webrtc=Xe,this.p5toast=et,this.mClipboard=tt,this.alertCtrl=it,this.info={},this.foundLastRead=!1,this.messages=[],this.sending_msg=[],this.temporary_open_thumbnail={},this.extended_buttons=[{icon:"settings-outline",act:()=>{3!=this.info.redirect.type?this.extended_buttons[0].isHide=!0:this.lock_modal_open||(this.lock_modal_open=!0,this.modalCtrl.create({component:Y.x,componentProps:{info:this.nakama.groups[this.isOfficial][this.target][this.info.group_id],server:{isOfficial:this.isOfficial,target:this.target}}}).then(k=>{k.onWillDismiss().then(C=>{C.data&&(this.extended_buttons.forEach(R=>{R.isHide=!0}),this.extended_buttons[0].isHide=!1,this.extended_buttons[6].isHide=!1,this.extended_buttons[9].isHide=!1)}),k.onDidDismiss().then(()=>{this.ionViewDidEnter()}),this.removeShortCutKey(),k.present(),this.lock_modal_open=!1}))}},{icon:"image-outline",isHide:!0,act:()=>{document.getElementById("local_channel").click()}},{icon:"document-attach-outline",act:(k=(0,v.Z)(function*(){r.userInputTextArea||(r.userInputTextArea=document.getElementById(r.ChannelUserInputId)),yield r.NewAttach.open(),r.removeShortCutKey(),r.global.p5key.KeyShortCut.Digit=C=>{let R=["image","link","inapp","load"];!r.isHidden&&document.activeElement!=document.getElementById(r.ChannelUserInputId)&&R.length>C&&r.new_attach({detail:{value:R[C]}})}}),function(){return k.apply(this,arguments)})},{icon:"camera-outline",act:function(){var k=(0,v.Z)(function*(){try{const C=yield U.V1.getPhoto({quality:90,resultType:U.dk.Base64,source:U.oK.Camera});let R=yield r.loadingCtrl.create({message:r.lang.text.TodoDetail.WIP});R.present(),r.userInputTextArea||(r.userInputTextArea=document.getElementById(r.ChannelUserInputId)),r.userInput.file={},r.userInput.file.filename=`Camera_${(new Date).toLocaleString().replace(/:/g,"_")}.${C.format}`,r.userInput.file.file_ext=C.format,r.userInput.file.thumbnail=r.sanitizer.bypassSecurityTrustUrl("data:image/jpeg;base64,"+C.base64String),r.userInput.file.type=`image/${C.format}`,r.userInput.file.typeheader="image",r.userInput.file.content_related_creator=[{user_id:r.info.local?"local":r.nakama.servers[r.isOfficial][r.target].session.user_id,timestamp:(new Date).getTime(),display_name:r.nakama.users.self.display_name,various:"camera"}],r.userInput.file.content_creator={user_id:r.info.local?"local":r.nakama.servers[r.isOfficial][r.target].session.user_id,timestamp:(new Date).getTime(),display_name:r.nakama.users.self.display_name,various:"camera"},yield r.indexed.saveBase64ToUserPath("data:image/jpeg;base64,"+C.base64String,`tmp_files/chatroom/${r.userInput.file.filename}`,q=>{r.userInput.file.blob=new Blob([q],{type:r.userInput.file.type})}),R.dismiss()}catch{}});return function(){return k.apply(this,arguments)}}()},{icon:"server-outline",act:()=>{this.modalCtrl.create({component:j.b}).then(k=>{k.onDidDismiss().then(C=>{C.data?(this.userInput.quickShare=C.data,this.inputPlaceholder=this.lang.text.ChatRoom.QuickShare_placeholder):this.cancel_qrshare(),this.ionViewDidEnter()}),this.removeShortCutKey(),k.present()})}},{icon:"call-outline",act:function(){var k=(0,v.Z)(function*(){try{yield r.webrtc.initialize("audio",void 0,{isOfficial:r.isOfficial,target:r.target,channel_id:r.info.id,user_id:r.info.info.id||r.info.info.user_id}),r.webrtc.CurrentMatch=yield r.nakama.servers[r.isOfficial][r.target].socket.createMatch(),yield r.nakama.servers[r.isOfficial][r.target].socket.writeChatMessage(r.info.id,{match:r.webrtc.CurrentMatch.match_id}),r.scroll_down_logs(),r.webrtc.CreateOfffer()}catch(C){console.log("webrtc \uc2dc\uc791\ub2e8\uacc4 \uc624\ub958: ",C)}});return function(){return k.apply(this,arguments)}}()},{isHide:!1,icon:"documents-outline",act:()=>{this.modalCtrl.create({component:H.P,componentProps:{path:`/${this.info.id}/files/`}}).then(k=>{k.onWillDismiss().then(function(){var C=(0,v.Z)(function*(R){R.data&&r.selected_blobFile_callback_act(R.data)});return function(R){return C.apply(this,arguments)}}()),k.onDidDismiss().then(()=>{this.is_modal=!1,this.ionViewDidEnter()}),this.is_modal=!0,k.present()})}},{icon:"volume-mute-outline",act:function(){var k=(0,v.Z)(function*(){r.toggle_speakermode()});return function(){return k.apply(this,arguments)}}()},{icon:"log-out-outline",act:function(){var k=(0,v.Z)(function*(){if(3!=r.info.redirect.type)try{yield r.nakama.remove_group_list(r.nakama.groups[r.isOfficial][r.target][r.info.group_id]||r.info.info,r.isOfficial,r.target,!1),yield r.nakama.servers[r.isOfficial][r.target].socket.leaveChat(r.info.id),r.nakama.channels_orig[r.isOfficial][r.target][r.info.id].status="missing",r.extended_buttons.forEach(C=>{C.isHide=!0}),r.extended_buttons[6].isHide=!1,r.extended_buttons[9].isHide=!1}catch(C){console.error("\ucc44\ub110\uc5d0\uc11c \ub098\uc624\uae30 \uc2e4\ud328: ",C)}else r.extended_buttons[8].isHide=!0;r.ionViewDidEnter()});return function(){return k.apply(this,arguments)}}()},{isHide:!0,icon:"close-circle-outline",act:()=>{this.alertCtrl.create({header:this.lang.text.ChatRoom.RemoveChannel,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.ChatRoom.Delete,handler:function(){var k=(0,v.Z)(function*(){let C=yield r.loadingCtrl.create({message:r.lang.text.TodoDetail.WIP});switch(C.present(),delete r.nakama.channels_orig[r.isOfficial][r.target][r.info.id],r.info.redirect.type){case 3:yield r.nakama.remove_group_list(r.nakama.groups[r.isOfficial][r.target][r.info.group_id]||r.info.info,r.isOfficial,r.target);break;case 0:yield r.indexed.removeFileFromUserPath(`servers/${r.isOfficial}/${r.target}/groups/${r.info.id}.img`)}try{delete r.nakama.groups[r.isOfficial][r.target][r.info.group_id]}catch(A){console.log("DeleteGroupFailed: ",A)}r.nakama.remove_channel_files(r.isOfficial,r.target,r.info.id),r.nakama.save_groups_with_less_info();let R=yield r.indexed.GetFileListFromDB(`servers/${r.isOfficial}/${r.target}/channels/${r.info.id}`);for(let A=0,q=R.length;A<q;A++)C.message=`${r.lang.text.UserFsDir.DeleteFile}: ${q-A}`,yield r.indexed.removeFileFromUserPath(R[A]);C.dismiss(),r.navCtrl.pop()});return function(){return k.apply(this,arguments)}}()}]}).then(k=>k.present())}}],this.is_modal=!1,this.next_cursor="",this.prev_cursor="",this.file_sel_id="file_sel_id",this.ShowGoToBottom=!1,this.isMobile=!1,this.last_message_viewer={user_id:void 0,message:void 0,color:void 0,is_me:void 0},this.userInput={file:void 0,quickShare:void 0,text:""},this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder,this.pullable=!0,this.ViewableMessage=[],this.ViewMsgIndex=0,this.RefreshCount=15,this.ViewCount=45,this.ShowRecentMsg=!1,this.useSpeaker=!1,this.isSpeeching=!1,this.SpeechThese=[],this.isHistoryLoaded=!1,this.LocalHistoryList=[],this.isHidden=!0,this.ChannelUserInputId="ChannelUserInputId",this.lock_modal_open=!1}add_shortcut(){this.is_modal||this.ionViewDidEnter()}ionViewDidEnter(){this.nakama.resumeBanner(),this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.global.p5key.KeyShortCut.BottomTab=t=>{document.activeElement!=document.getElementById(this.ChannelUserInputId)&&"E"===t&&this.open_ext_with_delay()};let i=[];for(let t=0,a=this.extended_buttons.length;t<a;t++)this.extended_buttons[t].isHide||i.push(this.extended_buttons[t]);this.global.p5key.KeyShortCut.Digit=t=>{!this.isHidden&&document.activeElement!=document.getElementById(this.ChannelUserInputId)&&i.length>t&&i[t].act()},this.global.p5key.KeyShortCut.EnterAct=()=>{document.activeElement!=document.getElementById(this.ChannelUserInputId)&&setTimeout(()=>{this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),this.userInputTextArea.focus()},0)}}new_attach(i){var t=this;return(0,v.Z)(function*(){switch(i.detail.value){case"load":t.userInputTextArea||(t.userInputTextArea=document.getElementById(t.ChannelUserInputId)),document.getElementById(t.file_sel_id).click();break;case"image":t.userInputTextArea||(t.userInputTextArea=document.getElementById(t.ChannelUserInputId));let l,a={};if(t.userInput.file&&"image"==t.userInput.file.typeheader)try{t.userInput.file.url&&(t.userInput.file.blob=yield fetch(t.userInput.file.url).then(h=>h.blob()));let c=`tmp_files/chatroom/attached.${t.userInput.file.file_ext}`;yield t.indexed.saveBlobToUserPath(t.userInput.file.blob,c,void 0,t.indexed.godotDB);let _=document.getElementById("ChatroomSelectedImage");a.path=c,a.width=_.naturalWidth,a.height=_.naturalHeight,l=t.userInput.file.content_related_creator}catch(c){return void t.p5toast.show({text:`${t.lang.text.ContentViewer.CannotEditFile}: ${c}`})}t.modalCtrl.create({component:Q.$,componentProps:a}).then(c=>{c.onWillDismiss().then(function(){var _=(0,v.Z)(function*(h){h.data&&(yield t.voidDraw_fileAct_callback(h,l))});return function(h){return _.apply(this,arguments)}}()),c.onDidDismiss().then(()=>{t.is_modal=!1,t.ionViewDidEnter()}),t.is_modal=!0,c.present()});break;case"link":try{let c;try{c=yield t.mClipboard.paste()}catch{try{c=yield K.Z.read()}catch(m){throw m}}let _={};_.url=c,_.content_related_creator=[{user_id:t.info.local?"local":t.nakama.servers[t.isOfficial][t.target].session.user_id,timestamp:(new Date).getTime(),display_name:t.nakama.users.self.display_name,various:"link"}],_.content_creator={user_id:t.info.local?"local":t.nakama.servers[t.isOfficial][t.target].session.user_id,timestamp:(new Date).getTime(),display_name:t.nakama.users.self.display_name,various:"link"},_.file_ext=_.url.split(".").pop().split("?").shift(),_.filename=`${t.lang.text.ChatRoom.ExternalLinkFile}.${_.file_ext}`,t.global.set_viewer_category_from_ext(_),_.type="",_.typeheader=_.viewer,t.global.modulate_thumbnail(_,_.url),t.NeedScrollDown()&&setTimeout(()=>{t.scroll_down_logs()},100),t.userInput.file=_,t.inputPlaceholder=`(${t.lang.text.ChatRoom.FileLink}: ${t.userInput.file.filename})`}catch(c){t.p5toast.show({text:`${t.lang.text.ChatRoom.FailedToPasteData}: ${c}`})}break;case"inapp":t.modalCtrl.create({component:H.P}).then(c=>{c.onWillDismiss().then(function(){var _=(0,v.Z)(function*(h){h.data&&t.selected_blobFile_callback_act(h.data)});return function(h){return _.apply(this,arguments)}}()),c.onDidDismiss().then(()=>{t.is_modal=!1,t.ionViewDidEnter()}),t.is_modal=!0,c.present()})}t.NewAttach.value=""})()}toggle_speakermode(i){var t=this;return(0,v.Z)(function*(){if(t.useSpeaker=null!=i?i:!t.useSpeaker,t.extended_buttons[7].icon=t.useSpeaker?"volume-high-outline":"volume-mute-outline",!t.useSpeaker)try{yield F.w.stop()}catch{}})()}cancel_qrshare(){delete this.userInput.quickShare,this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder}inputFileSelected(i){var t=this;return(0,v.Z)(function*(){if(i.target.files.length)if(1!=i.target.files.length)(yield t.alertCtrl.create({header:t.lang.text.ChatRoom.MultipleSend,message:`${t.lang.text.ChatRoom.CountFile}: ${i.target.files.length}`,buttons:[{text:t.lang.text.ChatRoom.Send,handler:(c=(0,v.Z)(function*(){let _=yield t.loadingCtrl.create({message:t.lang.text.ChatRoom.MultipleSend});_.present(),t.noti.noti.schedule({id:7,title:t.lang.text.ChatRoom.MultipleSend,progressBar:{indeterminate:!0},sound:null,smallIcon:"res://diychat",color:"b0b0b0"});for(let h=0,m=i.target.files.length;h<m;h++)_.message=`${t.lang.text.ChatRoom.MultipleSend}: ${m-h}`,t.noti.noti.schedule({id:7,title:t.lang.text.ChatRoom.MultipleSend,progressBar:{value:h,maxValue:m},sound:null,smallIcon:"res://diychat",color:"b0b0b0"}),yield t.selected_blobFile_callback_act(i.target.files[h]),yield t.send();t.noti.ClearNoti(7),_.dismiss(),setTimeout(()=>{t.scroll_down_logs()},300)}),function(){return c.apply(this,arguments)})}]})).present();else{let l=yield t.loadingCtrl.create({message:t.lang.text.TodoDetail.WIP});l.present(),yield t.selected_blobFile_callback_act(i.target.files[0]),l.dismiss()}else delete t.userInput.file,t.inputPlaceholder=t.lang.text.ChatRoom.input_placeholder;var c})()}LocalChannelImageChanged(i){var t=this;return(0,v.Z)(function*(){let a=yield t.global.GetBase64ThroughFileReader(i.target.files[0]);t.nakama.limit_image_size(a,l=>{t.info.info.img=l.canvas.toDataURL(),t.indexed.saveTextFileToUserPath(t.info.info.img,`servers/${t.info.server.isOfficial}/${t.info.server.target}/groups/${t.info.id}.img`),t.p5toast.show({text:t.lang.text.ChatRoom.LocalImageChanged})})})()}ngOnInit(){var i=this;this.ChatLogs=document.getElementById("chatroom_div"),this.ChatLogs.onscroll=t=>{Math.abs(this.ChatLogs.scrollHeight-(this.ChatLogs.scrollTop+this.ChatLogs.clientHeight))<1&&(this.ShowGoToBottom||this.ShowRecentMsg||this.init_last_message_viewer(),this.ShowRecentMsg&&this.pull_msg_history(!1)),this.ShowGoToBottom=this.ChatLogs.scrollHeight-220>this.ChatLogs.scrollTop+this.ChatLogs.clientHeight},this.nakama.ChatroomLinkAct=function(){var t=(0,v.Z)(function*(a,l){delete i.nakama.channels_orig[i.isOfficial][i.target][i.info.id].update,i.info=a,yield i.init_chatroom(),i.userInput.file=l,i.userInput.file&&i.create_selected_thumbnail()});return function(a,l){return t.apply(this,arguments)}}(),this.route.queryParams.subscribe(function(){var t=(0,v.Z)(function*(a){const l=i.router.getCurrentNavigation().extras.state;l&&(i.info=l.info),yield new Promise(c=>setTimeout(c,100)),yield i.init_chatroom(),i.userInput.file=l.file,i.userInput.file&&i.create_selected_thumbnail()});return function(a){return t.apply(this,arguments)}}()),"DesktopPWA"==O.n$&&setTimeout(()=>{this.CreateDrop()},0),this.isMobile="Android"==O.n$||"iOS"==O.n$}GetSpeechToText(){var i=this;return(0,v.Z)(function*(){let t=yield W.M.start({language:i.lang.lang,maxResults:1,prompt:i.lang.text.ChatRoom.TalkMessage,partialResults:!0,popup:!0});i.userInput.text=t.matches[0]})()}CreateDrop(){var i=this;let t=document.getElementById("p5Drop_chatroom");this.p5canvas=new J(a=>{a.setup=()=>{let m=a.createCanvas(t.clientWidth,t.clientHeight);m.parent(t),a.pixelDensity(1),m.drop(w=>{let Z=a.millis();_<Z-400?(c=!1,h.length=0,h.push(w)):(c=!0,h.push(w)),_=Z,clearTimeout(l),l=setTimeout((0,v.Z)(function*(){if(c)i.alertCtrl.create({header:i.lang.text.ChatRoom.MultipleSend,message:`${i.lang.text.ChatRoom.CountFile}: ${h.length}`,buttons:[{text:i.lang.text.ChatRoom.Send,handler:()=>{i.DropSendAct(h)}}]}).then(S=>S.present());else{let S=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});S.present(),i.selected_blobFile_callback_act(w.file),S.dismiss()}}),400)})};let l,c=!1,_=0,h=[];a.mouseMoved=m=>{m.dataTransfer?(t.style.pointerEvents="all",t.style.backgroundColor="#0008"):(t.style.pointerEvents="none",t.style.backgroundColor="transparent")}})}DropSendAct(i){var t=this;return(0,v.Z)(function*(){let a=yield t.loadingCtrl.create({message:t.lang.text.TodoDetail.WIP});a.present();for(let l=0,c=i.length;l<c;l++)yield t.selected_blobFile_callback_act(i[l].file),yield t.send();a.dismiss(),setTimeout(()=>{t.scroll_down_logs()},300)})()}selected_blobFile_callback_act(i,t=[],a="loaded"){var l=this;return(0,v.Z)(function*(){l.userInput.file={},l.userInput.file.filename=i.name,l.userInput.file.file_ext=i.name.split(".").pop()||i.type||l.lang.text.ChatRoom.unknown_ext,l.userInput.file.size=i.size,l.userInput.file.type=i.type,l.userInput.file.content_related_creator=[...t,{user_id:l.info.local?"local":l.nakama.servers[l.isOfficial][l.target].session.user_id,timestamp:(new Date).getTime(),display_name:l.nakama.users.self.display_name,various:a}],l.userInput.file.content_creator={user_id:l.info.local?"local":l.nakama.servers[l.isOfficial][l.target].session.user_id,timestamp:(new Date).getTime(),display_name:l.nakama.users.self.display_name,various:a},l.userInput.file.blob=i,l.create_selected_thumbnail(),l.inputPlaceholder=`(${l.lang.text.ChatRoom.attachments}: ${l.userInput.file.filename})`})()}create_selected_thumbnail(){var i=this;return(0,v.Z)(function*(){try{if(i.userInput.file.blob.user_fs){if(i.global.set_viewer_category_from_ext(i.userInput.file),i.userInput.file.url)return i.userInput.file.thumbnail=i.userInput.file.url,void(i.userInput.file.typeheader=i.userInput.file.viewer);i.userInput.file.thumbnail=yield i.indexed.loadBlobFromUserPath(i.userInput.file.path,i.userInput.file.type)}}catch{}let t=URL.createObjectURL(i.userInput.file.blob);switch(i.userInput.file.typeheader=i.userInput.file.blob.type.split("/")[0]||i.userInput.file.viewer,setTimeout(()=>{URL.revokeObjectURL(t)},0),i.userInput.file.thumbnail=void 0,i.userInput.file.typeheader){case"image":i.userInput.file.thumbnail=i.sanitizer.bypassSecurityTrustUrl(t);break;case"text":new J(a=>{a.setup=()=>{a.noCanvas(),a.loadStrings(t,l=>{i.userInput.file.thumbnail=l,a.remove()},l=>{console.error("\ubb38\uc790\uc5f4 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",l),a.remove()})}})}})()}init_chatroom(){var i=this;return(0,v.Z)(function*(){switch(i.nakama.OnTransferMessage={},i.ViewableMessage.length=0,i.ViewMsgIndex=0,i.ShowGoToBottom=!1,i.ShowRecentMsg=!1,i.isHistoryLoaded=!1,i.LocalHistoryList.length=0,i.messages.length=0,i.prev_cursor="",i.next_cursor="",i.pullable=!0,i.toggle_speakermode(!1),i.init_last_message_viewer(),i.file_sel_id=`chatroom_${i.info.id}_${(new Date).getTime()}`,i.ChannelUserInputId=`chatroom_input_${i.info.id}_${(new Date).getTime()}`,i.noti.Current=i.info.cnoti_id,i.info.cnoti_id&&i.noti.ClearNoti(i.info.cnoti_id),i.noti.RemoveListener(`openchat${i.info.cnoti_id}`),i.isOfficial=i.info.server.isOfficial,i.target=i.info.server.target,i.info=i.nakama.channels_orig[i.isOfficial][i.target][i.info.id],i.nakama.opened_page_info.channel={isOfficial:i.isOfficial,target:i.target,id:i.info.id},i.foundLastRead=i.info.last_read_id==i.info.last_comment_id,i.info.redirect.type){case 2:"missing"!=i.info.status&&(i.info.redirect?"online"==i.statusBar.groupServer[i.isOfficial][i.target]&&(i.info.status=i.nakama.load_other_user(i.info.redirect.id,i.isOfficial,i.target).online?"online":"pending"):i.info.status=i.info.info.online?"online":"pending",delete i.extended_buttons[6].isHide,i.extended_buttons[0].isHide=!0,i.extended_buttons[5].isHide="http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")||!1);break;case 3:"missing"!=i.info.status&&(yield i.nakama.load_groups(i.isOfficial,i.target,i.info.group_id)),i.extended_buttons[8].isHide=!0,delete i.extended_buttons[0].isHide,i.extended_buttons[5].isHide=!0;break;case 0:i.extended_buttons.forEach(t=>{t.isHide=!0}),i.extended_buttons[1].isHide=!1,i.extended_buttons[2].isHide=!1,i.extended_buttons[3].isHide=!1,i.extended_buttons[6].isHide=!1,i.extended_buttons[7].isHide=!1,i.extended_buttons[9].isHide=!1}i.nakama.channels_orig[i.isOfficial][i.target]&&i.nakama.channels_orig[i.isOfficial][i.target][i.info.id]&&"missing"!=i.info.status&&(i.nakama.channels_orig[i.isOfficial][i.target][i.info.id].update=t=>{let a="local"==t.sender_id;a||i.nakama.check_sender_and_show_name(t,i.isOfficial,i.target),t.content.filename&&i.ModulateFileEmbedMessage(t),i.info.last_read_id=i.info.last_comment_id,i.nakama.save_channels_with_less_info(),a||i.check_if_send_msg(t),i.messages.push(t),i.ViewMsgIndex+i.ViewCount==i.messages.length-1&&i.ViewMsgIndex++,i.ViewableMessage=i.messages.slice(i.ViewMsgIndex,i.ViewMsgIndex+i.ViewCount),i.modulate_chatmsg(0,i.ViewableMessage.length),i.modulate_chatmsg(i.ViewableMessage.length-1,i.ViewableMessage.length),i.ShowRecentMsg=i.messages.length>i.ViewMsgIndex+i.ViewCount,i.useSpeaker&&i.SpeechReceivedMessage(t),setTimeout(()=>{i.info.is_new=!1,i.nakama.has_new_channel_msg=!1,i.NeedScrollDown()&&!i.ShowRecentMsg?(i.init_last_message_viewer(),i.ChatLogs.scrollTo({top:i.ChatLogs.scrollHeight,behavior:"smooth"})):(i.last_message_viewer.is_me=!!i.info.local||t.sender_id==i.nakama.servers[i.isOfficial][i.target].session.user_id,i.last_message_viewer.user_id=t.sender_id,i.last_message_viewer.message=t.content.msg,i.last_message_viewer.color=t.color)},0)}),(void 0===i.info.status||"missing"==i.info.status)&&(i.extended_buttons.forEach(t=>{t.isHide=!0}),i.extended_buttons[6].isHide=!1,i.extended_buttons[9].isHide=!1,3==i.info.redirect.type&&(i.extended_buttons[0].isHide=!1)),i.extended_buttons[7].isHide=O.bS||"missing"==i.info.status,i.pull_msg_history(),setTimeout(()=>{i.ChatLogs.scrollTo({top:i.ChatLogs.scrollHeight,behavior:"smooth"})},500)})()}init_last_message_viewer(){delete this.last_message_viewer.user_id,delete this.last_message_viewer.message,delete this.last_message_viewer.color,delete this.last_message_viewer.is_me}NeedScrollDown(){return this.ChatLogs.scrollHeight<this.ChatLogs.scrollTop+this.ChatLogs.clientHeight+200}scroll_down_logs(){this.ShowRecentMsg||this.init_last_message_viewer(),this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})}check_if_send_msg(i){for(let t=0,a=this.sending_msg.length;t<a;t++)if(i.sender_id==this.nakama.servers[this.isOfficial][this.target].session.user_id&&i.content.local_comp==this.sending_msg[t].content.local_comp){i.content.filename&&this.auto_open_thumbnail(i),this.sending_msg.splice(t,1);break}}auto_open_thumbnail(i){try{this.temporary_open_thumbnail[i.message_id]()}catch{this.temporary_open_thumbnail[i.message_id]=()=>{this.indexed.loadBlobFromUserPath(`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${i.message_id}.${i.content.file_ext}`,i.content.type,a=>{i.content.path=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${i.message_id}.${i.content.file_ext}`;let l=URL.createObjectURL(a);this.global.modulate_thumbnail(i.content,l),this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100),this.nakama.WriteStorage_From_channel(i,i.content.path,this.isOfficial,this.target)}),delete this.temporary_open_thumbnail[i.message_id]}}}removeAttach(){delete this.userInput.file,this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder}pull_msg_history(i=!0){var t=this;return(0,v.Z)(function*(){if(t.pullable||!i)if(t.pullable=!1,i)try{if(t.info.local)throw"Local channel";if(void 0===t.info.status||"missing"==t.info.status)throw"Channel missing";if(0!=t.ViewMsgIndex){let a=Math.min(t.ViewMsgIndex,t.RefreshCount);t.ViewMsgIndex-=a,t.ViewableMessage=t.messages.slice(t.ViewMsgIndex,t.ViewMsgIndex+t.ViewCount);for(let l=0;l<a;l++)try{let c=yield t.indexed.loadBlobFromUserPath(t.ViewableMessage[l].content.path,t.ViewableMessage[l].content.file_ext),_=URL.createObjectURL(c);t.global.modulate_thumbnail(t.ViewableMessage[l].content,_)}catch{}return t.modulate_chatmsg(0,t.ViewableMessage.length),t.ShowRecentMsg=t.messages.length>t.ViewMsgIndex+t.ViewCount,void(t.pullable=!0)}yield t.nakama.servers[t.isOfficial][t.target].client.listChannelMessages(t.nakama.servers[t.isOfficial][t.target].session,t.info.id,t.RefreshCount,!1,t.next_cursor).then(a=>{t.info.is_new=!1,a.messages.forEach(l=>{l=t.nakama.modulation_channel_message(l,t.isOfficial,t.target),t.nakama.check_sender_and_show_name(l,t.isOfficial,t.target),t.info.last_comment||(t.info.last_comment=(l.content.filename?`(${t.lang.text.ChatRoom.attachments}) `:"")+(l.content.msg||l.content.noti||"")),!t.foundLastRead&&t.info.last_read_id?t.info.last_read_id==l.message_id&&(l.isLastRead=!0,t.foundLastRead=!0,t.info.last_read_id=t.info.last_comment_id,t.nakama.save_channels_with_less_info()):t.foundLastRead=!0,t.nakama.translate_updates(l),l.content.filename&&t.ModulateFileEmbedMessage(l),t.nakama.ModulateTimeDate(l),t.nakama.content_to_hyperlink(l),t.messages.unshift(l),t.ViewableMessage=t.messages.slice(t.ViewMsgIndex,t.ViewMsgIndex+t.ViewCount),t.modulate_chatmsg(0,t.ViewableMessage.length)}),t.ShowRecentMsg=t.messages.length>t.ViewMsgIndex+t.ViewCount,t.next_cursor=a.next_cursor,t.prev_cursor=a.prev_cursor,t.pullable=!0,t.nakama.saveListedMessage(t.messages,t.info,t.isOfficial,t.target)})}catch{if(3==t.info.redirect.type&&t.nakama.groups[t.isOfficial][t.target]&&t.nakama.groups[t.isOfficial][t.target][t.info.group_id]&&!t.nakama.groups[t.isOfficial][t.target][t.info.group_id].open){let l=[{content:{msg:[{text:t.lang.text.ChatRoom.closed_group_must_online}]}},{content:{msg:[{text:t.lang.text.ChatRoom.closed_group_not_allow}]}}];return t.next_cursor=void 0,t.isHistoryLoaded=!0,void l.forEach(c=>t.messages.push(c))}t.LoadLocalChatHistory()}else{let a=t.messages.length-t.ViewMsgIndex-t.ViewCount;t.ShowRecentMsg=0!=a,t.ViewMsgIndex+=Math.min(t.RefreshCount,a),t.ViewableMessage=t.messages.slice(t.ViewMsgIndex,t.ViewMsgIndex+t.ViewCount);for(let l=t.ViewableMessage.length-1;l>=0;l--){try{let c=yield t.indexed.loadBlobFromUserPath(t.ViewableMessage[l].content.path,t.ViewableMessage[l].content.file_ext),_=URL.createObjectURL(c);t.global.modulate_thumbnail(t.ViewableMessage[l].content,_)}catch{}t.modulate_chatmsg(l,t.ViewableMessage.length)}t.pullable=!0}})()}SpeechReceivedMessage(i){let t=JSON.parse(JSON.stringify(i.content.msg)),a="";for(let l=0,c=t.length;l<c;l++)for(let _=0,h=t[l].length;_<h;_++)a+=t[l][_].text+" ";this.SpeechThese.push(a),this.isSpeeching||this.SpeechingTexts()}SpeechingTexts(){var i=this;return(0,v.Z)(function*(){let t=i.SpeechThese.shift();i.isSpeeching=!0,yield F.w.speak({text:t,lang:i.lang.lang}),i.SpeechThese.length?i.SpeechingTexts():i.isSpeeching=!1})()}LoadLocalChatHistory(){var i=this;return(0,v.Z)(function*(){if(i.ViewMsgIndex>0){let t=Math.min(i.ViewableMessage.length,Math.min(i.ViewMsgIndex,i.RefreshCount));i.ViewMsgIndex-=t,i.ViewableMessage=i.messages.slice(i.ViewMsgIndex,i.ViewMsgIndex+i.ViewCount);for(let a=t-1;a>=0;a--){try{let l=yield i.indexed.loadBlobFromUserPath(i.ViewableMessage[a].content.path,i.ViewableMessage[a].content.file_ext),c=URL.createObjectURL(l);i.global.modulate_thumbnail(i.ViewableMessage[a].content,c)}catch{}i.modulate_chatmsg(a,t)}return i.ShowRecentMsg=i.messages.length>i.ViewMsgIndex+i.ViewCount,void(i.pullable=0!=i.ViewMsgIndex||!!i.LocalHistoryList.length)}i.isHistoryLoaded?i.indexed.loadTextFromUserPath(i.LocalHistoryList.pop(),function(){var t=(0,v.Z)(function*(a,l){if(a&&l){let c=JSON.parse(l.trim());for(let h=c.length-1;h>=0;h--)i.nakama.translate_updates(c[h]),c[h]=i.nakama.modulation_channel_message(c[h],i.isOfficial,i.target),i.nakama.ModulateTimeDate(c[h]),i.messages.unshift(c[h]);i.ViewMsgIndex=Math.max(0,c.length-i.RefreshCount),i.ViewableMessage=i.messages.slice(i.ViewMsgIndex,i.ViewMsgIndex+i.ViewCount);let _=Math.min(Math.min(c.length,i.RefreshCount),i.ViewableMessage.length);for(let h=_-1;h>=0;h--){try{let m=yield i.indexed.loadBlobFromUserPath(i.ViewableMessage[h].content.path,i.ViewableMessage[h].content.file_ext),w=URL.createObjectURL(m);i.global.modulate_thumbnail(i.ViewableMessage[h].content,w)}catch{}i.modulate_chatmsg(h,_)}i.ShowRecentMsg=i.messages.length>i.ViewMsgIndex+i.ViewCount}else a&&i.LoadLocalChatHistory();i.pullable=!!i.LocalHistoryList.length});return function(a,l){return t.apply(this,arguments)}}()):i.indexed.GetFileListFromDB(`servers/${i.isOfficial}/${i.target}/channels/${i.info.id}/chats/`,t=>{i.LocalHistoryList=t,i.isHistoryLoaded=!0,i.LocalHistoryList.length&&i.indexed.loadTextFromUserPath(i.LocalHistoryList.pop(),function(){var a=(0,v.Z)(function*(l,c){if(l&&c){let _=JSON.parse(c.trim());for(let h=_.length-1;h>=0;h--)i.nakama.translate_updates(_[h]),i.info.local||(_[h]=i.nakama.modulation_channel_message(_[h],i.isOfficial,i.target)),i.nakama.ModulateTimeDate(_[h]),i.messages.unshift(_[h]);i.ViewMsgIndex=Math.max(0,i.messages.length-i.RefreshCount),i.ViewableMessage=i.messages.slice(i.ViewMsgIndex,i.ViewMsgIndex+i.RefreshCount),i.modulate_chatmsg(0,_.length);for(let h=i.ViewableMessage.length-1;h>=0;h--){try{let m=yield i.indexed.loadBlobFromUserPath(i.ViewableMessage[h].content.path,i.ViewableMessage[h].content.file_ext),w=URL.createObjectURL(m);i.global.modulate_thumbnail(i.ViewableMessage[h].content,w)}catch{}i.modulate_chatmsg(h,i.ViewableMessage.length)}}i.next_cursor=null,i.pullable=!0});return function(l,c){return a.apply(this,arguments)}}())})})()}open_ext_with_delay(){this.ScrollNearLogs(),this.isHidden=!this.isHidden}make_ext_hidden(){this.ScrollNearLogs(),"DesktopPWA"!=O.n$&&(this.isHidden=!0)}ScrollNearLogs(){this.NeedScrollDown()&&(this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"}),setTimeout(()=>{this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})},150))}check_key(i){this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),"DesktopPWA"==O.n$?"Enter"!=i.key||i.shiftKey||"keydown"!=i.type?setTimeout(()=>{this.userInputTextArea.style.height="36px",this.userInputTextArea.style.height=this.userInputTextArea.scrollHeight+"px"},0):this.send(!0):setTimeout(()=>{this.userInputTextArea.style.height="36px",this.userInputTextArea.style.height=this.userInputTextArea.scrollHeight+"px"},0)}send(i=!1){var t=this;return(0,v.Z)(function*(){if(i&&("Android"==O.n$||"iOS"==O.n$))return;if(t.userInputTextArea||(t.userInputTextArea=document.getElementById(t.ChannelUserInputId)),!t.userInput.text.trim()&&!t.userInput.file&&!t.userInput.quickShare)return void setTimeout(()=>{t.userInput.text="",t.userInputTextArea.style.height="36px"},0);t.userInputTextArea.focus(),t.isHidden=!0;let a={};a.msg=t.userInput.text;let l=!1,c=!1,_="";if(t.userInput.file){a.filename=t.userInput.file.filename,a.file_ext=t.userInput.file.file_ext,a.type=t.userInput.file.type;try{a.filesize=t.userInput.file.size||t.userInput.file.blob.size,a.partsize=Math.ceil(a.filesize/N.In)}catch{a.url=t.userInput.file.url,c=!0}a.msg.length>800?(_=a.msg,delete a.msg):a.msg=a.msg,a.content_creator=t.userInput.file.content_creator,a.content_related_creator=t.userInput.file.content_related_creator,l=!0;for(let m=0,w=a.content_related_creator.length;m<w;m++)delete a.content_related_creator[m].is_me,delete a.content_related_creator[m].timeDisplay,delete a.content_related_creator[m].various_display}else if(a.msg.length>800)return void t.LongTextMessageAsFile(a);t.userInput.quickShare&&(a.quickShare=t.userInput.quickShare),a.local_comp=Math.random();let h={content:JSON.parse(JSON.stringify(a))};if(t.nakama.content_to_hyperlink(h),t.info.local){let m=(new Date).getTime().toString();if(l&&!c){let S=`servers/${t.isOfficial}/${t.target}/channels/${t.info.id}/files/msg_${m}.${t.userInput.file.file_ext}`;yield t.indexed.saveBlobToUserPath(t.userInput.file.blob,S)}delete t.userInput.quickShare,delete t.userInput.file,_&&(a.msg=_,t.LongTextMessageAsFile(a));let w={channel_id:t.info.id,code:0,color:"888",...h,create_time:(new Date).toISOString(),sender_id:"local",message_id:m,user_display_name:t.nakama.users.self.display_name,is_me:!0};return t.nakama.ModulateTimeDate(w),t.nakama.channels_orig[t.isOfficial][t.target][w.channel_id].last_comment_time=w.create_time,t.nakama.channels_orig[t.isOfficial][t.target][t.info.id].last_comment_id=m,t.nakama.rearrange_channels(),t.nakama.channels_orig[t.isOfficial][t.target][t.info.id].update(w),t.nakama.saveListedMessage([w],t.info,t.isOfficial,t.target),t.nakama.channels_orig[t.isOfficial][t.target][t.info.id].last_comment=(w.content.filename?`(${t.lang.text.ChatRoom.attachments}) `:"")+(t.userInput.text||w.content.noti||(w.content.match?t.lang.text.ChatRoom.JoinWebRTCMatch:void 0)||""),t.nakama.save_channels_with_less_info(),void setTimeout(()=>{t.userInput.text="",t.userInputTextArea.style.height="36px",t.inputPlaceholder=t.lang.text.ChatRoom.input_placeholder},0)}t.sending_msg.push(h);try{yield t.nakama.servers[t.isOfficial][t.target].socket.writeChatMessage(t.info.id,a).then(m=>{l&&!c&&t.indexed.saveBlobToUserPath(t.userInput.file.blob,`servers/${t.isOfficial}/${t.target}/channels/${t.info.id}/files/msg_${m.message_id}.${t.userInput.file.file_ext}`,()=>{t.auto_open_thumbnail({content:a,message_id:m.message_id})}),delete t.userInput.quickShare,delete t.userInput.file,t.userInput.text="",t.userInputTextArea.style.height="36px",t.inputPlaceholder=t.lang.text.ChatRoom.input_placeholder,_&&(a.msg=_,t.LongTextMessageAsFile(a))})}catch(m){3===m.code?t.p5toast.show({text:t.lang.text.ChatRoom.FailedToJoinChannel}):(console.log("\uc624\ub958 \uac80\ud1a0 \ud544\uc694: ",m),t.p5toast.show({text:`${t.lang.text.ChatRoom.FailedToSend}: ${m.message}`})),setTimeout(()=>{t.userInput.text="",t.userInputTextArea.style.height="36px"},0),setTimeout(()=>{for(let w=t.sending_msg.length-1;w>=0;w--)t.sending_msg[w].content.local_comp==a.local_comp&&t.sending_msg.splice(w,1)},1500)}})()}LongTextMessageAsFile(i){var t=this;return(0,v.Z)(function*(){let a=new Blob([i.msg]);yield t.indexed.saveBlobToUserPath(a,`tmp_files/chatroom/${t.lang.text.ChatRoom.LongText}_${i.msg.substring(0,10)}.txt`);let l={};l.blob=a,l.content_related_creator=[{user_id:t.info.local?"local":t.nakama.servers[t.isOfficial][t.target].session.user_id,timestamp:(new Date).getTime(),display_name:t.nakama.users.self.display_name,various:"long_text"}],l.content_creator={user_id:t.info.local?"local":t.nakama.servers[t.isOfficial][t.target].session.user_id,timestamp:(new Date).getTime(),display_name:t.nakama.users.self.display_name,various:"long_text"};let c=i.msg.substring(0,24);l.path=`tmp_files/chatroom/${t.lang.text.ChatRoom.LongText}_${c}~.txt`,l.file_ext="txt",l.filename=`[${t.lang.text.ChatRoom.LongText}] ${c}~.txt`,t.global.set_viewer_category_from_ext(l),l.type="text/plain",l.typeheader="text",delete i.msg,delete t.userInput.quickShare,delete t.userInput.file,t.userInput.text="",t.userInputTextArea.style.height="36px",t.inputPlaceholder=t.lang.text.ChatRoom.input_placeholder,t.userInput.file=l,t.inputPlaceholder=`(${t.lang.text.ChatRoom.attachments}: ${t.userInput.file.filename})`,t.create_selected_thumbnail(),t.p5toast.show({text:t.lang.text.ChatRoom.CreateAsTextFile})})()}message_detail(i){}file_detail(i){var t=this;return(0,v.Z)(function*(){if(i.content.url)return i.content.thumbnail=i.content.url,void t.open_viewer(i,i.content.url);let a=`servers/${t.isOfficial}/${t.target}/channels/${t.info.id}/files/msg_${i.message_id}.${i.content.file_ext}`;try{if(!(yield t.indexed.checkIfFileExist(`${a}.history`)))throw"\uc378\ub124\uc77c \uc5f4\uae30";i.content.text=[t.lang.text.TodoDetail.WIP];let c=yield t.indexed.loadTextFromUserPath(`${a}.history`),_=JSON.parse(c);switch(delete i.content.text,_.type){case"upload":if(i.content.text=[t.lang.text.ChatRoom.uploading],t.nakama.WriteStorage_From_channel(i,a,t.isOfficial,t.target,_.index),i.content.transfer_index&&t.nakama.OnTransfer[t.isOfficial][t.target][i.channel_id][i.message_id].OnTransfer)throw"\uc804\uc1a1\uc791\uc5c5 \uc911, \uc378\ub124\uc77c \uc5f4\uae30";break;case"download":i.content.text=[t.lang.text.TodoDetail.WIP],yield t.nakama.ReadStorage_From_channel(i,a,t.isOfficial,t.target,_.index),t.NeedScrollDown()&&setTimeout(()=>{t.scroll_down_logs()},100)}}catch{(yield t.indexed.checkIfFileExist(a))?(i.content.text||(i.content.text=[t.lang.text.ChatRoom.downloaded]),t.indexed.loadBlobFromUserPath(a,i.content.type,_=>{i.content.path=a;let h=URL.createObjectURL(_);t.global.modulate_thumbnail(i.content,h),t.NeedScrollDown()&&setTimeout(()=>{t.scroll_down_logs()},100)}),t.open_viewer(i,a)):t.isHistoryLoaded||(i.content.text=[t.lang.text.TodoDetail.WIP],yield t.nakama.ReadStorage_From_channel(i,a,t.isOfficial,t.target),t.NeedScrollDown()&&setTimeout(()=>{t.scroll_down_logs()},400))}})()}quickShare_act(i){var t=this;return(0,v.Z)(function*(){t.modalCtrl.create({component:G.y,componentProps:{data:i.content.quickShare}}).then(a=>a.present())})()}JoinWebRTCMatch(i){this.nakama.JoinWebRTCMatch(i,this.isOfficial,this.target,this.info)}modulate_chatmsg(i,t){this.ViewableMessage[i].showInfo||(this.ViewableMessage[i].showInfo={}),this.ViewableMessage[i].showInfo.date=!!this.ViewableMessage[i].msgDate,this.ViewableMessage[i].showInfo.sender=!this.ViewableMessage[i].content.noti&&this.ViewableMessage[i].user_display_name,i-1>=0&&(this.ViewableMessage[i].showInfo.date=!!this.ViewableMessage[i].msgDate&&this.ViewableMessage[i].msgDate!=this.ViewableMessage[i-1].msgDate,this.ViewableMessage[i].showInfo.sender=!this.ViewableMessage[i].content.noti&&this.ViewableMessage[i].user_display_name&&(this.ViewableMessage[i-1].isLastRead||this.ViewableMessage[i].sender_id!=this.ViewableMessage[i-1].sender_id||this.ViewableMessage[i-1].content.noti||this.ViewableMessage[i].msgDate!=this.ViewableMessage[i-1].msgDate||this.ViewableMessage[i].msgTime!=this.ViewableMessage[i-1].msgTime)),this.ViewableMessage[i].content.url&&("image"==this.ViewableMessage[i].content.viewer?this.ViewableMessage[i].content.thumbnail=this.ViewableMessage[i].content.url:delete this.ViewableMessage[i].content.thumbnail);try{i+1<t&&(this.ViewableMessage[i+1].showInfo.date=!!this.ViewableMessage[i].msgDate&&this.ViewableMessage[i].msgDate!=this.ViewableMessage[i+1].msgDate,this.ViewableMessage[i+1].showInfo.sender=!this.ViewableMessage[i+1].content.noti&&this.ViewableMessage[i+1].user_display_name&&(this.ViewableMessage[i].isLastRead||this.ViewableMessage[i].sender_id!=this.ViewableMessage[i+1].sender_id||this.ViewableMessage[i].content.noti||this.ViewableMessage[i].msgDate!=this.ViewableMessage[i+1].msgDate||this.ViewableMessage[i].msgTime!=this.ViewableMessage[i+1].msgTime))}catch{}}ModulateFileEmbedMessage(i){let t=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${i.message_id}.${i.content.file_ext}`;i.content.path=t;try{i.content.transfer_index=this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id][i.message_id]}catch{}i.content.transfer_index||this.indexed.checkIfFileExist(`${t}.history`,a=>{a&&this.indexed.loadTextFromUserPath(`${t}.history`,(l,c)=>{if(l&&c){let _=JSON.parse(c);delete i.content.text,this.nakama.OnTransfer[this.isOfficial]||(this.nakama.OnTransfer[this.isOfficial]={}),this.nakama.OnTransfer[this.isOfficial][this.target]||(this.nakama.OnTransfer[this.isOfficial][this.target]={}),this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id]||(this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id]={}),this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id][i.message_id]||(this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id][i.message_id]={index:i.content.partsize-_.index}),i.content.transfer_index=this.nakama.OnTransfer[this.isOfficial][this.target][i.channel_id][i.message_id]}})}),this.global.set_viewer_category(i.content),this.indexed.checkIfFileExist(t,a=>{a&&(i.content.text=[this.lang.text.ChatRoom.downloaded],this.indexed.loadBlobFromUserPath(t,i.content.type,l=>{i.content.path=t;let c=URL.createObjectURL(l);this.global.modulate_thumbnail(i.content,c),this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100)}))})}toggle_thumbnail(){var i=this;return(0,v.Z)(function*(){i.info.HideAutoThumbnail=!i.info.HideAutoThumbnail,i.nakama.save_channels_with_less_info()})()}open_viewer(i,t){var a=this;let l=[];for(let c=0,_=this.messages.length;c<_;c++)this.messages[c].content.filename&&l.push(this.messages[c]);this.lock_modal_open||(this.lock_modal_open=!0,this.removeShortCutKey(),this.modalCtrl.create({component:L.B,componentProps:{info:i,path:t,alt_path:t,isOfficial:this.isOfficial,target:this.target,targetDB:this.indexed.ionicDB,relevance:l},cssClass:"fullscreen"}).then(c=>{c.onDidDismiss().then(_=>{if(this.ionViewDidEnter(),_.data)switch(_.data.type){case"image":let h=[];if(_.data.msg.content.content_related_creator&&(h=[..._.data.msg.content.content_related_creator]),_.data.msg.content.content_creator){let m=!1;for(let w=0,Z=h.length;w<Z;w++)if(h[w].user_id==_.data.msg.content.content_creator.user_id){m=!0;break}m||h.push(_.data.msg.content.content_creator)}return void this.modalCtrl.create({component:Q.$,componentProps:{path:_.data.path||t,width:_.data.width,height:_.data.height}}).then(m=>{m.onWillDismiss().then(function(){var w=(0,v.Z)(function*(Z){Z.data&&(yield a.voidDraw_fileAct_callback(Z,h))});return function(Z){return w.apply(this,arguments)}}()),m.present()});case"text":this.selected_blobFile_callback_act(_.data.blob,_.data.contentRelated,"textedit")}this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="IonicViewerPage",c.present(),this.nakama.removeBanner(),this.lock_modal_open=!1}))}voidDraw_fileAct_callback(i,t){var a=this;return(0,v.Z)(function*(){try{a.userInput.file={},a.userInput.file.filename=i.data.name,a.userInput.file.file_ext="png",a.userInput.file.thumbnail=a.sanitizer.bypassSecurityTrustUrl(i.data.img),a.userInput.file.type="image/png",a.userInput.file.typeheader="image",t?(a.userInput.file.content_related_creator=t,a.userInput.file.content_creator={user_id:a.info.local?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,timestamp:(new Date).getTime(),display_name:a.nakama.users.self.display_name,various:"voidDraw"}):(a.userInput.file.content_related_creator=[{user_id:a.info.local?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,timestamp:(new Date).getTime(),display_name:a.nakama.users.self.display_name,various:"voidDraw"}],a.userInput.file.content_creator={user_id:a.info.local?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,timestamp:(new Date).getTime(),display_name:a.nakama.users.self.display_name,various:"voidDraw"}),yield a.indexed.saveBase64ToUserPath(i.data.img,`tmp_files/chatroom/${a.userInput.file.filename}`,l=>{a.userInput.file.blob=new Blob([l],{type:a.userInput.file.type})}),a.inputPlaceholder=`(${a.lang.text.ChatRoom.attachments}: ${a.userInput.file.filename})`}catch(l){console.error("godot-\uc774\ubbf8\uc9c0 \ud3b8\uc9d1 \uc0ac\uc6a9 \ubd88\uac00: ",l)}i.data.loadingCtrl.dismiss()})()}user_detail(i){this.lock_modal_open||(this.lock_modal_open=!0,i.is_me?this.modalCtrl.create({component:B.Y}).then(t=>{t.onDidDismiss().then(a=>{this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="GroupServerPage",t.present(),this.lock_modal_open=!1}):this.modalCtrl.create({component:E.r,componentProps:{info:{user:this.nakama.load_other_user(i.sender_id,this.isOfficial,this.target)},group:this.info,has_admin:!1}}).then(t=>{t.onDidDismiss().then(a=>{this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="OthersProfilePage",t.present(),this.lock_modal_open=!1}))}ionViewWillLeave(){this.nakama.rearrange_channels(),this.nakama.channels_orig[this.isOfficial][this.target]&&this.nakama.channels_orig[this.isOfficial][this.target][this.info.id]&&delete this.nakama.channels_orig[this.isOfficial][this.target][this.info.id].update,this.noti.Current=void 0,this.removeShortCutKey()}removeShortCutKey(){delete this.global.p5key.KeyShortCut.Escape,delete this.global.p5key.KeyShortCut.BottomTab,delete this.global.p5key.KeyShortCut.Digit,delete this.global.p5key.KeyShortCut.EnterAct}ngOnDestroy(){delete this.nakama.opened_page_info.channel,this.nakama.ChatroomLinkAct=void 0,this.p5canvas&&this.p5canvas.remove(),this.nakama.OnTransferMessage={}}}return(s=d).\u0275fac=function(i){return new(i||s)(e.Y36(M.IN),e.Y36(M.SH),e.Y36(I.gz),e.Y36(I.F0),e.Y36(z.a),e.Y36(X.J),e.Y36(p.g),e.Y36(T.H),e.Y36(g.b),e.Y36(f.H7),e.Y36(N.AN),e.Y36(M.HT),e.Y36(x.V),e.Y36(b.F),e.Y36(y.T),e.Y36(M.Br))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-chat-room"]],viewQuery:function(i,t){if(1&i&&e.Gf(P,5),2&i){let a;e.iGM(a=e.CRH())&&(t.NewAttach=a.first)}},decls:56,vars:26,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref","subscribes"],["class","top_icon","slot","end","name","eye-outline",3,"click",4,"ngIf"],["class","top_icon","slot","end","name","eye-off-outline",3,"click",4,"ngIf"],[1,"header_online_circle"],["id","p5Drop_chatroom",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["id","main_table",2,"width","100%","height","100%","background-color","var(--chatroom-background)"],[2,"height","100%"],[2,"vertical-align","top"],["id","chatroom_div",1,"main",2,"max-width","100vw"],["button","",3,"disabled","click"],[3,"click",4,"ngFor","ngForOf"],[1,"thumnails"],["class","thumnail_parts",3,"click",4,"ngIf"],["class","thumnail_parts",4,"ngIf"],["id","input_table",2,"width","100%","background-color","var(--chatroom-input-background)"],["fill","clear",1,"ion-text-center",3,"disabled","click"],["name","add"],[2,"width","100%","vertical-align","bottom"],[1,"TextAreaInput",3,"id","ngModel","placeholder","ngModelChange","keyup","keydown","click"],[4,"ngIf"],["fill","clear","expand","block",3,"disabled","click"],["name","send"],["id","ext_menu",3,"hidden"],[1,"expanded"],["hidden","","type","file","id","local_channel","accept","image/*",3,"change"],["hidden","","type","file","accept","*","multiple","",3,"id","change"],["style","display: inline-block;",4,"ngFor","ngForOf"],[2,"display","none"],["interface","action-sheet",3,"ionChange","ionDismiss"],["NewChatRoomAttach",""],["value","image"],["value","link"],["value","inapp"],["value","load"],["slot","end","name","eye-outline",1,"top_icon",3,"click"],["slot","end","name","eye-off-outline",1,"top_icon",3,"click"],[3,"click"],["style","text-align: center; font-size: 16px; padding-top: 8px;",4,"ngIf"],["class","message_form",4,"ngIf"],["class","quickShare_form",3,"click",4,"ngIf"],["class","file_message_form",3,"click",4,"ngIf"],["class","notice_form",4,"ngIf"],["class","message_content_form",4,"ngIf"],["class","read_last_here",4,"ngIf"],[2,"text-align","center","font-size","16px","padding-top","8px"],["color","#888"],[1,"message_form"],[1,"message_span_form",3,"click"],[3,"color"],[1,"time_form"],[1,"quickShare_form",3,"click"],[1,"file_message_form",3,"click"],["class","file_button",3,"style",4,"ngIf"],["class","file_name_form",4,"ngIf"],["class","transfer_count",4,"ngIf"],[1,"file_button"],[1,"file_info"],["class","text_seperator",4,"ngIf"],["class","file_info file_text_thumbnail",4,"ngFor","ngForOf"],[1,"text_seperator"],[1,"file_info","file_text_thumbnail"],[1,"file_name_form"],[1,"file_thumbnail",3,"src","alt"],[1,"transfer_count"],[1,"notice_form"],[1,"notice"],[1,"message_content_form"],[4,"ngFor","ngForOf"],[3,"style",4,"ngIf"],["target","_system",3,"href",4,"ngIf"],["target","_system",3,"href"],[1,"read_last_here"],["class","comp_local_content",4,"ngIf"],["class","comp_local_content","target","_system",3,"href",4,"ngIf"],[1,"comp_local_content"],["target","_system",1,"comp_local_content",3,"href"],[1,"thumnail_parts",3,"click"],[2,"padding","8px","text-align","center"],[1,"thumnail_parts"],[3,"click",4,"ngIf"],[2,"text-align","center","margin-top","4px"],["style","display: grid;","class","thumnail_parts",4,"ngIf"],["id","ChatroomSelectedImage","class","image_thumbnail",3,"src","alt",4,"ngIf"],["id","ChatroomSelectedImage",1,"image_thumbnail",3,"src","alt"],[1,"thumnail_parts",2,"display","grid"],[2,"text-align","center","padding","4px 0px"],[1,"bottom_thumbnail"],["fill","clear","expand","block",3,"click"],["name","mic-outline"],[2,"display","inline-block"],[1,"ext_button",3,"hidden","click"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"]],template:function(i,t){1&i&&(e.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),e._uU(3),e.qZA(),e.TgZ(4,"ion-buttons",1),e._UZ(5,"ion-back-button",2),e.qZA(),e.YNc(6,V,1,0,"ion-icon",3),e.YNc(7,ee,1,0,"ion-icon",4),e._UZ(8,"div",5),e.qZA()(),e.TgZ(9,"ion-content"),e._UZ(10,"div",6),e.TgZ(11,"table",7)(12,"tr",8)(13,"td",9)(14,"div",10)(15,"ion-item",11),e.NdJ("click",function(){return t.pull_msg_history()}),e.TgZ(16,"ion-label"),e._uU(17),e.qZA()(),e.YNc(18,ve,9,8,"div",12),e.YNc(19,Pe,4,3,"div",12),e.qZA(),e.TgZ(20,"table",13),e.YNc(21,Se,4,1,"tr",14),e.YNc(22,Je,3,1,"tr",15),e.YNc(23,Le,3,1,"tr",14),e.YNc(24,qe,6,4,"tr",14),e.qZA()()(),e.TgZ(25,"tr")(26,"td")(27,"div")(28,"table",16)(29,"tr")(30,"td")(31,"ion-button",17),e.NdJ("click",function(){return t.open_ext_with_delay()}),e._UZ(32,"ion-icon",18),e.qZA()(),e.TgZ(33,"td",19)(34,"textarea",20),e.NdJ("ngModelChange",function(l){return t.userInput.text=l})("keyup",function(l){return t.check_key(l)})("keydown",function(l){return t.check_key(l)})("click",function(){return t.make_ext_hidden()}),e.qZA()(),e.YNc(35,Ee,3,0,"td",21),e.TgZ(36,"td")(37,"ion-button",22),e.NdJ("click",function(){return t.send(!1)}),e._UZ(38,"ion-icon",23),e.qZA()()()()()()(),e.TgZ(39,"tr",24)(40,"td")(41,"div",25)(42,"input",26),e.NdJ("change",function(l){return t.LocalChannelImageChanged(l)}),e.qZA(),e.TgZ(43,"input",27),e.NdJ("change",function(l){return t.inputFileSelected(l)}),e.qZA(),e.YNc(44,je,4,5,"div",28),e.qZA(),e.TgZ(45,"ion-item",29)(46,"ion-select",30,31),e.NdJ("ionChange",function(l){return t.new_attach(l)})("ionDismiss",function(){return t.add_shortcut()}),e.TgZ(48,"ion-select-option",32),e._uU(49),e.qZA(),e.TgZ(50,"ion-select-option",33),e._uU(51),e.qZA(),e.TgZ(52,"ion-select-option",34),e._uU(53),e.qZA(),e.TgZ(54,"ion-select-option",35),e._uU(55),e.qZA()()()()()()()),2&i&&(e.xp6(3),e.Oqu(t.info.title||t.lang.text.ChatRoom.noname_chatroom),e.xp6(3),e.Q6J("ngIf",!t.info.HideAutoThumbnail),e.xp6(1),e.Q6J("ngIf",t.info.HideAutoThumbnail),e.xp6(1),e.Akn("background-color: "+t.statusBar.colors[t.info.status||"offline"]),e.xp6(7),e.Q6J("disabled",void 0===t.next_cursor&&!t.ViewMsgIndex||!t.pullable),e.xp6(2),e.Oqu(t.lang.text.ChatRoom.fetch_previous_chat),e.xp6(1),e.Q6J("ngForOf",t.ViewableMessage),e.xp6(1),e.Q6J("ngForOf",t.sending_msg),e.xp6(2),e.Q6J("ngIf",t.userInput.quickShare),e.xp6(1),e.Q6J("ngIf",t.userInput.file),e.xp6(1),e.Q6J("ngIf",t.ShowGoToBottom&&!t.last_message_viewer.user_id),e.xp6(1),e.Q6J("ngIf",t.last_message_viewer.user_id),e.xp6(7),e.Q6J("disabled","offline"==((t.info.status?t.info.status:t.info.info.status)||"offline")),e.xp6(3),e.Q6J("id",t.ChannelUserInputId)("ngModel",t.userInput.text)("placeholder",t.inputPlaceholder),e.xp6(1),e.Q6J("ngIf",t.isMobile),e.xp6(2),e.Q6J("disabled",!t.info.status||"missing"==t.info.status||"offline"==t.info.status),e.xp6(2),e.Q6J("hidden",t.isHidden),e.xp6(4),e.Q6J("id",t.file_sel_id),e.xp6(1),e.Q6J("ngForOf",t.extended_buttons),e.xp6(5),e.Oqu(t.lang.text.TodoDetail.new_draw),e.xp6(2),e.Oqu(t.lang.text.TodoDetail.outlink),e.xp6(2),e.Oqu(t.lang.text.TodoDetail.user_fs),e.xp6(2),e.Oqu(t.lang.text.TodoDetail.add_attach))},dependencies:[$.sg,$.O5,n.Fj,n.JJ,n.On,M.oU,M.YG,M.Sm,M.W2,M.Gu,M.gu,M.Ie,M.Q$,M.t9,M.n0,M.wd,M.sr,M.QI,M.cs],styles:[".top_icon[_ngcontent-%COMP%]{width:28px;height:28px;padding-right:68px;cursor:pointer}.main[_ngcontent-%COMP%]{width:100%;height:100%;padding:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}.message_form[_ngcontent-%COMP%]{margin:8px 0 0}.message_span_form[_ngcontent-%COMP%]{margin-right:8px}.time_form[_ngcontent-%COMP%]{font-size:12px;color:#888}.file_message_form[_ngcontent-%COMP%]{display:flex}.file_name_form[_ngcontent-%COMP%]{margin-top:4px;max-width:192px;max-height:192px}.file_thumbnail[_ngcontent-%COMP%]{max-width:192px;max-height:192px;width:auto;height:auto;border-radius:8px}.file_info[_ngcontent-%COMP%]{margin:0 4px}.file_text_thumbnail[_ngcontent-%COMP%]{margin-top:2px;display:grid}.quickShare_form[_ngcontent-%COMP%]{border-radius:16px;max-width:156px;width:-moz-fit-content;width:fit-content;height:-moz-fit-content;height:fit-content;padding:8px;margin:8px 0;text-align:center;vertical-align:middle;word-break:keep-all;overflow:hidden;background-color:var(--chatroom-you-read-here-backgruond)}.message_content_form[_ngcontent-%COMP%]{margin:4px 0 0}.comp_local_content[_ngcontent-%COMP%]{color:#888}.text_seperator[_ngcontent-%COMP%]{background-color:#fff;margin-top:2px;position:relative;width:100%;height:2px}.expanded[_ngcontent-%COMP%]{height:240px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth;text-align:center;background-color:var(--chatroom-input-background)}.ext_button[_ngcontent-%COMP%]{width:64px;height:48px;margin:24px 12px 0;text-align:center}.ext_button_icon[_ngcontent-%COMP%]{width:72px;height:72px}.file_button[_ngcontent-%COMP%]{width:160px;height:112px;overflow:hidden;background-color:gray;margin-top:4px;border-radius:8px}#send_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;height:-moz-fit-content;height:fit-content;max-height:160px;transform:translateY(-100%);position:relative;background:rgba(187,187,187,.7333333333);padding:8px;overflow:hidden}.bottom_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;max-height:96px;overflow:hidden;padding:8px}.image_thumbnail[_ngcontent-%COMP%]{width:auto;max-height:96px;height:auto;object-fit:contain;display:block;margin:auto;padding:8px}.thumnails[_ngcontent-%COMP%]{width:100%;height:-moz-fit-content;height:fit-content;position:relative;transform:translateY(-100%);background:var(--chatroom-last-msg-viewer-bg);padding:8px}.thumnail_parts[_ngcontent-%COMP%]{max-height:96px;overflow-y:scroll;max-width:100vw}.transfer_count[_ngcontent-%COMP%]{align-self:flex-end;margin-left:4px}.notice_form[_ngcontent-%COMP%]{text-align:center;margin:12px}.notice[_ngcontent-%COMP%]{font-size:12px;display:inline;background:#444;border-radius:8px;padding:4px 8px;color:#fff}.read_last_here[_ngcontent-%COMP%]{text-align:center;font-size:12px;display:inherit;background:var(--chatroom-you-read-here-backgruond);margin:4px 0;color:var(--chatroom-you-read-here-text)}.ext_icon_img[_ngcontent-%COMP%]{max-width:36px;max-height:36px}.TextAreaInput[_ngcontent-%COMP%]{width:100%;height:36px;max-height:156px;resize:none;padding:6px;margin-top:5px;border:0;overflow:hidden;background-color:var(--chatroom-input-background)}"]}),d})()},{path:"ionic-viewer",loadChildren:()=>u.e(1277).then(u.bind(u,1277)).then(s=>s.IonicViewerPageModule)},{path:"void-draw",loadChildren:()=>u.e(4139).then(u.bind(u,4139)).then(s=>s.VoidDrawPageModule)},{path:"quick-share-review",loadChildren:()=>u.e(3556).then(u.bind(u,3556)).then(s=>s.QuickShareReviewPageModule)}];let Ke=(()=>{var s;class d{}return(s=d).\u0275fac=function(i){return new(i||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[I.Bz.forChild(Ge),I.Bz]}),d})(),We=(()=>{var s;class d{}return(s=d).\u0275fac=function(i){return new(i||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[$.ez,n.u5,M.Pc,Ke]}),d})()},5470:(te,D,u)=>{u.d(D,{y:()=>X});var $=u(5861),n=u(9468),M=u(3857),I=u(1325),v=u(9080),J=u(9376),E=u(6052),O=u(6814),L=u(95);function Q(p,T){1&p&&n._UZ(0,"ion-icon",15)}function N(p,T){1&p&&n._UZ(0,"ion-icon",16)}function Y(p,T){if(1&p){const g=n.EpF();n.TgZ(0,"ion-accordion",7)(1,"ion-item",8),n.YNc(2,Q,1,0,"ion-icon",9),n.YNc(3,N,1,0,"ion-icon",10),n.TgZ(4,"ion-label"),n._uU(5),n.qZA()(),n.TgZ(6,"div",11)(7,"ion-item",4),n.NdJ("click",function(){const b=n.CHM(g).$implicit;return n.KtG(b.grant=!b.grant)}),n.TgZ(8,"ion-toggle",12),n.NdJ("ngModelChange",function(x){const y=n.CHM(g).$implicit;return n.KtG(y.grant=x)}),n._uU(9),n.qZA()(),n.TgZ(10,"ion-item",13)(11,"ion-label"),n._uU(12),n.qZA(),n.TgZ(13,"ion-label",14),n._uU(14),n.qZA()(),n.TgZ(15,"ion-item",13)(16,"ion-label"),n._uU(17),n.qZA(),n.TgZ(18,"ion-label",14),n._uU(19),n.qZA()(),n.TgZ(20,"ion-item",13)(21,"ion-label"),n._uU(22),n.qZA(),n.TgZ(23,"ion-label",14),n._uU(24),n.qZA()(),n.TgZ(25,"ion-item",13)(26,"ion-toggle",12),n.NdJ("ngModelChange",function(x){const y=n.CHM(g).$implicit;return n.KtG(y.value.isSSL=x)}),n._uU(27),n.qZA()()()()}if(2&p){const g=T.$implicit,f=T.index,x=n.oxw(2);n.Q6J("value",f),n.xp6(2),n.Q6J("ngIf",!g.grant),n.xp6(1),n.Q6J("ngIf",g.grant),n.xp6(2),n.Oqu(g.value.name),n.xp6(3),n.Q6J("ngModel",g.grant),n.xp6(1),n.Oqu(x.lang.text.QuickShareReview.QuickShareGrant),n.xp6(3),n.Oqu(x.lang.text.GroupServer.Address),n.xp6(2),n.Oqu(g.value.address),n.xp6(3),n.Oqu(x.lang.text.GroupServer.Port),n.xp6(2),n.Oqu(g.value.port||7350),n.xp6(3),n.Oqu(x.lang.text.GroupServer.Key),n.xp6(2),n.Oqu(g.value.key||"defaultkey"),n.xp6(2),n.Q6J("ngModel",g.value.isSSL),n.xp6(1),n.Oqu(x.lang.text.GroupServer.isSSL)}}function U(p,T){if(1&p&&(n.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),n._uU(3),n.qZA()(),n.TgZ(4,"ion-accordion-group"),n.YNc(5,Y,28,14,"ion-accordion",6),n.qZA()()),2&p){const g=n.oxw();n.xp6(3),n.Oqu(g.lang.text.QuickShareReview.Servers),n.xp6(2),n.Q6J("ngForOf",g.servers)}}function B(p,T){1&p&&n._UZ(0,"ion-icon",15)}function j(p,T){1&p&&n._UZ(0,"ion-icon",16)}function G(p,T){if(1&p){const g=n.EpF();n.TgZ(0,"ion-accordion",7)(1,"ion-item",8),n.YNc(2,B,1,0,"ion-icon",9),n.YNc(3,j,1,0,"ion-icon",10),n.TgZ(4,"ion-label"),n._uU(5),n.qZA()(),n.TgZ(6,"div",11)(7,"ion-item",4),n.NdJ("click",function(){const b=n.CHM(g).$implicit;return n.KtG(b.grant=!b.grant)}),n.TgZ(8,"ion-toggle",12),n.NdJ("ngModelChange",function(x){const y=n.CHM(g).$implicit;return n.KtG(y.grant=x)}),n._uU(9),n.qZA()()()()}if(2&p){const g=T.$implicit,f=T.index,x=n.oxw(2);n.Q6J("value",f),n.xp6(2),n.Q6J("ngIf",!g.grant),n.xp6(1),n.Q6J("ngIf",g.grant),n.xp6(2),n.Oqu(g.name),n.xp6(3),n.Q6J("ngModel",g.grant),n.xp6(1),n.Oqu(x.lang.text.QuickShareReview.QuickShareGrant)}}function K(p,T){if(1&p&&(n.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),n._uU(3),n.qZA()(),n.TgZ(4,"ion-accordion-group"),n.YNc(5,G,10,6,"ion-accordion",6),n.qZA()()),2&p){const g=n.oxw();n.xp6(3),n.Oqu(g.lang.text.QuickShareReview.Channels),n.xp6(2),n.Q6J("ngForOf",g.groups)}}function F(p,T){1&p&&n._UZ(0,"ion-icon",15)}function W(p,T){1&p&&n._UZ(0,"ion-icon",16)}function H(p,T){if(1&p&&(n.TgZ(0,"ion-item")(1,"ion-label"),n._uU(2),n.qZA()()),2&p){const g=T.$implicit;n.xp6(2),n.Oqu(g)}}function e(p,T){if(1&p){const g=n.EpF();n.TgZ(0,"ion-accordion",7)(1,"ion-item",8),n.YNc(2,F,1,0,"ion-icon",9),n.YNc(3,W,1,0,"ion-icon",10),n.TgZ(4,"ion-label"),n._uU(5),n.qZA()(),n.TgZ(6,"div",11),n.YNc(7,H,3,1,"ion-item",17),n.TgZ(8,"ion-item",4),n.NdJ("click",function(){const b=n.CHM(g).$implicit;return n.KtG(b.grant=!b.grant)}),n.TgZ(9,"ion-toggle",12),n.NdJ("ngModelChange",function(x){const y=n.CHM(g).$implicit;return n.KtG(y.grant=x)}),n._uU(10),n.qZA()()()()}if(2&p){const g=T.$implicit,f=T.index,x=n.oxw(2);n.Q6J("value",f),n.xp6(2),n.Q6J("ngIf",!g.grant),n.xp6(1),n.Q6J("ngIf",g.grant),n.xp6(2),n.Oqu(g.value.urls[0]),n.xp6(2),n.Q6J("ngForOf",g.value.urls),n.xp6(2),n.Q6J("ngModel",g.grant),n.xp6(1),n.Oqu(x.lang.text.QuickShareReview.QuickShareGrant)}}function z(p,T){if(1&p&&(n.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),n._uU(3),n.qZA()(),n.TgZ(4,"ion-accordion-group"),n.YNc(5,e,11,7,"ion-accordion",6),n.qZA()()),2&p){const g=n.oxw();n.xp6(3),n.Oqu(g.lang.text.QuickShareReview.Channels),n.xp6(2),n.Q6J("ngForOf",g.rtcserver)}}let X=(()=>{var p;class T{constructor(f,x,b,y,P,V){this.lang=f,this.navParams=x,this.modalCtrl=b,this.nakama=y,this.p5toast=P,this.global=V,this.servers=[],this.groups=[],this.rtcserver=[]}ngOnInit(){var f=this;return(0,$.Z)(function*(){let x=f.navParams.get("data"),b=f.global.CatchGETs(x),y=yield f.nakama.AddressToQRCodeAct(b,!0);for(let P=0,V=y.length;P<V;P++)switch(y[P].type){case"server":f.servers.push(y[P]);break;case"group":f.groups.push(y[P]);break;case"rtcserver":f.rtcserver.push(y[P])}})()}apply_selected(){var f=this;return(0,$.Z)(function*(){let x=[];for(let b=0,y=f.servers.length;b<y;b++)f.servers[b].grant&&x.push(f.servers[b]);for(let b=0,y=f.groups.length;b<y;b++)f.groups[b].grant&&x.push(f.groups[b]);for(let b=0,y=f.rtcserver.length;b<y;b++)f.rtcserver[b].grant&&x.push(f.rtcserver[b]);console.log(x),yield f.nakama.act_from_QRInfo(x),f.p5toast.show({text:f.lang.text.QuickQRShare.success_received,lateable:!0}),f.modalCtrl.dismiss()})()}}return(p=T).\u0275fac=function(f){return new(f||p)(n.Y36(M.b),n.Y36(I.X1),n.Y36(I.IN),n.Y36(v.a),n.Y36(J.F),n.Y36(E.AN))},p.\u0275cmp=n.Xpm({type:p,selectors:[["app-quick-share-review"]],decls:14,vars:5,consts:[[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],[4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["slot","header"],["color","danger","slot","start","name","close-outline",4,"ngIf"],["color","success","slot","start","name","checkmark-outline",4,"ngIf"],["slot","content"],[1,"ion_toggle_ignore",3,"ngModel","ngModelChange"],["button",""],[1,"ion-text-end"],["color","danger","slot","start","name","close-outline"],["color","success","slot","start","name","checkmark-outline"],[4,"ngFor","ngForOf"]],template:function(f,x){1&f&&(n.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),n._uU(3),n.qZA(),n.TgZ(4,"ion-buttons",1),n.NdJ("click",function(){return x.modalCtrl.dismiss()}),n._UZ(5,"ion-back-button",2),n.qZA()()(),n.TgZ(6,"ion-content"),n.YNc(7,U,6,2,"div",3),n.YNc(8,K,6,2,"div",3),n.YNc(9,z,6,2,"div",3),n.qZA(),n.TgZ(10,"ion-footer")(11,"ion-item",4),n.NdJ("click",function(){return x.apply_selected()}),n.TgZ(12,"ion-label",5),n._uU(13),n.qZA()()()),2&f&&(n.xp6(3),n.Oqu(x.lang.text.QuickShareReview.Title),n.xp6(4),n.Q6J("ngIf",x.servers.length),n.xp6(1),n.Q6J("ngIf",x.groups.length),n.xp6(1),n.Q6J("ngIf",x.rtcserver.length),n.xp6(4),n.Oqu(x.lang.text.QuickShareReview.ApplyChecked))},dependencies:[O.sg,O.O5,L.JJ,L.On,I.We,I.eh,I.oU,I.Sm,I.W2,I.fr,I.Gu,I.gu,I.Ie,I.rH,I.Q$,I.wd,I.ho,I.sr,I.w,I.cs],styles:[".ion_toggle_ignore[_ngcontent-%COMP%]{pointer-events:none}"]}),T})()}}]);