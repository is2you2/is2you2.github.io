"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8744],{8744:(me,ae,w)=>{w.d(ae,{K:()=>Je});var r=w(1528),A=w(5193),M=w(9352),oe=w(896),le=w(2272),t=w(4496),b=w(5624),se=w(9240),re=w(4668),ce=w(4500),E=w(544),Y=w(3824),T=w(5020),D=w(7136),B=w(7756),K=w(6819),z=w(1368),Z=w(4716);const ue=["ShowContentInfoIonic"];function pe(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-icon",22),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.AutoPlayNext=!n.AutoPlayNext)}),t.C$Y()}}function ve(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-icon",23),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.AutoPlayNext=!n.AutoPlayNext)}),t.C$Y()}}function Ie(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-icon",24),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.ChangeToAnother(-1))}),t.C$Y()}}function xe(l,v){if(1&l&&(t.I0R(0,"ion-label",25),t.OEk(1),t.C$Y()),2&l){const a=t.GaO();t.yG2(),t.cNF(a.RelevanceIndex+" / "+a.Relevances.length)}}function ye(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-icon",26),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.ChangeToAnother(1))}),t.C$Y()}}function Ce(l,v){if(1&l&&(t.I0R(0,"ion-label",27),t.OEk(1),t.C$Y()),2&l){const a=t.GaO();t.yG2(),t.cNF(a.FileInfo.filename||a.FileInfo.name)}}function we(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-input",28),t.iHE("ngModelChange",function(n){t.usT(a);const o=t.GaO();return t.kNx(o.NewTextFileName,n)||(o.NewTextFileName=n),t.CGJ(n)}),t.C$Y()}if(2&l){const a=t.GaO();t.OKB("ngModel",a.NewTextFileName),t.E7m("placeholder",a.FileInfo.filename||a.FileInfo.name)}}function be(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-button",29),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.close_text_edit())}),t.wR5(1,"ion-icon",30),t.C$Y()}}function ke(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-button",29),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.SaveText())}),t.wR5(1,"ion-icon",31),t.C$Y()}}function Te(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-button",32),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.DownloadAllListFiles())}),t.wR5(1,"ion-icon",33),t.C$Y()}if(2&l){const a=t.GaO();t.E7m("disabled",a.isDownloading||a.MessageInfo.content.transfer_index&&"download"==a.MessageInfo.content.transfer_index.OnTransfer)}}function Pe(l,v){1&l&&(t.I0R(0,"ion-button",34),t.wR5(1,"ion-icon",35),t.C$Y())}function Oe(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(3);return t.CGJ(n.open_text_editor())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&l){const a=t.GaO(3);t.yG2(2),t.cNF(a.lang.text.ContentViewer.EditText)}}function Fe(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(3);return t.CGJ(n.modify_image())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&l){const a=t.GaO(3);t.yG2(2),t.cNF(a.lang.text.ContentViewer.Edit)}}function Re(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(3);return t.CGJ(n.ShareContent())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&l){const a=t.GaO(3);t.yG2(2),t.cNF(a.lang.text.ContentViewer.ShareContent)}}function Ee(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(3);return t.CGJ(n.download_file())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&l){const a=t.GaO(3);t.yG2(2),t.cNF(a.lang.text.ContentViewer.Download)}}function De(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(3);return t.CGJ(n.RemoveFile())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&l){const a=t.GaO(3);t.yG2(2),t.cNF(a.lang.text.ContentViewer.RemoveFile)}}function Ge(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-content")(1,"ion-list"),t.yuY(2,Oe,3,1,"ion-item",37)(3,Fe,3,1,"ion-item",37),t.I0R(4,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(2);return t.CGJ(n.open_bottom_modal())}),t.I0R(5,"ion-label"),t.OEk(6),t.C$Y()(),t.yuY(7,Re,3,1,"ion-item",37)(8,Ee,3,1,"ion-item",37)(9,De,3,1,"ion-item",37),t.C$Y()()}if(2&l){const a=t.GaO(2);t.yG2(2),t.E7m("ngIf",!a.NeedDownloadFile&&"text"==a.FileInfo.viewer),t.yG2(),t.E7m("ngIf",!a.NeedDownloadFile&&"audio"!=a.FileInfo.viewer),t.yG2(3),t.cNF(a.lang.text.ContentViewer.ContentInfo),t.yG2(),t.E7m("ngIf",!a.NeedDownloadFile),t.yG2(),t.E7m("ngIf",!a.NeedDownloadFile),t.yG2(),t.E7m("ngIf",!a.NeedDownloadFile&&a.OpenInChannelChat&&!a.FileInfo.url)}}function Be(l,v){1&l&&(t.I0R(0,"ion-popover",36),t.yuY(1,Ge,10,6,"ng-template"),t.C$Y())}function Me(l,v){if(1&l&&(t.I0R(0,"div")(1,"div",40),t.wR5(2,"ion-icon",41),t.I0R(3,"div")(4,"ion-label",42),t.OEk(5),t.C$Y()()()()),2&l){const a=t.GaO(2);t.yG2(5),t.cNF(a.lang.text.ContentViewer.OnLoadContent)}}function Ve(l,v){if(1&l&&(t.I0R(0,"td"),t.yuY(1,Me,6,1,"div",19),t.wR5(2,"div",39),t.C$Y()),2&l){const a=t.GaO();t.yG2(),t.E7m("ngIf",!a.ContentOnLoad)}}function Le(l,v){if(1&l){const a=t.KQA();t.I0R(0,"td")(1,"ion-grid")(2,"ion-row",43)(3,"ion-col",44)(4,"ion-button",45),t.qCj("click",function(){t.usT(a);const n=t.GaO();return t.CGJ(n.DownloadCurrentFile())}),t.OEk(5),t.C$Y()()()()()}if(2&l){const a=t.GaO();t.yG2(4),t.E7m("disabled",a.isDownloading||a.MessageInfo.content.transfer_index&&"download"==a.MessageInfo.content.transfer_index.OnTransfer),t.yG2(),t.oRS(" ",a.MessageInfo.content.transfer_index&&"download"==a.MessageInfo.content.transfer_index.OnTransfer?a.lang.text.ContentViewer.FileDownloading:a.lang.text.ContentViewer.DownloadThisFile," ")}}function Ae(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(a);const n=t.GaO(2);return t.CGJ(n.copy_url(n.content_creator.user_id))}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"ion-label",47),t.OEk(4),t.C$Y()()}if(2&l){const a=t.GaO(2);t.yG2(2),t.cNF(a.lang.text.ContentInfo.LastPost),t.yG2(2),t.oRS(" ",a.content_creator.publisher||a.content_creator.display_name||a.lang.text.Profile.noname_user,"")}}function $e(l,v){if(1&l&&(t.I0R(0,"ion-item",50)(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"ion-label",47),t.OEk(4),t.C$Y()()),2&l){const a=t.GaO(2);t.yG2(2),t.cNF(a.lang.text.ContentInfo.SourceFrom),t.yG2(2),t.cNF(a.content_creator.various_display)}}function Ne(l,v){if(1&l&&(t.I0R(0,"ion-item")(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"ion-label",47),t.OEk(4),t.C$Y()()),2&l){const a=t.GaO(2);t.yG2(2),t.cNF(a.lang.text.ContentInfo.FileSize),t.yG2(2),t.cNF(a.CurrentFileSize)}}function Ue(l,v){1&l&&t.wR5(0,"ion-icon",59)}function Ye(l,v){1&l&&t.wR5(0,"ion-icon",60)}function Se(l,v){1&l&&t.wR5(0,"ion-icon",61)}function We(l,v){1&l&&t.wR5(0,"ion-icon",62)}function je(l,v){1&l&&t.wR5(0,"ion-icon",63)}function Ke(l,v){1&l&&t.wR5(0,"ion-icon",64)}function ze(l,v){1&l&&(t.I0R(0,"ion-avatar"),t.wR5(1,"img",65),t.C$Y())}function He(l,v){if(1&l){const a=t.KQA();t.I0R(0,"div")(1,"div",51),t.OEk(2),t.I0R(3,"ion-chip",52),t.qCj("click",function(){const o=t.usT(a).$implicit,c=t.GaO(2);return t.CGJ(c.toast_info(o))}),t.yuY(4,Ue,1,0,"ion-icon",53)(5,Ye,1,0,"ion-icon",54)(6,Se,1,0,"ion-icon",55)(7,We,1,0,"ion-icon",56)(8,je,1,0,"ion-icon",57)(9,Ke,1,0,"ion-icon",58)(10,ze,2,0,"ion-avatar",19),t.I0R(11,"ion-label"),t.OEk(12),t.C$Y()()()()}if(2&l){const a=v.$implicit,e=t.GaO(2);t.yG2(2),t.oRS(" ",a.timeDisplay," "),t.yG2(2),t.E7m("ngIf","loaded"==a.various),t.yG2(),t.E7m("ngIf","camera"==a.various),t.yG2(),t.E7m("ngIf","link"==a.various),t.yG2(),t.E7m("ngIf","long_text"==a.various),t.yG2(),t.E7m("ngIf","textedit"==a.various),t.yG2(),t.E7m("ngIf","shared"==a.various),t.yG2(),t.E7m("ngIf","voidDraw"==a.various),t.yG2(2),t.cNF(a.publisher||a.display_name||e.lang.text.Profile.noname_user)}}function Qe(l,v){if(1&l){const a=t.KQA();t.I0R(0,"ion-content")(1,"ion-item-divider")(2,"ion-label"),t.OEk(3),t.C$Y()(),t.yuY(4,Ae,5,2,"ion-item",37)(5,$e,5,2,"ion-item",46)(6,Ne,5,2,"ion-item",19),t.I0R(7,"ion-item")(8,"ion-label"),t.OEk(9),t.C$Y(),t.I0R(10,"ion-label",47),t.OEk(11),t.C$Y()(),t.I0R(12,"ion-item-divider")(13,"ion-label"),t.OEk(14),t.C$Y()(),t.yuY(15,He,13,9,"div",48),t.I0R(16,"ion-item",38),t.qCj("click",function(){t.usT(a),t.GaO();const n=t.Gew(27);return t.CGJ(n.dismiss())}),t.I0R(17,"ion-label",49),t.OEk(18),t.C$Y()()()}if(2&l){const a=t.GaO();t.yG2(3),t.cNF(a.lang.text.ContentInfo.WorkLogs),t.yG2(),t.E7m("ngIf",!a.FromUserFsDir),t.yG2(),t.E7m("ngIf",a.content_creator.various),t.yG2(),t.E7m("ngIf",!a.FileInfo.url),t.yG2(3),t.cNF(a.lang.text.ContentInfo.TimeAt),t.yG2(2),t.cNF(a.content_creator.timeDisplay),t.yG2(3),t.cNF(a.lang.text.ContentInfo.WorkHistory),t.yG2(),t.E7m("ngForOf",a.content_related_creator),t.yG2(3),t.cNF(a.lang.text.ContentInfo.CloseModal)}}const Xe=()=>[.5,1];let Je=(()=>{var l;class v{constructor(e,n,o,c,f,i,s,m,x,I,_,d){this.modalCtrl=e,this.navParams=n,this.indexed=o,this.lang=c,this.file=f,this.p5toast=i,this.alertCtrl=s,this.loadingCtrl=m,this.global=x,this.nakama=I,this.mClipboard=_,this.noti=d,this.useP5Navigator=!0,this.RelevanceIndex=0,this.HaveRelevances=!1,this.NeedDownloadFile=!1,this.ContentOnLoad=!1,this.isDownloading=!1,this.OpenInChannelChat=!1,this.isChannelOnline=!0,this.fromLocalChannel=!1,this.EventListenerAct=y=>{y.detail.register(120,u=>{})},this.BackButtonPressed=!1,this.ContentChanging=!1,this.AutoPlayNext=!1,this.isTextEditMode=!1,this.NewTextFileName="",this.image_info={},this.forceWrite=!1}InitBrowserBackButtonOverride(){window.history.replaceState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.modalCtrl.dismiss())}}ngOnInit(){var e=this;return(0,r.c)(function*(){e.InitBrowserBackButtonOverride(),e.fromLocalChannel=e.navParams.get("local"),e.MessageInfo=e.navParams.get("info"),e.OpenInChannelChat=void 0!==e.MessageInfo.code,e.CurrentViewId=e.MessageInfo.message_id,e.FileInfo=e.MessageInfo.content,e.ContentBox=document.getElementById("ContentBox"),e.FileHeader=document.getElementById("FileHeader"),e.isOfficial=e.navParams.get("isOfficial"),e.target=e.navParams.get("target");try{e.isChannelOnline="online"==e.nakama.channels_orig[e.isOfficial][e.target][e.MessageInfo.channel_id].info.status,e.isChannelOnline=e.isChannelOnline||"online"==e.nakama.channels_orig[e.isOfficial][e.target][e.MessageInfo.channel_id].status||"pending"==e.nakama.channels_orig[e.isOfficial][e.target][e.MessageInfo.channel_id].status}catch{}if("text"===(e.targetDB=e.navParams.get("targetDB"),e.FromUserFsDir=e.navParams.get("no_edit")||!1,e.FileInfo.is_new));else{if(e.Relevances=e.navParams.get("relevance"),e.Relevances){for(let n=0,o=e.Relevances.length;n<o;n++)if(e.Relevances[n].message_id&&e.MessageInfo.message_id){if(e.Relevances[n].message_id==e.MessageInfo.message_id){e.RelevanceIndex=n+1;break}}else if(e.Relevances[n].content.path==e.MessageInfo.content.path){e.RelevanceIndex=n+1;break}e.HaveRelevances=e.Relevances.length>1}else e.HaveRelevances=!1;e.CreateContentInfo()}})()}reinit_content_data(e){var n=this;return(0,r.c)(function*(){n.NewTextFileName="",n.NeedDownloadFile=!0,n.ContentOnLoad=!1,n.isTextEditMode=!1,n.MessageInfo=e,n.CurrentViewId=n.MessageInfo.message_id,n.FileInfo=n.MessageInfo.content;let o=document.getElementById("content_viewer_canvas");if(o)for(let c=0,f=o.childNodes.length;c<f;c++)o.removeChild(o.childNodes[c]);if(URL.revokeObjectURL(n.FileURL),n.FileInfo.url)n.CreateContentInfo(),n.NeedDownloadFile=!1,n.ContentOnLoad=!0,n.ionViewDidEnter();else{let c=n.FileInfo.path||`servers/${n.isOfficial}/${n.target}/channels/${e.channel_id}/files/msg_${e.message_id}.${e.content.file_ext}`;n.image_info.path=c,n.NeedDownloadFile=yield n.indexed.checkIfFileExist(`${c}.history`,void 0,n.targetDB);try{n.blob=yield n.indexed.loadBlobFromUserPath(c,n.FileInfo.type,void 0,n.targetDB),n.CreateContentInfo(),n.ionViewDidEnter()}catch{n.FileURL=void 0,n.blob=void 0,n.isDownloading=!1,n.NeedDownloadFile=!0,n.ContentOnLoad=!1,n.CreateContentInfo(),n.p5canvas&&n.p5canvas.remove(),n.p5canvas=new M(i=>{i.setup=()=>{i.noCanvas()}}),n.ChangeContentWithKeyInput()}}})()}DownloadAllListFiles(){this.alertCtrl.create({header:this.lang.text.ContentViewer.DownloadAllFiles,message:this.lang.text.ContentViewer.DownloadLoadedList,buttons:[{text:this.lang.text.ContentViewer.DownloadThisFile,handler:()=>{this.DownloadInOrder()}}]}).then(e=>e.present())}DownloadInOrder(){var e=this;return(0,r.c)(function*(){("Android"==A.s1||"iOS"==A.s1)&&e.noti.noti.schedule({id:6,title:e.lang.text.ContentViewer.DownloadThisFile,progressBar:{indeterminate:!0},sound:null,smallIcon:"res://diychat",color:"b0b0b0"});for(let n=0,o=e.Relevances.length;n<o;n++)e.nakama.OnTransfer[e.isOfficial]||(e.nakama.OnTransfer[e.isOfficial]={}),e.nakama.OnTransfer[e.isOfficial][e.target]||(e.nakama.OnTransfer[e.isOfficial][e.target]={}),e.nakama.OnTransfer[e.isOfficial][e.target][e.Relevances[n].channel_id]||(e.nakama.OnTransfer[e.isOfficial][e.target][e.Relevances[n].channel_id]={}),e.nakama.OnTransfer[e.isOfficial][e.target][e.Relevances[n].channel_id][e.Relevances[n].message_id]||(e.nakama.OnTransfer[e.isOfficial][e.target][e.Relevances[n].channel_id][e.Relevances[n].message_id]={});for(let n=0,o=e.Relevances.length;n<o;n++){("Android"==A.s1||"iOS"==A.s1)&&e.noti.noti.schedule({id:6,title:`${e.lang.text.ContentViewer.DownloadThisFile}: ${o-n}`,progressBar:{value:n,maxValue:o},sound:null,smallIcon:"res://diychat",color:"b0b0b0"});let c=`servers/${e.isOfficial}/${e.target}/channels/${e.Relevances[n].channel_id}/files/msg_${e.Relevances[n].message_id}.${e.Relevances[n].content.file_ext}`;if(!(yield e.indexed.checkIfFileExist(c,void 0,e.targetDB)))try{yield e.DownloadCurrentFile(n)}catch(i){console.log(i)}}e.noti.ClearNoti(6)})()}ChangeToAnother(e){if(this.ContentChanging)return;this.ContentChanging=!0;let n=this.RelevanceIndex+e;n<=0||n>this.Relevances.length||(this.p5canvas&&this.p5canvas.remove(),this.RelevanceIndex=n,this.FileInfo={file_ext:""},this.reinit_content_data(this.Relevances[this.RelevanceIndex-1]),this.ContentChanging=!1)}DownloadCurrentFile(e){var n=this;return(0,r.c)(function*(){n.isDownloading=!0;let o=0,c=n.Relevances[null!=e?e:n.RelevanceIndex-1],f=`servers/${n.isOfficial}/${n.target}/channels/${c.channel_id}/files/msg_${c.message_id}.${c.content.file_ext}`;try{let s=yield n.indexed.loadTextFromUserPath(`${f}.history`,void 0,n.targetDB);o=JSON.parse(s).index}catch{}let i=c.message_id;yield n.nakama.ReadStorage_From_channel(c,f,n.isOfficial,n.target,o),n.CurrentViewId==i&&n.reinit_content_data(c)})()}formatBytes(e,n=2){if(!+e)return"0 Bytes";const c=n<0?0:n,i=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,i)).toFixed(c))} ${["Bytes","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"][i]}`}CreateContentInfo(){try{if(this.FileInfo.url||(this.CurrentFileSize=this.formatBytes(this.FileInfo.size||this.FileInfo.filesize||this.blob.size)),this.content_creator=this.FileInfo.content_creator||{timestamp:this.FileInfo.timestamp},this.content_creator.timeDisplay=new Date(this.content_creator.timestamp).toLocaleString(),this.content_related_creator=this.FileInfo.content_related_creator||[],this.content_creator.user_id)try{this.content_creator.is_me=this.nakama.servers[this.isOfficial][this.target].session.user_id==this.content_creator.user_id}catch{}try{this.content_creator.publisher=this.content_creator.is_me?this.nakama.users.self.display_name:this.nakama.users[this.isOfficial][this.target][this.content_creator.user_id].display_name}catch{}this.set_various_display(this.content_creator);for(let e=0,n=this.content_related_creator.length;e<n;e++){if(this.content_related_creator[e].user_id)try{this.content_related_creator[e].is_me=this.nakama.servers[this.isOfficial][this.target].session.user_id==this.content_related_creator[e].user_id}catch{}this.content_related_creator[e].timeDisplay=new Date(this.content_related_creator[e].timestamp).toLocaleString()}}catch{}try{this.content_related_creator[0].publisher=this.content_related_creator[0].is_me?this.nakama.users.self.display_name:this.nakama.users[this.isOfficial][this.target][this.content_related_creator[0].user_id].display_name,this.content_related_creator[0].timestamp==this.content_related_creator[1].timestamp&&(this.content_related_creator[0].publisher=this.content_related_creator[1].is_me?this.nakama.users.self.display_name:this.nakama.users[this.isOfficial][this.target][this.content_related_creator[1].user_id].display_name,this.content_related_creator.splice(1,1))}catch{try{this.content_related_creator[0].publisher=this.content_related_creator[1].display_name,this.content_related_creator[0].timestamp==this.content_related_creator[1].timestamp&&(this.content_related_creator[0].publisher=this.content_related_creator[1].display_name,this.content_related_creator.splice(1,1))}catch{}try{this.content_related_creator[0].publisher||(this.content_related_creator[0].publisher=this.content_related_creator[0].display_name)}catch{}}try{this.content_related_creator.sort((e,n)=>e.timestamp>n.timestamp?-1:e.timestamp<n.timestamp?1:0)}catch{}}set_various_display(e){switch(e.various){case"camera":e.various_display=this.lang.text.GlobalAct.FromCamera;break;case"link":e.various_display=this.lang.text.ChatRoom.ExternalLinkFile;break;case"loaded":e.various_display=this.lang.text.GlobalAct.variousCreator;break;case"voidDraw":e.various_display=this.lang.text.GlobalAct.FromVoidDraw;break;case"long_text":e.various_display=this.lang.text.GlobalAct.FromAutoLongText;break;case"textedit":e.various_display=this.lang.text.GlobalAct.FromTextEditor;break;case"shared":e.various_display=this.lang.text.GlobalAct.SharedContent;break;default:e.various_display=this.lang.text.GlobalAct.UnknownSource}}close_text_edit(){this.FileInfo.is_new?this.modalCtrl.dismiss():this.reinit_content_data(this.MessageInfo)}ionViewDidEnter(){var e=this;return(0,r.c)(function*(){e.FileInfo.url?e.FileURL=e.FileInfo.url:e.FileInfo.is_new||(e.blob||(e.blob=yield e.indexed.loadBlobFromUserPath(e.FileInfo.path||e.navParams.get("path"),e.FileInfo.type,void 0,e.targetDB)),e.FileURL=URL.createObjectURL(e.blob)),e.forceWrite=!1;let n=document.getElementById("content_viewer_canvas");switch(n&&(n.style.backgroundImage=""),document.removeEventListener("ionBackButton",e.EventListenerAct),e.p5canvas&&e.p5canvas.remove(),e.FileInfo.viewer){case"image":e.p5canvas=new M(i=>{i.setup=(0,r.c)(function*(){n.style.maxWidth="100%",n.style.overflow="hidden",e.ContentBox.style.overflow="hidden",i.noCanvas();let p=i.createElement("img");p.elt.hidden=!0,p.elt.src=e.FileURL,p.elt.onload=()=>{n.style.backgroundImage=`url('${e.FileURL}')`,n.style.backgroundRepeat="no-repeat",n.style.pointerEvents="none",e.image_info.width=p.elt.naturalWidth,e.image_info.height=p.elt.naturalHeight,m=i.createVector(p.elt.naturalWidth,p.elt.naturalHeight),s(),p.remove(),e.ContentOnLoad=!0},i.noLoop()});let s=()=>{if(e.image_info.width/e.image_info.height<n.clientWidth/n.clientHeight){let p=e.image_info.width*n.clientHeight/e.image_info.height;n.style.backgroundSize=`${p}px`,n.style.backgroundPositionX=(n.clientWidth-p)/2+"px",n.style.backgroundPositionY="0px"}else n.style.backgroundSize=`${n.clientWidth}px`,n.style.backgroundPositionX="0px",n.style.backgroundPositionY=n.clientHeight/2-m.y*(n.clientWidth/m.x)/2+"px";W=!0};i.windowResized=()=>{setTimeout(()=>{s()},50)};let m,x=i.createVector(),I=i.createVector(),_=i.createVector(),d=1,y=()=>{n.style.backgroundPositionX=`${x.x+_.x}px`,n.style.backgroundPositionY=`${x.y+_.y}px`},u=(p,$)=>{let C=d,G=d*$,g=Number(n.style.backgroundPositionX.split("px")[0]),Q=Number(n.style.backgroundPositionY.split("px")[0]),q=(C-G)*i.map(p.x,g,g+C,0,1),N=(C-G)/m.x*m.y*i.map(p.y,Q,Q+C/m.x*m.y,0,1);n.style.backgroundPositionX=`${g+q}px`,n.style.backgroundPositionY=`${Q+N}px`,n.style.backgroundSize=`${G}px`};i.mousePressed=()=>{e.useP5Navigator&&(i.mouseButton==i.CENTER&&s(),"DesktopPWA"==A.s1&&(x=i.createVector(Number(n.style.backgroundPositionX.split("px")[0]),Number(n.style.backgroundPositionY.split("px")[0])),I=i.createVector(i.mouseX,i.mouseY)))},i.mouseWheel=p=>{e.useP5Navigator&&(d=Number(n.style.backgroundSize.split("px")[0]),u(i.createVector(n.clientWidth/2,n.clientHeight/2),1-p.delta/1e3))},i.mouseDragged=()=>{e.useP5Navigator&&"DesktopPWA"==A.s1&&(_=i.createVector(i.mouseX,i.mouseY),_.sub(I),y())};let k,h={},S=!1,W=!0;i.touchStarted=p=>{if(e.useP5Navigator){for(let C=0,G=p.changedTouches.length;C<G;C++)h[p.changedTouches[C].identifier]=i.createVector(p.changedTouches[C].clientX,p.changedTouches[C].clientY);switch(Object.keys(h).length){case 1:x=i.createVector(Number(n.style.backgroundPositionX.split("px")[0]),Number(n.style.backgroundPositionY.split("px")[0])),I=h[p.changedTouches[0].identifier].copy();break;case 2:x=i.createVector(Number(n.style.backgroundPositionX.split("px")[0]),Number(n.style.backgroundPositionY.split("px")[0]));let C=h[0].copy();k=C.dist(h[1]),I=C.add(h[1]).div(2).copy(),d=Number(n.style.backgroundSize.split("px")[0]),y();break;default:S=!0,s()}}},i.touchMoved=p=>{if(e.useP5Navigator&&!S){for(let C=0,G=p.changedTouches.length;C<G;C++)h[p.changedTouches[C].identifier]=i.createVector(p.changedTouches[C].clientX,p.changedTouches[C].clientY);switch(Object.keys(h).length){case 1:_=h[p.changedTouches[0].identifier].copy(),_.sub(I),W||y();break;case 2:W=!1;let C=h[0].copy(),G=C.dist(h[1]);_=C.add(h[1]).div(2).copy();let g=_.copy();_.sub(I),y(),u(g,G/k)}}},i.touchEnded=p=>{if(e.useP5Navigator&&"changedTouches"in p){for(let C=0,G=p.changedTouches.length;C<G;C++)delete h[p.changedTouches[C].identifier];switch(Object.keys(h).length){case 1:x=i.createVector(Number(n.style.backgroundPositionX.split("px")[0]),Number(n.style.backgroundPositionY.split("px")[0])),I=h[Object.keys(h)[0]].copy();break;case 0:W&&!S&&(_.x>50?e.ChangeToAnother(-1):_.x<-50&&e.ChangeToAnother(1)),S=!1}}}});break;case"audio":e.p5canvas=new M(i=>{var s;i.setup=()=>{i.noCanvas(),i.noLoop(),(s=i.createAudio([e.FileURL],()=>{n.appendChild(s.elt),s.elt.onended=()=>{e.AutoPlayNext&&e.ChangeToAnother(1)},setTimeout(()=>{m(),s.elt.hidden=!1},50),s.showControls(),s.play(),e.ContentOnLoad=!0})).elt.hidden=!0};let m=()=>{let d=e.ContentBox.offsetWidth;s.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),s.size(d,25)};i.windowResized=()=>{setTimeout(()=>{m()},50)};let x=i.createVector(),I={};i.touchStarted=d=>{if(e.useP5Navigator&&!document.pictureInPictureElement&&"changedTouches"in d){for(let u=0,h=d.changedTouches.length;u<h;u++)I[d.changedTouches[u].identifier]=i.createVector(d.changedTouches[u].clientX,d.changedTouches[u].clientY);1===Object.keys(I).length&&(x=I[d.changedTouches[0].identifier].copy())}},i.touchEnded=d=>{if(e.useP5Navigator&&!document.pictureInPictureElement&&"changedTouches"in d){let y;for(let h=0,k=d.changedTouches.length;h<k;h++)y=i.createVector(d.changedTouches[h].clientX,d.changedTouches[h].clientY),delete I[d.changedTouches[h].identifier];0===Object.keys(I).length&&(y.sub(x),y.x>50?e.ChangeToAnother(-1):y.x<-50&&e.ChangeToAnother(1))}}});break;case"video":e.p5canvas=new M(i=>{var s;i.setup=(0,r.c)(function*(){i.noCanvas(),i.noLoop(),(s=i.createVideo([e.FileURL],()=>{e.global.PIPLinkedVideoElement?(s.elt.remove(),s.elt=e.global.PIPLinkedVideoElement,s.elt.setAttribute("src",e.FileURL)):e.global.PIPLinkedVideoElement=s.elt,n&&n.appendChild(s.elt),s.elt.onended=()=>{e.AutoPlayNext&&e.ChangeToAnother(1)},setTimeout(()=>{e.image_info.width=s.elt.videoWidth,e.image_info.height=s.elt.videoHeight,m(),s.elt.hidden=!1},50),s.showControls(),s.play(),e.ContentOnLoad=!0})).elt.hidden=!0,i.VideoMedia=s});let m=()=>{let d=e.ContentBox.offsetWidth,y=e.ContentBox.offsetHeight-e.FileHeader.offsetHeight,u=s.elt.videoWidth,h=s.elt.videoHeight;0!=u&&0!=h&&(d/y>u/h?(h=y,u=u/s.elt.videoHeight*h,s.elt.setAttribute("style","position: relative; left: 50%; transform: translateX(-50%);")):(u=d,h=h/s.elt.videoWidth*u||y/2,s.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);")),s.size(u,h))};i.windowResized=()=>{setTimeout(()=>{m()},50)};let x=i.createVector(),I={};i.touchStarted=d=>{if(e.useP5Navigator&&!document.pictureInPictureElement&&"changedTouches"in d){for(let u=0,h=d.changedTouches.length;u<h;u++)I[d.changedTouches[u].identifier]=i.createVector(d.changedTouches[u].clientX,d.changedTouches[u].clientY);1===Object.keys(I).length&&(x=I[d.changedTouches[0].identifier].copy())}},i.touchEnded=d=>{if(e.useP5Navigator&&!document.pictureInPictureElement&&"changedTouches"in d){let y;for(let h=0,k=d.changedTouches.length;h<k;h++)y=i.createVector(d.changedTouches[h].clientX,d.changedTouches[h].clientY),delete I[d.changedTouches[h].identifier];0===Object.keys(I).length&&(y.sub(x),y.x>50?e.ChangeToAnother(-1):y.x<-50&&e.ChangeToAnother(1))}}});break;case"text":e.p5canvas=new M(i=>{i.setup=()=>{i.noCanvas(),i.noLoop();let s=i.createElement("textarea");s.elt.disabled=!0,s.elt.className="infobox",s.elt.setAttribute("style","height: 100%; display: block;"),s.elt.textContent="",n.appendChild(s.elt),i.TextArea=s.elt,e.FileInfo.is_new?e.open_text_editor(s.elt):i.loadStrings(e.FileURL,m=>{s.elt.textContent=m.join("\n"),e.ContentOnLoad=!0},m=>{n.textContent=e.lang.text.ContentViewer.CannotOpenText,e.FileInfo.else=!0,e.ContentOnLoad=!0})}});break;case"godot":document.addEventListener("ionBackButton",e.EventListenerAct);let o,c=e.MessageInfo.message_id;try{let i=yield e.indexed.loadBlobFromUserPath((e.FileInfo.path||e.navParams.get("path"))+"_thumbnail.png","",void 0,e.targetDB);o=URL.createObjectURL(i)}catch{}!e.NeedDownloadFile&&e.CurrentViewId==c&&setTimeout((0,r.c)(function*(){let i=!1;if(e.indexed.godotDB)try{let s=yield e.indexed.loadBlobFromUserPath(e.FileInfo.path||e.navParams.get("path"),"",void 0,e.indexed.ionicDB);yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(s,"tmp_files/duplicate/viewer.pck",void 0,e.indexed.godotDB),i=!0}catch(s){console.log("\ub0b4\ubd80 \ud30c\uc77c \uc5c6\uc74c: ",s)}if(yield e.global.CreateGodotIFrame("content_viewer_canvas",{path:"tmp_files/duplicate/viewer.pck",alt_path:e.FileInfo.path||e.navParams.get("path"),ext:e.FileInfo.file_ext,url:e.FileInfo.url,background:o,receive_image:(s=(0,r.c)(function*(m,x,I){let _="tmp_files/modify_image.png";yield e.indexed.saveBase64ToUserPath(","+m,_),e.modalCtrl.dismiss({type:"image",path:_,width:x,height:I,msg:e.MessageInfo,index:e.RelevanceIndex-1})}),function(x,I,_){return s.apply(this,arguments)})},"start_load_pck"),!i){try{let s=yield e.indexed.loadBlobFromUserPath(e.FileInfo.path||e.navParams.get("path"),"",void 0,e.indexed.ionicDB);yield e.indexed.GetGodotIndexedDB(),yield e.indexed.saveBlobToUserPath(s,"tmp_files/duplicate/viewer.pck",void 0,e.indexed.godotDB)}catch{}yield e.global.CreateGodotIFrame("content_viewer_canvas",{path:"tmp_files/duplicate/viewer.pck",alt_path:e.FileInfo.path||e.navParams.get("path"),ext:e.FileInfo.file_ext,url:e.FileInfo.url,background:o,receive_image:function(){var s=(0,r.c)(function*(m,x,I){let _="tmp_files/modify_image.png";yield e.indexed.saveBase64ToUserPath(","+m,_),e.modalCtrl.dismiss({type:"image",path:_,width:x,height:I,msg:e.MessageInfo,index:e.RelevanceIndex-1})});return function(x,I,_){return s.apply(this,arguments)}}()},"start_load_pck")}var s;e.ContentOnLoad=!0,o&&URL.revokeObjectURL(o),e.FileInfo.url?e.global.godot_window.download_url():e.global.godot_window.start_load_pck()}),100);break;case"blender":let f=yield e.loadingCtrl.create({message:e.lang.text.ContentViewer.OnLoadContent});f.present(),e.p5canvas=new M(i=>{let _,s=[],m=[],I={};i.setup=(0,r.c)(function*(){let y,d=i.createCanvas(n.clientWidth,n.clientHeight,i.WEBGL);d.parent(n),i.canvas=d,i.textureMode(i.NORMAL),i.textureWrap(i.REPEAT),i.clear(255,255,255,0),i.pixelDensity(1);try{y=yield e.indexed.loadBlobFromUserPath(e.FileInfo.path,e.FileInfo.type||"")}catch{try{y=yield(yield fetch(e.FileInfo.url)).blob()}catch(k){console.log("\ubdf0\uc5b4\uc5d0\uc11c \ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",k)}}let u=i.createElement("iframe");u.elt.id="jsBlend",u.elt.setAttribute("src","assets/js.blend/index.html"),u.elt.setAttribute("frameborder","0"),u.elt.setAttribute("class","full_screen"),u.elt.setAttribute("allow","fullscreen; encrypted-media"),u.elt.setAttribute("scrolling","no"),u.elt.setAttribute("withCredentials","true"),u.elt.setAttribute("hidden","true"),n.appendChild(u.elt),u.elt.contentWindow.TARGET_FILE=y,u.elt.onload=(0,r.c)(function*(){if(!y)return e.p5toast.show({text:e.lang.text.ContentViewer.CannotOpenText}),void f.dismiss();_=i.createDiv(),_.parent(n),_.id("logDiv"),_.style("position","absolute"),_.style("width","100%"),_.style("height","100%"),_.style("max-height",`${n.clientHeight}px`),_.style("pointer-events","none");let h=yield u.elt.contentWindow.JSBLEND(y);const k=100;let S=h.file.AB;for(let G=0;G<h.file.objects.Object.length;G++){let g=h.file.objects.Object[G];f.message=`${e.lang.text.ContentViewer.ReadObject}: ${g.aname}`;let Q=i.createVector(-g.loc[0]*k,-g.loc[2]*k,g.loc[1]*k),q=i.createVector(g.rot[0],g.rot[2],-g.rot[1]);switch(g.type){case 0:case 11:break;case 1:{let X,N=(g.data.vdata.layers[0]||g.data.vdata.layers).data,J=(g.data.edata.layers[0]||g.data.edata.layers).data,de=(g.data.ldata.layers[0]||g.data.ldata.layers).data;i.beginGeometry(),i.push(),i.translate(Q),i.scale(g.size[0],g.size[2],g.size[1]),g.rot[0]+g.rot[1]+g.rot[2]&&(_.elt.innerHTML+=`<div style="color: var(--ion-color-warning-shade)">${g.aname}: ${e.lang.text.ContentViewer.MayGimbalLock}</div>`,i.rotate(i.HALF_PI,q));try{let O=[];for(let F=0,U=N.length;F<U;F++)O.push([]);for(let F=0,U=J.length;F<U;F++){var W,H;let L=null!==(W=J[F].x)&&void 0!==W?W:J[F].v1,R=null!==(H=J[F].y)&&void 0!==H?H:J[F].v2;O[L].push(R),O[R].push(L)}let te=4==de.length,P=[{u:0,v:1},{u:1,v:1},{u:1,v:0},{u:0,v:0}];for(let U,L,F=de.length-1;F>=0;F--){var p,$,C;let R=de[F].i,j=null!==(p=N[R].x)&&void 0!==p?p:N[R].co[0],ne=null!==($=N[R].y)&&void 0!==$?$:N[R].co[1],ie=null!==(C=N[R].z)&&void 0!==C?C:N[R].co[2];if(void 0!==L){try{if(!O[L].includes(R))throw"\ub9c8\uc9c0\ub9c9 \uc810\uc73c\ub85c\ubd80\ud130 \uadf8\ub9b4 \uc218 \uc5c6\uc74c";te?i.vertex(-j*k,-ie*k,ne*k,P[F].u,P[F].v):i.vertex(-j*k,-ie*k,ne*k);let fe=!1;if(L!=U&&(fe=O[R].includes(U)),fe)throw"\ub3cc\uc544\uac08 \uc218 \uc788\ub294\ub370 \ub3cc\uc544\uac00\uc9c0 \uc54a\ub294\ub2e4\uba74 \uc0c8 \uc2dc\uc791\uc810\uc73c\ub85c \uc778\uc2dd"}catch{i.endShape(i.CLOSE),L=void 0;continue}L=R}else i.beginShape(),te?i.vertex(-j*k,-ie*k,ne*k,P[F].u,P[F].v):i.vertex(-j*k,-ie*k,ne*k),U=R,L=R}}catch(O){console.log("\uba54\uc26c \uc815\ubcf4 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",O)}i.pop(),X=i.endGeometry();let ee,_e,he,ge=0;try{if(!g.data.mat.length)throw"no_mat";for(let O=0,te=g.data.mat.length;O<te;O++){try{let P=g.data.mat[O].nodetree.nodes.first.next.inputs.first.default_value.value;_e=i.color(255*P[0],255*P[1],255*P[2],255*P[3])}catch(P){console.log("\ubca0\uc774\uc2a4 \uc0c9\uc0c1 \uac00\uc838\uc624\uae30 \uc2e4\ud328: ",P)}try{let P=g.data.mat[O].nodetree.nodes.first.next.inputs.last.prev.default_value.value;ge=g.data.mat[O].nodetree.nodes.first.next.inputs.last.default_value.value,he=i.color(255*P[0],255*P[1],255*P[2],255*P[3])}catch(P){console.log("\uc774\ubbf8\uc158 \uc815\ubcf4 \uc218\uc9d1 \uc2e4\ud328: ",P)}if(g.data.mat[O].nodetree.nodes.last.id){let P=g.data.mat[O].nodetree.nodes.last.id.packedfile;if(!P)throw"unpacked";if(I[P.data.__data_address__])throw"duplicated";ee=P.data.__data_address__;let U=S.slice(ee,ee+P.size),L=new Blob([U]),R=URL.createObjectURL(L);i.loadImage(R,j=>{I[P.data.__data_address__]=j,_.elt.innerHTML+=`<div style="color: var(--ion-color-danger-shade)">${g.aname}: ${e.lang.text.ContentViewer.OnWorkReadUV}</div>`,URL.revokeObjectURL(R)},j=>{console.log("\ud14d\uc2a4\uccd0 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",j),URL.revokeObjectURL(R)})}}}catch(O){switch(O){case"unpacked":_.elt.innerHTML+=`<div style="color: var(--ion-color-warning-shade)">${g.aname}: ${e.lang.text.ContentViewer.LinkedTexFile}</div>`;break;case"duplicated":break;case"no_mat":_.elt.innerHTML+=`<div style="color: var(--ion-color-medium-shade)">${g.aname}: ${e.lang.text.ContentViewer.NoMaterial}</div>`;break;default:console.log(g.aname,"_\uc7ac\uc9c8 \uc815\ubcf4 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",O),_.elt.innerHTML+=`<div style="color: var(--ion-color-danger-shade)">${g.aname}: ${O}</div>`}}X.computeNormals(),m.push({id:g.data.address,name:g.data.aname,color:_e,emissionColor:he,emissionStrength:ge,texture:ee,mesh:X})}break;case 10:s.length<5?(_.elt.innerHTML+=`<div style="color: var(--ion-color-warning-shade)">${g.aname}: ${e.lang.text.ContentViewer.OnWorkReadLightMode}</div>`,s.push({type:"point",loc:Q,rot:q,color:i.color(255,255,255)})):_.elt.innerHTML+=`<div style="color: var(--ion-color-medium-shade)">${g.aname}: ${e.lang.text.ContentViewer.ReachLightLimit}</div>`;break;default:_.elt.innerHTML+=`<div style="color: var(--ion-color-medium-shade)>${g.aname}: ${e.lang.text.ContentViewer.OnWorkObjectType}_${g.type}</div>`}yield new Promise(X=>setTimeout(X,0))}f.dismiss(),setTimeout(()=>{_.elt.remove()},8e3),e.ContentOnLoad=!0})}),i.draw=()=>{if(i.clear(255,255,255,0),i.orbitControl(),s.length)for(let d=0,y=s.length;d<y;d++)"point"===s[d].type&&i.pointLight(s[d].color,s[d].loc);else i.lights();for(let d=0,y=m.length;d<y;d++)i.push(),m[d].texture?(i.noStroke(),I[m[d].texture]&&i.texture(I[m[d].texture])):m[d].color&&(i.noStroke(),i.ambientMaterial(m[d].color)),m[d].emissionStrength&&(i.noStroke(),i.emissiveMaterial(m[d].emissionColor)),i.model(m[d].mesh),i.pop()},i.windowResized=()=>{setTimeout(()=>{n.style.maxHeight=window.innerHeight-56-45+"px",_&&_.style("max-height",`${n.clientHeight}px`),i.resizeCanvas(n.clientWidth,n.clientHeight)},50)}});break;default:console.log("\uc815\uc758\ub418\uc9c0 \uc54a\uc740 \ud30c\uc77c \uc815\ubcf4: ",e.FileInfo.viewer);case"disabled":e.p5canvas=new M(i=>{i.setup=()=>{i.noCanvas()}}),e.ContentOnLoad=!0}e.ChangeContentWithKeyInput()})()}ChangeContentWithKeyInput(){this.p5canvas&&(this.p5canvas.keyPressed=e=>{if(!this.isTextEditMode)switch(e.code){case"KeyA":case"ArrowLeft":this.ChangeToAnother(-1);break;case"KeyS":this.download_file();break;case"KeyD":case"ArrowRight":this.ChangeToAnother(1);break;case"KeyS":this.NeedDownloadFile&&this.DownloadCurrentFile()}})}open_bottom_modal(){this.ShowContentInfoIonic.onDidDismiss().then(e=>{this.useP5Navigator=!0}),this.useP5Navigator=!1,this.ShowContentInfoIonic.present()}open_text_editor(e=this.p5canvas.TextArea){e.disabled=!1,setTimeout(()=>{this.isTextEditMode=!0,e.focus()},500)}SaveText(){var e=this;return(0,r.c)(function*(){let n=new Blob([e.p5canvas.TextArea.value],{type:e.FileInfo.type});if(n.name=e.NewTextFileName||e.FileInfo.filename||e.FileInfo.name,e.OpenInChannelChat)e.modalCtrl.dismiss({type:"text",blob:n,contentRelated:e.FileInfo.content_related_creator});else{let o=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});o.present();let c=`tmp_files/texteditor/${e.FileInfo.filename||e.FileInfo.name}`;e.FileInfo.path||(e.FileInfo.path=c),yield e.indexed.saveBlobToUserPath(n,c,void 0,e.targetDB),o.dismiss(),e.p5toast.show({text:e.lang.text.ContentViewer.fileSaved}),e.modalCtrl.dismiss({type:"text",blob:n,path:c,index:e.RelevanceIndex-1})}})()}modify_image(){var e=this;return(0,r.c)(function*(){switch(e.FileInfo.viewer){case"image":{let o=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});o.present();try{let c;e.image_info.path=e.FileInfo.path||e.navParams.get("path"),e.FileInfo.url&&(e.image_info.path="tmp_files/modify_image.png",c=yield fetch(e.FileInfo.url).then(f=>f.blob()),yield e.indexed.saveBlobToUserPath(c,e.image_info.path)),e.modalCtrl.dismiss({type:"image",...e.image_info,path:e.image_info.path,msg:e.MessageInfo,index:e.RelevanceIndex-1})}catch(c){e.p5toast.show({text:`${e.lang.text.ContentViewer.CannotEditFile}: ${c}`})}o.dismiss()}break;case"text":let n=e.p5canvas.TextArea.textContent.split("\n");e.modalCtrl.dismiss({type:"image",text:n,msg:e.MessageInfo,index:e.RelevanceIndex-1});break;case"video":try{let o=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});o.present(),e.p5canvas.pixelDensity(1),e.p5canvas.VideoMedia.pause(),e.p5canvas.VideoMedia.size(e.image_info.width,e.image_info.height);let c=e.p5canvas.createCanvas(e.image_info.width,e.image_info.height);e.p5canvas.image(e.p5canvas.VideoMedia,0,0,e.p5canvas.width,e.p5canvas.height);let f=c.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{o.dismiss(),e.image_info.path="tmp_files/modify_image.png",yield e.indexed.saveBase64ToUserPath(f,e.image_info.path),e.modalCtrl.dismiss({type:"image",...e.image_info,msg:e.MessageInfo,index:e.RelevanceIndex-1})}catch(i){console.log("\ud30c\uc77c \uc800\uc7a5 \uc624\ub958: ",i)}}catch(o){console.log("\uc7ac\uc0dd\uc911\uc778 \ube44\ub514\uc624 \uc774\ubbf8\uc9c0 \ucd94\ucd9c \uc624\ub958: ",o)}break;case"blender":try{let o=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});o.present(),e.p5canvas.pixelDensity(1);let c=e.p5canvas.canvas.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{o.dismiss(),e.image_info.path="tmp_files/modify_image.png",e.image_info.width=e.p5canvas.width,e.image_info.height=e.p5canvas.height,yield e.indexed.saveBase64ToUserPath(c,e.image_info.path),e.modalCtrl.dismiss({type:"image",...e.image_info,msg:e.MessageInfo,index:e.RelevanceIndex-1})}catch(f){console.log("\ud30c\uc77c \uc800\uc7a5 \uc624\ub958: ",f)}}catch(o){console.log("\uc7ac\uc0dd\uc911\uc778 \ube44\ub514\uc624 \uc774\ubbf8\uc9c0 \ucd94\ucd9c \uc624\ub958: ",o)}break;case"godot":e.global.godot_window.modify_image();break;default:console.log("\ud3b8\uc9d1 \ubd88\uac00 \ud30c\uc77c \uc815\ubcf4: ",e.FileInfo)}})()}download_file(){var e=this;return(0,r.c)(function*(){if("DesktopPWA"==A.s1||"MobilePWA"==A.s1)if(e.FileInfo.url)try{let n=yield fetch(e.FileInfo.url),o=yield n.blob();if(!n.ok)throw"\uc81c\ub300\ub85c \ub2e4\uc6b4\ubc1b\uc544\uc9c0\uc9c0 \uc54a\uc74c";yield e.indexed.saveBlobToUserPath(o,e.FileInfo.path),e.indexed.DownloadFileFromUserPath(e.FileInfo.path,e.FileInfo.type,e.FileInfo.filename||e.FileInfo.name,e.targetDB)}catch(n){console.log("\ub2e4\uc6b4\ubc1b\uae30 \uc2e4\ud328: ",n),e.p5toast.show({text:`${e.lang.text.Nakama.FailedDownload}: ${n}`})}else e.indexed.DownloadFileFromUserPath(e.FileInfo.path,e.FileInfo.type,e.FileInfo.filename||e.FileInfo.name,e.targetDB);else e.alertCtrl.create({header:e.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:e.FileInfo.filename||e.FileInfo.name,type:"text"}],buttons:[{text:e.lang.text.ContentViewer.saveFile,handler:(n=(0,r.c)(function*(o){if(e.FileInfo.url)try{let c=yield fetch(e.FileInfo.url),f=yield c.blob();if(!c.ok)throw"\uc81c\ub300\ub85c \ub2e4\uc6b4\ubc1b\uc544\uc9c0\uc9c0 \uc54a\uc74c";yield e.indexed.saveBlobToUserPath(f,e.FileInfo.path),e.DownloadFileAct(o)}catch(c){console.log("\ub2e4\uc6b4\ubc1b\uae30 \uc2e4\ud328: ",c),e.p5toast.show({text:`${e.lang.text.Nakama.FailedDownload}: ${c}`})}else e.DownloadFileAct(o)}),function(c){return n.apply(this,arguments)})}]}).then(n=>n.present());var n})()}DownloadFileAct(e){var n=this;return(0,r.c)(function*(){let o=yield n.loadingCtrl.create({message:n.lang.text.TodoDetail.WIP});o.present();let c=e.filename?e.filename.replace(/:|\?|\/|\\|<|>/g,""):n.FileInfo.filename||n.FileInfo.name,f=yield n.indexed.loadBlobFromUserPath(n.FileInfo.path,n.FileInfo.type,void 0,n.targetDB);n.forceWrite&&!e.filename?n.file.writeExistingFile(n.file.externalDataDirectory,c,f).then(i=>{n.forceWrite=!1,o.dismiss(),n.p5toast.show({text:`${n.lang.text.ContentViewer.OverWriteFile}: ${c}`})}):n.file.writeFile(n.file.externalDataDirectory,c,f).then(i=>{o.dismiss(),n.p5toast.show({text:n.lang.text.ContentViewer.fileSaved})}).catch(i=>{12===(o.dismiss(),i.code)?(n.p5toast.show({text:n.lang.text.ContentViewer.AlreadyExist}),n.forceWrite=!0,n.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",i)})})()}toast_info(e){e.various_display||this.set_various_display(e),this.p5toast.show({text:e.various_display})}ShareContent(){let e=this.nakama.rearrange_channels();for(let n=e.length-1;n>=0;n--)("missing"==e[n].status||"offline"==e[n].status)&&e.splice(n,1);e.length?this.modalCtrl.create({component:oe._,componentProps:{file:this.FileInfo,channels:e}}).then(n=>{n.onDidDismiss().then(o=>{o.data&&this.modalCtrl.dismiss()}),n.present()}):this.p5toast.show({text:this.lang.text.ShareContentToOther.NoChannelToShare})}RemoveFile(){this.alertCtrl.create({header:this.lang.text.ContentViewer.RemoveFile,message:this.FileInfo.path,buttons:[{text:this.lang.text.TodoDetail.remove,handler:()=>{this.RemoveFileAct()},cssClass:"red_font"}]}).then(e=>e.present())}RemoveFileAct(){var e=this;return(0,r.c)(function*(){URL.revokeObjectURL(e.FileURL),delete e.FileInfo.thumbnail,delete e.FileInfo.text,yield e.indexed.removeFileFromUserPath(e.FileInfo.path,void 0,e.targetDB),e.RelevanceIndex-=1,e.ChangeToAnother(1)})()}ionViewWillLeave(){var e=this;return(0,r.c)(function*(){switch(document.removeEventListener("ionBackButton",e.EventListenerAct),e.FileInfo.viewer){case"video":try{let c,f,o=e.p5canvas.VideoMedia.size();o.width>o.height?(c=192,f=o.height/o.width*192):(c=o.width/o.height*192,f=192);let i=e.p5canvas.createCanvas(c,f);e.p5canvas.pixelDensity(1),e.p5canvas.imageMode(e.p5canvas.CORNER),e.p5canvas.image(e.p5canvas.VideoMedia,0,0,c,f),e.p5canvas.fill(255,128),e.p5canvas.rect(0,0,c,f),e.p5canvas.textWrap(e.p5canvas.CHAR),e.p5canvas.textSize(16);let s=f/16;e.p5canvas.push(),e.p5canvas.translate(s/6,s/6),e.p5canvas.fill(0),e.p5canvas.text(e.FileInfo.filename||e.FileInfo.name,s,s,c-2*s,f-2*s),e.p5canvas.filter(e.p5canvas.BLUR,3),e.p5canvas.pop(),e.p5canvas.fill(255),e.p5canvas.text(e.FileInfo.filename||e.FileInfo.name,s,s,c-2*s,f-2*s);let m=i.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{yield e.indexed.saveBase64ToUserPath(m,`${e.FileInfo.path}_thumbnail.png`,void 0,e.targetDB),e.FileInfo.thumbnail=m,e.global.modulate_thumbnail(e.FileInfo,""),e.p5canvas&&e.p5canvas.remove()}catch(x){console.log("\uc378\ub124\uc77c \uc800\uc7a5 \uc624\ub958: ",x)}}catch(o){console.log("\ube44\ub514\uc624 \uc378\ub124\uc77c \uc0dd\uc131 \ucde8\uc18c: ",o)}break;case"godot":try{e.global.godot_window.filename=e.FileInfo.filename||e.FileInfo.name,e.global.godot_window.create_thumbnail(e.FileInfo),(yield e.indexed.GetFileListFromDB("tmp_files",void 0,e.indexed.godotDB)).forEach(c=>e.indexed.removeFileFromUserPath(c,void 0,e.indexed.godotDB)),e.p5canvas&&e.p5canvas.remove()}catch(o){console.log("godot \uc378\ub124\uc77c \uc800\uc7a5 \uc624\ub958: ",o)}break;case"blender":let n=e.p5canvas.canvas.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{new M(o=>{o.setup=()=>{o.loadImage(n,function(){var c=(0,r.c)(function*(f){let i,s;f.width>f.height?(i=192,s=f.height/f.width*192):(i=f.width/f.height*192,s=192);let m=o.createCanvas(i,s);o.pixelDensity(1),o.imageMode(o.CORNER),o.image(f,0,0,o.width,o.height),o.fill(255,128),o.rect(0,0,i,s),o.textWrap(o.CHAR),o.textSize(16);let x=s/16;o.push(),o.translate(x/6,x/6),o.fill(0),o.text(e.FileInfo.filename||e.FileInfo.name,x,x,i-2*x,s-2*x),o.filter(o.BLUR,3),o.pop(),o.fill(255),o.text(e.FileInfo.filename||e.FileInfo.name,x,x,i-2*x,s-2*x);let I=m.elt.toDataURL("image/png").replace("image/png","image/octet-stream");yield e.indexed.saveBase64ToUserPath(I,`${e.FileInfo.path}_thumbnail.png`,void 0,e.targetDB),e.FileInfo.thumbnail=I,e.global.modulate_thumbnail(e.FileInfo,""),o.remove(),e.p5canvas&&e.p5canvas.remove()});return function(f){return c.apply(this,arguments)}}(),c=>{console.log("\ube14\ub80c\ub354 \uc378\ub124\uc77c \ubc30\uacbd \ubc1b\uc544\uc624\uae30 \uc624\ub958: ",c),o.remove(),e.p5canvas&&e.p5canvas.remove()})}})}catch(o){console.log("blender \uc378\ub124\uc77c \uc800\uc7a5 \uc624\ub958: ",o)}break;default:e.p5canvas&&e.p5canvas.remove()}URL.revokeObjectURL(e.FileURL);try{(yield e.file.checkFile(e.file.externalDataDirectory,`viewer_tmp.${e.FileInfo.file_ext}`))&&(yield e.file.removeFile(e.file.externalDataDirectory,`viewer_tmp.${e.FileInfo.file_ext}`))}catch{}})()}copy_url(e){this.mClipboard.copy(e).catch(n=>le.c.write(e))}}return(l=v).\u0275fac=function(e){return new(e||l)(t.GI1(b.qS),t.GI1(se.a6),t.GI1(re.k),t.GI1(ce.o),t.GI1(E.S),t.GI1(Y.O),t.GI1(b.iW),t.GI1(b.Kg),t.GI1(T.A1),t.GI1(D.h),t.GI1(B._),t.GI1(K.s))},l.\u0275cmp=t.In1({type:l,selectors:[["app-ionic-viewer"]],viewQuery:function(e,n){if(1&e&&t.CC$(ue,5),2&e){let o;t.wto(o=t.Gqi())&&(n.ShowContentInfoIonic=o.first)}},decls:29,vars:18,consts:[[1,"ion-no-border"],["id","Toolbar"],["slot","start",3,"click"],["defaultHref",""],["class","relevance_change","style","padding-right: 16px;","slot","end","name","pause-circle",3,"click",4,"ngIf"],["class","relevance_change","style","padding-right: 16px;","slot","end","name","play-circle",3,"click",4,"ngIf"],["class","relevance_change","style","padding-right: 4px;","slot","end","name","arrow-back-circle-outline",3,"click",4,"ngIf"],["slot","end",4,"ngIf"],["class","relevance_change","style","padding-right: 16px; padding-left: 4px;","slot","end","name","arrow-forward-circle-outline",3,"click",4,"ngIf"],["id","ContentBox","oncontextmenu","return false;"],[1,"main_table_elt"],[2,"height","0"],["id","FileHeader",2,"max-width","100vw"],["text-wrap","","style","overflow-x: auto;",4,"ngIf"],["type","text","text-warp","","style","overflow-x: auto; overflow-y: hidden;",3,"ngModel","placeholder","ngModelChange",4,"ngIf"],[3,"click",4,"ngIf"],["class","ion-align-items-center",3,"disabled","click",4,"ngIf"],["id","menu_trigger",4,"ngIf"],["trigger","menu_trigger","dismissOnSelect","",4,"ngIf"],[4,"ngIf"],[3,"initialBreakpoint","breakpoints"],["ShowContentInfoIonic",""],["slot","end","name","pause-circle",1,"relevance_change",2,"padding-right","16px",3,"click"],["slot","end","name","play-circle",1,"relevance_change",2,"padding-right","16px",3,"click"],["slot","end","name","arrow-back-circle-outline",1,"relevance_change",2,"padding-right","4px",3,"click"],["slot","end"],["slot","end","name","arrow-forward-circle-outline",1,"relevance_change",2,"padding-right","16px","padding-left","4px",3,"click"],["text-wrap","",2,"overflow-x","auto"],["type","text","text-warp","",2,"overflow-x","auto","overflow-y","hidden",3,"ngModel","placeholder","ngModelChange"],[3,"click"],["name","close-circle-outline"],["name","save-outline"],[1,"ion-align-items-center",3,"disabled","click"],["name","code-download-outline"],["id","menu_trigger"],["name","ellipsis-vertical"],["trigger","menu_trigger","dismissOnSelect",""],["button","",3,"click",4,"ngIf"],["button","",3,"click"],["id","content_viewer_canvas",1,"full_screen",2,"max-width","100vw"],[1,"disconnect_info"],["color","medium","name","attach-outline",2,"width","60px","height","60px"],["color","medium"],[1,"ion-align-items-center"],["size","12",1,"ion-text-center"],["color","warning","shape","round",1,"ion-align-items-center",3,"disabled","click"],["button","",4,"ngIf"],[1,"ion-text-end"],[4,"ngFor","ngForOf"],[1,"ion-text-center"],["button",""],[1,"history_center"],["color","secondary","mode","ios","outline","true",3,"click"],["name","document-attach-outline",4,"ngIf"],["name","camera-outline",4,"ngIf"],["name","link-outline",4,"ngIf"],["name","text-outline",4,"ngIf"],["name","document-text-outline",4,"ngIf"],["name","share-social-outline",4,"ngIf"],["name","document-attach-outline"],["name","camera-outline"],["name","link-outline"],["name","text-outline"],["name","document-text-outline"],["name","share-social-outline"],["src","assets/icon/voidDraw.png"]],template:function(e,n){1&e&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar",1)(2,"ion-title"),t.OEk(3),t.C$Y(),t.I0R(4,"ion-buttons",2),t.qCj("click",function(){return n.modalCtrl.dismiss()}),t.wR5(5,"ion-back-button",3),t.C$Y(),t.yuY(6,pe,1,0,"ion-icon",4)(7,ve,1,0,"ion-icon",5)(8,Ie,1,0,"ion-icon",6)(9,xe,2,1,"ion-label",7)(10,ye,1,0,"ion-icon",8),t.C$Y()(),t.I0R(11,"ion-content",9)(12,"table",10)(13,"tr",11)(14,"td")(15,"ion-list-header",12),t.yuY(16,Ce,2,1,"ion-label",13)(17,we,1,2,"ion-input",14)(18,be,2,0,"ion-button",15)(19,ke,2,0,"ion-button",15)(20,Te,2,1,"ion-button",16)(21,Pe,2,0,"ion-button",17)(22,Be,2,0,"ion-popover",18),t.C$Y()()(),t.I0R(23,"tr"),t.yuY(24,Ve,3,1,"td",19)(25,Le,6,2,"td",19),t.C$Y()(),t.I0R(26,"ion-modal",20,21),t.yuY(28,Qe,19,9,"ng-template"),t.C$Y()()),2&e&&(t.yG2(3),t.cNF(n.lang.text.ContentViewer.Title),t.yG2(3),t.E7m("ngIf",("video"==n.FileInfo.viewer||"audio"==n.FileInfo.viewer)&&n.AutoPlayNext),t.yG2(),t.E7m("ngIf",("video"==n.FileInfo.viewer||"audio"==n.FileInfo.viewer)&&!n.AutoPlayNext),t.yG2(),t.E7m("ngIf",n.HaveRelevances),t.yG2(),t.E7m("ngIf",n.HaveRelevances),t.yG2(),t.E7m("ngIf",n.HaveRelevances),t.yG2(6),t.E7m("ngIf",!n.isTextEditMode),t.yG2(),t.E7m("ngIf",n.isTextEditMode),t.yG2(),t.E7m("ngIf",n.isTextEditMode),t.yG2(),t.E7m("ngIf",n.isTextEditMode),t.yG2(),t.E7m("ngIf",n.isChannelOnline&&n.HaveRelevances&&!n.isTextEditMode&&!n.fromLocalChannel),t.yG2(),t.E7m("ngIf",!n.isTextEditMode),t.yG2(),t.E7m("ngIf",!n.isTextEditMode),t.yG2(2),t.E7m("ngIf",!n.NeedDownloadFile),t.yG2(),t.E7m("ngIf",n.NeedDownloadFile),t.yG2(),t.E7m("initialBreakpoint",.5)("breakpoints",t.q4q(17,Xe)))},dependencies:[z.ay,z.u_,Z.ue,Z._G,b.O7,b.sn,b.GS,b.cz,b.Kk,b._i,b.YP,b.wB,b.Ko,b.A5,b.Yb,b.S8,b.QR,b.OC,b.zz,b.qo,b.tM,b.Md,b.yc,b.sW,b.qG,b.Im],styles:[".main_table_elt[_ngcontent-%COMP%]{width:100%;height:100%;border:0;margin:0}.relevance_change[_ngcontent-%COMP%]{width:25px;height:25px}.history_center[_ngcontent-%COMP%]{text-align:center}"]}),v})()},896:(me,ae,w)=>{w.d(ae,{_:()=>ce});var r=w(4496),A=w(4500),M=w(9240),V=w(5624),oe=w(4180),le=w(7136),t=w(1368);function b(E,Y){if(1&E&&r.wR5(0,"img",12),2&E){const T=r.GaO().$implicit;r.m_g("online"==T.status||3==T.redirect.type&&"pending"==T.status?"filter: grayscale(0) contrast(1)":"filter: grayscale(.9) contrast(1.4)"),r.E7m("src",T.info.img||"assets/data/channel.svg",r.K6U)}}function se(E,Y){if(1&E&&r.wR5(0,"div",13),2&E){const T=r.GaO().$implicit;r.m_g("background-image: linear-gradient(to right, #0000, #"+(T.color||"abcdef")+"44)")}}function re(E,Y){if(1&E){const T=r.KQA();r.I0R(0,"ion-item",4),r.qCj("click",function(){const K=r.usT(T).$implicit,z=r.GaO();return r.CGJ(z.go_to_chatroom(K))}),r.I0R(1,"div",5),r.yuY(2,b,1,3,"img",6),r.wR5(3,"div",7),r.C$Y(),r.yuY(4,se,1,2,"div",8),r.I0R(5,"ion-label")(6,"div",9)(7,"table")(8,"tr")(9,"td"),r.OEk(10),r.C$Y(),r.I0R(11,"td",10),r.OEk(12),r.C$Y()()()(),r.I0R(13,"div",11),r.OEk(14),r.C$Y()()()}if(2&E){const T=Y.$implicit,D=r.GaO();r.yG2(2),r.E7m("ngIf",T.info),r.yG2(),r.m_g("background-color: "+D.statusBar.colors[T.status||"offline"]),r.yG2(),r.E7m("ngIf",T.is_new),r.yG2(6),r.oRS(" ",T.info?T.info.name||T.info.display_name||D.lang.text.ChatRoom.noname_chatroom:T.title||D.lang.text.ChatRoom.noname_chatroom," "),r.yG2(2),r.oRS(" ","("+T.server.target+")"," "),r.yG2(2),r.oRS(" ",T.last_comment||T.noti||D.lang.text.Subscribes.noMessageHistory," ")}}let ce=(()=>{var E;class Y{constructor(D,B,K,z,Z){this.lang=D,this.navParams=B,this.modalCtrl=K,this.statusBar=z,this.nakama=Z,this.BackButtonPressed=!1}InitBrowserBackButtonOverride(){window.history.replaceState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.modalCtrl.dismiss())}}ngOnInit(){this.InitBrowserBackButtonOverride(),this.channels=this.navParams.get("channels")}go_to_chatroom(D){let B=this.navParams.get("file");delete B.db,this.nakama.go_to_chatroom_without_admob_act(D,B),this.modalCtrl.dismiss(!0)}}return(E=Y).\u0275fac=function(D){return new(D||E)(r.GI1(A.o),r.GI1(M.a6),r.GI1(V.qS),r.GI1(oe.Y),r.GI1(le.h))},E.\u0275cmp=r.In1({type:E,selectors:[["app-share-content-to-other"]],decls:11,vars:3,consts:[[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click"],[1,"channel_image"],["class","channel_image","alt","ch_img",3,"src","style",4,"ngIf"],[1,"status_circle"],["class","additional_form new_bg_form",3,"style",4,"ngIf"],[1,"channel_text_form","header"],[1,"channel_text_form","server_target"],[1,"form_margin","content"],["alt","ch_img",1,"channel_image",3,"src"],[1,"additional_form","new_bg_form"]],template:function(D,B){1&D&&(r.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),r.OEk(3),r.C$Y(),r.I0R(4,"ion-buttons",1),r.qCj("click",function(){return B.modalCtrl.dismiss()}),r.wR5(5,"ion-back-button",2),r.C$Y()()(),r.I0R(6,"ion-content")(7,"ion-item-divider")(8,"ion-label"),r.OEk(9),r.C$Y()(),r.yuY(10,re,15,7,"ion-item",3),r.C$Y()),2&D&&(r.yG2(3),r.cNF(B.lang.text.ShareContentToOther.Title),r.yG2(6),r.cNF(B.lang.text.ShareContentToOther.AvailableChannels),r.yG2(),r.E7m("ngForOf",B.channels))},dependencies:[t.ay,t.u_,V.GS,V._i,V.wB,V.Yb,V.S8,V.QR,V.tM,V.Md,V.Im],styles:[".server_target[_ngcontent-%COMP%]{color:#888;padding-left:4px}.content[_ngcontent-%COMP%]{color:#888;height:24px;display:table-cell;vertical-align:middle;padding:0 16px}.channel_image[_ngcontent-%COMP%]{width:52px;height:52px;border-radius:64px;object-fit:cover}.status_circle[_ngcontent-%COMP%]{position:relative;top:-56px;left:38px;width:12px;height:12px;border-radius:12px}.channel_text_form[_ngcontent-%COMP%]{margin-left:12px}"]}),Y})()}}]);