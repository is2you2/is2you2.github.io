"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6810],{6810:(q,k,p)=>{p.r(k),p.d(k,{EnginepptPageModule:()=>K});var w=p(6814),E=p(95),g=p(1325),A=p(5877),h=p(5861),u=p(3641),C=p(9868),e=p(9468),Z=p(3857),B=p(6052),y=p(7488);let J=(()=>{var s;class d{constructor(t){this.statusBar=t,this.list={},this.addresses=[]}initialize(t,n,o,l){if("DesktopPWA"!=u.n$&&"MobilePWA"!=u.n$){if(null!=this.list[t])return console.warn("\ub3d9\uc77c\ud55c \uc11c\ubc84 \uad6c\uc131\uc774 \uc774\ubbf8 \uc874\uc7ac\ud568: ",this.list),void((!this.statusBar.tools[t]||"offline"==this.statusBar.tools[t])&&delete this.list[t]);this.statusBar.tools[t]="pending",this.list[t]={},this.list[t].OnConnected={},this.list[t].OnDisconnected={},this.list[t].server||(this.list[t].server=cordova.plugins.wsserver),this.check_addresses(t),this.list[t].server.start(n,{onFailure:(r,a,c)=>{this.onServerClose(t),this.stop(t)},onOpen:r=>{if(this.list[t].users?(console.log("1:1 \ub9e4\uce6d\uc774 \uc644\ub8cc\ub428"),this.list[t].server.close({uuid:r.uuid},4001,"\ud5c8\uc6a9\ub418\uc9c0 \uc54a\uc740 \uc0ac\uc6a9\uc790")):(this.list[t].users=r.uuid,this.statusBar.tools[t]="certified"),this.list[t].OnConnected){let a=Object.keys(this.list[t].OnConnected);for(let c=0,T=a.length;c<T;c++)this.list[t].OnConnected[a[c]](r)}},onMessage:(r,a)=>{try{let c=JSON.parse(a);l(c)}catch(c){console.error(`Tool-server_json \ubcc0\ud658 \uc624\ub958_${a}: ${c}`)}},onClose:(r,a,c,T)=>{if(this.statusBar.tools[t]="online",delete this.list[t].users,this.list[t].OnDisconnected){let v=Object.keys(this.list[t].OnDisconnected);for(let m=0,x=v.length;m<x;m++)this.list[t].OnDisconnected[v[m]]()}},origins:[],protocols:[],tcpNoDelay:!0},(r,a)=>{this.statusBar.tools[t]="online",o&&o()},r=>{this.onServerClose(t),this.stop(t)})}else this.stop(t)}stop(t){"DesktopPWA"!=u.n$&&"MobilePWA"!=u.n$&&this.list[t].server.stop((n,o)=>{this.onServerClose(t),delete this.list[t]})}onServerClose(t){delete this.list[t].users,this.statusBar.tools[t]="missing",setTimeout(()=>{this.statusBar.tools[t]="offline"},1e3)}check_addresses(t){"DesktopPWA"!=u.n$&&"MobilePWA"!=u.n$&&(this.list[t].server||(this.list[t].server=cordova.plugins.wsserver),this.list[t].server.getInterfaces(n=>{this.addresses.length=0;let o=Object.keys(n);for(let l=0,r=o.length;l<r;l++)this.addresses=[...this.addresses,...n[o[l]].ipv4Addresses]}))}send_to(t,n){this.list[t].users&&this.list[t]&&this.list[t].server&&this.list[t].server.send({uuid:this.list[t].users},n)}}return(s=d).\u0275fac=function(t){return new(t||s)(e.LFG(y.g))},s.\u0275prov=e.Yz7({token:s,factory:s.\u0275fac,providedIn:"root"}),d})();var R=p(797),D=p(9376),M=p(4093),L=p(7429);function F(s,d){if(1&s&&(e.TgZ(0,"ion-header",4)(1,"ion-toolbar")(2,"ion-title"),e._uU(3),e.qZA(),e.TgZ(4,"ion-buttons",5),e._UZ(5,"ion-back-button",6),e.qZA()()()),2&s){const i=e.oxw();e.xp6(3),e.Oqu(i.lang.text.Settings.EnginePPT)}}function Y(s,d){1&s&&e._UZ(0,"div",7)}function G(s,d){if(1&s){const i=e.EpF();e.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),e._uU(3),e.qZA()(),e.TgZ(4,"textarea",8),e.NdJ("ngModelChange",function(n){e.CHM(i);const o=e.oxw();return e.KtG(o.RemoteDesc=n)}),e.qZA()()}if(2&s){const i=e.oxw();e.xp6(3),e.Oqu(i.lang.text.EngineWorksPPT.Manual),e.xp6(1),e.Q6J("ngModel",i.RemoteDesc)}}function U(s,d){if(1&s){const i=e.EpF();e.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),e._uU(3),e.qZA()(),e.TgZ(4,"ion-item")(5,"ion-input",12),e.NdJ("ngModelChange",function(n){e.CHM(i);const o=e.oxw(2);return e.KtG(o.InputAddress=n)}),e.qZA()(),e.TgZ(6,"ion-item",13),e.NdJ("click",function(){e.CHM(i);const n=e.oxw(2);return e.KtG(n.ConnectToAddress())}),e.TgZ(7,"ion-label",10),e._uU(8),e.qZA()()()}if(2&s){const i=e.oxw(2);e.xp6(3),e.Oqu(i.lang.text.EngineWorksPPT.ManualLink),e.xp6(2),e.Q6J("label",i.lang.text.EngineWorksPPT.Address)("ngModel",i.InputAddress)("placeholder",i.lang.text.EngineWorksPPT.InputAddress+" (IPv4)"),e.xp6(1),e.Q6J("disabled",i.ConnectButtonDisabled),e.xp6(2),e.Oqu(i.lang.text.EngineWorksPPT.Connect)}}function H(s,d){if(1&s){const i=e.EpF();e.TgZ(0,"div"),e.YNc(1,U,9,6,"div",2),e.TgZ(2,"ion-item-divider")(3,"ion-label"),e._uU(4),e.qZA()(),e.TgZ(5,"ion-item",9),e.NdJ("click",function(){e.CHM(i);const n=e.oxw();return e.KtG(n.buttonClickLinkInputFile())}),e.TgZ(6,"ion-label",10),e._uU(7),e.qZA()(),e.TgZ(8,"input",11),e.NdJ("change",function(n){e.CHM(i);const o=e.oxw();return e.KtG(o.inputpckselected(n))}),e.qZA()()}if(2&s){const i=e.oxw();e.xp6(1),e.Q6J("ngIf",!i.LinkedAddress&&!i.isSSLConnect),e.xp6(3),e.Oqu(i.lang.text.EngineWorksPPT.JustStart),e.xp6(3),e.Oqu(i.lang.text.EngineWorksPPT.DropFileHere),e.xp6(1),e.Q6J("id",i.engine_ppt_file_sel)}}function $(s,d){if(1&s){const i=e.EpF();e.TgZ(0,"div")(1,"ion-item",14),e._UZ(2,"div",15),e.TgZ(3,"ion-label",16),e._uU(4),e.qZA()(),e.TgZ(5,"ion-item",13),e.NdJ("click",function(){e.CHM(i);const n=e.oxw();return e.KtG(n.buttonClickSelectPckFromMobile())}),e.TgZ(6,"ion-label"),e._uU(7),e.qZA()(),e.TgZ(8,"input",11),e.NdJ("change",function(n){e.CHM(i);const o=e.oxw();return e.KtG(o.mobilepckselected(n))}),e.qZA(),e.TgZ(9,"ion-item",9),e.NdJ("click",function(){e.CHM(i);const n=e.oxw();return e.KtG(n.CreateEngineController())}),e.TgZ(10,"ion-label",10),e._uU(11),e.qZA()()()}if(2&s){const i=e.oxw();e.xp6(2),e.Akn("background-color: "+i.statusBar.colors[i.statusBar.tools.engineppt||"offline"]),e.xp6(2),e.Oqu(i.lang.text.EngineWorksPPT.RemoteServer),e.xp6(1),e.Q6J("disabled","certified"!=i.statusBar.tools.engineppt),e.xp6(2),e.Oqu(i.lang.text.EngineWorksPPT.StartFromMobile),e.xp6(1),e.Q6J("id",i.engine_ppt_mobile_sel),e.xp6(3),e.Oqu(i.lang.text.EngineWorksPPT.StartRemote)}}function j(s,d){1&s&&e._UZ(0,"div",17)}const Q=[{path:"",component:(()=>{var s;class d{constructor(t,n,o,l,r,a,c,T,v,m){this.lang=t,this.global=n,this.toolServer=o,this.indexed=l,this.p5toast=r,this.loadingCtrl=a,this.statusBar=c,this.navCtrl=T,this.noti=v,this.webrtc=m,this.EventListenerAct=x=>{x.detail.register(150,()=>{})},this.ToggleHeader=!0,this.Status="initialize",this.InputAddress="",this.LinkedAddress="",this.isSSLConnect=!1,this.engine_ppt_file_sel="",this.SelectedFile=[],this.ConnectButtonDisabled=!1,this.engine_ppt_mobile_sel=""}ngOnInit(){this.engine_ppt_file_sel=`engine_ppt_file_sel_${(new Date).getTime()}`,this.engine_ppt_mobile_sel=`engine_ppt_mobile_sel_${(new Date).getTime()}`,this.isSSLConnect="https:"==window.location.protocol&&!u.bS}ionViewWillEnter(){this.prerequisite_check()}ionViewDidEnter(){this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()}}prerequisite_check(){this.load_info_text(),"Android"==u.n$||"iOS"==u.n$?(this.Status="initApp",this.StartRemoteContrServer()):(this.Status="initPWA","DesktopPWA"==u.n$&&setTimeout(()=>{this.CreateDrop()},50))}CreateDrop(){var t=this;let n=document.getElementById("p5Drop");this.p5canvas=new C(o=>{o.setup=()=>{let l=o.createCanvas(n.clientWidth,n.clientHeight);o.pixelDensity(1),l.parent(n),l.drop(function(){var r=(0,h.Z)(function*(a){t.StartPresentation(a.name,a.file)});return function(a){return r.apply(this,arguments)}}())},o.mouseMoved=l=>{l.dataTransfer?(n.style.pointerEvents="all",n.style.backgroundColor="#0008"):(n.style.pointerEvents="none",n.style.backgroundColor="transparent")}})}buttonClickLinkInputFile(){document.getElementById(this.engine_ppt_file_sel).click()}inputpckselected(t){var n=this;return(0,h.Z)(function*(){n.StartPresentation(t.target.files[0].name,t.target.files[0])})()}StartPresentation(t,n){var o=this;return(0,h.Z)(function*(){"pck"==t.substring(t.lastIndexOf(".")+1)?(yield o.indexed.saveBlobToUserPath(n,"engineppt/presentation_this.pck",void 0,o.indexed.godotDB),o.CreateEnginePPT()):o.p5toast.show({text:o.lang.text.EngineWorksPPT.FileExtPck})})()}CreateEnginePPT(){this.ToggleHeader=!1,this.Status="OnPresentation",this.p5canvas&&this.p5canvas.remove(),setTimeout(()=>{this.TempWs&&this.TempWs.readyState==this.TempWs.OPEN&&this.TempWs.close(),this.global.CreateGodotIFrame("engineppt",{local_url:"assets/data/godot/engineppt.pck",title:"EnginePPT",remoteAddr:this.LinkedAddress,p5toast:t=>{this.p5toast.show({text:t})},dismiss:()=>{this.navCtrl.pop()}})},0)}load_info_text(){this.p5canvas=new C(t=>{t.noCanvas(),t.loadStrings(`assets/data/infos/${this.lang.lang}/engine_remote.txt`,n=>{this.RemoteDesc=n.join("\n")})})}StartRemoteContrServer(){var t=this;this.webrtc.initialize("data"),this.toolServer.initialize("engineppt",12021,()=>{this.toolServer.list.engineppt.OnConnected.show_noti=n=>{this.noti.PushLocal({id:13,title:this.lang.text.EngineWorksPPT.ClientConnected,body:this.lang.text.EngineWorksPPT.UsePPTRemote,group_ln:"engineppt",smallIcon_ln:"engineppt",iconColor_ln:"478cbf",autoCancel_ln:!0},"engineppt"),setTimeout(()=>{this.toolServer.send_to("engineppt",JSON.stringify({act:"WEBRTC_INIT_REQ_SIGNAL"}))},500)},this.toolServer.list.engineppt.OnDisconnected.remove_noti=(0,h.Z)(function*(){t.noti.ClearNoti(13)}),this.toolServer.list.engineppt.OnDisconnected.showDisconnected=()=>{"OnPresentation"==this.Status&&this.p5toast.show({text:this.lang.text.EngineWorksPPT.Disconnected})}},n=>{switch(n.act){case"WEBRTC_REPLY_INIT_SIGNAL":"EOL"==n.data?(this.webrtc.createRemoteOfferFromAnswer(JSON.parse(this.webrtc.ReceivedOfferPart)),this.webrtc.ReceivedOfferPart="",this.webrtc.CreateAnswer(),setTimeout(()=>{let r=JSON.stringify(this.webrtc.LocalAnswer).match(/(.{1,250})/g);for(let a=0,c=r.length;a<c;a++)this.toolServer.send_to("engineppt",JSON.stringify({act:"WEBRTC_RECEIVE_ANSWER",data:r[a]}));this.toolServer.send_to("engineppt",JSON.stringify({act:"WEBRTC_RECEIVE_ANSWER",data:"EOL"}))},500)):this.webrtc.ReceivedOfferPart+=n.data;break;case"WEBRTC_ICE_CANDIDATES":this.webrtc.ReceiveIceCandidate(n.data),setTimeout(()=>{for(let l=0,r=this.webrtc.IceCandidates.length;l<r;l++)this.toolServer.send_to("engineppt",JSON.stringify({act:"WEBRTC_ICE_CANDIDATES",data:this.webrtc.IceCandidates[l]}));this.webrtc.IceCandidates.length=0},800);break;case"react":let o=this.SelectedFile.shift();this.toolServer.send_to("engineppt",o?JSON.stringify({act:"part",data:o}):JSON.stringify({act:"eof"}));break;case"exit":this.Status="initApp";break;default:console.log("\uc608\uc0c1\ud558\uc9c0 \uc54a\uc740 \uc218\uc2e0\uac12: ",n)}})}ConnectToAddress(){var t=this;return(0,h.Z)(function*(){if(t.InputAddress=t.InputAddress.trim(),t.InputAddress){t.ConnectButtonDisabled=!0;try{t.LinkedAddress=yield t.CatchAvailableAddress([t.InputAddress])}catch{t.p5toast.show({text:t.lang.text.EngineWorksPPT.CannotConnect})}t.ConnectButtonDisabled=!1}else t.p5toast.show({text:t.lang.text.EngineWorksPPT.NeedAddress})})()}buttonClickSelectPckFromMobile(){document.getElementById(this.engine_ppt_mobile_sel).click()}mobilepckselected(t){var n=this;return(0,h.Z)(function*(){if(!n.toolServer.list.engineppt.users)return void n.p5toast.show({text:n.lang.text.EngineWorksPPT.NeedLink});let o=t.target.files[0].name;if("pck"!=o.substring(o.lastIndexOf(".")+1))return void n.p5toast.show({text:n.lang.text.EngineWorksPPT.FileExtPck});yield n.indexed.saveBlobToUserPath(t.target.files[0],"tmp_files/engineppt_selected.pck");let r=yield n.global.GetBase64ThroughFileReader(t.target.files[0]),c=Math.ceil(r.length/22e4);n.SelectedFile=r.match(/(.{1,220000})/g),n.toolServer.send_to("engineppt",JSON.stringify({act:"init",size:c,total:r.length}))})()}CatchAvailableAddress(t){var n=this;return new Promise(function(){var o=(0,h.Z)(function*(l,r){let a;for(let c=0,T=t.length;c<T;c++)try{a=yield new Promise(function(){var m=(0,h.Z)(function*(x,O){let I="",b=yield n.loadingCtrl.create({message:n.lang.text.EngineWorksPPT.ReceivingFile});n.TempWs=new WebSocket(`ws://${t[c]}:12021`),n.TempWs.onopen=function(){var P=(0,h.Z)(function*(f){yield n.webrtc.initialize("data"),n.webrtc.createDataChannel("engineppt",{ordered:!0,maxRetransmits:0}),n.webrtc.dataChannelOnMsgAct.engineppt=W=>{n.global.godot_window.override_cursor_position&&n.global.godot_window.override_cursor_position(JSON.parse(W))},n.webrtc.CreateOfffer(),x(t[c])});return function(f){return P.apply(this,arguments)}}(),n.TempWs.onmessage=P=>{let f=JSON.parse(P.data);switch(f.act){case"WEBRTC_INIT_REQ_SIGNAL":let N=JSON.stringify(n.webrtc.LocalOffer).match(/(.{1,250})/g);for(let _=0,S=N.length;_<S;_++)n.TempWs.send(JSON.stringify({act:"WEBRTC_REPLY_INIT_SIGNAL",data:N[_]}));n.TempWs.send(JSON.stringify({act:"WEBRTC_REPLY_INIT_SIGNAL",data:"EOL"}));break;case"WEBRTC_RECEIVE_ANSWER":if("EOL"==f.data){n.webrtc.ReceiveRemoteAnswer(JSON.parse(n.webrtc.ReceivedAnswerPart)),n.webrtc.ReceivedAnswerPart="";for(let _=0,S=n.webrtc.IceCandidates.length;_<S;_++)n.TempWs.send(JSON.stringify({act:"WEBRTC_ICE_CANDIDATES",data:n.webrtc.IceCandidates[_]}));n.webrtc.IceCandidates.length=0}else n.webrtc.ReceivedAnswerPart+=f.data;break;case"WEBRTC_ICE_CANDIDATES":n.webrtc.ReceiveIceCandidate(f.data);break;case"init":b.present(),n.TempWs.send(JSON.stringify({act:"react"}));break;case"part":I+=f.data,n.TempWs.send(JSON.stringify({act:"react"}));break;case"eof":n.indexed.saveBase64ToUserPath(I,"engineppt/presentation_this.pck",_=>{b.dismiss(),n.CreateEnginePPT()},n.indexed.godotDB);break;default:console.log("\uc608\uc0c1\ud558\uc9c0 \uc54a\uc740 \uc11c\ubc84 \uc218\uc2e0\uac12: ",f)}},n.TempWs.onclose=function(){var P=(0,h.Z)(function*(f){n.LinkedAddress="",b.dismiss(),"OnPresentation"!=n.Status&&n.p5toast.show({text:n.lang.text.EngineWorksPPT.Disconnected}),O("onclose")});return function(f){return P.apply(this,arguments)}}()});return function(x,O){return m.apply(this,arguments)}}());break}catch(v){console.log("CatchAvailableAddress: ",v),n.TempWs.close()}a?(n.p5toast.show({text:`${n.lang.text.EngineWorksPPT.ReadyToConnect}: ${a}`}),l(a)):(n.LinkedAddress="",r("\uc0ac\uc6a9\ud560 \uc218 \uc788\ub294 \uc8fc\uc18c \uc5c6\uc74c"))});return function(l,r){return o.apply(this,arguments)}}())}CreateEngineController(){this.Status="OnPresentation",this.noti.ClearNoti(13),this.p5canvas&&this.p5canvas.remove(),document.addEventListener("ionBackButton",this.EventListenerAct),this.send_device_rotation();let t=!0,n={};setTimeout(()=>{this.global.CreateGodotIFrame("engineppt",{local_url:"assets/data/godot/engineppt.pck",title:"EnginePPTContr",pointer_pos:(o="")=>{let l=JSON.parse(o);n={...n,...l},this.webrtc.dataChannel.engineppt&&(this.webrtc.send("engineppt",JSON.stringify({x:l.x,y:l.y})),delete n.x,delete n.y);let r=Object.keys(n);t&&r.length&&(this.toolServer.send_to("engineppt",JSON.stringify({...n})),r.forEach(a=>delete n[a]),t=!1,setTimeout(()=>{t=!0},60))}})},0)}send_device_rotation(){this.p5gyro=new C(t=>{t.setup=()=>{t.noCanvas()},t.draw=()=>{this.global.godot_window.set_horizontal_rot&&this.global.godot_window.set_horizontal_rot(t.rotationZ),this.global.godot_window.set_vertical_rot&&this.global.godot_window.set_vertical_rot(t.rotationX)}})}ionViewWillLeave(){document.removeEventListener("ionBackButton",this.EventListenerAct),this.toolServer.stop("engineppt"),delete this.global.p5key.KeyShortCut.Escape,this.indexed.removeFileFromUserPath("engineppt/presentation_this.pck",void 0,this.indexed.godotDB),this.indexed.GetFileListFromDB("tmp_files",t=>{t.forEach(n=>this.indexed.removeFileFromUserPath(n,void 0,this.indexed.godotDB))},this.indexed.godotDB),this.TempWs&&this.TempWs.close(),this.p5canvas&&this.p5canvas.remove(),this.p5gyro&&this.p5gyro.remove(),this.webrtc.close_webrtc(),this.noti.ClearNoti(13)}}return(s=d).\u0275fac=function(t){return new(t||s)(e.Y36(Z.b),e.Y36(B.AN),e.Y36(J),e.Y36(R.H),e.Y36(D.F),e.Y36(g.HT),e.Y36(y.g),e.Y36(g.SH),e.Y36(M.J),e.Y36(L.V))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-engineppt"]],decls:7,vars:6,consts:[["class","ion-no-border",4,"ngIf"],["id","p5Drop","style","position: absolute; width: 100%; height: 100%; display: flex;",4,"ngIf"],[4,"ngIf"],["class","full_screen","style","display: flex;","id","engineppt",4,"ngIf"],[1,"ion-no-border"],["slot","start"],["defaultHref",""],["id","p5Drop",2,"position","absolute","width","100%","height","100%","display","flex"],["disabled","",1,"infobox",2,"height","280px",3,"ngModel","ngModelChange"],["button","",3,"click"],[1,"ion-text-center"],["hidden","","type","file","accept","*",3,"id","change"],[1,"ion-text-end",3,"label","ngModel","placeholder","ngModelChange"],["button","",3,"disabled","click"],["button",""],[1,"additional_form","status_bar_single"],[1,"form_margin"],["id","engineppt",1,"full_screen",2,"display","flex"]],template:function(t,n){1&t&&(e.YNc(0,F,6,1,"ion-header",0),e.TgZ(1,"ion-content"),e.YNc(2,Y,1,0,"div",1),e.YNc(3,G,5,2,"div",2),e.YNc(4,H,9,4,"div",2),e.YNc(5,$,12,7,"div",2),e.YNc(6,j,1,0,"div",3),e.qZA()),2&t&&(e.Q6J("ngIf",n.ToggleHeader),e.xp6(2),e.Q6J("ngIf","initPWA"==n.Status),e.xp6(1),e.Q6J("ngIf","OnPresentation"!=n.Status),e.xp6(1),e.Q6J("ngIf","initPWA"==n.Status),e.xp6(1),e.Q6J("ngIf","initApp"==n.Status),e.xp6(1),e.Q6J("ngIf","OnPresentation"==n.Status))},dependencies:[w.O5,E.Fj,E.JJ,E.On,g.oU,g.Sm,g.W2,g.Gu,g.pK,g.Ie,g.rH,g.Q$,g.wd,g.sr,g.j9,g.cs]}),d})()}];let z=(()=>{var s;class d{}return(s=d).\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[A.Bz.forChild(Q),A.Bz]}),d})(),K=(()=>{var s;class d{}return(s=d).\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[w.ez,E.u5,g.Pc,z]}),d})()}}]);