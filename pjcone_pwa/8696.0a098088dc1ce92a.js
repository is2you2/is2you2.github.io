"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8696],{8696:(x,P,f)=>{f.d(P,{C:()=>J});var u=f(1528),R=f(9352),b=f(9596),p=f(7136),L=f(4712),M=f(5020),g=f(4496),N=f(5624),W=f(3824),B=f(4668),U=f(4500),$=f(7756);!function j(){("http:"!=window.location.protocol||0==window.location.host.indexOf("localhost"))&&f.e(4616).then(f.t.bind(f,4616,23)).then(y=>{})}();let J=(()=>{var y;class k{constructor(t,e,i,s,a,c){this.modalCtrl=t,this.p5toast=e,this.indexed=i,this.lang=s,this.nakama=a,this.mClipboard=c,this.OnUse=!1,this.isCallable=!1,this.isConnected=!1,this.JoinInited=!1,this.ReceivedOfferPart="",this.ReceivedAnswerPart="",this.IceCandidates=[],this.dataChannel={},this.dataChannelOpenAct={},this.dataChannelOnMsgAct={},this.dataChannelOnCloseAct={},this.nakama.WebRTCService=this}initialize(t,e,i,s){var a=this;return(0,u.c)(function*(){if("http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")){let n=a.nakama.get_all_online_server(),r="https://is2you2.github.io/pjcone_pwa/";r+=`?tmp_user=${a.nakama.users.self.email},${a.nakama.users.self.password},${a.nakama.users.self.display_name}`;for(let o=0,h=n.length;o<h;o++)r+=`&server=${n[o].info.name||""},${n[o].info.address||""},${n[o].info.useSSL||""},${n[o].info.port||""},${n[o].info.key||""}`;r+=`&open_prv_channel=${i.user_id},${i.isOfficial||"official"},${i.target||"DevTestServer"}`;try{let o=yield a.indexed.loadTextFromUserPath("servers/webrtc_server.json"),h=JSON.parse(o);for(let d=0,C=h.length;d<C;d++)r+=`&rtcserver=[${h[d].urls}],${h[d].username},${h[d].credential}`}catch{}try{yield a.mClipboard.copy(r)}catch{}throw window.open(r,"_system"),a.lang.text.WebRTCDevManager.SecurityError}if("data"!=t&&(yield L.G.requestAudioRecordingPermission()),a.OnUse)throw a.p5toast.show({text:a.lang.text.WebRTCDevManager.AlreadyCalling}),a.lang.text.WebRTCDevManager.AlreadyCalling;if(yield a.close_webrtc(s),a.TypeIn=t,a.nakama.socket_reactive.WEBRTC_CHECK_ONLINE=n=>{a.user_id==n&&a.close_webrtc()},a.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL=function(){var n=(0,u.c)(function*(r){let h=JSON.stringify(a.LocalOffer).match(/(.{1,64})/g);if(r){for(let d=0,C=h.length;d<C;d++)r.server.send_to(r.target,r.user,JSON.stringify({type:"socket_react",act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:h[d]})),yield new Promise(v=>setTimeout(v,40));r.server.send_to(r.target,r.user,JSON.stringify({type:"socket_react",act:"WEBRTC_REPLY_INIT_SIGNAL",data_str:"EOL"}))}else{for(let d=0,C=h.length;d<C;d++)yield a.nakama.servers[a.isOfficial][a.target].socket.sendMatchState(a.CurrentMatch.match_id,p.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent(h[d]));yield a.nakama.servers[a.isOfficial][a.target].socket.sendMatchState(a.CurrentMatch.match_id,p.i.WEBRTC_REPLY_INIT_SIGNAL,encodeURIComponent("EOL"))}});return function(r){return n.apply(this,arguments)}}(),a.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL=n=>{"EOL"==n?(a.createRemoteOfferFromAnswer(JSON.parse(a.ReceivedOfferPart)),a.ReceivedOfferPart="",a.InitReplyCallback&&a.InitReplyCallback()):a.ReceivedOfferPart+=n},a.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER=(n,r)=>{"EOL"==n?(a.ReceiveRemoteAnswer(JSON.parse(a.ReceivedAnswerPart),r),a.ReceivedAnswerPart=""):a.ReceivedAnswerPart+=n},a.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES=(n,r)=>{a.ReceiveIceCandidate(JSON.parse(n),r)},a.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED=n=>{"EOL"==n?(a.createRemoteOfferFromAnswer(JSON.parse(a.ReceivedOfferPart)),a.ReceivedOfferPart="",a.CreateAnswer()):a.ReceivedOfferPart+=n},a.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF=n=>{a.close_webrtc(!1)},i&&(a.isOfficial=i.isOfficial,a.target=i.target,a.user_id=i.user_id,a.channel_id=i.channel_id),"data"!=t){a.createP5_panel();try{var c,l;a.localMedia=document.createElement(t),a.localMedia.id="webrtc_video",a.localMedia.style.width="100%",a.localMedia.style.height="fit-content",a.localMedia.autoplay=!0,"video"==t&&(a.localMedia.playsInline=!0),a.localMedia.muted=!0,document.body.appendChild(a.localMedia),a.remoteMedia=document.createElement(t),a.remoteMedia.id="webrtc_video_remote",a.remoteMedia.style.width="100%",a.remoteMedia.style.height="fit-content",a.remoteMedia.autoplay=!0,"video"==t&&(a.remoteMedia.playsInline=!0),document.body.appendChild(a.remoteMedia);let r,o,n=yield a.getDeviceList(),h=Number(null!==(c=localStorage.getItem("VideoInputDev"))&&void 0!==c?c:NaN),d=Number(null!==(l=localStorage.getItem("AudioInputDev"))&&void 0!==l?l:NaN);for(let C=0,v=n.length,I=0,O=0;C<v&&(!r||!o);C++)!r&&"audioinput"==n[C].kind&&(Number.isNaN(d)?(r=n[C].deviceId,localStorage.setItem("AudioInputDev",`${O}`)):O==d&&(r=n[C].deviceId),O++),!o&&"videoinput"==n[C].kind&&(Number.isNaN(h)?(o=n[C].deviceId,localStorage.setItem("AudioInputDev",`${I}`)):I==h&&(o=n[C].deviceId),I++);e||(e={},"video"==t?(e.video=!0,o&&(e.video={deviceId:o})):e.video=!1,e.audio=!0,r&&(e.audio={deviceId:r})),a.localStream=yield navigator.mediaDevices.getUserMedia(e),a.localMedia.srcObject=a.localStream,a.isCallable=!0}catch(n){console.log("navigator.getUserMedia error: ",n),yield a.close_webrtc(),a.p5toast.show({text:`${a.lang.text.WebRTCDevManager.InitErr}: ${n}`})}}else a.isCallable=!0;yield a.createCall(),a.p5canvas&&(a.p5canvas.call_button.elt.disabled=!1)})()}createP5_panel(){var t=this;this.OnUse=!0,this.p5canvas&&(clearTimeout(this.p5canvas.waiting_act),this.p5canvas.remove()),this.p5canvas=new R(e=>{let i,s,a,c,l,n,r,o,h,d,C=1;e.setup=()=>{let _,D=()=>{this.JoinInited?(_.stop(.1),clearTimeout(e.waiting_act)):(_&&_.stop(.1),_=new R.Oscillator(380,"sine"),_.start(),_.amp(1,.15),_.amp(0,.75),e.waiting_act=setTimeout(()=>{D()},1200))};e.waiting_act=setTimeout(()=>{D()},0),e.hangup=(E=!1)=>{!this.isConnected&&!E||(_.stop(.1),clearTimeout(e.waiting_act),_=new R.Oscillator(380,"sine"),_.start(),_.freq(250,.35),_.amp(1,.15),_.amp(0,.25),_.amp(1,.35),_.amp(0,.45))},e.noCanvas(),i=e.createDiv(),i.id("outterDiv"),i.style("position: absolute; left: 50%; top: 0px; z-index: 1"),i.style("transform: translateX(-50%)"),i.style("width: fit-content; height: fit-content"),i.style("padding: 8px 16px;"),i.style("display: flex; justify-content: center;"),c=e.createDiv(),c.parent(i),c.style("display: flex; justify-content: center;"),c.style("width: fit-content; height: fit-content"),c.style("border-radius: 32px"),c.style("background: #"+(M.Mp?"30564e88":"b9543788")),c.style("padding: 6px 12px"),s=e.createDiv(),s.parent(c),s.id("webrtc_content"),s.style("display: flex; justify-content: center;"),s.style("flex-direction","column"),s.style("width: fit-content; height: fit-content"),s.style("word-break: break-all"),s.style("background: #"+(M.Mp?"30564e88":"b9543788")),s.style("border-radius: 32px"),s.style("padding: 6px 12px"),s.style("color: "+(M.Mp?"white":"black")),O(),this.isOfficial&&this.target&&(this.user_id&&(a=e.createDiv(this.nakama.users[this.isOfficial][this.target][this.user_id].display_name)),a.parent(s),a.style("text-align","center"),a.style("align-self","center"),a.style("width","100%"),a.style("height","fit-content"),a.style("pointer-events","none")),l=e.createDiv(),l.parent(s),l.id("webrtc_content"),l.style("display: flex; justify-content: center;"),l.style("align-self","center"),l.style("width: fit-content; height: fit-content"),n=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="call-outline"></ion-icon>'),n.parent(l),n.style("padding","0px"),n.style("margin","4px"),n.style("border-radius","16px"),n.style("width","40px"),n.style("height","40px"),n.mouseClicked(()=>{this.CreateAnswer()}),n.elt.disabled=!0,e.call_button=n,r=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-outline"></ion-icon>'),r.parent(l),r.style("padding","0px"),r.style("margin","4px"),r.style("border-radius","16px"),r.style("width","40px"),r.style("height","40px"),r.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let m=0,S=E.length;m<S;m++)E[m].enabled=!1;o.show(),r.hide()}),o=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="mic-off-outline"></ion-icon>'),o.parent(l),o.style("background-color","grey"),o.style("padding","0px"),o.style("margin","4px"),o.style("border-radius","16px"),o.style("width","40px"),o.style("height","40px"),o.mouseClicked(()=>{const E=this.localStream.getAudioTracks();for(let m=0,S=E.length;m<S;m++)E[m].enabled=!0;r.show(),o.hide()}),o.hide(),h=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="settings-outline"></ion-icon>'),h.parent(l),h.style("padding","0px"),h.style("margin","4px"),h.style("border-radius","16px"),h.style("width","40px"),h.style("height","40px"),h.mouseClicked((0,u.c)(function*(){h.elt.disabled=!0;let E=yield t.getDeviceList();t.modalCtrl.create({component:b.I,componentProps:{list:E}}).then(m=>{m.onDidDismiss().then(function(){var S=(0,u.c)(function*(T){h.elt.disabled=!1;try{let A={};T.data.videoinput&&(A.video={deviceId:T.data.videoinput.deviceId}),T.data.audioinput&&(A.audio={deviceId:T.data.audioinput.deviceId}),t.PeerConnection.removeStream(t.localStream),t.localStream=yield navigator.mediaDevices.getUserMedia(A),t.localMedia.srcObject=t.localStream,t.localStream.getTracks().forEach(K=>t.PeerConnection.addTrack(K,t.localStream))}catch{}});return function(T){return S.apply(this,arguments)}}()),m.present()})})),d=e.createButton('<ion-icon style="width: 32px; height: 32px;" name="close-circle-outline"></ion-icon>'),d.parent(l),d.style("background-color","red"),d.style("padding","0px"),d.style("margin","4px"),d.style("border-radius","16px"),d.style("width","40px"),d.style("height","40px"),d.mouseClicked((0,u.c)(function*(){yield t.close_webrtc()}))};let I=!1;e.draw=()=>{C>0&&(C-=.03),O(),this.OnUse||this.p5canvas&&!I&&(this.p5canvas.hangup(),i.hide(),setTimeout(()=>{this.OnUse||this.p5canvas.remove()},1e3),I=!0)};let O=()=>{let _=e.lerpColor(e.color("#"+(M.Mp?"30564e88":"b9543788")),e.color("#ffd94ebb"),C).levels,D=4*C;c.style(`padding: ${D}px ${D}px`),s.style(`padding: ${e.lerp(6,2,C)}px ${e.lerp(12,8,C)}px`),c.style(`background: rgba(${_[0]}, ${_[1]}, ${_[2]}, ${_[3]/255})`)}})}getDeviceList(){return(0,u.c)(function*(){return yield navigator.mediaDevices.enumerateDevices()})()}createCall(){var t=this;return(0,u.c)(function*(){let e;t.isCallable=!1,t.isConnected=!0,t.startTime=window.performance.now();try{let i=yield t.indexed.loadTextFromUserPath("servers/webrtc_server.json");e={},e.iceServers=JSON.parse(i)}catch{}"data"!=t.TypeIn&&(!e||!e.iceServers||!e.iceServers.length)&&(t.p5toast.show({text:t.lang.text.WebRTCDevManager.NoRegServer}),e=void 0),t.PeerConnection=new RTCPeerConnection(e),t.PeerConnection.addEventListener("icecandidate",i=>t.handleConnection(i)),t.PeerConnection.addEventListener("connectionstatechange",function(){var i=(0,u.c)(function*(s){switch(s.target.connectionState){case"failed":case"disconnected":yield t.close_webrtc();break;case"connected":t.p5canvas&&clearTimeout(t.p5canvas.waiting_act);break;default:console.log("\uc5f0\uacb0 \uc0c1\ud0dc \ubcc0\uacbd\ub428: ",s.target.connectionState)}});return function(s){return i.apply(this,arguments)}}()),"data"!=t.TypeIn?(t.localStream.getTracks().forEach(i=>t.PeerConnection.addTrack(i,t.localStream)),t.PeerConnection.addEventListener("addstream",i=>{t.remoteMedia.srcObject=i.stream})):t.createDataChannel("voidDraw"),t.PeerConnection.addEventListener("datachannel",i=>{t.dataChannel[i.channel.label]=i.channel,t.createDataChannelListener(i.channel.label)}),t.PeerConnection.addEventListener("negotiationneeded",function(){var i=(0,u.c)(function*(s){if(t.JoinInited){yield t.PeerConnection.createOffer({offerToReceiveVideo:1}).then(l=>t.createdOffer(l)).catch(l=>t.setSessionDescriptionError(l));let c=JSON.stringify(t.LocalOffer).match(/(.{1,64})/g);if(t.isOfficial&&t.target){console.log("\uc11c\ubc84\uc815\ubcf4 \uc788\uc74c");for(let l=0,n=c.length;l<n;l++)yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,p.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent(c[l]));yield t.nakama.servers[t.isOfficial][t.target].socket.sendMatchState(t.CurrentMatch.match_id,p.i.WEBRTC_NEGOCIATENEEDED,encodeURIComponent("EOL"))}else console.log("\uc11c\ubc84\uc815\ubcf4 \uc5c6\uc74c: \ub204\uad6c \ud1b5\ud574\uc11c \ubcf4\ub0c4?")}});return function(s){return i.apply(this,arguments)}}())})()}createDataChannel(t,e){this.dataChannel[t]=this.PeerConnection.createDataChannel(t,e),this.createDataChannelListener(t)}createDataChannelListener(t){this.dataChannel[t].addEventListener("open",e=>{this.dataChannelOpenAct[t]&&this.dataChannelOpenAct[t]()}),this.dataChannel[t].addEventListener("close",e=>{this.dataChannelOnCloseAct[t]&&this.dataChannelOnCloseAct[t]()}),this.dataChannel[t].addEventListener("message",e=>{this.dataChannelOnMsgAct[t]&&this.dataChannelOnMsgAct[t](e.data)})}send(t,e){try{this.dataChannel[t].send(e)}catch(i){console.log("WebRTC \uba54\uc2dc\uc9c0 \ubc1c\uc1a1 \uc2e4\ud328: ",i)}}CreateOffer(){this.p5canvas&&this.p5canvas.call_button.hide(),this.PeerConnection.createOffer({offerToReceiveVideo:1}).then(t=>this.createdOffer(t)).catch(t=>this.setSessionDescriptionError(t))}handleConnection(t){let e=t.candidate;e&&this.IceCandidates.push(new RTCIceCandidate(e))}ReceiveIceCandidate(t,e){var i=this;this.ReplyIceCandidate&&clearTimeout(this.ReplyIceCandidate),this.ReplyIceCandidate=setTimeout((0,u.c)(function*(){if(e)for(let s=0,a=i.IceCandidates.length;s<a;s++)e.send(JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(i.IceCandidates[s])})),yield new Promise(c=>setTimeout(c,40));else for(let s=0,a=i.IceCandidates.length;s<a;s++)yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(i.IceCandidates[s])));i.IceCandidates.length=0}),800),this.PeerConnection.addIceCandidate(t).then(()=>{console.log("Success to add new ice candidate")}).catch(s=>{console.error("failed to add ice candidate: ",s)})}createdOffer(t){this.LocalOffer=t,this.PeerConnection.setLocalDescription(t).then(()=>{this.setLocalDescriptionSuccess(this.PeerConnection)}).catch(e=>this.setSessionDescriptionError(e))}createRemoteOfferFromAnswer(t){this.PeerConnection.setRemoteDescription(t).then(()=>{this.setRemoteDescriptionSuccess(this.PeerConnection)}).catch(e=>this.setSessionDescriptionError(e))}CreateAnswer(t){this.PeerConnection.createAnswer().then(e=>this.createdAnswer(e,t)).catch(e=>this.setSessionDescriptionError(e))}setLocalDescriptionSuccess(t){this.setDescriptionSuccess(t,"setLocalDescription")}setRemoteDescriptionSuccess(t){this.setDescriptionSuccess(t,"setRemoteDescription")}createdAnswer(t,e){var i=this;return(0,u.c)(function*(){i.p5canvas&&i.p5canvas.call_button.hide(),i.LocalAnswer=t,i.PeerConnection.setLocalDescription(t).then(()=>{i.setLocalDescriptionSuccess(i.PeerConnection)}).catch(c=>i.setSessionDescriptionError(c));let a=JSON.stringify(t).match(/(.{1,64})/g);if(e){for(let c=0,l=a.length;c<l;c++)e.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",data_str:a[c]})),yield new Promise(n=>setTimeout(n,40));e.send(JSON.stringify({type:"socket_react",act:"WEBRTC_RECEIVE_ANSWER",data_str:"EOL"}))}else{for(let c=0,l=a.length;c<l;c++)yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent(a[c]));yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_RECEIVE_ANSWER,encodeURIComponent("EOL")),yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.nakama.self_match[i.isOfficial][i.target].match_id,p.i.WEBRTC_RECEIVED_CALL_SELF,encodeURIComponent(""))}i.JoinInited=!0})()}ReceiveRemoteAnswer(t,e){var i=this;return(0,u.c)(function*(){if(i.PeerConnection.setRemoteDescription(t).then(()=>{i.setRemoteDescriptionSuccess(i.PeerConnection)}).catch(s=>i.setSessionDescriptionError(s)),e)for(let s=0,a=i.IceCandidates.length;s<a;s++)e.server.send_to(e.target,e.user,JSON.stringify({type:"socket_react",act:"WEBRTC_ICE_CANDIDATES",data_str:JSON.stringify(i.IceCandidates[s])})),yield new Promise(c=>setTimeout(c,40));else for(let s=0,a=i.IceCandidates.length;s<a;s++)yield i.nakama.servers[i.isOfficial][i.target].socket.sendMatchState(i.CurrentMatch.match_id,p.i.WEBRTC_ICE_CANDIDATES,encodeURIComponent(JSON.stringify(i.IceCandidates[s])));i.IceCandidates.length=0})()}setSessionDescriptionError(t){console.error(`Failed to create session description: ${t}.`)}setDescriptionSuccess(t,e){console.log(`Local ${e} complete.`)}HangUpCall(t){var e=this;return(0,u.c)(function*(){e.p5canvas&&e.p5canvas.hangup(),e.isCallable=!0,e.isConnected=!1,e.PeerConnection&&e.PeerConnection.close(),e.PeerConnection=void 0;try{t&&e.CurrentMatch.match_id!=e.nakama.self_match[e.isOfficial][e.target].match_id&&(yield e.nakama.servers[e.isOfficial][e.target].socket.sendMatchState(e.CurrentMatch.match_id,p.i.WEBRTC_HANGUP,""),yield e.nakama.servers[e.isOfficial][e.target].socket.leaveMatch(e.CurrentMatch.match_id))}catch{}})()}close_webrtc(t=!0){var e=this;return(0,u.c)(function*(){e.InitReplyCallback=void 0,yield e.HangUpCall(t),e.localMedia&&e.localMedia.remove(),e.remoteMedia&&e.remoteMedia.remove(),e.OnUse=!1,e.isCallable=!1,e.isConnected=!1,e.localStream&&(e.localStream.getVideoTracks().forEach(i=>i.stop()),e.localStream.getAudioTracks().forEach(i=>i.stop())),e.localMedia=void 0,e.localStream=void 0,e.remoteMedia=void 0,e.dataChannelOpenAct={},e.dataChannelOnCloseAct={},e.dataChannelOnMsgAct={},e.dataChannel={},e.ReceivedOfferPart="",e.ReceivedAnswerPart="",e.JoinInited=!1,delete e.nakama.socket_reactive.WEBRTC_INIT_REQ_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_REPLY_INIT_SIGNAL,delete e.nakama.socket_reactive.WEBRTC_RECEIVE_ANSWER,delete e.nakama.socket_reactive.WEBRTC_ICE_CANDIDATES,delete e.nakama.socket_reactive.WEBRTC_NEGOCIATENEEDED,delete e.nakama.socket_reactive.WEBRTC_RECEIVED_CALL_SELF,delete e.nakama.socket_reactive.WEBRTC_CHECK_ONLINE,e.IceCandidates.length=0})()}}return(y=k).\u0275fac=function(t){return new(t||y)(g.CoB(N.qS),g.CoB(W.O),g.CoB(B.k),g.CoB(U.o),g.CoB(p.h),g.CoB($._))},y.\u0275prov=g.wxM({token:y,factory:y.\u0275fac,providedIn:"root"}),k})()},4712:(x,P,f)=>{f.d(P,{G:()=>R});const R=(0,f(6400).C_)("VoiceRecorder",{web:()=>f.e(5840).then(f.bind(f,5840)).then(w=>new w.VoiceRecorderWeb)})}}]);