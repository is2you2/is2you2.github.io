"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6524],{6524:(J,p,o)=>{o.r(p),o.d(p,{InstantCallPageModule:()=>O});var I=o(177),_=o(4341),c=o(5374),u=o(9858),f=o(467),v=o(5402),b=o(8326),S=o(9349),t=o(3953),R=o(482),P=o(4234),x=o(4020),T=o(345),W=o(4237),G=o(9900),k=o(3656);const j=["InstantCallServer"];function w(a,s){1&a&&t.nrm(0,"div",8)}function y(a,s){if(1&a&&(t.j41(0,"ion-select-option",15),t.EFF(1),t.k0s()),2&a){const n=s.$implicit;t.Y8G("value",n),t.R7$(),t.JRh(n.info.name)}}function A(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-select",12,0),t.bIt("ionChange",function(e){t.eBV(n);const i=t.XpG(2);return t.Njj(i.SelectAddressTarget(e))}),t.j41(3,"ion-select-option",13),t.EFF(4),t.k0s(),t.DNE(5,y,2,2,"ion-select-option",14),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.AddGroup.SelectServer),t.R7$(3),t.JRh(n.lang.text.voidDraw.InternalConn),t.R7$(),t.Y8G("ngForOf",n.ServerList)}}function E(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",16),t.mxI("ngModelChange",function(e){t.eBV(n);const i=t.XpG(2);return t.DH7(i.UserInputCustomAddress,e)||(i.UserInputCustomAddress=e),t.Njj(e)}),t.k0s(),t.j41(2,"ion-icon",17),t.bIt("click",function(){t.eBV(n);const e=t.XpG(2);return t.Njj(e.global.open_custom_site(e.UserInputCustomAddress))}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.voidDraw.InputAddress),t.R50("ngModel",n.UserInputCustomAddress)}}function N(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(n);const i=t.XpG(2);return t.DH7(i.Port,e)||(i.Port=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.GroupServer.Port),t.R50("ngModel",n.Port),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (3478)")}}function $(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(n);const i=t.XpG(2);return t.DH7(i.Username,e)||(i.Username=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.WebRTCDevManager.Username),t.R50("ngModel",n.Username),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (username)")}}function U(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item")(1,"ion-input",18),t.mxI("ngModelChange",function(e){t.eBV(n);const i=t.XpG(2);return t.DH7(i.Password,e)||(i.Password=e),t.Njj(e)}),t.k0s()()}if(2&a){const n=t.XpG(2);t.R7$(),t.Y8G("label",n.lang.text.WebRTCDevManager.Credential),t.R50("ngModel",n.Password),t.Y8G("placeholder",n.lang.text.Settings.joinDedi_placeholder+" (password)")}}function M(a,s){if(1&a){const n=t.RV6();t.j41(0,"div",9),t.DNE(1,A,6,3,"ion-item",7)(2,E,3,2,"ion-item",7)(3,N,2,3,"ion-item",7)(4,$,2,3,"ion-item",7)(5,U,2,3,"ion-item",7),t.j41(6,"ion-item",10),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.LinkToServer())}),t.j41(7,"ion-label",11),t.EFF(8),t.k0s()()()}if(2&a){const n=t.XpG();t.R7$(),t.Y8G("ngIf",n.ServerList.length),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(),t.Y8G("ngIf",n.NeedInputCustomAddress),t.R7$(3),t.JRh(n.lang.text.voidDraw.ConnectToAddress)}}function X(a,s){if(1&a){const n=t.RV6();t.j41(0,"ion-item",10),t.bIt("click",function(){t.eBV(n);const e=t.XpG();return t.Njj(e.copy_qr_address())}),t.j41(1,"ion-label",11),t.EFF(2),t.k0s()()}if(2&a){const n=t.XpG();t.R7$(2),t.JRh(n.QRCodeAsString)}}function D(a,s){if(1&a&&(t.j41(0,"ion-label",22),t.EFF(1),t.k0s()),2&a){const n=t.XpG(2);t.R7$(),t.JRh(n.lang.text.InstantCall.Waiting)}}function Y(a,s){if(1&a&&(t.j41(0,"ion-label",22),t.EFF(1),t.k0s()),2&a){const n=t.XpG(2);t.R7$(),t.JRh(n.lang.text.InstantCall.Connecting)}}function F(a,s){if(1&a&&(t.j41(0,"ion-label",22),t.EFF(1),t.k0s()),2&a){const n=t.XpG(2);t.R7$(),t.JRh(n.lang.text.InstantCall.Connected)}}function V(a,s){if(1&a&&(t.j41(0,"div")(1,"div",19),t.nrm(2,"ion-icon",20),t.j41(3,"div"),t.DNE(4,D,2,1,"ion-label",21)(5,Y,2,1,"ion-label",21)(6,F,2,1,"ion-label",21),t.k0s()()()),2&a){const n=t.XpG();t.R7$(4),t.Y8G("ngIf",!n.global.InitEnd&&!n.global.PeerConnected),t.R7$(),t.Y8G("ngIf",!n.global.InitEnd&&n.global.PeerConnected),t.R7$(),t.Y8G("ngIf",n.global.InitEnd)}}const B=[{path:"",component:(()=>{var a;class s{constructor(l,e,i,C,h,g,d,r,m){this.global=l,this.lang=e,this.webrtc=i,this.title=C,this.nakama=h,this.router=g,this.route=d,this.p5toast=r,this.navCtrl=m,this.UserInputCustomAddress="",this.NeedInputCustomAddress=!1,this.isCustomServer=!1,this.PageOut=!1,this.CallClosed=!1}ngOnInit(){this.ServerList=this.nakama.get_all_online_server(),setTimeout(()=>{this.InstantCallServer?(this.InstantCallServer.value=this.ServerList[0]||"local",this.SelectAddressTarget({detail:{value:this.InstantCallServer.value}})):this.NeedInputCustomAddress=!0},0),this.route.queryParams.subscribe(l=>{const e=this.router.getCurrentNavigation().extras.state;e&&(this.UserInputCustomAddress=e.address,this.ChannelId=e.channel,this.Port=e.port,this.Username=e.username,this.Password=e.password,this.LinkToServer(!0))})}SelectAddressTarget(l){"local"===(this.title.setTitle(this.lang.text.InstantCall.Title),l.detail.value)?(this.UserInputCustomAddress="",this.NeedInputCustomAddress=!0):(this.UserInputCustomAddress=l.detail.value.info.address,this.NeedInputCustomAddress=!1)}LinkToServer(l=!1){var e=this;if(v.R.requestAudioRecordingPermission(),l&&!this.ChannelId)return this.p5toast.show({text:this.lang.text.InstantCall.MissingInfo}),void this.navCtrl.pop();let i=this.UserInputCustomAddress.split("://"),C=i.pop();this.isCustomServer=l||!this.InstantCallServer||"local"==this.InstantCallServer.value,this.isCustomServer&&this.nakama.SaveWebRTCServer({urls:[`stun:${C}:${this.Port||3478}`,`turn:${C}:${this.Port||3478}`],username:this.Username||"username",credential:this.Password||"password"});let g,h=i.pop();h||(h=this.global.checkProtocolFromAddress(C)?"wss":"ws"),this.global.InstantCallWSClient=new WebSocket(`${h}://${C}:12013`),this.global.InstantCallWSClient.onopen=(0,f.A)(function*(){e.global.WaitingConnect=!0,e.p5toast.show({text:e.lang.text.InstantCall.Waiting}),e.ChannelId?(e.global.InstantCallSend(JSON.stringify({type:"join",channel:e.ChannelId})),yield new Promise(d=>setTimeout(d,e.global.WebsocketRetryTerm)),e.global.PeerConnected=!0,e.webrtc.initialize("audio").then(()=>{e.webrtc.HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close()},e.ShowWaiting(),e.webrtc.CreateOffer(),e.global.PeerConnected=!0,e.global.InstantCallSend(JSON.stringify({type:"init_req"}))})):e.global.InstantCallSend(JSON.stringify({type:"init"}))}),this.global.InstantCallWSClient.onmessage=d=>{let r=JSON.parse(d.data);if(void 0===g)g=r.uid;else if(g==r.uid)return;switch(r.type){case"leave":this.global.InstantCallWSClient.close();break;case"init_id":this.global.InstantCallSend(JSON.stringify({type:"join",channel:r.id})),this.ChannelId=r.id,this.QRCodeAsString=`${S.d2}pjcone_pwa/?instc=${this.UserInputCustomAddress},${this.ChannelId},${this.Port||""},${this.Username||""},${this.Password||""}`;break;case"init_req":this.global.PeerConnected=!0,this.webrtc.initialize("audio").then((0,f.A)(function*(){e.webrtc.HangUpCallBack=()=>{e.global.InstantCallWSClient&&e.global.InstantCallWSClient.close()},e.ShowWaiting(),e.webrtc.CreateOffer(),yield new Promise(m=>setTimeout(m,e.global.WebsocketRetryTerm)),e.global.InstantCallSend(JSON.stringify({type:"socket_react",channel:e.ChannelId,act:"WEBRTC_INIT_REQ_SIGNAL"}))}));break;case"socket_react":switch(r.act){case"WEBRTC_REPLY_INIT_SIGNAL":this.nakama.socket_reactive[r.act](r.data_str),"EOL"==r.data_str&&this.webrtc.CreateAnswer({client:this.global.InstantCallWSClient,channel:this.ChannelId});break;case"WEBRTC_ICE_CANDIDATES":this.nakama.socket_reactive[r.act](r.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId}),this.global.InstantCallSend(JSON.stringify({type:"init_end",channel:this.ChannelId})),this.global.InitEnd=!0;break;case"WEBRTC_INIT_REQ_SIGNAL":this.nakama.socket_reactive[r.act]({client:this.global.InstantCallWSClient,channel:this.ChannelId});break;case"WEBRTC_RECEIVE_ANSWER":this.nakama.socket_reactive[r.act](r.data_str,{client:this.global.InstantCallWSClient,channel:this.ChannelId})}break;case"init_end":this.global.InitEnd=!0}},this.global.InstantCallWSClient.onerror=d=>{console.error("\uc989\uc11d \ud1b5\ud654 \uc6f9\uc18c\ucf13 \uc624\ub958: ",d),this.global.InstantCallWSClient.close()},this.global.InstantCallWSClient.onclose=()=>{this.p5toast.show({text:this.lang.text.InstantCall.CallEnd}),this.global.WaitingConnect=!1,this.global.InitEnd=!1,this.global.PeerConnected=!1,this.global.InstantCallWSClient.onopen=null,this.global.InstantCallWSClient.onclose=null,this.global.InstantCallWSClient.onmessage=null,this.global.InstantCallWSClient.onerror=null,this.global.InstantCallWSClient=null,this.webrtc.close_webrtc(!1),this.CallClosed=!0,this.PageOut||this.navCtrl.pop()}}copy_qr_address(l=this.QRCodeAsString){this.global.WriteValueToClipboard("text/plain",l)}ShowWaiting(){this.QRCodeAsString="",!this.p5canvas&&(this.p5canvas=new b(l=>{let e=document.getElementById("InstantCallCanvasDiv"),i=1;l.setup=()=>{l.pixelDensity(1),l.createCanvas(e.clientWidth,e.clientHeight).parent(e),l.noStroke()};class C{constructor(){this.color={r:0,g:0,b:0},this.size=1,this.targetSize=100,this.opacity=200,this.pos=l.createVector(0,0),this.dir=l.createVector(l.random(-1.4,1.4),l.random(-2,-4)),this.color.r=l.random(0,255),this.color.g=l.random(0,255),this.color.b=l.random(0,255),this.targetSize=l.random(80,150)}display(){this.size<this.targetSize&&(this.size+=6),this.size>this.targetSize&&(this.size=this.targetSize),l.push(),l.fill(this.color.r,this.color.g,this.color.b,this.opacity),l.circle(this.pos.x,this.pos.y,this.size*i),l.pop(),this.pos.add(this.dir),this.dir.y+=.04,this.opacity-=1}}let h=[],g=!0;l.draw=()=>{g&&(h.push(new C),g=!1,setTimeout(()=>{g=!0},500)),l.clear(),l.push(),l.translate(l.width/2,l.height/2);for(let d=h.length-1;d>=0;d--)h[d].display(),h[d].opacity<=0&&h.splice(d,1);l.pop(),this.global.InitEnd&&(i-=.02),i<=0&&l.remove()},l.windowResized=()=>{l.resizeCanvas(e.clientWidth,e.clientHeight)}}))}ionViewWillEnter(){this.PageOut=!1,this.p5canvas&&this.p5canvas.windowResized(),this.global.StoreShortCutAct("instant-call"),this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.CallClosed&&this.navCtrl.pop()}ionViewWillLeave(){this.PageOut=!0,delete this.global.p5KeyShortCut.Escape,this.global.RestoreShortCutAct("instant-call")}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove(),this.isCustomServer&&this.nakama.RemoveWebRTCServer(this.UserInputCustomAddress.split("://").pop()),!this.global.InitEnd&&!this.global.PeerConnected&&this.global.InstantCallWSClient&&this.global.InstantCallWSClient.close(),this.route.queryParams.unsubscribe()}}return(a=s).\u0275fac=function(l){return new(l||a)(t.rXU(R.z3),t.rXU(P.y),t.rXU(x.j),t.rXU(T.hE),t.rXU(W.X),t.rXU(u.Ix),t.rXU(u.nX),t.rXU(G.G),t.rXU(k.q9))},a.\u0275cmp=t.VBU({type:a,selectors:[["app-instant-call"]],viewQuery:function(l,e){if(1&l&&t.GBs(j,5),2&l){let i;t.mGM(i=t.lsd())&&(e.InstantCallServer=i.first)}},decls:11,vars:5,consts:[["InstantCallServer",""],[1,"ion-no-border"],["slot","start"],["defaultHref","portal/arcade"],["id","InstantCallCanvasDiv","style","position: absolute; width: 100%; height: 100%; overflow: hidden; pointer-events: none;",4,"ngIf"],["style","flex: 0 1 auto;",4,"ngIf"],["button","",3,"click",4,"ngIf"],[4,"ngIf"],["id","InstantCallCanvasDiv",2,"position","absolute","width","100%","height","100%","overflow","hidden","pointer-events","none"],[2,"flex","0 1 auto"],["button","",3,"click"],[1,"ion-text-center"],["value","local",2,"pointer-events","none",3,"ionChange","label"],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["placeholder","(wss://)0.0.0.0",1,"ion-text-right",3,"ngModelChange","label","ngModel"],["slot","end","name","open-outline",3,"click"],[1,"ion-text-right",3,"ngModelChange","label","ngModel","placeholder"],[1,"disconnect_info"],["color","medium","name","call-outline",2,"width","60px","height","60px"],["color","medium",4,"ngIf"],["color","medium"]],template:function(l,e){1&l&&(t.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-title"),t.EFF(3),t.k0s(),t.j41(4,"ion-buttons",2),t.nrm(5,"ion-back-button",3),t.k0s()()(),t.j41(6,"ion-content"),t.DNE(7,w,1,0,"div",4)(8,M,9,6,"div",5)(9,X,3,1,"ion-item",6)(10,V,7,3,"div",7),t.k0s()),2&l&&(t.R7$(3),t.JRh(e.lang.text.InstantCall.Title),t.R7$(4),t.Y8G("ngIf",e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",!e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",e.QRCodeAsString&&e.global.WaitingConnect),t.R7$(),t.Y8G("ngIf",e.global.WaitingConnect||e.global.InitEnd))},dependencies:[I.Sq,I.bT,_.BC,_.vS,c.QW,c.W9,c.eU,c.iq,c.$w,c.uz,c.he,c.Nm,c.Ip,c.BC,c.ai,c.Je,c.Gw,c.el]}),s})()}];let z=(()=>{var a;class s{}return(a=s).\u0275fac=function(l){return new(l||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[u.iI.forChild(B),u.iI]}),s})(),O=(()=>{var a;class s{}return(a=s).\u0275fac=function(l){return new(l||a)},a.\u0275mod=t.$C({type:a}),a.\u0275inj=t.G2t({imports:[I.MD,_.YN,c.bv,z]}),s})()}}]);