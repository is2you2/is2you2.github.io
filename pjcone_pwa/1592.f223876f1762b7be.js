"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1592],{8828:(F,k,m)=>{m.d(k,{_8:()=>x,on:()=>h,wd:()=>b});var x=function(f){return f.Prompt="PROMPT",f.Camera="CAMERA",f.Photos="PHOTOS",f}(x||{}),b=function(f){return f.Rear="REAR",f.Front="FRONT",f}(b||{}),h=function(f){return f.Uri="uri",f.Base64="base64",f.DataUrl="dataUrl",f}(h||{})},4120:(F,k,m)=>{m.d(k,{Ut:()=>h,_8:()=>b._8,on:()=>b.on});var x=m(6400),b=m(8828);const h=(0,x.C_)("Camera",{web:()=>m.e(9028).then(m.bind(m,9028)).then(f=>new f.CameraWeb)})},1592:(F,k,m)=>{m.r(k),m.d(k,{AddPostPageModule:()=>se});var x=m(1368),b=m(4716),h=m(5624),f=m(3332),v=m(1528),E=m(5020),M=m(340),$=m(4120),w=m(1052),R=m(4712),G=m(2272),D=m(8744),U=m(9352),B=m(5193),t=m(4496),N=m(4500),j=m(9240),L=m(7136),Y=m(3824),K=m(4668),W=m(4476),H=m(7756);function z(c,g){if(1&c&&(t.I0R(0,"ion-title"),t.OEk(1),t.C$Y()),2&c){const l=t.GaO();t.yG2(),t.cNF(l.lang.text.AddPost.EditTitle)}}function J(c,g){if(1&c&&(t.I0R(0,"ion-title"),t.OEk(1),t.C$Y()),2&c){const l=t.GaO();t.yG2(),t.cNF(l.lang.text.AddPost.Title)}}function V(c,g){if(1&c){const l=t.KQA();t.I0R(0,"ion-item",7),t.qCj("click",function(){const n=t.usT(l).index,i=t.GaO(2);return t.CGJ(i.select_server(n,!0))}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y()()}if(2&c){const l=g.$implicit;t.yG2(2),t.cNF(l.name)}}function Q(c,g){if(1&c){const l=t.KQA();t.I0R(0,"ion-accordion-group",21,22),t.qCj("click",function(){t.usT(l);const a=t.GaO();return t.CGJ(a.isExpanded=!0)}),t.I0R(2,"ion-accordion",23)(3,"ion-item",24)(4,"ion-label"),t.OEk(5),t.C$Y(),t.I0R(6,"ion-label",25),t.OEk(7),t.C$Y(),t.wR5(8,"ion-icon",26),t.C$Y(),t.I0R(9,"div",27),t.yuY(10,V,3,1,"ion-item",28),t.C$Y()()()}if(2&c){const l=t.GaO();t.E7m("disabled",l.isSaveClicked)("value",l.isExpanded),t.yG2(5),t.cNF(l.lang.text.AddGroup.SelectServer),t.yG2(2),t.cNF(l.servers[l.index].name),t.yG2(3),t.E7m("ngForOf",l.servers)}}function X(c,g){if(1&c){const l=t.KQA();t.I0R(0,"div",29)(1,"ion-item",11)(2,"ion-toggle",30),t.iHE("ngModelChange",function(a){t.usT(l);const n=t.GaO();return t.kNx(n.userInput.isNSFW,a)||(n.userInput.isNSFW=a),t.CGJ(a)}),t.OEk(3),t.C$Y()(),t.I0R(4,"div",31),t.wR5(5,"img",32),t.C$Y()()}if(2&c){const l=t.GaO();t.yG2(2),t.OKB("ngModel",l.userInput.isNSFW),t.yG2(),t.cNF(l.lang.text.AddPost.NSFW),t.yG2(2),t.m_g(l.userInput.isNSFW?"filter: blur(16px);":""),t.E7m("src",l.MainPostImage,t.K6U)}}function Z(c,g){if(1&c&&t.wR5(0,"ion-icon",37),2&c){const l=t.GaO().$implicit;t.E7m("name",l.icon||"close-circle")}}function q(c,g){if(1&c&&t.wR5(0,"img",38),2&c){const l=t.GaO().$implicit;t.E7m("src","assets/icon/"+l.icon_img,t.K6U)("alt",l.title)}}function ee(c,g){if(1&c){const l=t.KQA();t.I0R(0,"div",33)(1,"div",34),t.qCj("click",function(){const n=t.usT(l).$implicit;return t.CGJ(n.act())}),t.yuY(2,Z,1,1,"ion-icon",35)(3,q,1,2,"img",36),t.I0R(4,"div"),t.OEk(5),t.C$Y()()()}if(2&c){const l=g.$implicit;t.yG2(),t.m_g("cursor: "+(l.cursor||"pointer")+";"),t.E7m("hidden",l.isHide),t.yG2(),t.E7m("ngIf",l.icon),t.yG2(),t.E7m("ngIf",l.icon_img),t.yG2(2),t.cNF(l.name)}}function te(c,g){if(1&c){const l=t.KQA();t.I0R(0,"ion-item",39),t.qCj("click",function(){const a=t.usT(l),n=a.$implicit,i=a.index,s=t.GaO();return t.CGJ(s.open_viewer(n,i))}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"div",40),t.wR5(4,"img",41),t.C$Y()()}if(2&c){const l=g.$implicit,e=g.index,a=t.GaO();t.E7m("id","PostAttach_"+e)("disabled",a.isSaveClicked),t.yG2(2),t.cNF("["+e+"] "+l.filename),t.yG2(2),t.E7m("src",l.thumbnail,t.K6U)}}const ae=[{path:"",component:(()=>{var c;class g{constructor(e,a,n,i,s,o,y,p,r,u,A,T){var C,d=this;this.global=e,this.lang=a,this.navCtrl=n,this.nakama=i,this.modalCtrl=s,this.p5toast=o,this.indexed=y,this.loadingCtrl=p,this.sanitizer=r,this.mClipboard=u,this.route=A,this.router=T,this.servers=[],this.userInput={id:void 0,title:void 0,content:void 0,creator_id:void 0,creator_name:void 0,UserColor:void 0,create_time:void 0,modify_time:void 0,server:void 0,mainImage:void 0,attachments:[],isNSFW:!1},this.index=0,this.isModify=!1,this.isExpanded=!1,this.isSaveClicked=!1,this.isServerChanged=!1,this.useVoiceRecording=!1,this.MainPostImage=void 0,this.extended_buttons=[{icon:"image-outline",name:this.lang.text.AddPost.MainPostImage,act:()=>{this.isSaveClicked||(this.MainPostImage?(this.MainPostImage=void 0,this.userInput.mainImage=void 0,document.getElementById("PostMainImage_sel").value=""):document.getElementById("PostMainImage_sel").click())}},{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(C=(0,v.c)(function*(){if(!d.isSaveClicked)try{return void(yield d.new_attach({detail:{value:"link"}}))}catch(_){"done"!=_&&d.new_attach({detail:{value:"load"}})}}),function(){return C.apply(this,arguments)})},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:function(){var C=(0,v.c)(function*(){d.isSaveClicked||d.modalCtrl.create({component:w.S,componentProps:{},cssClass:"fullscreen"}).then(I=>{I.onWillDismiss().then(function(){var S=(0,v.c)(function*(O){O.data&&(d.AddAttachTextForm(),yield d.voidDraw_fileAct_callback(O,void 0))});return function(O){return S.apply(this,arguments)}}()),I.onDidDismiss().then(()=>{d.AddShortcut()}),delete d.global.p5key.KeyShortCut.Escape,I.present()})});return function(){return C.apply(this,arguments)}}()},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:function(){var C=(0,v.c)(function*(){if(!d.isSaveClicked)try{const _=yield $.Ut.getPhoto({quality:90,resultType:$.on.Base64,source:$._8.Camera});let P=yield d.loadingCtrl.create({message:d.lang.text.TodoDetail.WIP});P.present();let I={};I.filename=`Camera_${(new Date).toLocaleString().replace(/:/g,"_")}.${_.format}`,I.file_ext=_.format,I.thumbnail=d.sanitizer.bypassSecurityTrustUrl("data:image/jpeg;base64,"+_.base64String),I.type=`image/${_.format}`,I.typeheader="image",I.content_related_creator=[{user_id:"local"==d.servers[d.index].isOfficial?"local":d.nakama.servers[d.isOfficial][d.target].session.user_id,timestamp:(new Date).getTime(),display_name:d.nakama.users.self.display_name,various:"camera"}],I.content_creator={user_id:"local"==d.servers[d.index].isOfficial?"local":d.nakama.servers[d.isOfficial][d.target].session.user_id,timestamp:(new Date).getTime(),display_name:d.nakama.users.self.display_name,various:"camera"},I.viewer="image",I.path=`tmp_files/post/${I.filename}`,yield d.indexed.saveBase64ToUserPath("data:image/jpeg;base64,"+_.base64String,I.path,O=>{I.blob=new Blob([O],{type:I.type})}),d.AddAttachTextForm(),d.userInput.attachments.push(I),d.MakeAttachHaveContextMenu(),P.dismiss()}catch{}});return function(){return C.apply(this,arguments)}}()},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var C=(0,v.c)(function*(){if(!d.isSaveClicked)if(d.useVoiceRecording=!d.useVoiceRecording,d.useVoiceRecording)(yield R.G.hasAudioRecordingPermission()).value?(d.extended_buttons[4].icon="stop-circle-outline",yield R.G.startRecording(),d.p5toast.show({text:d.lang.text.ChatRoom.StartVRecord})):yield R.G.requestAudioRecordingPermission();else{let _=yield R.G.stopRecording(),P=d.global.Base64ToBlob(`${_.value.mimeType},${_.value.recordDataBase64}`);P.name=`${d.lang.text.ChatRoom.VoiceRecord}.${_.value.mimeType.split("/").pop().split(";")[0]}`,P.type_override=_.value.mimeType,d.selected_blobFile_callback_act(P),d.extended_buttons[4].icon="mic-circle-outline"}});return function(){return C.apply(this,arguments)}}()},{icon:"cloud-done-outline",name:this.lang.text.ChatRoom.UseCloud,act:()=>{this.toggle_custom_attach()}}],this.lock_modal_open=!1,this.useFirstCustomCDN=!0,this.isApplyPostData=!1}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove()}ngOnInit(){var e=this;this.useFirstCustomCDN=!!localStorage.getItem("useFFSCDN"),this.toggle_custom_attach(this.useFirstCustomCDN),this.route.queryParams.subscribe(function(){var a=(0,v.c)(function*(n){const i=e.router.getCurrentNavigation().extras.state;let s=!1;if(i&&(s=!!i.act,i.data&&(e.userInput=i.data)),e.MakeAttachHaveContextMenu(),s){if(e.servers=e.nakama.get_all_server_info(!0,!0),e.servers.unshift({name:e.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0}),e.servers.length>1&&(e.index=1),i&&i.data){let y=`${e.userInput.server.isOfficial}/${e.userInput.server.target}`;for(let p=0,r=e.servers.length;p<r;p++)if(`${e.servers[p].isOfficial}/${e.servers[p].target}`==y){e.index=p;break}if(e.userInput.mainImage){let p=e.userInput.mainImage.url;p||(p=URL.createObjectURL(e.userInput.mainImage.blob),setTimeout(()=>{URL.revokeObjectURL(p)},100)),e.MainPostImage=p}}e.select_server(e.index),i&&i.data&&(e.OriginalInfo=JSON.parse(JSON.stringify(e.userInput)))}});return function(n){return a.apply(this,arguments)}}()),"DesktopPWA"==B.s1&&setTimeout(()=>{this.CreateDrop()},0)}CreateDrop(){var e=this;let a=document.getElementById("p5Drop_addPost");this.p5canvas||(this.p5canvas=new U(n=>{n.setup=()=>{let i=n.createCanvas(a.clientWidth,a.clientHeight);i.parent(a),n.pixelDensity(.1),i.drop(function(){var s=(0,v.c)(function*(o){yield e.selected_blobFile_callback_act(o.file)});return function(o){return s.apply(this,arguments)}}())},n.mouseMoved=i=>{i.dataTransfer?(a.style.pointerEvents="all",a.style.backgroundColor="#0008"):(a.style.pointerEvents="none",a.style.backgroundColor="transparent")},n.keyPressed=i=>{"Enter"===i.code&&"exact_post_title_id"==document.activeElement.id&&this.postData()}}))}catchBottomTabShortCut(){this.BottomTabShortcut=this.global.p5key.KeyShortCut.BottomTab,delete this.global.p5key.KeyShortCut.BottomTab}ionViewWillEnter(){this.AddShortcut(),this.catchBottomTabShortCut(),this.TitleInput=document.getElementById("add_post_title").childNodes[1].childNodes[1].childNodes[1],this.TitleInput.id="exact_post_title_id",this.TitleInput.onpaste=a=>{let n=[];for(const i of a.clipboardData.files)i.type.startsWith("image/png")&&n.push({file:i});if(n.length)return 1==n.length&&this.ChangeMainPostImage({target:{files:[n[0].file]}}),!1};let e=document.getElementById("add_post_content");setTimeout(()=>{this.userInput.title?e.focus():this.TitleInput.focus()},200),e.onpaste=a=>{let n=[];for(const i of a.clipboardData.files)i.type.startsWith("image/")&&n.push({file:i});if(n.length){if(1==n.length)this.selected_blobFile_callback_act(n[0].file);else for(let i=0,s=n.length;i<s;i++)this.selected_blobFile_callback_act(n[i].file);return!1}},this.isModify=!!this.userInput.id}go_to_profile(){this.modalCtrl.create({component:M.w,componentProps:{isOfficial:this.isOfficial,target:this.target}}).then(e=>e.present())}select_server(e,a=!1){this.index=e,this.userInput.server=this.servers[e],this.isExpanded=!1,this.isOfficial=this.servers[e].isOfficial,this.target=this.servers[e].target,a?this.isServerChanged=this.OriginalServerInfo!=`${this.isOfficial}/${this.target}`:this.OriginalServerInfo=`${this.isOfficial}/${this.target}`,this.userInput.creator_name=this.nakama.users.self.display_name;try{this.userInput.creator_id=this.nakama.servers[this.isOfficial][this.target].session.user_id,this.userInput.UserColor=(this.userInput.creator_id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6)}catch{this.userInput.creator_id="me",this.userInput.UserColor="888888"}}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.navigateBack("portal/community")})}ChangeMainPostImage(e){let a=e.target.files[0],n={};n.filename=a.name,n.file_ext=a.name.split(".").pop()||a.type||this.lang.text.ChatRoom.unknown_ext,n.size=a.size,n.type=a.type||a.type_override,n.blob=a,n.path=`tmp_files/post/MainImage.${n.file_ext}`,this.userInput.mainImage=n;let i=URL.createObjectURL(a);this.indexed.saveBlobToUserPath(a,n.path),this.MainPostImage=i,setTimeout(()=>{URL.revokeObjectURL(i)},100)}selected_blobFile_callback_act(e,a=[],n="loaded",i){var s=this;return(0,v.c)(function*(){let o={};o.filename=e.name,o.file_ext=e.name.split(".").pop()||e.type||s.lang.text.ChatRoom.unknown_ext,o.size=e.size,o.type=e.type||e.type_override,i&&(o.path=i),o.content_related_creator=[...a,{user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:n}],o.content_creator={user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:n},o.blob=e,o.path=`tmp_files/post/${o.filename}_${s.userInput.attachments.length}.${o.file_ext}`,s.create_selected_thumbnail(o),s.AddAttachTextForm(),s.userInput.attachments.push(o),s.MakeAttachHaveContextMenu(),s.indexed.saveBlobToUserPath(o.blob,o.path)})()}AddAttachTextForm(){this.userInput.content?this.userInput.content+=`\n[${this.userInput.attachments.length}]\n`:this.userInput.content=`[${this.userInput.attachments.length}]\n`}create_selected_thumbnail(e){var a=this;return(0,v.c)(function*(){if(a.global.set_viewer_category_from_ext(e),e.url){try{(yield fetch(e.url)).ok&&(e.thumbnail=e.url)}catch{}return void(e.typeheader=e.viewer)}try{e.thumbnail=yield a.indexed.loadBlobFromUserPath(e.path,e.type)}catch{}let n=URL.createObjectURL(e.blob);"image"===(e.typeheader=e.blob.type.split("/")[0]||e.viewer,setTimeout(()=>{URL.revokeObjectURL(n)},0),e.thumbnail=void 0,e.typeheader)&&(e.thumbnail=a.sanitizer.bypassSecurityTrustUrl(n))})()}voidDraw_fileAct_callback(e,a,n){var i=this;return(0,v.c)(function*(){let s={};void 0!==n?i.userInput.attachments[n]=s:i.userInput.attachments.push(s);try{s.filename=e.data.name,s.file_ext="png",s.thumbnail=i.sanitizer.bypassSecurityTrustUrl(e.data.img),s.type="image/png",s.typeheader="image",a?(s.content_related_creator=a,s.content_creator={user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}):(s.content_related_creator=[{user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}],s.content_creator={user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}),s.path=`tmp_files/post/${s.filename}`,s.viewer="image",yield i.indexed.saveBase64ToUserPath(e.data.img,s.path,o=>{s.blob=new Blob([o],{type:s.type})}),i.MakeAttachHaveContextMenu()}catch(o){console.error("godot-\uc774\ubbf8\uc9c0 \ud3b8\uc9d1 \uc0ac\uc6a9 \ubd88\uac00: ",o)}e.data.loadingCtrl.dismiss()})()}new_attach(e,a=void 0){var n=this;return(0,v.c)(function*(){let i;switch(void 0===a&&(a={}),e.detail.value){case"load":document.getElementById("add_post_input").click();break;case"link":try{let s=a.url;if(void 0===s)try{s=yield n.mClipboard.paste()}catch{try{s=yield G.c.read()}catch(r){throw r}}try{let p=n.global.Base64ToBlob(s),r=s.split(";")[0].split(":")[1];throw i=new File([p],`${n.lang.text.ChatRoom.FileLink}.${r.split("/").pop()}`,{type:r}),yield n.selected_blobFile_callback_act(i),"done"}catch(p){if("done"===p)throw p}try{if(i&&void 0===a.filename)throw"\uc774\ubbf8 \ud30c\uc77c\uc774 \ucca8\ubd80\ub428, \ud1a0\uae00\ub9cc \uc2dc\ub3c4";if(!(yield fetch(s)).ok)throw"URL \uad6c\uc870\uac00 \uc815\uc0c1\uc774 \uc544\ub2d8"}catch(p){throw p}let o={};o.url=s,o.content_related_creator=[],a&&a.content_related_creator&&(o.content_related_creator=[...a.content_related_creator]),o.content_related_creator.push({user_id:"local"==n.servers[n.index].isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:a.url?"shared":"link"}),o.content_creator={user_id:"local"==n.servers[n.index].isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,timestamp:(new Date).getTime(),display_name:n.nakama.users.self.display_name,various:a.url?"shared":"link"};let y=o.url.split(".");o.file_ext=a.file_ext||y.pop().split("?").shift(),o.filename=a.filename||decodeURIComponent(`${y.pop().split("/").pop()||n.lang.text.ChatRoom.ExternalLinkFile}.${o.file_ext}`),n.global.set_viewer_category_from_ext(o),o.type=a.type||"",o.typeheader=a.typeheader||o.viewer,n.global.modulate_thumbnail(o,o.url),n.userInput.attachments.push(o),n.MakeAttachHaveContextMenu()}catch(s){throw"done"==s?s:`\uc778\uc2dd \ubd88\uac00\ub2a5\ud55c URL \uc815\ubcf4: ${s}`}}})()}MakeAttachHaveContextMenu(){setTimeout(()=>{for(let e=this.userInput.attachments.length-1;e>=0;e--)document.getElementById(`PostAttach_${e}`).oncontextmenu=()=>(this.p5toast.show({text:`${this.lang.text.AddPost.RemoveAttach}: ${this.userInput.attachments[e].filename}`}),this.userInput.attachments.splice(e,1),this.MakeAttachHaveContextMenu(),!1)},0)}inputFileSelected(e){var a=this;return(0,v.c)(function*(){if(e.target.files.length)if(1!=e.target.files.length){let i=yield a.loadingCtrl.create({message:a.lang.text.ChatRoom.MultipleSend});i.present();for(let s=0,o=e.target.files.length;s<o;s++)i.message=`${o-s}: ${e.target.files[s].name}`,yield a.selected_blobFile_callback_act(e.target.files[s]);i.dismiss(),setTimeout(()=>{document.getElementById("add_post_input").value=""},300)}else{let i=yield a.loadingCtrl.create({message:a.lang.text.TodoDetail.WIP});i.present(),yield a.selected_blobFile_callback_act(e.target.files[0]),i.dismiss(),document.getElementById("add_post_input").value=""}})()}open_viewer(e,a){var n=this;let i=[];for(let s=0,o=this.userInput.attachments.length;s<o;s++)i.push({content:this.userInput.attachments[s]});this.lock_modal_open||(this.lock_modal_open=!0,delete this.global.p5key.KeyShortCut.Escape,this.modalCtrl.create({component:D.K,componentProps:{info:{content:e},path:e.path,alt_path:e.path,isOfficial:this.isOfficial,target:this.target,relevance:i,local:"local"==this.servers[this.index].isOfficial},cssClass:"fullscreen"}).then(s=>{s.onDidDismiss().then(o=>{if(this.AddShortcut(),o.data)switch(o.data.type){case"image":let y=[];if(o.data.msg.content.content_related_creator&&(y=[...o.data.msg.content.content_related_creator]),o.data.msg.content.content_creator){let p=!1;for(let r=0,u=y.length;r<u;r++)if(y[r].user_id==o.data.msg.content.content_creator.user_id){p=!0;break}p||y.push(o.data.msg.content.content_creator)}return void this.modalCtrl.create({component:w.S,componentProps:{path:o.data.path||e.path,width:o.data.width,height:o.data.height,isDarkMode:o.data.isDarkMode},cssClass:"fullscreen"}).then(p=>{p.onDidDismiss().then(()=>{this.AddShortcut()}),p.onWillDismiss().then(function(){var r=(0,v.c)(function*(u){u.data&&(yield n.voidDraw_fileAct_callback(u,y,a))});return function(u){return r.apply(this,arguments)}}()),delete this.global.p5key.KeyShortCut.Escape,p.present()});case"text":this.selected_blobFile_callback_act(o.data.blob,o.data.contentRelated,"textedit")}}),delete this.global.p5key.KeyShortCut.Escape,s.present(),this.lock_modal_open=!1}))}toggle_custom_attach(e){var a=this;return(0,v.c)(function*(){a.useFirstCustomCDN=null!=e?e:!a.useFirstCustomCDN,a.extended_buttons[5].icon=a.useFirstCustomCDN?"cloud-done-outline":"cloud-offline-outline",a.useFirstCustomCDN?localStorage.setItem("useFFSCDN",`${a.useFirstCustomCDN}`):localStorage.removeItem("useFFSCDN")})()}postData(){var e=this;return(0,v.c)(function*(){if(!e.userInput.title)return e.p5toast.show({text:e.lang.text.AddPost.NeedPostTitle}),void e.TitleInput.focus();let a=!!e.userInput.server.local;e.isApplyPostData=!0;let n=yield e.loadingCtrl.create({message:e.lang.text.AddPost.WIP});n.present(),e.isSaveClicked=!0;let i=e.userInput.server.isOfficial,s=e.userInput.server.target;if(!e.isModify||e.isServerChanged)if(e.isServerChanged&&e.OriginalInfo&&(yield e.nakama.RemovePost(e.OriginalInfo)),a){let r=Number(yield e.indexed.loadTextFromUserPath("servers/local/target/posts/me/counter.txt"))||0;e.userInput.id=`LocalPost_${r}`;try{yield e.indexed.saveTextFileToUserPath(`${r+1}`,"servers/local/target/posts/me/counter.txt")}catch(u){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${u}`}),console.log(u)}}else try{let r=yield e.nakama.servers[i][s].client.readStorageObjects(e.nakama.servers[i][s].session,{object_ids:[{collection:"server_post",key:"Counter",user_id:e.nakama.servers[i][s].session.user_id}]}),u=0;r.objects.length&&(u=r.objects[0].value.counter),e.userInput.id=`ServerPost_${u}`,yield e.nakama.servers[i][s].client.writeStorageObjects(e.nakama.servers[i][s].session,[{collection:"server_post",key:"Counter",permission_write:1,permission_read:2,value:{counter:u+1}}])}catch(r){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${r}`}),console.log(r)}else yield e.nakama.RemovePost(e.userInput);e.isModify?e.userInput.modify_time=(new Date).getTime():(e.userInput.create_time=(new Date).getTime(),e.userInput.modify_time=e.userInput.create_time);for(let r=0,u=e.userInput.attachments.length;r<u;r++)delete e.userInput.attachments[r].thumbnail;if(e.userInput.mainImage){n.message=e.lang.text.AddPost.SyncMainImage;try{e.userInput.mainImage.path=`servers/${i}/${s}/posts/${e.userInput.creator_id}/${e.userInput.id}/mainImage.png`,yield e.indexed.saveBlobToUserPath(e.userInput.mainImage.blob,e.userInput.mainImage.path)}catch(A){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${A}`}),console.log(A)}let r=e.userInput.mainImage.blob;a||(yield e.nakama.sync_save_file(e.userInput.mainImage,i,s,"server_post",`${e.userInput.id}_mainImage`)),e.userInput.mainImage.blob=r;let u=URL.createObjectURL(r);e.userInput.mainImage.thumbnail=u,setTimeout(()=>{URL.revokeObjectURL(r)},100)}let o=e.userInput.attachments.length;if(o){n.message=e.lang.text.AddPost.SyncAttaches;for(let r=o-1;r>=0;r--){try{let u;if(n.message=`${e.lang.text.AddPost.SyncAttaches}: [${r}]${e.userInput.attachments[r].filename}`,e.useFirstCustomCDN&&(u=yield e.global.try_upload_to_user_custom_fs(e.userInput.attachments[r],e.nakama.users.self.display_name)),!u)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.attachments[r].path,delete e.userInput.attachments[r].partsize,e.userInput.attachments[r].url=u}catch{e.userInput.attachments[r].path=`servers/${i}/${s}/posts/${e.userInput.creator_id}/${e.userInput.id}/[${r}]${e.userInput.attachments[r].filename}`,yield e.indexed.saveBlobToUserPath(e.userInput.attachments[r].blob,e.userInput.attachments[r].path)}if(!a)try{let u=e.nakama.servers[e.isOfficial][e.target].info.address,A=e.nakama.servers[e.isOfficial][e.target].info.useSSL?"https:":"http:",T=yield e.global.upload_file_to_storage(e.userInput.attachments[r],e.nakama.servers[e.isOfficial][e.target].session.user_id,A,u,e.useFirstCustomCDN);if(!T)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.attachments[r].partsize,e.userInput.attachments[r].url=T}catch{yield e.nakama.sync_save_file(e.userInput.attachments[r],i,s,"server_post",`${e.userInput.id}_attach_${r}`)}}}let y=JSON.parse(JSON.stringify(e.userInput));y.mainImage&&delete y.mainImage.blob;for(let r=y.attachments.length-1;r>=0;r--)delete y.attachments[r].blob;delete y.server;try{e.nakama.posts_orig[i][s]||(e.nakama.posts_orig[i][s]={}),e.nakama.posts_orig[i][s][e.userInput.creator_id]||(e.nakama.posts_orig[i][s][e.userInput.creator_id]={}),e.nakama.posts_orig[i][s][e.userInput.creator_id][e.userInput.id]=e.userInput}catch(r){e.p5toast.show({text:`${e.lang.text.AddPost.SyncErr}: ${r}`}),console.log(r)}let p=JSON.stringify(y);if(yield e.indexed.saveTextFileToUserPath(p,`servers/${i}/${s}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`),!a){let r=new Blob([p],{type:"text/plain"}),u={filename:"info.txt"};u.blob=r,u.size=r.size,u.type="text/plain",u.file_ext="txt",u.typeheader="text",u.path=`servers/${i}/${s}/posts/${e.userInput.creator_id}/${e.userInput.id}/info.json`,yield e.nakama.sync_save_file(u,i,s,"server_post",e.userInput.id)}e.nakama.rearrange_posts(),n.dismiss(),e.navCtrl.navigateBack("portal/community")})()}ionViewWillLeave(){if(delete this.global.p5key.KeyShortCut.Escape,this.global.p5key.KeyShortCut.BottomTab=this.BottomTabShortcut,this.indexed.GetFileListFromDB("tmp_files/post").then(e=>e.forEach(a=>this.indexed.removeFileFromUserPath(a))),!this.isApplyPostData)try{this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id]&&delete this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id],this.nakama.load_local_post_with_id(this.userInput.id,this.userInput.server.isOfficial,this.userInput.server.target,this.userInput.creator_id),this.nakama.rearrange_posts()}catch{}}}return(c=g).\u0275fac=function(e){return new(e||c)(t.GI1(E.A1),t.GI1(N.o),t.GI1(j.wX),t.GI1(L.h),t.GI1(h.qS),t.GI1(Y.O),t.GI1(K.k),t.GI1(h.Kg),t.GI1(W.mI),t.GI1(H._),t.GI1(f.gV),t.GI1(f.E5))},c.\u0275cmp=t.In1({type:c,selectors:[["app-add-post"]],decls:30,vars:21,consts:[[3,"translucent"],[4,"ngIf"],["slot","start"],["defaultHref","portal/community"],[3,"fullscreen"],["id","p5Drop_addPost",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],["button","",3,"click"],[1,"additional_form","new_bg_form"],[1,"ion-text-end"],["style","width: 100%; text-align: center; text-align: -webkit-center; padding: 8px;",4,"ngIf"],["button",""],["id","add_post_title",3,"disabled","placeholder","ngModel","ngModelChange"],["id","add_post_content",1,"infobox",2,"height","50%",3,"disabled","placeholder","ngModel","ngModelChange"],["hidden","","type","file","id","add_post_input","accept","*","multiple","",3,"change"],["hidden","","type","file","id","PostMainImage_sel","accept","image/*",3,"change"],[2,"width","100%","text-align","center","padding-bottom","16px"],["style","display: inline-block;",4,"ngFor","ngForOf"],["button","",3,"id","disabled","click",4,"ngFor","ngForOf"],["button","",3,"disabled","click"],[1,"ion-text-center"],["value","colors","expand","inset",3,"disabled","value","click"],["accordionGroup",""],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],[2,"width","100%","text-align","center","text-align","-webkit-center","padding","8px"],[2,"pointer-events","none",3,"ngModel","ngModelChange"],[2,"width","400px","padding-top","8px"],["alt","MainPostImage",1,"thumbnail_image",3,"src"],[2,"display","inline-block"],[1,"ext_button","ext_button_override",3,"hidden","click"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"],["button","",3,"id","disabled","click"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"]],template:function(e,a){1&e&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar"),t.yuY(2,z,2,1,"ion-title",1)(3,J,2,1,"ion-title",1),t.I0R(4,"ion-buttons",2),t.wR5(5,"ion-back-button",3),t.C$Y()()(),t.I0R(6,"ion-content",4),t.wR5(7,"div",5),t.yuY(8,Q,11,5,"ion-accordion-group",6),t.I0R(9,"ion-item",7),t.qCj("click",function(){return a.go_to_profile()}),t.wR5(10,"div",8),t.I0R(11,"ion-label"),t.OEk(12),t.C$Y(),t.I0R(13,"ion-label",9),t.OEk(14),t.C$Y()(),t.I0R(15,"ion-item-divider")(16,"ion-label"),t.OEk(17),t.C$Y()(),t.yuY(18,X,6,5,"div",10),t.I0R(19,"ion-item",11)(20,"ion-input",12),t.iHE("ngModelChange",function(i){return t.kNx(a.userInput.title,i)||(a.userInput.title=i),i}),t.C$Y()(),t.I0R(21,"textarea",13),t.iHE("ngModelChange",function(i){return t.kNx(a.userInput.content,i)||(a.userInput.content=i),i}),t.C$Y(),t.I0R(22,"input",14),t.qCj("change",function(i){return a.inputFileSelected(i)}),t.C$Y(),t.I0R(23,"input",15),t.qCj("change",function(i){return a.ChangeMainPostImage(i)}),t.C$Y(),t.I0R(24,"div",16),t.yuY(25,ee,6,6,"div",17),t.C$Y(),t.yuY(26,te,5,4,"ion-item",18),t.I0R(27,"ion-item",19),t.qCj("click",function(){return a.postData()}),t.I0R(28,"ion-label",20),t.OEk(29),t.C$Y()()()),2&e&&(t.E7m("translucent",!0),t.yG2(2),t.E7m("ngIf",a.isModify),t.yG2(),t.E7m("ngIf",!a.isModify),t.yG2(3),t.E7m("fullscreen",!0),t.yG2(2),t.E7m("ngIf",a.servers.length),t.yG2(2),t.m_g("background-image: linear-gradient(to right, #0000, #"+a.userInput.UserColor+"44)"),t.yG2(2),t.cNF(a.lang.text.AddPost.Creator),t.yG2(2),t.cNF(a.userInput.creator_name||a.lang.text.Profile.noname_user),t.yG2(3),t.cNF(a.lang.text.AddPost.AddNewPost),t.yG2(),t.E7m("ngIf",a.MainPostImage),t.yG2(2),t.E7m("disabled",a.isSaveClicked)("placeholder",a.lang.text.AddPost.TitlePlaceholder),t.OKB("ngModel",a.userInput.title),t.yG2(),t.E7m("disabled",a.isSaveClicked)("placeholder",a.lang.text.AddPost.ContentPlaceHolder),t.OKB("ngModel",a.userInput.content),t.yG2(4),t.E7m("ngForOf",a.extended_buttons),t.yG2(),t.E7m("ngForOf",a.userInput.attachments),t.yG2(),t.E7m("disabled",a.isSaveClicked),t.yG2(2),t.cNF(a.lang.text.AddPost.Post))},dependencies:[x.ay,x.u_,b.ot,b.ue,b._G,h.cm,h.qU,h.GS,h._i,h.wB,h.Ko,h.A5,h.Yb,h.S8,h.QR,h.tM,h.E$,h.Md,h.UJ,h.qG,h.Im],styles:[".ext_button_override[_ngcontent-%COMP%]{margin:12px;cursor:pointer}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover;border-radius:16px}"]}),g})()}];let ie=(()=>{var c;class g{}return(c=g).\u0275fac=function(e){return new(e||c)},c.\u0275mod=t.a4G({type:c}),c.\u0275inj=t.s3X({imports:[f.qQ.forChild(ae),f.qQ]}),g})(),se=(()=>{var c;class g{}return(c=g).\u0275fac=function(e){return new(e||c)},c.\u0275mod=t.a4G({type:c}),c.\u0275inj=t.s3X({imports:[x.MD,b.y,h.wZ,ie]}),g})()}}]);