"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7759],{7759:(z,k,p)=>{p.r(k),p.d(k,{AddPostPageModule:()=>J});var P=p(177),y=p(4341),b=p(5374),x=p(9858),I=p(467),C=p(4237),A=p(5402),S=p(8326),R=p(92),e=p(3953),$=p(482),F=p(4234),O=p(3656),T=p(9900),w=p(755),j=p(345);function D(d,_){if(1&d&&(e.j41(0,"ion-title"),e.EFF(1),e.k0s()),2&d){const u=e.XpG();e.R7$(),e.JRh(u.lang.text.AddPost.EditTitle)}}function M(d,_){if(1&d&&(e.j41(0,"ion-title"),e.EFF(1),e.k0s()),2&d){const u=e.XpG();e.R7$(),e.JRh(u.lang.text.AddPost.Title)}}function L(d,_){if(1&d){const u=e.RV6();e.j41(0,"ion-item",7),e.bIt("click",function(){const i=e.eBV(u).index,s=e.XpG(2);return e.Njj(s.select_server(i,!0))}),e.j41(1,"ion-label"),e.EFF(2),e.k0s()()}if(2&d){const u=_.$implicit;e.R7$(2),e.JRh(u.name)}}function N(d,_){if(1&d){const u=e.RV6();e.j41(0,"ion-accordion-group",21,0),e.bIt("click",function(){e.eBV(u);const i=e.XpG();return e.Njj(i.isExpanded=!0)}),e.j41(2,"ion-accordion",22)(3,"ion-item",23)(4,"ion-label"),e.EFF(5),e.k0s(),e.j41(6,"ion-label",24),e.EFF(7),e.k0s(),e.nrm(8,"ion-icon",25),e.k0s(),e.j41(9,"div",26),e.DNE(10,L,3,1,"ion-item",27),e.k0s()()()}if(2&d){const u=e.XpG();e.Y8G("disabled",u.isSaveClicked)("value",u.isExpanded),e.R7$(5),e.JRh(u.lang.text.AddGroup.SelectServer),e.R7$(2),e.JRh(u.servers[u.index].name),e.R7$(3),e.Y8G("ngForOf",u.servers)}}function U(d,_){if(1&d){const u=e.RV6();e.j41(0,"div",28)(1,"ion-item",11)(2,"ion-toggle",29),e.mxI("ngModelChange",function(i){e.eBV(u);const s=e.XpG();return e.DH7(s.userInput.isNSFW,i)||(s.userInput.isNSFW=i),e.Njj(i)}),e.EFF(3),e.k0s()(),e.j41(4,"div",30),e.nrm(5,"img",31),e.k0s()()}if(2&d){const u=e.XpG();e.R7$(2),e.R50("ngModel",u.userInput.isNSFW),e.R7$(),e.JRh(u.lang.text.AddPost.NSFW),e.R7$(2),e.Aen(u.userInput.isNSFW?"filter: blur(16px);":""),e.Y8G("src",u.MainPostImage,e.B4B)}}function B(d,_){if(1&d&&e.nrm(0,"ion-icon",36),2&d){const u=e.XpG().$implicit;e.Y8G("name",u.icon||"close-circle")}}function E(d,_){if(1&d&&e.nrm(0,"img",37),2&d){const u=e.XpG().$implicit;e.Y8G("src","assets/icon/"+u.icon_img,e.B4B)("alt",u.title)}}function V(d,_){if(1&d){const u=e.RV6();e.j41(0,"div",32)(1,"div",33),e.bIt("click",function(){const i=e.eBV(u).$implicit;return e.Njj(i.act())}),e.DNE(2,B,1,1,"ion-icon",34)(3,E,1,2,"img",35),e.j41(4,"div"),e.EFF(5),e.k0s()()()}if(2&d){const u=_.$implicit;e.R7$(),e.Aen("cursor: "+(u.cursor||"pointer")+";"),e.Y8G("hidden",u.isHide),e.R7$(),e.Y8G("ngIf",u.icon),e.R7$(),e.Y8G("ngIf",u.icon_img),e.R7$(2),e.JRh(u.name)}}function G(d,_){if(1&d){const u=e.RV6();e.j41(0,"ion-item",38),e.bIt("click",function(){const i=e.eBV(u),s=i.$implicit,n=i.index,a=e.XpG();return e.Njj(a.open_viewer(s,n))})("contextmenu",function(){const i=e.eBV(u).index,s=e.XpG();return e.Njj(s.PostAttachContextMenu(i))}),e.j41(1,"ion-label"),e.EFF(2),e.k0s(),e.j41(3,"div",39),e.nrm(4,"img",40),e.k0s()()}if(2&d){const u=_.$implicit,t=_.index,i=e.XpG();e.Y8G("disabled",i.isSaveClicked),e.R7$(2),e.JRh("["+t+"] "+u.filename),e.R7$(2),e.Y8G("src",u.thumbnail,e.B4B)}}const X=[{path:"",component:(()=>{var d;class _{constructor(t,i,s,n,a,l,c,m,o,h){var f,r=this;this.global=t,this.lang=i,this.navCtrl=s,this.nakama=n,this.p5toast=a,this.indexed=l,this.loadingCtrl=c,this.sanitizer=m,this.route=o,this.router=h,this.servers=[],this.userInput={id:void 0,title:void 0,content:void 0,creator_id:void 0,creator_name:void 0,UserColor:void 0,create_time:void 0,modify_time:void 0,server:void 0,mainImage:void 0,attachments:[],OutSource:void 0,isNSFW:!1},this.index=0,this.isModify=!1,this.isExpanded=!1,this.isSaveClicked=!1,this.isServerChanged=!1,this.useVoiceRecording=!1,this.MainPostImage=null,this.extended_buttons=[{icon:"image-outline",name:this.lang.text.AddPost.MainPostImage,act:()=>{this.isSaveClicked||(this.MainPostImage?(URL.revokeObjectURL(this.MainPostImage),this.MainPostImage=null,this.userInput.mainImage=void 0,document.getElementById("PostMainImage_sel").value=""):document.getElementById("PostMainImage_sel").click())}},{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(f=(0,I.A)(function*(){r.isSaveClicked||r.new_attach({detail:{value:"load"}})}),function(){return f.apply(this,arguments)})},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:function(){var f=(0,I.A)(function*(){r.isSaveClicked||(r.global.PageDismissAct["add-post-new-image"]=function(){var g=(0,I.A)(function*(v){v.data&&(r.AddAttachTextForm(),yield r.voidDraw_fileAct_callback(v)),r.global.RestoreShortCutAct("add-post-new-image"),delete r.global.PageDismissAct["add-post-new-image"]});return function(v){return g.apply(this,arguments)}}(),r.global.StoreShortCutAct("add-post-new-image"),r.global.ActLikeModal("portal/community/add-post/void-draw",{dismiss:"add-post-new-image"}))});return function(){return f.apply(this,arguments)}}()},{icon:"reader-outline",name:this.lang.text.ChatRoom.newText,act:function(){var f=(0,I.A)(function*(){let g={info:{content:{is_new:void 0,type:"text/plain",viewer:"text",filename:void 0,path:void 0}},no_edit:void 0};g.info.content.is_new="text",g.info.content.filename=r.global.TextEditorNewFileName(),g.no_edit=!0,r.global.PageDismissAct["add-post-viewer"]=v=>{if(v.data){let H=r.global.TextEditorAfterAct(v.data,{display_name:r.nakama.users.self.display_name});r.AddAttachTextForm(),r.userInput.attachments.push(H)}r.global.RestoreShortCutAct("add-post-viewer"),delete r.global.PageDismissAct["add-post-viewer"]},r.global.StoreShortCutAct("add-post-viewer"),r.global.ActLikeModal("portal/community/add-post/ionic-viewer",g)});return function(){return f.apply(this,arguments)}}()},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:function(){var f=(0,I.A)(function*(){if(!r.isSaveClicked)try{let g=yield r.global.from_camera("tmp_files/post/",{user_id:"local"==r.isOfficial?void 0:r.nakama.servers[r.isOfficial][r.target].session.user_id,display_name:r.nakama.users.self.display_name});r.AddAttachTextForm(),r.userInput.attachments.push(g)}catch(g){console.log("\ucd2c\uc601 \uc2e4\ud328: ",g),r.p5toast.show({text:`${r.lang.text.GlobalAct.ErrorFromCamera}: ${g}`})}});return function(){return f.apply(this,arguments)}}()},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var f=(0,I.A)(function*(){r.isSaveClicked||(r.useVoiceRecording=!r.useVoiceRecording,r.useVoiceRecording?(yield A.R.hasAudioRecordingPermission()).value?(r.extended_buttons[5].icon="stop-circle-outline",r.p5toast.show({text:r.lang.text.ChatRoom.StartVRecord}),r.p5StartVoiceTimer(),yield A.R.startRecording(),r.CreateFloatingVoiceTimeHistoryAddButton()):(r.useVoiceRecording=!1,r.extended_buttons[5].icon="mic-circle-outline",yield A.R.requestAudioRecordingPermission()):yield r.StopAndSaveVoiceRecording())});return function(){return f.apply(this,arguments)}}()},{icon:"cloud-done-outline",name:this.lang.text.ChatRoom.Detour,act:()=>{this.toggle_custom_attach()}},{icon:"eye-off-outline",name:this.lang.text.AddPost.UseOutLink,act:()=>{this.toggle_open_link()}}],this.lock_modal_open=!1,this.useFirstCustomCDN=0,this.UseOutLink=!1,this.isApplyPostData=!1,this.WillLeavePage=!1}ngOnDestroy(){this.global.RestoreShortCutAct("add-post"),delete this.global.p5KeyShortCut.LeaveAddPost,this.route.queryParams.unsubscribe(),this.TitleInput.onpaste=null,this.ContentTextArea.onpaste=null,this.p5StartVoiceTimer=null,this.p5StopVoiceTimer=null,this.p5canvas&&this.p5canvas.remove(),delete this.nakama.StatusBarChangedCallback,this.useVoiceRecording&&this.StopAndSaveVoiceRecording();try{this.MainPostImage&&setTimeout(()=>{URL.revokeObjectURL(this.MainPostImage)},1e3)}catch{}}ngOnInit(){var t=this;this.cont=new AbortController,this.useFirstCustomCDN=Number(localStorage.getItem("useFFSCDN"))||0,this.toggle_custom_attach(this.useFirstCustomCDN),this.global.StoreShortCutAct("add-post"),this.route.queryParams.subscribe(function(){var i=(0,I.A)(function*(s){const n=t.router.getCurrentNavigation().extras.state;let a=!1;if(n&&(a=!!n.act,n.data&&(t.userInput=n.data)),t.lock_modal_open=!1,a){if(t.LoadListServer(),t.servers.length>1&&(t.index=1),n&&n.data){let l=`${t.userInput.server.isOfficial}/${t.userInput.server.target}`;for(let c=0,m=t.servers.length;c<m;c++)if(`${t.servers[c].isOfficial}/${t.servers[c].target}`==l){t.index=c;break}if(t.userInput.mainImage){let c=t.userInput.mainImage.url;c||(c=URL.createObjectURL(t.userInput.mainImage.blob)),t.MainPostImage=c}for(let c=0,m=t.userInput.attachments.length;c<m;c++)if("image"==t.userInput.attachments[c].viewer)if(t.userInput.attachments[c].url)t.userInput.attachments[c].thumbnail=t.userInput.attachments[c].url;else{let o=yield t.indexed.loadBlobFromUserPath(t.userInput.attachments[c].path,t.userInput.attachments[c].file_ext),h=URL.createObjectURL(o);t.userInput.attachments[c].thumbnail=h,setTimeout(()=>{URL.revokeObjectURL(h)},1e3)}t.UseOutLink=!!t.userInput.OutSource,t.toggle_open_link(t.UseOutLink)}t.select_server(t.index),n&&n.data&&(t.OriginalInfo=JSON.parse(JSON.stringify(t.userInput)))}});return function(s){return i.apply(this,arguments)}}()),setTimeout(()=>{this.WillLeavePage||this.CreateDrop()},100),this.nakama.StatusBarChangedCallback=()=>{this.LoadListServer(),this.index=0}}LoadListServer(){this.servers=this.nakama.get_all_server_info(!0,!0),this.servers.unshift({name:this.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0})}CreateDrop(){var t=this;let i=document.getElementById("p5Drop_addPost");this.p5canvas||(this.p5canvas=new S(s=>{let n=0;s.setup=()=>{let l=s.createCanvas(i.clientWidth,i.clientHeight);l.parent(i),s.pixelDensity(.1),l.drop(function(){var c=(0,I.A)(function*(m){yield t.selected_blobFile_callback_act(m.file)});return function(m){return c.apply(this,arguments)}}()),s.noLoop(),this.p5StartVoiceTimer=()=>{s.loop(),n=s.millis()},this.p5StopVoiceTimer=()=>{s.noLoop()}},s.draw=()=>{this.useVoiceRecording&&(this.extended_buttons[5].name=a(s.millis()-n))};let a=l=>{let c=l/1e3,m=s.floor(c)%60,o=c/60,h=s.floor(o)%60,r=s.floor(o/60);return r?`${r}:${s.nf(h,2)}:${s.nf(m,2)}`:`${h}:${s.nf(m,2)}`};s.mouseMoved=l=>{l.dataTransfer?(i.style.pointerEvents="all",i.style.backgroundColor="#0008"):(i.style.pointerEvents="none",i.style.backgroundColor="transparent")},s.keyPressed=function(){var l=(0,I.A)(function*(c){"Enter"===c.key&&("exact_post_title_id"==document.activeElement.id&&setTimeout(()=>{t.ContentTextArea.focus()},0),c.ctrlKey&&t.postData())});return function(c){return l.apply(this,arguments)}}()}))}ionViewWillEnter(){this.WillLeavePage=!1,this.TitleInput=document.getElementById("add_post_title").childNodes[1].childNodes[1].childNodes[1],this.TitleInput.id="exact_post_title_id",this.TitleInput.onpaste=t=>{let i=[];for(const s of t.clipboardData.files)i.push({file:s});if(i.length)return 1==i.length&&this.ChangeMainPostImage({target:{files:[i[0].file]}}),!1},this.ContentTextArea=document.getElementById("add_post_content"),setTimeout(()=>{this.userInput.title?this.ContentTextArea.focus():this.TitleInput.focus()},200),this.ContentTextArea.onpaste=t=>{let i=[];for(const s of t.clipboardData.files)i.push({file:s});if(i.length){if(1==i.length)this.selected_blobFile_callback_act(i[0].file);else for(let s=0,n=i.length;s<n;s++)this.selected_blobFile_callback_act(i[s].file);return!1}},this.isModify=!!this.userInput.id}ionViewDidEnter(){this.global.RestoreShortCutAct("LeaveAddPost"),this.AddShortcut()}go_to_profile(){this.nakama.open_profile_page({isOfficial:this.isOfficial,target:this.target})}select_server(t,i=!1){this.index=t,this.userInput.server=this.servers[t],this.isExpanded=!1,this.isOfficial=this.servers[t].isOfficial,this.target=this.servers[t].target,i?this.isServerChanged=this.OriginalServerInfo!=`${this.isOfficial}/${this.target}`:this.OriginalServerInfo=`${this.isOfficial}/${this.target}`,this.userInput.creator_name=this.nakama.users.self.display_name;try{this.userInput.creator_id=this.nakama.servers[this.isOfficial][this.target].session.user_id,this.userInput.UserColor=(this.userInput.creator_id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6),this.extended_buttons[7].isHide=2==this.useFirstCustomCDN}catch{this.userInput.creator_id="me",this.userInput.UserColor="888888",this.extended_buttons[7].isHide=1!=this.useFirstCustomCDN}this.TitleInput&&this.TitleInput.focus()}AddShortcut(){this.global.p5key&&this.global.p5KeyShortCut&&(this.global.p5KeyShortCut.Escape=()=>{this.navCtrl.navigateBack("portal/community")})}AddVoiceTimeHistory(){this.userInput.content?this.userInput.content+=`\n{"i":"n","t":"${this.extended_buttons[5].name}"}\n`:this.userInput.content=`{"i":"n","t":"${this.extended_buttons[5].name}"}\n`,this.ContentTextArea.focus()}CreateFloatingVoiceTimeHistoryAddButton(){this.p5floatingButton&&this.p5floatingButton.remove(),this.p5floatingButton=new S(t=>{t.setup=()=>{t.noCanvas();let i=t.createDiv('<ion-icon style="width: 36px; height: 36px" name="timer-outline"></ion-icon>');i.style("position: absolute; right: 0; bottom: 56px; z-index: 1"),i.style("width: 64px; height: 64px"),i.style("text-align: center; align-content: center"),i.style("cursor: pointer"),i.style("margin: 16px"),i.style("padding-top: 6px"),i.style("background-color: #8888"),i.style("border-radius: 24px"),i.elt.onclick=()=>{this.AddVoiceTimeHistory(),this.p5toast.show({text:`${this.lang.text.AddPost.RecordVoiceTime}: ${this.extended_buttons[5].name}`})}}})}StopAndSaveVoiceRecording(){var t=this;return(0,I.A)(function*(){t.p5floatingButton&&t.p5floatingButton.remove();let i=yield t.loadingCtrl.create({message:t.lang.text.AddPost.SavingRecord});i.present();try{let s=yield t.global.StopAndSaveVoiceRecording();yield t.selected_blobFile_callback_act(s)}catch{}i.dismiss(),t.extended_buttons[5].icon="mic-circle-outline",t.extended_buttons[5].name=t.lang.text.ChatRoom.Voice,t.checkVoiceLinker()})()}checkVoiceLinker(){this.p5StopVoiceTimer&&this.p5StopVoiceTimer();let t=this.userInput.content.split("\n");for(let i=0,s=t.length;i<s;i++)try{let n=JSON.parse(t[i]);"n"==n.i&&(n.i=this.userInput.attachments.length-1),t[i]=JSON.stringify(n)}catch{}this.userInput.content=t.join("\n")}ChangeMainPostImage(t){let i=t.target.files[0],s={};s.filename=i.name,s.file_ext=i.name.split(".").pop()||i.type||this.lang.text.ChatRoom.unknown_ext,s.size=i.size,s.type=i.type||i.type_override,s.blob=i,s.path=`tmp_files/post/MainImage.${s.file_ext}`,this.userInput.mainImage=s;let n=URL.createObjectURL(i);this.indexed.saveBlobToUserPath(i,s.path),this.MainPostImage=n}selected_blobFile_callback_act(t,i=[],s="loaded",n){var a=this;return(0,I.A)(function*(){let l=a.global.selected_blobFile_callback_act(t,"tmp_files/post/",{user_id:"local"==a.isOfficial?"local":a.nakama.servers[a.isOfficial][a.target].session.user_id,display_name:a.nakama.users.self.display_name},s,i);a.create_selected_thumbnail(l),void 0===n?(a.AddAttachTextForm(),a.userInput.attachments.push(l)):a.userInput.attachments[n]=l,a.indexed.saveBlobToUserPath(l.blob,l.path)})()}AddAttachTextForm(){this.userInput.content?this.userInput.content+=`\n[${this.userInput.attachments.length}]\n`:this.userInput.content=`[${this.userInput.attachments.length}]\n`,this.ContentTextArea.focus()}create_selected_thumbnail(t){var i=this;return(0,I.A)(function*(){if(i.global.set_viewer_category_from_ext(t),t.url){try{(yield fetch(t.url,{signal:i.cont.signal})).ok&&(t.thumbnail=t.url)}catch{}return void(t.typeheader=t.viewer)}try{t.thumbnail=yield i.indexed.loadBlobFromUserPath(t.path,t.type)}catch{}let s=URL.createObjectURL(t.blob);"image"===(t.typeheader=t.blob.type.split("/")[0]||t.viewer,setTimeout(()=>{URL.revokeObjectURL(s)},0),t.thumbnail=void 0,t.typeheader)&&(t.thumbnail=i.sanitizer.bypassSecurityTrustUrl(s))})()}voidDraw_fileAct_callback(t,i,s){var n=this;return(0,I.A)(function*(){let a=yield n.global.voidDraw_fileAct_callback(t,"tmp_files/post/",{user_id:"local"==n.isOfficial?"local":n.nakama.servers[n.isOfficial][n.target].session.user_id,display_name:n.nakama.users.self.display_name},i);a.thumbnail=n.sanitizer.bypassSecurityTrustUrl(t.data.img),void 0!==s?n.userInput.attachments[s]=a:n.userInput.attachments.push(a),t.data.loadingCtrl.dismiss()})()}new_attach(t){return(0,I.A)(function*(){"load"===t.detail.value&&document.getElementById("add_post_input").click()})()}PostAttachContextMenu(t){this.p5toast.show({text:`${this.lang.text.AddPost.RemoveAttach}: ${this.userInput.attachments[t].filename}`}),this.userInput.attachments.splice(t,1);let i=this.userInput.content.split("\n");for(let s=i.length-1;s>=0;s--){let n=!1,a=i[s].length-1,l=0;try{l=Number(i[s].substring(1,a)),n="["==i[s].charAt(0)&&"]"==i[s].charAt(a)&&!isNaN(l)}catch{}if(n)if(t==l){if(""==i[s+1])try{i.splice(s+1,1)}catch{}i.splice(s,1)}else t<l&&(i[s]=`[${l-1}]`)}return this.userInput.content=i.join("\n"),!1}inputFileSelected(t){var i=this;return(0,I.A)(function*(){if(t.target.files.length)if(1!=t.target.files.length){let n=yield i.loadingCtrl.create({message:i.lang.text.ChatRoom.MultipleSend});n.present();for(let a=0,l=t.target.files.length;a<l;a++)n.message=`${l-a}: ${t.target.files[a].name}`,yield i.selected_blobFile_callback_act(t.target.files[a]);n.dismiss(),setTimeout(()=>{document.getElementById("add_post_input").value=""},300)}else{let n=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});n.present(),yield i.selected_blobFile_callback_act(t.target.files[0]),n.dismiss(),document.getElementById("add_post_input").value=""}})()}open_viewer(t,i){var s=this;let n=[];for(let a=0,l=this.userInput.attachments.length;a<l;a++)n.push({content:this.userInput.attachments[a]});this.lock_modal_open||(this.lock_modal_open=!0,this.global.PageDismissAct["add-post-open-viewer"]=a=>{if(a.data)switch(a.data.type){case"image":let l=[];if(a.data.msg.content.content_related_creator&&(l=[...a.data.msg.content.content_related_creator]),a.data.msg.content.content_creator){let c=!1;for(let m=0,o=l.length;m<o;m++)if(l[m].user_id==a.data.msg.content.content_creator.user_id){c=!0;break}c||l.push(a.data.msg.content.content_creator)}return this.global.PageDismissAct["add-post-modify-image"]=function(){var c=(0,I.A)(function*(m){m.data&&(yield s.voidDraw_fileAct_callback(m,l,i)),s.global.RestoreShortCutAct("add-post-modify-image"),delete s.global.PageDismissAct["add-post-modify-image"]});return function(m){return c.apply(this,arguments)}}(),this.global.StoreShortCutAct("add-post-modify-image"),void this.global.ActLikeModal("portal/community/add-post/void-draw",{path:a.data.path||t.path,width:a.data.width,height:a.data.height,isDarkMode:a.data.isDarkMode,scrollHeight:a.data.scrollHeight,dismiss:"add-post-modify-image"});case"text":this.selected_blobFile_callback_act(a.data.blob,a.data.contentRelated,"textedit",i)}this.global.RestoreShortCutAct("add-post-open-viewer"),delete this.global.PageDismissAct["add-post-open-viewer"]},this.global.StoreShortCutAct("add-post-open-viewer"),this.global.ActLikeModal("portal/community/add-post/ionic-viewer",{info:{content:t},path:t.path,alt_path:t.path,isOfficial:this.isOfficial,target:this.target,relevance:n,dismiss:"add-post-open-viewer"}))}toggle_custom_attach(t){var i=this;return(0,I.A)(function*(){switch(i.useFirstCustomCDN=(null!=t?t:i.useFirstCustomCDN+1)%("me"==i.userInput.creator_id?2:3),"Android"==R.aH&&(i.useFirstCustomCDN=2,i.extended_buttons[6].isHide=!0),i.extended_buttons[7].isHide=!("me"!=i.userInput.creator_id&&2!=i.useFirstCustomCDN||1==i.useFirstCustomCDN||i.userInput.OutSource),i.useFirstCustomCDN){case 0:i.extended_buttons[6].icon="cloud-offline-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.Detour;break;case 1:i.extended_buttons[6].icon="cloud-done-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.useFSS;break;case 2:i.extended_buttons[6].icon="server-outline",i.extended_buttons[6].name=i.lang.text.ChatRoom.forceSQL}localStorage.setItem("useFFSCDN",`${i.useFirstCustomCDN}`)})()}toggle_open_link(t){var i=this;return(0,I.A)(function*(){i.UseOutLink=null!=t?t:!i.UseOutLink,i.extended_buttons[7].icon=i.UseOutLink?"eye-outline":"eye-off-outline"})()}postData(){var t=this;return(0,I.A)(function*(){if(!t.userInput.title)return t.p5toast.show({text:t.lang.text.AddPost.NeedPostTitle}),void t.TitleInput.focus();t.useVoiceRecording&&(yield t.StopAndSaveVoiceRecording());let i=!!t.userInput.server.local;t.isApplyPostData=!0;let s=yield t.loadingCtrl.create({message:t.lang.text.AddPost.WIP});s.present(),t.isSaveClicked=!0;let n=t.userInput.server.isOfficial,a=t.userInput.server.target;if(t.isModify||t.isServerChanged){if(t.userInput.mainImage&&t.userInput.mainImage.url&&!t.userInput.mainImage.blob){try{let l=yield fetch(t.userInput.mainImage.url,{signal:t.cont.signal});l.ok&&(t.userInput.mainImage.blob=yield l.blob())}catch{}t.userInput.mainImage.blob=yield(yield fetch(t.userInput.mainImage.url,{signal:t.cont.signal})).blob()}for(let l=0,c=t.userInput.attachments.length;l<c;l++)if(t.userInput.attachments[l].url&&!t.userInput.attachments[l].blob)try{let m=yield fetch(t.userInput.attachments[l].url,{signal:t.cont.signal});m.ok&&(t.userInput.attachments[l].blob=yield m.blob())}catch{}yield t.nakama.RemovePost(t.userInput)}try{if(!t.isModify||t.isServerChanged)if(t.isServerChanged&&t.OriginalInfo&&(yield t.nakama.RemovePost(t.OriginalInfo)),i){let o=Number(yield t.indexed.loadTextFromUserPath("servers/local/target/posts/me/counter.txt"))||0;t.userInput.id=`LocalPost_${o}`;try{yield t.indexed.saveTextFileToUserPath(`${o+1}`,"servers/local/target/posts/me/counter.txt")}catch(h){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${h}`}),console.log(h)}}else try{let o=yield t.nakama.servers[n][a].client.readStorageObjects(t.nakama.servers[n][a].session,{object_ids:[{collection:"server_post",key:"Counter",user_id:t.nakama.servers[n][a].session.user_id}]}),h=0;o.objects.length&&(h=o.objects[0].value.counter),t.userInput.id=`ServerPost_${h}`,yield t.nakama.servers[n][a].client.writeStorageObjects(t.nakama.servers[n][a].session,[{collection:"server_post",key:"Counter",permission_write:1,permission_read:2,value:{counter:h+1}}])}catch(o){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${o}`}),console.log(o)}t.isModify?t.userInput.modify_time=(new Date).getTime():(t.userInput.create_time=(new Date).getTime(),t.userInput.modify_time=t.userInput.create_time);for(let o=0,h=t.userInput.attachments.length;o<h;o++)delete t.userInput.attachments[o].thumbnail;if(t.userInput.mainImage)if(s.message=t.lang.text.AddPost.SyncMainImage,t.userInput.mainImage.path=`servers/${n}/${a}/posts/${t.userInput.creator_id}/${t.userInput.id}/MainImage.${t.userInput.mainImage.file_ext}`,t.userInput.mainImage.thumbnail=t.MainPostImage,i)try{if(1!=t.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let o;if(s.message=`${t.lang.text.AddPost.SyncMainImage}: ${t.userInput.mainImage.filename}`,o=yield t.global.try_upload_to_user_custom_fs(t.userInput.mainImage,t.nakama.users.self.display_name,s),!o)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete t.userInput.mainImage.path,delete t.userInput.mainImage.partsize,t.userInput.mainImage.url=o}catch{yield t.indexed.saveBlobToUserPath(t.userInput.mainImage.blob,t.userInput.mainImage.path)}else try{if(2==t.useFirstCustomCDN)throw"SQL \uac15\uc81c";let o=t.nakama.servers[t.isOfficial][t.target].info.address,h=t.nakama.servers[t.isOfficial][t.target].info.useSSL?"https:":"http:",r=yield t.global.upload_file_to_storage(t.userInput.mainImage,t.nakama.servers[t.isOfficial][t.target].session.user_id,h,o,1==t.useFirstCustomCDN,s);if(!r)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete t.userInput.mainImage.partsize,t.userInput.mainImage.url=r}catch{yield t.nakama.sync_save_file(t.userInput.mainImage,n,a,"server_post",`${t.userInput.id}_mainImage`)}let l=t.userInput.attachments.length;if(l){s.message=t.lang.text.AddPost.SyncAttaches;for(let o=l-1;o>=0;o--)if(!t.userInput.attachments[o].url)if(i)try{if(1!=t.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let h;if(s.message=`${t.lang.text.AddPost.SyncAttaches}: [${o}]${t.userInput.attachments[o].filename}`,h=yield t.global.try_upload_to_user_custom_fs(t.userInput.attachments[o],t.nakama.users.self.display_name,s),!h)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete t.userInput.attachments[o].path,delete t.userInput.attachments[o].partsize,t.userInput.attachments[o].url=h}catch{t.userInput.attachments[o].path=`servers/${n}/${a}/posts/${t.userInput.creator_id}/${t.userInput.id}/[${o}]${t.userInput.attachments[o].filename}`,yield t.indexed.saveBlobToUserPath(t.userInput.attachments[o].blob,t.userInput.attachments[o].path)}else try{if(2==t.useFirstCustomCDN)throw"SQL \uac15\uc81c";let h=t.nakama.servers[t.isOfficial][t.target].info.address,r=t.nakama.servers[t.isOfficial][t.target].info.useSSL?"https:":"http:",f=yield t.global.upload_file_to_storage(t.userInput.attachments[o],t.nakama.servers[t.isOfficial][t.target].session.user_id,r,h,1==t.useFirstCustomCDN,s);if(!f)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete t.userInput.attachments[o].partsize,t.userInput.attachments[o].url=f}catch(h){"SQL \uac15\uc81c"==h&&t.userInput.attachments[o].url&&!t.userInput.attachments[o].blob&&(t.userInput.attachments[o].blob=yield(yield fetch(t.userInput.attachments[o].url,{signal:t.cont.signal})).blob()),yield t.nakama.sync_save_file(t.userInput.attachments[o],n,a,"server_post",`${t.userInput.id}_attach_${o}`)}}if(t.userInput.OutSource&&(t.global.remove_file_from_storage(t.userInput.OutSource),t.userInput.OutSource=void 0),t.UseOutLink){let o=new Blob([JSON.stringify(t.userInput)],{type:"text/plain"}),h={blob:o,filename:`${t.userInput.id}.json`,file_ext:"json",size:o.size};try{let r=t.nakama.servers[t.isOfficial][t.target].info.address,f=t.nakama.servers[t.isOfficial][t.target].session.user_id,g=t.nakama.servers[t.isOfficial][t.target].info.useSSL?"https:":"http:";s.message=`${t.lang.text.AddPost.SyncPostInfo}`;let v=yield t.global.upload_file_to_storage(h,f,g,r,1==t.useFirstCustomCDN);if(!v)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";t.userInput.OutSource=v}catch{try{let f=t.nakama.users.self.display_name;s.message=`${t.lang.text.AddPost.SyncPostInfo}`;let g=yield t.global.try_upload_to_user_custom_fs(h,f);if(!g)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";t.userInput.OutSource=g}catch(f){t.userInput.OutSource=void 0,t.UseOutLink=!1,t.p5toast.show({text:`${t.lang.text.AddPost.OutLinkFailed}: ${f}`})}}}let c=JSON.parse(JSON.stringify(t.userInput));c.mainImage&&delete c.mainImage.blob;for(let o=c.attachments.length-1;o>=0;o--)delete c.attachments[o].blob;delete c.server;try{t.nakama.posts_orig[n][a]||(t.nakama.posts_orig[n][a]={}),t.nakama.posts_orig[n][a][t.userInput.creator_id]||(t.nakama.posts_orig[n][a][t.userInput.creator_id]={}),t.nakama.posts_orig[n][a][t.userInput.creator_id][t.userInput.id]=t.userInput}catch(o){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${o}`}),console.log(o)}let m=JSON.stringify(c);if(yield t.indexed.saveTextFileToUserPath(m,`servers/${n}/${a}/posts/${t.userInput.creator_id}/${t.userInput.id}/info.json`),!i){let o=new Blob([m],{type:"application/json"}),h={filename:"info.json"};h.blob=o,h.size=o.size,h.type="application/json",h.file_ext="txt",h.typeheader="text",h.path=`servers/${n}/${a}/posts/${t.userInput.creator_id}/${t.userInput.id}/info.json`,yield t.nakama.sync_save_file(h,n,a,"server_post",t.userInput.id)}t.nakama.rearrange_posts()}catch(l){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${l}`}),console.warn("\uac8c\uc2dc\ubb3c \uc800\uc7a5 \ucc98\ub9ac \uc624\ub958: ",l)}try{yield t.nakama.servers[t.isOfficial][t.target].client.rpc(t.nakama.servers[t.isOfficial][t.target].session,"send_noti_all_fn",{noti_id:C.I.MANAGE_POST,type:"add",user_id:t.userInput.creator_id,post_id:t.userInput.id,persistent:!1})}catch{}s.dismiss(),t.navCtrl.navigateBack("portal/community")})()}ionViewWillLeave(){if(this.WillLeavePage=!0,this.cont.abort(),this.global.StoreShortCutAct("LeaveAddPost"),delete this.global.p5KeyShortCut.Escape,!this.isApplyPostData)try{this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id]&&delete this.nakama.posts_orig[this.isOfficial][this.target][this.userInput.creator_id][this.userInput.id],this.nakama.load_local_post_with_id(this.userInput.id,this.userInput.server.isOfficial,this.userInput.server.target,this.userInput.creator_id),this.nakama.rearrange_posts()}catch{}}}return(d=_).\u0275fac=function(t){return new(t||d)(e.rXU($.z3),e.rXU(F.y),e.rXU(O.q9),e.rXU(C.X),e.rXU(T.G),e.rXU(w.n),e.rXU(b.Xi),e.rXU(j.up),e.rXU(x.nX),e.rXU(x.Ix))},d.\u0275cmp=e.VBU({type:d,selectors:[["app-add-post"]],decls:30,vars:19,consts:[["accordionGroup",""],[1,"ion-no-border"],[4,"ngIf"],["slot","start"],["defaultHref","portal/community"],["id","p5Drop_addPost",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],["button","",3,"click"],[1,"additional_form","new_bg_form"],[1,"ion-text-end"],["style","width: 100%; text-align: center; text-align: -webkit-center; padding: 8px;",4,"ngIf"],["button",""],["id","add_post_title",3,"ngModelChange","disabled","placeholder","ngModel"],["id","add_post_content",1,"infobox",2,"height","50%",3,"ngModelChange","disabled","placeholder","ngModel"],["hidden","","type","file","id","add_post_input","accept","*","multiple","",3,"change"],["hidden","","type","file","id","PostMainImage_sel","accept","image/*",3,"change"],[2,"width","100%","text-align","center","padding-bottom","16px"],["style","display: inline-block;",4,"ngFor","ngForOf"],["button","",3,"disabled","click","contextmenu",4,"ngFor","ngForOf"],["button","",3,"click","disabled"],[1,"ion-text-center"],["value","colors","expand","inset",3,"click","disabled","value"],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],[2,"width","100%","text-align","center","text-align","-webkit-center","padding","8px"],[2,"pointer-events","none",3,"ngModelChange","ngModel"],[1,"thumbnail_image",2,"width","400px","padding-top","8px"],["alt","MainPostImage",3,"src"],[2,"display","inline-block"],[1,"ext_button","ext_button_override",3,"click","hidden"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"],["button","",3,"click","contextmenu","disabled"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"]],template:function(t,i){1&t&&(e.j41(0,"ion-header",1)(1,"ion-toolbar"),e.DNE(2,D,2,1,"ion-title",2)(3,M,2,1,"ion-title",2),e.j41(4,"ion-buttons",3),e.nrm(5,"ion-back-button",4),e.k0s()()(),e.j41(6,"ion-content"),e.nrm(7,"div",5),e.DNE(8,N,11,5,"ion-accordion-group",6),e.j41(9,"ion-item",7),e.bIt("click",function(){return i.go_to_profile()}),e.nrm(10,"div",8),e.j41(11,"ion-label"),e.EFF(12),e.k0s(),e.j41(13,"ion-label",9),e.EFF(14),e.k0s()(),e.j41(15,"ion-item-divider")(16,"ion-label"),e.EFF(17),e.k0s()(),e.DNE(18,U,6,5,"div",10),e.j41(19,"ion-item",11)(20,"ion-input",12),e.mxI("ngModelChange",function(n){return e.DH7(i.userInput.title,n)||(i.userInput.title=n),n}),e.k0s()(),e.j41(21,"textarea",13),e.mxI("ngModelChange",function(n){return e.DH7(i.userInput.content,n)||(i.userInput.content=n),n}),e.k0s(),e.j41(22,"input",14),e.bIt("change",function(n){return i.inputFileSelected(n)}),e.k0s(),e.j41(23,"input",15),e.bIt("change",function(n){return i.ChangeMainPostImage(n)}),e.k0s(),e.j41(24,"div",16),e.DNE(25,V,6,6,"div",17),e.k0s(),e.DNE(26,G,5,3,"ion-item",18),e.j41(27,"ion-item",19),e.bIt("click",function(){return i.postData()}),e.j41(28,"ion-label",20),e.EFF(29),e.k0s()()()),2&t&&(e.R7$(2),e.Y8G("ngIf",i.isModify),e.R7$(),e.Y8G("ngIf",!i.isModify),e.R7$(5),e.Y8G("ngIf",i.servers.length),e.R7$(2),e.Aen("background-image: linear-gradient(to right, #0000, #"+i.userInput.UserColor+"44)"),e.R7$(2),e.JRh(i.lang.text.AddPost.Creator),e.R7$(2),e.JRh(i.userInput.creator_name||i.lang.text.Profile.noname_user),e.R7$(3),e.JRh(i.lang.text.AddPost.AddNewPost),e.R7$(),e.Y8G("ngIf",i.MainPostImage),e.R7$(2),e.Y8G("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.TitlePlaceholder),e.R50("ngModel",i.userInput.title),e.R7$(),e.Y8G("disabled",i.isSaveClicked)("placeholder",i.lang.text.AddPost.ContentPlaceHolder),e.R50("ngModel",i.userInput.content),e.R7$(4),e.Y8G("ngForOf",i.extended_buttons),e.R7$(),e.Y8G("ngForOf",i.userInput.attachments),e.R7$(),e.Y8G("disabled",i.isSaveClicked),e.R7$(2),e.JRh(i.lang.text.AddPost.Post))},dependencies:[P.Sq,P.bT,y.me,y.BC,y.vS,b.xk,b.YH,b.QW,b.W9,b.eU,b.iq,b.$w,b.uz,b.Dg,b.he,b.BC,b.BY,b.ai,b.hB,b.Gw,b.el],styles:[".ext_button_override[_ngcontent-%COMP%]{margin:12px;cursor:pointer}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover;border-radius:16px;overflow:hidden}"]}),_})()},{path:"void-draw",loadChildren:()=>p.e(2655).then(p.bind(p,2655)).then(d=>d.VoidDrawPageModule)},{path:"ionic-viewer",loadChildren:()=>p.e(5390).then(p.bind(p,5390)).then(d=>d.IonicViewerPageModule)}];let Y=(()=>{var d;class _{}return(d=_).\u0275fac=function(t){return new(t||d)},d.\u0275mod=e.$C({type:d}),d.\u0275inj=e.G2t({imports:[x.iI.forChild(X),x.iI]}),_})(),J=(()=>{var d;class _{}return(d=_).\u0275fac=function(t){return new(t||d)},d.\u0275mod=e.$C({type:d}),d.\u0275inj=e.G2t({imports:[P.MD,y.YN,b.bv,Y]}),_})()}}]);