"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7602],{5087:(W,O,h)=>{h.d(O,{r:()=>M});var P=h(655),y=h(5016),s=h(9863),m=h(3996),n=h(1282),g=h(3496),A=h(5742),U=h(4433),k=h(3336);let M=(()=>{class E{constructor(u,c,x,v,w,t,e,i,o){this.modalCtrl=u,this.navParams=c,this.global=x,this.indexed=v,this.lang=w,this.file=t,this.alertCtrl=e,this.loadingCtrl=i,this.p5toast=o,this.EventListenerAct=l=>{l.detail.register(120,p=>{})}}ngOnInit(){this.FileInfo=this.navParams.get("info")}ionViewDidEnter(){return(0,P.mG)(this,void 0,void 0,function*(){document.addEventListener("ionBackButton",this.EventListenerAct),yield this.global.CreateGodotIFrame("viewer",{local_url:"assets/data/godot/viewer.pck",title:"ViewerEx",path:this.navParams.get("path"),ext:this.FileInfo.file_ext,force_logo:!0,receive_image:(u,c,x)=>{this.modalCtrl.dismiss({base64:","+u,width:c,height:x})}},"create_thumbnail")})}snapshot_modify(){this.global.godot_window.modify_image()}download_file(){"DesktopPWA"==y.n$||"MobilePWA"==y.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:u=>(0,P.mG)(this,void 0,void 0,function*(){let c=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});c.present();let x=u.filename?`${u.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,v=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,x,v).then(w=>{c.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(w=>{12===(c.dismiss(),w.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",w)})})}]}).then(u=>u.present())}ionViewWillLeave(){document.removeEventListener("ionBackButton",this.EventListenerAct),this.global.godot_window.filename=this.FileInfo.filename,this.global.godot_window.create_thumbnail(this.FileInfo)}}return E.\u0275fac=function(u){return new(u||E)(s.Y36(m.IN),s.Y36(m.X1),s.Y36(n.A),s.Y36(g.H),s.Y36(A.b),s.Y36(U.$),s.Y36(m.Br),s.Y36(m.HT),s.Y36(k.F))},E.\u0275cmp=s.Xpm({type:E,selectors:[["app-godot-viewer"]],decls:20,vars:4,consts:[["slot","start",3,"click"],["defaultHref",""],[1,"main_table",2,"width","100%","height","100%","margin","0"],[2,"height","0"],["text-wrap",""],[3,"click"],["id","viewer",1,"full_screen",2,"display","flex"]],template:function(u,c){1&u&&(s.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),s._uU(3),s.qZA(),s.TgZ(4,"ion-buttons",0),s.NdJ("click",function(){return c.modalCtrl.dismiss()}),s._UZ(5,"ion-back-button",1),s.qZA()()(),s.TgZ(6,"ion-content")(7,"table",2)(8,"tr",3)(9,"td")(10,"ion-list-header")(11,"ion-label",4),s._uU(12),s.qZA(),s.TgZ(13,"ion-button",5),s.NdJ("click",function(){return c.snapshot_modify()}),s._uU(14),s.qZA(),s.TgZ(15,"ion-button",5),s.NdJ("click",function(){return c.download_file()}),s._uU(16),s.qZA()()()(),s.TgZ(17,"tr")(18,"td"),s._UZ(19,"div",6),s.qZA()()()()),2&u&&(s.xp6(3),s.Oqu(c.lang.text.ContentViewer.Title),s.xp6(9),s.Oqu(c.FileInfo.filename),s.xp6(2),s.hij("",c.lang.text.ContentViewer.Edit," "),s.xp6(2),s.hij("",c.lang.text.ContentViewer.Download," "))},directives:[m.Gu,m.sr,m.wd,m.Sm,m.oU,m.cs,m.W2,m.yh,m.Q$,m.YG],styles:[""]}),E})()},774:(W,O,h)=>{h.d(O,{B:()=>x});var P=h(655),y=h(5016),s=h(6505),n=h(9863),g=h(3996),A=h(3496),U=h(5742),k=h(4433),M=h(3336),E=h(6690),F=h(1282),u=h(9808);function c(v,w){if(1&v){const t=n.EpF();n.TgZ(0,"ion-button",9),n.NdJ("click",function(){return n.CHM(t),n.oxw().modify_image()}),n._uU(1),n.qZA()}if(2&v){const t=n.oxw();n.xp6(1),n.hij(" ",t.lang.text.ContentViewer.Edit," ")}}let x=(()=>{class v{constructor(t,e,i,o,l,p,_,d,C,I){this.modalCtrl=t,this.navParams=e,this.indexed=i,this.lang=o,this.file=l,this.p5toast=p,this.alertCtrl=_,this.loadingCtrl=d,this.fileOpener=C,this.global=I,this.image_info={}}ngOnInit(){return(0,P.mG)(this,void 0,void 0,function*(){this.FileInfo=this.navParams.get("info"),this.ContentBox=document.getElementById("ContentBox"),this.FileHeader=document.getElementById("FileHeader"),this.HasNoEditButton=this.navParams.get("no_edit")||!1,this.blob=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type),this.FileURL=URL.createObjectURL(this.blob)})}ionViewDidEnter(){return(0,P.mG)(this,void 0,void 0,function*(){let t=document.getElementById("p5canvas");switch(this.FileInfo.viewer){case"image":this.p5canvas=new s(e=>{let i;e.setup=()=>(0,P.mG)(this,void 0,void 0,function*(){t.style.maxWidth="100%",t.style.overflow="hidden",this.ContentBox.style.overflow="hidden",e.noCanvas();let a=document.createElement("img");a.hidden=!0,a.src=this.FileURL,a.onload=()=>{t.style.backgroundImage=`url(${this.FileURL})`,t.style.backgroundRepeat="no-repeat",t.style.pointerEvents="none",this.image_info.width=a.naturalWidth,this.image_info.height=a.naturalHeight,l=e.createVector(a.naturalWidth,a.naturalHeight),o(),a.remove()},("Android"==y.n$||"iOS"==y.n$)&&(i=document.createElement("iframe"),i.setAttribute("src",this.FileURL),i.setAttribute("frameborder","0"),i.setAttribute("class","full_screen"),i.setAttribute("style","position: relative; pointer-events: all"),i.hidden=!0,t.appendChild(i)),e.noLoop()});let o=()=>{t.style.backgroundSize=`${t.clientWidth}px`,t.style.backgroundPositionX="0px",t.style.backgroundPositionY=t.clientHeight/2-l.y*(t.clientWidth/l.x)/2+"px"};e.windowResized=()=>{setTimeout(()=>{o()},50)};let l,p=e.createVector(),_=e.createVector(),d=e.createVector(),C=1,I=()=>{t.style.backgroundPositionX=`${p.x+d.x}px`,t.style.backgroundPositionY=`${p.y+d.y}px`},B=(a,D)=>{let r=C,b=C*D,T=Number(t.style.backgroundPositionX.split("px")[0]),R=Number(t.style.backgroundPositionY.split("px")[0]),Y=(r-b)*e.map(a.x,T,T+r,0,1),$=(r-b)/l.x*l.y*e.map(a.y,R,R+r/l.x*l.y,0,1);t.style.backgroundPositionX=`${T+Y}px`,t.style.backgroundPositionY=`${R+$}px`,t.style.backgroundSize=`${b}px`};e.mousePressed=()=>{e.mouseButton==e.CENTER&&o(),"DesktopPWA"==y.n$&&(p=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),_=e.createVector(e.mouseX,e.mouseY))},e.mouseWheel=a=>{C=Number(t.style.backgroundSize.split("px")[0]),B(e.createVector(t.clientWidth/2,t.clientHeight/2),1-a.delta/1e3)},e.mouseDragged=()=>{"DesktopPWA"==y.n$&&(d=e.createVector(e.mouseX,e.mouseY),d.sub(_),I())};let L,f={},V=!1;e.touchStarted=a=>{for(let r=0,b=a.changedTouches.length;r<b;r++)f[a.changedTouches[r].identifier]=e.createVector(a.changedTouches[r].clientX,a.changedTouches[r].clientY);switch(Object.keys(f).length){case 1:p=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),_=f[a.changedTouches[0].identifier].copy();break;case 2:p=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0]));let r=f[0].copy();L=r.dist(f[1]),_=r.add(f[1]).div(2).copy(),C=Number(t.style.backgroundSize.split("px")[0]),I();break;default:V=!0,o()}},e.touchMoved=a=>{if(!V){for(let r=0,b=a.changedTouches.length;r<b;r++)f[a.changedTouches[r].identifier]=e.createVector(a.changedTouches[r].clientX,a.changedTouches[r].clientY);switch(Object.keys(f).length){case 1:d=f[a.changedTouches[0].identifier].copy(),d.sub(_),I();break;case 2:let r=f[0].copy(),b=r.dist(f[1]);d=r.add(f[1]).div(2).copy();let T=d.copy();d.sub(_),I(),B(T,b/L)}}},e.touchEnded=a=>{if("changedTouches"in a){for(let r=0,b=a.changedTouches.length;r<b;r++)delete f[a.changedTouches[r].identifier];switch(Object.keys(f).length){case 1:p=e.createVector(Number(t.style.backgroundPositionX.split("px")[0]),Number(t.style.backgroundPositionY.split("px")[0])),_=f[Object.keys(f)[0]].copy();break;case 0:V=!1}}}});break;case"audio":this.p5canvas=new s(e=>{var i;e.setup=()=>{e.noCanvas(),e.noLoop(),i=e.createAudio([this.FileURL],()=>{t.appendChild(i.elt),i.elt.hidden=!0,setTimeout(()=>{o(),i.elt.hidden=!1},50),i.showControls(),i.play()})};let o=()=>{let l=this.ContentBox.offsetWidth;i.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),i.size(l,25)};e.windowResized=()=>{setTimeout(()=>{o()},50)}});break;case"video":this.p5canvas=new s(e=>{var i;e.setup=()=>{e.noCanvas(),e.noLoop(),i=e.createVideo([this.FileURL],()=>{t.appendChild(i.elt),i.elt.hidden=!0,setTimeout(()=>{o(),i.elt.hidden=!1},50),i.showControls(),i.play()}),e.VideoMedia=i};let o=()=>{let l=this.ContentBox.offsetWidth,p=this.ContentBox.offsetHeight-this.FileHeader.offsetHeight,_=i.width,d=i.height;i.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),_<d?(d=p,_=_/i.height*d):(_=l,d=d/i.width*_||p/2),i.size(_,d)};e.windowResized=()=>{setTimeout(()=>{o()},50)}});break;case"text":this.p5canvas=new s(e=>{e.setup=()=>{e.noCanvas(),e.noLoop(),e.loadStrings(this.FileURL,i=>{let o=document.createElement("textarea");o.disabled=!0,o.className="infobox",o.setAttribute("style","height: 100%; display: block;"),o.textContent=i.join("\n"),t.appendChild(o)},i=>{console.error("\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c: ",i),t.textContent="\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c\uc785\ub2c8\ub2e4.",this.FileInfo.else=!0})}});break;case"disabled":try{yield this.file.writeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`,this.blob),this.fileOpener.open(this.file.externalDataDirectory+`viewer_tmp.${this.FileInfo.file_ext}`,this.FileInfo.type||`application/${this.FileInfo.file_ext}`)}catch(e){console.log("open file failed: ",e),this.p5toast.show({text:`${this.lang.text.ChatRoom.cannot_open_file}: ${e.message}`})}}})}modify_image(){this.modalCtrl.dismiss(this.image_info)}download_file(){"DesktopPWA"==y.n$||"MobilePWA"==y.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:t=>(0,P.mG)(this,void 0,void 0,function*(){let e=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});e.present();let i=t.filename?`${t.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,o=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,i,o).then(l=>{e.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(l=>{12===(e.dismiss(),l.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",l)})})}]}).then(t=>t.present())}ionViewWillLeave(){return(0,P.mG)(this,void 0,void 0,function*(){if("video"==this.FileInfo.viewer)try{let i,o,e=this.p5canvas.VideoMedia.size();e.width>e.height?(i=192,o=e.height/e.width*192):(i=e.width/e.height*192,o=192),this.p5canvas.createCanvas(i,o),this.p5canvas.image(this.p5canvas.VideoMedia,0,0,i,o),this.p5canvas.fill(255,128),this.p5canvas.rect(0,0,i,o),this.p5canvas.textWrap(this.p5canvas.CHAR),this.p5canvas.textSize(16);let l=o/16;this.p5canvas.push(),this.p5canvas.translate(l/6,l/6),this.p5canvas.fill(0),this.p5canvas.text(this.FileInfo.filename,l,l,i-2*l,o-2*l),this.p5canvas.filter(this.p5canvas.BLUR,3),this.p5canvas.pop(),this.p5canvas.fill(255),this.p5canvas.text(this.FileInfo.filename,l,l,i-2*l,o-2*l),this.p5canvas.saveFrames("","png",1,1,p=>(0,P.mG)(this,void 0,void 0,function*(){try{yield this.indexed.saveBase64ToUserPath(p[0].imageData.replace(/"|=|\\/g,""),`${this.FileInfo.path}_thumbnail.png`),this.global.modulate_thumbnail(this.FileInfo,"")}catch(_){}}))}catch(e){console.log("\uc791\uc5c5\uc911 \uc624\ub958\ubcf4\uae30: ",e)}this.p5canvas&&this.p5canvas.remove(),this.FileURL&&URL.revokeObjectURL(this.FileURL),this.file.checkFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`)&&this.file.removeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`)})}}return v.\u0275fac=function(t){return new(t||v)(n.Y36(g.IN),n.Y36(g.X1),n.Y36(A.H),n.Y36(U.b),n.Y36(k.$),n.Y36(M.F),n.Y36(g.Br),n.Y36(g.HT),n.Y36(E.u),n.Y36(F.A))},v.\u0275cmp=n.Xpm({type:v,selectors:[["app-ionic-viewer"]],decls:19,vars:4,consts:[["id","Toolbar"],["slot","start",3,"click"],["defaultHref",""],["id","ContentBox"],[1,"main_table_elt"],[2,"height","0"],["id","FileHeader"],["text-wrap",""],[3,"click",4,"ngIf"],[3,"click"],["id","p5canvas",1,"full_screen",2,"overflow-y","scroll"]],template:function(t,e){1&t&&(n.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),n._uU(3),n.qZA(),n.TgZ(4,"ion-buttons",1),n.NdJ("click",function(){return e.modalCtrl.dismiss()}),n._UZ(5,"ion-back-button",2),n.qZA()()(),n.TgZ(6,"ion-content",3)(7,"table",4)(8,"tr",5)(9,"td")(10,"ion-list-header",6)(11,"ion-label",7),n._uU(12),n.qZA(),n.YNc(13,c,2,1,"ion-button",8),n.TgZ(14,"ion-button",9),n.NdJ("click",function(){return e.download_file()}),n._uU(15),n.qZA()()()(),n.TgZ(16,"tr")(17,"td"),n._UZ(18,"div",10),n.qZA()()()()),2&t&&(n.xp6(3),n.Oqu(e.lang.text.ContentViewer.Title),n.xp6(9),n.Oqu(e.FileInfo.filename),n.xp6(1),n.Q6J("ngIf","image"==e.FileInfo.viewer&&!e.HasNoEditButton),n.xp6(2),n.hij(" ",e.lang.text.ContentViewer.Download," "))},directives:[g.Gu,g.sr,g.wd,g.Sm,g.oU,g.cs,g.W2,g.yh,g.Q$,u.O5,g.YG],styles:[".main_table_elt[_ngcontent-%COMP%]{width:100%;height:100%;border:0;margin:0}"]}),v})()}}]);