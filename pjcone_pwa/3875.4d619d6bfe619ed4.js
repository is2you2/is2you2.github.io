"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3875],{3875:(z,A,c)=>{c.r(A),c.d(A,{ChatRoomPageModule:()=>Yt});var O=c(9808),i=c(4182),C=c(3996),x=c(9705),u=c(655),V=c(6505),J=c(9123),M=c(5016),S=c(774),$=c(9805),Q=c(428),L=c(4896),F=c(2879),N=c(905),H=c(3260),t=c(9863),q=c(9912),D=c(8677),Y=c(4606),E=c(3496),B=c(5742),j=c(2313),G=c(1282),d=c(5129),v=c(8217),r=c(3336),_=c(4299);function g(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"ion-icon",27),t.NdJ("click",function(){return t.CHM(e),t.oxw().toggle_thumbnail()}),t.qZA()}}function b(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"ion-icon",28),t.NdJ("click",function(){return t.CHM(e),t.oxw().toggle_thumbnail()}),t.qZA()}}function I(n,h){if(1&n&&(t.TgZ(0,"div",37)(1,"font",38),t._uU(2),t.qZA()()),2&n){const e=t.oxw().$implicit;t.xp6(2),t.hij(" ",e.msgDate," ")}}function U(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",39)(1,"span",40),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().user_detail(a)}),t.TgZ(2,"b")(3,"font",41),t._uU(4),t.qZA()()(),t.TgZ(5,"span",42),t._uU(6),t.qZA()()}if(2&n){const e=t.oxw().$implicit,s=t.oxw();t.xp6(3),t.MGl("color","#",e.is_me&&s.nakama.users.self.online||!e.is_me&&s.nakama.users[s.isOfficial][s.target][e.sender_id].online?e.color:"888",""),t.xp6(1),t.hij(" ",e.user_display_name,""),t.xp6(2),t.Oqu(e.msgTime)}}function K(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",43),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().quickShare_act(a)}),t._uU(1),t.qZA()}if(2&n){const e=t.oxw(2);t.xp6(1),t.hij(" ",e.lang.text.ChatRoom.QuickShare," ")}}function X(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",43),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().JoinWebRTCMatch(a)}),t._uU(1),t.qZA()}if(2&n){const e=t.oxw(2);t.xp6(1),t.hij(" ",e.lang.text.ChatRoom.JoinWebRTCMatch," ")}}function tt(n,h){1&n&&t._UZ(0,"div",52)}function et(n,h){if(1&n&&(t.TgZ(0,"span",53),t._uU(1),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.hij(" ",e," ")}}function it(n,h){if(1&n&&(t.TgZ(0,"div",48)(1,"p",49),t._uU(2),t.qZA(),t.YNc(3,tt,1,0,"div",50),t.YNc(4,et,2,1,"span",51),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(2),t.hij(" ",e.content.filename," "),t.xp6(1),t.Q6J("ngIf",e.content.text),t.xp6(1),t.Q6J("ngForOf",e.content.text)}}function st(n,h){if(1&n&&(t.TgZ(0,"div",54),t._UZ(1,"img",55),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(1),t.Q6J("src",e.content.thumbnail,t.LSH)("alt",e.content.filename)}}function nt(n,h){if(1&n&&(t.TgZ(0,"div",56),t._uU(1),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(1),t.hij(" ",e.content.transfer_index.index,"")}}function at(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",44),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().file_detail(a)}),t.YNc(1,it,5,3,"div",45),t.YNc(2,st,2,2,"div",46),t.YNc(3,nt,2,1,"div",47),t.qZA()}if(2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngIf",!e.content.thumbnail),t.xp6(1),t.Q6J("ngIf",e.content.thumbnail),t.xp6(1),t.Q6J("ngIf",e.content.transfer_index)}}function ot(n,h){if(1&n&&(t.TgZ(0,"div",57)(1,"div",58),t._uU(2),t.qZA()()),2&n){const e=t.oxw().$implicit;t.xp6(2),t.hij(" ",e.content.noti," ")}}function lt(n,h){if(1&n&&(t.TgZ(0,"span"),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Akn("font-size: "+(e.size||16)+"px"),t.xp6(1),t.hij(" ",e.text," ")}}function ht(n,h){if(1&n&&(t.TgZ(0,"a",63),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Q6J("href",e.text,t.LSH),t.xp6(1),t.Oqu(e.text)}}function rt(n,h){if(1&n&&(t.TgZ(0,"span"),t.YNc(1,lt,2,3,"span",61),t.YNc(2,ht,2,2,"a",62),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngIf",!e.href),t.xp6(1),t.Q6J("ngIf",e.href)}}function ct(n,h){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,rt,3,2,"span",60),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngForOf",e)}}function _t(n,h){if(1&n&&(t.TgZ(0,"div",59),t.YNc(1,ct,2,1,"div",60),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngForOf",e.content.msg)}}function dt(n,h){if(1&n&&(t.TgZ(0,"div",64),t._uU(1),t.qZA()),2&n){const e=t.oxw(2);t.xp6(1),t.hij(" ",e.lang.text.ChatRoom.YouReadHereLast,"")}}function gt(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",29),t.NdJ("click",function(){const l=t.CHM(e).$implicit;return t.oxw().message_detail(l)}),t.YNc(1,I,3,1,"div",30),t.YNc(2,U,7,3,"div",31),t.YNc(3,K,2,1,"div",32),t.YNc(4,X,2,1,"div",32),t.YNc(5,at,4,3,"div",33),t.YNc(6,ot,3,1,"div",34),t.YNc(7,_t,2,1,"div",35),t.YNc(8,dt,2,1,"div",36),t.qZA()}if(2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngIf",e.showInfo&&e.showInfo.date),t.xp6(1),t.Q6J("ngIf",e.showInfo&&e.showInfo.sender),t.xp6(1),t.Q6J("ngIf",e.content.quickShare),t.xp6(1),t.Q6J("ngIf",e.content.match),t.xp6(1),t.Q6J("ngIf",e.content.filename),t.xp6(1),t.Q6J("ngIf",e.content.noti),t.xp6(1),t.Q6J("ngIf",e.content.msg),t.xp6(1),t.Q6J("ngIf",e.isLastRead)}}function ut(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",43),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().quickShare_act(a)}),t._uU(1),t.qZA()}if(2&n){const e=t.oxw(2);t.xp6(1),t.hij(" ",e.lang.text.ChatRoom.QuickShare," ")}}function ft(n,h){1&n&&t._UZ(0,"div",52)}function mt(n,h){if(1&n&&(t.TgZ(0,"span",53),t._uU(1),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.hij(" ",e," ")}}function pt(n,h){if(1&n&&(t.TgZ(0,"div",48)(1,"p",49),t._uU(2),t.qZA(),t.YNc(3,ft,1,0,"div",50),t.YNc(4,mt,2,1,"span",51),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(2),t.hij(" ",e.content.filename," "),t.xp6(1),t.Q6J("ngIf",e.content.text),t.xp6(1),t.Q6J("ngForOf",e.content.text)}}function xt(n,h){if(1&n&&(t.TgZ(0,"div",54),t._UZ(1,"img",55),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(1),t.Q6J("src",e.content.thumbnail,t.LSH)("alt",e.content.filename)}}function vt(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",44),t.NdJ("click",function(){t.CHM(e);const a=t.oxw().$implicit;return t.oxw().file_detail(a)}),t.YNc(1,pt,5,3,"div",45),t.YNc(2,xt,2,2,"div",46),t.qZA()}if(2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngIf",!e.content.thumbnail),t.xp6(1),t.Q6J("ngIf",e.content.thumbnail)}}function wt(n,h){if(1&n&&(t.TgZ(0,"span",67),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.hij(" ",e.text," ")}}function bt(n,h){if(1&n&&(t.TgZ(0,"a",68),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Q6J("href",e.text,t.LSH),t.xp6(1),t.Oqu(e.text)}}function Tt(n,h){if(1&n&&(t.TgZ(0,"span"),t.YNc(1,wt,2,1,"span",65),t.YNc(2,bt,2,2,"a",66),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngIf",!e.href),t.xp6(1),t.Q6J("ngIf",e.href)}}function Ct(n,h){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,Tt,3,2,"span",60),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngForOf",e)}}function kt(n,h){if(1&n&&(t.TgZ(0,"div",59),t.YNc(1,Ct,2,1,"div",60),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngForOf",e.content.msg)}}function It(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",29),t.NdJ("click",function(){const l=t.CHM(e).$implicit;return t.oxw().message_detail(l)}),t.YNc(1,ut,2,1,"div",32),t.YNc(2,vt,3,2,"div",33),t.YNc(3,kt,2,1,"div",35),t.qZA()}if(2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngIf",e.content.quickShare),t.xp6(1),t.Q6J("ngIf",e.content.filename),t.xp6(1),t.Q6J("ngIf",e.content.msg)}}function Mt(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",69),t.NdJ("click",function(){return t.CHM(e),t.oxw().pull_msg_history(!1)}),t.TgZ(1,"ion-label"),t._uU(2),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Oqu(e.lang.text.ChatRoom.fetch_next_chat)}}function yt(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"tr",70),t.NdJ("click",function(){return t.CHM(e),t.oxw().cancel_qrshare()}),t.TgZ(1,"td",71)(2,"span"),t._uU(3),t.qZA()()()}if(2&n){const e=t.oxw();t.xp6(3),t.Oqu(e.lang.text.Settings.quickQRshare)}}function Rt(n,h){if(1&n&&t._UZ(0,"img",78),2&n){const e=t.oxw(4);t.Q6J("src",e.userInput.file.thumbnail,t.LSH)("alt",e.userInput.file.name)}}function Ot(n,h){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,Rt,1,2,"img",77),t.qZA()),2&n){const e=t.oxw(3);t.xp6(1),t.Q6J("ngIf","image"==e.userInput.file.typeheader)}}function Pt(n,h){if(1&n&&(t.TgZ(0,"span"),t._uU(1),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.hij(" ",e," ")}}function Zt(n,h){if(1&n&&(t.TgZ(0,"div",79),t.YNc(1,Pt,2,1,"span",60),t.qZA()),2&n){const e=t.oxw(3);t.xp6(1),t.Q6J("ngForOf",e.userInput.file.thumbnail)}}function At(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",29),t.NdJ("click",function(){return t.CHM(e),t.oxw(2).removeAttach()}),t.TgZ(1,"div",74),t._uU(2),t.qZA(),t.YNc(3,Ot,2,1,"div",75),t.YNc(4,Zt,2,1,"div",76),t.qZA()}if(2&n){const e=t.oxw(2);t.xp6(2),t.hij(" ",e.userInput.file.filename," "),t.xp6(1),t.Q6J("ngIf",e.userInput.file.thumbnail),t.xp6(1),t.Q6J("ngIf","text"==e.userInput.file.typeheader)}}function Vt(n,h){if(1&n&&(t.TgZ(0,"tr",72)(1,"td"),t.YNc(2,At,5,3,"div",73),t.qZA()()),2&n){const e=t.oxw();t.xp6(2),t.Q6J("ngIf",e.userInput.file)}}function St(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"tr",70),t.NdJ("click",function(){return t.CHM(e),t.oxw().scroll_down_logs()}),t.TgZ(1,"td",80),t._uU(2),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Oqu(e.lang.text.ChatRoom.GoToRecent)}}function $t(n,h){if(1&n&&(t.TgZ(0,"span"),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.hij(" ",e.text," ")}}function Ut(n,h){if(1&n&&(t.TgZ(0,"a",63),t._uU(1),t.qZA()),2&n){const e=t.oxw().$implicit;t.Q6J("href",e.text,t.LSH),t.xp6(1),t.Oqu(e.text)}}function Jt(n,h){if(1&n&&(t.TgZ(0,"span"),t.YNc(1,$t,2,1,"span",75),t.YNc(2,Ut,2,2,"a",62),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngIf",!e.href),t.xp6(1),t.Q6J("ngIf",e.href)}}function Qt(n,h){if(1&n&&(t.TgZ(0,"span"),t.YNc(1,Jt,3,2,"span",60),t.qZA()),2&n){const e=h.$implicit;t.xp6(1),t.Q6J("ngForOf",e)}}function Lt(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"tr",70),t.NdJ("click",function(){return t.CHM(e),t.oxw().init_chatroom()}),t.TgZ(1,"td",81)(2,"span")(3,"b"),t._uU(4),t.qZA()(),t.YNc(5,Qt,2,1,"span",60),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Akn("margin-right: 8px; color: #"+e.last_message_viewer.color),t.xp6(2),t.Oqu((e.last_message_viewer.is_me?e.nakama.users.self.display_name:e.nakama.users[e.isOfficial][e.target][e.last_message_viewer.user_id].display_name)||e.lang.text.Profile.noname_user),t.xp6(1),t.Q6J("ngForOf",e.last_message_viewer.message)}}function Ft(n,h){if(1&n&&t._UZ(0,"ion-icon",85),2&n){const e=t.oxw().$implicit;t.Q6J("name",e.icon||"close-circle")}}function Nt(n,h){if(1&n&&t._UZ(0,"img",86),2&n){const e=t.oxw().$implicit;t.Q6J("src","assets/icon/"+e.icon_img,t.LSH)("alt",e.title)}}function Ht(n,h){if(1&n){const e=t.EpF();t.TgZ(0,"div",82),t.NdJ("click",function(){return t.CHM(e).$implicit.act()}),t.TgZ(1,"div"),t.YNc(2,Ft,1,1,"ion-icon",83),t.YNc(3,Nt,1,2,"img",84),t.qZA()()}if(2&n){const e=h.$implicit;t.Akn("cursor: "+(e.cursor||"pointer")+";"),t.Q6J("hidden",e.isHide),t.xp6(2),t.Q6J("ngIf",e.icon),t.xp6(1),t.Q6J("ngIf",e.icon_img)}}const qt=[{path:"",component:(()=>{class n{constructor(e,s,a,l,o,f,w,T,P,y,Z,W,Et,Bt,jt,Gt,Wt){this.modalCtrl=e,this.navCtrl=s,this.route=a,this.router=l,this.nakama=o,this.noti=f,this.statusBar=w,this.indexed=T,this.lang=P,this.sanitizer=y,this.global=Z,this.loadingCtrl=W,this.camera=Et,this.webrtc=Bt,this.p5toast=jt,this.mClipboard=Gt,this.alertCtrl=Wt,this.info={},this.foundLastRead=!1,this.messages=[],this.sending_msg=[],this.temporary_open_thumbnail={},this.extended_buttons=[{isHide:!0,icon:"close-circle-outline",act:()=>(0,u.mG)(this,void 0,void 0,function*(){let p=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});p.present(),delete this.nakama.channels_orig[this.isOfficial][this.target][this.info.id],3==this.info.redirect.type&&(yield this.nakama.remove_group_list(this.nakama.groups[this.isOfficial][this.target][this.info.group_id]||this.info.info,this.isOfficial,this.target));try{delete this.nakama.groups[this.isOfficial][this.target][this.info.group_id]}catch(m){console.log("DeleteGroupFailed: ",m)}yield this.nakama.remove_channel_files(this.isOfficial,this.target,this.info.id),this.nakama.save_groups_with_less_info(),yield this.indexed.GetFileListFromDB(`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}`,m=>{m.forEach(k=>this.indexed.removeFileFromUserPath(k)),p.dismiss()}),this.navCtrl.back()})},{icon:"log-out-outline",act:()=>(0,u.mG)(this,void 0,void 0,function*(){if(3!=this.info.redirect.type)try{yield this.nakama.remove_group_list(this.nakama.groups[this.isOfficial][this.target][this.info.group_id]||this.info.info,this.isOfficial,this.target,!1),yield this.nakama.servers[this.isOfficial][this.target].socket.leaveChat(this.info.id),this.nakama.channels_orig[this.isOfficial][this.target][this.info.id].status="missing",this.extended_buttons.forEach(p=>{p.isHide=!0}),this.extended_buttons[0].isHide=!1}catch(p){console.error("\ucc44\ub110\uc5d0\uc11c \ub098\uc624\uae30 \uc2e4\ud328: ",p)}else this.extended_buttons[1].isHide=!0})},{icon:"settings-outline",act:()=>{3!=this.info.redirect.type?this.extended_buttons[2].isHide=!0:this.lock_modal_open||(this.lock_modal_open=!0,this.modalCtrl.create({component:Q.x,componentProps:{info:this.nakama.groups[this.isOfficial][this.target][this.info.group_id],server:{isOfficial:this.isOfficial,target:this.target}}}).then(p=>{p.onWillDismiss().then(m=>{m.data&&(this.extended_buttons.forEach(k=>{k.isHide=!0}),this.extended_buttons[0].isHide=!1,this.extended_buttons[2].isHide=!1)}),p.present(),this.lock_modal_open=!1}))}},{icon:"camera-outline",act:()=>{this.camera.getPicture({destinationType:0,correctOrientation:!0}).then(p=>(0,u.mG)(this,void 0,void 0,function*(){let m=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});m.present(),this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),this.userInput.file={};let k=new Date;this.userInput.file.filename=`Camera_${k.toLocaleString().replace(/:/g,"_")}.jpeg`,this.userInput.file.file_ext="jpeg",this.userInput.file.thumbnail=this.sanitizer.bypassSecurityTrustUrl("data:image/jpeg;base64,"+p),this.userInput.file.type="image/jpeg",this.userInput.file.typeheader="image",this.userInput.file.content_related_creator=[{user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"camera"}],this.userInput.file.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"camera"},yield this.indexed.saveBase64ToUserPath("data:image/jpeg;base64,"+p,`tmp_files/chatroom/${this.userInput.file.filename}`,R=>{this.userInput.file.blob=new Blob([R],{type:this.userInput.file.type})}),m.dismiss()}))}},{icon:"document-outline",act:()=>{this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),document.getElementById(this.file_sel_id).click()}},{icon:"document-attach-outline",act:()=>(0,u.mG)(this,void 0,void 0,function*(){try{let p;try{p=yield this.mClipboard.paste()}catch(k){try{p=yield H.Z.read()}catch(R){throw R}}let m={};m.url=p,m.content_related_creator=[{user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"link"}],m.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"link"},m.file_ext=m.url.split(".").pop().split("?").shift(),m.filename=`${this.lang.text.ChatRoom.ExternalLinkFile}.${m.file_ext}`,this.global.set_viewer_category_from_ext(m),m.type="",m.typeheader=m.viewer,this.info.HideAutoThumbnail||this.global.modulate_thumbnail(m,m.url),this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100),this.userInput.file=m,this.inputPlaceholder=`(${this.lang.text.ChatRoom.FileLink}: ${this.userInput.file.filename})`}catch(p){this.p5toast.show({text:`${this.lang.text.ChatRoom.FailedToPasteData}: ${p}`})}})},{icon_img:"voidDraw.png",act:()=>(0,u.mG)(this,void 0,void 0,function*(){this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId));let m,p={};if(this.userInput.file&&"image"==this.userInput.file.typeheader)try{this.userInput.file.url&&(this.userInput.file.blob=yield fetch(this.userInput.file.url).then(zt=>zt.blob()));let k=`tmp_files/chatroom/attached.${this.userInput.file.file_ext}`;yield this.indexed.saveBlobToUserPath(this.userInput.file.blob,k,void 0,this.indexed.godotDB);let R=document.getElementById("ChatroomSelectedImage");p.path=k,p.width=R.naturalWidth,p.height=R.naturalHeight,m=this.userInput.file.content_related_creator}catch(k){return void this.p5toast.show({text:`${this.lang.text.ContentViewer.CannotEditFile}: ${k}`})}this.modalCtrl.create({component:$.$,componentProps:p}).then(k=>{k.onWillDismiss().then(R=>(0,u.mG)(this,void 0,void 0,function*(){R.data&&(yield this.voidDraw_fileAct_callback(R,m))})),k.present()})})},{icon:"qr-code-outline",act:()=>{this.modalCtrl.create({component:F.b}).then(p=>{p.onDidDismiss().then(m=>{m.data?(this.userInput.quickShare=m.data,this.inputPlaceholder=this.lang.text.ChatRoom.QuickShare_placeholder):this.cancel_qrshare()}),p.present()})}},{icon:"call-outline",act:()=>(0,u.mG)(this,void 0,void 0,function*(){try{yield this.webrtc.initialize("audio",void 0,{isOfficial:this.isOfficial,target:this.target,channel_id:this.info.id,user_id:this.info.info.id||this.info.info.user_id}),this.webrtc.CurrentMatch=yield this.nakama.servers[this.isOfficial][this.target].socket.createMatch(),yield this.nakama.servers[this.isOfficial][this.target].socket.writeChatMessage(this.info.id,{match:this.webrtc.CurrentMatch.match_id}),this.scroll_down_logs(),this.webrtc.CreateOfffer()}catch(p){console.log("webrtc \uc2dc\uc791\ub2e8\uacc4 \uc624\ub958: ",p)}})}],this.next_cursor="",this.prev_cursor="",this.file_sel_id="file_sel_id",this.ShowGoToBottom=!1,this.last_message_viewer={user_id:void 0,message:void 0,color:void 0,is_me:void 0},this.userInput={file:void 0,quickShare:void 0,text:""},this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder,this.pullable=!0,this.ViewableMessage=[],this.ViewMsgIndex=0,this.RefreshCount=15,this.ViewCount=60,this.ShowRecentMsg=!1,this.isHistoryLoaded=!1,this.LocalHistoryList=[],this.isHidden=!0,this.ChannelUserInputId="ChannelUserInputId",this.lock_modal_open=!1}cancel_qrshare(){delete this.userInput.quickShare,this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder}inputFileSelected(e){return(0,u.mG)(this,void 0,void 0,function*(){if(e.target.files.length)if(1!=e.target.files.length)(yield this.alertCtrl.create({header:this.lang.text.ChatRoom.MultipleSend,message:`${this.lang.text.ChatRoom.CountFile}: ${e.target.files.length}`,buttons:[{text:this.lang.text.ChatRoom.Send,handler:()=>(0,u.mG)(this,void 0,void 0,function*(){let l=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});l.present();for(let o=0,f=e.target.files.length;o<f;o++)yield this.selected_blobFile_callback_act(e.target.files[o]),yield this.send();l.dismiss(),setTimeout(()=>{this.scroll_down_logs()},300)})}]})).present();else{let a=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});a.present(),yield this.selected_blobFile_callback_act(e.target.files[0]),a.dismiss()}else delete this.userInput.file,this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder})}ngOnInit(){this.nakama.removeBanner(),this.ChatLogs=document.getElementById("chatroom_div"),this.ChatLogs.onscroll=e=>{this.ChatLogs.scrollHeight==this.ChatLogs.scrollTop+this.ChatLogs.clientHeight&&(this.ShowGoToBottom||this.ShowRecentMsg||this.init_last_message_viewer()),this.ShowGoToBottom=this.ChatLogs.scrollHeight-220>this.ChatLogs.scrollTop+this.ChatLogs.clientHeight},this.nakama.ChatroomLinkAct=(e,s)=>(0,u.mG)(this,void 0,void 0,function*(){delete this.nakama.channels_orig[this.isOfficial][this.target][this.info.id].update,this.info=e,yield this.init_chatroom(),this.userInput.file=s,this.userInput.file&&this.create_selected_thumbnail()}),this.route.queryParams.subscribe(e=>(0,u.mG)(this,void 0,void 0,function*(){const s=this.router.getCurrentNavigation().extras.state;s&&(this.info=s.info),yield this.init_chatroom(),this.userInput.file=s.file,this.userInput.file&&this.create_selected_thumbnail()})),"DesktopPWA"==M.n$&&setTimeout(()=>{this.CreateDrop()},0)}CreateDrop(){let e=document.getElementById("p5Drop_chatroom");this.p5canvas=new V(s=>{s.setup=()=>{let w=s.createCanvas(e.clientWidth,e.clientHeight);w.parent(e),s.pixelDensity(1),w.drop(T=>{let P=s.millis();o<P-400?(l=!1,f.length=0,f.push(T)):(l=!0,f.push(T)),o=P,clearTimeout(a),a=setTimeout(()=>(0,u.mG)(this,void 0,void 0,function*(){if(l)this.alertCtrl.create({header:this.lang.text.ChatRoom.MultipleSend,message:`${this.lang.text.ChatRoom.CountFile}: ${f.length}`,buttons:[{text:this.lang.text.ChatRoom.Send,handler:()=>(0,u.mG)(this,void 0,void 0,function*(){let y=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});y.present();for(let Z=0,W=f.length;Z<W;Z++)yield this.selected_blobFile_callback_act(f[Z].file),yield this.send();y.dismiss(),setTimeout(()=>{this.scroll_down_logs()},300)})}]}).then(y=>y.present());else{let y=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});y.present(),this.selected_blobFile_callback_act(T.file),y.dismiss()}}),400)})};let a,l=!1,o=0,f=[];s.mouseMoved=w=>{w.dataTransfer?(e.style.pointerEvents="all",e.style.backgroundColor="#0008"):(e.style.pointerEvents="none",e.style.backgroundColor="transparent")}})}selected_blobFile_callback_act(e,s=[],a="loaded"){return(0,u.mG)(this,void 0,void 0,function*(){this.userInput.file={},this.userInput.file.filename=e.name,this.userInput.file.file_ext=e.name.split(".").pop()||e.type||this.lang.text.ChatRoom.unknown_ext,this.userInput.file.size=e.size,this.userInput.file.type=e.type,this.userInput.file.content_related_creator=[...s,{user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:a}],this.userInput.file.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:a},this.userInput.file.blob=e,this.create_selected_thumbnail(),this.inputPlaceholder=`(${this.lang.text.ChatRoom.attachments}: ${this.userInput.file.filename})`})}create_selected_thumbnail(){return(0,u.mG)(this,void 0,void 0,function*(){if(!this.userInput.file.blob||void 0===this.userInput.file.blob.size){if(this.global.set_viewer_category_from_ext(this.userInput.file),this.userInput.file.url)return this.userInput.file.thumbnail=this.userInput.file.url,void(this.userInput.file.typeheader=this.userInput.file.viewer);this.userInput.file.blob=yield this.indexed.loadBlobFromUserPath(this.userInput.file.path,this.userInput.file.type)}let e=URL.createObjectURL(this.userInput.file.blob);switch(this.userInput.file.typeheader=this.userInput.file.blob.type.split("/")[0]||this.userInput.file.viewer,setTimeout(()=>{URL.revokeObjectURL(e)},0),this.userInput.file.thumbnail=void 0,this.userInput.file.typeheader){case"image":this.userInput.file.thumbnail=this.sanitizer.bypassSecurityTrustUrl(e);break;case"text":new V(s=>{s.setup=()=>{s.noCanvas(),s.loadStrings(e,a=>{this.userInput.file.thumbnail=a,s.remove()},a=>{console.error("\ubb38\uc790\uc5f4 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",a),s.remove()})}})}})}init_chatroom(){return(0,u.mG)(this,void 0,void 0,function*(){switch(this.nakama.OnTransferMessage={},this.ViewableMessage.length=0,this.ViewMsgIndex=0,this.ShowGoToBottom=!1,this.ShowRecentMsg=!1,this.messages.length=0,this.prev_cursor=void 0,this.next_cursor=void 0,this.init_last_message_viewer(),this.file_sel_id=`chatroom_${this.info.id}_${(new Date).getTime()}`,this.ChannelUserInputId=`chatroom_input_${this.info.id}_${(new Date).getTime()}`,this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`),this.isOfficial=this.info.server.isOfficial,this.target=this.info.server.target,this.info=this.nakama.channels_orig[this.isOfficial][this.target][this.info.id],this.nakama.opened_page_info.channel={isOfficial:this.isOfficial,target:this.target,id:this.info.id},this.foundLastRead=this.info.last_read_id==this.info.last_comment_id,this.extended_buttons[3].isHide="Android"!=M.n$&&"iOS"!=M.n$,this.info.redirect.type){case 2:"missing"!=this.info.status&&(this.info.redirect?"online"==this.statusBar.groupServer[this.isOfficial][this.target]&&(this.info.status=this.nakama.load_other_user(this.info.redirect.id,this.isOfficial,this.target).online?"online":"pending"):this.info.status=this.info.info.online?"online":"pending",delete this.extended_buttons[1].isHide,this.extended_buttons[2].isHide=!0,this.extended_buttons[8].isHide="http:"==window.location.protocol&&0!=window.location.host.indexOf("localhost")||!1);break;case 3:"missing"!=this.info.status&&(yield this.nakama.load_groups(this.isOfficial,this.target,this.info.group_id)),this.extended_buttons[1].isHide=!0,delete this.extended_buttons[2].isHide,this.extended_buttons[8].isHide=!0}this.nakama.channels_orig[this.isOfficial][this.target]&&this.nakama.channels_orig[this.isOfficial][this.target][this.info.id]&&(this.nakama.channels_orig[this.isOfficial][this.target][this.info.id].update=e=>{this.nakama.check_sender_and_show_name(e,this.isOfficial,this.target),e.content.filename&&this.ModulateFileEmbedMessage(e),this.info.last_read_id=this.info.last_comment_id,this.nakama.save_channels_with_less_info(),this.check_if_send_msg(e),this.messages.push(e),this.ViewMsgIndex+this.ViewCount==this.messages.length-1&&this.ViewMsgIndex++,this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount),this.modulate_chatmsg(0,this.ViewableMessage.length),this.ShowRecentMsg=this.messages.length>this.ViewMsgIndex+this.ViewCount,setTimeout(()=>{this.info.is_new=!1,this.nakama.has_new_channel_msg=!1,this.NeedScrollDown()&&!this.ShowRecentMsg?(this.init_last_message_viewer(),this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})):(this.last_message_viewer.is_me=e.sender_id==this.nakama.servers[this.isOfficial][this.target].session.user_id,this.last_message_viewer.user_id=e.sender_id,this.last_message_viewer.message=e.content.msg,this.last_message_viewer.color=e.color)},0)}),(void 0===this.info.status||"missing"==this.info.status)&&(this.extended_buttons.forEach(e=>{e.isHide=!0}),this.extended_buttons[0].isHide=!1,3==this.info.redirect.type&&(this.extended_buttons[2].isHide=!1)),this.pull_msg_history(),setTimeout(()=>{this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})},500)})}init_last_message_viewer(){delete this.last_message_viewer.user_id,delete this.last_message_viewer.message,delete this.last_message_viewer.color,delete this.last_message_viewer.is_me}NeedScrollDown(){return this.ChatLogs.scrollHeight<this.ChatLogs.scrollTop+this.ChatLogs.clientHeight+200}scroll_down_logs(){this.ShowRecentMsg||this.init_last_message_viewer(),this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})}check_if_send_msg(e){for(let s=0,a=this.sending_msg.length;s<a;s++)if(e.sender_id==this.nakama.servers[this.isOfficial][this.target].session.user_id&&e.content.local_comp==this.sending_msg[s].content.local_comp){e.content.filename&&this.auto_open_thumbnail(e),this.sending_msg.splice(s,1);break}}auto_open_thumbnail(e){try{this.temporary_open_thumbnail[e.message_id]()}catch(s){this.temporary_open_thumbnail[e.message_id]=()=>{this.indexed.loadBlobFromUserPath(`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${e.message_id}.${e.content.file_ext}`,e.content.type,a=>(0,u.mG)(this,void 0,void 0,function*(){if(e.content.path=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${e.message_id}.${e.content.file_ext}`,!this.info.HideAutoThumbnail){let l=URL.createObjectURL(a);yield this.global.modulate_thumbnail(e.content,l)}this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100),this.nakama.WriteStorage_From_channel(e,e.content.path,this.isOfficial,this.target)})),delete this.temporary_open_thumbnail[e.message_id]}}}removeAttach(){delete this.userInput.file,this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder}pull_msg_history(e=!0){return(0,u.mG)(this,void 0,void 0,function*(){if(this.pullable||!e)if(this.pullable=!1,e)try{if(void 0===this.info.status||"missing"==this.info.status)throw"Channel missing";if(0!=this.ViewMsgIndex){let s=Math.min(this.ViewMsgIndex,this.RefreshCount);this.ViewMsgIndex-=s,this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount);for(let a=0;a<s;a++)try{if(this.info.HideAutoThumbnail)throw"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let l=yield this.indexed.loadBlobFromUserPath(this.ViewableMessage[a].content.path,this.ViewableMessage[a].content.file_ext);if(this.info.HideAutoThumbnail)throw"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let o=URL.createObjectURL(l);this.global.modulate_thumbnail(this.ViewableMessage[a].content,o)}catch(l){}return this.modulate_chatmsg(0,this.ViewableMessage.length),this.ShowRecentMsg=this.messages.length>this.ViewMsgIndex+this.ViewCount,void(this.pullable=!0)}yield this.nakama.servers[this.isOfficial][this.target].client.listChannelMessages(this.nakama.servers[this.isOfficial][this.target].session,this.info.id,this.RefreshCount,!1,this.next_cursor).then(s=>{this.info.is_new=!1,s.messages.forEach(a=>{a=this.nakama.modulation_channel_message(a,this.isOfficial,this.target),this.nakama.check_sender_and_show_name(a,this.isOfficial,this.target),this.info.last_comment||(this.info.last_comment=(a.content.filename?`(${this.lang.text.ChatRoom.attachments}) `:"")+(a.content.msg||a.content.noti||"")),!this.foundLastRead&&this.info.last_read_id?this.info.last_read_id==a.message_id&&(a.isLastRead=!0,this.foundLastRead=!0,this.info.last_read_id=this.info.last_comment_id,this.nakama.save_channels_with_less_info()):this.foundLastRead=!0,this.nakama.translate_updates(a),a.content.filename&&this.ModulateFileEmbedMessage(a),this.nakama.ModulateTimeDate(a),this.nakama.content_to_hyperlink(a),this.messages.unshift(a),this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount),this.modulate_chatmsg(0,this.ViewableMessage.length)}),this.ShowRecentMsg=this.messages.length>this.ViewMsgIndex+this.ViewCount,this.next_cursor=s.next_cursor,this.prev_cursor=s.prev_cursor,this.pullable=!0,this.nakama.saveListedMessage(this.messages,this.info,this.isOfficial,this.target)})}catch(s){if(3==this.info.redirect.type&&this.nakama.groups[this.isOfficial][this.target]&&this.nakama.groups[this.isOfficial][this.target][this.info.group_id]&&!this.nakama.groups[this.isOfficial][this.target][this.info.group_id].open){let a=[{content:{msg:[{text:this.lang.text.ChatRoom.closed_group_must_online}]}},{content:{msg:[{text:this.lang.text.ChatRoom.closed_group_not_allow}]}}];return this.next_cursor=void 0,this.isHistoryLoaded=!0,void a.forEach(l=>this.messages.push(l))}this.LoadLocalChatHistory()}else{let s=this.messages.length-this.ViewMsgIndex-this.ViewCount;this.ViewMsgIndex+=Math.min(this.RefreshCount,s),this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount);for(let a=this.ViewableMessage.length-1;a>=0;a--){try{if(this.info.HideAutoThumbnail)throw"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let l=yield this.indexed.loadBlobFromUserPath(this.ViewableMessage[a].content.path,this.ViewableMessage[a].content.file_ext);if(this.info.HideAutoThumbnail)throw"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let o=URL.createObjectURL(l);this.global.modulate_thumbnail(this.ViewableMessage[a].content,o)}catch(l){}this.modulate_chatmsg(a,this.ViewableMessage.length)}this.ShowRecentMsg=0!=s,this.pullable=!0}})}LoadLocalChatHistory(){return(0,u.mG)(this,void 0,void 0,function*(){if(0!=this.ViewMsgIndex){let e=Math.min(this.ViewMsgIndex,this.RefreshCount);this.ViewMsgIndex-=e,this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount);for(let s=e-1;s>=0;s--){try{if(this.info.HideAutoThumbnail)throw delete this.ViewableMessage[s].content.thumbnail,"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let a=yield this.indexed.loadBlobFromUserPath(this.ViewableMessage[s].content.path,this.ViewableMessage[s].content.file_ext),l=URL.createObjectURL(a);this.global.modulate_thumbnail(this.ViewableMessage[s].content,l)}catch(a){}this.modulate_chatmsg(s,this.ViewableMessage.length)}return this.ShowRecentMsg=this.messages.length>this.ViewMsgIndex+this.ViewCount,void(this.pullable=0!=this.ViewMsgIndex||Boolean(this.LocalHistoryList.length))}this.isHistoryLoaded?this.indexed.loadTextFromUserPath(this.LocalHistoryList.pop(),(e,s)=>(0,u.mG)(this,void 0,void 0,function*(){if(e&&s){let a=JSON.parse(s.trim());for(let o=a.length-1;o>=0;o--)this.ModulateFileEmbedMessage(a[o]),this.nakama.translate_updates(a[o]),a[o]=this.nakama.modulation_channel_message(a[o],this.isOfficial,this.target),this.nakama.ModulateTimeDate(a[o]),this.messages.unshift(a[o]);let l=Math.min(a.length,this.ViewCount);this.ViewMsgIndex=Math.max(0,a.length-this.RefreshCount),this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.ViewCount);for(let o=l-1;o>=0;o--){try{if(this.info.HideAutoThumbnail)throw delete this.ViewableMessage[o].content.thumbnail,"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let f=yield this.indexed.loadBlobFromUserPath(this.ViewableMessage[o].content.path,this.ViewableMessage[o].content.file_ext),w=URL.createObjectURL(f);this.global.modulate_thumbnail(this.ViewableMessage[o].content,w)}catch(f){}this.modulate_chatmsg(o,this.ViewableMessage.length)}this.ShowRecentMsg=this.messages.length>this.ViewMsgIndex+this.ViewCount}this.pullable=Boolean(this.LocalHistoryList.length)})):this.indexed.GetFileListFromDB(`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/chats/`,e=>{this.LocalHistoryList=e,this.isHistoryLoaded=!0,this.LocalHistoryList.length&&this.indexed.loadTextFromUserPath(this.LocalHistoryList.pop(),(s,a)=>(0,u.mG)(this,void 0,void 0,function*(){if(s&&a){let l=JSON.parse(a.trim());for(let o=l.length-1;o>=0;o--)this.ModulateFileEmbedMessage(l[o]),this.nakama.translate_updates(l[o]),l[o]=this.nakama.modulation_channel_message(l[o],this.isOfficial,this.target),this.nakama.ModulateTimeDate(l[o]),this.messages.unshift(l[o]),this.ViewMsgIndex=Math.max(0,this.messages.length-this.RefreshCount),this.ViewableMessage=this.messages.slice(this.ViewMsgIndex,this.ViewMsgIndex+this.RefreshCount),this.modulate_chatmsg(0,this.ViewableMessage.length);for(let o=this.ViewableMessage.length-1;o>=0;o--){try{if(this.info.HideAutoThumbnail)throw delete this.ViewableMessage[o].content.thumbnail,"\uc378\ub124\uc77c \ubcf4\uc9c0 \uc54a\uae30";let f=yield this.indexed.loadBlobFromUserPath(this.ViewableMessage[o].content.path,this.ViewableMessage[o].content.file_ext),w=URL.createObjectURL(f);this.global.modulate_thumbnail(this.ViewableMessage[o].content,w)}catch(f){}this.modulate_chatmsg(o,this.ViewableMessage.length)}}this.next_cursor=null,this.pullable=!0}))})})}open_ext_with_delay(){this.isHidden=!this.isHidden}make_ext_hidden(){this.NeedScrollDown()&&(this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"}),setTimeout(()=>{this.ChatLogs.scrollTo({top:this.ChatLogs.scrollHeight,behavior:"smooth"})},150)),"DesktopPWA"!=M.n$&&(this.isHidden=!0)}check_key(e){this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),"DesktopPWA"==M.n$?"Enter"!=e.key||e.shiftKey||"keydown"!=e.type?setTimeout(()=>{this.userInputTextArea.style.height="36px",this.userInputTextArea.style.height=this.userInputTextArea.scrollHeight+"px"},0):this.send(!0):setTimeout(()=>{this.userInputTextArea.style.height="36px",this.userInputTextArea.style.height=this.userInputTextArea.scrollHeight+"px"},0)}send(e=!1){return(0,u.mG)(this,void 0,void 0,function*(){if(e&&("Android"==M.n$||"iOS"==M.n$))return;if(this.userInputTextArea||(this.userInputTextArea=document.getElementById(this.ChannelUserInputId)),!this.userInput.text.trim()&&!this.userInput.file&&!this.userInput.quickShare)return void setTimeout(()=>{this.userInput.text="",this.userInputTextArea.style.height="36px"},0);this.userInputTextArea.focus(),this.isHidden=!0;let s={};s.msg=this.userInput.text;let a=!1,l=!1,o="";if(this.userInput.file){s.filename=this.userInput.file.filename,s.file_ext=this.userInput.file.file_ext,s.type=this.userInput.file.type;try{s.filesize=this.userInput.file.size||this.userInput.file.blob.size,s.partsize=Math.ceil(s.filesize/12e4)}catch(w){s.url=this.userInput.file.url,l=!0}s.msg.length>800?(o=s.msg,delete s.msg):s.msg=s.msg,s.content_creator=this.userInput.file.content_creator,s.content_related_creator=this.userInput.file.content_related_creator,a=!0}else if(s.msg.length>800)return void this.LongTextMessageAsFile(s);this.userInput.quickShare&&(s.quickShare=this.userInput.quickShare),s.local_comp=Math.random();let f={content:JSON.parse(JSON.stringify(s))};this.nakama.content_to_hyperlink(f),this.sending_msg.push(f);try{yield this.nakama.servers[this.isOfficial][this.target].socket.writeChatMessage(this.info.id,s).then(w=>{a&&!l&&this.indexed.saveBlobToUserPath(this.userInput.file.blob,`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${w.message_id}.${this.userInput.file.file_ext}`,()=>{this.auto_open_thumbnail({content:s,message_id:w.message_id})}),delete this.userInput.quickShare,delete this.userInput.file,this.userInput.text="",this.userInputTextArea.style.height="36px",this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder,o&&(s.msg=o,this.LongTextMessageAsFile(s))})}catch(w){3===w.code?this.p5toast.show({text:this.lang.text.ChatRoom.FailedToJoinChannel}):(console.log("\uc624\ub958 \uac80\ud1a0 \ud544\uc694: ",w),this.p5toast.show({text:`${this.lang.text.ChatRoom.FailedToSend}: ${w.message}`})),setTimeout(()=>{this.userInput.text="",this.userInputTextArea.style.height="36px"},0),setTimeout(()=>{for(let T=this.sending_msg.length-1;T>=0;T--)this.sending_msg[T].content.local_comp==s.local_comp&&this.sending_msg.splice(T,1)},1500)}})}LongTextMessageAsFile(e){return(0,u.mG)(this,void 0,void 0,function*(){let s=new Blob([e.msg]);yield this.indexed.saveBlobToUserPath(s,`tmp_files/chatroom/${this.lang.text.ChatRoom.LongText}_${e.msg.substring(0,10)}.txt`);let a={};a.blob=s,a.content_related_creator=[{user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"long_text"}],a.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"long_text"};let l=e.msg.substring(0,24);a.path=`tmp_files/chatroom/${this.lang.text.ChatRoom.LongText}_${l}~.txt`,a.file_ext="txt",a.filename=`[${this.lang.text.ChatRoom.LongText}] ${l}~.txt`,this.global.set_viewer_category_from_ext(a),a.type="text/plain",a.typeheader="text",delete e.msg,delete this.userInput.quickShare,delete this.userInput.file,this.userInput.text="",this.userInputTextArea.style.height="36px",this.inputPlaceholder=this.lang.text.ChatRoom.input_placeholder,this.userInput.file=a,this.inputPlaceholder=`(${this.lang.text.ChatRoom.attachments}: ${this.userInput.file.filename})`,this.create_selected_thumbnail(),this.p5toast.show({text:this.lang.text.ChatRoom.CreateAsTextFile})})}message_detail(e){}file_detail(e){return(0,u.mG)(this,void 0,void 0,function*(){if(e.content.url)return this.info.HideAutoThumbnail||(e.content.thumbnail=e.content.url),void this.open_viewer(e,e.content.url);let s=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${e.message_id}.${e.content.file_ext}`;try{if(!(yield this.indexed.checkIfFileExist(`${s}.history`)))throw"\uc378\ub124\uc77c \uc5f4\uae30";e.content.text=[this.lang.text.TodoDetail.WIP];let l=yield this.indexed.loadTextFromUserPath(`${s}.history`),o=JSON.parse(l);switch(delete e.content.text,o.type){case"upload":if(e.content.text=[this.lang.text.ChatRoom.uploading],this.nakama.WriteStorage_From_channel(e,s,this.isOfficial,this.target,o.index),e.content.transfer_index&&this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id][e.message_id].OnTransfer)throw"\uc804\uc1a1\uc791\uc5c5 \uc911, \uc378\ub124\uc77c \uc5f4\uae30";break;case"download":e.content.text=[this.lang.text.TodoDetail.WIP],yield this.nakama.ReadStorage_From_channel(e,s,this.isOfficial,this.target,o.index),this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100)}}catch(a){(yield this.indexed.checkIfFileExist(s))?(e.content.text||(e.content.text=[this.lang.text.ChatRoom.downloaded]),this.indexed.loadBlobFromUserPath(s,e.content.type,o=>{if(e.content.path=s,!this.info.HideAutoThumbnail){let f=URL.createObjectURL(o);this.global.modulate_thumbnail(e.content,f)}this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100)}),this.open_viewer(e,s)):this.isHistoryLoaded||(e.content.text=[this.lang.text.TodoDetail.WIP],yield this.nakama.ReadStorage_From_channel(e,s,this.isOfficial,this.target),this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},400))}})}quickShare_act(e){return(0,u.mG)(this,void 0,void 0,function*(){this.modalCtrl.create({component:N.y,componentProps:{data:e.content.quickShare}}).then(s=>s.present())})}JoinWebRTCMatch(e){this.nakama.JoinWebRTCMatch(e,this.isOfficial,this.target,this.info)}modulate_chatmsg(e,s){this.ViewableMessage[e].showInfo||(this.ViewableMessage[e].showInfo={}),this.ViewableMessage[e].showInfo.date=Boolean(this.ViewableMessage[e].msgDate),this.ViewableMessage[e].showInfo.sender=!this.ViewableMessage[e].content.noti&&this.ViewableMessage[e].user_display_name,e-1>=0&&(this.ViewableMessage[e].showInfo.date=Boolean(this.ViewableMessage[e].msgDate)&&this.ViewableMessage[e].msgDate!=this.ViewableMessage[e-1].msgDate,this.ViewableMessage[e].showInfo.sender=!this.ViewableMessage[e].content.noti&&this.ViewableMessage[e].user_display_name&&(this.ViewableMessage[e-1].isLastRead||this.ViewableMessage[e].sender_id!=this.ViewableMessage[e-1].sender_id||this.ViewableMessage[e-1].content.noti||this.ViewableMessage[e].msgDate!=this.ViewableMessage[e-1].msgDate||this.ViewableMessage[e].msgTime!=this.ViewableMessage[e-1].msgTime)),e+1<s&&(this.ViewableMessage[e+1].showInfo.date=Boolean(this.ViewableMessage[e].msgDate)&&this.ViewableMessage[e].msgDate!=this.ViewableMessage[e+1].msgDate,this.ViewableMessage[e+1].showInfo.sender=!this.ViewableMessage[e+1].content.noti&&this.ViewableMessage[e+1].user_display_name&&(this.ViewableMessage[e].isLastRead||this.ViewableMessage[e].sender_id!=this.ViewableMessage[e+1].sender_id||this.ViewableMessage[e].content.noti||this.ViewableMessage[e].msgDate!=this.ViewableMessage[e+1].msgDate||this.ViewableMessage[e].msgTime!=this.ViewableMessage[e+1].msgTime)),this.ViewableMessage[e].content.url&&!this.info.HideAutoThumbnail&&(this.ViewableMessage[e].content.thumbnail=this.ViewableMessage[e].content.url)}ModulateFileEmbedMessage(e){let s=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${e.message_id}.${e.content.file_ext}`;e.content.path=s;try{e.content.transfer_index=this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id][e.message_id]}catch(a){}e.content.transfer_index||this.indexed.checkIfFileExist(`${s}.history`,a=>{a&&this.indexed.loadTextFromUserPath(`${s}.history`,(l,o)=>{if(l&&o){let f=JSON.parse(o);delete e.content.text,this.nakama.OnTransfer[this.isOfficial]||(this.nakama.OnTransfer[this.isOfficial]={}),this.nakama.OnTransfer[this.isOfficial][this.target]||(this.nakama.OnTransfer[this.isOfficial][this.target]={}),this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id]||(this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id]={}),this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id][e.message_id]||(this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id][e.message_id]={index:e.content.partsize-f.index}),e.content.transfer_index=this.nakama.OnTransfer[this.isOfficial][this.target][e.channel_id][e.message_id]}})}),this.global.set_viewer_category(e.content),this.indexed.checkIfFileExist(s,a=>{a&&(e.content.text=[this.lang.text.ChatRoom.downloaded],this.indexed.loadBlobFromUserPath(s,e.content.type,l=>{if(e.content.path=s,!this.info.HideAutoThumbnail){let o=URL.createObjectURL(l);this.global.modulate_thumbnail(e.content,o)}this.NeedScrollDown()&&setTimeout(()=>{this.scroll_down_logs()},100)}))})}toggle_thumbnail(){return(0,u.mG)(this,void 0,void 0,function*(){if(this.info.HideAutoThumbnail=!this.info.HideAutoThumbnail,this.info.HideAutoThumbnail)for(let e=0,s=this.ViewableMessage.length;e<s;e++)delete this.ViewableMessage[e].content.thumbnail;else for(let e=0,s=this.ViewableMessage.length;e<s;e++)if(this.ViewableMessage[e].content.url)this.ViewableMessage[e].content.thumbnail=this.ViewableMessage[e].content.url;else{let a=`servers/${this.isOfficial}/${this.target}/channels/${this.info.id}/files/msg_${this.ViewableMessage[e].message_id}.${this.ViewableMessage[e].content.file_ext}`;this.ViewableMessage[e].content.path=a;try{if(this.info.HideAutoThumbnail)throw"\uc0c1\ud0dc \ubcc0\uacbd\ub428";let l=yield this.indexed.loadBlobFromUserPath(a,this.ViewableMessage[e].content.file_ext);if(this.info.HideAutoThumbnail)throw"\uc0c1\ud0dc \ubcc0\uacbd\ub428";let o=URL.createObjectURL(l);this.global.modulate_thumbnail(this.ViewableMessage[e].content,o)}catch(l){}}this.nakama.save_channels_with_less_info()})}open_viewer(e,s){let a=[];for(let l=0,o=this.messages.length;l<o;l++)this.messages[l].content.filename&&a.push(this.messages[l]);this.lock_modal_open||(this.lock_modal_open=!0,this.modalCtrl.create({component:S.B,componentProps:{info:e,path:s,isOfficial:this.isOfficial,target:this.target,relevance:a}}).then(l=>{l.onDidDismiss().then(o=>{if(o.data)switch(o.data.type){case"image":let f=[];if(o.data.msg.content.content_related_creator&&(f=[...o.data.msg.content.content_related_creator]),o.data.msg.content.content_creator){let w=!1;for(let T=0,P=f.length;T<P;T++)if(f[T].user_id==o.data.msg.content.content_creator.user_id){w=!0;break}w||f.push(o.data.msg.content.content_creator)}return void this.modalCtrl.create({component:$.$,componentProps:{path:o.data.path||s,width:o.data.width,height:o.data.height}}).then(w=>{w.onWillDismiss().then(T=>(0,u.mG)(this,void 0,void 0,function*(){T.data&&(yield this.voidDraw_fileAct_callback(T,f))})),w.present()});case"text":this.selected_blobFile_callback_act(o.data.blob,o.data.contentRelated,"textedit")}this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="IonicViewerPage",l.present(),this.lock_modal_open=!1}))}voidDraw_fileAct_callback(e,s){return(0,u.mG)(this,void 0,void 0,function*(){try{this.userInput.file={},this.userInput.file.filename=e.data.name,this.userInput.file.file_ext="png",this.userInput.file.thumbnail=this.sanitizer.bypassSecurityTrustUrl(e.data.img),this.userInput.file.type="image/png",this.userInput.file.typeheader="image",s?(this.userInput.file.content_related_creator=s,this.userInput.file.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}):(this.userInput.file.content_related_creator=[{user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}],this.userInput.file.content_creator={user_id:this.nakama.servers[this.isOfficial][this.target].session.user_id,timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}),yield this.indexed.saveBase64ToUserPath(e.data.img,`tmp_files/chatroom/${this.userInput.file.filename}`,a=>{this.userInput.file.blob=new Blob([a],{type:this.userInput.file.type})}),this.inputPlaceholder=`(${this.lang.text.ChatRoom.attachments}: ${this.userInput.file.filename})`}catch(a){console.error("godot-\uc774\ubbf8\uc9c0 \ud3b8\uc9d1 \uc0ac\uc6a9 \ubd88\uac00: ",a)}e.data.loadingCtrl.dismiss()})}user_detail(e){this.lock_modal_open||(this.lock_modal_open=!0,e.is_me?this.modalCtrl.create({component:L.Y}).then(s=>{s.onDidDismiss().then(a=>{this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="GroupServerPage",s.present(),this.lock_modal_open=!1}):this.modalCtrl.create({component:J.r,componentProps:{info:{user:this.nakama.load_other_user(e.sender_id,this.isOfficial,this.target)},group:this.info,has_admin:!1}}).then(s=>{s.onDidDismiss().then(a=>{this.noti.Current=this.info.cnoti_id,this.info.cnoti_id&&this.noti.ClearNoti(this.info.cnoti_id),this.noti.RemoveListener(`openchat${this.info.cnoti_id}`)}),this.noti.Current="OthersProfilePage",s.present(),this.lock_modal_open=!1}))}ionViewWillLeave(){this.nakama.rearrange_channels(),this.nakama.channels_orig[this.isOfficial][this.target]&&this.nakama.channels_orig[this.isOfficial][this.target][this.info.id]&&delete this.nakama.channels_orig[this.isOfficial][this.target][this.info.id].update,this.noti.Current=void 0}ngOnDestroy(){this.indexed.GetFileListFromDB("tmp_files",e=>{e.forEach(s=>this.indexed.removeFileFromUserPath(s))}),delete this.nakama.opened_page_info.channel,this.nakama.ChatroomLinkAct=void 0,this.p5canvas&&this.p5canvas.remove(),this.nakama.OnTransferMessage={}}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(C.IN),t.Y36(C.SH),t.Y36(x.gz),t.Y36(x.F0),t.Y36(q.a),t.Y36(D.J),t.Y36(Y.g),t.Y36(E.H),t.Y36(B.b),t.Y36(j.H7),t.Y36(G.AN),t.Y36(C.HT),t.Y36(d.V1),t.Y36(v.V),t.Y36(r.F),t.Y36(_.T),t.Y36(C.Br))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-chat-room"]],decls:44,vars:22,consts:[["slot","start"],["defaultHref","subscribes"],["class","top_icon","slot","end","name","eye-outline",3,"click",4,"ngIf"],["class","top_icon","slot","end","name","eye-off-outline",3,"click",4,"ngIf"],[1,"header_online_circle"],["id","p5Drop_chatroom",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["id","main_table",2,"width","100%","height","100%","background-color","var(--chatroom-background)"],[2,"height","100%"],[2,"vertical-align","top"],["id","chatroom_div",1,"main",2,"max-width","100vw"],["button","",3,"disabled","click"],[3,"click",4,"ngFor","ngForOf"],["style","padding-top: 8px; z-index: 0;","button","",3,"click",4,"ngIf"],[1,"thumnails"],["class","thumnail_parts",3,"click",4,"ngIf"],["class","thumnail_parts",4,"ngIf"],["id","input_table",2,"width","100%","background-color","var(--chatroom-input-background)"],["fill","clear",1,"ion-text-center",3,"disabled","click"],["name","add"],[2,"width","100%","vertical-align","bottom"],[1,"TextAreaInput",3,"id","ngModel","placeholder","ngModelChange","keyup","keydown","click"],["fill","clear","expand","block",3,"disabled","click"],["name","send"],["id","ext_menu",3,"hidden"],[1,"expanded"],["hidden","","type","file","accept","*","multiple","",3,"id","change"],["class","ext_button",3,"hidden","style","click",4,"ngFor","ngForOf"],["slot","end","name","eye-outline",1,"top_icon",3,"click"],["slot","end","name","eye-off-outline",1,"top_icon",3,"click"],[3,"click"],["style","text-align: center; font-size: 16px; padding-top: 8px;",4,"ngIf"],["class","message_form",4,"ngIf"],["class","quickShare_form",3,"click",4,"ngIf"],["class","file_message_form",3,"click",4,"ngIf"],["class","notice_form",4,"ngIf"],["class","message_content_form",4,"ngIf"],["class","read_last_here",4,"ngIf"],[2,"text-align","center","font-size","16px","padding-top","8px"],["color","#888"],[1,"message_form"],[1,"message_span_form",3,"click"],[3,"color"],[1,"time_form"],[1,"quickShare_form",3,"click"],[1,"file_message_form",3,"click"],["class","file_button",4,"ngIf"],["class","file_name_form",4,"ngIf"],["class","transfer_count",4,"ngIf"],[1,"file_button"],[1,"file_info"],["class","text_seperator",4,"ngIf"],["class","file_text_thumbnail",4,"ngFor","ngForOf"],[1,"text_seperator"],[1,"file_text_thumbnail"],[1,"file_name_form"],[1,"file_thumbnail",3,"src","alt"],[1,"transfer_count"],[1,"notice_form"],[1,"notice"],[1,"message_content_form"],[4,"ngFor","ngForOf"],[3,"style",4,"ngIf"],["target","_system",3,"href",4,"ngIf"],["target","_system",3,"href"],[1,"read_last_here"],["class","comp_local_content",4,"ngIf"],["class","comp_local_content","target","_system",3,"href",4,"ngIf"],[1,"comp_local_content"],["target","_system",1,"comp_local_content",3,"href"],["button","",2,"padding-top","8px","z-index","0",3,"click"],[1,"thumnail_parts",3,"click"],[2,"padding","8px","text-align","center"],[1,"thumnail_parts"],[3,"click",4,"ngIf"],[2,"text-align","center","margin-top","4px"],[4,"ngIf"],["style","display: grid;","class","thumnail_parts",4,"ngIf"],["id","ChatroomSelectedImage","class","image_thumbnail",3,"src","alt",4,"ngIf"],["id","ChatroomSelectedImage",1,"image_thumbnail",3,"src","alt"],[1,"thumnail_parts",2,"display","grid"],[2,"text-align","center","padding","4px 0px"],[1,"bottom_thumbnail"],[1,"ext_button",3,"hidden","click"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"]],template:function(e,s){1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t._uU(3),t.qZA(),t.TgZ(4,"ion-buttons",0),t._UZ(5,"ion-back-button",1),t.qZA(),t.YNc(6,g,1,0,"ion-icon",2),t.YNc(7,b,1,0,"ion-icon",3),t._UZ(8,"div",4),t.qZA()(),t.TgZ(9,"ion-content"),t._UZ(10,"div",5),t.TgZ(11,"table",6)(12,"tr",7)(13,"td",8)(14,"div",9)(15,"ion-item",10),t.NdJ("click",function(){return s.pull_msg_history()}),t.TgZ(16,"ion-label"),t._uU(17),t.qZA()(),t.YNc(18,gt,9,8,"div",11),t.YNc(19,It,4,3,"div",11),t.YNc(20,Mt,3,1,"ion-item",12),t.qZA(),t.TgZ(21,"table",13),t.YNc(22,yt,4,1,"tr",14),t.YNc(23,Vt,3,1,"tr",15),t.YNc(24,St,3,1,"tr",14),t.YNc(25,Lt,6,4,"tr",14),t.qZA()()(),t.TgZ(26,"tr")(27,"td")(28,"div")(29,"table",16)(30,"tr")(31,"td")(32,"ion-button",17),t.NdJ("click",function(){return s.open_ext_with_delay()}),t._UZ(33,"ion-icon",18),t.qZA()(),t.TgZ(34,"td",19)(35,"textarea",20),t.NdJ("ngModelChange",function(l){return s.userInput.text=l})("keyup",function(l){return s.check_key(l)})("keydown",function(l){return s.check_key(l)})("click",function(){return s.make_ext_hidden()}),t.qZA()(),t.TgZ(36,"td")(37,"ion-button",21),t.NdJ("click",function(){return s.send(!1)}),t._UZ(38,"ion-icon",22),t.qZA()()()()()()(),t.TgZ(39,"tr",23)(40,"td")(41,"div",24)(42,"input",25),t.NdJ("change",function(l){return s.inputFileSelected(l)}),t.qZA(),t.YNc(43,Ht,4,5,"div",26),t.qZA()()()()()),2&e&&(t.xp6(3),t.Oqu(s.info.title||s.lang.text.ChatRoom.noname_chatroom),t.xp6(3),t.Q6J("ngIf",!s.info.HideAutoThumbnail),t.xp6(1),t.Q6J("ngIf",s.info.HideAutoThumbnail),t.xp6(1),t.Akn("background-color: "+s.statusBar.colors[(s.info.status?s.info.status:s.info.info.status)||"offline"]),t.xp6(7),t.Q6J("disabled",void 0===s.next_cursor&&!s.ViewMsgIndex||!s.pullable),t.xp6(2),t.Oqu(s.lang.text.ChatRoom.fetch_previous_chat),t.xp6(1),t.Q6J("ngForOf",s.ViewableMessage),t.xp6(1),t.Q6J("ngForOf",s.sending_msg),t.xp6(1),t.Q6J("ngIf",s.ShowRecentMsg),t.xp6(2),t.Q6J("ngIf",s.userInput.quickShare),t.xp6(1),t.Q6J("ngIf",s.userInput.file),t.xp6(1),t.Q6J("ngIf",s.ShowGoToBottom&&!s.last_message_viewer.user_id),t.xp6(1),t.Q6J("ngIf",s.last_message_viewer.user_id),t.xp6(7),t.Q6J("disabled","offline"==((s.info.status?s.info.status:s.info.info.status)||"offline")),t.xp6(3),t.Q6J("id",s.ChannelUserInputId)("ngModel",s.userInput.text)("placeholder",s.inputPlaceholder),t.xp6(2),t.Q6J("disabled",!s.info.status||"missing"==s.info.status||"offline"==s.info.status),t.xp6(2),t.Q6J("hidden",s.isHidden),t.xp6(3),t.Q6J("id",s.file_sel_id),t.xp6(1),t.Q6J("ngForOf",s.extended_buttons))},directives:[C.Gu,C.sr,C.wd,C.Sm,C.oU,C.cs,O.O5,C.gu,C.W2,C.Ie,C.Q$,O.sg,C.YG,i.Fj,i.JJ,i.On],styles:[".top_icon[_ngcontent-%COMP%]{width:28px;height:28px;padding-right:60px}.main[_ngcontent-%COMP%]{width:100%;height:100%;padding:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}.message_form[_ngcontent-%COMP%]{margin:8px 0 0}.message_span_form[_ngcontent-%COMP%]{margin-right:8px}.time_form[_ngcontent-%COMP%]{font-size:12px;color:#888}.file_message_form[_ngcontent-%COMP%]{display:flex}.file_name_form[_ngcontent-%COMP%]{margin-top:4px;max-width:192px;max-height:192px}.file_thumbnail[_ngcontent-%COMP%]{max-width:192px;max-height:192px;width:auto;height:auto}.file_info[_ngcontent-%COMP%]{margin:0}.file_text_thumbnail[_ngcontent-%COMP%]{margin-top:2px;display:grid}.quickShare_form[_ngcontent-%COMP%]{border-radius:16px;max-width:156px;width:-moz-fit-content;width:fit-content;height:-moz-fit-content;height:fit-content;padding:8px;margin:8px 0;text-align:center;vertical-align:middle;word-break:keep-all;overflow:hidden;background-color:var(--chatroom-you-read-here-backgruond)}.message_content_form[_ngcontent-%COMP%]{margin:4px 0 0}.comp_local_content[_ngcontent-%COMP%]{color:#888}.text_seperator[_ngcontent-%COMP%]{background-color:#fff;margin-top:2px;position:relative;width:100%;height:2px}.expanded[_ngcontent-%COMP%]{height:240px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth;text-align:center;background-color:var(--chatroom-input-background)}.ext_button[_ngcontent-%COMP%]{display:inline-block;width:64px;height:48px;margin:24px 12px 0;text-align:center}.ext_button_icon[_ngcontent-%COMP%]{width:72px;height:72px}.file_button[_ngcontent-%COMP%]{width:160px;height:112px;overflow:hidden;background-color:gray;margin-top:4px}#send_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;height:-moz-fit-content;height:fit-content;max-height:160px;transform:translateY(-100%);position:relative;background:#bbbb;padding:8px;overflow:hidden}.bottom_thumbnail[_ngcontent-%COMP%]{width:100%;max-width:100vw;max-height:96px;overflow:hidden;padding:8px}.image_thumbnail[_ngcontent-%COMP%]{width:auto;max-height:96px;height:auto;object-fit:contain;display:block;margin:auto;padding:8px}.thumnails[_ngcontent-%COMP%]{width:100%;height:-moz-fit-content;height:fit-content;position:relative;transform:translateY(-100%);background:var(--chatroom-last-msg-viewer-bg);padding:8px}.thumnail_parts[_ngcontent-%COMP%]{max-height:96px;overflow-y:scroll}.transfer_count[_ngcontent-%COMP%]{align-self:flex-end;margin-left:4px}.notice_form[_ngcontent-%COMP%]{text-align:center;margin:12px}.notice[_ngcontent-%COMP%]{font-size:12px;display:inline;background:#444;border-radius:8px;padding:4px 8px;color:#fff}.read_last_here[_ngcontent-%COMP%]{text-align:center;font-size:12px;display:inherit;background:var(--chatroom-you-read-here-backgruond);margin:4px 0;color:var(--chatroom-you-read-here-text)}.ext_icon_img[_ngcontent-%COMP%]{max-width:36px;max-height:36px}.TextAreaInput[_ngcontent-%COMP%]{width:100%;height:36px;max-height:156px;resize:none;padding:6px;margin-top:5px;border:0;overflow:hidden;background-color:var(--chatroom-input-background)}"]}),n})()},{path:"ionic-viewer",loadChildren:()=>c.e(132).then(c.bind(c,132)).then(n=>n.IonicViewerPageModule)},{path:"void-draw",loadChildren:()=>c.e(4695).then(c.bind(c,4695)).then(n=>n.VoidDrawPageModule)},{path:"quick-share-review",loadChildren:()=>c.e(2907).then(c.bind(c,2907)).then(n=>n.QuickShareReviewPageModule)}];let Dt=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[x.Bz.forChild(qt)],x.Bz]}),n})(),Yt=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[O.ez,i.u5,C.Pc,Dt]]}),n})()},905:(z,A,c)=>{c.d(A,{y:()=>G});var O=c(655),i=c(9863),C=c(5742),x=c(3996),u=c(9912),V=c(3336),J=c(1282),M=c(9808),S=c(4182);function $(d,v){1&d&&i._UZ(0,"ion-icon",14)}function Q(d,v){1&d&&i._UZ(0,"ion-icon",15)}function L(d,v){if(1&d){const r=i.EpF();i.TgZ(0,"ion-accordion",6)(1,"ion-item",7),i.YNc(2,$,1,0,"ion-icon",8),i.YNc(3,Q,1,0,"ion-icon",9),i.TgZ(4,"ion-label"),i._uU(5),i.qZA()(),i.TgZ(6,"ion-list",10)(7,"ion-item",3),i.NdJ("click",function(){const b=i.CHM(r).$implicit;return b.grant=!b.grant}),i.TgZ(8,"ion-label"),i._uU(9),i.qZA(),i.TgZ(10,"ion-toggle",11),i.NdJ("ngModelChange",function(g){return i.CHM(r).$implicit.grant=g}),i.qZA()(),i.TgZ(11,"ion-item",12)(12,"ion-label"),i._uU(13),i.qZA(),i.TgZ(14,"ion-label",13),i._uU(15),i.qZA()(),i.TgZ(16,"ion-item",12)(17,"ion-label"),i._uU(18),i.qZA(),i.TgZ(19,"ion-label",13),i._uU(20),i.qZA()(),i.TgZ(21,"ion-item",12)(22,"ion-label"),i._uU(23),i.qZA(),i.TgZ(24,"ion-label",13),i._uU(25),i.qZA()(),i.TgZ(26,"ion-item",12)(27,"ion-label"),i._uU(28),i.qZA(),i.TgZ(29,"ion-toggle",11),i.NdJ("ngModelChange",function(g){return i.CHM(r).$implicit.value.isSSL=g}),i.qZA()()()()}if(2&d){const r=v.$implicit,_=v.index,g=i.oxw(2);i.Q6J("value",_),i.xp6(2),i.Q6J("ngIf",!r.grant),i.xp6(1),i.Q6J("ngIf",r.grant),i.xp6(2),i.Oqu(r.value.name),i.xp6(4),i.Oqu(g.lang.text.QuickShareReview.QuickShareGrant),i.xp6(1),i.Q6J("ngModel",r.grant),i.xp6(3),i.Oqu(g.lang.text.GroupServer.Address),i.xp6(2),i.Oqu(r.value.address),i.xp6(3),i.Oqu(g.lang.text.GroupServer.Port),i.xp6(2),i.Oqu(r.value.port||7350),i.xp6(3),i.Oqu(g.lang.text.GroupServer.Key),i.xp6(2),i.Oqu(r.value.key||"defaultkey"),i.xp6(3),i.Oqu(g.lang.text.GroupServer.isSSL),i.xp6(1),i.Q6J("ngModel",r.value.isSSL)}}function F(d,v){if(1&d&&(i.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),i._uU(3),i.qZA()(),i.TgZ(4,"ion-accordion-group"),i.YNc(5,L,30,14,"ion-accordion",5),i.qZA()()),2&d){const r=i.oxw();i.xp6(3),i.Oqu(r.lang.text.QuickShareReview.Servers),i.xp6(2),i.Q6J("ngForOf",r.servers)}}function N(d,v){1&d&&i._UZ(0,"ion-icon",14)}function H(d,v){1&d&&i._UZ(0,"ion-icon",15)}function t(d,v){if(1&d){const r=i.EpF();i.TgZ(0,"ion-accordion",6)(1,"ion-item",7),i.YNc(2,N,1,0,"ion-icon",8),i.YNc(3,H,1,0,"ion-icon",9),i.TgZ(4,"ion-label"),i._uU(5),i.qZA()(),i.TgZ(6,"ion-list",10)(7,"ion-item",3),i.NdJ("click",function(){const b=i.CHM(r).$implicit;return b.grant=!b.grant}),i.TgZ(8,"ion-label"),i._uU(9),i.qZA(),i.TgZ(10,"ion-toggle",11),i.NdJ("ngModelChange",function(g){return i.CHM(r).$implicit.grant=g}),i.qZA()()()()}if(2&d){const r=v.$implicit,_=v.index,g=i.oxw(2);i.Q6J("value",_),i.xp6(2),i.Q6J("ngIf",!r.grant),i.xp6(1),i.Q6J("ngIf",r.grant),i.xp6(2),i.Oqu(r.name),i.xp6(4),i.Oqu(g.lang.text.QuickShareReview.QuickShareGrant),i.xp6(1),i.Q6J("ngModel",r.grant)}}function q(d,v){if(1&d&&(i.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),i._uU(3),i.qZA()(),i.TgZ(4,"ion-accordion-group"),i.YNc(5,t,11,6,"ion-accordion",5),i.qZA()()),2&d){const r=i.oxw();i.xp6(3),i.Oqu(r.lang.text.QuickShareReview.Channels),i.xp6(2),i.Q6J("ngForOf",r.groups)}}function D(d,v){1&d&&i._UZ(0,"ion-icon",14)}function Y(d,v){1&d&&i._UZ(0,"ion-icon",15)}function E(d,v){if(1&d&&(i.TgZ(0,"ion-item")(1,"ion-label"),i._uU(2),i.qZA()()),2&d){const r=v.$implicit;i.xp6(2),i.Oqu(r)}}function B(d,v){if(1&d){const r=i.EpF();i.TgZ(0,"ion-accordion",6)(1,"ion-item",7),i.YNc(2,D,1,0,"ion-icon",8),i.YNc(3,Y,1,0,"ion-icon",9),i.TgZ(4,"ion-label"),i._uU(5),i.qZA()(),i.TgZ(6,"ion-list",10),i.YNc(7,E,3,1,"ion-item",16),i.TgZ(8,"ion-item",3),i.NdJ("click",function(){const b=i.CHM(r).$implicit;return b.grant=!b.grant}),i.TgZ(9,"ion-label"),i._uU(10),i.qZA(),i.TgZ(11,"ion-toggle",11),i.NdJ("ngModelChange",function(g){return i.CHM(r).$implicit.grant=g}),i.qZA()()()()}if(2&d){const r=v.$implicit,_=v.index,g=i.oxw(2);i.Q6J("value",_),i.xp6(2),i.Q6J("ngIf",!r.grant),i.xp6(1),i.Q6J("ngIf",r.grant),i.xp6(2),i.Oqu(r.value.urls[0]),i.xp6(2),i.Q6J("ngForOf",r.value.urls),i.xp6(3),i.Oqu(g.lang.text.QuickShareReview.QuickShareGrant),i.xp6(1),i.Q6J("ngModel",r.grant)}}function j(d,v){if(1&d&&(i.TgZ(0,"div")(1,"ion-item-divider")(2,"ion-label"),i._uU(3),i.qZA()(),i.TgZ(4,"ion-accordion-group"),i.YNc(5,B,12,7,"ion-accordion",5),i.qZA()()),2&d){const r=i.oxw();i.xp6(3),i.Oqu(r.lang.text.QuickShareReview.Channels),i.xp6(2),i.Q6J("ngForOf",r.rtcserver)}}let G=(()=>{class d{constructor(r,_,g,b,I,U){this.lang=r,this.navParams=_,this.modalCtrl=g,this.nakama=b,this.p5toast=I,this.global=U,this.servers=[],this.groups=[],this.rtcserver=[]}ngOnInit(){return(0,O.mG)(this,void 0,void 0,function*(){let r=this.navParams.get("data"),_=this.global.CatchGETs(r),g=yield this.nakama.AddressToQRCodeAct(_,!0);for(let b=0,I=g.length;b<I;b++)switch(g[b].type){case"server":this.servers.push(g[b]);break;case"group":this.groups.push(g[b]);break;case"rtcserver":this.rtcserver.push(g[b])}})}apply_selected(){return(0,O.mG)(this,void 0,void 0,function*(){let r=[];for(let _=0,g=this.servers.length;_<g;_++)this.servers[_].grant&&r.push(this.servers[_]);for(let _=0,g=this.groups.length;_<g;_++)this.groups[_].grant&&r.push(this.groups[_]);for(let _=0,g=this.rtcserver.length;_<g;_++)this.rtcserver[_].grant&&r.push(this.rtcserver[_]);yield this.nakama.act_from_QRInfo(r),this.p5toast.show({text:this.lang.text.QuickQRShare.success_received,lateable:!0}),this.modalCtrl.dismiss()})}}return d.\u0275fac=function(r){return new(r||d)(i.Y36(C.b),i.Y36(x.X1),i.Y36(x.IN),i.Y36(u.a),i.Y36(V.F),i.Y36(J.AN))},d.\u0275cmp=i.Xpm({type:d,selectors:[["app-quick-share-review"]],decls:14,vars:5,consts:[["slot","start",3,"click"],["defaultHref",""],[4,"ngIf"],["button","",3,"click"],[1,"ion-text-center"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["slot","header"],["color","danger","slot","start","name","close-outline",4,"ngIf"],["color","success","slot","start","name","checkmark-outline",4,"ngIf"],["slot","content"],["slot","end",1,"ion_toggle_ignore",3,"ngModel","ngModelChange"],["button",""],[1,"ion-text-end"],["color","danger","slot","start","name","close-outline"],["color","success","slot","start","name","checkmark-outline"],[4,"ngFor","ngForOf"]],template:function(r,_){1&r&&(i.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),i._uU(3),i.qZA(),i.TgZ(4,"ion-buttons",0),i.NdJ("click",function(){return _.modalCtrl.dismiss()}),i._UZ(5,"ion-back-button",1),i.qZA()()(),i.TgZ(6,"ion-content"),i.YNc(7,F,6,2,"div",2),i.YNc(8,q,6,2,"div",2),i.YNc(9,j,6,2,"div",2),i.qZA(),i.TgZ(10,"ion-footer")(11,"ion-item",3),i.NdJ("click",function(){return _.apply_selected()}),i.TgZ(12,"ion-label",4),i._uU(13),i.qZA()()()),2&r&&(i.xp6(3),i.Oqu(_.lang.text.QuickShareReview.Title),i.xp6(4),i.Q6J("ngIf",_.servers.length),i.xp6(1),i.Q6J("ngIf",_.groups.length),i.xp6(1),i.Q6J("ngIf",_.rtcserver.length),i.xp6(4),i.Oqu(_.lang.text.QuickShareReview.ApplyChecked))},directives:[x.Gu,x.sr,x.wd,x.Sm,x.oU,x.cs,x.W2,M.O5,x.rH,x.Q$,x.eh,M.sg,x.We,x.Ie,x.gu,x.q_,x.ho,x.w,S.JJ,S.On,x.fr],styles:[".ion_toggle_ignore[_ngcontent-%COMP%]{pointer-events:none}"]}),d})()}}]);