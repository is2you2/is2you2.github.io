"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7602],{5087:(Z,O,c)=>{c.d(O,{r:()=>V});var y=c(655),E=c(5016),n=c(9863),_=c(3996),t=c(1282),h=c(3496),A=c(5742),U=c(4433),M=c(3336);function k(b,F){if(1&b){const d=n.EpF();n.TgZ(0,"ion-content")(1,"ion-list")(2,"ion-item",9),n.NdJ("click",function(){return n.CHM(d),n.oxw().snapshot_modify()}),n.TgZ(3,"ion-label"),n._uU(4),n.qZA()(),n.TgZ(5,"ion-item",9),n.NdJ("click",function(){return n.CHM(d),n.oxw().download_file()}),n.TgZ(6,"ion-label"),n._uU(7),n.qZA()()()()}if(2&b){const d=n.oxw();n.xp6(4),n.Oqu(d.lang.text.ContentViewer.Edit),n.xp6(3),n.Oqu(d.lang.text.ContentViewer.Download)}}let V=(()=>{class b{constructor(d,u,P,p,w,i,e,o,s){this.modalCtrl=d,this.navParams=u,this.global=P,this.indexed=p,this.lang=w,this.file=i,this.alertCtrl=e,this.loadingCtrl=o,this.p5toast=s,this.EventListenerAct=l=>{l.detail.register(120,v=>{})}}ngOnInit(){this.FileInfo=this.navParams.get("info")}ionViewDidEnter(){return(0,y.mG)(this,void 0,void 0,function*(){document.addEventListener("ionBackButton",this.EventListenerAct),yield this.global.CreateGodotIFrame("viewer",{local_url:"assets/data/godot/viewer.pck",title:"ViewerEx",path:this.navParams.get("path"),ext:this.FileInfo.file_ext,force_logo:!0,receive_image:(d,u,P)=>{this.modalCtrl.dismiss({base64:","+d,width:u,height:P})}},"create_thumbnail")})}snapshot_modify(){this.global.godot_window.modify_image()}download_file(){"DesktopPWA"==E.n$||"MobilePWA"==E.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:d=>(0,y.mG)(this,void 0,void 0,function*(){let u=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});u.present();let P=d.filename?`${d.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,p=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,P,p).then(w=>{u.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(w=>{12===(u.dismiss(),w.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",w)})})}]}).then(d=>d.present())}ionViewWillLeave(){document.removeEventListener("ionBackButton",this.EventListenerAct),this.global.godot_window.filename=this.FileInfo.filename,this.global.godot_window.create_thumbnail(this.FileInfo)}}return b.\u0275fac=function(d){return new(d||b)(n.Y36(_.IN),n.Y36(_.X1),n.Y36(t.A),n.Y36(h.H),n.Y36(A.b),n.Y36(U.$),n.Y36(_.Br),n.Y36(_.HT),n.Y36(M.F))},b.\u0275cmp=n.Xpm({type:b,selectors:[["app-godot-viewer"]],decls:20,vars:2,consts:[["slot","start",3,"click"],["defaultHref",""],[1,"main_table",2,"width","100%","height","100%","margin","0"],[2,"height","0"],["text-wrap",""],["id","menu_trigger"],["slot","start","name","ellipsis-vertical",2,"transform","translateX(25%)"],["trigger","menu_trigger","dismissOnSelect",""],["id","viewer",1,"full_screen",2,"display","flex"],["button","",3,"click"]],template:function(d,u){1&d&&(n.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),n._uU(3),n.qZA(),n.TgZ(4,"ion-buttons",0),n.NdJ("click",function(){return u.modalCtrl.dismiss()}),n._UZ(5,"ion-back-button",1),n.qZA()()(),n.TgZ(6,"ion-content")(7,"table",2)(8,"tr",3)(9,"td")(10,"ion-list-header")(11,"ion-label",4),n._uU(12),n.qZA(),n.TgZ(13,"ion-button",5),n._UZ(14,"ion-icon",6),n.qZA(),n.TgZ(15,"ion-popover",7),n.YNc(16,k,8,2,"ng-template"),n.qZA()()()(),n.TgZ(17,"tr")(18,"td"),n._UZ(19,"div",8),n.qZA()()()()),2&d&&(n.xp6(3),n.Oqu(u.lang.text.ContentViewer.Title),n.xp6(9),n.Oqu(u.FileInfo.filename))},directives:[_.Gu,_.sr,_.wd,_.Sm,_.oU,_.cs,_.W2,_.yh,_.Q$,_.YG,_.gu,_.d8,_.q_,_.Ie],styles:[""]}),b})()},774:(Z,O,c)=>{c.d(O,{B:()=>P});var y=c(655),E=c(5016),n=c(6505),t=c(9863),h=c(3996),A=c(3496),U=c(5742),M=c(4433),k=c(3336),V=c(6690),b=c(1282),F=c(9808);function d(p,w){if(1&p){const i=t.EpF();t.TgZ(0,"ion-item",13),t.NdJ("click",function(){return t.CHM(i),t.oxw(2).modify_image()}),t.TgZ(1,"ion-label"),t._uU(2),t.qZA()()}if(2&p){const i=t.oxw(2);t.xp6(2),t.Oqu(i.lang.text.ContentViewer.Edit)}}function u(p,w){if(1&p){const i=t.EpF();t.TgZ(0,"ion-content")(1,"ion-list"),t.YNc(2,d,3,1,"ion-item",12),t.TgZ(3,"ion-item",13),t.NdJ("click",function(){return t.CHM(i),t.oxw().download_file()}),t.TgZ(4,"ion-label"),t._uU(5),t.qZA()()()()}if(2&p){const i=t.oxw();t.xp6(2),t.Q6J("ngIf","image"==i.FileInfo.viewer&&!i.HasNoEditButton),t.xp6(3),t.Oqu(i.lang.text.ContentViewer.Download)}}let P=(()=>{class p{constructor(i,e,o,s,l,v,m,g,C,I){this.modalCtrl=i,this.navParams=e,this.indexed=o,this.lang=s,this.file=l,this.p5toast=v,this.alertCtrl=m,this.loadingCtrl=g,this.fileOpener=C,this.global=I,this.image_info={}}ngOnInit(){return(0,y.mG)(this,void 0,void 0,function*(){this.FileInfo=this.navParams.get("info"),this.ContentBox=document.getElementById("ContentBox"),this.FileHeader=document.getElementById("FileHeader"),this.HasNoEditButton=this.navParams.get("no_edit")||!1,this.blob=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type),this.FileURL=URL.createObjectURL(this.blob)})}ionViewDidEnter(){return(0,y.mG)(this,void 0,void 0,function*(){let i=document.getElementById("p5canvas");switch(this.FileInfo.viewer){case"image":this.p5canvas=new n(e=>{let o;e.setup=()=>(0,y.mG)(this,void 0,void 0,function*(){i.style.maxWidth="100%",i.style.overflow="hidden",this.ContentBox.style.overflow="hidden",e.noCanvas();let a=document.createElement("img");a.hidden=!0,a.src=this.FileURL,a.onload=()=>{i.style.backgroundImage=`url(${this.FileURL})`,i.style.backgroundRepeat="no-repeat",i.style.pointerEvents="none",this.image_info.width=a.naturalWidth,this.image_info.height=a.naturalHeight,l=e.createVector(a.naturalWidth,a.naturalHeight),s(),a.remove()},("Android"==E.n$||"iOS"==E.n$)&&(o=document.createElement("iframe"),o.setAttribute("src",this.FileURL),o.setAttribute("frameborder","0"),o.setAttribute("class","full_screen"),o.setAttribute("style","position: relative; pointer-events: all"),o.hidden=!0,i.appendChild(o)),e.noLoop()});let s=()=>{i.style.backgroundSize=`${i.clientWidth}px`,i.style.backgroundPositionX="0px",i.style.backgroundPositionY=i.clientHeight/2-l.y*(i.clientWidth/l.x)/2+"px"};e.windowResized=()=>{setTimeout(()=>{s()},50)};let l,v=e.createVector(),m=e.createVector(),g=e.createVector(),C=1,I=()=>{i.style.backgroundPositionX=`${v.x+g.x}px`,i.style.backgroundPositionY=`${v.y+g.y}px`},L=(a,T)=>{let r=C,x=C*T,D=Number(i.style.backgroundPositionX.split("px")[0]),B=Number(i.style.backgroundPositionY.split("px")[0]),Y=(r-x)*e.map(a.x,D,D+r,0,1),$=(r-x)/l.x*l.y*e.map(a.y,B,B+r/l.x*l.y,0,1);i.style.backgroundPositionX=`${D+Y}px`,i.style.backgroundPositionY=`${B+$}px`,i.style.backgroundSize=`${x}px`};e.mousePressed=()=>{e.mouseButton==e.CENTER&&s(),"DesktopPWA"==E.n$&&(v=e.createVector(Number(i.style.backgroundPositionX.split("px")[0]),Number(i.style.backgroundPositionY.split("px")[0])),m=e.createVector(e.mouseX,e.mouseY))},e.mouseWheel=a=>{C=Number(i.style.backgroundSize.split("px")[0]),L(e.createVector(i.clientWidth/2,i.clientHeight/2),1-a.delta/1e3)},e.mouseDragged=()=>{"DesktopPWA"==E.n$&&(g=e.createVector(e.mouseX,e.mouseY),g.sub(m),I())};let W,f={},R=!1;e.touchStarted=a=>{for(let r=0,x=a.changedTouches.length;r<x;r++)f[a.changedTouches[r].identifier]=e.createVector(a.changedTouches[r].clientX,a.changedTouches[r].clientY);switch(Object.keys(f).length){case 1:v=e.createVector(Number(i.style.backgroundPositionX.split("px")[0]),Number(i.style.backgroundPositionY.split("px")[0])),m=f[a.changedTouches[0].identifier].copy();break;case 2:v=e.createVector(Number(i.style.backgroundPositionX.split("px")[0]),Number(i.style.backgroundPositionY.split("px")[0]));let r=f[0].copy();W=r.dist(f[1]),m=r.add(f[1]).div(2).copy(),C=Number(i.style.backgroundSize.split("px")[0]),I();break;default:R=!0,s()}},e.touchMoved=a=>{if(!R){for(let r=0,x=a.changedTouches.length;r<x;r++)f[a.changedTouches[r].identifier]=e.createVector(a.changedTouches[r].clientX,a.changedTouches[r].clientY);switch(Object.keys(f).length){case 1:g=f[a.changedTouches[0].identifier].copy(),g.sub(m),I();break;case 2:let r=f[0].copy(),x=r.dist(f[1]);g=r.add(f[1]).div(2).copy();let D=g.copy();g.sub(m),I(),L(D,x/W)}}},e.touchEnded=a=>{if("changedTouches"in a){for(let r=0,x=a.changedTouches.length;r<x;r++)delete f[a.changedTouches[r].identifier];switch(Object.keys(f).length){case 1:v=e.createVector(Number(i.style.backgroundPositionX.split("px")[0]),Number(i.style.backgroundPositionY.split("px")[0])),m=f[Object.keys(f)[0]].copy();break;case 0:R=!1}}}});break;case"audio":this.p5canvas=new n(e=>{var o;e.setup=()=>{e.noCanvas(),e.noLoop(),o=e.createAudio([this.FileURL],()=>{i.appendChild(o.elt),o.elt.hidden=!0,setTimeout(()=>{s(),o.elt.hidden=!1},50),o.showControls(),o.play()})};let s=()=>{let l=this.ContentBox.offsetWidth;o.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),o.size(l,25)};e.windowResized=()=>{setTimeout(()=>{s()},50)}});break;case"video":this.p5canvas=new n(e=>{var o;e.setup=()=>{e.noCanvas(),e.noLoop(),o=e.createVideo([this.FileURL],()=>{i.appendChild(o.elt),o.elt.hidden=!0,setTimeout(()=>{s(),o.elt.hidden=!1},50),o.showControls(),o.play()}),e.VideoMedia=o};let s=()=>{let l=this.ContentBox.offsetWidth,v=this.ContentBox.offsetHeight-this.FileHeader.offsetHeight,m=o.width,g=o.height;o.elt.setAttribute("style","position: relative; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);"),m<g?(g=v,m=m/o.height*g):(m=l,g=g/o.width*m||v/2),o.size(m,g)};e.windowResized=()=>{setTimeout(()=>{s()},50)}});break;case"text":this.p5canvas=new n(e=>{e.setup=()=>{e.noCanvas(),e.noLoop(),e.loadStrings(this.FileURL,o=>{let s=document.createElement("textarea");s.disabled=!0,s.className="infobox",s.setAttribute("style","height: 100%; display: block;"),s.textContent=o.join("\n"),i.appendChild(s)},o=>{console.error("\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c: ",o),i.textContent="\uc5f4\ub78c\ud560 \uc218 \uc5c6\ub294 \ud30c\uc77c\uc785\ub2c8\ub2e4.",this.FileInfo.else=!0})}});break;case"disabled":try{yield this.file.writeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`,this.blob),this.fileOpener.open(this.file.externalDataDirectory+`viewer_tmp.${this.FileInfo.file_ext}`,this.FileInfo.type||`application/${this.FileInfo.file_ext}`)}catch(e){console.log("open file failed: ",e),this.p5toast.show({text:`${this.lang.text.ChatRoom.cannot_open_file}: ${e.message}`})}}})}modify_image(){this.modalCtrl.dismiss(this.image_info)}download_file(){"DesktopPWA"==E.n$||"MobilePWA"==E.n$?this.indexed.DownloadFileFromUserPath(this.navParams.get("path"),this.FileInfo.type,this.FileInfo.filename):this.alertCtrl.create({header:this.lang.text.ContentViewer.Filename,inputs:[{name:"filename",placeholder:this.FileInfo.filename,type:"text"}],buttons:[{text:this.lang.text.ContentViewer.saveFile,handler:i=>(0,y.mG)(this,void 0,void 0,function*(){let e=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});e.present();let o=i.filename?`${i.filename.replace(/:|\?|\/|\\|<|>/g,"")}.${this.FileInfo.file_ext}`:this.FileInfo.filename,s=yield this.indexed.loadBlobFromUserPath(this.navParams.get("path"),this.FileInfo.type);this.file.writeFile(this.file.externalDataDirectory,o,s).then(l=>{e.dismiss(),this.p5toast.show({text:this.lang.text.ContentViewer.fileSaved})}).catch(l=>{12===(e.dismiss(),l.code)?(this.p5toast.show({text:this.lang.text.ContentViewer.AlreadyExist}),this.download_file()):console.log("\uc900\ube44\ub418\uc9c0 \uc54a\uc740 \uc624\ub958 \ubc18\ud658: ",l)})})}]}).then(i=>i.present())}ionViewWillLeave(){return(0,y.mG)(this,void 0,void 0,function*(){if("video"==this.FileInfo.viewer)try{let o,s,e=this.p5canvas.VideoMedia.size();e.width>e.height?(o=192,s=e.height/e.width*192):(o=e.width/e.height*192,s=192),this.p5canvas.createCanvas(o,s),this.p5canvas.image(this.p5canvas.VideoMedia,0,0,o,s),this.p5canvas.fill(255,128),this.p5canvas.rect(0,0,o,s),this.p5canvas.textWrap(this.p5canvas.CHAR),this.p5canvas.textSize(16);let l=s/16;this.p5canvas.push(),this.p5canvas.translate(l/6,l/6),this.p5canvas.fill(0),this.p5canvas.text(this.FileInfo.filename,l,l,o-2*l,s-2*l),this.p5canvas.filter(this.p5canvas.BLUR,3),this.p5canvas.pop(),this.p5canvas.fill(255),this.p5canvas.text(this.FileInfo.filename,l,l,o-2*l,s-2*l),this.p5canvas.saveFrames("","png",1,1,v=>(0,y.mG)(this,void 0,void 0,function*(){try{yield this.indexed.saveBase64ToUserPath(v[0].imageData.replace(/"|=|\\/g,""),`${this.FileInfo.path}_thumbnail.png`),this.global.modulate_thumbnail(this.FileInfo,"")}catch(m){}}))}catch(e){console.log("\uc791\uc5c5\uc911 \uc624\ub958\ubcf4\uae30: ",e)}this.p5canvas&&this.p5canvas.remove(),this.FileURL&&URL.revokeObjectURL(this.FileURL),this.file.checkFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`)&&this.file.removeFile(this.file.externalDataDirectory,`viewer_tmp.${this.FileInfo.file_ext}`)})}}return p.\u0275fac=function(i){return new(i||p)(t.Y36(h.IN),t.Y36(h.X1),t.Y36(A.H),t.Y36(U.b),t.Y36(M.$),t.Y36(k.F),t.Y36(h.Br),t.Y36(h.HT),t.Y36(V.u),t.Y36(b.A))},p.\u0275cmp=t.Xpm({type:p,selectors:[["app-ionic-viewer"]],decls:20,vars:2,consts:[["id","Toolbar"],["slot","start",3,"click"],["defaultHref",""],["id","ContentBox"],[1,"main_table_elt"],[2,"height","0"],["id","FileHeader"],["text-wrap",""],["id","menu_trigger"],["slot","start","name","ellipsis-vertical",2,"transform","translateX(25%)"],["trigger","menu_trigger","dismissOnSelect",""],["id","p5canvas",1,"full_screen",2,"overflow-y","scroll"],["button","",3,"click",4,"ngIf"],["button","",3,"click"]],template:function(i,e){1&i&&(t.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),t._uU(3),t.qZA(),t.TgZ(4,"ion-buttons",1),t.NdJ("click",function(){return e.modalCtrl.dismiss()}),t._UZ(5,"ion-back-button",2),t.qZA()()(),t.TgZ(6,"ion-content",3)(7,"table",4)(8,"tr",5)(9,"td")(10,"ion-list-header",6)(11,"ion-label",7),t._uU(12),t.qZA(),t.TgZ(13,"ion-button",8),t._UZ(14,"ion-icon",9),t.qZA(),t.TgZ(15,"ion-popover",10),t.YNc(16,u,6,2,"ng-template"),t.qZA()()()(),t.TgZ(17,"tr")(18,"td"),t._UZ(19,"div",11),t.qZA()()()()),2&i&&(t.xp6(3),t.Oqu(e.lang.text.ContentViewer.Title),t.xp6(9),t.Oqu(e.FileInfo.filename))},directives:[h.Gu,h.sr,h.wd,h.Sm,h.oU,h.cs,h.W2,h.yh,h.Q$,h.YG,h.gu,h.d8,h.q_,F.O5,h.Ie],styles:[".main_table_elt[_ngcontent-%COMP%]{width:100%;height:100%;border:0;margin:0}"]}),p})()}}]);