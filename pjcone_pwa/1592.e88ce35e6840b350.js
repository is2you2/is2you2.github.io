"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1592],{8828:(S,k,u)=>{u.d(k,{_8:()=>C,on:()=>h,wd:()=>b});var C=function(_){return _.Prompt="PROMPT",_.Camera="CAMERA",_.Photos="PHOTOS",_}(C||{}),b=function(_){return _.Rear="REAR",_.Front="FRONT",_}(b||{}),h=function(_){return _.Uri="uri",_.Base64="base64",_.DataUrl="dataUrl",_}(h||{})},4120:(S,k,u)=>{u.d(k,{Ut:()=>h,_8:()=>b._8,on:()=>b.on});var C=u(6400),b=u(8828);const h=(0,C.C_)("Camera",{web:()=>u.e(9028).then(u.bind(u,9028)).then(_=>new _.CameraWeb)})},1592:(S,k,u)=>{u.r(k),u.d(k,{AddPostPageModule:()=>ae});var C=u(1368),b=u(4716),h=u(5624),_=u(3332),I=u(1528),E=u(5020),M=u(340),T=u(4120),$=u(1052),R=u(4712),w=u(2272),G=u(8744),F=u(9352),D=u(5193),e=u(4496),U=u(4500),B=u(9240),j=u(7136),N=u(3824),L=u(4668),K=u(4476),Y=u(7756);function W(c,f){if(1&c&&(e.I0R(0,"ion-title"),e.OEk(1),e.C$Y()),2&c){const r=e.GaO();e.yG2(),e.cNF(r.lang.text.AddPost.EditTitle)}}function H(c,f){if(1&c&&(e.I0R(0,"ion-title"),e.OEk(1),e.C$Y()),2&c){const r=e.GaO();e.yG2(),e.cNF(r.lang.text.AddPost.Title)}}function z(c,f){if(1&c){const r=e.KQA();e.I0R(0,"ion-item",7),e.qCj("click",function(){const i=e.usT(r).index,n=e.GaO(2);return e.CGJ(n.select_server(i,!0))}),e.I0R(1,"ion-label"),e.OEk(2),e.C$Y()()}if(2&c){const r=f.$implicit;e.yG2(2),e.cNF(r.name)}}function V(c,f){if(1&c){const r=e.KQA();e.I0R(0,"ion-accordion-group",21,22),e.qCj("click",function(){e.usT(r);const a=e.GaO();return e.CGJ(a.isExpanded=!0)}),e.I0R(2,"ion-accordion",23)(3,"ion-item",24)(4,"ion-label"),e.OEk(5),e.C$Y(),e.I0R(6,"ion-label",25),e.OEk(7),e.C$Y(),e.wR5(8,"ion-icon",26),e.C$Y(),e.I0R(9,"div",27),e.yuY(10,z,3,1,"ion-item",28),e.C$Y()()()}if(2&c){const r=e.GaO();e.E7m("disabled",r.isSaveClicked)("value",r.isExpanded),e.yG2(5),e.cNF(r.lang.text.AddGroup.SelectServer),e.yG2(2),e.cNF(r.servers[r.index].name),e.yG2(3),e.E7m("ngForOf",r.servers)}}function J(c,f){if(1&c){const r=e.KQA();e.I0R(0,"div",29)(1,"ion-item",11)(2,"ion-toggle",30),e.iHE("ngModelChange",function(a){e.usT(r);const i=e.GaO();return e.kNx(i.userInput.isNSFW,a)||(i.userInput.isNSFW=a),e.CGJ(a)}),e.OEk(3),e.C$Y()(),e.I0R(4,"div",31),e.wR5(5,"img",32),e.C$Y()()}if(2&c){const r=e.GaO();e.yG2(2),e.OKB("ngModel",r.userInput.isNSFW),e.yG2(),e.cNF(r.lang.text.AddPost.NSFW),e.yG2(2),e.m_g(r.userInput.isNSFW?"filter: blur(16px);":""),e.E7m("src",r.MainPostImage,e.K6U)}}function Q(c,f){if(1&c&&e.wR5(0,"ion-icon",37),2&c){const r=e.GaO().$implicit;e.E7m("name",r.icon||"close-circle")}}function X(c,f){if(1&c&&e.wR5(0,"img",38),2&c){const r=e.GaO().$implicit;e.E7m("src","assets/icon/"+r.icon_img,e.K6U)("alt",r.title)}}function Z(c,f){if(1&c){const r=e.KQA();e.I0R(0,"div",33)(1,"div",34),e.qCj("click",function(){const i=e.usT(r).$implicit;return e.CGJ(i.act())}),e.yuY(2,Q,1,1,"ion-icon",35)(3,X,1,2,"img",36),e.I0R(4,"div"),e.OEk(5),e.C$Y()()()}if(2&c){const r=f.$implicit;e.yG2(),e.m_g("cursor: "+(r.cursor||"pointer")+";"),e.E7m("hidden",r.isHide),e.yG2(),e.E7m("ngIf",r.icon),e.yG2(),e.E7m("ngIf",r.icon_img),e.yG2(2),e.cNF(r.name)}}function q(c,f){if(1&c){const r=e.KQA();e.I0R(0,"ion-item",39),e.qCj("click",function(){const i=e.usT(r).$implicit,n=e.GaO();return e.CGJ(n.open_viewer(i))}),e.I0R(1,"ion-label"),e.OEk(2),e.C$Y(),e.I0R(3,"div",40),e.wR5(4,"img",41),e.C$Y()()}if(2&c){const r=f.$implicit,t=f.index,a=e.GaO();e.E7m("id","PostAttach_"+t)("disabled",a.isSaveClicked),e.yG2(2),e.cNF("["+t+"] "+r.filename),e.yG2(2),e.E7m("src",r.thumbnail,e.K6U)}}const ee=[{path:"",component:(()=>{var c;class f{constructor(t,a,i,n,s,o,m,p,l,g,ie,ne,se){var x,d=this;this.global=t,this.lang=a,this.navCtrl=i,this.nakama=n,this.modalCtrl=s,this.p5toast=o,this.indexed=m,this.loadingCtrl=p,this.sanitizer=l,this.mClipboard=g,this.alertCtrl=ie,this.route=ne,this.router=se,this.servers=[],this.userInput={id:void 0,title:void 0,content:void 0,creator_id:void 0,creator_name:void 0,UserColor:void 0,create_time:void 0,modify_time:void 0,server:void 0,mainImage:void 0,attachments:[],isNSFW:!1},this.index=0,this.isModify=!1,this.isExpanded=!1,this.isSaveClicked=!1,this.isServerChanged=!1,this.useVoiceRecording=!1,this.MainPostImage=void 0,this.extended_buttons=[{icon:"image-outline",name:this.lang.text.AddPost.MainPostImage,act:()=>{this.isSaveClicked||(this.MainPostImage?(this.MainPostImage=void 0,this.userInput.mainImage=void 0,document.getElementById("PostMainImage_sel").value=""):document.getElementById("PostMainImage_sel").click())}},{icon:"document-attach-outline",name:this.lang.text.ChatRoom.attachments,act:(x=(0,I.c)(function*(){if(!d.isSaveClicked)try{return void(yield d.new_attach({detail:{value:"link"}}))}catch(y){"done"!=y&&d.new_attach({detail:{value:"load"}})}}),function(){return x.apply(this,arguments)})},{icon_img:"voidDraw.png",name:this.lang.text.ChatRoom.voidDraw,act:function(){var x=(0,I.c)(function*(){d.isSaveClicked||d.modalCtrl.create({component:$.S,componentProps:{},cssClass:"fullscreen"}).then(v=>{v.onWillDismiss().then(function(){var O=(0,I.c)(function*(A){A.data&&(d.AddAttachTextForm(),yield d.voidDraw_fileAct_callback(A,void 0))});return function(A){return O.apply(this,arguments)}}()),v.onDidDismiss().then(()=>{d.AddShortcut()}),delete d.global.p5key.KeyShortCut.Escape,v.present()})});return function(){return x.apply(this,arguments)}}()},{icon:"camera-outline",name:this.lang.text.ChatRoom.Camera,act:function(){var x=(0,I.c)(function*(){if(!d.isSaveClicked)try{const y=yield T.Ut.getPhoto({quality:90,resultType:T.on.Base64,source:T._8.Camera});let P=yield d.loadingCtrl.create({message:d.lang.text.TodoDetail.WIP});P.present();let v={};v.filename=`Camera_${(new Date).toLocaleString().replace(/:/g,"_")}.${y.format}`,v.file_ext=y.format,v.thumbnail=d.sanitizer.bypassSecurityTrustUrl("data:image/jpeg;base64,"+y.base64String),v.type=`image/${y.format}`,v.typeheader="image",v.content_related_creator=[{user_id:"local"==d.servers[d.index].isOfficial?"local":d.nakama.servers[d.isOfficial][d.target].session.user_id,timestamp:(new Date).getTime(),display_name:d.nakama.users.self.display_name,various:"camera"}],v.content_creator={user_id:"local"==d.servers[d.index].isOfficial?"local":d.nakama.servers[d.isOfficial][d.target].session.user_id,timestamp:(new Date).getTime(),display_name:d.nakama.users.self.display_name,various:"camera"},v.viewer="image",v.path=`tmp_files/post/${v.filename}`,yield d.indexed.saveBase64ToUserPath("data:image/jpeg;base64,"+y.base64String,v.path,A=>{v.blob=new Blob([A],{type:v.type})}),d.AddAttachTextForm(),d.userInput.attachments.push(v),d.MakeAttachHaveContextMenu(),P.dismiss()}catch{}});return function(){return x.apply(this,arguments)}}()},{icon:"mic-circle-outline",name:this.lang.text.ChatRoom.Voice,act:function(){var x=(0,I.c)(function*(){if(!d.isSaveClicked)if(d.useVoiceRecording=!d.useVoiceRecording,d.useVoiceRecording)(yield R.G.hasAudioRecordingPermission()).value?(d.extended_buttons[4].icon="stop-circle-outline",yield R.G.startRecording(),d.p5toast.show({text:d.lang.text.ChatRoom.StartVRecord})):yield R.G.requestAudioRecordingPermission();else{let y=yield R.G.stopRecording(),P=d.global.Base64ToBlob(`${y.value.mimeType},${y.value.recordDataBase64}`);P.name=`${d.lang.text.ChatRoom.VoiceRecord}.${y.value.mimeType.split("/").pop().split(";")[0]}`,P.type_override=y.value.mimeType,d.selected_blobFile_callback_act(P),d.extended_buttons[4].icon="mic-circle-outline"}});return function(){return x.apply(this,arguments)}}()}],this.lock_modal_open=!1}ngOnDestroy(){this.p5canvas&&this.p5canvas.remove()}ngOnInit(){var t=this;this.route.queryParams.subscribe(function(){var a=(0,I.c)(function*(i){const n=t.router.getCurrentNavigation().extras.state;let s=!1;if(n&&(s=!!n.act,n.data&&(t.userInput=n.data)),t.MakeAttachHaveContextMenu(),s){if(t.servers=t.nakama.get_all_server_info(!0,!0),t.servers.unshift({name:t.lang.text.AddGroup.UseLocalStorage,isOfficial:"local",target:"target",local:!0}),t.servers.length>1&&(t.index=1),n&&n.data&&("local"==t.userInput.creator_id&&(t.index=0),t.userInput.mainImage)){let p=URL.createObjectURL(t.userInput.mainImage.blob);t.MainPostImage=p,setTimeout(()=>{URL.revokeObjectURL(p)},100)}t.select_server(t.index)}});return function(i){return a.apply(this,arguments)}}()),"DesktopPWA"==D.s1&&setTimeout(()=>{this.CreateDrop()},0)}CreateDrop(){var t=this;let a=document.getElementById("p5Drop_addPost");this.p5canvas||(this.p5canvas=new F(i=>{i.setup=()=>{let n=i.createCanvas(a.clientWidth,a.clientHeight);n.parent(a),i.pixelDensity(.1),n.drop(function(){var s=(0,I.c)(function*(o){yield t.selected_blobFile_callback_act(o.file)});return function(o){return s.apply(this,arguments)}}())},i.mouseMoved=n=>{n.dataTransfer?(a.style.pointerEvents="all",a.style.backgroundColor="#0008"):(a.style.pointerEvents="none",a.style.backgroundColor="transparent")}}))}catchBottomTabShortCut(){this.BottomTabShortcut=this.global.p5key.KeyShortCut.BottomTab,delete this.global.p5key.KeyShortCut.BottomTab}ionViewWillEnter(){var t=this;this.AddShortcut(),this.catchBottomTabShortCut(),this.TitleInput=document.getElementById("add_post_title").childNodes[1].childNodes[1].childNodes[1],this.TitleInput.onpaste=i=>{let n=[];for(const s of i.clipboardData.files)s.type.startsWith("image/")&&n.push({file:s});n.length&&1==n.length&&this.ChangeMainPostImage({target:{files:[n[0].file]}})};let a=document.getElementById("add_post_content");setTimeout(()=>{this.userInput.title?a.focus():this.TitleInput.focus()},200),a.onpaste=i=>{let n=[];for(const s of i.clipboardData.files)s.type.startsWith("image/")&&n.push({file:s});var s;n.length&&(1==n.length?this.selected_blobFile_callback_act(n[0].file):this.alertCtrl.create({header:this.lang.text.ChatRoom.MultipleSend,message:`${this.lang.text.ChatRoom.CountFile}: ${n.length}`,buttons:[{text:this.lang.text.ChatRoom.Send,handler:(s=(0,I.c)(function*(){let o=yield t.loadingCtrl.create({message:t.lang.text.TodoDetail.WIP});o.present();for(let m=0,p=n.length;m<p;m++)yield t.selected_blobFile_callback_act(n[m].file);o.dismiss()}),function(){return s.apply(this,arguments)})}]}).then(s=>{this.global.p5key.KeyShortCut.Escape=()=>{s.dismiss()},s.onDidDismiss().then(()=>{this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()}}),s.present()}))},this.isModify=!!this.userInput.id}go_to_profile(){this.modalCtrl.create({component:M.w,componentProps:{isOfficial:this.isOfficial,target:this.target}}).then(t=>t.present())}select_server(t,a=!1){this.index=t,this.userInput.server=this.servers[t],this.isExpanded=!1,this.isOfficial=this.servers[t].isOfficial,this.target=this.servers[t].target,a?this.isServerChanged=this.OriginalServerInfo!=`${this.isOfficial}/${this.target}`:this.OriginalServerInfo=`${this.isOfficial}/${this.target}`,this.userInput.creator_name=this.nakama.users.self.display_name;try{this.userInput.creator_id=this.nakama.servers[this.isOfficial][this.target].session.user_id,this.userInput.UserColor=(this.userInput.creator_id.replace(/[^5-79a-b]/g,"")+"abcdef").substring(0,6)}catch{this.userInput.creator_id="local",this.userInput.UserColor="888888"}}AddShortcut(){this.global.p5key&&this.global.p5key.KeyShortCut&&(this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.navigateBack("portal/community")})}ChangeMainPostImage(t){let a=t.target.files[0],i={};i.filename=a.name,i.file_ext=a.name.split(".").pop()||a.type||this.lang.text.ChatRoom.unknown_ext,i.size=a.size,i.type=a.type||a.type_override,i.blob=a,i.path=`tmp_files/post/MainImage.${i.file_ext}`,this.userInput.mainImage=i;let n=URL.createObjectURL(a);this.indexed.saveBlobToUserPath(a,i.path),this.MainPostImage=n,setTimeout(()=>{URL.revokeObjectURL(n)},100)}selected_blobFile_callback_act(t,a=[],i="loaded",n){var s=this;return(0,I.c)(function*(){let o={};o.filename=t.name,o.file_ext=t.name.split(".").pop()||t.type||s.lang.text.ChatRoom.unknown_ext,o.size=t.size,o.type=t.type||t.type_override,n&&(o.path=n),o.content_related_creator=[...a,{user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:i}],o.content_creator={user_id:"local"==s.servers[s.index].isOfficial?"local":s.nakama.servers[s.isOfficial][s.target].session.user_id,timestamp:(new Date).getTime(),display_name:s.nakama.users.self.display_name,various:i},o.blob=t,o.path=`tmp_files/post/${o.filename}_${s.userInput.attachments.length}.${o.file_ext}`,s.create_selected_thumbnail(o),s.AddAttachTextForm(),s.userInput.attachments.push(o),s.MakeAttachHaveContextMenu(),s.indexed.saveBlobToUserPath(o.blob,o.path)})()}AddAttachTextForm(){this.userInput.content?this.userInput.content+=`\n[${this.userInput.attachments.length}]\n`:this.userInput.content=`[${this.userInput.attachments.length}]\n`}create_selected_thumbnail(t){var a=this;return(0,I.c)(function*(){if(a.global.set_viewer_category_from_ext(t),t.url){try{(yield fetch(t.url)).ok&&(t.thumbnail=t.url)}catch{}return void(t.typeheader=t.viewer)}try{t.thumbnail=yield a.indexed.loadBlobFromUserPath(t.path,t.type)}catch{}let i=URL.createObjectURL(t.blob);"image"===(t.typeheader=t.blob.type.split("/")[0]||t.viewer,setTimeout(()=>{URL.revokeObjectURL(i)},0),t.thumbnail=void 0,t.typeheader)&&(t.thumbnail=a.sanitizer.bypassSecurityTrustUrl(i))})()}voidDraw_fileAct_callback(t,a){var i=this;return(0,I.c)(function*(){try{let n={};n.filename=t.data.name,n.file_ext="png",n.thumbnail=i.sanitizer.bypassSecurityTrustUrl(t.data.img),n.type="image/png",n.typeheader="image",a?(n.content_related_creator=a,n.content_creator={user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}):(n.content_related_creator=[{user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}],n.content_creator={user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"voidDraw"}),n.path=`tmp_files/post/${n.filename}`,n.viewer="image",yield i.indexed.saveBase64ToUserPath(t.data.img,n.path,s=>{n.blob=new Blob([s],{type:n.type})}),i.userInput.attachments.push(n),i.MakeAttachHaveContextMenu()}catch(n){console.error("godot-\uc774\ubbf8\uc9c0 \ud3b8\uc9d1 \uc0ac\uc6a9 \ubd88\uac00: ",n)}t.data.loadingCtrl.dismiss()})()}new_attach(t,a=void 0){var i=this;return(0,I.c)(function*(){let n;switch(void 0===a&&(a={}),t.detail.value){case"load":document.getElementById("add_post_input").click();break;case"link":try{let s=a.url;if(void 0===s)try{s=yield i.mClipboard.paste()}catch{try{s=yield w.c.read()}catch(l){throw l}}try{let p=i.global.Base64ToBlob(s),l=s.split(";")[0].split(":")[1];throw n=new File([p],`${i.lang.text.ChatRoom.FileLink}.${l.split("/").pop()}`,{type:l}),yield i.selected_blobFile_callback_act(n),"done"}catch(p){if("done"===p)throw p}try{if(n&&void 0===a.filename)throw"\uc774\ubbf8 \ud30c\uc77c\uc774 \ucca8\ubd80\ub428, \ud1a0\uae00\ub9cc \uc2dc\ub3c4";if(!(yield fetch(s)).ok)throw"URL \uad6c\uc870\uac00 \uc815\uc0c1\uc774 \uc544\ub2d8"}catch(p){throw p}let o={};o.url=s,o.content_related_creator=[],a&&a.content_related_creator&&(o.content_related_creator=[...a.content_related_creator]),o.content_related_creator.push({user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:a.url?"shared":"link"}),o.content_creator={user_id:"local"==i.servers[i.index].isOfficial?"local":i.nakama.servers[i.isOfficial][i.target].session.user_id,timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:a.url?"shared":"link"};let m=o.url.split(".");o.file_ext=a.file_ext||m.pop().split("?").shift(),o.filename=a.filename||decodeURIComponent(`${m.pop().split("/").pop()||i.lang.text.ChatRoom.ExternalLinkFile}.${o.file_ext}`),i.global.set_viewer_category_from_ext(o),o.type=a.type||"",o.typeheader=a.typeheader||o.viewer,i.global.modulate_thumbnail(o,o.url),i.userInput.attachments.push(o),i.MakeAttachHaveContextMenu()}catch(s){throw"done"==s?s:`\uc778\uc2dd \ubd88\uac00\ub2a5\ud55c URL \uc815\ubcf4: ${s}`}}})()}MakeAttachHaveContextMenu(){setTimeout(()=>{for(let t=this.userInput.attachments.length-1;t>=0;t--)document.getElementById(`PostAttach_${t}`).oncontextmenu=()=>(this.p5toast.show({text:`${this.lang.text.AddPost.RemoveAttach}: ${this.userInput.attachments[t].filename}`}),this.userInput.attachments.splice(t,1),this.MakeAttachHaveContextMenu(),!1)},0)}inputFileSelected(t){var a=this;return(0,I.c)(function*(){if(t.target.files.length)if(1!=t.target.files.length){let n=yield a.alertCtrl.create({header:a.lang.text.ChatRoom.MultipleSend,message:`${a.lang.text.ChatRoom.CountFile}: ${t.target.files.length}`,buttons:[{text:a.lang.text.ChatRoom.Send,handler:(s=(0,I.c)(function*(){let o=yield a.loadingCtrl.create({message:a.lang.text.ChatRoom.MultipleSend});o.present();for(let m=0,p=t.target.files.length;m<p;m++)o.message=`${a.lang.text.ChatRoom.MultipleSend}: ${p-m}`,yield a.selected_blobFile_callback_act(t.target.files[m]);o.dismiss(),setTimeout(()=>{document.getElementById("add_post_input").value=""},300)}),function(){return s.apply(this,arguments)})}]});a.global.p5key.KeyShortCut.Escape=()=>{n.dismiss()},n.onDidDismiss().then(()=>{a.global.p5key.KeyShortCut.Escape=()=>{a.navCtrl.pop()}}),n.present()}else{let n=yield a.loadingCtrl.create({message:a.lang.text.TodoDetail.WIP});n.present(),yield a.selected_blobFile_callback_act(t.target.files[0]),n.dismiss(),document.getElementById("add_post_input").value=""}var s})()}open_viewer(t){var a=this;let i=[];for(let n=0,s=this.userInput.attachments.length;n<s;n++)i.push({content:this.userInput.attachments[n]});this.lock_modal_open||(this.lock_modal_open=!0,delete this.global.p5key.KeyShortCut.Escape,this.modalCtrl.create({component:G.K,componentProps:{info:{content:t},path:t.path,alt_path:t.path,isOfficial:this.isOfficial,target:this.target,relevance:i,local:"local"==this.servers[this.index].isOfficial},cssClass:"fullscreen"}).then(n=>{n.onDidDismiss().then(s=>{if(this.AddShortcut(),s.data)switch(s.data.type){case"image":let o=[];if(s.data.msg.content.content_related_creator&&(o=[...s.data.msg.content.content_related_creator]),s.data.msg.content.content_creator){let m=!1;for(let p=0,l=o.length;p<l;p++)if(o[p].user_id==s.data.msg.content.content_creator.user_id){m=!0;break}m||o.push(s.data.msg.content.content_creator)}return void this.modalCtrl.create({component:$.S,componentProps:{path:s.data.path||t.path,width:s.data.width,height:s.data.height,isDarkMode:s.data.isDarkMode},cssClass:"fullscreen"}).then(m=>{m.onDidDismiss().then(()=>{this.AddShortcut()}),m.onWillDismiss().then(function(){var p=(0,I.c)(function*(l){l.data&&(yield a.voidDraw_fileAct_callback(l,o))});return function(l){return p.apply(this,arguments)}}()),delete this.global.p5key.KeyShortCut.Escape,m.present()});case"text":this.selected_blobFile_callback_act(s.data.blob,s.data.contentRelated,"textedit")}}),delete this.global.p5key.KeyShortCut.Escape,n.present(),this.lock_modal_open=!1}))}postData(){var t=this;return(0,I.c)(function*(){if(!t.userInput.title)return t.p5toast.show({text:t.lang.text.AddPost.NeedPostTitle}),void t.TitleInput.focus();let a=!!t.userInput.server.local;if(!a)return void t.p5toast.show({text:"\uac8c\uc2dc\ubb3c \uc791\uc131 \uae30\ub2a5 \uc900\ube44\uc911"});let i=yield t.loadingCtrl.create({message:t.lang.text.AddPost.WIP});i.present(),t.isSaveClicked=!0;let n=t.userInput.server.isOfficial,s=t.userInput.server.target;if(delete t.userInput.server,t.isModify)yield t.nakama.RemovePost(t.userInput);else if(a){let l=Number(yield t.indexed.loadTextFromUserPath("servers/local/target/posts/counter.txt"))||0;t.userInput.id=`LocalPost_${l}`;try{yield t.indexed.saveTextFileToUserPath(`${l+1}`,"servers/local/target/posts/counter.txt")}catch(g){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${g}`}),console.log(g)}}else try{let l=yield t.nakama.servers[n][s].client.readStorageObjects(t.nakama.servers[n][s].session,{object_ids:[{collection:"server_post",key:"Counter",user_id:t.nakama.servers[n][s].session.user_id}]}),g=0;l.objects.length?(g=l.objects[0].value.counter,t.userInput.id=`ServerPost_${t.userInput.creator_id}_${g}`):t.userInput.id=`ServerPost_${t.userInput.creator_id}_${g}`,yield t.nakama.servers[n][s].client.writeStorageObjects(t.nakama.servers[n][s].session,[{collection:"server_post",key:"Counter",permission_write:1,permission_read:2,value:{counter:g+1}}])}catch(l){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${l}`}),console.log(l)}t.isModify?t.userInput.modify_time=(new Date).getTime():(t.userInput.create_time=(new Date).getTime(),t.userInput.modify_time=t.userInput.create_time);for(let l=0,g=t.userInput.attachments.length;l<g;l++)delete t.userInput.attachments[l].thumbnail;if(t.userInput.mainImage)if(i.message=t.lang.text.AddPost.SyncMainImage,a)try{t.userInput.mainImage.path=`servers/local/target/posts/${t.userInput.id}/${t.userInput.mainImage.filename}`,yield t.indexed.saveBlobToUserPath(t.userInput.mainImage.blob,t.userInput.mainImage.path)}catch(l){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${l}`}),console.log(l)}else console.log("\uc11c\ubc84 \ub300\ud45c\uc774\ubbf8\uc9c0 \uc800\uc7a5 \uc900\ube44\uc911");let o=t.userInput.attachments.length;if(o)if(i.message=t.lang.text.AddPost.SyncAttaches,a)for(let l=o-1;l>=0;l--)try{i.message=`${t.lang.text.AddPost.SyncAttaches}: [${l}]${t.userInput.attachments[l].filename}`,t.userInput.attachments[l].path=`servers/local/target/posts/${t.userInput.id}/[${l}]${t.userInput.attachments[l].filename}`,yield t.indexed.saveBlobToUserPath(t.userInput.attachments[l].blob,t.userInput.attachments[l].path)}catch(g){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${g}`}),console.log(g)}else console.log("\uc11c\ubc84 \ucca8\ubd80\ud30c\uc77c \uc800\uc7a5 \uc900\ube44\uc911");let m=JSON.parse(JSON.stringify(t.userInput));m.mainImage&&delete m.mainImage.blob;for(let l=m.attachments.length-1;l>=0;l--)delete m.attachments[l].blob;let p=JSON.stringify(m);if(a)try{if(t.userInput.mainImage){let l=URL.createObjectURL(t.userInput.mainImage.blob);t.userInput.mainImage.thumbnail=l,setTimeout(()=>{URL.revokeObjectURL(l)},100)}t.nakama.posts_orig.local.target.me[t.userInput.id]=t.userInput,t.nakama.rearrange_posts(),yield t.indexed.saveTextFileToUserPath(p,`servers/local/target/posts/${t.userInput.id}/info.json`)}catch(l){t.p5toast.show({text:`${t.lang.text.AddPost.SyncErr}: ${l}`}),console.log(l)}else{let l=new Blob([p],{type:"text/plain"}),g={filename:"info.txt"};g.blob=l,g.size=l.size,g.type="text/plain",g.file_ext="txt",g.typeheader="text",yield t.nakama.sync_save_file(g,n,s,"server_post",t.userInput.id)}i.dismiss(),t.navCtrl.navigateBack("portal/community")})()}ionViewWillLeave(){delete this.global.p5key.KeyShortCut.Escape,this.global.p5key.KeyShortCut.BottomTab=this.BottomTabShortcut,this.indexed.GetFileListFromDB("tmp_files/post").then(t=>t.forEach(a=>this.indexed.removeFileFromUserPath(a)))}}return(c=f).\u0275fac=function(t){return new(t||c)(e.GI1(E.A1),e.GI1(U.o),e.GI1(B.wX),e.GI1(j.h),e.GI1(h.qS),e.GI1(N.O),e.GI1(L.k),e.GI1(h.Kg),e.GI1(K.mI),e.GI1(Y._),e.GI1(h.iW),e.GI1(_.gV),e.GI1(_.E5))},c.\u0275cmp=e.In1({type:c,selectors:[["app-add-post"]],decls:30,vars:21,consts:[[3,"translucent"],[4,"ngIf"],["slot","start"],["defaultHref","portal/community"],[3,"fullscreen"],["id","p5Drop_addPost",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none"],["value","colors","expand","inset",3,"disabled","value","click",4,"ngIf"],["button","",3,"click"],[1,"additional_form","new_bg_form"],[1,"ion-text-end"],["style","width: 100%; text-align: center; text-align: -webkit-center; padding: 8px;",4,"ngIf"],["button",""],["id","add_post_title",3,"disabled","placeholder","ngModel","ngModelChange"],["id","add_post_content",1,"infobox",2,"height","50%",3,"disabled","placeholder","ngModel","ngModelChange"],["hidden","","type","file","id","add_post_input","accept","*","multiple","",3,"change"],["hidden","","type","file","id","PostMainImage_sel","accept","image/*",3,"change"],[2,"width","100%","text-align","center","padding-bottom","16px"],["style","display: inline-block;",4,"ngFor","ngForOf"],["button","",3,"id","disabled","click",4,"ngFor","ngForOf"],["button","",3,"disabled","click"],[1,"ion-text-center"],["value","colors","expand","inset",3,"disabled","value","click"],["accordionGroup",""],["value","colors"],["slot","header"],[1,"ion-text-right"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],["button","",3,"click",4,"ngFor","ngForOf"],[2,"width","100%","text-align","center","text-align","-webkit-center","padding","8px"],[2,"pointer-events","none",3,"ngModel","ngModelChange"],[2,"width","400px","padding-top","8px"],["alt","MainPostImage",1,"thumbnail_image",3,"src"],[2,"display","inline-block"],[1,"ext_button","ext_button_override",3,"hidden","click"],["slot","icon-only","style","width: 36px; height: 36px;",3,"name",4,"ngIf"],["class","ext_icon_img",3,"src","alt",4,"ngIf"],["slot","icon-only",2,"width","36px","height","36px",3,"name"],[1,"ext_icon_img",3,"src","alt"],["button","",3,"id","disabled","click"],[1,"additional_form","bg_img_form"],[1,"profile_img",3,"src"]],template:function(t,a){1&t&&(e.I0R(0,"ion-header",0)(1,"ion-toolbar"),e.yuY(2,W,2,1,"ion-title",1)(3,H,2,1,"ion-title",1),e.I0R(4,"ion-buttons",2),e.wR5(5,"ion-back-button",3),e.C$Y()()(),e.I0R(6,"ion-content",4),e.wR5(7,"div",5),e.yuY(8,V,11,5,"ion-accordion-group",6),e.I0R(9,"ion-item",7),e.qCj("click",function(){return a.go_to_profile()}),e.wR5(10,"div",8),e.I0R(11,"ion-label"),e.OEk(12),e.C$Y(),e.I0R(13,"ion-label",9),e.OEk(14),e.C$Y()(),e.I0R(15,"ion-item-divider")(16,"ion-label"),e.OEk(17),e.C$Y()(),e.yuY(18,J,6,5,"div",10),e.I0R(19,"ion-item",11)(20,"ion-input",12),e.iHE("ngModelChange",function(n){return e.kNx(a.userInput.title,n)||(a.userInput.title=n),n}),e.C$Y()(),e.I0R(21,"textarea",13),e.iHE("ngModelChange",function(n){return e.kNx(a.userInput.content,n)||(a.userInput.content=n),n}),e.C$Y(),e.I0R(22,"input",14),e.qCj("change",function(n){return a.inputFileSelected(n)}),e.C$Y(),e.I0R(23,"input",15),e.qCj("change",function(n){return a.ChangeMainPostImage(n)}),e.C$Y(),e.I0R(24,"div",16),e.yuY(25,Z,6,6,"div",17),e.C$Y(),e.yuY(26,q,5,4,"ion-item",18),e.I0R(27,"ion-item",19),e.qCj("click",function(){return a.postData()}),e.I0R(28,"ion-label",20),e.OEk(29),e.C$Y()()()),2&t&&(e.E7m("translucent",!0),e.yG2(2),e.E7m("ngIf",a.isModify),e.yG2(),e.E7m("ngIf",!a.isModify),e.yG2(3),e.E7m("fullscreen",!0),e.yG2(2),e.E7m("ngIf",a.servers.length),e.yG2(2),e.m_g("background-image: linear-gradient(to right, #0000, #"+a.userInput.UserColor+"44)"),e.yG2(2),e.cNF(a.lang.text.AddPost.Creator),e.yG2(2),e.cNF(a.userInput.creator_name||a.lang.text.Profile.noname_user),e.yG2(3),e.cNF(a.lang.text.AddPost.AddNewPost),e.yG2(),e.E7m("ngIf",a.MainPostImage),e.yG2(2),e.E7m("disabled",a.isSaveClicked)("placeholder",a.lang.text.AddPost.TitlePlaceholder),e.OKB("ngModel",a.userInput.title),e.yG2(),e.E7m("disabled",a.isSaveClicked)("placeholder",a.lang.text.AddPost.ContentPlaceHolder),e.OKB("ngModel",a.userInput.content),e.yG2(4),e.E7m("ngForOf",a.extended_buttons),e.yG2(),e.E7m("ngForOf",a.userInput.attachments),e.yG2(),e.E7m("disabled",a.isSaveClicked),e.yG2(2),e.cNF(a.lang.text.AddPost.Post))},dependencies:[C.ay,C.u_,b.ot,b.ue,b._G,h.cm,h.qU,h.GS,h._i,h.wB,h.Ko,h.A5,h.Yb,h.S8,h.QR,h.tM,h.E$,h.Md,h.UJ,h.qG,h.Im],styles:[".ext_button_override[_ngcontent-%COMP%]{margin:12px;cursor:pointer}.thumbnail_image[_ngcontent-%COMP%]{width:100%;max-height:240px;object-fit:cover;border-radius:16px}"]}),f})()}];let te=(()=>{var c;class f{}return(c=f).\u0275fac=function(t){return new(t||c)},c.\u0275mod=e.a4G({type:c}),c.\u0275inj=e.s3X({imports:[_.qQ.forChild(ee),_.qQ]}),f})(),ae=(()=>{var c;class f{}return(c=f).\u0275fac=function(t){return new(t||c)},c.\u0275mod=e.a4G({type:c}),c.\u0275inj=e.s3X({imports:[C.MD,b.y,h.wZ,te]}),f})()}}]);