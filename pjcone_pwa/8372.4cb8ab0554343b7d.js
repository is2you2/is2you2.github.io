"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8372],{8372:(Me,ge,p)=>{p.d(ge,{S:()=>xe});var X=p(1528),le=p(9352),R=p(5193),ee=p(7136),n=p(4496),ve=p(4500),x=p(5624),me=p(9240),Ce=p(5020),fe=p(4668),pe=p(3824),ye=p(4180);let be=(()=>{var y;class E{constructor(i){this.statusBar=i,this.list={},this.addresses=[]}initialize(i,t,c,e,o,h){if("DesktopPWA"!=R.s1&&"MobilePWA"!=R.s1){if(null!=this.list[i])return console.warn("\ub3d9\uc77c\ud55c \ud0a4\uc758 \uc11c\ubc84\uac00 \uc774\ubbf8 \uc874\uc7ac\ud568: ",this.list),void((!this.statusBar.tools[i]||"offline"==this.statusBar.tools[i])&&delete this.list[i]);this.statusBar.tools[i]="pending",this.list[i]={},this.list[i].users=[],this.list[i].server||(this.list[i].server=cordova.plugins.wsserver),this.check_addresses(i),this.list[i].server.start(t,{onFailure:(s,b,g)=>{this.onServerClose(i),this.stop(i)},onOpen:s=>{this.list[i].users.push(s.uuid),e(s)},onMessage:(s,b)=>{try{let g=JSON.parse(b);o(s,g)}catch(g){console.error(`Tool-server_json \ubcc0\ud658 \uc624\ub958_${b}: ${g}`)}},onClose:(s,b,g,v)=>{for(let I=this.list[i].users.length-1;I>=0;I--)if(this.list[i].users[I]==s.uuid){this.list[i].users.splice(I,1);break}h(s)},origins:[],protocols:[],tcpNoDelay:!0},(s,b)=>{this.statusBar.tools[i]="online",c&&c()},s=>{this.onServerClose(i),this.stop(i)})}else this.stop(i)}stop(i){"DesktopPWA"!=R.s1&&"MobilePWA"!=R.s1&&this.list[i]&&this.list[i].server.stop((t,c)=>{this.onServerClose(i),delete this.list[i]})}onServerClose(i){delete this.list[i].users,this.statusBar.tools[i]="missing",setTimeout(()=>{this.statusBar.tools[i]="offline"},1e3)}check_addresses(i){"DesktopPWA"!=R.s1&&"MobilePWA"!=R.s1&&(this.list[i].server||(this.list[i].server=cordova.plugins.wsserver),this.list[i].server.getInterfaces(t=>{this.addresses.length=0;let c=Object.keys(t);for(let e=0,o=c.length;e<o;e++)this.addresses=[...this.addresses,...t[c[e]].ipv4Addresses]}))}send_to(i,t,c){this.list[i].users.length&&this.list[i]&&this.list[i].server&&this.list[i].server.send({uuid:t},c)}}return(y=E).\u0275fac=function(i){return new(i||y)(n.CoB(ye.Y))},y.\u0275prov=n.wxM({token:y,factory:y.\u0275fac,providedIn:"root"}),E})();var De=p(8696),Se=p(1368);const ke=["RemoteDraw"];function Re(y,E){if(1&y&&(n.I0R(0,"ion-select-option",10),n.OEk(1),n.C$Y()),2&y){const B=E.$implicit;n.E7m("value",B),n.yG2(),n.cNF(B.info.name)}}let xe=(()=>{var y;class E{constructor(i,t,c,e,o,h,s,b,g,v,I){this.lang=i,this.modalCtrl=t,this.alertCtrl=c,this.loadingCtrl=e,this.global=o,this.navParams=h,this.indexed=s,this.nakama=b,this.p5toast=g,this.toolServer=v,this.webrtc=I,this.BackButtonPressed=!1,this.EventListenerAct=N=>{N.detail.register(130,M=>{this.ReadyToShareAct=!1,this.RemoteLoadingCtrl.dismiss(),this.toolServer.stop("RemoteDraw"),this.p5voidDraw.SetDrawable(!0),this.webrtc.close_webrtc(!1)})},this.isMobile=!1,this.isCropMode=!1,this.ServerList=[],this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.RemoteBackgroundImage="",this.WillLeaveHere=!1,this.WithoutSave=!0}InitBrowserBackButtonOverride(){window.history.replaceState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.modalCtrl.dismiss())}}ngOnInit(){this.InitBrowserBackButtonOverride()}ionViewDidEnter(){var i=this;return(0,X.c)(function*(){i.AddShortCut(),document.addEventListener("ionBackButton",i.EventListenerAct),i.mainLoading=yield i.loadingCtrl.create({message:i.lang.text.voidDraw.UseThisImage}),i.create_new_canvas({width:i.navParams.data.width,height:i.navParams.data.height,path:i.navParams.data.path}),i.isMobile="DesktopPWA"!=R.s1})()}AddShortCut(){this.p5voidDraw&&this.p5voidDraw.SetDrawable&&this.p5voidDraw.SetDrawable(!0),delete this.global.p5key.KeyShortCut.Digit,this.global.p5key.KeyShortCut.HistoryAct=i=>{switch(i){case"Z":this.p5voidDraw.history_act(-1);break;case"X":this.p5voidDraw.history_act(1);break;case"C":this.isCropMode?this.p5voidDraw.apply_crop():this.p5voidDraw.change_color();break;case"V":this.p5voidDraw.set_line_weight()}},this.global.p5key.KeyShortCut.AddAct=()=>{this.ClickRemoteAddButton()},this.global.p5key.KeyShortCut.SKeyAct=()=>{this.open_crop_tool()},this.global.p5key.KeyShortCut.DeleteAct=()=>{this.isCropMode?this.p5voidDraw.apply_crop():this.dismiss_draw()},this.global.p5key.KeyShortCut.FKeyAct=()=>{},this.global.p5key.KeyShortCut.Escape=()=>{this.isDrawServerCreated&&(this.ReadyToShareAct=!1,this.RemoteLoadingCtrl.dismiss(),this.toolServer.stop("RemoteDraw"),this.isDrawServerCreated=!1,this.p5voidDraw.SetDrawable(!0),this.webrtc.close_webrtc(!1))}}create_new_canvas(i){var t=this;return(0,X.c)(function*(){i.width=i.width||432,i.height=i.height||432,t.p5voidDraw&&t.p5voidDraw.remove(),t.create_p5voidDraw(i)})()}waiting(i){return new Promise(t=>setTimeout(()=>{t(void 0)},i))}create_p5voidDraw(i){var t=this;let c=document.getElementById("voidDraw");this.isCropMode=!1,this.p5voidDraw=new le(e=>{let o,h,s,b,g,v,I,N,M=e.createColorPicker("#000"),te=Math.min(i.width,i.height)/100,ie=1;e.setup=(0,X.c)(function*(){e.pixelDensity(1),e.noLoop(),e.noFill(),e.imageMode(e.CENTER),b=e.createCanvas(c.clientWidth,c.clientHeight),b.parent(c),_.x=e.width/2,_.y=e.height/2,e.set_line_weight=()=>{t.alertCtrl.create({header:t.lang.text.voidDraw.changeWeight,inputs:[{label:t.lang.text.voidDraw.weight,name:"weight",placeholder:`${ie}`,type:"number"}],buttons:[{text:t.lang.text.voidDraw.apply,handler:d=>{d.weight&&(ie=Number(d.weight))}}]}).then(d=>{O=!1,d.onWillDismiss().then(()=>{O=!0}),d.present()})},e.change_color=()=>{M.elt.click()},e.save_image=()=>{new le(d=>{d.setup=()=>{let W=d.createCanvas(o.width,o.height);d.pixelDensity(1),s&&d.image(s,0,0),o&&d.image(o,0,0);let $=W.elt.toDataURL("image/png").replace("image/png","image/octet-stream");t.modalCtrl.dismiss({name:`voidDraw_${d.year()}-${d.nf(d.month(),2)}-${d.nf(d.day(),2)}_${d.nf(d.hour(),2)}-${d.nf(d.minute(),2)}-${d.nf(d.second(),2)}.png`,img:$,loadingCtrl:t.mainLoading}),d.remove()}})},e.history_act=(d,W=!1)=>{switch(A=e.min(e.max(0,A+d),e.DrawingStack.length),d){case 1:e.DrawingStack.length&&(I.style.fill="var(--ion-color-dark)"),A==e.DrawingStack.length&&(N.style.fill="var(--ion-color-medium)"),K(o,e.DrawingStack[A-1]);break;case-1:e.DrawingStack.length&&(N.style.fill="var(--ion-color-dark)"),A<1?(I.style.fill="var(--ion-color-medium)",o.clear(255,255,255,255),e.redraw()):ce()}!W&&t.ReadyToShareAct&&t.webrtc.dataChannel.send(JSON.stringify({type:"same",act:"history_act",data:d}))},e.open_crop_tool=()=>{t.isCropMode?(t.isCropMode=!1,e.redraw()):(t.isCropMode=!0,u.x=o.width,u.y=o.height,P.x=0,P.y=0,e.redraw())},e.apply_crop=()=>{t.isMobile&&P.div(C),o.resizeCanvas(u.x,u.y),h=e.createVector(o.width/2,o.height/2),S.sub(P),ce(),s.resizeCanvas(u.x,u.y),s.push(),s.background(t.navParams.data.isDarkMode?26:255),s.translate(S),e.BaseImage&&s.image(e.BaseImage,0,0),s.pop(),s.redraw(),t.isCropMode=!1,e.SetCanvasViewportInit()},e.SetDrawable=Pe,g=e.createElement("table"),g.style("position: absolute; top: 0px;"),g.style(`width: 100%; height: ${k}px;`),g.style("background-color: var(--voidDraw-menu-background);"),g.parent(c);let a=g.elt.insertRow(0),r=a.insertCell(0);r.innerHTML='<ion-icon id="RemoteIcon" style="width: 27px; height: 27px" name="wifi-outline"></ion-icon>',r.style.textAlign="center",r.style.cursor="pointer",r.onclick=()=>{t.ClickRemoteAddButton()};let l=a.insertCell(1);l.innerHTML='<ion-icon style="width: 27px; height: 27px" name="crop"></ion-icon>',l.style.textAlign="center",l.style.cursor="pointer",l.onclick=()=>{t.open_crop_tool()};let D=a.insertCell(2);D.innerHTML='<ion-icon style="width: 27px; height: 27px" name="checkmark"></ion-icon>',D.style.textAlign="center",D.style.cursor="pointer",D.onclick=()=>{t.dismiss_draw()},v=e.createElement("table"),v.style("position: absolute; bottom: 0px;"),v.style(`width: 100%; height: ${k}px;`),v.style("background-color: var(--voidDraw-menu-background);"),v.parent(c);let T=v.elt.insertRow(0),V=T.insertCell(0);V.innerHTML='<ion-icon id="undoIcon" style="width: 27px; height: 27px" name="arrow-undo"></ion-icon>',I=document.getElementById("undoIcon"),I.style.fill="var(--ion-color-medium)",V.style.textAlign="center",V.style.cursor="pointer",V.onclick=()=>{t.p5voidDraw.history_act(-1)};let Z=T.insertCell(1);Z.innerHTML='<ion-icon id="redoIcon" style="width: 27px; height: 27px" name="arrow-redo"></ion-icon>',N=document.getElementById("redoIcon"),N.style.fill="var(--ion-color-medium)",Z.style.textAlign="center",Z.style.cursor="pointer",Z.onclick=()=>{t.p5voidDraw.history_act(1)};let H=T.insertCell(2);H.innerHTML='<ion-icon style="width: 27px; height: 27px" name="color-palette"></ion-icon>',M.style("width: 0px; height: 0px; opacity: 0;"),M.parent(H),M.elt.oninput=()=>{let d=M.color().levels,W=`#${e.hex(d[0],2)}${e.hex(d[1],2)}${e.hex(d[2],2)}`;H.childNodes[0].style.color=W},H.style.textAlign="center",H.style.cursor="pointer",H.onclick=()=>{M.elt.click()};let q=T.insertCell(3);if(q.innerHTML='<ion-icon style="width: 27px; height: 27px" name="pencil"></ion-icon>',q.style.textAlign="center",q.style.cursor="pointer",q.onclick=()=>{t.change_line_weight()},e.SetCanvasViewportInit=()=>{b.hide(),e.resizeCanvas(c.clientWidth,c.clientHeight),F.x=e.width/2,F.y=e.height/2,_.x=0,_.y=0;let d=c.clientHeight-112;C=c.clientWidth/d<o.width/o.height?c.clientWidth/o.width:d/o.height,b.show(),e.redraw()},o=e.createGraphics(i.width,i.height),h=e.createVector(o.width/2,o.height/2),o.pixelDensity(1),o.noLoop(),o.noFill(),e.ActualCanvas=o,s=e.createGraphics(i.width,i.height),s.pixelDensity(1),s.noLoop(),s.noFill(),s.background(t.navParams.data.isDarkMode?26:255),e.ImageCanvas=s,i.path){let d=yield t.indexed.loadBlobFromUserPath(i.path,""),W=URL.createObjectURL(d);e.loadImage(W,$=>{e.BaseImage=$,s.image(e.BaseImage,0,0),s.redraw(),URL.revokeObjectURL(W),e.SetCanvasViewportInit()},$=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",$),s.redraw(),URL.revokeObjectURL(W),e.SetCanvasViewportInit()})}else s.redraw(),e.SetCanvasViewportInit();i.width<i.height&&(te/=C),e.getCropPos=Ie,e.setCropPos=_e,e.RemoteDrawStart=Te,e.RemoteDrawing=We,e.RemoteDrawingEnd=Le,e.updateRemoteCurve=Ae});let _=e.createVector(),C=1,F=e.createVector(0,0),S=e.createVector(),P=e.createVector(),u=e.createVector(),Ie=()=>S,_e=(a,r)=>{S.x=a,S.y=r,o.translate(a,r),s.translate(a,r)};e.draw=()=>{if(e.clear(255,255,255,255),e.push(),e.translate(F),e.scale(C),e.translate(_),e.image(s,0,0),o&&e.image(o,0,0),this.isCropMode)e.push(),e.translate(-o.width/2,-o.height/2),e.translate(P),e.noStroke(),e.fill(0,100),e.rect(0,0,u.x,u.y),e.stroke(255,0,0),e.strokeWeight(8),e.beginShape(e.LINES),e.vertex(0,0),e.vertex(u.x,0),e.vertex(u.x,0),e.vertex(u.x,.8*u.y),e.vertex(0,0),e.vertex(0,u.y),e.vertex(0,u.y),e.vertex(.8*u.x,u.y),e.stroke(255,255,0),e.vertex(.8*u.x,u.y),e.vertex(u.x,u.y),e.vertex(u.x,.8*u.y),e.vertex(u.x,u.y),e.endShape(),e.pop();else{if(w&&w.pos&&w.pos.length){e.push(),e.translate(S),e.stroke(w.color),e.strokeWeight(w.weight),e.beginShape();for(let a=0,r=w.pos.length;a<r;a++)e.curveVertex(w.pos[a].x-h.x,w.pos[a].y-h.y);e.endShape(),e.pop()}if(this.ReadyToShareAct&&m&&m.pos&&m.pos.length){e.push(),e.translate(S),e.stroke(m.color),e.strokeWeight(m.weight),e.beginShape();for(let a=0,r=m.pos.length;a<r;a++)e.curveVertex(m.pos[a].x-h.x,m.pos[a].y-h.y);e.endShape(),e.pop()}}e.pop()},e.DrawingStack=[];let A=0,ce=()=>{o.clear(255,255,255,255);for(let a=0;a<A;a++)K(o,e.DrawingStack[a])},K=(a,r=w)=>{if(r.color){a.push(),a.translate(S),a.stroke(r.color),a.strokeWeight(r.weight),a.beginShape();for(let l=0,D=r.pos.length;l<D;l++)a.curveVertex(r.pos[l].x,r.pos[l].y);a.endShape(),a.pop(),a.redraw(),e.redraw()}},Ae=a=>{for(let r=0,l=a.length;r<l;r++)K(o,a[r]);A=e.DrawingStack.length};e.windowResized=()=>{setTimeout(()=>{e.SetCanvasViewportInit()},0)};let w={},m={},Te=a=>{m=a,e.redraw()},We=a=>{m&&m.pos&&m.pos.push(a),e.redraw()},Le=a=>{m.pos.push(a),m.pos.push(a),e.DrawingStack.length=A,m&&(e.DrawingStack.push(m),K(o,m)),A=e.DrawingStack.length,m=void 0,e.redraw()};const k=56;let ae,G,re,se,de,z,ne,oe=0,j=!1,L=!1;e.mousePressed=a=>{if(O){if(e.mouseY<k||e.mouseY>e.height-k)return void(L=!0);switch(a.which){case 1:this.isCropMode?he():we();break;case 3:G=e.createVector(e.mouseX,e.mouseY),z=_.copy(),ae=e.createVector(e.mouseX,e.mouseY);break;case 2:e.SetCanvasViewportInit()}}};let he=(a,r)=>{let l=Y(a,r),D=P.copy().add(u).sub(e.createVector(o.width/2,o.height/2)),T=l.dist(D),V=.2*e.max(u.x,u.y);j=T<V,j?(se=e.createVector(e.mouseX,e.mouseY),ne=u.copy()):re=e.createVector(e.mouseX,e.mouseY).sub(P.mult(C))},we=(a,r)=>{I.style.fill="var(--ion-color-dark)",N.style.fill="var(--ion-color-medium)";let l=Y(a,r);l.sub(S),l.add(h);let D={x:l.x,y:l.y},T=M.color().levels,V=`#${e.hex(T[0],2)}${e.hex(T[1],2)}${e.hex(T[2],2)}`;w={pos:[],color:V,weight:te*ie},w.pos.push(D),w.pos.push(D),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"start",data:w})),e.redraw()};e.mouseDragged=a=>{if(O)switch(a.which){case 1:if(this.isCropMode&&!L){let r=e.createVector(e.mouseX,e.mouseY);j?u=ne.copy().add(se.copy().sub(r).div(-C)):P=re.copy().sub(r).div(-C),e.redraw()}else{let r=Y();r.sub(S),r.add(h);let l={x:r.x,y:r.y};w&&w.pos&&w.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:l})),e.redraw()}break;case 3:ae=e.createVector(e.mouseX,e.mouseY),_=z.copy().add(ae.sub(G).div(C)),e.redraw()}},e.mouseWheel=a=>{O&&(e.mouseY<k||e.mouseY>e.height-k?L=!0:(Oe(Y()),C*=a.deltaY<0?1.1:.9,e.redraw()))},e.mouseReleased=a=>{if(O){if(1===a.which&&!this.isCropMode&&!L){let r=Y();r.sub(S),r.add(h);let l={x:r.x,y:r.y};if(w)try{w.pos.push(l),w.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:l}))}catch{}ue()}L=!1}};let Oe=a=>{F=e.createVector(e.mouseX,e.mouseY),_=a.mult(-1)},Y=(a,r)=>{let l=e.createVector(a||e.mouseX,r||e.mouseY);return l.sub(F),l.div(C),l.sub(_),l},f=[],J=!1,O=!0,Pe=a=>{O=a};e.touchStarted=a=>{if(O){if(f=a.touches,a.changedTouches[0].clientY<k||a.changedTouches[0].clientY>e.height-k)return void(L=!0);switch(J=!0,f.length){case 1:this.isCropMode?he(a.changedTouches[0].clientX,a.changedTouches[0].clientY-k):we(a.changedTouches[0].clientX,a.changedTouches[0].clientY-k);break;case 2:let r=e.createVector(f[0].clientX,f[0].clientY-56),l=e.createVector(f[1].clientX,f[1].clientY-56);oe=r.dist(l),G=r.copy().add(l).div(2),z=_.copy(),de=C,w=void 0;break;default:J=!1,e.SetCanvasViewportInit()}}},e.touchMoved=a=>{if(O&&J){switch(f=a.touches,f.length){case 1:if(this.isCropMode&&!L){let r=e.createVector(a.changedTouches[0].clientX,a.changedTouches[0].clientY-k);j?u=ne.copy().add(se.copy().sub(r).div(-C)):P=re.copy().sub(r).div(-C),e.redraw()}else{let r=Y(a.changedTouches[0].clientX,a.changedTouches[0].clientY-k);r.sub(S),r.add(h);let l={x:r.x,y:r.y};w&&w.pos&&w.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"moved",data:l})),e.redraw()}break;case 2:{let r=e.createVector(f[0].clientX,f[0].clientY-56),l=e.createVector(f[1].clientX,f[1].clientY-56),D=r.copy().add(l).div(2);C=r.dist(l)/oe*de,_=z.copy().add(D.sub(G).div(C)),e.redraw()}}return!1}},e.touchEnded=a=>{if(O&&a.changedTouches){switch(f=a.touches,J=!1,f.length){case 0:if(!this.isCropMode&&!L&&w){let r=Y(a.changedTouches[0].clientX,a.changedTouches[0].clientY-k);r.sub(S),r.add(h);let l={x:r.x,y:r.y};w.pos.push(l),w.pos.push(l),this.ReadyToShareAct&&this.webrtc.dataChannel.send(JSON.stringify({type:"draw",act:"end",data:l})),ue()}break;case 1:if(!J)return;Be(),oe=0,w=void 0}L=!1}};let Be=()=>{G=e.createVector(f[0].clientX,f[0].clientY-56),z=_.copy()},ue=()=>{e.DrawingStack.length=A,w&&(e.DrawingStack.push(w),K(o,w)),A=e.DrawingStack.length,G=void 0,L=!1,w=void 0,e.redraw()}})}ClickRemoteAddButton(){this.isDrawServerCreated||(this.ServerList=this.nakama.get_all_online_server(),this.ServerList.length?(this.p5voidDraw.SetDrawable(!1),this.RemoteDraw.open()):this.RemoteBridgeServerSelected({detail:{value:"local"}}))}RemoteBridgeServerSelected(i){var t=this;return(0,X.c)(function*(){if(t.isDrawServerCreated)return;let c=i.detail.value;if("local"===c)if("DesktopPWA"==R.s1||"MobilePWA"==R.s1){let h;t.alertCtrl.create({header:t.lang.text.voidDraw.LocalAddrInput,inputs:[{type:"text",placeholder:"0.0.0.0"}],buttons:[{text:t.lang.text.voidDraw.Confirm,handler:s=>{t.p5voidDraw.SetDrawable(!1),s[0]?(h=!0,t.loadingCtrl.create({message:`${t.lang.text.voidDraw.WaitingConnection}: ${s[0]}`}).then(b=>{t.RemoteLoadingCtrl=b,t.RemoteLoadingCtrl.present(),t.IceWebRTCWsClient=new WebSocket(`ws://${s[0]}:12012/`),t.AddShortCut(),t.isDrawServerCreated=!0,t.IceWebRTCWsClient.onopen=()=>{t.p5toast.show({text:`${t.lang.text.voidDraw.Connected}: ${s[0]}`});let g=t.p5voidDraw.getCropPos();t.IceWebRTCWsClient.send(JSON.stringify({type:"size",width:t.p5voidDraw.ActualCanvas.width,height:t.p5voidDraw.ActualCanvas.height,cropX:g.x,cropY:g.y}))},t.IceWebRTCWsClient.onmessage=g=>{let v=JSON.parse(g.data);switch(v.type){case"init":t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Init,t.webrtc.initialize("data").then(()=>{t.IceWebRTCWsClient.send(JSON.stringify({type:"socket_react",act:"WEBRTC_INIT_REQ_SIGNAL"})),t.CreateOnOpenAct(),t.CreateOnMessageLink()});break;case"socket_react":switch(v.act){case"WEBRTC_REPLY_INIT_SIGNAL":t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Reply,t.nakama.socket_reactive[v.act](v.data_str),"EOL"==v.data_str&&(t.webrtc.CreateAnswer(t.IceWebRTCWsClient),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Ice);break;case"WEBRTC_ICE_CANDIDATES":t.nakama.socket_reactive[v.act](v.data_str,t.IceWebRTCWsClient),b.dismiss(),t.IceWebRTCWsClient.send(JSON.stringify({type:"init_end"}))}break;default:console.log("\uc9c0\uc815\ub418\uc9c0 \uc54a\uc740 \uc815\ubcf4: ",v)}},t.IceWebRTCWsClient.onerror=g=>{console.log("\uadf8\ub9bc\ud310 \uae30\ub2a5 \uacf5\uc720 \uc5f0\uacb0 \uc624\ub958: ",g),t.IceWebRTCWsClient.close()},t.IceWebRTCWsClient.onclose=()=>{t.webrtc.close_webrtc(!1)}})):t.p5toast.show({text:t.lang.text.voidDraw.InputAddress})}}]}).then(s=>{s.onDidDismiss().then(()=>{!h&&!t.WillLeaveHere&&t.AddShortCut()}),t.RemoveShortCut(),s.present()})}else t.RemoteLoadingCtrl=yield t.loadingCtrl.create({message:t.lang.text.voidDraw.WaitingConnection}),t.RemoteLoadingCtrl.present(),t.p5voidDraw.SetDrawable(!1),t.toolServer.initialize("RemoteDraw",12012,()=>{t.isDrawServerCreated=!0,t.CreateOnOpenActSimple()},h=>{t.p5toast.show({text:`${t.lang.text.voidDraw.Connected}: ${h.remoteAddr}`})},(h,s)=>{switch(s.type){case"size":t.create_new_canvas({width:s.width,height:s.height}),t.p5voidDraw.setCropPos(s.cropX,s.cropY),t.p5voidDraw.redraw(),t.webrtc.initialize("data").then(()=>{t.CreateOnOpenActSimple(),t.CreateOnMessageLink(),t.webrtc.CreateOffer(),t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Init,t.toolServer.send_to("RemoteDraw",t.toolServer.list.RemoteDraw.users[0],JSON.stringify({type:"init"}))});break;case"socket_react":switch(s.act){case"WEBRTC_INIT_REQ_SIGNAL":t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Reply,t.nakama.socket_reactive[s.act]({server:t.toolServer,target:"RemoteDraw",user:t.toolServer.list.RemoteDraw.users[0]});break;case"WEBRTC_RECEIVE_ANSWER":t.RemoteLoadingCtrl.message=t.lang.text.voidDraw.WebRTC_Ice,t.nakama.socket_reactive[s.act](s.data_str,{server:t.toolServer,target:"RemoteDraw",user:t.toolServer.list.RemoteDraw.users[0]})}break;case"init_end":t.p5voidDraw.SetDrawable(!0),t.RemoteLoadingCtrl.dismiss();break;default:console.log("\uc815\ubcf4 \uc9c0\uc815\ub418\uc9c0 \uc54a\uc74c:",s)}},h=>{t.toolServer.stop("RemoteDraw"),t.webrtc.close_webrtc(!1)});else{t.RemoteLoadingCtrl=yield t.loadingCtrl.create({message:t.lang.text.voidDraw.WaitingConnection}),t.RemoteLoadingCtrl.present();let e=c.info.isOfficial,o=c.info.target;if(t.webrtc.CurrentMatch=t.nakama.self_match[e][o],t.isDrawServerCreated=!0,"DesktopPWA"==R.s1||"MobilePWA"==R.s1){let h=t.p5voidDraw.getCropPos();yield t.nakama.servers[e][o].socket.sendMatchState(t.nakama.self_match[e][o].match_id,ee.i.VOIDDRAW_INIT,encodeURIComponent(JSON.stringify({type:"size",width:t.p5voidDraw.ActualCanvas.width,height:t.p5voidDraw.ActualCanvas.height,cropX:h.x,cropY:h.y}))),yield t.webrtc.initialize("data",void 0,{isOfficial:e,target:o}),t.CreateOnOpenAct(),t.CreateOnMessageLink(),yield t.nakama.servers[e][o].socket.sendMatchState(t.nakama.self_match[e][o].match_id,ee.i.WEBRTC_INIT_REQ_SIGNAL,encodeURIComponent("")),t.webrtc.InitReplyCallback=()=>{t.webrtc.CreateAnswer(),t.p5voidDraw.SetDrawable(!0)}}else t.nakama.VoidDrawInitCallBack=h=>{t.create_new_canvas({width:h.width,height:h.height}),t.p5voidDraw.setCropPos(h.cropX,h.cropY),t.p5voidDraw.redraw()},t.webrtc.initialize("data",void 0,{isOfficial:e,target:o}).then(()=>{t.CreateOnOpenActSimple(),t.CreateOnMessageLink(),t.webrtc.CreateOffer(),t.p5voidDraw.SetDrawable(!0)})}})()}CreateOnOpenAct(){var i=this;this.webrtc.dataChannelOpenAct=()=>{this.ReadyToShareAct=!0,this.RemoteLoadingCtrl.dismiss(),this.webrtc.dataChannel.send(JSON.stringify({type:"drawline",data:this.p5voidDraw.DrawingStack})),this.navParams.data.path&&this.indexed.loadBlobFromUserPath(this.navParams.data.path,"",function(){var t=(0,X.c)(function*(c){let o=(yield i.global.GetBase64ThroughFileReader(c)).match(/(.{1,64})/g);for(let h=0,s=o.length;h<s;h++)yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"part",data:o[h]}));yield i.webrtc.dataChannel.send(JSON.stringify({type:"background",act:"EOF"}))});return function(c){return t.apply(this,arguments)}}())}}CreateOnOpenActSimple(){this.webrtc.dataChannelOpenAct=()=>{this.ReadyToShareAct=!0,this.RemoteLoadingCtrl.dismiss()}}CreateOnMessageLink(){this.webrtc.dataChannelOnMsgAct=i=>{let t=JSON.parse(i);switch(t.type){case"drawline":this.p5voidDraw.DrawingStack=t.data,this.p5voidDraw.updateRemoteCurve(t.data),this.p5voidDraw.redraw();break;case"background":switch(t.act){case"part":this.RemoteBackgroundImage+=t.data;break;case"EOF":this.p5voidDraw.loadImage(this.RemoteBackgroundImage,c=>{this.p5voidDraw.BaseImage=c,this.p5voidDraw.ImageCanvas.image(this.p5voidDraw.BaseImage,0,0),this.p5voidDraw.ImageCanvas.redraw(),this.p5voidDraw.SetCanvasViewportInit(),this.RemoteBackgroundImage=""},c=>{console.error("\uadf8\ub9bc\ud310 \ubc30\uacbd \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc624\ub958: ",c),this.p5voidDraw.ImageCanvas.redraw(),this.p5voidDraw.SetCanvasViewportInit(),this.RemoteBackgroundImage=""})}break;case"draw":switch(t.act){case"start":this.p5voidDraw.RemoteDrawStart(t.data);break;case"moved":this.p5voidDraw.RemoteDrawing(t.data);break;case"end":this.p5voidDraw.RemoteDrawingEnd(t.data)}break;case"same":"history_act"===t.act&&this.p5voidDraw.history_act(t.data,!0)}},this.webrtc.dataChannelOnCloseAct=()=>{this.ReadyToShareAct=!1,this.isDrawServerCreated=!1,this.RemoteLoadingCtrl.dismiss(),this.p5voidDraw.SetDrawable(!0),this.p5toast.show({text:this.lang.text.TodoDetail.Disconnected}),this.nakama.VoidDrawInitCallBack=void 0}}change_line_weight(){this.p5voidDraw.set_line_weight()}open_crop_tool(){this.p5voidDraw.open_crop_tool()}dismiss_draw(){this.isCropMode?this.p5voidDraw.apply_crop():(this.mainLoading.present(),this.WithoutSave=!1,this.p5voidDraw.save_image())}ionSelectCancel(){this.p5voidDraw&&this.p5voidDraw.SetDrawable&&!this.isDrawServerCreated&&this.p5voidDraw.SetDrawable(!0)}RemoveShortCut(){this.p5voidDraw&&this.p5voidDraw.SetDrawable&&this.p5voidDraw.SetDrawable(!1),delete this.global.p5key.KeyShortCut.HistoryAct,delete this.global.p5key.KeyShortCut.AddAct,delete this.global.p5key.KeyShortCut.DeleteAct,delete this.global.p5key.KeyShortCut.SKeyAct,delete this.global.p5key.KeyShortCut.FKeyAct,delete this.global.p5key.KeyShortCut.Escape}ionViewWillLeave(){this.WillLeaveHere=!0,this.RemoveShortCut(),this.p5voidDraw&&this.p5voidDraw.remove(),this.toolServer.stop("RemoteDraw"),this.IceWebRTCWsClient&&this.IceWebRTCWsClient.close(),this.isDrawServerCreated=!1,this.ReadyToShareAct=!1,this.toolServer.stop("RemoteDraw"),this.RemoteLoadingCtrl.dismiss(),this.webrtc.close_webrtc(!1)}ionViewDidLeave(){document.removeEventListener("ionBackButton",this.EventListenerAct),this.WithoutSave&&this.mainLoading.remove()}}return(y=E).\u0275fac=function(i){return new(i||y)(n.GI1(ve.o),n.GI1(x.qS),n.GI1(x.iW),n.GI1(x.Kg),n.GI1(Ce.A1),n.GI1(me.a6),n.GI1(fe.k),n.GI1(ee.h),n.GI1(pe.O),n.GI1(be),n.GI1(De.C))},y.\u0275cmp=n.In1({type:y,selectors:[["app-void-draw"]],viewQuery:function(i,t){if(1&i&&n.CC$(ke,5),2&i){let c;n.wto(c=n.Gqi())&&(t.RemoteDraw=c.first)}},decls:14,vars:4,consts:[[1,"ion-no-border"],["slot","start",3,"click"],["defaultHref",""],["oncontextmenu","return false;"],["hidden",""],["value","local",3,"label","ionChange","ionCancel"],["RemoteDraw",""],["value","local"],[3,"value",4,"ngFor","ngForOf"],["id","voidDraw",1,"full_screen",2,"display","flex","overflow","hidden","background-color","black"],[3,"value"]],template:function(i,t){1&i&&(n.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),n.OEk(3),n.C$Y(),n.I0R(4,"ion-buttons",1),n.qCj("click",function(){return t.modalCtrl.dismiss()}),n.wR5(5,"ion-back-button",2),n.C$Y()()(),n.I0R(6,"ion-content",3)(7,"div",4)(8,"ion-select",5,6),n.qCj("ionChange",function(e){return t.RemoteBridgeServerSelected(e)})("ionCancel",function(){return t.ionSelectCancel()}),n.I0R(10,"ion-select-option",7),n.OEk(11),n.C$Y(),n.yuY(12,Re,2,2,"ion-select-option",8),n.C$Y()(),n.wR5(13,"div",9),n.C$Y()),2&i&&(n.yG2(3),n.cNF(t.lang.text.ChatRoom.voidDraw),n.yG2(5),n.E7m("label",t.lang.text.voidDraw.ConnectToAddress),n.yG2(3),n.cNF(t.lang.text.voidDraw.InternalConn),n.yG2(),n.E7m("ngForOf",t.ServerList))},dependencies:[Se.ay,x.GS,x._i,x.wB,x.Cy,x.gd,x.tM,x.Md,x.IT,x.Im]}),E})()}}]);