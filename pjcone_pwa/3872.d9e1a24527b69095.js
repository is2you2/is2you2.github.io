"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3872],{3872:(xe,G,I)=>{I.r(G),I.d(G,{AddTodoMenuPageModule:()=>ve});var A=I(1368),v=I(4716),f=I(5624),T=I(3332),b=I(1528),k=I(9352),$=I(3664),w=I(7136),D=I(5193),O=I(8372),S=I(4120),R=I(9373),E=I(7048),P=I(4712),t=I(4496),F=I(9240),N=I(4500),L=I(3824),Y=I(4476),j=I(4668),U=I(6819),B=I(4180),W=I(5020);const K=["StartCalendar"],J=["Calendar"],z=["NewAttach"],Q=["StoreAt"],q=["ImporantSel"];function H(u,_){if(1&u&&(t.I0R(0,"ion-select-option",43),t.OEk(1),t.C$Y()),2&u){const o=_.$implicit;t.E7m("value",o),t.yG2(),t.oRS("",o.name," ")}}function V(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-item",38),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.StoreAtSelClicked())}),t.I0R(1,"ion-select",39,40),t.qCj("ionChange",function(i){t.usT(o);const r=t.GaO();return t.CGJ(r.StoreAtSelChanged(i))}),t.I0R(3,"ion-select-option",41),t.OEk(4),t.C$Y(),t.yuY(5,H,2,2,"ion-select-option",42),t.C$Y()()}if(2&u){const o=t.GaO();t.yG2(),t.E7m("label",o.lang.text.TodoDetail.StoreAt),t.yG2(3),t.cNF(o.lang.text.TodoDetail.OnThisDevice),t.yG2(),t.E7m("ngForOf",o.AvailableStorageList)}}function X(u,_){if(1&u&&(t.I0R(0,"div")(1,"ion-item")(2,"ion-label",44),t.OEk(3),t.C$Y(),t.I0R(4,"ion-label",45),t.OEk(5),t.C$Y()()()),2&u){const o=t.GaO();t.yG2(3),t.cNF(o.userInput.display_store||o.lang.text.TodoDetail.WIP),t.yG2(2),t.cNF(o.userInput.display_creator)}}function Z(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-grid",46)(1,"ion-row")(2,"ion-col",47)(3,"ion-item",48),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.doneTodo())}),t.I0R(4,"ion-label",49),t.OEk(5),t.C$Y()()()()()}if(2&u){const o=t.GaO();t.yG2(3),t.E7m("disabled",o.isButtonClicked),t.yG2(2),t.cNF(o.lang.text.TodoDetail.TodoComplete)}}function ee(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-icon",50),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.SpeechToTitleText())}),t.C$Y()}}function te(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-item")(1,"ion-checkbox",53),t.iHE("ngModelChange",function(i){const a=t.usT(o).$implicit;return t.kNx(a.todo_checked,i)||(a.todo_checked=i),t.CGJ(i)}),t.OEk(2),t.C$Y()()}if(2&u){const o=_.$implicit;t.yG2(),t.OKB("ngModel",o.todo_checked),t.yG2(),t.cNF(o.display_name)}}function ie(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-accordion",43)(1,"ion-item",25)(2,"ion-label"),t.OEk(3),t.C$Y()(),t.I0R(4,"div",28)(5,"ion-item",14),t.qCj("click",function(){const r=t.usT(o).$implicit,a=t.GaO(2);return t.CGJ(a.toggle_all_user(r.id))}),t.I0R(6,"ion-label"),t.OEk(7),t.C$Y()(),t.yuY(8,te,3,2,"ion-item",32),t.C$Y()()}if(2&u){const o=_.$implicit,e=t.GaO(2);t.E7m("value",o.id),t.yG2(3),t.cNF(o.name),t.yG2(4),t.cNF(e.lang.text.TodoDetail.ToggleWorkers),t.yG2(),t.E7m("ngForOf",e.AvailableWorker[o.id])}}function ae(u,_){if(1&u&&(t.I0R(0,"div")(1,"ion-accordion-group",null,51)(3,"ion-accordion")(4,"ion-item",25)(5,"ion-label"),t.OEk(6),t.C$Y()(),t.I0R(7,"div",28)(8,"ion-accordion-group",null,52),t.yuY(10,ie,9,4,"ion-accordion",42),t.C$Y()()()()()),2&u){const o=t.GaO();t.yG2(6),t.cNF(o.lang.text.TodoDetail.ManageWorker),t.yG2(4),t.E7m("ngForOf",o.WorkerGroups)}}function ne(u,_){if(1&u&&(t.I0R(0,"div",61),t.OEk(1),t.C$Y()),2&u){const o=t.GaO().$implicit;t.yG2(),t.cNF(o.displayTime)}}function oe(u,_){1&u&&t.wR5(0,"ion-icon",62)}function re(u,_){1&u&&t.wR5(0,"ion-icon",63)}function se(u,_){1&u&&t.wR5(0,"ion-icon",64)}function le(u,_){if(1&u&&(t.I0R(0,"ion-item",56)(1,"ion-label"),t.OEk(2),t.C$Y(),t.yuY(3,ne,2,1,"div",57)(4,oe,1,0,"ion-icon",58)(5,re,1,0,"ion-icon",59)(6,se,1,0,"ion-icon",60),t.C$Y()),2&u){const o=_.$implicit;t.yG2(2),t.cNF(o.name),t.yG2(),t.E7m("ngIf",o.displayTime),t.yG2(),t.E7m("ngIf",void 0===o.isDelete),t.yG2(),t.E7m("ngIf",1==o.isDelete),t.yG2(),t.E7m("ngIf",0==o.isDelete)}}function ue(u,_){if(1&u&&(t.I0R(0,"div")(1,"ion-accordion-group",null,51)(3,"ion-accordion")(4,"ion-item",25)(5,"ion-label"),t.OEk(6),t.C$Y(),t.I0R(7,"ion-label",54),t.OEk(8),t.C$Y()(),t.I0R(9,"div",28),t.yuY(10,le,7,5,"ion-item",55),t.C$Y()()()()),2&u){const o=t.GaO();t.yG2(6),t.cNF(o.lang.text.TodoDetail.ManageWorker),t.yG2(2),t.cNF(o.worker_done+" / "+o.userInput.workers.length),t.yG2(2),t.E7m("ngForOf",o.userInput.workers)}}function de(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-accordion",65)(1,"ion-item",25)(2,"ion-label"),t.OEk(3),t.C$Y(),t.I0R(4,"ion-label",26),t.OEk(5),t.C$Y(),t.wR5(6,"ion-icon",27),t.C$Y(),t.I0R(7,"div",28)(8,"ion-datetime",29,66),t.qCj("ionChange",function(i){t.usT(o);const r=t.GaO();return t.CGJ(r.start_change(i))}),t.C$Y()()()}if(2&u){const o=t.GaO();t.yG2(3),t.cNF(o.lang.text.TodoDetail.startFrom),t.yG2(2),t.cNF(o.startDisplay||o.lang.text.TodoDetail.startImmediatly),t.yG2(3),t.E7m("locale",o.lang.lang)}}function ce(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-item-divider")(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"ion-icon",50),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.SpeechToDetailText())}),t.C$Y()()}if(2&u){const o=t.GaO();t.yG2(2),t.cNF(o.lang.text.TodoDetail.description)}}function me(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-button",38),t.qCj("click",function(){t.usT(o);const i=t.GaO().index,r=t.GaO();return t.CGJ(r.remove_attach(i))}),t.OEk(1),t.C$Y()}if(2&u){const o=t.GaO(2);t.yG2(),t.oRS(" ",o.lang.text.ChatRoom.Delete," ")}}function he(u,_){if(1&u){const o=t.KQA();t.I0R(0,"img",70),t.qCj("contextmenu",function(){t.usT(o);const i=t.GaO(2),r=i.$implicit,a=i.index,d=t.GaO();return t.CGJ(d.AttachmentContextMenu(r,a))}),t.C$Y()}if(2&u){const o=t.GaO(2).$implicit;t.E7m("src",o.thumbnail,t.K6U)("alt",o.filename)}}function pe(u,_){if(1&u&&(t.I0R(0,"ion-item",71)(1,"ion-label",44),t.OEk(2),t.C$Y()()),2&u){const o=t.GaO(3);t.yG2(2),t.cNF(o.lang.text.TodoDetail.open_content_viewer)}}function _e(u,_){if(1&u){const o=t.KQA();t.I0R(0,"div",38),t.qCj("click",function(){t.usT(o);const i=t.GaO().index,r=t.GaO();return t.CGJ(r.open_content_viewer(i))}),t.yuY(1,he,1,2,"img",68)(2,pe,3,1,"ion-item",69),t.C$Y()}if(2&u){const o=t.GaO().$implicit;t.yG2(),t.E7m("ngIf",o.thumbnail),t.yG2(),t.E7m("ngIf",!o.thumbnail)}}function ge(u,_){if(1&u&&(t.I0R(0,"div")(1,"ion-item")(2,"ion-label",67),t.OEk(3),t.C$Y(),t.yuY(4,me,2,1,"ion-button",9),t.C$Y(),t.yuY(5,_e,3,2,"div",9),t.C$Y()),2&u){const o=_.$implicit,e=t.GaO();t.yG2(3),t.cNF(o.filename),t.yG2(),t.E7m("ngIf",e.isModifiable),t.yG2(),t.E7m("ngIf",o.viewer)}}function fe(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-label",82),t.qCj("click",function(){t.usT(o);const i=t.GaO(2);return t.CGJ(i.toggle_custom_attach())}),t.OEk(1),t.C$Y()}if(2&u){const o=t.GaO(2);t.yG2(),t.cNF(o.DisplayDBSelectedName)}}function Ie(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-icon",83),t.qCj("click",function(){t.usT(o);const i=t.GaO(2);return t.CGJ(i.toggle_custom_attach())}),t.C$Y()}if(2&u){const o=t.GaO(2);t.E7m("name",o.DisplayDBSelector)}}function ye(u,_){if(1&u){const o=t.KQA();t.I0R(0,"ion-item",14),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.open_select_new())}),t.I0R(1,"ion-label"),t.OEk(2),t.C$Y(),t.I0R(3,"ion-item",72)(4,"ion-select",73,74),t.qCj("ionChange",function(i){t.usT(o);const r=t.GaO();return t.CGJ(r.new_attach(i))})("ionDismiss",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.AddShortCut())}),t.I0R(6,"ion-select-option",75),t.OEk(7),t.C$Y(),t.I0R(8,"ion-select-option",76),t.OEk(9),t.C$Y(),t.I0R(10,"ion-select-option",77),t.OEk(11),t.C$Y(),t.I0R(12,"ion-select-option",78),t.OEk(13),t.C$Y(),t.I0R(14,"ion-select-option",79),t.OEk(15),t.C$Y()()(),t.yuY(16,fe,2,1,"ion-label",80)(17,Ie,1,1,"ion-icon",81),t.C$Y()}if(2&u){const o=t.GaO();t.yG2(2),t.cNF(o.lang.text.TodoDetail.attachments),t.yG2(2),t.E7m("label",o.lang.text.TodoDetail.new_attach)("cancelText",o.lang.text.GlobalAct.CancelText),t.yG2(3),t.cNF(o.lang.text.GlobalAct.FromCamera),t.yG2(2),t.cNF(o.lang.text.TodoDetail.new_draw),t.yG2(2),t.cNF(o.lang.text.TodoDetail.new_text),t.yG2(2),t.cNF(o.lang.text.TodoDetail.user_fs),t.yG2(2),t.cNF(o.lang.text.TodoDetail.add_attach),t.yG2(),t.E7m("ngIf",o.isCDNToggleAvailable),t.yG2(),t.E7m("ngIf",o.isCDNToggleAvailable)}}function be(u,_){if(1&u){const o=t.KQA();t.I0R(0,"td")(1,"ion-button",84),t.qCj("click",function(){t.usT(o);const i=t.GaO();return t.CGJ(i.deleteData())}),t.OEk(2),t.C$Y()()}if(2&u){const o=t.GaO();t.yG2(),t.E7m("disabled",o.isButtonClicked),t.yG2(),t.oRS(" ",o.lang.text.TodoDetail.remove," ")}}const ke=[{path:"",component:(()=>{var u;class _{constructor(e,i,r,a,d,c,n,l,s,m,h,g,p,y){this.route=e,this.router=i,this.modalCtrl=r,this.lang=a,this.p5toast=d,this.sanitizer=c,this.indexed=n,this.nakama=l,this.alertCtrl=s,this.noti=m,this.statusBar=h,this.loadingCtrl=g,this.global=p,this.navCtrl=y,this.userInput={id:void 0,storeAt:"local",display_store:"",title:void 0,create_at:void 0,written:void 0,startFrom:void 0,limit:void 0,custom_color:void 0,workers:void 0,importance:"0",description:void 0,remote:void 0,display_creator:void 0,attach:[],done:void 0,noti_id:void 0},this.isMobile=!1,this.BackButtonPressed=!1,this.buttonDisplay={saveTodo:this.lang.text.TodoDetail.buttonDisplay_add},this.AmICreator=!0,this.isModify=!1,this.isModifiable=!1,this.isStoreAtChanged=!1,this.isStoreAtChangable=!0,this.isLimitUsable=!1,this.normal_color="#8888",this.alert_color="#0bb8",this.AlertLerpStartFrom=.8,this.input_ele_ids=[],this.file_sel_id="",this.AvailableStorageList=[],this.isManager=!1,this.AvailableWorker={},this.WorkerGroups=[],this.toggle_logs={},this.worker_done=0,this.lock_modal_open=!1,this.useFirstCustomCDN=0,this.isCDNToggleClicked=!1,this.isCDNToggleAvailable=!0,this.isButtonClicked=!1,this.WillLeavePage=!1}ngOnInit(){var e=this;if(window.history.pushState(null,null,window.location.href),window.onpopstate=()=>{this.BackButtonPressed||(this.BackButtonPressed=!0,this.navCtrl.back())},this.MainDiv=document.getElementById("main_div"),this.isMobile="Android"==D.s1||"iOS"==D.s1,this.route.queryParams.subscribe(i=>{const r=this.router.getCurrentNavigation().extras.state;r&&(this.received_data=r.data),this.received_data&&(this.userInput={...this.userInput,...JSON.parse(this.received_data)})}),this.nakama.AddTodoLinkAct=function(){var i=(0,b.c)(function*(r){e.p5timer&&e.p5timer.remove(),e.received_data=r,e.userInput=JSON.parse(e.received_data),yield e.ionViewWillEnter(),e.show_count_timer()});return function(r){return i.apply(this,arguments)}}(),this.nakama.AddTodoManageUpdateAct=(i,r,a,d)=>{if(this.userInput.id==i)for(let c=0,n=this.userInput.workers.length;c<n;c++)if((this.userInput.workers[c].user_id||this.userInput.workers[c].id)==r){this.userInput.workers[c].isDelete=a,this.userInput.workers[c].timestamp=d,this.userInput.workers[c].displayTime=new Date(d).toLocaleString(),this.worker_done++;break}},"DesktopPWA"==D.s1&&setTimeout(()=>{this.CreateDrop()},0),this.userInput.workers)for(let i=0,r=this.userInput.workers.length;i<r;i++)this.userInput.workers[i].timestamp&&(this.userInput.workers[i].displayTime=new Date(this.userInput.workers[i].timestamp).toLocaleString(),this.worker_done++);this.nakama.StatusBarChangedCallback=()=>{if(this.isModify){if(this.LoadStorageList(),this.userInput.remote)try{let i=!1;for(let r=0,a=this.AvailableStorageList.length;r<a;r++)if(this.AvailableStorageList[r].type==`${this.userInput.remote.isOfficial}/${this.userInput.remote.target}`){i=!0;break}this.isModifiable=i,this.userInput.display_creator=i?this.nakama.load_other_user(this.userInput.remote.creator_id,this.userInput.remote.isOfficial,this.userInput.remote.target).display_name:this.lang.text.TodoDetail.Disconnected}catch{}}else this.LoadStorageList()}}CreateDrop(){var e=this;let i=document.getElementById("p5Drop_todo");this.p5canvas=new k(r=>{r.setup=()=>{let a=r.createCanvas(i.clientWidth,i.clientHeight);a.parent(i),r.pixelDensity(.1),a.drop(function(){var d=(0,b.c)(function*(c){yield e.selected_blobFile_callback_act(c.file)});return function(c){return d.apply(this,arguments)}}())},r.mouseMoved=a=>{a.dataTransfer?(i.style.pointerEvents="all",i.style.backgroundColor="#0008"):(i.style.pointerEvents="none",i.style.backgroundColor="transparent")}})}selected_blobFile_callback_act(e){var i=this;return(0,b.c)(function*(){let r=yield i.loadingCtrl.create({message:i.lang.text.TodoDetail.WIP});r.present();let a={};a.filename=e.name,a.file_ext=e.name.substring(e.name.lastIndexOf(".")+1),a.size=e.size,a.type=e.type,a.path=`tmp_files/todo/${a.filename}`,a.blob=e,a.content_related_creator=[{timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"loaded"}],a.content_creator={timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"loaded"},yield i.checkHasSameFileAndRename(a),i.global.set_viewer_category(a);let d=URL.createObjectURL(e);"image"==a.viewer&&(a.thumbnail=i.sanitizer.bypassSecurityTrustUrl(d));try{yield i.indexed.saveBlobToUserPath(e,a.path),i.userInput.attach.push(a),setTimeout(()=>{URL.revokeObjectURL(d)},0),r.dismiss()}catch(c){console.error("\ud30c\uc77c \uc62c\ub9ac\uae30 \uc2e4\ud328: ",c),i.p5toast.show({text:i.lang.text.TodoDetail.load_failed}),r.dismiss()}i.auto_scroll_down()})()}checkHasSameFileAndRename(e){var i=this;return(0,b.c)(function*(){let r=!1;if(r=yield i.indexed.checkIfFileExist(e.path),i.userInput.id&&!r)try{r=yield i.indexed.checkIfFileExist(`todo/${i.userInput.id}_${i.userInput.remote.isOfficial}_${i.userInput.remote.target}/${e.filename}`)}catch{r=yield i.indexed.checkIfFileExist(`todo/${i.userInput.id}/${e.filename}`)}r&&(e.filename=`${e.filename.substring(0,e.filename.lastIndexOf("."))}_.${e.file_ext}`,e.path=`tmp_files/todo/${e.filename}`,yield i.checkHasSameFileAndRename(e))})()}AttachmentContextMenu(e,i){var r=this;let a=URL.createObjectURL(e.blob);return new k(d=>{d.setup=()=>{d.noCanvas(),d.loadImage(a,c=>{let n=[];if(e.content_related_creator&&(n=[...e.content_related_creator]),e.content_creator){let l=!1;for(let s=0,m=n.length;s<m;s++)if(void 0!==n[s].user_id&&void 0!==e.content_creator.user_id&&n[s].user_id==e.content_creator.user_id){l=!0;break}l||n.push(e.content_creator)}this.modalCtrl.create({component:O.S,componentProps:{path:e.alt_path||e.path,width:c.width,height:c.height},cssClass:"fullscreen"}).then(l=>{this.removeShortCut(),l.onDidDismiss().then(s=>{this.AddShortCut()}),l.onWillDismiss().then(function(){var s=(0,b.c)(function*(m){m.data&&r.voidDraw_fileAct_callback(m,n,i,!0)});return function(m){return s.apply(this,arguments)}}()),l.present()}),URL.revokeObjectURL(a),d.remove()},c=>{console.log("\ube60\ub978 \ud3b8\uc9d1\uae30 \uc774\ub3d9 \uc2e4\ud328: ",c),URL.revokeObjectURL(a),d.remove()})}}),!1}ionViewWillEnter(){var e=this;return(0,b.c)(function*(){let i;if(e.LoadStorageList(),e.received_data){if(e.buttonDisplay.saveTodo=e.lang.text.TodoDetail.buttonDisplay_modify,i=JSON.parse(e.received_data),e.userInput={...e.userInput,...i},e.isModify=!0,"local"==e.userInput.storeAt)e.StoreAt.value="local";else for(let n=0,l=e.AvailableStorageList.length;n<l;n++)if(e.userInput.remote.isOfficial==e.AvailableStorageList[n].isOfficial&&e.userInput.remote.target==e.AvailableStorageList[n].target){e.StoreAt.value=e.AvailableStorageList[n];break}}else e.userInput.limit=(new Date).getTime(),e.limitTimeP5Display=e.userInput.limit,e.AvailableStorageList.length&&(e.StoreAt.value=e.AvailableStorageList[0].target,e.StoreAtSelChanged({detail:{value:e.AvailableStorageList[0]}}));let r=document.getElementById("titleInput");e.titleIonInput=r.children[0].children[1].children[0],setTimeout(()=>{!e.isModify&&!e.checkIfInputFocus()&&e.titleIonInput.focus()},200),e.ImporantSelChanged({detail:{value:e.userInput.importance}}),e.file_sel_id=`${e.userInput.id||"new_todo_id"}_${(new Date).getTime()}`;let a=!1;try{a=yield e.indexed.checkIfFileExist(`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/thumbnail.png`)}catch{a=yield e.indexed.checkIfFileExist(`todo/${e.userInput.id}/thumbnail.png`)}if(e.userInput.attach.length)for(let n=0,l=e.userInput.attach.length;n<l;n++){let s=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});try{if(e.userInput.remote){if(s.present(),e.userInput.attach[n].url?e.userInput.attach[n].thumbnail=e.userInput.attach[n].url:(e.userInput.attach[n].alt_path=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/${e.userInput.attach[n].filename}`,e.userInput.attach[n].blob=(yield e.nakama.sync_load_file(e.userInput.attach[n],e.userInput.remote.isOfficial,e.userInput.remote.target,"todo_attach",e.userInput.remote.creator_id)).value),!a&&"image"==e.userInput.attach[n].viewer){let h=e.userInput.attach[n].url;e.userInput.attach[n].blob&&(h=URL.createObjectURL(e.userInput.attach[n].blob)),yield new Promise(g=>{new k(p=>{p.setup=()=>{p.noCanvas(),p.loadImage(h,y=>{y.width>y.height?y.resize(y.width/y.height*128,128):y.resize(128,y.height/y.width*128);let x=p.createCanvas(128,128);x.hide(),p.smooth(),p.pixelDensity(1),p.image(y,-(y.width-128)/2,-(y.height-128)/2);let M,Te=x.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{M=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/thumbnail.png`}catch{M=`todo/${e.userInput.id}/thumbnail.png`}e.indexed.saveBase64ToUserPath(Te,M,De=>{e.global.p5todo&&e.global.p5todo.add_todo&&e.global.p5todo.add_todo(JSON.stringify(e.userInput)),g()}),e.userInput.attach[n].blob&&URL.revokeObjectURL(h),p.remove()},y=>{console.error("Todo-\ub4f1\ub85d\ub41c \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",y),g(),e.userInput.attach[n].blob&&URL.revokeObjectURL(h),p.remove()})}})})}}else{if("image"!=e.userInput.attach[n].viewer&&"text"!=e.userInput.attach[n].viewer)throw"\ubc88\uc678 \uc378\ub124\uc77c \ud544\uc694";e.userInput.attach[n].blob=yield e.indexed.loadBlobFromUserPath(e.userInput.attach[n].path,e.userInput.attach[n].type)}if(!e.userInput.attach[n].blob)continue;let m=URL.createObjectURL(e.userInput.attach[n].blob);e.global.modulate_thumbnail(e.userInput.attach[n],m)}catch{e.global.modulate_thumbnail(e.userInput.attach[n],"")}s.dismiss(),e.userInput.attach[n].exist=!0}try{if("local"==e.userInput.storeAt)e.isModify||(e.StoreAt.value=e.userInput.storeAt),e.userInput.display_store=e.lang.text.TodoDetail.OnThisDevice,e.userInput.display_creator=e.lang.text.TodoDetail.WrittenByMe,e.isModifiable=!0;else if(e.userInput.remote){if(e.isModify||(e.StoreAt.value=e.userInput.remote),e.userInput.display_store=e.userInput.remote.name,e.userInput.display_creator=e.lang.text.TodoDetail.Disconnected,!e.nakama.servers[e.userInput.remote.isOfficial]||!e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target])throw e.userInput.display_creator=e.lang.text.TodoDetail.DeletedServer,{text:"Server Deleted",isModifiable:!0};if(e.statusBar.groupServer[e.userInput.remote.isOfficial]&&"online"!=e.statusBar.groupServer[e.userInput.remote.isOfficial][e.userInput.remote.target])throw e.isStoreAtChangable=!1,{text:"Server disconnected",isModifiable:!1};"online"==e.statusBar.groupServer[e.userInput.remote.isOfficial][e.userInput.remote.target]&&(e.isModifiable=!0),e.userInput.remote.creator_id&&(e.AmICreator=e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].session.user_id==e.userInput.remote.creator_id),e.userInput.display_creator=e.AmICreator?e.lang.text.TodoDetail.WrittenByMe:e.nakama.load_other_user(e.userInput.remote.creator_id,e.userInput.remote.isOfficial,e.userInput.remote.target).display_name,e.userInput.remote.group_id&&(e.isModifiable="online"==e.nakama.groups[e.userInput.remote.isOfficial][e.userInput.remote.target][e.userInput.remote.group_id].status)}}catch(n){e.isModifiable=n.isModifiable,console.log("Server issue: ",n)}e.noti.Current=e.userInput.id;let d=new Date(e.userInput.limit);if(e.Calendar.value=new Date(d.getTime()-60*d.getTimezoneOffset()*1e3).toISOString(),i&&(e.limitTimeP5Display=new Date(i.limit).getTime()),e.userInput.startFrom){let n=new Date(e.userInput.startFrom);e.startDisplay=n.toLocaleString(e.lang.lang),e.startDisplay=e.startDisplay.substring(0,e.startDisplay.lastIndexOf(":"))}if(e.limit_change({detail:{value:e.userInput.limit}}),e.userInput.workers)for(let n=0,l=e.userInput.workers.length;n<l;n++){try{e.userInput.workers[n].name=e.nakama.load_other_user(e.userInput.workers[n].id,e.userInput.remote.isOfficial,e.userInput.remote.target).display_name}catch{}e.userInput.workers[n].timestamp&&(e.userInput.workers[n].displayTime=new Date(e.userInput.workers[n].timestamp).toLocaleString())}document.getElementById("descInput").onpaste=n=>{let l=[];for(const s of n.clipboardData.files)s.type.startsWith("image/")&&l.push({file:s});if(l.length){for(let s=0,m=l.length;s<m;s++)e.selected_blobFile_callback_act(l[s].file);return!1}},e.useFirstCustomCDN=Number(localStorage.getItem("useFFSCDN"))||0,e.toggle_custom_attach(e.useFirstCustomCDN)})()}LoadStorageList(){let e=[];Object.keys(this.nakama.servers).forEach(a=>{Object.keys(this.nakama.servers[a]).forEach(c=>{"online"==this.statusBar.groupServer[a][c]&&e.push({name:`${this.nakama.servers[a][c].info.name}`,isOfficial:a,target:c,type:`${a}/${c}`})})}),[...e].forEach(a=>{this.AvailableStorageList.push(a)})}ionViewDidEnter(){this.show_count_timer(),this.AddShortCut()}AddShortCut(){this.NewAttach&&(!this.NewAttach.value&&!this.WillLeavePage&&setTimeout(()=>{delete this.global.p5key.KeyShortCut.Digit,this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()},this.global.p5key.KeyShortCut.AddAct=()=>{this.checkIfInputFocus()||this.open_select_new()}},0),this.NewAttach.value="")}removeShortCut(){delete this.global.p5key.KeyShortCut.Escape,delete this.global.p5key.KeyShortCut.AddAct,delete this.global.p5key.KeyShortCut.Digit}start_change(e){this.userInput.startFrom=e.detail.value,this.startDisplay=new Date(e.detail.value).toLocaleString(this.lang.lang),this.startDisplay=this.startDisplay.substring(0,this.startDisplay.lastIndexOf(":")),this.startTimeP5Display=new Date(this.userInput.startFrom).getTime()}limit_change(e){this.userInput.limit=e.detail.value;let i=new Date(e.detail.value);i.getTime()<=Date.now()?this.limitDisplay=this.lang.text.TodoDetail.NoDeadLine:(this.limitDisplay=i.toLocaleString(this.lang.lang),this.limitDisplay=this.limitDisplay.substring(0,this.limitDisplay.lastIndexOf(":"))),this.limitTimeP5Display=new Date(this.userInput.limit).getTime(),this.startTimeP5Display=Date.now(),this.isLimitUsable=this.limitTimeP5Display>this.startTimeP5Display}remove_attach(e){this.userInput.attach.splice(e,1)}show_count_timer(){this.p5timer=new k(e=>{let i=0;this.startTimeP5Display=this.userInput.startFrom||this.userInput.written?new Date(this.userInput.startFrom||this.userInput.written).getTime():(new Date).getTime(),this.startTimeP5Display=e.min(this.startTimeP5Display,this.limitTimeP5Display);let r,a=e.color(this.normal_color);e.setup=()=>{let s=document.getElementById("p5timer"),m=e.createCanvas(s.clientWidth,s.clientHeight);m.id("timer"),m.style("position","inherit"),m.style("width","100%"),m.style("height","100%"),m.parent(s),e.noStroke()};let d=0,c=()=>{r=(new Date).getTime(),d=this.limitTimeP5Display<r?1:e.map(r,this.startTimeP5Display,this.limitTimeP5Display,0,1,!0),d<=this.AlertLerpStartFrom?a=e.color(this.userInput.custom_color?this.userInput.custom_color+"88":this.normal_color):d>this.AlertLerpStartFrom&&(a=this.userInput.custom_color?e.color(this.userInput.custom_color+"88"):e.lerpColor(e.color(this.normal_color),e.color(this.alert_color),e.map(d,this.AlertLerpStartFrom,1,0,1)*i))};e.draw=()=>{c(),e.clear(255,255,255,255),e.push(),e.fill(a),i<1?(i+=.04,i>=1&&(i=1),e.rect(0,0,e.lerp(0,e.width,d*n(i)),e.height)):e.rect(0,0,e.lerp(0,e.width,d),e.height),e.pop()};let n=s=>l(e.sq(l(s))),l=s=>1-s})}from_camera(){var e=this;return(0,b.c)(function*(){try{const i=yield S.Ut.getPhoto({quality:90,resultType:S.on.Base64,source:S._8.Camera});let r=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});r.present();let a={};a.filename=`Camera_${(new Date).toLocaleString().replace(/[:|.|\/]/g,"_")}.${i.format}`,a.file_ext=i.format,a.base64="data:image/jpeg;base64,"+i.base64String,a.thumbnail=e.sanitizer.bypassSecurityTrustUrl(a.base64),a.type=`image/${i.format}`,a.typeheader="image",a.content_related_creator=[{timestamp:(new Date).getTime(),display_name:e.nakama.users.self.display_name,various:"camera"}],a.content_creator={timestamp:(new Date).getTime(),display_name:e.nakama.users.self.display_name,various:"camera"},a.path=`tmp_files/todo/${a.filename}`,a.viewer="image";let c=yield e.indexed.saveBase64ToUserPath(a.base64,a.path);a.blob=new Blob([c],{type:a.type}),a.size=a.blob.size,r.dismiss(),e.userInput.attach.push(a)}catch{}})()}open_select_new(){if(this.isCDNToggleClicked)return;delete this.global.p5key.KeyShortCut.Escape,delete this.global.p5key.KeyShortCut.AddAct;let e=["camera","image","inapp","load"];this.global.p5key.KeyShortCut.Digit=i=>{this.checkIfInputFocus()||(delete this.global.p5key.KeyShortCut.Digit,e.length>i&&this.new_attach({detail:{value:e[i]}}))},this.NewAttach&&this.NewAttach.open()}checkIfInputFocus(){this.input_ele_ids.length||(this.input_ele_ids.push(this.titleIonInput),this.input_ele_ids.push(document.getElementById("descInput")));let e=!1;for(let i=0,r=this.input_ele_ids.length;i<r;i++)if(document.activeElement==this.input_ele_ids[i]){e=!0;break}return e}new_attach(e){var i=this;return(0,b.c)(function*(){switch(e.detail.value){case"camera":yield i.from_camera(),i.AddShortCut(),i.auto_scroll_down(100);break;case"text":let r=new Date,m=`texteditor_${r.getUTCFullYear()}-${("0"+(r.getMonth()+1)).slice(-2)}-${("0"+r.getDate()).slice(-2)}_${("0"+r.getHours()).slice(-2)}-${("0"+r.getMinutes()).slice(-2)}-${("0"+r.getSeconds()).slice(-2)}.txt`;i.modalCtrl.create({component:$.K,componentProps:{info:{content:{is_new:"text",type:"text/plain",viewer:"text",filename:m}},no_edit:!0}}).then(h=>{i.removeShortCut(),h.onWillDismiss().then(g=>{if(g.data){let p={};p.content_creator={timestamp:(new Date).getTime(),display_name:i.nakama.users.self.display_name,various:"textedit"},p.content_related_creator=[],p.content_related_creator.push(p.content_creator),p.blob=g.data.blob,p.path=g.data.path,p.size=g.data.blob.size,p.filename=g.data.blob.name||m,p.file_ext=p.filename.split(".").pop(),p.type="text/plain",p.viewer="text",i.userInput.attach.push(p),i.auto_scroll_down()}}),h.onDidDismiss().then(()=>{i.AddShortCut()}),h.present()});break;case"image":i.modalCtrl.create({component:O.S,cssClass:"fullscreen"}).then(h=>{i.removeShortCut(),h.onWillDismiss().then(function(){var g=(0,b.c)(function*(p){p.data&&i.voidDraw_fileAct_callback(p)});return function(p){return g.apply(this,arguments)}}()),h.onDidDismiss().then(()=>{i.AddShortCut()}),h.present()});break;case"inapp":i.modalCtrl.create({component:E.w}).then(h=>{h.onWillDismiss().then(function(){var g=(0,b.c)(function*(p){p.data&&i.selected_blobFile_callback_act(p.data)});return function(p){return g.apply(this,arguments)}}()),h.onDidDismiss().then(()=>{i.AddShortCut()}),h.present()});break;case"load":i.select_attach(),i.AddShortCut()}})()}select_attach(){document.getElementById(this.file_sel_id).click()}inputImageSelected(e){var i=this;return(0,b.c)(function*(){if(e.target.files.length){for(let a=0,d=e.target.files.length;a<d;a++)yield i.selected_blobFile_callback_act(e.target.files[a]);document.getElementById(i.file_sel_id).value=""}})()}StoreAtSelClicked(){this.StoreAt.open()}StoreAtSelChanged(e){this.isStoreAtChanged=!0;let i=e.detail.value;"local"==i?(this.userInput.storeAt="local",this.userInput.remote=void 0,this.isManager=!1,this.userInput.workers=void 0):(this.userInput.storeAt=i.type,this.userInput.remote=i,this.userInput.workers=[],this.nakama.servers[i.isOfficial][i.target].client.getAccount(this.nakama.servers[i.isOfficial][i.target].session).then(r=>{let a=JSON.parse(r.user.metadata);if(this.WorkerGroups.length=0,this.AvailableWorker={},a.is_admin)this.nakama.servers[i.isOfficial][i.target].client.rpc(this.nakama.servers[i.isOfficial][i.target].session,"query_all_groups",{}).then(d=>{let c=d.payload;for(let n=0,l=c.length;n<l;n++){this.AvailableWorker[c[n].id]||(this.AvailableWorker[c[n].id]=[]);for(let s=0,m=c[n].users.length;s<m;s++){let h=this.nakama.load_other_user(c[n].users[s].user.user_id,i.isOfficial,i.target);delete h.todo_checked,h.email||this.AvailableWorker[c[n].id].push(h)}this.AvailableWorker[c[n].id].length?this.WorkerGroups.push({id:c[n].id,name:c[n].name}):delete this.AvailableWorker[c[n].id]}this.isManager=!0});else if(a.is_manager){for(let d=a.is_manager.length-1;d>=0;d--)try{let c=this.nakama.groups[i.isOfficial][i.target][a.is_manager[d]];this.AvailableWorker[c.id]||(this.AvailableWorker[c.id]=[]);for(let n=0,l=c.users.length;n<l;n++){if(!c.users[n].user.user_id&&!c.users[n].user.id||(c.users[n].user.user_id||c.users[n].user.id)==this.nakama.servers[i.isOfficial][i.target].session.user_id)continue;let s=this.nakama.load_other_user(c.users[n].user.user_id||c.users[n].user.id,i.isOfficial,i.target);delete s.todo_checked,(s.id||s.user_id)!=this.nakama.servers[i.isOfficial][i.target].session.user_id&&s.display_name&&this.AvailableWorker[c.id].push(s)}this.AvailableWorker[c.id].length?this.WorkerGroups.push({id:c.id,name:c.name}):delete this.AvailableWorker[c.id]}catch{a.is_manager.splice(d,1)}this.isManager=a.is_manager.length,this.isManager||delete a.is_manager,this.nakama.servers[i.isOfficial][i.target].client.rpc(this.nakama.servers[i.isOfficial][i.target].session,"update_user_metadata_fn",{user_id:this.nakama.servers[i.isOfficial][i.target].session.user_id,metadata:a}).catch(d=>{})}})),this.toggle_custom_attach(this.useFirstCustomCDN)}toggle_all_user(e){this.toggle_logs[e]=!this.toggle_logs[e];for(let i=0,r=this.AvailableWorker[e].length;i<r;i++)this.AvailableWorker[e][i].todo_checked=this.toggle_logs[e]}ImporantSelClicked(){this.ImporantSel.open()}ImporantSelChanged(e){switch(this.userInput.importance=e.detail.value,this.userInput.importance){case"0":this.normal_color="#888b",this.alert_color="#58a19288",this.AlertLerpStartFrom=.8;break;case"1":this.normal_color="#888b",this.alert_color="#ddbb4188",this.AlertLerpStartFrom=.5;break;case"2":this.normal_color="#dddd0c88",this.alert_color="#b9543788",this.AlertLerpStartFrom=.4}}SpeechToTitleText(){var e=this;return(0,b.c)(function*(){yield P.G.requestAudioRecordingPermission();let i=yield R.I.start({language:e.lang.lang,maxResults:1,prompt:e.lang.text.ChatRoom.TalkMessage,partialResults:!0,popup:!0});e.userInput.title=i.matches[0]})()}SpeechToDetailText(){var e=this;return(0,b.c)(function*(){yield P.G.requestAudioRecordingPermission();let i=yield R.I.start({language:e.lang.lang,maxResults:1,prompt:e.lang.text.ChatRoom.TalkMessage,partialResults:!0,popup:!0});e.userInput.description?e.userInput.description+="\n":e.userInput.description="",e.userInput.description+=i.matches[0]})()}toggle_custom_color(){this.userInput.custom_color?this.userInput.custom_color=void 0:(document.getElementById("TodoCustomColorInput").click(),this.userInput.custom_color="#ff0000")}open_content_viewer(e){if(this.lock_modal_open)return;this.lock_modal_open=!0;let i=[];for(let r=0,a=this.userInput.attach.length;r<a;r++)i.push({content:this.userInput.attach[r]});this.modalCtrl.create({component:$.K,componentProps:{info:{content:this.userInput.attach[e]},path:this.userInput.attach[e].alt_path||this.userInput.attach[e].path,relevance:i,noEdit:!this.isModifiable},cssClass:"fullscreen"}).then(r=>{this.removeShortCut(),r.onDidDismiss().then(a=>{if(this.lock_modal_open=!1,this.AddShortCut(),a.data)switch(a.data.type){case"image":let d=[];if(this.userInput.attach[a.data.index].content_related_creator&&(d=[...this.userInput.attach[a.data.index].content_related_creator]),this.userInput.attach[a.data.index].content_creator){let c=!1;for(let n=0,l=d.length;n<l;n++)if(void 0!==d[n].user_id&&void 0!==this.userInput.attach[a.data.index].content_creator.user_id&&d[n].user_id==this.userInput.attach[a.data.index].content_creator.user_id){c=!0;break}c||d.push(this.userInput.attach[a.data.index].content_creator)}return delete this.userInput.attach[a.data.index].exist,void this.modalCtrl.create({component:O.S,componentProps:{path:a.data.path||this.userInput.attach[a.data.index].alt_path||this.userInput.attach[a.data.index].path,width:a.data.width,height:a.data.height,text:a.data.text},cssClass:"fullscreen"}).then(c=>{this.removeShortCut(),c.onWillDismiss().then(n=>{n.data&&("image"===a.data.msg.content.viewer?this.voidDraw_fileAct_callback(n,d,a.data.index,!0):this.voidDraw_fileAct_callback(n,d,a.data.index))}),c.onDidDismiss().then(n=>{this.AddShortCut()}),c.present()});case"text":this.userInput.attach[a.data.index].content_related_creator.push(this.userInput.attach[a.data.index].content_creator),this.userInput.attach[a.data.index].content_creator={timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"textedit"},this.userInput.attach[a.data.index].blob=a.data.blob,this.userInput.attach[a.data.index].path=a.data.path,this.userInput.attach[a.data.index].size=a.data.blob.size,this.userInput.attach[a.data.index].filename=a.data.blob.name||this.userInput.attach[a.data.index].filename,delete this.userInput.attach[a.data.index].exist}}),this.noti.Current="IonicViewerPage",r.present()})}auto_scroll_down(e=0){setTimeout(()=>{this.MainDiv.scrollTo({top:this.MainDiv.scrollHeight,behavior:"smooth"})},e)}voidDraw_fileAct_callback(e,i,r,a=!1){let d;try{if(!a)throw"not overwrite";d={},this.userInput.attach[r]=d}catch{d={},this.userInput.attach.push(d)}d.filename=e.data.name,d.file_ext="png",d.type="image/png",d.viewer="image",i?(d.content_related_creator=i,d.content_creator={timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}):(d.content_related_creator=[{timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}],d.content_creator={timestamp:(new Date).getTime(),display_name:this.nakama.users.self.display_name,various:"voidDraw"}),d.thumbnail=this.sanitizer.bypassSecurityTrustUrl(e.data.img),d.path=`tmp_files/todo/${d.filename}`,this.indexed.saveBase64ToUserPath(e.data.img,"tmp_files/todo/attach.jpeg",c=>{let n=new Blob([c],{type:d.type});d.blob=new File([n],e.data.name),d.size=d.blob.size}),this.indexed.saveBase64ToUserPath(e.data.img,d.path,c=>{e.data.loadingCtrl.dismiss()}),this.auto_scroll_down(100)}doneTodo(){this.isButtonClicked=!0,this.nakama.doneTodo(this.userInput)}toggle_custom_attach(e){var i=this;return(0,b.c)(function*(){switch(i.isCDNToggleClicked=!0,i.useFirstCustomCDN=(null!=e?e:i.useFirstCustomCDN+1)%(i.userInput.remote?3:2),"Android"==D.s1&&(i.useFirstCustomCDN=2,i.isCDNToggleAvailable=!1),i.useFirstCustomCDN){case 0:i.DisplayDBSelector="cloud-offline-outline",i.DisplayDBSelectedName=i.lang.text.ChatRoom.Detour;break;case 1:i.DisplayDBSelector="cloud-done-outline",i.DisplayDBSelectedName=i.lang.text.ChatRoom.useFSS;break;case 2:i.DisplayDBSelector="server-outline",i.DisplayDBSelectedName=i.lang.text.ChatRoom.forceSQL}localStorage.setItem("useFFSCDN",`${i.useFirstCustomCDN}`),setTimeout(()=>{i.isCDNToggleClicked=!1},0)})()}saveData(){var e=this;return(0,b.c)(function*(){if(!e.userInput.title)return void e.p5toast.show({text:e.lang.text.TodoDetail.needDisplayName});e.isButtonClicked=!0;let i=!!e.userInput.attach.length;if(delete e.userInput.display_store,delete e.userInput.display_creator,JSON.stringify(e.userInput)==e.received_data)return void e.navCtrl.pop();e.userInput.create_at||(e.userInput.create_at=(new Date).getTime());let a=e.received_data?JSON.parse(e.received_data):void 0;if(e.isStoreAtChanged&&e.isModify){for(let n=0,l=a.attach.length;n<l;n++){let s=a.attach[n].filename,m=yield e.indexed.loadBlobFromUserPath(a.attach[n].path,a.attach[n].type),h=`tmp_files/todo/${s}`;yield e.indexed.saveBlobToUserPath(m,h),e.userInput.attach[n].path=h,e.userInput.attach[n].blob=m,delete e.userInput.attach[n].exist}yield e.nakama.deleteTodoFromStorage(!0,a),e.isModify=!1}if(!e.userInput.id||!e.isModify)if(e.userInput.remote){let n=yield e.nakama.getRemoteTodoCounter(e.userInput.remote.isOfficial,e.userInput.remote.target);e.userInput.id=`RemoteTodo_${n}`}else e.userInput.id=new Date(e.userInput.create_at).toISOString().replace(/[:|.|\/]/g,"_");e.userInput.noti_id&&(e.isMobile||(clearTimeout(e.nakama.web_noti_id[e.userInput.noti_id]),delete e.nakama.web_noti_id[e.userInput.noti_id]),e.nakama.removeRegisteredId(e.userInput.noti_id),e.noti.ClearNoti(e.userInput.noti_id)),e.userInput.noti_id=e.nakama.get_noti_id(),e.nakama.set_todo_notification(e.userInput);let c,d=!1;if(!e.isModify&&e.userInput.workers){e.userInput.workers.length=0;let n=Object.keys(e.AvailableWorker),l=[];for(let s=0,m=n.length;s<m;s++)for(let h=0,g=e.AvailableWorker[n[s]].length;h<g;h++){let p=e.AvailableWorker[n[s]][h].id||e.AvailableWorker[n[s]][h].user_id;e.AvailableWorker[n[s]][h].todo_checked&&!l.includes(p)&&(e.userInput.workers.push({id:p,name:e.nakama.load_other_user(p,e.userInput.remote.isOfficial,e.userInput.remote.target).display_name}),l.push(p))}e.userInput.workers.length||(e.userInput.workers=void 0)}try{a.attach.forEach(s=>{delete s.exist,delete s.thumbnail,delete s.base64,delete s.blob});let n=JSON.stringify(a.attach),l=JSON.parse(JSON.stringify(e.userInput.attach));l.forEach(s=>{delete s.exist,delete s.thumbnail,delete s.base64,delete s.blob}),l=JSON.stringify(l),d=n!=l}catch{d=!0}if(i&&d){let l,n=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});if(n.present(),a){let s;try{s=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/thumbnail.png`}catch{s=`todo/${e.userInput.id}/thumbnail.png`}yield e.indexed.removeFileFromUserPath(s);for(let m=0,h=a.attach.length;m<h;m++){for(let g=0,p=e.userInput.attach.length;g<p;g++)if(e.userInput.attach[g].path==a.attach[m].path){a.attach[m].exist=!0,a.attach[m].index=g;break}(!a.attach[m].exist||a.attach[m].exist&&!e.userInput.attach[a.attach[m].index])&&(a.attach[m].url?yield e.global.remove_file_from_storage(a.attach[m].url):yield e.indexed.removeFileFromUserPath(a.attach[m].path))}}for(let s=0,m=e.userInput.attach.length;s<m;s++){let h,g=!1;try{if(l)throw"already exist";h=yield e.indexed.loadBlobFromUserPath(`${e.userInput.attach[s].path}_thumbnail.png`,"image/png"),g=!0}catch{}if(!e.userInput.attach[s].exist||!l&&"image"==e.userInput.attach[s].viewer){g||(h=yield e.indexed.loadBlobFromUserPath(e.userInput.attach[s].path,e.userInput.attach[s].type));try{if(1!=e.useFirstCustomCDN)throw"FFS \uc0ac\uc6a9 \uc21c\uc704\uc5d0 \uc5c6\uc74c";let p;if(n.message=`${e.lang.text.AddPost.SyncAttaches}: ${e.userInput.attach[s].filename}`,p=yield e.global.try_upload_to_user_custom_fs(e.userInput.attach[s],e.nakama.users.self.display_name,void 0,n),!p)throw"\uc5c5\ub85c\ub4dc \uc2e4\ud328";delete e.userInput.attach[s].path,delete e.userInput.attach[s].partsize,e.userInput.attach[s].url=p}catch{try{e.userInput.attach[s].path=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/${e.userInput.attach[s].filename}`}catch{e.userInput.attach[s].path=`todo/${e.userInput.id}/${e.userInput.attach[s].filename}`}yield e.indexed.saveBlobToUserPath(h,e.userInput.attach[s].path)}}else delete e.userInput.attach[s].exist;!l&&("image"==e.userInput.attach[s].viewer||g)&&(l=URL.createObjectURL(h))}l&&(yield new Promise(s=>{new k(m=>{m.setup=()=>{m.noCanvas(),m.loadImage(l,h=>{h.width>h.height?h.resize(h.width/h.height*128,128):h.resize(128,h.height/h.width*128);let p=m.createCanvas(128,128);p.hide(),m.smooth(),m.pixelDensity(1),m.image(h,-(h.width-128)/2,-(h.height-128)/2);let C,y=p.elt.toDataURL("image/png").replace("image/png","image/octet-stream");try{C=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/thumbnail.png`}catch{C=`todo/${e.userInput.id}/thumbnail.png`}e.indexed.saveBase64ToUserPath(y,C,x=>{s()}),URL.revokeObjectURL(l),m.remove()},h=>{console.error("Todo-\ub4f1\ub85d\ub41c \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",h),s(),URL.revokeObjectURL(l),m.remove()})}})})),n.dismiss()}if(!i&&d&&a){let n;try{n=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/thumbnail.png`}catch{n=`todo/${e.userInput.id}/thumbnail.png`}if(yield e.indexed.removeFileFromUserPath(n),a.attach)for(let l=0,s=a.attach.length;l<s;l++)a.attach[l].url?yield e.global.remove_file_from_storage(a.attach[l].url):yield e.indexed.removeFileFromUserPath(a.attach[l].path)}if(e.userInput.attach.forEach(n=>{URL.revokeObjectURL(n.thumbnail),delete n.thumbnail,delete n.exist,delete n.base64}),e.userInput.written=(new Date).getTime(),e.userInput.startFrom){let n=new Date(e.userInput.startFrom).getTime();(new Date).getTime()>n?delete e.userInput.startFrom:e.userInput.startFrom=n}if(e.userInput.limit=new Date(e.userInput.limit).getTime(),e.isModify||e.userInput.remote&&!e.userInput.remote.creator_id&&(e.userInput.remote.creator_id=e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].session.user_id),e.userInput.remote){let n=yield e.loadingCtrl.create({message:e.lang.text.TodoDetail.WIP});n.present();try{if(e.userInput.attach.forEach(l=>{URL.revokeObjectURL(l.thumbnail),delete l.thumbnail,delete l.exist,delete l.base64}),i&&d&&a)for(let l=0,s=a.attach.length;l<s;l++){for(let m=0,h=e.userInput.attach.length;m<h;m++)if(e.userInput.attach[m].path==a.attach[l].path){a.attach[l].exist=!0,a.attach[l].index=m;break}(!a.attach[l].exist||a.attach[l].exist&&!e.userInput.attach[a.attach[l].index])&&(a.attach[l].url?yield e.global.remove_file_from_storage(a.attach[l].url):yield e.nakama.sync_remove_file(a.attach[l].path,e.userInput.remote.isOfficial,e.userInput.remote.target,"todo_attach"))}for(let l=0,s=e.userInput.attach.length;l<s;l++)try{if(2==e.useFirstCustomCDN)throw"ForceSQL";let m=e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].info.address,h=e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].info.useSSL?"https:":"http:",g=`${e.userInput.id}_${e.nakama.users.self.display_name}`;try{g=`${e.userInput.id}_${e.userInput.remote.creator_id}`}catch{}let p=yield e.global.upload_file_to_storage(e.userInput.attach[l],g,h,m,1==e.useFirstCustomCDN);if(!p)throw"\ub9c1\ud06c \ub9cc\ub4e4\uae30 \uc2e4\ud328";delete e.userInput.attach[l].partsize,e.userInput.attach[l].url=p}catch(m){console.log("cdn \uc5c5\ub85c\ub4dc \ucc98\ub9ac \uc2e4\ud328: ",m),"ForceSQL"==m&&e.userInput.attach[l].url&&(e.userInput.attach[l].blob=yield(yield fetch(e.userInput.attach[l].url)).blob()),yield e.nakama.sync_save_file(e.userInput.attach[l],e.userInput.remote.isOfficial,e.userInput.remote.target,"todo_attach")}if(e.userInput.workers){if(!e.isModify){let l=yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].client.rpc(e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].session,"manage_todo_add_fn",e.userInput);e.userInput.id=`RemoteTodo_${l.payload.value}`,e.nakama.RemoteTodoCounter[e.userInput.remote.isOfficial][e.userInput.remote.target].push(l.payload.value),e.nakama.updateRemoteCounter(e.userInput.remote.isOfficial,e.userInput.remote.target)}for(let l=0,s=e.userInput.workers.length;l<s;l++)try{let m=yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].client.readStorageObjects(e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].session,{object_ids:[{collection:"self_share",key:"private_match",user_id:e.userInput.workers[l].id}]});m.objects.length&&(yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].socket.joinMatch(m.objects[0].value.match_id),yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].socket.sendMatchState(m.objects[0].value.match_id,w.i.MANAGE_TODO,encodeURIComponent(`add,server_todo,${e.userInput.id}`)),yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].socket.leaveMatch(m.objects[0].value.match_id))}catch(m){console.log(m)}}else yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].client.writeStorageObjects(e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].session,[{collection:"server_todo",key:e.userInput.id,permission_read:2,permission_write:1,value:e.userInput}]).then(function(){var l=(0,b.c)(function*(s){yield e.nakama.servers[e.userInput.remote.isOfficial][e.userInput.remote.target].socket.sendMatchState(e.nakama.self_match[e.userInput.remote.isOfficial][e.userInput.remote.target].match_id,w.i.MANAGE_TODO,encodeURIComponent(`add,${s.acks[0].collection},${s.acks[0].key}`))});return function(s){return l.apply(this,arguments)}}());e.isModify||(yield e.nakama.updateRemoteCounter(e.userInput.remote.isOfficial,e.userInput.remote.target)),n.dismiss()}catch(l){if(console.error("\ud574\uc57c\ud560 \uc77c\uc774 \uc11c\ubc84\uc5d0 \uc804\uc1a1\ub418\uc9c0 \uc54a\uc74c: ",l),n.dismiss(),e.isModify){let s;e.p5toast.show({text:e.lang.text.TodoDetail.SaveAfterConnectServer}),e.userInput.modified=!0,e.global.p5todo&&e.global.p5todo.add_todo&&e.global.p5todo.add_todo(JSON.stringify(e.userInput));try{s=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/info.todo`}catch{s=`todo/${e.userInput.id}/info.todo`}yield e.indexed.saveTextFileToUserPath(JSON.stringify(e.userInput),s),e.navCtrl.pop()}else e.p5toast.show({text:e.lang.text.TodoDetail.CanAddToServer});return void(e.isButtonClicked=!1)}}e.global.p5todo&&e.global.p5todo.add_todo&&e.global.p5todo.add_todo(JSON.stringify(e.userInput));try{c=`todo/${e.userInput.id}_${e.userInput.remote.isOfficial}_${e.userInput.remote.target}/info.todo`}catch{c=`todo/${e.userInput.id}/info.todo`}yield e.indexed.saveTextFileToUserPath(JSON.stringify(e.userInput),c),e.navCtrl.pop()})()}deleteData(){var i,e=this;this.alertCtrl.create({header:this.lang.text.TodoDetail.remove,message:this.lang.text.ChatRoom.CannotUndone,buttons:[{text:this.lang.text.TodoDetail.remove,handler:(i=(0,b.c)(function*(){e.isButtonClicked=!0,yield e.nakama.deleteTodoFromStorage(!0,e.userInput),e.navCtrl.pop()}),function(){return i.apply(this,arguments)}),cssClass:"redfont"}]}).then(i=>{this.global.p5key.KeyShortCut.Escape=()=>{i.dismiss()},i.onDidDismiss().then(()=>{this.global.p5key.KeyShortCut.Escape=()=>{this.navCtrl.pop()}}),i.present()})}ionViewWillLeave(){var e=this;return(0,b.c)(function*(){e.WillLeavePage=!0,delete e.global.p5key.KeyShortCut.Escape,delete e.global.p5key.KeyShortCut.AddAct,delete e.global.p5key.KeyShortCut.Digit,e.noti.Current="",e.p5timer&&e.p5timer.remove()})()}ngOnDestroy(){this.nakama.AddTodoLinkAct=void 0,this.nakama.AddTodoManageUpdateAct=void 0,this.p5canvas&&this.p5canvas.remove(),delete this.nakama.StatusBarChangedCallback}}return(u=_).\u0275fac=function(e){return new(e||u)(t.GI1(T.gV),t.GI1(T.E5),t.GI1(f.qS),t.GI1(N.o),t.GI1(L.O),t.GI1(Y.mI),t.GI1(j.k),t.GI1(w.h),t.GI1(f.iW),t.GI1(U.s),t.GI1(B.Y),t.GI1(f.Kg),t.GI1(W.A1),t.GI1(F.wX))},u.\u0275cmp=t.In1({type:u,selectors:[["app-add-todo-menu"]],viewQuery:function(e,i){if(1&e&&(t.CC$(K,5),t.CC$(J,5),t.CC$(z,5),t.CC$(Q,5),t.CC$(q,5)),2&e){let r;t.wto(r=t.Gqi())&&(i.StartCalendar=r.first),t.wto(r=t.Gqi())&&(i.Calendar=r.first),t.wto(r=t.Gqi())&&(i.NewAttach=r.first),t.wto(r=t.Gqi())&&(i.StoreAt=r.first),t.wto(r=t.Gqi())&&(i.ImporantSel=r.first)}},decls:62,vars:32,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref","portal/main"],["id","p5Drop_todo",2,"position","absolute","width","100%","height","100%","display","flex","pointer-events","none","z-index","500"],["id","main_table",2,"width","100%","height","100%"],[2,"height","100%"],[2,"vertical-align","top"],["id","p5timer",2,"position","absolute","width","100%","height","8px","z-index","2"],["id","main_div",1,"main",2,"max-width","100vw"],[3,"click",4,"ngIf"],[4,"ngIf"],["fixed","",4,"ngIf"],["id","titleInput",1,"ion-text-right",3,"label","ngModel","placeholder","ngModelChange"],["slot","end","name","mic-outline",3,"click",4,"ngIf"],["button","",3,"click"],[2,"pointer-events","none",3,"label","value","ionChange"],["ImporantSel",""],["value","2"],["value","1"],["value","0"],[1,"additional_form","new_bg_form"],["id","TodoCustomColorInput","type","color",2,"width","0px","height","0px","opacity","0",3,"ngModel","ngModelChange"],["DateTime",""],["value","Start",4,"ngIf"],["value","Limit"],["button","","slot","header"],[1,"ion-text-right","uneditable_data"],[1,"ion-accordion-toggle-icon","hide_accordion_icon"],["slot","content"],[2,"display","inline",3,"locale","ionChange"],["Calendar",""],["id","descInput",1,"infobox",2,"height","240px",3,"ngModel","placeholder","ngModelChange"],[4,"ngFor","ngForOf"],["button","",3,"click",4,"ngIf"],["hidden","","type","file","accept","*","multiple","",3,"id","change"],[2,"width","100%"],["id","bottom_buttons",2,"width","100%","background-color","black"],["expand","block",3,"disabled","click"],[3,"click"],[2,"pointer-events","none",3,"label","ionChange"],["StoreAt",""],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["color","medium"],["color","medium",1,"ion-text-right"],["fixed",""],["col-33",""],["button","","color","success",3,"disabled","click"],[1,"ion-text-center"],["slot","end","name","mic-outline",3,"click"],["ManageWorker",""],["Groups",""],[3,"ngModel","ngModelChange"],[1,"ion-text-end"],["class","ignore_check",4,"ngFor","ngForOf"],[1,"ignore_check"],["style","color: var(--ion-color-medium);",4,"ngIf"],["slot","end","color","medium","name","ellipsis-horizontal-circle-outline",4,"ngIf"],["slot","end","color","danger","name","close-circle-outline",4,"ngIf"],["slot","end","color","success","name","checkmark-circle-outline",4,"ngIf"],[2,"color","var(--ion-color-medium)"],["slot","end","color","medium","name","ellipsis-horizontal-circle-outline"],["slot","end","color","danger","name","close-circle-outline"],["slot","end","color","success","name","checkmark-circle-outline"],["value","Start"],["StartCalendar",""],["text-wrap",""],["class","image_thumbnail",3,"src","alt","contextmenu",4,"ngIf"],["button","",4,"ngIf"],[1,"image_thumbnail",3,"src","alt","contextmenu"],["button",""],[2,"display","none"],["interface","action-sheet",3,"label","cancelText","ionChange","ionDismiss"],["NewAttach",""],["value","camera"],["value","image"],["value","text"],["value","inapp"],["value","load"],["slot","end",3,"click",4,"ngIf"],["slot","end",3,"name","click",4,"ngIf"],["slot","end",3,"click"],["slot","end",3,"name","click"],["color","danger","expand","block",3,"disabled","click"]],template:function(e,i){1&e&&(t.I0R(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t.OEk(3),t.C$Y(),t.I0R(4,"ion-buttons",1),t.wR5(5,"ion-back-button",2),t.C$Y()()(),t.I0R(6,"ion-content"),t.wR5(7,"div",3),t.I0R(8,"table",4)(9,"tr",5)(10,"td",6),t.wR5(11,"div",7),t.I0R(12,"div",8),t.yuY(13,V,6,3,"ion-item",9)(14,X,6,2,"div",10)(15,Z,6,2,"ion-grid",11),t.I0R(16,"ion-item")(17,"ion-input",12),t.iHE("ngModelChange",function(a){return t.kNx(i.userInput.title,a)||(i.userInput.title=a),a}),t.C$Y(),t.yuY(18,ee,1,0,"ion-icon",13),t.C$Y(),t.yuY(19,ae,11,2,"div",10),t.I0R(20,"ion-item",14),t.qCj("click",function(){return i.ImporantSelClicked()}),t.I0R(21,"ion-select",15,16),t.qCj("ionChange",function(a){return i.ImporantSelChanged(a)}),t.I0R(23,"ion-select-option",17),t.OEk(24),t.C$Y(),t.I0R(25,"ion-select-option",18),t.OEk(26),t.C$Y(),t.I0R(27,"ion-select-option",19),t.OEk(28),t.C$Y()()(),t.yuY(29,ue,11,3,"div",10),t.I0R(30,"ion-item",14),t.qCj("click",function(){return i.toggle_custom_color()}),t.I0R(31,"ion-label"),t.OEk(32),t.C$Y(),t.I0R(33,"div",20)(34,"input",21),t.iHE("ngModelChange",function(a){return t.kNx(i.userInput.custom_color,a)||(i.userInput.custom_color=a),a}),t.C$Y()()(),t.I0R(35,"ion-accordion-group",null,22),t.yuY(37,de,10,3,"ion-accordion",23),t.I0R(38,"ion-accordion",24)(39,"ion-item",25)(40,"ion-label"),t.OEk(41),t.C$Y(),t.I0R(42,"ion-label",26),t.OEk(43),t.C$Y(),t.wR5(44,"ion-icon",27),t.C$Y(),t.I0R(45,"div",28)(46,"ion-datetime",29,30),t.qCj("ionChange",function(a){return i.limit_change(a)}),t.C$Y()()()(),t.yuY(48,ce,4,1,"ion-item-divider",10),t.I0R(49,"textarea",31),t.iHE("ngModelChange",function(a){return t.kNx(i.userInput.description,a)||(i.userInput.description=a),a}),t.C$Y(),t.yuY(50,ge,6,3,"div",32)(51,ye,18,10,"ion-item",33),t.I0R(52,"input",34),t.qCj("change",function(a){return i.inputImageSelected(a)}),t.C$Y()()()(),t.I0R(53,"tr")(54,"td")(55,"div",35)(56,"table",36)(57,"tr")(58,"td")(59,"ion-button",37),t.qCj("click",function(){return i.saveData()}),t.OEk(60),t.C$Y()(),t.yuY(61,be,3,2,"td",10),t.C$Y()()()()()()()),2&e&&(t.yG2(3),t.cNF(i.lang.text.TodoDetail.Title),t.yG2(10),t.E7m("ngIf",i.isStoreAtChangable&&i.AmICreator),t.yG2(),t.E7m("ngIf",!i.isStoreAtChangable||!i.AmICreator),t.yG2(),t.E7m("ngIf",i.isModify),t.yG2(2),t.E7m("label",i.lang.text.TodoDetail.DisplayName),t.OKB("ngModel",i.userInput.title),t.E7m("placeholder",i.lang.text.TodoDetail.DisplayName_placeholder),t.yG2(),t.E7m("ngIf",i.isMobile),t.yG2(),t.E7m("ngIf","local"!=i.userInput.storeAt&&i.isManager&&i.WorkerGroups.length),t.yG2(2),t.E7m("label",i.lang.text.TodoDetail.Importance)("value",i.userInput.importance),t.yG2(3),t.cNF(i.lang.text.TodoDetail.Importance_2),t.yG2(2),t.cNF(i.lang.text.TodoDetail.Importance_1),t.yG2(2),t.cNF(i.lang.text.TodoDetail.Importance_0),t.yG2(),t.E7m("ngIf",!i.isStoreAtChanged&&i.userInput.workers),t.yG2(3),t.cNF(i.lang.text.TodoDetail.CustomColor),t.yG2(),t.m_g("background-image: linear-gradient(to right, #0000, "+(i.userInput.custom_color||i.alert_color)+")"),t.yG2(),t.OKB("ngModel",i.userInput.custom_color),t.yG2(3),t.E7m("ngIf",i.isLimitUsable),t.yG2(4),t.cNF(i.lang.text.TodoDetail.limit),t.yG2(2),t.cNF(i.limitDisplay),t.yG2(3),t.E7m("locale",i.lang.lang),t.yG2(2),t.E7m("ngIf",i.isMobile),t.yG2(),t.OKB("ngModel",i.userInput.description),t.E7m("placeholder",i.lang.text.TodoDetail.description),t.yG2(),t.E7m("ngForOf",i.userInput.attach),t.yG2(),t.E7m("ngIf",i.isModifiable),t.yG2(),t.E7m("id",i.file_sel_id),t.yG2(7),t.E7m("disabled",i.isButtonClicked),t.yG2(),t.oRS(" ",i.buttonDisplay.saveTodo," "),t.yG2(),t.E7m("ngIf",i.isModify))},dependencies:[A.ay,A.u_,v.ot,v.ue,v._G,f.cm,f.qU,f.sn,f.GS,f.ew,f.Kk,f._i,f.on,f.YP,f.wB,f.Ko,f.A5,f.Yb,f.S8,f.QR,f.qo,f.Cy,f.gd,f.tM,f.Md,f.UJ,f.IT,f.qG,f.Im],styles:[".uneditable_data[_ngcontent-%COMP%]{color:#888}.main[_ngcontent-%COMP%]{width:100%;height:100%;padding-top:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}.logs[_ngcontent-%COMP%]{background:var(--voidDraw-menu-background);border-radius:8px;margin:8px;padding:4px 8px;text-align:center}.image_thumbnail[_ngcontent-%COMP%]{width:auto;height:auto;object-fit:contain;display:block;margin:auto}.ignore_check[_ngcontent-%COMP%]{pointer-events:none}"]}),_})()}];let Ce=(()=>{var u;class _{}return(u=_).\u0275fac=function(e){return new(e||u)},u.\u0275mod=t.a4G({type:u}),u.\u0275inj=t.s3X({imports:[T.qQ.forChild(ke),T.qQ]}),_})(),ve=(()=>{var u;class _{}return(u=_).\u0275fac=function(e){return new(e||u)},u.\u0275mod=t.a4G({type:u}),u.\u0275inj=t.s3X({imports:[A.MD,v.y,f.wZ,Ce]}),_})()}}]);