"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2621],{2621:(ht,b,g)=>{g.r(b),g.d(b,{AddTodoMenuPageModule:()=>rt});var x=g(9808),I=g(4182),p=g(3996),T=g(9705),_=g(655),k=g(4464),w=g(6505),M=g(774),v=g(9912),m=g(5016),A=g(9805),S=g(5087),t=g(9863),O=g(5742),Z=g(3336),N=g(2313),P=g(3496),F=g(8677),J=g(4606),U=g(1282),q=g(5129);const $=["StartCalendar"],j=["Calendar"],L=["StoreAt"],B=["ImporantSel"],H=["TagSel"];function Q(n,c){if(1&n&&(t.TgZ(0,"ion-select-option",34),t._uU(1),t.qZA()),2&n){const e=c.$implicit;t.Q6J("value",e),t.xp6(1),t.hij("",e.name," ")}}function Y(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",29),t.NdJ("click",function(){return t.CHM(e),t.oxw().StoreAtSelClicked()}),t.TgZ(1,"ion-label"),t._uU(2),t.qZA(),t.TgZ(3,"ion-select",30,31),t.NdJ("ionChange",function(a){return t.CHM(e),t.oxw().StoreAtSelChanged(a)}),t.TgZ(5,"ion-select-option",32),t._uU(6),t.qZA(),t.YNc(7,Q,2,2,"ion-select-option",33),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Oqu(e.lang.text.TodoDetail.StoreAt),t.xp6(4),t.Oqu(e.lang.text.TodoDetail.OnThisDevice),t.xp6(1),t.Q6J("ngForOf",e.AvailableStorageList)}}function G(n,c){if(1&n&&(t.TgZ(0,"ion-item")(1,"ion-label",35),t._uU(2),t.qZA(),t.TgZ(3,"ion-label",36),t._uU(4),t.qZA()()),2&n){const e=t.oxw(2);t.xp6(2),t.Oqu(e.lang.text.TodoDetail.ManagerIs),t.xp6(2),t.Oqu(e.userInput.display_manager)}}function E(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"div")(1,"ion-item")(2,"ion-label",35),t._uU(3),t.qZA(),t.TgZ(4,"ion-label",36),t._uU(5),t.qZA()(),t.YNc(6,G,5,2,"ion-item",8),t.TgZ(7,"ion-grid",37)(8,"ion-row")(9,"ion-col",38)(10,"ion-item",39),t.NdJ("click",function(){return t.CHM(e),t.oxw().doneTodo()}),t.TgZ(11,"ion-label",40),t._uU(12),t.qZA()()()()()()}if(2&n){const e=t.oxw();t.xp6(3),t.Oqu(e.userInput.display_store),t.xp6(2),t.Oqu(e.userInput.display_creator),t.xp6(1),t.Q6J("ngIf",e.userInput.remote&&e.userInput.remote.channel_id),t.xp6(4),t.Q6J("disabled",!e.isModifiable||e.isButtonClicked),t.xp6(2),t.Oqu(e.lang.text.TodoDetail.TodoComplete)}}function W(n,c){if(1&n&&(t.TgZ(0,"ion-select-option",34),t._uU(1),t.qZA()),2&n){const e=c.$implicit;t.Q6J("value",e),t.xp6(1),t.Oqu(e)}}function R(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",10),t.NdJ("click",function(){return t.CHM(e),t.oxw().TagSelClicked()}),t.TgZ(1,"ion-label"),t._uU(2),t.qZA(),t.TgZ(3,"ion-select",41,42),t.NdJ("ionChange",function(a){return t.CHM(e),t.oxw().TagSelChanged(a)}),t.TgZ(5,"ion-select-option",43),t._uU(6),t.qZA(),t.YNc(7,W,2,2,"ion-select-option",33),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Oqu(e.lang.text.TodoDetail.Tag),t.xp6(1),t.Q6J("value",e.userInput.tags)("placeholder",e.lang.text.TodoDetail.SelectTag),t.xp6(3),t.Oqu(e.lang.text.TodoDetail.NewTag),t.xp6(1),t.Q6J("ngForOf",e.saved_tag)}}function z(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item")(1,"ion-label"),t._uU(2),t.qZA(),t.TgZ(3,"ion-input",44),t.NdJ("ngModelChange",function(a){return t.CHM(e),t.oxw().InputNewTag=a}),t.qZA(),t.TgZ(4,"ion-button",45),t.NdJ("click",function(){return t.CHM(e),t.oxw().AddNewTag()}),t._uU(5),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(2),t.Oqu(e.lang.text.TodoDetail.Tag),t.xp6(1),t.Q6J("ngModel",e.InputNewTag)("placeholder",e.lang.text.TodoDetail.NewTagName),t.xp6(2),t.hij(" ",e.lang.text.TodoDetail.CreateTag," ")}}function V(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"img",47),t.NdJ("click",function(){t.CHM(e);const a=t.oxw(2).index;return t.oxw().open_ionic_viewer(a)}),t.qZA()}if(2&n){const e=t.oxw(2).$implicit;t.Q6J("src",e.thumbnail,t.LSH)("alt",e.filename)}}function K(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",10),t.NdJ("click",function(){t.CHM(e);const a=t.oxw(3).index;return t.oxw().open_godot_viewer(a)}),t.TgZ(1,"ion-label",35),t._uU(2),t.qZA()()}if(2&n){const e=t.oxw(4);t.xp6(2),t.Oqu(e.lang.text.TodoDetail.open_content_viewer)}}function X(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",10),t.NdJ("click",function(){t.CHM(e);const a=t.oxw(3).index;return t.oxw().open_ionic_viewer(a)}),t.TgZ(1,"ion-label",35),t._uU(2),t.qZA()()}if(2&n){const e=t.oxw(4);t.xp6(2),t.Oqu(e.lang.text.TodoDetail.open_content_viewer)}}function tt(n,c){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,K,3,1,"ion-item",16),t.YNc(2,X,3,1,"ion-item",16),t.qZA()),2&n){const e=t.oxw(2).$implicit;t.xp6(1),t.Q6J("ngIf","godot"==e.viewer),t.xp6(1),t.Q6J("ngIf","image"!=e.viewer&&"godot"!=e.viewer)}}function et(n,c){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,V,1,2,"img",46),t.YNc(2,tt,3,2,"div",8),t.qZA()),2&n){const e=t.oxw().$implicit;t.xp6(1),t.Q6J("ngIf","image"==e.viewer&&e.thumbnail),t.xp6(1),t.Q6J("ngIf","disabled"!=e.viewer)}}function it(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"div")(1,"ion-item")(2,"ion-label"),t._uU(3),t.qZA(),t.TgZ(4,"ion-button",29),t.NdJ("click",function(){const s=t.CHM(e).index;return t.oxw().remove_attach(s)}),t._uU(5),t.qZA()(),t.YNc(6,et,3,2,"div",8),t.qZA()}if(2&n){const e=c.$implicit,i=t.oxw();t.xp6(3),t.Oqu(e.filename),t.xp6(2),t.hij(" ",i.lang.text.TodoDetail.delete_attach," "),t.xp6(1),t.Q6J("ngIf",e.viewer)}}function at(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-button",24),t.NdJ("click",function(){return t.CHM(e),t.oxw().from_camera()}),t._uU(1),t.qZA()}if(2&n){const e=t.oxw();t.xp6(1),t.hij(" ",e.lang.text.TodoDetail.camera," ")}}function st(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"td")(1,"ion-button",48),t.NdJ("click",function(){return t.CHM(e),t.oxw().deleteData()}),t._uU(2),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(1),t.Q6J("disabled",!e.isModifiable||e.isButtonClicked),t.xp6(1),t.hij(" ",e.lang.text.TodoDetail.remove," ")}}const nt=[{path:"",component:(()=>{class n{constructor(e,i,a,s,d,l,r,o,h,u,f,D,y,C,lt,dt){this.route=e,this.router=i,this.modalCtrl=a,this.lang=s,this.p5toast=d,this.sanitizer=l,this.indexed=r,this.nakama=o,this.alertCtrl=h,this.noti=u,this.statusBar=f,this.loadingCtrl=D,this.global=y,this.camera=C,this.navCtrl=lt,this.ngZone=dt,this.userInput={id:void 0,storeAt:"local",display_store:"",title:void 0,create_at:void 0,written:void 0,startFrom:void 0,limit:void 0,tags:[],importance:"0",description:void 0,remote:void 0,display_creator:void 0,attach:[],done:void 0,manager:void 0,display_manager:void 0,is_focus:void 0,noti_id:void 0},this.saved_tag=[],this.saved_tag_orig={},this.add_todo_menu=ut=>{this.ngZone.run(()=>{this.navCtrl.navigateForward("add-todo-menu",{animation:k.pg,state:{data:ut}})})},this.buttonDisplay={saveTodo:this.lang.text.TodoDetail.buttonDisplay_add},this.AmICreator=!0,this.isModify=!1,this.isModifiable=!1,this.isStartCalendarHidden=!0,this.isCalendarHidden=!0,this.isLimitChangable=!1,this.normal_color="#888b",this.alert_color="#0bbb",this.AlertLerpStartFrom=.8,this.file_sel_id="",this.AvailableStorageList=[],this.NewTagName="",this.needInputNewTagName=!0,this.InputNewTag="",this.isButtonClicked=!1}ngOnInit(){this.can_cordova="Android"==m.n$||"iOS"==m.n$,this.nakama.removeBanner(),this.indexed.loadTextFromUserPath("todo/tags.json",(s,d)=>{s&&d&&(this.saved_tag_orig=JSON.parse(d),this.saved_tag=Object.keys(this.saved_tag_orig),this.saved_tag.length&&(this.needInputNewTagName=!1))});let e=[];Object.keys(this.nakama.servers).forEach(s=>{Object.keys(this.nakama.servers[s]).forEach(l=>{"online"==this.statusBar.groupServer[s][l]&&e.push({name:`${this.nakama.servers[s][l].info.name}`,isOfficial:s,target:l,type:`${s}/${l}`})})}),[...e].forEach(s=>{this.AvailableStorageList.push(s)}),this.route.queryParams.subscribe(s=>{const d=this.router.getCurrentNavigation().extras.state;d&&(this.received_data=d.data)})}ionViewWillEnter(){return(0,_.mG)(this,void 0,void 0,function*(){if(this.received_data)this.buttonDisplay.saveTodo=this.lang.text.TodoDetail.buttonDisplay_modify,this.isModify=!0;else{let i=new Date((new Date).getTime()+864e5);this.userInput.limit=i.getTime()}if(this.received_data){let i=JSON.parse(this.received_data);if(i.attach.constructor!=Array){let a=JSON.parse(JSON.stringify(i.attach));i.attach=[],a.filename&&(a.path=`todo/${i.id}/${a.filename}`,i.attach.push(a))}this.userInput=Object.assign(Object.assign({},this.userInput),i)}if(this.file_sel_id=`todo_${this.userInput.id||"new_todo_id"}_${(new Date).getTime()}`,this.userInput.attach.length)for(let i=0,a=this.userInput.attach.length;i<a;i++){try{let s;if(this.userInput.remote){let l=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});l.present(),s=yield this.nakama.sync_load_file(this.userInput.attach[i],this.userInput.remote.isOfficial,this.userInput.remote.target,"todo_attach"),l.dismiss()}else s=yield this.indexed.loadBlobFromUserPath(this.userInput.attach[i].path,this.userInput.attach[i].type);let d=URL.createObjectURL(s);this.global.modulate_thumbnail(this.userInput.attach[i],d)}catch(s){console.log("\ucca8\ubd80\ud30c\uc77c \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",s)}this.userInput.attach[i].exist=!0}try{if("local"==this.userInput.storeAt)this.isModify||(this.StoreAt.value=this.userInput.storeAt),this.userInput.display_store=this.lang.text.TodoDetail.OnThisDevice,this.userInput.display_creator=this.lang.text.TodoDetail.WrittenByMe,this.userInput.display_manager=this.lang.text.TodoDetail.WrittenByMe,this.isModifiable=!0;else if(this.userInput.remote){if(this.isModify||(this.StoreAt.value=this.userInput.remote),this.userInput.display_store=this.userInput.remote.name,this.userInput.display_creator=this.lang.text.TodoDetail.Disconnected,this.userInput.display_manager=this.lang.text.TodoDetail.Disconnected,!this.nakama.servers[this.userInput.remote.isOfficial]||!this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target])throw this.userInput.display_creator=this.lang.text.TodoDetail.DeletedServer,{text:"Server Deleted",isModifiable:!0};if(this.statusBar.groupServer[this.userInput.remote.isOfficial]&&"online"!=this.statusBar.groupServer[this.userInput.remote.isOfficial][this.userInput.remote.target])throw{text:"Server disconnected",isModifiable:!1};"online"==this.statusBar.groupServer[this.userInput.remote.isOfficial][this.userInput.remote.target]&&(this.isModifiable=!0),this.AmICreator=this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].session.user_id==this.userInput.remote.creator_id,this.userInput.display_creator=this.AmICreator?this.lang.text.TodoDetail.WrittenByMe:this.nakama.load_other_user(this.userInput.remote.creator_id,this.userInput.remote.isOfficial,this.userInput.remote.target).display_name,this.userInput.display_manager=this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].session.user_id==this.userInput.manager?this.nakama.users.self.display_name:this.nakama.load_other_user(this.userInput.manager,this.userInput.remote.isOfficial,this.userInput.remote.target).display_name,this.userInput.remote.group_id&&(this.isModifiable="online"==this.nakama.groups[this.userInput.remote.isOfficial][this.userInput.remote.target][this.userInput.remote.group_id].status)}}catch(i){this.isModifiable=i.isModifiable,console.log("Server issue: ",i)}this.noti.Current=this.userInput.id;let e=new Date(this.userInput.limit);if(this.Calendar.value=new Date(e.getTime()-60*e.getTimezoneOffset()*1e3).toISOString(),this.userInput.startFrom){let i=new Date(this.userInput.startFrom);this.startDisplay=i.toLocaleString(this.lang.lang),this.startDisplay=this.startDisplay.substring(0,this.startDisplay.lastIndexOf(":"))}this.limitDisplay=e.toLocaleString(this.lang.lang),this.limitDisplay=this.limitDisplay.substring(0,this.limitDisplay.lastIndexOf(":")),this.isLimitChangable=!0})}ionViewDidEnter(){this.show_count_timer()}toggle_start_calendar(){this.isStartCalendarHidden=!this.isStartCalendarHidden,this.isCalendarHidden=!0}toggle_calendar(){this.isCalendarHidden=!this.isCalendarHidden,this.isStartCalendarHidden=!0}start_change(e){!this.isLimitChangable||(this.userInput.startFrom=e.detail.value,this.startDisplay=new Date(e.detail.value).toLocaleString(this.lang.lang),this.startDisplay=this.startDisplay.substring(0,this.startDisplay.lastIndexOf(":")),this.startTimeP5Display=new Date(this.userInput.startFrom).getTime())}limit_change(e){!this.isLimitChangable||(this.userInput.limit=e.detail.value,this.limitDisplay=new Date(e.detail.value).toLocaleString(this.lang.lang),this.limitDisplay=this.limitDisplay.substring(0,this.limitDisplay.lastIndexOf(":")),this.limitTimeP5Display=new Date(this.userInput.limit).getTime())}remove_attach(e){this.userInput.attach.splice(e,1)}show_count_timer(){this.p5timer=new w(e=>{let i=0;this.startTimeP5Display=new Date(this.userInput.startFrom||this.userInput.written).getTime(),this.limitTimeP5Display=new Date(this.userInput.limit).getTime();let a,s=e.color(this.normal_color);e.setup=()=>{let h=document.getElementById("p5timer"),u=e.createCanvas(h.clientWidth,h.clientHeight);u.id("timer"),u.style("position","inherit"),u.style("width","100%"),u.style("height","100%"),u.parent(h),e.noStroke()};let d=0,l=()=>{a=(new Date).getTime(),d=this.limitTimeP5Display<a?1:e.map(a,this.startTimeP5Display,this.limitTimeP5Display,0,1,!0),d<=this.AlertLerpStartFrom?s=e.color(this.normal_color):d>this.AlertLerpStartFrom&&(s=e.lerpColor(e.color(this.normal_color),e.color(this.alert_color),e.map(d,this.AlertLerpStartFrom,1,0,1)*i))};e.draw=()=>{l(),e.clear(255,255,255,255),e.push(),e.fill(s),i<1?(i+=.04,i>=1&&(i=1),e.rect(0,0,e.lerp(0,e.width,d*r(i)),e.height)):e.rect(0,0,e.lerp(0,e.width,d),e.height),e.pop()};let r=h=>o(e.sq(o(h))),o=h=>1-h})}from_camera(){this.camera.getPicture({destinationType:0,correctOrientation:!0}).then(e=>(0,_.mG)(this,void 0,void 0,function*(){let i=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});i.present();let a={},s=new Date;a.filename=`Camera_${s.toLocaleString().replace(/[:|.|\/]/g,"_")}.jpeg`,a.file_ext="jpeg",a.base64="data:image/jpeg;base64,"+e,a.thumbnail=this.sanitizer.bypassSecurityTrustUrl(a.base64),a.type="image/jpeg",a.typeheader="image",a.content_related_creator=[{timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name}],a.content_creator={timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name},a.thumbnail=a.base64,a.path=`todo/add_tmp.${a.filename}`,a.viewer="image",yield this.indexed.saveFileToUserPath(a.base64,a.path),i.dismiss(),this.userInput.attach.push(a)}))}new_attach(){this.modalCtrl.create({component:A.$}).then(e=>{e.onWillDismiss().then(i=>(0,_.mG)(this,void 0,void 0,function*(){if(i.data){let a={};a.filename=i.data.name,a.file_ext="png",a.type="image/png",a.content_related_creator=[{timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name}],a.content_creator={timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name},a.viewer="image",a.thumbnail=this.sanitizer.bypassSecurityTrustUrl(i.data.img),a.path=`todo/add_tmp.${a.filename}`,yield this.indexed.saveFileToUserPath(i.data.img,a.path),i.data.loadingCtrl.dismiss(),this.userInput.attach.push(a)}})),e.present()})}select_attach(){document.getElementById(this.file_sel_id).click()}inputImageSelected(e){return(0,_.mG)(this,void 0,void 0,function*(){if(!e.target.files.length)return;let i=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});i.present();let a={};a.filename=e.target.files[0].name,a.file_ext=e.target.files[0].name.substring(e.target.files[0].name.lastIndexOf(".")+1),a.filesize=e.target.files[0].size,a.type=e.target.files[0].type,a.path=`todo/add_tmp.${a.filename}`,a.content_related_creator=[{timestamp:(new Date).toLocaleString(),display_name:this.lang.text.GlobalAct.UnCheckableCreator}],a.content_creator={timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name};let s=!1;s=yield this.indexed.checkIfFileExist(a.path),this.userInput.id&&!s&&(s=yield this.indexed.checkIfFileExist(`todo/${this.userInput.id}/${a.filename}`)),s&&(a.filename=`${a.filename.substring(0,a.filename.lastIndexOf("."))}_.${a.file_ext}`),this.global.set_viewer_category(a),this.userInput.attach.push(a),a.base64=yield this.global.GetBase64ThroughFileReader(e.target.files[0]),"image"==a.viewer&&(a.thumbnail=this.sanitizer.bypassSecurityTrustUrl(a.base64)),this.indexed.saveFileToUserPath(a.base64,a.path,d=>{i.dismiss()})})}StoreAtSelClicked(){this.StoreAt.open()}StoreAtSelChanged(e){let i=e.detail.value;"local"==i?(this.userInput.storeAt="local",this.userInput.remote=void 0,this.userInput.manager=void 0):(this.userInput.storeAt=i.type,this.userInput.remote=i)}ImporantSelClicked(){this.ImporantSel.open()}ImporantSelChanged(e){switch(this.userInput.importance=e.detail.value,this.userInput.importance){case"0":this.normal_color="#888b",this.alert_color="#0bbb",this.AlertLerpStartFrom=.8;break;case"1":this.normal_color="#888b",this.alert_color="#dddd0cbb",this.AlertLerpStartFrom=.5;break;case"2":this.normal_color="#dddd0cbb",this.alert_color="#800b",this.AlertLerpStartFrom=.4}}TagSelClicked(){this.TagSel.open()}TagSelChanged(e){let i=e.detail.value;this.needInputNewTagName=i.includes("@new_tag"),this.needInputNewTagName&&i.splice(i.lastIndexOf("@new_tag"),1),this.userInput.tags=i}AddNewTag(){if(this.InputNewTag=this.InputNewTag.trim(),!this.InputNewTag)return void setTimeout(()=>{this.needInputNewTagName=!1,this.InputNewTag=""},0);let e=!0;for(let i=0,a=this.saved_tag.length;i<a;i++)if(this.saved_tag[i]==this.InputNewTag){e=!1;break}e&&(this.saved_tag.push(this.InputNewTag),this.userInput.tags.push(this.InputNewTag)),setTimeout(()=>{this.needInputNewTagName=!1,this.InputNewTag=""},0)}saveTagInfo(){var e;let a=null!==(e=(this.received_data?JSON.parse(this.received_data):{}).tags)&&void 0!==e?e:[],s=this.userInput.tags?JSON.parse(JSON.stringify(this.userInput.tags)):[],d=[],l=[];if(a.sort(),s.sort(),s.length)for(let r=0,o=s.length;r<o;r++){let h=a.indexOf(s[r]);h>=0?a.splice(h,1):d.push(s[r])}l=a,d.forEach(r=>{this.saved_tag_orig[r]||(this.saved_tag_orig[r]=0),this.saved_tag_orig[r]=this.saved_tag_orig[r]+1}),l.forEach(r=>{this.saved_tag_orig[r]&&(this.saved_tag_orig[r]=this.saved_tag_orig[r]-1),this.saved_tag_orig[r]<=0&&delete this.saved_tag_orig[r]}),this.indexed.saveTextFileToUserPath(JSON.stringify(this.saved_tag_orig),"todo/tags.json")}removeTagInfo(){(this.userInput.tags?JSON.parse(JSON.stringify(this.userInput.tags)):[]).forEach(i=>{this.saved_tag_orig[i]&&(this.saved_tag_orig[i]=this.saved_tag_orig[i]-1),this.saved_tag_orig[i]<=0&&delete this.saved_tag_orig[i]}),this.indexed.saveTextFileToUserPath(JSON.stringify(this.saved_tag_orig),"todo/tags.json")}open_ionic_viewer(e){this.modalCtrl.create({component:M.B,componentProps:{info:this.userInput.attach[e],path:this.userInput.attach[e].path}}).then(i=>{i.onDidDismiss().then(a=>{if(a.data){let s=[];if(this.userInput.attach[e].content_related_creator&&s.push(...this.userInput.attach[e].content_related_creator),this.userInput.attach[e].content_creator){let d=!1;for(let l=0,r=s.length;l<r;l++)if(s[l].user_id==this.userInput.attach[e].content_creator.user_id){d=!0;break}d||s.push(...this.userInput.attach.content_creator)}return delete this.userInput.attach[e].exist,void this.modalCtrl.create({component:A.$,componentProps:{info:this.userInput.attach[e],path:this.userInput.attach[e].path,width:a.data.width,height:a.data.height}}).then(d=>{d.onWillDismiss().then(l=>{if(l.data){let r=this.userInput.attach[e];r.filename=l.data.name,r.file_ext="png",r.type="image/png",r.viewer="image",l.data.is_modify?(r.content_related_creator=s,r.content_creator={timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name}):(r.content_related_creator=[{timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name}],r.content_creator={timestamp:(new Date).toLocaleString(),display_name:this.nakama.users.self.display_name}),r.thumbnail=this.sanitizer.bypassSecurityTrustUrl(l.data.img),r.path=`todo/add_tmp.${r.filename}`,this.indexed.saveFileToUserPath(l.data.img,r.path,o=>{l.data.loadingCtrl.dismiss()})}}),d.present()})}}),this.noti.Current="IonicViewerPage",i.present()})}open_godot_viewer(e){this.modalCtrl.create({component:S.r,componentProps:{info:this.userInput.attach[e],path:this.userInput.attach[e].path}}).then(i=>{this.noti.Current="GodotViewerPage",i.present()})}doneTodo(){return(0,_.mG)(this,void 0,void 0,function*(){if(this.isButtonClicked=!0,this.userInput.done=!0,this.global.godot_window.add_todo&&this.global.godot_window.add_todo(JSON.stringify(this.userInput)),this.userInput.remote){let e=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});e.present(),this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target]&&(yield this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].socket.sendMatchState(this.nakama.self_match[this.userInput.remote.isOfficial][this.userInput.remote.target].match_id,v.B.ADD_TODO,encodeURIComponent(`done,${this.userInput.id}`))),e.dismiss()}this.deleteFromStorage(!1)})}moveTodo(){console.warn("\uc5c5\ubb34 \uc774\uad00 \ud589\ub3d9 \ud544\uc694")}focusTodo(){console.warn("\uc5c5\ubb34 \uc9d1\uc911 \ud589\ub3d9 \ud544\uc694... \uc9d1\uc911 \ub9d0\uace0 \ub2e4\ub978\uac8c \ud544\uc694")}saveData(){return(0,_.mG)(this,void 0,void 0,function*(){if(!this.userInput.title)return void this.p5toast.show({text:this.lang.text.TodoDetail.needDisplayName});this.isButtonClicked=!0;let e=Boolean(this.userInput.attach.length);delete this.userInput.display_store,delete this.userInput.display_manager,delete this.userInput.display_creator;let i=this.InputNewTag.trim();if(i&&(this.userInput.tags.includes(i)||this.userInput.tags.push(i)),JSON.stringify(this.userInput)==this.received_data)return void this.navCtrl.back();this.userInput.create_at||(this.userInput.create_at=(new Date).getTime()),(!this.userInput.id||!this.isModify)&&(this.userInput.id=this.userInput.remote?this.userInput.remote.channel_id?`${this.userInput.remote.isOfficial}_${this.userInput.remote.target}_${this.userInput.remote.channel_id}_${this.userInput.remote.message_id}`:`${this.userInput.remote.isOfficial}_${this.userInput.remote.target}_${new Date(this.userInput.create_at).toISOString().replace(/[:|.|\/]/g,"_")}`:new Date(this.userInput.create_at).toISOString().replace(/[:|.|\/]/g,"_")),this.userInput.noti_id&&(("DesktopPWA"==m.n$||"MobilePWA"==m.n$)&&(clearTimeout(this.nakama.web_noti_id[this.userInput.noti_id]),delete this.nakama.web_noti_id[this.userInput.noti_id]),this.noti.ClearNoti(this.userInput.noti_id)),this.userInput.noti_id=this.nakama.get_noti_id(),this.nakama.set_todo_notification(this.userInput);let s=this.received_data?JSON.parse(this.received_data):void 0,d=!1;try{let l=JSON.stringify(s.attach),r=JSON.parse(JSON.stringify(this.userInput.attach));r.forEach(o=>{delete o.exist,delete o.thumbnail}),r=JSON.stringify(r),d=l!=r}catch(l){d=!0}if(e&&d){let r,l=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});if(l.present(),s){yield this.indexed.removeFileFromUserPath(`todo/${this.userInput.id}/thumbnail.png`);for(let o=0,h=s.attach.length;o<h;o++){for(let u=0,f=this.userInput.attach.length;u<f;u++)if(this.userInput.attach[u].path==s.attach[o].path){s.attach[o].exist=!0,s.attach[o].index=u;break}(!s.attach[o].exist||s.attach[o].exist&&!this.userInput.attach[s.attach[o].index])&&(yield this.indexed.removeFileFromUserPath(s.attach[o].path))}}for(let o=0,h=this.userInput.attach.length;o<h;o++){if(!this.userInput.attach[o].exist||!r&&"image"==this.userInput.attach[o].viewer){let u=yield this.indexed.loadBlobFromUserPath(this.userInput.attach[o].path,this.userInput.attach[o].type);this.userInput.attach[o].base64=yield this.global.GetBase64ThroughFileReader(u),this.userInput.attach[o].path=`todo/${this.userInput.id}/${this.userInput.attach[o].filename}`,yield this.indexed.saveFileToUserPath(this.userInput.attach[o].base64,this.userInput.attach[o].path)}else delete this.userInput.attach[o].exist;!r&&"image"==this.userInput.attach[o].viewer&&(r=this.userInput.attach[o].base64)}r&&(yield new Promise(o=>{new w(h=>{h.setup=()=>{h.loadImage(r,u=>{u.width>u.height?u.resize(u.width/u.height*128,128):u.resize(128,u.height/u.width*128),h.createCanvas(128,128).hide(),h.smooth(),h.image(u,-(u.width-128)/2,-(u.height-128)/2),h.saveFrames("","png",1,1,y=>{this.indexed.saveFileToUserPath(y[0].imageData.replace(/"|=|\\/g,""),`todo/${this.userInput.id}/thumbnail.png`,C=>{o()}),h.remove()})},u=>{console.error("Todo-\ub4f1\ub85d\ub41c \uc774\ubbf8\uc9c0 \ubd88\ub7ec\uc624\uae30 \uc2e4\ud328: ",u),o(),h.remove()})}})})),this.global.last_frame_name="",l.dismiss()}else if(!e&&s){yield this.indexed.removeFileFromUserPath(`todo/${this.userInput.id}/thumbnail.png`);for(let l=0,r=s.attach.length;l<r;l++)yield this.indexed.removeFileFromUserPath(s.attach[l].path)}if(this.userInput.attach.forEach(l=>{URL.revokeObjectURL(l.thumbnail),delete l.thumbnail,delete l.exist}),this.userInput.written=(new Date).getTime(),this.userInput.startFrom){let l=new Date(this.userInput.startFrom).getTime();(new Date).getTime()>l?delete this.userInput.startFrom:this.userInput.startFrom=l}if(this.userInput.limit=new Date(this.userInput.limit).getTime(),this.isModify||this.userInput.remote&&!this.userInput.remote.creator_id&&(this.userInput.remote.creator_id=this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].session.user_id,this.userInput.manager=this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].session.user_id),this.userInput.remote){let l=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});l.present();let r={};r=this.userInput.remote.channel_id?{collection:"group_todo",key:this.userInput.id,permission_read:2,permission_write:1,value:this.userInput}:{collection:"server_todo",key:this.userInput.id,permission_read:2,permission_write:1,value:this.userInput};try{if(this.userInput.attach.forEach(o=>delete o.base64),yield this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].client.writeStorageObjects(this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].session,[r]).then(o=>(0,_.mG)(this,void 0,void 0,function*(){yield this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target].socket.sendMatchState(this.nakama.self_match[this.userInput.remote.isOfficial][this.userInput.remote.target].match_id,v.B.ADD_TODO,encodeURIComponent(`add,${o.acks[0].collection},${o.acks[0].key}`))})),e&&d&&s)for(let o=0,h=s.attach.length;o<h;o++){for(let u=0,f=this.userInput.attach.length;u<f;u++)if(this.userInput.attach[u].path==s.attach[o].path){s.attach[o].exist=!0,s.attach[o].index=u;break}(!s.attach[o].exist||s.attach[o].exist&&!this.userInput.attach[s.attach[o].index])&&(yield this.nakama.sync_remove_file(s.attach[o].path,this.userInput.remote.isOfficial,this.userInput.remote.target,"todo_attach"))}for(let o=0,h=this.userInput.attach.length;o<h;o++)yield this.nakama.sync_save_file(this.userInput.attach[o],this.userInput.remote.isOfficial,this.userInput.remote.target,"todo_attach"),delete this.userInput.attach[o].base64;l.dismiss()}catch(o){return console.error("\ud574\uc57c\ud560 \uc77c\uc774 \uc11c\ubc84\uc5d0 \uc804\uc1a1\ub418\uc9c0 \uc54a\uc74c: ",o),this.p5toast.show({text:this.lang.text.TodoDetail.CanAddToServer}),this.isButtonClicked=!1,void l.dismiss()}}this.global.godot_window.add_todo&&this.global.godot_window.add_todo(JSON.stringify(this.userInput)),this.indexed.saveTextFileToUserPath(JSON.stringify(this.userInput),`todo/${this.userInput.id}/info.todo`,l=>{this.saveTagInfo(),this.navCtrl.back()})})}deleteData(){this.alertCtrl.create({header:this.lang.text.TodoDetail.removeTodo,message:this.lang.text.TodoDetail.terminateTodo,buttons:[{text:this.lang.text.TodoDetail.remove,handler:()=>{this.deleteFromStorage()}}]}).then(e=>e.present())}deleteFromStorage(e=!0){return(0,_.mG)(this,void 0,void 0,function*(){this.isButtonClicked=!0;let i=yield this.loadingCtrl.create({message:this.lang.text.TodoDetail.WIP});if(i.present(),this.userInput.remote){let a={};a=this.userInput.remote.channel_id?{collection:"group_todo",key:this.userInput.id}:{collection:"server_todo",key:this.userInput.id};try{if(!this.nakama.servers[this.userInput.remote.isOfficial][this.userInput.remote.target])throw"Server deleted.";let s=this.userInput.remote.isOfficial,d=this.userInput.remote.target;yield this.nakama.servers[s][d].client.deleteStorageObjects(this.nakama.servers[s][d].session,{object_ids:[a]});for(let l=0,r=this.userInput.attach.length;l<r;l++)yield this.nakama.sync_remove_file(this.userInput.attach[l].path,s,d,"todo_attach");e&&(yield this.nakama.servers[s][d].socket.sendMatchState(this.nakama.self_match[s][d].match_id,v.B.ADD_TODO,encodeURIComponent(`delete,${this.userInput.id}`)))}catch(s){console.error("\ud574\uc57c\ud560 \uc77c \uc0ad\uc81c \uc694\uccad\uc774 \uc11c\ubc84\uc5d0 \uc804\uc1a1\ub418\uc9c0 \uc54a\uc74c: ",s)}}this.indexed.GetFileListFromDB(`todo/${this.userInput.id}`,a=>(0,_.mG)(this,void 0,void 0,function*(){a.forEach(s=>this.indexed.removeFileFromUserPath(s)),this.userInput.noti_id&&("DesktopPWA"==m.n$||"MobilePWA"==m.n$)&&(clearTimeout(this.nakama.web_noti_id[this.userInput.noti_id]),delete this.nakama.web_noti_id[this.userInput.noti_id]),this.noti.ClearNoti(this.userInput.noti_id),this.removeTagInfo(),e&&this.global.godot_window.remove_todo&&this.global.godot_window.remove_todo(JSON.stringify(this.userInput)),i.dismiss(),this.navCtrl.back()}))})}ionViewWillLeave(){return(0,_.mG)(this,void 0,void 0,function*(){this.indexed.GetFileListFromDB("todo/add_tmp.",e=>{e.forEach(i=>this.indexed.removeFileFromUserPath(i))}),this.noti.Current="",this.p5timer&&this.p5timer.remove(),this.global.CreateGodotIFrame("todo",{local_url:"assets/data/godot/todo.pck",title:"Todo",add_todo_menu:this.add_todo_menu})})}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(T.gz),t.Y36(T.F0),t.Y36(p.IN),t.Y36(O.b),t.Y36(Z.F),t.Y36(N.H7),t.Y36(P.H),t.Y36(v.a),t.Y36(p.Br),t.Y36(F.J),t.Y36(J.g),t.Y36(p.HT),t.Y36(U.A),t.Y36(q.V1),t.Y36(p.SH),t.Y36(t.R0b))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-add-todo-menu"]],viewQuery:function(e,i){if(1&e&&(t.Gf($,5),t.Gf(j,5),t.Gf(L,5),t.Gf(B,5),t.Gf(H,5)),2&e){let a;t.iGM(a=t.CRH())&&(i.StartCalendar=a.first),t.iGM(a=t.CRH())&&(i.Calendar=a.first),t.iGM(a=t.CRH())&&(i.StoreAt=a.first),t.iGM(a=t.CRH())&&(i.ImporantSel=a.first),t.iGM(a=t.CRH())&&(i.TagSel=a.first)}},decls:65,vars:32,consts:[["slot","start"],["defaultHref","main"],["id","main_table",2,"width","100%","height","100%"],[2,"height","100%"],[2,"vertical-align","top"],["id","p5timer",2,"position","absolute","width","100%","height","8px","z-index","2"],["id","main_div",1,"main"],[3,"click",4,"ngIf"],[4,"ngIf"],[1,"ion-text-right",3,"ngModel","placeholder","ngModelChange"],["button","",3,"click"],[2,"pointer-events","none",3,"value","ionChange"],["ImporantSel",""],["value","2"],["value","1"],["value","0"],["button","",3,"click",4,"ngIf"],[1,"ion-text-right","uneditable_data"],[2,"display","inline",3,"hidden","locale","ionChange"],["StartCalendar",""],["Calendar",""],[1,"infobox",3,"ngModel","placeholder","ngModelChange"],[4,"ngFor","ngForOf"],["class","ion-text-right",3,"click",4,"ngIf"],[1,"ion-text-right",3,"click"],["hidden","","type","file","accept","*",3,"id","change"],[2,"width","100%"],["id","bottom_buttons",2,"width","100%","background-color","black"],["expand","block",3,"disabled","click"],[3,"click"],[2,"pointer-events","none",3,"ionChange"],["StoreAt",""],["value","local"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["color","medium"],["color","medium",1,"ion-text-right"],["fixed",""],["col-33",""],["button","","color","success",3,"disabled","click"],[1,"ion-text-center"],["multiple","true",2,"pointer-events","none",3,"value","placeholder","ionChange"],["TagSel",""],["value","@new_tag"],["type","text",1,"ion-text-end",3,"ngModel","placeholder","ngModelChange"],[2,"margin-left","16px",3,"click"],["class","image_thumbnail",3,"src","alt","click",4,"ngIf"],[1,"image_thumbnail",3,"src","alt","click"],["color","danger","expand","block",3,"disabled","click"]],template:function(e,i){1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),t._uU(3),t.qZA(),t.TgZ(4,"ion-buttons",0),t._UZ(5,"ion-back-button",1),t.qZA()()(),t.TgZ(6,"ion-content")(7,"table",2)(8,"tr",3)(9,"td",4),t._UZ(10,"div",5),t.TgZ(11,"div",6),t.YNc(12,Y,8,3,"ion-item",7),t.YNc(13,E,13,5,"div",8),t.TgZ(14,"ion-item")(15,"ion-label"),t._uU(16),t.qZA(),t.TgZ(17,"ion-input",9),t.NdJ("ngModelChange",function(s){return i.userInput.title=s}),t.qZA()(),t.TgZ(18,"ion-item",10),t.NdJ("click",function(){return i.ImporantSelClicked()}),t.TgZ(19,"ion-label"),t._uU(20),t.qZA(),t.TgZ(21,"ion-select",11,12),t.NdJ("ionChange",function(s){return i.ImporantSelChanged(s)}),t.TgZ(23,"ion-select-option",13),t._uU(24),t.qZA(),t.TgZ(25,"ion-select-option",14),t._uU(26),t.qZA(),t.TgZ(27,"ion-select-option",15),t._uU(28),t.qZA()()(),t.YNc(29,R,8,5,"ion-item",16),t.YNc(30,z,6,4,"ion-item",8),t.TgZ(31,"ion-item",10),t.NdJ("click",function(){return i.toggle_start_calendar()}),t.TgZ(32,"ion-label"),t._uU(33),t.qZA(),t.TgZ(34,"ion-label",17),t._uU(35),t.qZA()(),t.TgZ(36,"ion-datetime",18,19),t.NdJ("ionChange",function(s){return i.start_change(s)}),t.qZA(),t.TgZ(38,"ion-item",10),t.NdJ("click",function(){return i.toggle_calendar()}),t.TgZ(39,"ion-label"),t._uU(40),t.qZA(),t.TgZ(41,"ion-label",17),t._uU(42),t.qZA()(),t.TgZ(43,"ion-datetime",18,20),t.NdJ("ionChange",function(s){return i.limit_change(s)}),t.qZA(),t.TgZ(45,"textarea",21),t.NdJ("ngModelChange",function(s){return i.userInput.description=s}),t.qZA(),t.YNc(46,it,7,3,"div",22),t.TgZ(47,"ion-item")(48,"ion-label"),t._uU(49),t.qZA(),t.YNc(50,at,2,1,"ion-button",23),t.TgZ(51,"ion-button",24),t.NdJ("click",function(){return i.new_attach()}),t._uU(52),t.qZA(),t.TgZ(53,"ion-button",24),t.NdJ("click",function(){return i.select_attach()}),t._uU(54),t.qZA()(),t.TgZ(55,"input",25),t.NdJ("change",function(s){return i.inputImageSelected(s)}),t.qZA()()()(),t.TgZ(56,"tr")(57,"td")(58,"div",26)(59,"table",27)(60,"tr")(61,"td")(62,"ion-button",28),t.NdJ("click",function(){return i.saveData()}),t._uU(63),t.qZA()(),t.YNc(64,st,3,2,"td",8),t.qZA()()()()()()()),2&e&&(t.xp6(3),t.Oqu(i.lang.text.TodoDetail.Title),t.xp6(9),t.Q6J("ngIf",!i.isModify),t.xp6(1),t.Q6J("ngIf",i.isModify),t.xp6(3),t.Oqu(i.lang.text.TodoDetail.DisplayName),t.xp6(1),t.Q6J("ngModel",i.userInput.title)("placeholder",i.lang.text.TodoDetail.DisplayName_placeholder),t.xp6(3),t.Oqu(i.lang.text.TodoDetail.Importance),t.xp6(1),t.Q6J("value",i.userInput.importance),t.xp6(3),t.Oqu(i.lang.text.TodoDetail.Importance_2),t.xp6(2),t.Oqu(i.lang.text.TodoDetail.Importance_1),t.xp6(2),t.Oqu(i.lang.text.TodoDetail.Importance_0),t.xp6(1),t.Q6J("ngIf",!i.needInputNewTagName),t.xp6(1),t.Q6J("ngIf",i.needInputNewTagName),t.xp6(3),t.Oqu(i.lang.text.TodoDetail.startFrom),t.xp6(2),t.Oqu(i.startDisplay||i.lang.text.TodoDetail.startImmediatly),t.xp6(1),t.Q6J("hidden",i.isStartCalendarHidden)("locale",i.lang.lang),t.xp6(4),t.Oqu(i.lang.text.TodoDetail.limit),t.xp6(2),t.Oqu(i.limitDisplay),t.xp6(1),t.Q6J("hidden",i.isCalendarHidden)("locale",i.lang.lang),t.xp6(2),t.Q6J("ngModel",i.userInput.description)("placeholder",i.lang.text.TodoDetail.description),t.xp6(1),t.Q6J("ngForOf",i.userInput.attach),t.xp6(3),t.Oqu(i.lang.text.TodoDetail.attachments),t.xp6(1),t.Q6J("ngIf",i.can_cordova),t.xp6(2),t.hij(" ",i.lang.text.TodoDetail.new_attach," "),t.xp6(2),t.hij(" ",i.lang.text.TodoDetail.add_attach," "),t.xp6(1),t.Q6J("id",i.file_sel_id),t.xp6(7),t.Q6J("disabled",!i.isModifiable||i.isButtonClicked),t.xp6(1),t.hij(" ",i.buttonDisplay.saveTodo," "),t.xp6(1),t.Q6J("ngIf",i.isModify))},directives:[p.Gu,p.sr,p.wd,p.Sm,p.oU,p.cs,p.W2,x.O5,p.Ie,p.Q$,p.t9,p.QI,p.n0,x.sg,p.jY,p.Nd,p.wI,p.pK,p.j9,I.JJ,I.On,p.YG,p.x4,I.Fj],styles:[".uneditable_data[_ngcontent-%COMP%]{color:#888}.main[_ngcontent-%COMP%]{width:100%;height:100%;padding:8px;overflow-x:hidden;overflow-y:auto;scroll-behavior:smooth}.logs[_ngcontent-%COMP%]{background:var(--voidDraw-menu-background);border-radius:8px;margin:8px;padding:4px 8px;text-align:center}.image_thumbnail[_ngcontent-%COMP%]{width:auto;height:auto;object-fit:contain;display:block;margin:auto}"]}),n})()}];let ot=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[T.Bz.forChild(nt)],T.Bz]}),n})(),rt=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[x.ez,I.u5,p.Pc,ot]]}),n})()}}]);